# 工具

1. [ADModule](https://github.com/samratashok/ADModule)

```
Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll
Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
```

2. [BloodHound](https://github.com/BloodHoundAD/BloodHound)

收集器分c#和PS版本

3. [PowerView](https://github.com/ZeroDayLab/PowerSploit/blob/master/Recon/PowerView.ps1)

4. [SharpView](https://github.com/tevora-threat/SharpView/)

c#版本powershell


#  BloodHound

收集器：

SharpHound.ps1

```
. C:\AD\Tools\BloodHound-master\Collectors\SharpHound.ps1  //引入

Invoke-BloodHound -CollectionMethod All -verbose  //收集
```

SharpHound.exe

```
SharpHound.exe --collectionmethods All
```

# Domain Enumeration

下面的例子，第一个方法是使用PowerView，第二个是ActiveDirectory Module

## 获取当前域


```
Get-Domain

Get-ADDomain
```

## 获取指定域 
```
Get-Domain –Domain techcorp.local

Get-ADDomain -Identity techcorp.local
```

## 获取当前域的SID
```
Get-DomainSID

(Get-ADDomain).DomainSID
```

## 获取当前域的域策略

```
Get-DomainPolicyData

(Get-DomainPolicyData).systemaccess
```

## 获取指定域的域策略
```
(Get-DomainPolicyData –domain techcorp.local).systemaccess
```

## 获取当前域的DC
```
Get-DomainController

Get-ADDomainController
```

## 获取指定域的DC
```
Get-DomainController –Domain techcorp.local

Get-ADDomainController -DomainName techcorp.local -Discover
```

## 获取域用户信息
```
Get-DomainUser
Get-DomainUser –Identity studentuser1

Get-ADUser -Filter * -Properties *
Get-ADUser -Identity studentuser1 -Properties *
```

## 获取指定用户的指定属性

```
Get-DomainUser -Identity studentuser1 -Properties *
Get-DomainUser -Properties pwdlastset

Get-ADUser -Filter * -Properties * | select -First 1 | Get-Member -MemberType *Property | select Name
Get-ADUser -Filter * -Properties * | select name,@{expression={[datetime]::fromFileTime($_.pwdlastset)}}
```


## 在用户的属性里搜索指定字符串信息

```
Get-DomainUser -LDAPFilter "Description=*built*" | Select name,Description

Get-ADUser -Filter 'Description -like "*built*"' -Properties Description | select name,Description
```


## 获取域计算机信息
```
Get-DomainComputer | select Name
Get-DomainComputer –OperatingSystem "Windows Server 2019 Standard"
Get-DomainComputer -Ping


Get-ADComputer -Filter * | select Name
Get-ADComputer -Filter 'OperatingSystem -like "*Windows Server 2019 Standard*"' -Properties OperatingSystem | select Name,OperatingSystem
Get-ADComputer -Filter * -Properties DNSHostName | %{Test-Connection -Count 1 -ComputerName $_.DNSHostName}
Get-ADComputer -Filter * -Properties *
```

## 获取域组信息
```
Get-DomainGroup | select Name
Get-DomainGroup –Domain techcorp.local

Get-ADGroup -Filter * | select Name
Get-ADGroup -Filter * -Properties *
```

获取名字有指定字符串字样的域组

```
Get-DomainGroup *admin*

Get-ADGroup -Filter 'Name -like "*admin*"' | select Name
```

## 获取指定组的群员信息，这里获取所有DA
```
Get-DomainGroupMember -Identity "Domain Admins" -Recurse

Get-ADGroupMember -Identity "Domain Admins" -Recursive
```

获取组成员身份
```
Get-DomainGroup –UserName studentuser1

Get-ADPrincipalGroupMembership -Identity studentuser1
```

## 获取一台机器上的所有本地组（在非dc机器上需要管理员权限)

```
Get-NetLocalGroup -ComputerName us-dc
```

获取一台机器上所有本地组的成员（在非dc机器上需要管理员权限)
```
Get-NetLocalGroupMember -ComputerName us-dc
```

获取本地Administrators组成员信息（在非dc机器上需要管理员权限)
```
Get-NetLocalGroupMember -ComputerName us-dc -GroupName Administrators
```

# GPO

组策略提供了改变和管理配置的能力

easily and centrally in AD.
• Allows configuration of –
• Security settings
• Registry-based policy settings
• Group policy preferences like startup/shutdown/log-on/logoff scripts


settings
• Software installation
• GPO can be abused for various attacks like privesc, backdoors,persistence etc


## 获取当前域的组策略
```
Get-DomainGPO

Get-DomainGPO -ComputerIdentity student1.us.techcorp.local  //指定计算机的组策略
```


Get GPO(s) which use Restricted Groups or groups.xml for interesting users
```
Get-DomainGPOLocalGroup
```

## Get users which are in a local group of a machine using GPO
```
Get-DomainGPOComputerLocalGroupMapping –ComputerIdentity student1.us.techcorp.local
Get-DomainGPOComputerLocalGroupMapping –ComputerIdentity us-mgmt.us.techcorp.local
```

Get machines where the given user is member of a specific group
```
Get-DomainGPOUserLocalGroupMapping -Identity studentuser1 -Verbose
```

## 获取所有OU
```
Get-DomainOU

Get-ADOrganizationalUnit -Filter * -Properties *
```

从gplink属性中读取GPO名称
```
Get-DomainGPO -Identity '{7162874B-E6F0-45AD-A3BF-0858DA4FA02F}'
```

## Get users which are in a local group of a machine in any OU using GPO
```
(Get-DomainOU).distinguishedname | %{Get-DomainComputer -SearchBase$_} | Get-DomainGPOComputerLocalGroupMapping
```

Get users which are in a local group of a machine in a particular OU using GPO
```
(Get-DomainOU -Identity 'OU=Mgmt,DC=us,DC=techcorp,DC=local').distinguishedname | %{Get-DomainComputer -SearchBase $_} | Get-DomainGPOComputerLocalGroupMapping
```

教材说powerview有bug，不然下面的命令会生效
```
Get-DomainGPOComputerLocalGroupMapping -OUIdentity 'OU=Mgmt,DC=us,DC=techcorp,DC=local'Get-DomainGPOComputerLocalGroupMapping -OUIdentity 'OU=Mgmt,DC=us,DC=techcorp,DC=local'
```

# ACL

 Enables control on the ability of a process to access objects and other

 resources in active directory based on:
– Access Tokens (security context of a process – identity and privs of
user)
– Security Descriptors (SID of the owner, Discretionary ACL (DACL) and


Access Control List (ACL)
• It is a list of Access Control Entries (ACE) – ACE corresponds to individual permission or audits access. Who has permission and what can be done
on an object?
• Two types:
– DACL – Defines the permissions trustees (a user or group) have on an object.
– SACL – Logs success and failure audit messages when an object is accessed.
• ACLs are vital to security architecture of AD.


## 枚举指定某个对象的ACL
```
Get-DomainObjectAcl -Identity studentuser1 –ResolveGUIDs
```

Get the ACLs associated with the specified LDAP path to be used for search
```
Get-DomainObjectAcl -Searchbase "LDAP://CN=Domain Admins,CN=Users,DC=us,DC=techcorp,DC=local" -ResolveGUIDs -Verbose
```

## 枚举一些特别的ACL
```
Find-InterestingDomainAcl -ResolveGUIDs
```

## 枚举跟某个指定LDAP PATH有关的ACL
```
Get-PathAcl -Path "\\us-dc\sysvol"
```

# Trusts

## 域信任分单向信任和双向信任

信任的方向跟访问的方向是相反的，即A信任B，表示B可以访问A

 Transitive（域传递性）	：所有默认的森林内部的信任关系，(树-根，父-子)之间的信任关系，都是双向信任
All the default intra-forest trust relationships(Tree-root, Parent-Child) between domains within a same forest are transitive two-way trusts.


Nontransitive(域非传递性）：不能扩展到 林中的其他域。可以是双向的 方式或单向的
This is the default trust (called external trust) between two domains in different forests when forests do not have a trust relationship.


## 域信任类型

1.  Default/Automatic Trusts（默认/自动的信任）

- Parent-child trust（父-子信任）	
 它是在新域和在命名空间层次结构中排在它前面的域之间自动创建的。在命名空间层次结构中，当一个新的域被添加到一个树中添加一个新域时，它就会自动在新域和它在命名空间层次中的前一个域之间创建。例如，us.techcorp.local是techcorp.local的一个子域)， 这种信任总是双向的。

- Tree-root trust（树-根信任）
当一个新的域树被添加到森林根部时，它就会自动创建。森林根的时候都会自动创建。 这种信任总是双向的。


2. External Trusts（外部信任）

– Between two domains in different forests when forests do not have a trust relationship.（存在在不同林的两个域之间，当两个林没有信任关系）

– Can be one-way or two-way and is nontransitive.（可以是双向信任或者单向信任，并且吗，没有域传递性）


## 林信任	

• Between forest root domain.（存在域两个林的根域之间）
• Cannot be extended to a third forest (no implicit trust).（不能扩展到第三个森林（没有隐式信任））
• Can be one-way or two-way and transitive or non-transitive.（可以是单向信任或者双向信任，也可以有域传递或没有域传递）


## 获取当前域的信任关系
```
Get-DomainTrust
Get-DomainTrust –Domain techcorp.local

Get-ADTrust
Get-ADTrust –Identity techcorp.local
```

## 获取林信息
```
Get-Forest

Get-ADForest
```

## 获取当前林里的所有域
```
Get-ForestDomain

(Get-ADForest).Domains
```

## 获取当前林的所有global catalogs
```
Get-ForestGlobalCatalog

Get-ADForest | select -ExpandProperty GlobalCatalogs
```

## 获取林信任关系	
```
Get-ForestTrust
Get-ADTrust -Filter 'intraForest -ne $True' -Server (Get-ADForest).Name
```

#  User Hunting

## 枚举当前用户有aminn权限的机器
```
Find-LocalAdminAccess –Verbose
```
Find-WMILocalAdminAccess.ps1  和 Find-PSRemotingLocalAdminAccess.ps1两个脚本也可以完成上面枚举


## 枚举DA（或者其他指定用户）有session的机器
```
Find-DomainUserLocation -Verbose
Find-DomainUserLocation -UserGroupIdentity "StudentUsers"
```

## 找到有域管理会话的计算机，并且当前用户有管理权限。用户有管理权限的计算机（使用Test-AdminAccess）
```
Find-DomainUserLocation -CheckAccess
```

Find computers (File Servers and Distributed File servers) where a domain admin session is available.
```
Find-DomainUserLocation –Stealth
```

