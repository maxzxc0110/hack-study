# 思路

主要从以下几个方面

- Protect and Limit Domain Admins（保护和限制DA）
- Isolate administrative workstations（隔离管理工作站）
- Secure local administrators（保护本地管理员）
- Time bound and just enough administration（有时间限制，和恰到好处的管理权限）
- Isolate administrators in a separate forest and breach containment using Tiers and ESAE（将管理员隔离在一个单独的森林中，并使用分层和ESAE突破遏制。（？））

# Protect and Limit Domain Admins

• Reduce the number of Domain Admins in your environment.（减少您环境中的域管理员数量。）

• Do not allow or limit login of DAs to any other machine other than th Domain Controllers. If logins to some servers is necessary, do not allow other administrators to login to that machine.（不允许或限制DA 登录到域控制器以外的任何其他机器。 如果需要登录某些服务器，请不要让其他管理员登录该机器。）

• (Try to) Never run a service with a DA. Credential theft protections which we are going to discuss soon are rendered useless in case of a service account.（（尝试）永远不要使用 DA 运行服务。 我们将很快讨论的凭证盗窃保护在服务帐户的情况下变得无用。）

• Set "Account is sensitive and cannot be delegated" for DAs.（为 DA 设置“账户敏感，不能委托”。）


## Protected Users Group
• Protected Users is a group introduced in Server 2012 R2 for "better protection against credential theft" by not caching credentials in insecure ways. A user added to this group has following major device protections:（受保护用户是Server 2012 R2 中引入的一个组，用于通过不以不安全的方式缓存凭据来“更好地防止凭据盗窃”。 添加到此组的用户具有以下主要设备保护：）
– Cannot use CredSSP and WDigest - No more cleartext credentials caching.（无法使用 CredSSP 和 WDigest - 不再缓存明文凭据。）
– NTLM hash is not cached.（不会缓存NTLM hash）
– Kerberos does not use DES or RC4 keys. No caching of clear text cred or long term keys.（Kerberos 不使用 DES 或 RC4 密钥。 不缓存明文凭据或长期密钥。）

• If the domain functional level is Server 2012 R2, following DC protections are available:（如果域功能级别是 Server 2012 R2，则以下 DC 保护可用：）
– No NTLM authentication.（没有 NTLM 身份验证。）
– No DES or RC4 keys in Kerberos pre-auth.（Kerberos 预授权中没有 DES 或 RC4 密钥。）
– No delegation (constrained or unconstrained)（无委托（受约束或不受约束））
– No renewal of TGT beyond initial four hour lifetime - Hardcoded, unconfigurable "Maximum lifetime for user ticket" and "Maximum lifetime for user ticket renewal"（超过最初的 4 小时生命周期后不再续订 TGT - 硬编码、不可配置的“用户票证最长生命周期”和“用户票证续签最长生命周期”）

## Protected Users Group

• Needs all domain control to be at least Server 2008 or later (because AES keys).（需要所有域控制至少为 Server 2008 或更高版本（因为 AES 密钥））
• Not recommended by MS to add DAs and EAs to this group without testing "the potential impact" of lock out.（MS 不建议在未测试锁定的“潜在影响”的情况下将 DA 和 EA 添加到该组。）
• No cached logon i.e. no offline sign-on.（无缓存登录，即无离线登录。）
• Having computer and service accounts in this group is useless as their credentials will always be present on the host machine.（在该组中拥有计算机和服务帐户是没有用的，因为它们的凭据将始终存在于主机上。）


# Isolate administrative workstations

Privileged Administrative Workstations (PAWs)（特权管理工作站（PAWs））
• A hardened workstation for performing sensitive tasks like administration of domain controllers, cloud infrastructure, sensitive business functions etc.（ 用于执行敏感任务的加固工作站，如管理域控制器、云基础设施、敏感业务功能等。）

• Can provides protection from phishing attacks, OS vulnerabilities,credential replay attacks.（可以提供保护，防止网络钓鱼攻击、操作系统漏洞、凭证重放攻击）

• Admin Jump servers to be accessed only from a PAW, multiple strategies（管理跳转服务器只能从PAW中访问，有多种策略）
– Separate privilege and hardware for administrative and normal tasks.（为管理和正常任务提供单独的权限和硬件。）
– Having a VM on a PAW for user tasks.（在PAW上有一个虚拟机用于用户任务。）

# Secure local administrators

LAPS (Local Administrator Password Solution)
• Centralized storage of passwords in AD with periodic randomizing where read permissions are access controlled.（在 AD 中集中存储密码，并定期随机化，控制读取和访问的权限。）

• Computer objects have two new attributes - ms-mcs-AdmPwd attribute stores the clear text password and ms-mcs-AdmPwdExpirationTime controls the password change.（计算机对象有两个新属性 - ms-mcs-AdmPwd 属性存储明文密码，ms-mcs-AdmPwdExpirationTime 控制密码更改。）

• Storage in clear text, transmission is encrypted.（明文存储，传输加密）

• Note - With careful enumeration, it is possible to retrieve which user can access the clear text password providing a list of attractive targets!（注意 - 通过仔细枚举，可以检索出哪些用户可以访问明文密码，提供有吸引力的目标列表！）


# Time Bound Administration - JIT

• Just In Time (JIT) administration provides the ability to grant time-bound administrative access on per-request bases.（Just In Time (JIT) 管理提供了基于每个请求授予有时限的管理访问权限的能力。）
• Check out Temporary Group Membership! (Requires Privileged Access Management Feature to be enabled which can't be turned off later)（查看临时组会员资格！ （需要启用特权访问管理功能，以后无法关闭））
```
Add-ADGroupMember -Identity 'Domain Admins' -Members newDA -MemberTimeToLive (New-TimeSpan -Minutes 60)
```

# Time Bound Administration - JEA

• JEA (Just Enough Administration) provides role based access control for PowerShell based remote delegated administration.（JEA（Just Enough Administration）为基于PowerShell的远程委托管理提供基于角色的访问控制。）

• With JEA non-admin users can connect remotely to machines for doing specific administrative tasks.（通过JEA，非管理员用户可以远程连接到机器上执行特定的管理任务。）

• For example, we can control the command a user can run and even restrict parameters which can be used.（例如，我们可以控制用户可以运行的命令，甚至限制可以使用的参数。）

• JEA endpoints have PowerShell transcription and logging enabled.（EA端点启用了PowerShell转录和日志记录功能。）


# Tier Model

Active Directory Administrative Tier Model（活动目录管理层模式）

• Composed of three levels only for administrative accounts:（由三个层次组成，只针对管理账户）
- Tier 0 – Accounts, Groups and computers which have privileges across the enterprise like domain controllers, domain admins, enterprise admins. （0级--账户、组和计算机，在整个企业中拥有特权，如域控制器、域管理员、企业管理员。）
- Tier 1 - Accounts, Groups and computers which have access to resources having significant amount of business value. A common example role is server administrators who maintain these operating systems with the ability to impact all enterprise services.（第1层--账户、群组和计算机，可以访问具有大量商业价值的资源。一个常见的例子是服务器管理员，他们维护这些操作系统，有能力影响所有企业服务。）
- Tier 2 - Administrator accounts which have administrative control of a significant amount of business value that is hosted on user workstations and devices. Examples include Help Desk and computer support administrators because they can impact the integrity of almost any user data.（第二层 - 管理员账户，对用户工作站和设备上托管的大量商业价值有管理控制。例子包括帮助台和计算机支持管理员，因为他们可以影响几乎所有用户数据的完整性。
）

• Control Restrictions - What admins control.（控制限制 - 管理员控制什么。）
• Logon Restrictions - Where admins can log-on to.（登录限制 - 管理员可以登录到哪里。）


# Detection and Defense - ESAE

ESAE (Enhanced Security Admin Environment)（ESAE (增强型安全管理环境)）

• Dedicated administrative forest for managing critical assets like administrative users, groups and computers.（专门的管理林用于管理关键资产，如管理用户、组和计算机）

• Since a forest is considered a security boundary rather than a domain,this model provides enhanced security controls.（由于森林被认为是一个安全边界，而不是一个域，这种模式提供了增强的安全控制。）

• The administrative forest is also called the Red Forest.（管理林也被称为红色森林。）

• Administrative users in a production forest are used as standard non-privileged users in the administrative forest.（生产林中的管理用户被用作管理林中的标准非特权用户。）

• Selective Authentication to the Red Forest enables stricter security controls on logon of users from non-administrative forests.(对红色森林的选择性认证可以对来自非管理性森林的用户的登录进行更严格的安全控制。)


# Credential Guard

• It "uses virtualization-based security to isolate secrets so that only privileges system software can access them".(它 "使用基于虚拟化的安全来隔离秘密，以便只有特权系统软件可以访问它们"。)

• Effective in stopping PTH and Over-PTH attacks by restricting access to NTLM hashes and TGTs. It is not possible to write Kerberos tickets to memory even if we have credentials.(通过限制对NTLM哈希值和TGT的访问，有效阻止了PTH和Over-PTH攻击。即使我们有凭证，也不可能将Kerberos票据写入内存。)


• But, credentials for local accounts in SAM and Service account credentials from LSA Secrets are NOT protected.(但是，SAM中的本地账户凭证和来自LSA Secrets的服务账户凭证不受保护。)

• Credential Guard cannot be enabled on a domain controller as it breaks authentication there.(不能在域控制器上启用凭证保护，因为它破坏了那里的认证。)

• Only available on the Windows 10 Enterprise edition and Server 2016.(只在Windows 10企业版和服务器2016上可用。)

• Mimikatz can bypass it but still, no need to not use it.(Mimikatz可以绕过它，但仍然没有必要不使用它。)


# Device Guard (WDAC)

• It is a group of features "designed to harden a system against malware attacks. Its focus is preventing malicious code from running by ensuring only known good code can run."(它是一组“旨在加强系统抵御恶意软件攻击的功能。其重点是通过确保只有已知的良好代码可以运行来防止恶意代码运行。”)

• Three primary components:(三个主要组成部分：)
– Configurable Code Integrity (CCI) - Configure only trusted code to run(可配置代码完整性 (CCI) - 仅配置可信代码以运行)
– Virtual Secure Mode Protected Code Integrity - Enforces CCI with Kernel Mode (KMCI) and User Mode (UMCI)(虚拟安全模式保护代码完整性 - 使用内核模式 (KMCI) 和用户模式 (UMCI) 实施 CCI)
– Platform and UEFI Secure Boot - Ensures boot binaries and firmware integrity(平台和 UEFI 安全启动 - 确保启动二进制文件和固件完整性)

• UMCI is something which interferes with most of the lateral movement attacks we have seen.(UMCI 会干扰我们见过的大多数横向移动攻击。)

• While it depends on the deployment (discussing which will be too lengthy), many well known application whitelisting bypasses - signed binaries like csc.exe, MSBuild.exe etc. - are useful for bypassing UMCI as well.(虽然这取决于部署（讨论会太冗长），但许多众所周知的应用程序白名单绕过 - 签名的二进制文件，如 csc.exe、MSBuild.exe 等 - 对于绕过 UMCI 也很有用。)

• Check out the LOLBAS project (lolbas-project.github.io/).


# MDI

• "..identify, detect, and investigate advanced threats, compromised identities, and malicious insider actions directed at your organization."(.....识别、检测和调查针对你的组织的高级威胁、受损的身份和恶意的内部行动)
• MDI sensors are installed on DCs and Federation servers. Analysis and alerting is done in the Azure cloud.( MDI传感器被安装在DC和联盟服务器上。分析和警报是在Azure云中完成的。)
• MDI can be used for detecting(MDI可用于检测)
− Recon(探测)
− Compromised credentials (Brute-Force, Kerberoasting etc.)
− Lateral movement (PTH, OPTH etc.)
− Domain Dominance (DCSync, Golden ticket, Skeleton key etc.)
− Exfiltration


# MDI Bypass

• The key is to avoid talking to the DC as long as possible and make appear the traffic we generate as attacker normal.(关键是尽可能避免与DC对话，使我们产生的流量看起来像攻击者的正常流量。)
• To bypass DCSync detection, go for users which are whitelisted. For example, the user account used for PHS may be whitelisted.(为了绕过DCSync的检测，要选择被列入白名单的用户。例如，用于PHS的用户账户可能是白名单。)
• Also, if we have NTLM hash of a DC, we can extract NTLM hashes of any machine account using netsync(另外，如果我们有一个DC的NTLM哈希值，我们可以使用netsync提取任何机器账户的NTLM哈希值)
```
Invoke-Mimikatz -Command '"lsadump::netsync /dc:us-dc.us.techcorp.local /user:us-dc$ /ntlm:f4492105cb24a843356945e45402073e /account:us-web$"'
```
• If we forge a Golden Ticket with SID History of the Domain Controllers group and Enterprise Domain Controllers Group, there are less chances of detection by MDI(如果我们用域控制器组和企业域控制器组的SID历史伪造一张金票，那么被MDI检测到的机会就会减少。)

```
Invoke-Mimikatz -Command '"kerberos::golden /user:us-dc$ /domain:us.techcorp.local /sid:S-1-5-21-210670787-2521448726-163245708 /groups:516 /krbtgt:b0975ae49f441adc6b024ad238935af5 /sids:S-1-5-21-2781415573-3701854478-2406986946-516,S-1-5-9 /ptt"'
```

# Golden Ticket

• Some important Event ID:
• Event ID
– 4624: Account Logon
– 4672: Admin Logon
```
Get-WinEvent -FilterHashtable @{Logname='Security';ID=4672} -MaxEvents 1 | Format-List –Property *
```


# Silver Ticket

• Event ID
– 4624: Account Logon
– 4634: Account Logoff
– 4672: Admin Logon
```
Get-WinEvent -FilterHashtable @{Logname='Security';ID=4672} -MaxEvents 1 | Format-List –Property *
```


# Skeleton Key

• Events
	− System Event ID 7045 - A service was installed in the system. (Type Kernel Mode driver)
• Events ("Audit privilege use" must be enabled)
	– Security Event ID 4673 – Sensitive Privilege Use
	– Event ID 4611 – A trusted logon process has been registered with the Local Security Authority
```
Get-WinEvent -FilterHashtable @{Logname='System';ID=7045} | ?{$_.message -like "*Kernel Mode Driver*"}
```
• Not recommended:
```
Get-WinEvent -FilterHashtable @{Logname='System';ID=7045} | ?{$_.message -like "*Kernel Mode Driver*" -and $_.message -like "*mimidrv*"}
```

• Mitigation
	− Running lsass.exe as a protected process is really handy as it forces an attacker to load a kernel mode driver.
	− Make sure that you test it thoroughly as many drivers and plugins may not load with the protection.
```
New-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\ -Name RunAsPPL -Value 1 -Verbose
```
• Verify after a reboot
```
Get-WinEvent -FilterHashtable @{Logname='System';ID=12} |?{$_.message -like "*protected process*"}
```

# DSRM

• Events
− Event ID 4657 - Audit creation/change of
```
HKLM:\System\CurrentControlSet\Control\Lsa\DsrmAdminLogonBehavior
```

# Malicious SSP

• Events
− Event ID 4657 - Audit creation/change of
```
HKLM:\System\CurrentControlSet\Control\Lsa\SecurityPackages
```

# Kerberoast

• Events
	– Security Event ID 4769 – A Kerberos ticket was requested
• Mitigation
	– Service Account Passwords should be hard to guess (greater than 30 characters)
	– Use Managed Service Accounts (Automatic change of password periodically and delegated SPN Management)https://technet.microsoft.com/en-us/library/jj128431(v=ws.11).aspx

• Since 4769 is logged very frequently on a DC. We may like to filter results based on the following information from logs:
	− Service name should not be krbtgt
	− Service name does not end with $ (to filter out machine accounts used for services)
	− Account name should not be machine@domain (to filter out requests from machines)
	− Failure code is '0x0' (to filter out failures, 0x0 is success)
	− Most importantly, ticket encryption type is 0x17


# Unconstrained Delegation

• Mitigation
	– Limit DA/Admin logins to specific servers
	– Set "Account is sensitive and cannot be delegated" for privileged accounts.(https://blogs.technet.microsoft.com/poshchap/2015/05/01/security-focus-analysing-account-is-sensitive-and-cannot-be-delegated-for-privileged-accounts/)

# ACL Attacks

• Events
	– Security Event ID 4662 (Audit Policy for object must be enabled) – An operation was performed on an object
	– Security Event ID 5136 (Audit Policy for object must be enabled) – A directory service object was modified
	– Security Event ID 4670 (Audit Policy for object must be enabled) – Permissions on an object were changed

• Useful tool
	– AD ACL Scanner - Create and compare create reports of ACLs.https://github.com/canix1/ADACLScanner


# Trust Tickets

SID Filtering
	• Avoid attacks which abuse SID history attribute (child to root domain privilege escalation, that is, DA from a Child to EA on forest root).
	• Enabled by default on all inter-forest trusts. Intra-forest trusts are assumed secured by default (MS considers forest and not the domain to be a security boundary).
	• But, since SID filtering has potential to break applications and user access, it is often disabled.

Selective Authentication
	• In an inter-forest trust, if Selective Authentication is configured,users between the trusts will not be automatically authenticated. Individual access to domains and servers in the trusting domain/forest should be given.



# Deception（欺骗）

• Deception is a very effective technique in active directory defense.(欺骗是活动目录防御中一种非常有效的技术。)
• By using decoy domain objects, defenders can trick adversaries to follow a particular attack path which increases chances of detection and increase their cost in terms of time.(通过使用诱饵域对象，防御者可以诱骗对手遵循特定的攻击路径，从而增加检测机会并增加他们的时间成本)
• Traditionally, deception has been limited to leave honey credentials on some boxes and check their usage but we can use it effectively during other phases of an attack.(传统上，欺骗仅限于在一些盒子上留下蜂蜜凭证并检查其使用情况，但我们可以在攻击的其他阶段有效地使用它)

• What to target? Adversary mindset of going for the "lowest hanging fruit" and illusive superiority over defenders.(目标是什么？对手的心态是追求 "最低的果实 "和对防御者虚幻的优势)
• We must provide the adversaries what they are looking for. For example, what adversaries look for in a user object:(我们必须向对手提供他们正在寻找的东西。例如，对手在一个用户对象中寻找什么。)
	– A user with high privileges.（一个具有高权限的用户）
	– Permissions over other objects.（对其他对象的权限。）
	– Poorly configured ACLs.（配置不良的ACL。配置不良的ACL。）
	– Misconfigured/dangerous user attributes and so on.（ 错误配置的/危险的用户属性等等）
• Let's create some user objects which can be used for deceiving adversaries. We can use Deploy-Deception for this: https://github.com/samratashok/Deploy-Deception
• Note that Windows Settings|Security Settings|Advanced Audit Policy Configuration|DS Access|Audit Directory Service Access Group Policy needs to be configured to enable 4662 logging.（请注意，需要配置Windows设置|安全设置|高级审计策略配置|DS访问|审计目录服务访问组策略以启用4662日志。）


# User Deception（用户欺骗）

• Creates a decoy user whose password never expires and a 4662 is logged whenever x500uniqueIdentifier - d07da11f-8a3d-42b6-b0aa-76c962be719a property of the user is read.:（创建一个诱饵用户，其密码永远不会过期，每当读取用户的x500uniqueIdentifier - d07da11f-8a3d-42b6-b0aa-76c962be719a属性时，就会记录下一个4662。）
```
Create-DecoyUser -UserFirstName user -UserLastName manager -Password Pass@123 | Deploy-UserDeception -UserFlag PasswordNeverExpires -GUID d07da11f-8a3d-42b6-b0aa-76c962be719a -Verbose
```
• This property is not read by net.exe, WMI classes (like Win32_UserAccount) and ActiveDirectory module. But LDAP based tools like PowerView and ADExplorer trigger the logging.（net.exe、WMI类（如Win32_UserAccount）和ActiveDirectory模块都不读取这个属性。但基于LDAP的工具，如PowerView和ADExplorer会触发记录。）

• Create a decoy user named decda and make it a member of the Domain Admins group. As a protection against potential abuse, Deny logon to the user on any machine.（创建一个名为decda的诱饵用户并使其成为域管理员组的成员。作为对潜在滥用的保护，拒绝该用户在任何机器上的登录。）
```
Create-DecoyUser -UserFirstName dec -UserLastName da -Password Pass@123 | Deploy-PrivilegedUserDeception -Technique DomainAdminsMemebership -Protection DenyLogon -Verbose
```

• If there is any attempt to use the user credentials (password or hashes) a 4768 is logged.(如果有任何试图使用用户凭证（密码或哈希值）的行为，将被记录为4768。)
• Any enumeration which reads DACL or all properties for the user will result in a 4662 logging.(任何读取用户的DACL或所有属性的枚举都会导致4662的记录。)