# Defence in Depth

几种情况可能导致红队把服务用户暴露在危险当中

> Leaving unauthenticated backdoors open and accessible via the Internet, such as web shells or SOCKS proxies.(保留未经身份验证的后门通过 Internet 打开和访问，如 Web shell 或 SOCKS 代理。)

> Using unencrypted channels, such as netcat or HTTP shells.(使用未加密的通道，如 netcat 或 HTTP shell)

> C2 servers being compromised, e.g. this [Cobalt Strike RCE](https://blog.cobaltstrike.com/2016/09/28/cobalt-strike-rce-active-exploitation-reported/) and [Covenant RCE](https://blog.null.farm/hunting-the-hunters).(C2服务器暴露，Cobalt Strike RCE或者Covenant RCE)

# Infrastructure Design

C2基础设施图表

![img](https://rto2-assets.s3.eu-west-2.amazonaws.com/inf/red-team-infra-overview.png?width=1920)

# Apache Installation

安装
```
sudo apt install apache2
sudo a2enmod ssl rewrite proxy proxy_http
```

配置文件
```
ubuntu@redirector-1 /e/a/sites-enabled> ll
total 0
lrwxrwxrwx 1 root root 35 Nov  5  2021 000-default.conf -> ../sites-available/000-default.conf
ubuntu@redirector-1 /e/a/sites-enabled> sudo rm 000-default.conf
ubuntu@redirector-1 /e/a/sites-enabled> sudo ln -s ../sites-available/default-ssl.conf .
ubuntu@redirector-1 /e/a/sites-enabled> ll
total 0
lrwxrwxrwx 1 root root 35 May 26 10:27 default-ssl.conf -> ../sites-available/default-ssl.conf
```

重启apache
```
sudo systemctl restart apache2
```

# Java KeyStore

因为CS是java写的，公钥和私钥都需要引入Java KeyStore

首先，我们需要将单独的公共和私有文件组合成一个 PKCS12文件，需要设置一个密码，此密码后面要用到

```
openssl pkcs12 -inkey private.key -in public.crt -export -out acme.pkcs12
```

然后，可以使用 keytool 实用工具将 PKCS12文件转换为 JavaKeyStore

```
 keytool -importkeystore -srckeystore acme.pkcs12 -srcstoretype pkcs12 -destkeystore acme.store
```

这个新存储的密码可以是相同的，也可以是不同的

Pkcs12文件现在可以删除。在使用新的 JavaKeyStore 之前，需要在C2配置文件中引用它

```
https-certificate {
     set keystore "acme.store";
     set password "password";
}
```

打开teamserver时指定上面配置的profile文件

```
ubuntu@teamserver ~/cobaltstrike> sudo ./teamserver 10.10.0.69 Passw0rd! c2-profiles/normal/webbug_getonly.profile

[*] Checking TeamServerImage for local update

[*] Verifying MD5 Message Digest for TeamServerImage
TeamServerImage: OK

[*] Will use existing X509 certificate and keystore (for SSL)

[*] Starting teamserver
[*] Team Server Version: 4.6.1 (20220511) Licensed
[*] Setting 'https.protocols' system property: SSLv3,SSLv2Hello,TLSv1,TLSv1.1,TLSv1.2,TLSv1.3
[+] I see you're into threat replication. c2-profiles/normal/webbug_getonly.profile loaded.
[+] Team server is up on 0.0.0.0:50050
[*] SHA256 hash of SSL cert is: e08407b2f751572ae7d1f0e8f5b1a01ba874293fd0b37d66d05843d88f1fbfc2
```

# HTTPS Listener for Redirector