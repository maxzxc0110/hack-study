
域枚举

# PowerView

引入PowerView,注意这一节使用的是开发版的PS
```
beacon> powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1
```

# Get-Domain

获取当前域
```
beacon> powershell Get-Domain
```

# Get-DomainController
获取DC

```
beacon> powershell Get-DomainController | select Forest, Name, OSVersion | fl
```

# Get-ForestDomain

获取当前林
```
beacon> powershell Get-ForestDomain
```

# Get-DomainPolicyData

返回当前域或指定域/域控制器的默认域策略或域控制器策略。对于查找诸如域密码策略之类的信息很有用。
```
beacon> powershell Get-DomainPolicyData | select -ExpandProperty SystemAccess

MinimumPasswordAge           : 1
MaximumPasswordAge           : 42
MinimumPasswordLength        : 7
PasswordComplexity           : 1
PasswordHistorySize          : 24
LockoutBadCount              : 0
RequireLogonToChangePassword : 0
ForceLogoffWhenHourExpire    : 0
ClearTextPassword            : 0
LSAAnonymousNameLookup       : 0
```

# Get-DomainUser

返回所有（或特定）用户。要仅返回特定属性，请使用-Properties. 默认情况下，返回当前域的所有用户对象，用于-Identity返回特定用户。

```
beacon> powershell Get-DomainUser -Identity nlamb -Properties DisplayName, MemberOf | fl

displayname : Nina Lamb
memberof    : {CN=Roaming Users,CN=Users,DC=dev,DC=cyberbotic,DC=io, CN=Group Policy Creator 
              Owners,CN=Users,DC=dev,DC=cyberbotic,DC=io, CN=Domain Admins,CN=Users,DC=dev,DC=cyberbotic,DC=io, 
              CN=Administrators,CN=Builtin,DC=dev,DC=cyberbotic,DC=io}
```

# Get-DomainComputer

获取域内所有计算机
```
beacon> powershell Get-DomainComputer -Properties DnsHostName | sort -Property DnsHostName
```

# Get-DomainOU

搜索所有organization units(OU) 或特定 OU 对象

```
beacon> powershell Get-DomainOU -Properties Name | sort -Property Name

name              
----              
Domain Controllers
Servers           
Tier 1            
Tier 2            
Workstations
```

# Get-DomainGroup

获取域内所有的组信息
```
beacon> powershell Get-DomainGroup
```

获取所有带```admin```字样的组信息
```
beacon> powershell Get-DomainGroup | where Name -like "*Admins*" | select SamAccountName

samaccountname
--------------
Domain Admins 
Key Admins    
DnsAdmins     
Oracle Admins 
```

# Get-DomainGroupMember

返回特定的组成员信息，这里是返回DA组
```
beacon> powershell Get-DomainGroupMember -Identity "Domain Admins" | select MemberDistinguishedName

MemberDistinguishedName                             
-----------------------                             
CN=Nina Lamb,CN=Users,DC=dev,DC=cyberbotic,DC=io    
CN=Administrator,CN=Users,DC=dev,DC=cyberbotic,DC=io
```

# Get-DomainGPO

返回所有组策略对象 (GPO) 或特定 GPO 对象。要枚举应用于特定机器的所有 GPO，请使用```-ComputerIdentity```

```
beacon> powershell Get-DomainGPO -Properties DisplayName | sort -Property DisplayName

displayname                      
-----------                      
Default Domain Controllers Policy
Default Domain Policy
Roaming Users
Tier 1 Admins
Tier 2 Admins
Windows Defender
Windows Firewall
```


```
beacon> powershell Get-DomainGPO -ComputerIdentity wkstn-1 -Properties DisplayName | sort -Property DisplayName

displayname          
-----------          
Default Domain Policy
LAPS
PowerShell Logging
Roaming Users
Windows Defender
Windows Firewall
```

# Get-DomainGPOLocalGroup

返回所有通过受限组或组策略首选项修改本地组成员资格的GPO。
```
beacon> powershell Get-DomainGPOLocalGroup | select GPODisplayName, GroupName

GPODisplayName GroupName           
-------------- ---------           
Tier 1 Admins  DEV\Developers      
Tier 2 Admins  DEV\1st Line Support
```

# Get-DomainGPOUserLocalGroupMapping

枚举特定域用户/组是特定本地组成员的机器。

```
beacon> powershell Get-DomainGPOUserLocalGroupMapping -LocalGroup Administrators | select ObjectName, GPODisplayName, ContainerName, ComputerName

ObjectName       GPODisplayName ContainerName                                     ComputerName             
----------       -------------- -------------                                     ------------             
1st Line Support Tier 2 Admins  {OU=Tier 2,OU=Servers,DC=dev,DC=cyberbotic,DC=io} {srv-2.dev.cyberbotic.io}
Developers       Tier 1 Admins  {OU=Tier 1,OU=Servers,DC=dev,DC=cyberbotic,DC=io} {srv-1.dev.cyberbotic.io}
```

# Find-DomainUserLocation

查找域用户（默认是DA）登录过的机器
```
beacon> powershell Find-DomainUserLocation | select UserName, SessionFromName

UserName      SessionFromName          
--------      ---------------          
nlamb         wkstn-2.dev.cyberbotic.io
```


# Get-NetSession

返回本地（或远程）机器的会话信息（其中CName是源IP）
```
beacon> powershell Get-NetSession -ComputerName dc-2 | select CName, UserName

CName          UserName
-----          --------
\\10.10.17.231 bfarmer 
\\10.10.17.132 nlamb   
```

# Get-DomainTrust

枚举域信任关系
```
beacon> powershell Get-DomainTrust
```

# [SharpView](https://github.com/tevora-threat/SharpView)

C#版本的powerview

使用SharpView枚举当前域
```
beacon> execute-assembly C:\Tools\SharpView\SharpView\bin\Debug\SharpView.exe Get-Domain

Forest                         : cyberbotic.io
DomainControllers              : {dc-2.dev.cyberbotic.io}
Children                       : {}
DomainMode                     : Unknown
DomainModeLevel                : 7
Parent                         : cyberbotic.io
PdcRoleOwner                   : dc-2.dev.cyberbotic.io
RidRoleOwner                   : dc-2.dev.cyberbotic.io
InfrastructureRoleOwner        : dc-2.dev.cyberbotic.io
Name                           : dev.cyberbotic.io
```

# [ADSearch](https://github.com/tomcarver16/ADSearch)

功能比powerview和shapview少一些，但是有强大的LDAP 查询功能

查找所有以```admins```结尾的域用户组
```
beacon> execute-assembly C:\Tools\ADSearch\ADSearch\bin\Debug\ADSearch.exe --search "(&(objectCategory=group)(cn=*Admins))"

[*] No domain supplied. This PC's domain will be used instead
[*] LDAP://DC=dev,DC=cyberbotic,DC=io
[*] CUSTOM SEARCH: 
[*] TOTAL NUMBER OF SEARCH RESULTS: 6
[+] cn : Domain Admins
[+] cn : Key Admins
[+] cn : DnsAdmins
[+] cn : Oracle Admins
[+] cn : Subsidiary Admins
[+] cn : MS SQL Admins
```


# GPO
枚举能过创建GPO的SID
然后通过```ConvertFrom-SID```命令查找这个SID是哪个组下的
```
beacon> powershell Get-DomainObjectAcl -SearchBase "CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" -ResolveGUIDs | ? { $_.ObjectAceType -eq "Group-Policy-Container" } | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl

ObjectDN              : CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io
ActiveDirectoryRights : CreateChild
SecurityIdentifier    : S-1-5-21-3263068140-2042698922-2891547269-1125

beacon> powershell ConvertFrom-SID S-1-5-21-3263068140-2042698922-2891547269-1125

DEV\1st Line Support
```


This query will return the principals that can write to the GP-Link attribute on OUs:
```
beacon> powershell Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ObjectAceType -eq "GP-Link" -and $_.ActiveDirectoryRights -match "WriteProperty" } | select ObjectDN, SecurityIdentifier | fl

ObjectDN           : OU=Workstations,DC=dev,DC=cyberbotic,DC=io
SecurityIdentifier : S-1-5-21-3263068140-2042698922-2891547269-1125

ObjectDN           : OU=Servers,DC=dev,DC=cyberbotic,DC=io
SecurityIdentifier : S-1-5-21-3263068140-2042698922-2891547269-1125

ObjectDN           : OU=Tier 1,OU=Servers,DC=dev,DC=cyberbotic,DC=io
SecurityIdentifier : S-1-5-21-3263068140-2042698922-2891547269-1125

ObjectDN           : OU=Tier 2,OU=Servers,DC=dev,DC=cyberbotic,DC=io
SecurityIdentifier : S-1-5-21-3263068140-2042698922-2891547269-1125
```

从上面的输出可以看到，```1st Line Support```域组既可以创建新的 GPO ，也可以将它们链接到多个 OU。
 如果更多的特权用户被认证到这些OU内的任何机器上，这可能导致特权升级。还可以想象一下，如果我们可以将GPO链接到包含敏感文件或数据库服务器的OU上--我们可以使用这些GPO来访问这些机器，随后访问存储在这些机器上的数据。



获取某个OU的计算机列表
```
beacon> powershell Get-DomainComputer | ? { $_.DistinguishedName -match "OU=Tier 1" } | select DnsHostName

dnshostname            
-----------            
srv-1.dev.cyberbotic.io
```


下面查询返回所有拥有WriteProperty、WriteDacl或WriteOwner权限的SID
```
beacon> powershell Get-DomainGPO | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "WriteProperty|WriteDacl|WriteOwner" -and $_.SecurityIdentifier -match "S-1-5-21-3263068140-2042698922-2891547269-[\d]{4,10}" } | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl

ObjectDN              : CN={AD7EE1ED-CDC8-4994-AE0F-50BA8B264829},CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io
ActiveDirectoryRights : CreateChild, DeleteChild, ReadProperty, WriteProperty, GenericExecute
SecurityIdentifier    : S-1-5-21-3263068140-2042698922-2891547269-1126

beacon> powershell ConvertFrom-SID S-1-5-21-3263068140-2042698922-2891547269-1126
DEV\Developers
```

查看上面结果中ObjectDN的名字
```
beacon> powershell Get-DomainGPO -Name "{AD7EE1ED-CDC8-4994-AE0F-50BA8B264829}" -Properties DisplayName

displayname       
-----------       
PowerShell Logging
```

