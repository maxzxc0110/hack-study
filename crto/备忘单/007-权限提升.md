# Peer-to-Peer Listeners

## 创建tcp Peer-to-Peer Listeners

1. 创建tcp Listeners
Cobalt Strike->Listener,选择```Beacon TCP```payload

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658932153519.png)


2. 生成可执行程序

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658932380042.png)

3. 选择上面的监听器```tcp_beacon```

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658932419426.png)

把生成的exe文件传到靶机，此时可以看到是没有4444端口服务的

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658932550271.png)

4. 执行我们的payload ，可以看见，已经生成了4444端口的监听

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658932670852.png)

5. 使用connect命令连接靶机上的4444端口，返回一个新的beacon

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658932785866.png)


从网络拓扑图可见，tcp beacon是从http beacon派生出来的

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658932928033.png)

如果此时去掉http beacon，tcp beacon也无法使用

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658933165263.png)


## 创建smb Peer-to-Peer Listeners

1. 创建smb Listeners
Cobalt Strike->Listener,选择```Beacon TCP```payload

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658933549100.jpg)

2. 生成可执行程序

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658932380042.png)

3. 选择上面的监听器```smb_beacon```,留意这里的pipename是```msagent_5c```

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658933643963.png)

4. 把生成的exe文件传到靶机，执行

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658933722166.png)

5. 使用命令``` ls \\.\pipe\ ```查看,已生成一个通道名```msagent_5c```

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658933892339.png)

6. 用```tcp beacon```执行```link```命令，获得一个smb beacon

可以看到此beacon是从tcp beacon派生出来的。

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658934042562.png)

此时如果tcp的beacon死掉了，smb的beacon也会丢失,因为smb是tcp的子进程
![img](https://github.com/maxzxc0110/hack-study/blob/main/1658934538714.png)

**注意**也可以由http派生出smb的beacon，在这种情况下，tcp死掉，不会影响smb，因为tcp和smb在这里是平行的同属http的子进程

![img](https://github.com/maxzxc0110/hack-study/blob/main/1658934235146.png)